<!DOCTYPE html>
<html lang="ja">
<head>
    {% load static %}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AI外見設定</title>
    <style>
        body{
            margin:0;
            font-family:Meiryo, 'Hiragino Kaku Gothic ProN',sans-serif;
            background-image:url("{% static 'accounts/background.png' %}");
            background-size:contain;
            background-position:center center;
            background-repeat:no-repeat;
            background-attachment:fixed;
            background-color:#f5f5f5;
            min-height:100vh;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:20px;
            box-sizing:border-box;
        }
        .wrap{
            max-width:1100px;
            width:95%;
            margin:auto;
            padding:50px 60px;
            border:none;
            background:transparent;
            border-radius:30px;
            box-shadow:none;
        }
        h1{text-align:center;margin-top:0;margin-bottom:30px;font-size:28px;font-weight:bold}
        .canvas{position:relative;height:380px;display:flex;align-items:center;justify-content:center;margin-bottom:20px}
        /* 画像周りの四角（枠）を消すために border を無効化し、img に合わせて表示する */
        .illustration{
            width:220px;
            height:240px;
            display:block; /* img要素なので block にする */
            border:none; /* 枠を消す */
            background:transparent;
            border-radius:0; /* 角丸も不要なら0に */
            object-fit:contain; /* 画像の縦横比を保って収める */
        }
        .nav-left,.nav-right{position:absolute;left:20px;top:50%;transform:translateY(-50%);cursor:pointer}
        .nav-right{left:auto;right:20px}
        .nav-button{width:48px;height:48px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;background:#f0f0f0;font-size:24px;transition:all 0.3s}
        .nav-button:hover{background:#e0e0e0;transform:scale(1.1)}
        .controls{display:flex;justify-content:space-between;padding:10px 0}
        .btn{padding:12px 40px;border-radius:8px;border:none;cursor:pointer;font-size:16px;font-weight:bold;transition:all 0.3s}
        .btn.primary{background:#5dade2;color:#fff}
        .btn.primary:hover{background:#3498db}
        .btn.secondary{background:#f8f9fa;color:#333;border:2px solid #ddd}
        .btn.secondary:hover{background:#e9ecef}
    </style>
</head>
<body>
    <div class="wrap">
        <h1>CodeMonの見た目を決めよう！</h1>
        <div class="canvas">
            <div class="nav-left" id="prev"><div class="nav-button">◀</div></div>
            <!-- 画像表示用に div を img に変更 -->
            <img class="illustration" id="illustration" src="" alt="AIのイラスト（大きく）">
            <div class="nav-right" id="next"><div class="nav-button">▶</div></div>
        </div>

        <form method="post" id="aiForm">
            {% csrf_token %}
            <input type="hidden" name="appearance" id="appearanceInput" value="triangle">
            <div class="controls">
                <button type="button" class="btn secondary" id="backBtn">戻る</button>
                <button type="submit" class="btn primary" id="decideBtn">決定</button>
            </div>
        </form>
    </div>

    <script>
        // baseStatic は static/accounts/ への URL
        const baseStatic = "{% static 'accounts/' %}";
        const appearances = {{ appearances|safe }};
        let idx = 0;
        const illustration = document.getElementById('illustration');
        const appearanceInput = document.getElementById('appearanceInput');

        function filenameFor(a){
            if(!a) return '';
            // 既に拡張子があればそのまま
            if(typeof a === 'string' && a.match(/\.(png|jpg|jpeg|gif)$/i)) return a;
            const map = {
                // 既存のキーをファイル名にマップ（必要なら追加）
                'triangle':'dog.png',
                'round':'panda.png',
                // static/accounts 内の実際のファイル名に合わせる
                'robot':'rabitto.png',
            };
            if(map[a]) return map[a];
            return a + '.png';
        }

        function render(){
            const a = appearances[idx];
            const filename = filenameFor(a);
            appearanceInput.value = filename;
            if(filename){
                // 日本語ファイル名にも対応するため encodeURIComponent を使用
                illustration.src = baseStatic + encodeURIComponent(filename);
                illustration.alt = filename;
            } else {
                illustration.removeAttribute('src');
                illustration.alt = 'AIのイラスト（大きく）';
            }
        }

        document.getElementById('prev').addEventListener('click',()=>{ idx = (idx-1+appearances.length)%appearances.length; render(); });
        document.getElementById('next').addEventListener('click',()=>{ idx = (idx+1)%appearances.length; render(); });
        document.getElementById('backBtn').addEventListener('click',()=>{ window.history.back(); });
        render();
    </script>
</body>
</html>