<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>AI初期設定</title>
    {% load static %}
    <style>
        /* --- 共通変数 (新規登録画面と統一) --- */
        :root {
            --bg: #f0f4f8;
            --accent: #5BD4F0;
            --accent-dark: #3fbcd9;
            --pop-yellow: #FFD200;
            --pop-yellow-dark: #E6BD00;
            --pop-red: #ff7675;
            --panel-white: rgba(255, 255, 255, 0.95);
            /* キャラクターごとの動的カラー用初期値 */
            --theme-color: #ff99cc;
            --theme-deep: #a30052;
        }

        /* 1. ページ読み込み完了前はコンテンツを非表示にする */
        .wrap { opacity: 0; transition: opacity 0.3s ease; }
        body.loaded .wrap { opacity: 1; }

        body {
            margin: 0;
            /* 5. 背景画像の統一 */
            background: linear-gradient(rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.4)), url("{% static 'codemon/images/backgrounds/bg_common.png' %}");
            background-size: cover; background-position: center; background-attachment: fixed;
            /* 4. フォントの統一 */
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* --- カーテン設定 --- */
        #curtain-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10000; display: flex; pointer-events: none;
        }
        .curtain-panel {
            flex: 1; height: 100%; transform: translateY(0);
            transition: transform 0.6s cubic-bezier(0.45, 0, 0.55, 1);
        }
        .p1 { transition-delay: 0.0s; } .p2 { transition-delay: 0.1s; }
        .p3 { transition-delay: 0.2s; background-color: #ffffff !important; }
        .p4 { transition-delay: 0.3s; } .p5 { transition-delay: 0.4s; }
        body.loaded .curtain-panel { transform: translateY(100%); }

        /* --- メインパネルレイアウト --- */
        .wrap {
            /* 9. デザイン性を高める（新規登録画面のmain-panel風に） */
            background: var(--panel-white);
            border: 6px solid #fff;
            border-radius: 40px;
            padding: 40px 50px;
            width: 90%;
            max-width: 850px; /* 横並びなので少し広めに */
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            position: relative;
            z-index: 10;
            text-align: center;
        }

        /* 1. 見出しのデザイン */
        h1 {
            margin: 0 0 30px 0;
            font-size: 26px;
            color: #555;
            font-weight: 900;
            letter-spacing: 1px;
        }
        h1 span { color: var(--theme-deep); }

        .content {
            display: flex;
            gap: 40px;
            align-items: center;
            justify-content: center;
        }

        /* --- 左側：キャラクターエリア --- */
        .left {
            flex: 0 0 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* 吹き出し */
        .speech-bubble {
            position: relative;
            background: #fff;
            border: 4px solid var(--theme-color);
            border-radius: 20px;
            padding: 15px 20px;
            margin-bottom: 20px;
            font-weight: bold;
            color: #333;
            font-size: 15px;
            box-shadow: 0 5px 0 rgba(0,0,0,0.05);
            /* 7. 吹き出しだけ動かす */
            animation: float 3s ease-in-out infinite;
            min-width: 200px;
        }
        .speech-bubble::after {
            content: ''; position: absolute; bottom: -15px; left: 50%;
            transform: translateX(-50%);
            border-width: 15px 12px 0; border-style: solid;
            border-color: var(--theme-color) transparent transparent;
        }

        /* キャラクター画像 (7. 固定) */
        .illustration {
            width: 260px; height: 260px;
            object-fit: contain;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
            /* アニメーション削除 */
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        /* --- 右側：フォームエリア --- */
        .right { flex: 1; max-width: 350px; }

        /* 9. フォームの余白調整 */
        .form-row { margin-bottom: 25px; text-align: left; }

        /* 8. ラベルと入力欄のメリハリ */
        .label {
            font-size: 14px;
            font-weight: bold;
            color: #666;
            margin-bottom: 6px;
            display: block;
            padding-left: 10px;
        }

        .input input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 3px solid #eef2f5;
            border-radius: 20px;
            background: #fdfdfd;
            color: #333;
            font-size: 20px; /* 文字サイズ大きく */
            font-weight: bold;
            text-align: center;
            box-sizing: border-box;
            transition: all 0.2s;
        }

        .input input[type="text"]:focus {
            outline: none;
            border-color: var(--theme-color);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
        }

        .input input[type="text"]::placeholder {
            color: #ccc;
            font-weight: normal;
            font-size: 16px;
        }

        /* コントロールエリア */
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 30px;
        }

        /* 2. 決定ボタン（黄色ポップ） */
        .hero-btn {
            width: 100%;
            background: var(--pop-yellow);
            color: #634a00;
            border: none;
            padding: 15px;
            font-size: 18px;
            font-weight: 900;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 5px 0 var(--pop-yellow-dark);
            transition: all 0.1s;
            text-decoration: none;
            display: inline-block;
        }
        .hero-btn:active {
            transform: translateY(3px);
            box-shadow: 0 2px 0 var(--pop-yellow-dark);
        }

        /* 3. 戻るボタン（位置調整済み） */
        .btn.secondary {
            background: transparent;
            color: #999;
            font-size: 14px;
            font-weight: bold;
            text-decoration: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.3s;
        }
        .btn.secondary:hover {
            background: #f0f4f8;
            color: #666;
        }

        /* スマホ対応 */
        @media (max-width: 768px) {
            .content { flex-direction: column; gap: 20px; }
            .left { flex: auto; }
            .right { width: 100%; }
        }
    </style>
</head>
<body>
    <div id="curtain-layer">
        <div class="curtain-panel p1"></div>
        <div class="curtain-panel p2"></div>
        <div class="curtain-panel p3"></div>
        <div class="curtain-panel p4"></div>
        <div class="curtain-panel p5"></div>
    </div>

    <div class="wrap" id="mainWrap">
        <h1>あいぼうの <span style="color:var(--theme-color)">なまえ</span> を きめてね！</h1>
        
        <div class="content">
            <div class="left">
                <div class="speech-bubble" id="speechBubble">
                    こんにちは！<br>よろしくね！
                </div>
                <img id="illustration" class="illustration" src="" alt="キャラ画像">
            </div>

            <div class="right">
                <form id="initial-form" method="post" action="{% url 'accounts:ai_initial_confirm' %}">
                    {% csrf_token %}
                    <div class="form-row">
                        <label class="label">なまえ</label>
                        <div class="input">
                            <input type="text" name="ai_name" id="aiNameInput" maxlength="10" 
                                   value="{{ config.ai_name|default:'' }}" placeholder="なまえをつけてね">
                        </div>
                    </div>
                    
                    <input type="hidden" name="appearance" value="{{ config.appearance }}">
                    <input type="hidden" name="ai_personality" value="">
                    <input type="hidden" name="ai_speech" value="">

                    <div class="controls">
                        <button type="button" class="hero-btn" onclick="startTransition()">けってい！</button>
                        <a href="{% url 'accounts:ai_appearance' %}" class="btn secondary">えらびなおす</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const baseStatic = "{% static 'codemon/images/characters/' %}";
        const appearance = "{{ config.appearance|escapejs }}" || '';

        // ai_appearance.htmlと同じロジック
        const colorMap = {
            'イヌ.png': '#FFD700', 'ウサギ.png': '#FFB6C1', 'キツネ.png': '#E5A020',
            'ネコ.png': '#4DB6AC', 'パンダ.png': '#E0E0E0', 'フクロウ.png': '#92B7D6',
            'リス.png': '#FEB6AC', 'アルパカ.png': '#E5D580'
        };

        function generateDeepColor(hex) {
            if(hex === '#E0E0E0') return '#5D5D5D'; 
            if(hex === '#FFD700') return '#8B6508';
            if(hex === '#FFB6C1') return '#a30052';
            let r = parseInt(hex.slice(1, 3), 16);
            let g = parseInt(hex.slice(3, 5), 16);
            let b = parseInt(hex.slice(5, 7), 16);
            const max = Math.max(r, g, b);
            const factor = 0.45;
            r = Math.floor(r === max ? r * 0.6 : r * factor);
            g = Math.floor(g === max ? g * 0.6 : g * factor);
            b = Math.floor(b === max ? b * 0.6 : b * factor);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // 6. キャラクターごとの初期挨拶設定 (intro)
        const animalSettings = {
            'イヌ': { personality: '元気', speech: 'わん', intro: 'はじめましてだワン！<br>なまえをつけてね！' },
            'ウサギ': { personality: '優しい', speech: 'ぴょん', intro: 'はじめましてぴょん♪<br>どんななまえかな？' },
            'キツネ': { personality: '冷静', speech: 'です', intro: 'はじめまして。<br>なまえをいただけますか？' },
            'ネコ': { personality: '無口', speech: 'にゃん', intro: '…はじめましてにゃ。<br>なまえ、まってるにゃ。' },
            'パンダ': { personality: '元気', speech: 'だよ', intro: 'やっほー！<br>ボクのなまえ、きめて！' },
            'フクロウ.png': { personality: '冷静', speech: 'ですな', intro: 'はじめましてですな。<br>よいなまえを頼みますぞ。' },
            'リス': { personality: '元気', speech: 'なのだ', intro: 'はじめましてなのだ！<br>早くなまえがほしいのだ！' },
            'アルパカ': { personality: '元気', speech: 'だよ', intro: 'はじめまして～！<br>なまえ、もふもふにして～' }
        };

        const baseColor = colorMap[appearance] || '#ff99cc';
        const deepColor = generateDeepColor(baseColor);
        const settings = {
            ...animalSettings[appearance],
            color: baseColor,
            deep: deepColor
        } || { personality: '元気', speech: 'です', intro: 'はじめまして！<br>なまえをつけてね！', color: '#ff99cc', deep: '#a30052' };

        document.addEventListener('DOMContentLoaded', () => {
            const root = document.documentElement;
            root.style.setProperty('--theme-color', settings.color);
            root.style.setProperty('--theme-deep', settings.deep);

            // カーテンの色設定
            const curtainPanels = document.querySelectorAll('.curtain-panel');
            curtainPanels[0].style.backgroundColor = settings.deep;
            curtainPanels[1].style.backgroundColor = settings.color;
            curtainPanels[3].style.backgroundColor = settings.color;
            curtainPanels[4].style.backgroundColor = settings.deep;

            // 6. 初期セリフの設定
            const bubble = document.getElementById('speechBubble');
            bubble.innerHTML = settings.intro;

            const nameInput = document.getElementById('aiNameInput');
            nameInput.addEventListener('input', (e) => {
                if (e.target.value) {
                    bubble.innerHTML = `「${e.target.value}」！<br>すてきな なまえだね！`;
                } else {
                    bubble.innerHTML = settings.intro; // 入力が消えたら初期セリフに戻す
                }
            });

            setTimeout(() => {
                document.body.classList.add('loaded');
            }, 50);
        });

        const ill = document.getElementById('illustration');
        if(appearance){ 
            ill.src = baseStatic + encodeURIComponent(appearance); 
        }
        document.querySelector('input[name="ai_personality"]').value = settings.personality;
        document.querySelector('input[name="ai_speech"]').value = settings.speech;

        function startTransition() {
            document.getElementById('initial-form').submit();
        }
    </script>
</body>
</html>