<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ›ãƒ¼ãƒ  - Codemon</title>
    {% load static %}
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'codemon/css/tutorial_overlay.css' %}">
    
    <style>
        :root {
            --color-system: #3fbcd9;    /* ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã‚·ã‚¢ãƒ³ï¼‰ */
            --color-algo: #B197FC;      /* ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆç´«ï¼‰ */
            --color-checklist: #A8E6CF; /* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆç·‘ï¼‰ */
            --color-chat: #FFD166;      /* ãƒãƒ£ãƒƒãƒˆï¼ˆé»„è‰²ï¼‰ */
            --color-mypage: #E0E0E0;    /* ãƒã‚¤ãƒšãƒ¼ã‚¸ï¼ˆã‚°ãƒ¬ãƒ¼ï¼‰ */
            --color-shop: #ff69b4;
            --color-trophy: #ff9f43;
            --color-account: #4cd97b;
            --color-bg: #f0f4f8;
            /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã‚¤ãƒŒï¼‰ */
            --theme-primary: #FFD700;
            --theme-secondary: #FFA500;
            --theme-dark: #FF8C00;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100vh;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden;
            background-color: transparent;
        }

        .full-background {
            position: fixed; inset: 0;
            background-size: cover; background-position: center; z-index: -1;
            opacity: 0.6;
        }

        .home-grid {
            display: grid;
            grid-template-columns: 1.4fr 1.1fr 380px;
            grid-template-rows: 90px 1fr 110px;
            height: 100vh; padding: 25px; box-sizing: border-box; gap: 20px;
            position: relative; z-index: 10;
        }

        /* --- å…±é€šï¼šæŠ¼ä¸‹æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¯ãƒªãƒƒã‚¯æ„Ÿï¼‰ --- */
        .account-btn:active, .deadline-item:active, .menu-panel:active, .chat-trigger-btn:active {
            transform: scale(0.95) !important;
            transition: transform 0.1s !important;
            box-shadow: none !important;
        }

        /* --- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ã‚³ã‚¤ãƒ³ --- */
        .account-section { grid-column: 1 / 2; grid-row: 1 / 2; display: flex; align-items: center; gap: 15px; }
        .account-btn {
            background: white; color: var(--color-account);
            padding: 12px 28px; border-radius: 50px;
            text-decoration: none; font-weight: 900;
            border: 4px solid var(--color-account);
            box-shadow: 0 6px 0 var(--color-account);
            display: flex; align-items: center; gap: 10px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .account-btn:hover { transform: scale(1.05) translateY(-2px); }

        .coin-btn {
            background: white; color: #d99300;
            padding: 12px 24px; border-radius: 50px;
            font-weight: 900; border: 4px solid #ffcc00;
            box-shadow: 0 6px 0 #d99300;
            display: flex; align-items: center; gap: 8px;
            cursor: default;
        }

        /* --- æœŸé™é€šçŸ¥ï¼ˆãƒœã‚¿ãƒ³ï¼‰ --- */
        .deadline-item {
            background: linear-gradient(135deg, #ff7675 0%, #ff4d4d 100%);
            color: white; padding: 10px 25px; border-radius: 25px;
            font-weight: 900; font-size: 15px; text-decoration: none;
            box-shadow: 0 5px 0 #cc3333; display: inline-flex; align-items: center; gap: 10px;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .deadline-item:hover { transform: translateY(-4px) scale(1.03); box-shadow: 0 8px 0 #cc3333; }

        /* --- ãƒ‘ãƒãƒ«åŸºæœ¬è¨­å®š --- */
        .menu-panel {
            position: relative; text-decoration: none; color: white;
            display: flex; align-items: center;
            transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            z-index: 1; border: 4px solid rgba(255,255,255,0.2);
        }
        .menu-panel:hover {
            z-index: 50; transform: scale(1.03);
            border-color: rgba(255,255,255,0.8);
        }

        .panel-label { position: absolute; left: 40px; z-index: 10; pointer-events: none; }
        .panel-label h2 { margin: 0; font-size: 42px; font-weight: 900; text-shadow: 3px 3px 0px rgba(0,0,0,0.2); }
        .panel-label span { font-size: 14px; opacity: 0.9; letter-spacing: 2px; font-weight: 800; background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 4px; }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š --- */
        .panel-system {
            grid-column: 1 / 2; grid-row: 2 / 3;
            background: var(--color-system);
            clip-path: polygon(0 0, 100% 0, 85% 100%, 0% 100%);
            border-radius: 30px 0 0 30px;
        }
        .panel-algo {
            grid-column: 2 / 3; grid-row: 2 / 3;
            background: var(--color-algo);
            height: calc(50% - 10px); align-self: start;
            margin-left: -15%; 
            clip-path: polygon(15% 0, 100% 0, 100% 100%, 7.5% 100%);
            border-radius: 0 30px 0 0;
        }
        /* ğŸŒŸ ä¿®æ­£ï¼šæ–‡å­—ãŒåˆ‡ã‚Œãªã„ã‚ˆã†ã«å³ã¸å¯„ã›ã‚‹ */
        .panel-algo .panel-label { left: 100px; }

        .panel-checklist {
            grid-column: 2 / 3; grid-row: 2 / 3;
            background: var(--color-checklist);
            height: calc(50% - 10px); align-self: end;
            margin-left: -15%;
            clip-path: polygon(7.5% 0, 100% 0, 100% 100%, 0% 100%);
            border-radius: 0 0 30px 0;
        }

        /* --- ğŸŒŸ Microinteractions --- */
        .micro-icon {
            position: absolute; right: 12%; top: 50%;
            transform: translateY(-50%); width: 100px; height: 100px;
            display: flex; align-items: center; justify-content: center;
        }

        /* ğŸ’» ã‚·ã‚¹ãƒ†ãƒ : ã‚·ãƒ³ãƒ—ãƒ«ãªæ°´å¹³1å›è»¢ */
        .laptop-icon { 
            font-size: 60px; 
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .panel-system:hover .laptop-icon { transform: rotateY(360deg); }

        /* âš™ï¸ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ  */
        .gear { font-size: 55px; opacity: 0.8; }
        .panel-algo:hover .gear { animation: spin 4s linear infinite; }

        /* âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ */
        .check-anim { font-size: 55px; position: relative; color: #fff; }
        .pencil { 
            position: absolute; top: -5px; right: -5px; font-size: 30px; 
            color: #ff69b4; filter: drop-shadow(2px 2px 0 #fff); 
            opacity: 0; transition: 0.3s;
        }
        .panel-checklist:hover .pencil { opacity: 1; animation: writing 1s infinite; }

        /* ğŸ›’ ã‚·ãƒ§ãƒƒãƒ— & ğŸ† ãƒˆãƒ­ãƒ•ã‚£ãƒ¼: æŠ‘åˆ¶ã•ã‚ŒãŸå…±é€šã®è·³ã­ */
        .calm-bounce { font-size: 30px; color: white; transition: 0.3s; }
        .panel-shop:hover .calm-bounce,
        .panel-trophy:hover .calm-bounce { animation: bounceIcon 0.8s infinite alternate; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes writing { 50% { transform: translate(-5px, 5px); } }
        @keyframes bounceIcon { 
            from { transform: translateY(0); } 
            to { transform: translateY(-8px) rotate(3deg); } 
        }

        /* --- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é ˜åŸŸ --- */
        .character-area { grid-column: 3 / 4; grid-row: 1 / 4; position: relative; display: flex; align-items: flex-end; justify-content: center; }
        .character-container { position: relative; width: 100%; height: 85vh; display: flex; align-items: flex-end; justify-content: center; }
        .character-img { max-height: 100%; width: auto; max-width: 420px; filter: drop-shadow(15px 15px 0 rgba(0,0,0,0.05)); transition: transform 0.3s ease; cursor: pointer; position: absolute; bottom: 0; }
        .character-img.hover { opacity: 0; }

        /* å¹ãå‡ºã—ãƒ»ãƒœã‚¿ãƒ³ */
        .speech-bubble { position: absolute; top: 120px; left: -30px; background: white; border: 4px solid var(--theme-primary); padding: 15px 25px; border-radius: 25px; font-weight: 900; box-shadow: 0 10px 0 rgba(0,0,0,0.05); z-index: 100; animation: float 3s ease-in-out infinite; color: #333; min-width: 150px; text-align: center; }
        .speech-bubble::after { content: ''; position: absolute; bottom: -15px; right: 30px; border-left: 12px solid transparent; border-right: 12px solid transparent; border-top: 15px solid var(--theme-primary); }
        
        .chat-trigger-btn { 
            position: absolute; bottom: 40px; left: 10px; 
            background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary)); color: white; 
            border: none; padding: 12px 25px; border-radius: 50px; font-weight: 900; 
            cursor: pointer; box-shadow: 0 6px 0 var(--theme-dark); transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            z-index: 110; display: flex; align-items: center; gap: 8px; 
        }
        .chat-trigger-btn:hover { transform: translateY(-5px) scale(1.08); box-shadow: 0 10px 0 var(--theme-dark); }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ä¸‹éƒ¨ãƒœã‚¿ãƒ³ */
        .bottom-area { grid-column: 1 / 3; grid-row: 3 / 4; display: flex; gap: 15px; align-items: center; }
        .panel-small { flex: 1; border-radius: 50px; height: 75px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 900; box-shadow: 0 6px 0 rgba(0,0,0,0.1); transition: all 0.2s; }
        .panel-small:hover { transform: translateY(-3px); }
    </style>
</head>
<body>

    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šç”»åƒURLã‚’ç¢ºèª -->
    <!-- ç”»åƒURL: {% static 'codemon/images/backgrounds/bg_common.png' %} -->
    
    <div class="full-background" style="background-image: url('{% static "codemon/images/backgrounds/bg_common.png" %}');"></div>

    <div class="home-grid">
        <div class="account-section">
            {% if user_coin %}
            <div class="coin-btn">
                <i class="fas fa-coins" style="color: #ffcc00;"></i> {{ user_coin.balance|default:0 }}
            </div>
            {% endif %}
        </div>

        <div style="grid-column: 2/3; display: flex; align-items: center;">
            {% if upcoming_checklists %}
                <a href="{% url 'codemon:checklist_list' %}" class="deadline-item">
                    <i class="fas fa-bell"></i> æœŸé™ãŒè¿‘ã„ãƒªã‚¹ãƒˆãŒã‚ã‚‹ã‚ˆï¼
                </a>
            {% endif %}
        </div>

        <a href="{% url 'accounts:system_choice' %}" class="menu-panel panel-system">
            <div class="panel-label">
                <span>Management</span>
                <h2>ã‚·ã‚¹ãƒ†ãƒ </h2>
            </div>
            <div class="micro-icon">
                <i class="fas fa-laptop-code laptop-icon"></i>
            </div>
        </a>

        <a href="{% url 'accounts:block_choice' %}" class="menu-panel panel-algo">
            <div class="panel-label">
                <span>Learning</span>
                <h2 style="font-size: 32px;">ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </h2>
            </div>
            <div class="micro-icon">
                <i class="fas fa-cog gear"></i>
            </div>
        </a>

        <a href="{% url 'codemon:checklist_selection' %}" class="menu-panel panel-checklist">
            <div class="panel-label">
                <span>Daily Task</span>
                <h2 style="font-size: 32px;">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
            </div>
            <div class="micro-icon">
                <div class="check-anim">
                    <i class="fas fa-check-square"></i>
                    <i class="fas fa-pen pencil"></i>
                </div>
            </div>
        </a>

        <div class="bottom-area">
            <a href="{% url 'codemon:accessory_shop' %}" class="menu-panel panel-small panel-shop" style="background: var(--color-shop);">
                <i class="fas fa-shopping-cart calm-bounce"></i>&nbsp;ã‚·ãƒ§ãƒƒãƒ—
            </a>
            <a href="{% url 'codemon:achievements' %}" class="menu-panel panel-small panel-trophy" style="background: var(--color-trophy);">
                <i class="fas fa-trophy calm-bounce"></i>&nbsp;ãƒˆãƒ­ãƒ•ã‚£ãƒ¼
            </a>
            <a href="http://127.0.0.1:8000/codemon/chat/student/" class="menu-panel panel-small" style="background: var(--color-chat);">
                <i class="fas fa-comments calm-bounce"></i>&nbsp;ãƒãƒ£ãƒƒãƒˆ
            </a>
            {% if is_teacher %}
                <a href="{% url 'accounts:account_dashboard' %}" class="menu-panel panel-small" style="background: var(--color-mypage); color: #666;">
                    <i class="fas fa-user calm-bounce"></i>&nbsp;ãƒã‚¤ãƒšãƒ¼ã‚¸
                </a>
            {% else %}
                <a href="{% url 'accounts:s_account' %}" class="menu-panel panel-small" style="background: var(--color-mypage); color: #666;">
                    <i class="fas fa-user calm-bounce"></i>&nbsp;ãƒã‚¤ãƒšãƒ¼ã‚¸
                </a>
            {% endif %}
        </div>

        <div class="character-area">
            <div class="speech-bubble" id="charSpeech">
                ãŠã‹ãˆã‚Šï¼âœ¨<br>ãªã«ã™ã‚‹ï¼Ÿ
            </div>

            <div class="character-container" id="charContainer">
                <img src="{% static 'codemon/images/characters/' %}{{ appearance }}" class="character-img" id="characterDefault">
                <img src="{% static 'codemon/images/characters/' %}{{ appearance|slice:':-4' }} ç¬‘é¡”.png" class="character-img hover" id="characterHover">
            </div>

            <button class="chat-trigger-btn" id="chatTriggerBtn">
                <i class="fas fa-comment-dots"></i> ã¯ãªã—ã‹ã‘ã‚‹
            </button>
        </div>
    </div>

    <script>
        // ========================================
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥å°è©ã¨è‰²ã®è¨­å®š
        // ========================================
        const characterDialogues = {
            'ã‚¦ã‚µã‚®.png': {
                mumbles: ['ãˆã€ãˆã£ã¨â€¦ä½•ã—ã‚ˆã†ã‹ãªâ€¦', 'ã¼ã€ã¼ãã€ã“ã“ã«ã„ã‚‹ã‚ˆâ€¦', 'ã†ã€ã†ã‚“ã¨â€¦å°‘ã—çœ ã„ã‹ã‚‚â€¦', 'ã‚ã€ã‚ã®â€¦èª°ã‹ã„ã‚‹ã‹ãªâ€¦', 'ã¼ã€ã¼ãã§ã‚ˆã‘ã‚Œã°â€¦è©±ãã†ã‚ˆâ€¦', 'ãˆã€ãˆã£ã¨â€¦ä»Šæ—¥ã‚‚ãŒã‚“ã°ã‚‹ã­â€¦', 'ã¼ã€ã¼ãâ€¦ã¡ã‚‡ã£ã¨ç·Šå¼µã™ã‚‹â€¦', 'ã‚ã€ã‚ã®â€¦ã‚ˆã‹ã£ãŸã‚‰å£°ã‹ã‘ã¦ã­â€¦'],
                greeting: 'ãŠã‹ãˆã‚Šï¼âœ¨<br>ãªã«ã™ã‚‹ï¼Ÿ',
                hoverMessage: 'ã„ã£ã—ã‚‡ã«<br>ã‚ãã¼ã†ï¼',
                chatGreeting: 'ã“ã€ã“ã‚“ã«ã¡ã¯â€¦ï¼ ã¼ã€ã¼ãã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã§ã™ã€‚<br>ãˆã€ãˆã£ã¨â€¦ãªã‚“ã§ã‚‚èã„ã¦ã­â€¦ï¼',
                colors: { primary: '#F5E3F4', secondary: '#E8C4E8', dark: '#D4A5D4' }
            },
            'ã‚­ãƒ„ãƒ.png': {
                mumbles: ['ãµãâ€¦é€€å±ˆã ãªã', 'ãªã‚“ã‹é¢ç™½ã„ã“ã¨ãªã„ã‹ã­', 'ã¾ã€æš‡ã¤ã¶ã—ã«ã¯ãªã‚‹ã‹', 'ãŠã¾ãˆã€ãã“ã«ã„ã‚‹ã‚“ã ã‚ï¼Ÿ', 'ã¸ã‡â€¦è¦‹ã¦ã‚‹ã®ã•', 'ã‚ãã³ãŒå‡ºã¡ã‚ƒã†ãª', 'èª°ã‹æ§‹ã£ã¦ãã‚Œãªã„ã‹ã­ã‡', 'ã¾ã€æ°—ãŒå‘ã„ãŸã‚‰è©±ã—ã‹ã‘ãªã‚ˆ'],
                greeting: 'ã‚ˆã‰ã€‚<br>ä½•ã™ã‚‹ï¼Ÿ',
                hoverMessage: 'ã¾ã€<br>ä»˜ãåˆã£ã¦ã‚„ã‚‹ã‹',
                chatGreeting: 'ã‚ˆã‰ã€ã‚ªãƒ¬ã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã•ã€‚<br>ä½•ã‹ç”¨ã‹ã„ï¼Ÿ',
                colors: { primary: '#FCD37D', secondary: '#F5B942', dark: '#E5A020' }
            },
            'ã‚¤ãƒŒ.png': {
                mumbles: ['ä»Šæ—¥ã‚‚ã„ã„å¤©æ°—ã ãªï¼', 'èª°ã‹éŠã³ã«æ¥ãªã„ã‹ãª', 'ãŠè…¹ã™ã„ã¦ããŸã', 'ã‚ˆã—ã€ã‚„ã‚‹æ°—å‡ºã¦ããŸï¼', 'ãªã‚“ã‹ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ãª', 'ã¡ã‚‡ã£ã¨çœ ããªã£ã¦ããŸâ€¦', 'æ•£æ­©ã—ãŸã„ãª', 'è©±ã—ã‹ã‘ã¦ãã‚Œã‚ˆï¼'],
                greeting: 'ãŠã‹ãˆã‚Šï¼âœ¨<br>ãªã«ã™ã‚‹ï¼Ÿ',
                hoverMessage: 'ã„ã£ã—ã‚‡ã«<br>ã‚ãã¼ã†ï¼',
                chatGreeting: 'ã‚„ãï¼ãƒœã‚¯ã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã ã‚ˆï¼<br>ãªã‚“ã§ã‚‚èã„ã¦ã­ï¼âœ¨',
                colors: { primary: '#FFD700', secondary: '#FFA500', dark: '#FF8C00' }
            },
            'ãƒ‘ãƒ³ãƒ€.png': {
                mumbles: ['ãµããâ€¦ã®ã‚“ã³ã‚Šã™ã‚‹ã­ã‡', 'ãŠæ˜¼å¯ã—ãŸã„ãªã', 'ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆã‰', 'ç¬¹ãŒé£Ÿã¹ãŸã„ãªã', 'ã¾ã£ãŸã‚Šã—ã¦ã‚‹ã­ã‡', 'ã‚ã£ãŸã‹ã„ã­ã‡â€¦', 'æ€¥ãŒãªãã¦ã„ã„ã‚ˆã‰', 'ã¼ãã€ã“ã“ã«ã„ã‚‹ã‚ˆã‰'],
                greeting: 'ã‚„ãâ€¦<br>ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆã‰',
                hoverMessage: 'ã„ã£ã—ã‚‡ã«<br>ã¾ã£ãŸã‚Šã—ã‚ˆã†ã‰',
                chatGreeting: 'ã‚„ãâ€¦ã¼ãã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã ã‚ˆã‰ã€‚<br>ã‚†ã£ãã‚Šã§ã„ã„ã‹ã‚‰ã€ãªã‚“ã§ã‚‚èã„ã¦ã­ã‡ã€‚',
                colors: { primary: '#FEF5DB', secondary: '#F5E6B8', dark: '#E5D090' }
            },
            'ãƒªã‚¹.png': {
                mumbles: ['ã‚‚ã†ã€ä½•ã—ã¦ã‚‹ã®ã‚ˆ', 'ã¡ã‚ƒã‚“ã¨ã‚„ã£ã¦ã‚‹ï¼Ÿ', 'ã—ã‚‡ã†ãŒãªã„ã‚ã­â€¦', 'ã‚¢ã‚¿ã‚·ã«ä»»ã›ãªã•ã„ã‚ˆ', 'ãµã‚“ã€åˆ¥ã«æš‡ã˜ã‚ƒãªã„ã—', 'ä½•ã‹æ‰‹ä¼ã£ã¦ã‚ã’ã‚ˆã†ã‹ï¼Ÿ', 'ã¡ã‚‡ã£ã¨ã€èã„ã¦ã‚‹ã®ï¼Ÿ', 'ã¾ã£ãŸãã€ä¸–è©±ãŒç„¼ã‘ã‚‹ã‚ã­'],
                greeting: 'ãµã‚“ã€ãŠã‹ãˆã‚Šã€‚<br>ãªã«ã‚ˆï¼Ÿ',
                hoverMessage: 'ã—ã‚‡ã†ãŒãªã„ã‚ã­â€¦<br>éŠã‚“ã§ã‚ã’ã‚‹',
                chatGreeting: 'ã‚¢ã‚¿ã‚·ã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã‚ˆã€‚<br>ä½•ã‹ç”¨ï¼Ÿ ã¾ãã€èã„ã¦ã‚ã’ã‚‹ã‚ã€‚',
                colors: { primary: '#FEB6AC', secondary: '#F59A8E', dark: '#E57A6E' }
            },
            'ãƒ•ã‚¯ãƒ­ã‚¦.png': {
                mumbles: ['ãµã‚€â€¦è€ƒãˆäº‹ã‚’ã—ã¦ã„ã¾ã—ãŸ', 'é™ã‹ã§è½ã¡ç€ãã¾ã™ã­', 'çŸ¥è­˜ã¯å®ã§ã™ã‚ˆ', 'ä½•ã‹ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ', 'ã‚†ã£ãã‚Šè€ƒãˆã¾ã—ã‚‡ã†', 'ãªã‚‹ã»ã©â€¦èˆˆå‘³æ·±ã„ã§ã™ã­', 'å­¦ã¶ã“ã¨ã¯æ¥½ã—ã„ã§ã™ã‚ˆ', 'ã„ã¤ã§ã‚‚ãŠæ‰‹ä¼ã„ã—ã¾ã™ã‚ˆ'],
                greeting: 'ãŠã‹ãˆã‚Šãªã•ã„ã€‚<br>ã„ã‹ãŒã„ãŸã—ã¾ã—ã‚‡ã†',
                hoverMessage: 'ãŠè©±ã—ã—ã¾ã—ã‚‡ã†ã‹',
                chatGreeting: 'ã“ã‚“ã«ã¡ã¯ã€‚ç§ã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã¨ç”³ã—ã¾ã™ã€‚<br>ä½•ãªã‚Šã¨ãŠå°‹ã­ãã ã•ã„ã€‚',
                colors: { primary: '#92B7D6', secondary: '#6A9BC5', dark: '#4A7BA5' }
            },
            'ãƒã‚³.png': {
                mumbles: ['â€¦â€¦ãµã', 'â€¦â€¦çœ ã„', 'â€¦â€¦ãªã«ï¼Ÿ', 'â€¦â€¦ã¾ã€ã„ã„ã‘ã©', 'â€¦â€¦æš‡ã ãª', 'â€¦â€¦ãã“ã«ã„ã‚‹ã®ï¼Ÿ', 'â€¦â€¦æ°—ãŒå‘ã„ãŸã‚‰è©±ã™', 'â€¦â€¦åˆ¥ã«å¾…ã£ã¦ãªã„ã—'],
                greeting: 'â€¦â€¦ãŠã‹ãˆã‚Š<br>â€¦â€¦ãªã«ï¼Ÿ',
                hoverMessage: 'â€¦â€¦ã¾ã€ã„ã„ã‘ã©',
                chatGreeting: 'â€¦â€¦{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã€‚<br>â€¦â€¦èããŸã„ã“ã¨ã‚ã‚‹ã®ï¼Ÿ',
                colors: { primary: '#9CBDB6', secondary: '#7AA59D', dark: '#5A8A80' }
            },
            'ã‚¢ãƒ«ãƒ‘ã‚«.png': {
                mumbles: ['ã”ãã’ã‚“ã‚ˆã†', 'ãŠç´…èŒ¶ãŒé£²ã¿ãŸã„ã§ã™ã‚', 'ã‚ˆãã£ã¦ã‚ˆ', 'ã‚ãŸãã—ã«ä»»ã›ãªã•ã„', 'ãµãµã€ç´ æ•µã§ã™ã‚ã­', 'ä½•ã‹ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ', 'ã¤ã„ã¦ã„ã‚‰ã£ã—ã‚ƒã„', 'ã•ã‚ã€ä½•ã§ã‚‚ãŠã£ã—ã‚ƒã£ã¦'],
                greeting: 'ã”ãã’ã‚“ã‚ˆã†<br>ãªã‚“ã§ã—ã‚‡ã†ï¼Ÿ',
                hoverMessage: 'ãŠè©±ã—ã—ã¾ã—ã‚‡ã†',
                chatGreeting: 'ã”ãã’ã‚“ã‚ˆã†ã€‚ã‚ãŸãã—ã¯{{ user.ai_name|default:"ã†ãŸãƒ¼"|escapejs }}ã§ã™ã‚ã€‚<br>ã©ã†ããŠæ°—è»½ã«ãŠè©±ã—ãã ã•ã„ã€‚',
                colors: { primary: '#FFF5CD', secondary: '#F5E8A5', dark: '#E5D580' }
            }
        };

        const charContainer = document.getElementById('charContainer');
        const defaultImg = document.getElementById('characterDefault');
        const hoverImg = document.getElementById('characterHover');
        const speech = document.getElementById('charSpeech');
        const chatTriggerBtn = document.getElementById('chatTriggerBtn');
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’å–å¾—
        const appearance = '{{ appearance|default:"ã‚¤ãƒŒ.png"|escapejs }}';
        const charData = characterDialogues[appearance] || characterDialogues['ã‚¤ãƒŒ.png'];
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—ï¼ˆä¾‹: 'ãƒã‚³.png' -> 'neko'ï¼‰
        const characterCodeMap = {
            'ã‚¦ã‚µã‚®.png': 'usagi',
            'ã‚­ãƒ„ãƒ.png': 'kitsune',
            'ã‚¤ãƒŒ.png': 'inu',
            'ãƒ‘ãƒ³ãƒ€.png': 'panda',
            'ãƒªã‚¹.png': 'risu',
            'ãƒ•ã‚¯ãƒ­ã‚¦.png': 'fukurou',
            'ãƒã‚³.png': 'neko',
            'ã‚¢ãƒ«ãƒ‘ã‚«.png': 'arupaka'
        };
        const characterCode = characterCodeMap[appearance] || 'inu';
        
        // character-containerã«data-characterå±æ€§ã‚’è¿½åŠ ï¼ˆai_chat_base.htmlã§ä½¿ç”¨ï¼‰
        charContainer.setAttribute('data-character', characterCode);
        console.log('è¨­å®šã•ã‚ŒãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼:', appearance, 'ã‚³ãƒ¼ãƒ‰:', characterCode);
        
        // ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’é©ç”¨
        document.documentElement.style.setProperty('--theme-primary', charData.colors.primary);
        document.documentElement.style.setProperty('--theme-secondary', charData.colors.secondary);
        document.documentElement.style.setProperty('--theme-dark', charData.colors.dark);
        document.documentElement.style.setProperty('--theme-light', charData.colors.primary + '20'); // é€æ˜åº¦20%
        
        // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
        let mumbleIndex = 0;
        speech.innerHTML = charData.greeting;
        
        // å®šæœŸçš„ã«ç‹¬ã‚Šè¨€ã‚’å¤‰æ›´ï¼ˆ5ç§’ã”ã¨ï¼‰
        setInterval(() => {
            if (defaultImg.style.opacity !== '0') { // ãƒ›ãƒãƒ¼ã—ã¦ã„ãªã„æ™‚ã®ã¿
                speech.innerHTML = charData.mumbles[mumbleIndex % charData.mumbles.length];
                mumbleIndex++;
            }
        }, 5000);
        
        // ãƒ›ãƒãƒ¼æ™‚ã®å‡¦ç†
        charContainer.addEventListener('mouseenter', () => {
            defaultImg.style.opacity = '0';
            hoverImg.style.opacity = '1';
            speech.innerHTML = charData.hoverMessage;
        });
        charContainer.addEventListener('mouseleave', () => {
            defaultImg.style.opacity = '1';
            hoverImg.style.opacity = '0';
            speech.innerHTML = charData.greeting;
        });
        
        // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®ç‹¬ã‚Šè¨€
        charContainer.addEventListener('click', () => {
            speech.innerHTML = charData.mumbles[mumbleIndex % charData.mumbles.length];
            mumbleIndex++;
        });
        
        // ã€Œã¯ãªã—ã‹ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã§AIãƒãƒ£ãƒƒãƒˆã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’é–‹ã
        if (chatTriggerBtn) {
            chatTriggerBtn.addEventListener('click', function(event) {
                event.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’æ­¢ã‚ã‚‹ï¼ˆdocumentã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²æ­¢ï¼‰
                console.log('ã¯ãªã—ã‹ã‘ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
                // ai_chat_base.htmlã®openAIChat()é–¢æ•°ã‚’å‘¼ã³å‡ºã™
                if (typeof window.openAIChat === 'function') {
                    console.log('window.openAIChaté–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¾ã™');
                    window.openAIChat();
                } else {
                    console.error('window.openAIChaté–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ç›´æ¥è¡¨ç¤º
                    const widget = document.getElementById('character-widget');
                    const bubble = document.getElementById('chat-bubble');
                    if (widget && bubble) {
                        widget.style.display = 'block';
                        bubble.className = 'expanded';
                        const expandedView = document.getElementById('expanded-view');
                        const minimizedView = document.getElementById('minimized-view');
                        if (expandedView && minimizedView) {
                            minimizedView.style.display = 'none';
                            expandedView.style.display = 'flex';
                            expandedView.style.flexDirection = 'column';
                        }
                    }
                }
            });
        }
    </script>

    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="{% static 'codemon/js/tutorial_overlay.js' %}"></script>
    <script>
        // ========================================
        // STEP1ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«: ãƒ¡ã‚¤ãƒ³ç”»é¢ â†’ ã‚·ã‚¹ãƒ†ãƒ é¸æŠ
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå›ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯æ‰‹å‹•èµ·å‹•ã®åˆ¤å®š
            const startTutorial = {{ start_tutorial|default:'false'|lower }};
            
            console.log('DEBUG: start_tutorial =', startTutorial, 'type:', typeof startTutorial);
            
            if (startTutorial) {
                console.log('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹å§‹ã—ã¾ã™');
                // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹å§‹ï¼ˆç”»é¢èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤ï¼‰
                setTimeout(function() {
                    startStep1Tutorial();
                }, 500);
            } else {
                console.log('ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™');
            }
        });

        function startStep1Tutorial() {
            const steps = [
                {
                    target: null,  // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãªã— = ç”»é¢ä¸­å¤®ã«å¤§ããè¡¨ç¤º
                    message: 'Codemonã¸ã‚ˆã†ã“ãï¼âœ¨<br>ã¯ã˜ã‚ã«ã€ã¤ã‹ã„ã‹ãŸã‚’ã›ã¤ã‚ã„ã™ã‚‹ã­ï¼',
                    requireClick: false,
                    showSkip: true,
                    centerMessage: true  // ç”»é¢ä¸­å¤®è¡¨ç¤ºãƒ•ãƒ©ã‚°
                },
                {
                    target: '.character-img',
                    message: 'ã‚ãŸã—ã¯ã€ãã¿ã®ãªã‹ã¾ã ã‚ˆï¼<br>ã„ã¤ã§ã‚‚ã„ã£ã—ã‚‡ã«ãŒã‚“ã°ã‚ã†ã­ï¼ğŸ˜Š',
                    requireClick: false,
                    showSkip: true
                },
                {
                    target: '.panel-system',
                    message: 'ã•ã„ã—ã‚‡ã«ã€ã€Œã‚·ã‚¹ãƒ†ãƒ ã€ã‚’ã¤ãã£ã¦ã¿ã‚ˆã†ï¼<br>ã—ãŸã®<strong>ã‚·ã‚¹ãƒ†ãƒ ãƒœã‚¿ãƒ³</strong>ã‚’ãŠã—ã¦ã­ï¼ğŸ’»',
                    requireClick: true,
                    showSkip: true,
                    onClick: function() {
                        // ã‚·ã‚¹ãƒ†ãƒ ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå¾Œã€æ¬¡ã®ç”»é¢ã§ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ç¶šã‘ã‚‹ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
                        sessionStorage.setItem('tutorial_step1_continue', 'true');
                    }
                }
            ];

            tutorialOverlay.init(steps, {
                onComplete: function() {
                    console.log('STEP1ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å®Œäº†');
                },
                onSkip: function() {
                    // ã‚¹ã‚­ãƒƒãƒ—æ™‚ã¯STEP1ã‚’å®Œäº†æ‰±ã„ã«ã™ã‚‹
                    fetch('/accounts/skip-tutorial-step/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ step: 1 })
                    });
                }
            });
        }

        // CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’æ‰‹å‹•ã§é–‹å§‹ã™ã‚‹é–¢æ•°ï¼ˆãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã—ç”¨ï¼‰
        function startTutorialManually(stepNumber) {
            if (stepNumber === 1) {
                startStep1Tutorial();
            }
            // å°†æ¥çš„ã«STEP2, STEP3ã‚‚è¿½åŠ äºˆå®š
        }
    </script>

    <!-- AIä¼šè©±æ©Ÿèƒ½ï¼ˆå³ä¸‹ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆï¼‰ -->
    {% include 'includes/ai_chat_base.html' %}
</body>
</html>