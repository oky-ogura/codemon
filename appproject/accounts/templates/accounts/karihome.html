
<header class="top-tabs">
  <nav class="tabs">
    <ul>
      <li><a href="#">システムタブ</a></li>
      <li><a href="#">アルゴリズムタブ</a></li>
      <li><a href="{% url 'codemon:checklist_selection' %}">チェックリストタブ</a></li>
      <li><a href="{% url 'accounts:account_entry' %}">アカウント</a>
</li>
    </ul>
  </nav>
</header>

<style>
/* 上部ナビタブの簡易スタイル（このブロックはテンプレート内の<head>に移しても良い） */
.top-tabs { border: 2px solid #000; padding: 6px 8px; background: #fff; }
.tabs ul { margin: 0; padding: 0; list-style: none; display: flex; gap: 8px; }
.tabs li { flex: 1 1 0; text-align: center; }
.tabs a {
  display: inline-block;
  width: 100%;
  padding: 10px 6px;
  border: 1px solid #000;
  text-decoration: none;
  color: #000;
  background: #fff;
  box-sizing: border-box;
}
.tabs a:hover { background: #f5f5f5; }
</style>
<!-- ...existing code... -->

<!-- AI 相棒パネル（内部用途） -->
<div id="ai-assistant-panel" style="position:fixed;right:12px;bottom:12px;width:320px;background:#fff;border:1px solid #333;padding:8px;font-size:13px;z-index:9999;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
    <strong>AI相棒 (内部)</strong>
    <button id="ai-close" style="background:#eee;border:1px solid #999;cursor:pointer;padding:2px 6px;font-size:12px;">×</button>
  </div>
  <div id="ai-messages" style="height:180px;overflow-y:auto;border:1px solid #ccc;padding:4px;background:#fafafa;"></div>
  <div style="margin-top:6px;">
    <input id="ai-input" type="text" placeholder="メッセージ..." style="width:75%;padding:4px;font-size:12px;" />
    <button id="ai-send" style="width:22%;padding:4px;font-size:12px;">送信</button>
  </div>
  <small style="color:#666;display:block;margin-top:6px;">開発用: Gemini API を利用します</small>
  {% csrf_token %}
  <!-- CSRF Cookie 利用のため、フォームレンダリング経由でトークン生成 -->
</div>

<script>
(function(){
  let conversationId = null;
  const panel   = document.getElementById('ai-assistant-panel');
  const messagesEl = document.getElementById('ai-messages');
  const inputEl = document.getElementById('ai-input');
  const sendBtn = document.getElementById('ai-send');
  const closeBtn= document.getElementById('ai-close');

  closeBtn.addEventListener('click', () => { panel.style.display='none'; });

  function append(role, text){
    const div = document.createElement('div');
    div.style.marginBottom='4px';
    div.innerHTML = '<b>' + (role==='user'?'あなた':'AI') + ':</b> ' +
      text.replace(/</g,'&lt;').replace(/>/g,'&gt;');
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  async function send(){
    const msg = inputEl.value.trim();
    if(!msg) return;
    append('user', msg);
    inputEl.value='';
    sendBtn.disabled = true;
    try {
      const resp = await fetch('/codemon/api/ai/chat', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {'Content-Type':'application/json', 'X-CSRFToken': getCsrf()},
        body: JSON.stringify({
          message: msg,
          character: 'arupaka',
          conversation_id: conversationId
        })
      });
      const data = await resp.json();
      if(data.error){
        append('assistant', '[エラー] ' + data.error);
      } else {
        conversationId = data.conversation_id;
        append('assistant', data.reply);
      }
    } catch(e){
      append('assistant', '[通信失敗] ' + e);
    } finally {
      sendBtn.disabled = false;
    }
  }

  function getCsrf(){
    const name = 'csrftoken';
    const cookies = document.cookie.split(';');
    for(const c of cookies){
      const trimmed = c.trim();
      if(trimmed.startsWith(name + '=')) return trimmed.slice(name.length+1);
    }
    return '';
  }

  sendBtn.addEventListener('click', send);
  inputEl.addEventListener('keydown', e => { if(e.key === 'Enter'){ send(); } });
})();
</script>