{% extends 'base.html' %}
{% block global_character_widget %}{% endblock %}
{% load static %}

{% block title %}アカウント{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
        :root {
            --color-system: #3fbcd9;
            --color-algo: #B197FC;
            --color-checklist: #A8E6CF;
            --color-chat: #FFD166;
            --color-mypage: #E0E0E0;
            --color-shop: #ff69b4;
            --color-trophy: #ff9f43;
            --color-account: #4cd97b;
            --color-bg: #f0f4f8;
            --theme-primary: #FFD700;
            --theme-secondary: #FFA500;
            --theme-dark: #FF8C00;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
        min-height: 100vh;
        font-family: 'M PLUS Rounded 1c', sans-serif;
        overflow-x: hidden;
        background-color: transparent;
    }

    .full-background {
        position: fixed;
        inset: 0;
        background-size: cover;
        background-position: center;
        z-index: -1;
        opacity: 0.6;
    }

    .account-container {
        display: grid;
        grid-template-columns: 1fr 380px;
        grid-template-rows: 1fr;
        min-height: calc(100vh - 140px);
        padding: 20px 25px;
        box-sizing: border-box;
        gap: 20px;
        position: relative;
        z-index: 10;
    }

    /* メインカード */
    .main-card {
        grid-column: 1 / 2;
        grid-row: 1 / 2;
        background: white;
        border-radius: 30px;
        padding: 40px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        display: flex;
        align-items: center;
    }

    .account-content {
        display: flex;
        gap: 40px;
        align-items: flex-start;
        width: 100%;
    }

    /* アバター部分 */
    .avatar-section {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }

    .avatar-circle {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        border: 5px solid var(--color-account);
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--color-account), #36b869);
        font-size: 48px;
        color: #fff;
        font-weight: 900;
        box-shadow: 0 8px 20px rgba(76, 217, 123, 0.3);
    }

    .logout-btn {
        background: linear-gradient(135deg, #ff7675, #ff4d4d);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: 900;
        cursor: pointer;
        box-shadow: 0 5px 0 #cc3333;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .logout-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 0 #cc3333;
    }

    .logout-btn:active {
        transform: scale(0.95);
        box-shadow: none;
    }

    /* 情報部分 */
    .info-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .info-row {
        display: flex;
        gap: 30px;
        align-items: center;
    }

    .info-table {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
    }

    .info-item {
        background: linear-gradient(135deg, #f0f4f8, #e6eef5);
        padding: 15px 25px;
        border-radius: 25px;
        display: flex;
        align-items: center;
        border: 3px solid #d0dfe8;
        box-shadow: 0 4px 0 #c0d5e0;
    }

    .info-label {
        width: 100px;
        font-weight: 900;
        color: #555;
        font-size: 15px;
    }

    .info-value {
        flex: 1;
        color: #000;
        font-size: 15px;
        font-weight: 700;
        text-align: left;
    }

    .info-value a {
        color: #0066cc;
        text-decoration: underline;
    }

    /* AI情報カード */
    .ai-card {
        background: linear-gradient(135deg, var(--theme-primary), var(--theme-secondary));
        padding: 25px;
        border-radius: 25px;
        color: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
        box-shadow: 0 8px 20px rgba(255, 215, 0, 0.3);
    }

    .ai-image {
        width: 150px;
        height: 150px;
        object-fit: contain;
        filter: drop-shadow(5px 5px 10px rgba(0, 0, 0, 0.2));
    }

    .ai-name {
        font-size: 20px;
        font-weight: 900;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }

    .ai-stats {
        text-align: center;
        font-size: 14px;
        font-weight: 700;
        opacity: 0.95;
    }

        /* キャラクター領域 */
        .character-area {
            grid-column: 2 / 3;
        grid-row: 1 / 2;
            justify-content: center;
        }

        .character-container {
            position: relative;
            width: 100%;
            height: 85vh;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }

        .character-img {
            max-height: 100%;
            width: auto;
            max-width: 420px;
            filter: drop-shadow(15px 15px 0 rgba(0, 0, 0, 0.05));
            transition: transform 0.3s ease;
            cursor: pointer;
            position: absolute;
            bottom: 0;
        }

        .character-img.hover {
            opacity: 0;
        }

        .speech-bubble {
            position: absolute;
            top: 80px;
            right: 60px;
            background: white;
            border: 4px solid var(--theme-primary);
            padding: 15px 25px;
            border-radius: 25px;
            font-weight: 900;
            box-shadow: 0 10px 0 rgba(0, 0, 0, 0.05);
            z-index: 100;
            animation: float 3s ease-in-out infinite;
            color: #333;
            min-width: 150px;
            text-align: center;
        }

        .speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 30px;
            border-left: 12px solid transparent;
            border-right: 12px solid transparent;
            border-top: 15px solid var(--theme-primary);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* レスポンシブ */
        @media(max-width: 1200px) {
            .account-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
            }
            
            .character-area {
                grid-column: 1 / 2;
                grid-row: 3 / 4;
                height: 300px;
            }
            
            .character-container {
                height: 100%;
            }
            
            .account-content {
                flex-direction: column;
            }
        }
</style>
{% endblock %}

{% block content %}
<div class="full-background" style="background-image: url('{% static "codemon/images/backgrounds/bg_common.png" %}');"></div>

<div class="account-container">
    <!-- メインカード -->
        <div class="main-card">
            <div class="account-content">
                <!-- アバター部分 -->
                <div class="avatar-section">
                    {% with display_name=account.user_name|default:"?" %}
                        {% with initial=display_name|slice:":1" %}
                            <div class="avatar-circle">
                                <span class="initial-text">{{ initial|upper }}</span>
                            </div>
                        {% endwith %}
                    {% endwith %}
                    
                    <form id="logout-form" method="get" action="{% url 'accounts:logout_confirm' %}">
                        <button type="submit" class="logout-btn">
                            <i class="fas fa-sign-out-alt"></i> ログアウト
                        </button>
                    </form>
                </div>

                <!-- 情報部分 -->
                <div class="info-section">
                    <div class="info-row">
                        <div class="info-table">
                            <div class="info-item">
                                <span class="info-label">ID</span>
                                <span class="info-value">{% if account %}{{ account.user_id }}{% else %}---{% endif %}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">名前</span>
                                <span class="info-value">{% if account %}{{ account.user_name }}{% else %}ゲスト{% endif %}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">年齢</span>
                                <span class="info-value">{% if account and account.age is not None %}{{ account.age }}歳{% else %}--{% endif %}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">グループ</span>
                                <span class="info-value">
                                    {% if joined_group %}
                                        {{ joined_group.group_name }}
                                    {% else %}
                                        <a href="{% url 'accounts:group_join_confirm' %}">グループ参加</a>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                        
                        <!-- AI情報カード -->
                        <div class="ai-card">
                            {% if ai_config and ai_config.appearance %}
                                <img src="{% static 'codemon/images/characters/' %}{{ ai_config.appearance }}" 
                                     alt="AI" 
                                     class="ai-image"
                                     onerror="this.src='{% static 'codemon/images/characters/イヌ.png' %}'">
                            {% else %}
                                <img src="{% static 'codemon/images/characters/イヌ.png' %}" 
                                     alt="AI" 
                                     class="ai-image">
                            {% endif %}
                            
                            <div class="ai-name">{{ ai_config.ai_name|default:"CodeMon" }}</div>
                            
                            <div class="ai-stats">
                                <div>初めて会った日</div>
                                <div>{% if first_met %}{{ first_met|date:"Y/m/d" }}{% else %}--{% endif %}</div>
                                <div style="margin-top: 8px;">累計 {% if total_days %}{{ total_days }}{% else %}0日{% endif %}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- キャラクター領域 -->
        <div class="character-area">
            <div class="speech-bubble" id="charSpeech">
                あなたの情報だよ！✨
            </div>

            <div class="character-container" id="charContainer">
                <img src="{% static 'codemon/images/characters/' %}{{ appearance }}" class="character-img" id="characterDefault">
                <img src="{% static 'codemon/images/characters/' %}{{ appearance|slice:':-4' }} 笑顔.png" class="character-img hover" id="characterHover">
            </div>
        </div>
    </div>

<script>
    // キャラクター別台詞と色の設定
    const characterDialogues = {
            'ウサギ.png': {
                mumbles: ['え、えっと…何しようかな…', 'ぼ、ぼく、ここにいるよ…', 'う、うんと…少し眠いかも…'],
                greeting: 'あなたの情報だよ！✨',
                hoverMessage: 'がんばってるね！',
                colors: { primary: '#F5E3F4', secondary: '#E8C4E8', dark: '#D4A5D4' }
            },
            'キツネ.png': {
                mumbles: ['ふぁ…退屈だなぁ', 'なんか面白いことないかね', 'ま、暇つぶしにはなるか'],
                greeting: 'これがお前の情報さ',
                hoverMessage: 'ま、悪くないな',
                colors: { primary: '#FCD37D', secondary: '#F5B942', dark: '#E5A020' }
            },
            'イヌ.png': {
                mumbles: ['今日もいい天気だな！', '誰か遊びに来ないかな', 'お腹すいてきたぞ'],
                greeting: 'あなたの情報だよ！✨',
                hoverMessage: 'いっしょにがんばろう！',
                colors: { primary: '#FFD700', secondary: '#FFA500', dark: '#FF8C00' }
            },
            'パンダ.png': {
                mumbles: ['ふぁぁ…のんびりするねぇ', 'お昼寝したいなぁ', 'ゆっくりでいいよぉ'],
                greeting: 'あなたの情報だよぉ',
                hoverMessage: 'のんびりでいいよぉ',
                colors: { primary: '#FEF5DB', secondary: '#F5E6B8', dark: '#E5D090' }
            },
            'リス.png': {
                mumbles: ['もう、何してるのよ', 'ちゃんとやってる？', 'しょうがないわね…'],
                greeting: 'これがアナタの情報よ',
                hoverMessage: 'ちゃんと確認しなさいよ',
                colors: { primary: '#FEB6AC', secondary: '#F59A8E', dark: '#E57A6E' }
            },
            'フクロウ.png': {
                mumbles: ['ふむ…考え事をしていました', '静かで落ち着きますね', '知識は宝ですよ'],
                greeting: 'あなたの情報です',
                hoverMessage: 'ご確認ください',
                colors: { primary: '#92B7D6', secondary: '#6A9BC5', dark: '#4A7BA5' }
            },
            'ネコ.png': {
                mumbles: ['……ふぁ', '……眠い', '……なに？'],
                greeting: '……あなたの情報',
                hoverMessage: '……見てるの？',
                colors: { primary: '#9CBDB6', secondary: '#7AA59D', dark: '#5A8A80' }
        },
        'アルパカ.png': {
            mumbles: ['ふわふわ〜', '気持ちいいなぁ', 'のんびりだね'],
            greeting: 'あなたの情報だよ〜',
            hoverMessage: 'ふわふわ〜',
            colors: { primary: '#F0E8D8', secondary: '#E0D0B8', dark: '#D0C0A8' }
        }
    };

    const charContainer = document.getElementById('charContainer');
    const defaultImg = document.getElementById('characterDefault');
    const hoverImg = document.getElementById('characterHover');
    const speech = document.getElementById('charSpeech');
    
    // キャラクター設定を取得
    const appearance = '{{ appearance|default:"イヌ.png"|escapejs }}';
    const charData = characterDialogues[appearance] || characterDialogues['イヌ.png'];
    
    // テーマカラーを適用
    document.documentElement.style.setProperty('--theme-primary', charData.colors.primary);
    document.documentElement.style.setProperty('--theme-secondary', charData.colors.secondary);
    document.documentElement.style.setProperty('--theme-dark', charData.colors.dark);
    
    // 初期メッセージを設定
    let mumbleIndex = 0;
    speech.innerHTML = charData.greeting;
    
    // 定期的に独り言を変更（5秒ごと）
    setInterval(() => {
        if (defaultImg.style.opacity !== '0') {
            speech.innerHTML = charData.mumbles[mumbleIndex % charData.mumbles.length];
            mumbleIndex++;
        }
    }, 5000);
    
    // ホバー時の処理
    charContainer.addEventListener('mouseenter', () => {
        defaultImg.style.opacity = '0';
        hoverImg.style.opacity = '1';
        speech.innerHTML = charData.hoverMessage;
    });
    charContainer.addEventListener('mouseleave', () => {
        defaultImg.style.opacity = '1';
        hoverImg.style.opacity = '0';
        speech.innerHTML = charData.greeting;
    });
    
    // キャラクタークリックで次の独り言
    charContainer.addEventListener('click', () => {
        speech.innerHTML = charData.mumbles[mumbleIndex % charData.mumbles.length];
        mumbleIndex++;
    });
</script>
{% endblock %}

{% block ai_chat_widget %}
    <!-- AI会話機能（右下ウィジェット） -->
    {% include 'includes/ai_chat_base.html' %}
{% endblock %}
