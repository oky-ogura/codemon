
{% extends 'base.html' %}
{% load static %}

{% block title %}アカウント（教員） - Codemon{% endblock %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/教員用アカウント画面 (2).png' %}" 
     alt="" 
     class="bg-frame"
     onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
    <style>
        
        

        /* メインカード */
        /* ヘッダーが固定表示のため、このページだけ上部に余白を確保する */
        /* 余白をやや大きめにしてヘッダーとの重なりを防止 */

        .card { max-width:1000px; margin:160px auto 40px; background:transparent; border:none; padding:18px; box-shadow:none; box-sizing:border-box; max-height:calc(100vh - 200px); overflow:visible; }

        .main { display:flex; gap:24px; align-items:flex-start; }
        .left { width:180px; flex-shrink:0; text-align:center; }
        .avatar-circle {
            width:140px; height:140px; border-radius:50%; border:3px solid #bbb; display:flex; align-items:center; justify-content:center; background:#fafafa; font-size:48px; margin:6px auto;
        }

        /* イニシャルごとの背景色（A-Z） */
        .avatar-circle.initial-A { background:#1abc9c; color:#fff; }
        .avatar-circle.initial-B { background:#2ecc71; color:#fff; }
        .avatar-circle.initial-C { background:#3498db; color:#fff; }
        .avatar-circle.initial-D { background:#9b59b6; color:#fff; }
        .avatar-circle.initial-E { background:#34495e; color:#fff; }
        .avatar-circle.initial-F { background:#16a085; color:#fff; }
        .avatar-circle.initial-G { background:#27ae60; color:#fff; }
        .avatar-circle.initial-H { background:#2980b9; color:#fff; }
        .avatar-circle.initial-I { background:#8e44ad; color:#fff; }
        .avatar-circle.initial-J { background:#2c3e50; color:#fff; }
        .avatar-circle.initial-K { background:#f39c12; color:#fff; }
        .avatar-circle.initial-L { background:#d35400; color:#fff; }
        .avatar-circle.initial-M { background:#c0392b; color:#fff; }
        .avatar-circle.initial-N { background:#7f8c8d; color:#fff; }
        .avatar-circle.initial-O { background:#e67e22; color:#fff; }
        .avatar-circle.initial-P { background:#e74c3c; color:#fff; }
        .avatar-circle.initial-Q { background:#1f618d; color:#fff; }
        .avatar-circle.initial-R { background:#117a65; color:#fff; }
        .avatar-circle.initial-S { background:#9b59b6; color:#fff; }
        .avatar-circle.initial-T { background:#2e86c1; color:#fff; }
        .avatar-circle.initial-U { background:#17a589; color:#fff; }
        .avatar-circle.initial-V { background:#b03a2e; color:#fff; }
        .avatar-circle.initial-W { background:#45b39d; color:#fff; }
        .avatar-circle.initial-X { background:#5dade2; color:#fff; }
        .avatar-circle.initial-Y { background:#f5b041; color:#fff; }
        .avatar-circle.initial-Z { background:#a569bd; color:#fff; }

        .initial-text { font-size:48px; line-height:1; color:inherit; font-weight:700; }
        .meta { margin-top:10px; font-size:14px; color:#333; }
        .logout-area { margin-top:14px; }

        .info { flex:1; }
        .info-table { border-collapse:collapse; }
        .info-table td { padding:8px 12px; vertical-align:middle; }
        .info-table .label { font-weight:700; color:#333; background:#fff; border:1px solid #ddd; border-right:none; border-radius:20px 0 0 20px; }
        .info-table .value { color:#000; background:#5DD4F5; border:1px solid #5DD4F5; border-left:none; border-radius:0 20px 20px 0; }

        .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .id-box { font-size:18px; font-weight:700; color:#333; }

        /* グループリスト */
        .groups { margin-top:-20px; display:flex; flex-direction:column; gap:10px; }
        .groups-list { display:flex; flex-direction:column; gap:10px; max-height:200px; overflow-y:auto; padding-right:4px; margin-top:-20px; padding-bottom:10px; }
        .groups-list::-webkit-scrollbar { width:8px; }
        .groups-list::-webkit-scrollbar-track { background:#f1f1f1; border-radius:4px; }
        .groups-list::-webkit-scrollbar-thumb { background:#bbb; border-radius:4px; }
        .groups-list::-webkit-scrollbar-thumb:hover { background:#999; }
        .group-row { display:flex; align-items:center; gap:12px; padding:8px; border-radius:6px; background:#f8f9fb; border:1px solid #e6e9ee; }
        .group-name { flex:1; font-weight:600; color:#222; }
        .group-meta { color:#666; font-size:13px; }
        .btn { padding:6px 10px; border-radius:6px; border:1px solid #bbb; background:#f0f2f5; cursor:pointer; font-size:13px; }
        .btn.detail { background:transparent; border:none; padding:4px; transition:transform 0.2s ease, opacity 0.2s ease; }
        .btn.detail:hover { transform:scale(1.1); opacity:0.7; }
        .btn.del { background:transparent; border:none; padding:4px; transition:transform 0.2s ease, opacity 0.2s ease; }
        .btn.del:hover { transform:scale(1.1); opacity:0.7; }
        .btn.create { background:transparent; border:none; padding:4px; transition:transform 0.2s ease, opacity 0.2s ease; }
        .btn.create:hover { transform:scale(1.1); opacity:0.7; }
        .btn.logout { background:transparent; border:none; padding:4px; cursor:pointer; transition:transform 0.2s ease, opacity 0.2s ease; outline:none; }
        .btn.logout:hover { transform:scale(1.1); opacity:0.7; }
        .btn.logout:focus { outline:none; }

        /* レスポンシブ */
        @media(max-width:720px){
            .main { flex-direction:column; }
            .left { width:100%; text-align:left; display:flex; gap:12px; align-items:center; }
            .avatar-circle { width:96px; height:96px; font-size:32px; }
            /* モバイルではヘッダーが狭くなるので余白を小さく調整 */
            .card { margin-top:120px; }
        }
    </style>
{% endblock %}
</head>
{% block content %}

    <div class="card">
        <div class="main">
            <div class="left">
                {% with display_name=account.user_name|default:user.get_full_name|default:"codemon" %}
                    {% with initial=display_name|slice:":1" %}
                        <div class="avatar-circle {% if not user.profile.avatar %}initial-{{ initial|upper }}{% endif %}">
                            {% if user.profile.avatar %}
                                <img src="{{ user.profile.avatar.url }}" alt="avatar" style="width:100%;height:100%;border-radius:50%;">
                            {% else %}
                                <span class="initial-text">{{ initial|upper }}</span>
                            {% endif %}
                        </div>
                    {% endwith %}
                {% endwith %}

                <div class="meta">
                    <div class="logout-area">
                        <form id="logout-form" method="get" action="{% url 'accounts:logout_confirm' %}">
                            <button type="submit" id="logout-btn" class="btn logout">
                                <img src="{% static 'codemon/images/nav/教員用アカウント画面 (17).png' %}" alt="ログアウト" style="height:40px; display:block;">
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="info">
                <div class="top-row">
                    <div style="flex:1;overflow:hidden;">
                        <div style="display:flex;gap:30px;align-items:center;margin-top:12px;flex-wrap:wrap;">
                            <table class="info-table" style="flex-shrink:0;border-spacing:0 8px;min-width:240px;">
                                <tr>
                                    <td colspan="2" style="padding:0;background:url('{% static 'codemon/images/nav/教員用アカウント画面 (10).png' %}') no-repeat center/100% 100%;height:50px;border-radius:25px;display:flex;align-items:center;">
                                        <span style="width:70px;padding-left:20px;font-weight:700;color:#333;font-size:15px;">ID</span>
                                        <span style="flex:1;padding-right:20px;color:#000;font-size:15px;text-align:center;">{{ account.user_id|default:user.id }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding:0;background:url('{% static 'codemon/images/nav/教員用アカウント画面 (10).png' %}') no-repeat center/100% 100%;height:50px;border-radius:25px;display:flex;align-items:center;">
                                        <span style="width:70px;padding-left:20px;font-weight:700;color:#333;font-size:15px;">名前</span>
                                        <span style="flex:1;padding-right:20px;color:#000;font-size:15px;text-align:center;">{{ account.user_name|default:user.get_full_name|default:"codemon" }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding:0;background:url('{% static 'codemon/images/nav/教員用アカウント画面 (10).png' %}') no-repeat center/100% 100%;height:50px;border-radius:25px;display:flex;align-items:center;">
                                        <span style="width:70px;padding-left:20px;font-weight:700;color:#333;font-size:15px;">年齢</span>
                                        <span style="flex:1;padding-right:20px;color:#000;font-size:15px;text-align:center;">{{ account.age|default:user.profile.age|default:"38" }}歳</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="padding:0;background:url('{% static 'codemon/images/nav/教員用アカウント画面 (10).png' %}') no-repeat center/100% 100%;height:50px;border-radius:25px;display:flex;align-items:center;">
                                        <span style="width:70px;padding-left:20px;font-weight:700;color:#333;font-size:15px;">所属</span>
                                        <span style="flex:1;padding-right:20px;color:#000;font-size:15px;text-align:center;">{{ account.account_type|default:user.profile.kyojin|default:"教員" }}</span>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- AI画像 -->
                            <div style="text-align:center;flex-shrink:0;">
                                {% if ai_config and ai_config.appearance %}
                                    <img src="{% static 'codemon/images/characters/' %}{{ ai_config.appearance }}" 
                                         alt="AI" 
                                         style="width:150px;height:150px;object-fit:contain;display:block;"
                                         onerror="this.src='{% static 'codemon/images/characters/イヌ.png' %}'">
                                {% else %}
                                    <div style="width:150px;height:150px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:48px;">⚪︎</div>
                                {% endif %}
                            </div>
                            
                            <!-- AI名前と日付情報 -->
                            <div style="display:flex;flex-direction:column;gap:8px;flex-shrink:1;min-width:200px;">
                                <div style="padding:0;background:url('{% static 'codemon/images/nav/教員用アカウント画面 (10).png' %}') no-repeat center/100% 100%;height:50px;border-radius:25px;display:flex;align-items:center;">
                                    <span style="width:70px;padding-left:20px;font-weight:700;color:#333;font-size:15px;">名前</span>
                                    <span style="flex:1;padding-right:20px;color:#000;font-size:15px;text-align:center;">{{ ai_config.ai_name|default:"codemon" }}</span>
                                </div>
                                <div style="text-align:center;font-size:14px;color:#666;">
                                    <div>初めて会った日　{% if first_met %}{{ first_met|date:"Y/m/d" }}{% else %}---{% endif %}</div>
                                    <div style="margin-top:4px;">累計　{{ total_days|default:"0日" }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="groups">
                    <div class="groups-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="font-weight:700; color:#444;">グループ</div>
                        <div class="groups-actions" style="margin-left:12px;">
                            <a class="btn create" href="{% url 'accounts:group_create' %}" aria-label="新規作成">
                                <img src="{% static 'codemon/images/nav/教員用アカウント画面 (11).png' %}" alt="新規作成" style="height:40px; display:block;">
                            </a>
                        </div>
                    </div>
                    <div class="groups-list">
                        {% if groups %}
                            {% for g in groups %}
                                <div class="group-row">
                                    <div class="group-name">{{ g.name }}</div>
                                    <div class="group-meta">{{ g.member_count }}人</div>
                                    <a class="btn detail" href="{% url 'accounts:group_menu' g.group_id %}" aria-label="詳細">
                                        <img src="{% static 'codemon/images/nav/教員用アカウント画面 (14).png' %}" alt="詳細" style="height:40px; display:block;">
                                    </a>
                                    <!-- 削除はページ内確認モーダルを表示してから遷移します -->
                                    <button type="button" class="btn del" data-delete-url="{% url 'accounts:group_delete' g.group_id %}" aria-label="削除">
                                        <img src="{% static 'codemon/images/nav/教員用アカウント画面 (15).png' %}" alt="削除" style="height:40px; display:block;">
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="padding:10px 6px; color:#666;">グループはありません</div>
                        {% endif %}
                    </div>
                </div>

            </div>
    </div>



    <!-- グループ削除用モーダル -->
    <div id="group-delete-modal" aria-hidden="true" style="display:none; position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1200;">
        <div class="box" role="dialog" aria-modal="true" aria-labelledby="gdel-title" style="background:#fff;padding:20px;border-radius:8px;min-width:320px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div id="gdel-title" style="font-weight:700; margin-bottom:10px;">本当にこのグループを削除しますか？</div>
            <div style="color:#666; font-size:14px;">削除すると復元できません。よろしいですか？</div>
            <div class="buttons" style="margin-top:18px;display:flex;gap:12px;justify-content:center">
                <button class="btn" id="gdel-cancel" style="padding:8px 14px;border-radius:6px;border:none;background:#e0e6ef">戻る</button>
                <button class="btn del" id="gdel-confirm" style="padding:8px 14px;border-radius:6px;border:none;background:#ff6b6b;color:#fff">削除する</button>
            </div>
        </div>
    </div>

    <script>
    (function(){
        var deleteButtons = document.querySelectorAll('button.btn.del[data-delete-url]');
        var modal = document.getElementById('group-delete-modal');
        var cancel = document.getElementById('gdel-cancel');
        var confirm = document.getElementById('gdel-confirm');
        var targetUrl = null;

        function openModal(url){
            targetUrl = url;
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden','false');
            // focus the cancel button for accessibility
            cancel && cancel.focus();
        }

        function closeModal(){
            targetUrl = null;
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden','true');
        }

        deleteButtons.forEach(function(btn){
            btn.addEventListener('click', function(e){
                var url = btn.getAttribute('data-delete-url');
                if(!url) return;
                openModal(url);
            });
        });

        if(cancel){ cancel.addEventListener('click', closeModal); }

    // CSRF helper: read cookie
    function getCookie(name) {
      var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    if(confirm){ confirm.addEventListener('click', function(){
        if(!targetUrl){ closeModal(); return; }
        // send POST via fetch to delete endpoint
        var csrf = getCookie('csrftoken') || getCookie('csrf');
        fetch(targetUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrf,
                'Accept': 'application/json'
            }
        }).then(function(resp){
            if(!resp.ok){ return resp.json().then(function(j){ throw j; }); }
            return resp.json();
        }).then(function(json){
            // Success: remove the group row element
            try{
                // find the button that opened the modal (nearest match by data-delete-url)
                var opener = document.querySelector('button.btn.del[data-delete-url="' + targetUrl + '"]');
                if(opener){
                    var row = opener.closest('.group-row');
                    if(row){ row.parentNode.removeChild(row); }
                }
            }catch(e){ /* ignore DOM errors */ }
            closeModal();
        }).catch(function(err){
            // show an alert on error
            try{
                var msg = (err && err.error) ? err.error : '削除に失敗しました';
                alert(msg);
            }catch(e){ alert('削除に失敗しました'); }
            closeModal();
        });
    }); }

        // ESC で閉じる
        document.addEventListener('keydown', function(ev){ if(ev.key === 'Escape' && modal && modal.style.display === 'flex'){ closeModal(); } });
    })();
    </script>

        </div>
    </div>
    <!-- ページ専用: ヘッダー高さに合わせてカードの上マージンを調整 -->
    <script>
    (function(){
        function adjustCardMargin(){
            try{
                var header = document.querySelector('.top-tabs');
                var card = document.querySelector('.card');
                if(!header || !card) return;
                var rect = header.getBoundingClientRect();
                var bottom = rect.bottom || 0;
                var extra = 18; // ヘッダーと本文の余裕
                var pad = Math.ceil(bottom + extra);
                // inline style で確実に上マージンを適用
                card.style.marginTop = pad + 'px';
            }catch(e){ console.error('adjustCardMargin error', e); }
        }

        document.addEventListener('DOMContentLoaded', adjustCardMargin);
        window.addEventListener('load', adjustCardMargin);
        window.addEventListener('resize', adjustCardMargin);
        // 遅延レイアウト変化にも対応
        setTimeout(adjustCardMargin, 300);
        setTimeout(adjustCardMargin, 1000);
    })();
    </script>
{% endblock %}
