<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆæ•™å“¡ï¼‰</title>
    <style>
        body { font-family: "Segoe UI", Meiryo, sans-serif; background:#f5f7fa; margin:0; padding:20px; }
        /* ä¸Šéƒ¨ã‚¿ãƒ– */
        .top-tabs { max-width:1000px; margin:0 auto 18px; border:2px solid #333; background:#fff; padding:6px 8px; box-sizing:border-box; }
        .tabs { display:flex; gap:0; }
        .tabs a { flex:1 0 auto; display:block; padding:8px 12px; border-right:1px solid #333; text-align:center; text-decoration:none; color:#111; font-weight:600; }
        .tabs a:last-child { border-right: none; }

        /* ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰ */
        .card { max-width:1000px; margin:0 auto; background:#fff; border:1px solid #ddd; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.05); box-sizing:border-box; }

        .main { display:flex; gap:24px; align-items:flex-start; }
        .left { width:220px; text-align:center; }
        .avatar-circle {
            width:140px; height:140px; border-radius:50%; border:3px solid #bbb; display:flex; align-items:center; justify-content:center; background:#fafafa; font-size:48px; margin:6px auto;
        }
        .meta { margin-top:10px; font-size:14px; color:#333; }
        .logout-area { margin-top:14px; }

        .info { flex:1; }
        .info-table { width:100%; border-collapse:collapse; }
        .info-table td { padding:6px 8px; vertical-align:top; }
        .info-table .label { width:140px; font-weight:700; color:#666; }
        .info-table .value { color:#222; }

        .top-row { display:flex; justify-content:space-between; align-items:center; gap:12px; }
        .id-box { font-size:18px; font-weight:700; color:#333; }

        /* ã‚°ãƒ«ãƒ¼ãƒ—ãƒªã‚¹ãƒˆ */
        .groups { margin-top:16px; display:flex; flex-direction:column; gap:10px; }
        .group-row { display:flex; align-items:center; gap:12px; padding:8px; border-radius:6px; background:#f8f9fb; border:1px solid #e6e9ee; }
        .group-name { flex:1; font-weight:600; color:#222; }
        .group-meta { color:#666; font-size:13px; }
        .btn { padding:6px 10px; border-radius:6px; border:1px solid #bbb; background:#f0f2f5; cursor:pointer; font-size:13px; }
        .btn.detail { background:#e8f0ff; border-color:#9cc0ff; }
        .btn.del { background:#ffecec; border-color:#ffa6a6; }
        .btn.logout { background:#2b8cff; color:#fff; border:none; padding:10px 18px; border-radius:8px; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media(max-width:720px){
            .main { flex-direction:column; }
            .left { width:100%; text-align:left; display:flex; gap:12px; align-items:center; }
            .avatar-circle { width:96px; height:96px; font-size:32px; }
        }
    </style>
</head>
<body>
    <div class="top-tabs">
        <nav class="tabs">
            <a href="#">ã‚·ã‚¹ãƒ†ãƒ </a>
            <a href="#">ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ </a>
            <a href="#">é€²æ—ç®¡ç†</a>
            <a href="{% url 'accounts:karihome' %}">ãƒ›ãƒ¼ãƒ </a>
        </nav>
    </div>

    <div class="card">
        <div class="main">
            <div class="left">
                <div class="avatar-circle">
                    {% if user.profile.avatar %}
                        <img src="{{ user.profile.avatar.url }}" alt="avatar" style="width:100%;height:100%;border-radius:50%;">
                    {% else %}
                        ğŸ‘¤
                    {% endif %}
                </div>

                <div class="meta">
                    <div>ID <strong>{{ account.user_id|default:user.id }}</strong></div>
                    <div>åå‰ <strong>{{ account.user_name|default:user.get_full_name|default:"codemon" }}</strong></div>
                    <div>å¹´é½¢ {{ account.age|default:user.profile.age|default:"38æ­³" }}</div>

                    <div class="logout-area">
                        <form id="logout-form" method="post" action="{% url 'accounts:logout' %}">
                            {% csrf_token %}
                            <button type="button" id="logout-btn" class="btn logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="info">
                <div class="top-row">
                    <div class="id-box">åå‰: {{ account.user_name|default:user.get_full_name|default:"codemon" }}</div>
                    <div style="text-align:right">
                        <div>åˆã‚ã¦ä¼šã£ãŸæ—¥: <strong>{% if first_met %}{{ first_met|date:"Y/n/j" }}{% else %}---{% endif %}</strong></div>
                        <div>ç´¯è¨ˆæ—¥æ•°: <strong>{{ total_days|default:"0æ—¥" }}</strong></div>
                    </div>
                </div>

                <table class="info-table" style="margin-top:12px;">
                    <tr><td class="label">æ‰€å±</td><td class="value">{{ account.account_type|default:user.profile.kyojin|default:"æ•™å“¡" }}</td></tr>
                </table>

                <div class="groups">
                    <div class="groups-header" style="display:flex; align-items:center; justify-content:space-between;">
                        <div style="font-weight:700; color:#444;">ã‚°ãƒ«ãƒ¼ãƒ—</div>
                        <div class="groups-actions" style="margin-left:12px;">
                            <a class="btn" href="{% url 'accounts:group_create' %}">æ–°è¦ä½œæˆ</a>
                        </div>
                    </div>
                        {% if groups %}
                            {% for g in groups %}
                                <div class="group-row">
                                    <div class="group-name">{{ g.name }}</div>
                                    <div class="group-meta">{{ g.member_count }}äºº</div>
                                    <a class="btn detail" href="{% url 'accounts:group_menu' g.group_id %}">è©³ç´°</a>
                                    <!-- å‰Šé™¤ã¯ãƒšãƒ¼ã‚¸å†…ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã¦ã‹ã‚‰é·ç§»ã—ã¾ã™ -->
                                    <button type="button" class="btn del" data-delete-url="{% url 'accounts:group_delete' g.group_id %}">å‰Šé™¤</button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="padding:10px 6px; color:#666;">ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“</div>
                        {% endif %}

                        
                        
                    </div>

                </div>

            </div>
    </div>

  <!-- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆs_account ã¨åŒã˜æ§‹æˆï¼‰ -->
  <div id="confirm-modal" aria-hidden="true" style="display:none; position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);align-items:center;justify-content:center">
    <div class="box" role="dialog" aria-modal="true" aria-labelledby="confirm-title" style="background:#fff;padding:20px;border-radius:8px;min-width:320px;text-align:center">
      <div id="confirm-title">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="buttons" style="margin-top:16px;display:flex;gap:12px;justify-content:center">
        <button class="btn yes" id="confirm-yes" style="padding:8px 14px;border-radius:6px;border:none;background:#f46b6b;color:#fff">ã¯ã„</button>
        <button class="btn no" id="confirm-no" style="padding:8px 14px;border-radius:6px;border:none;background:#e0e6ef">ã„ã„ãˆ</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    var logoutBtn = document.getElementById('logout-btn');
    var logoutForm = document.getElementById('logout-form');
    var modal = document.getElementById('confirm-modal');
    var yes = document.getElementById('confirm-yes');
    var no = document.getElementById('confirm-no');
    if(logoutBtn){ logoutBtn.addEventListener('click', function(){ modal.style.display = 'flex'; }); }
    if(no){ no.addEventListener('click', function(){ modal.style.display = 'none'; }); }
    if(yes){ yes.addEventListener('click', function(){ if(logoutForm) logoutForm.submit(); }); }
  })();
  </script>

    <!-- ã‚°ãƒ«ãƒ¼ãƒ—å‰Šé™¤ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="group-delete-modal" aria-hidden="true" style="display:none; position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:1200;">
        <div class="box" role="dialog" aria-modal="true" aria-labelledby="gdel-title" style="background:#fff;padding:20px;border-radius:8px;min-width:320px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
            <div id="gdel-title" style="font-weight:700; margin-bottom:10px;">æœ¬å½“ã«ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</div>
            <div style="color:#666; font-size:14px;">å‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</div>
            <div class="buttons" style="margin-top:18px;display:flex;gap:12px;justify-content:center">
                <button class="btn" id="gdel-cancel" style="padding:8px 14px;border-radius:6px;border:none;background:#e0e6ef">æˆ»ã‚‹</button>
                <button class="btn del" id="gdel-confirm" style="padding:8px 14px;border-radius:6px;border:none;background:#ff6b6b;color:#fff">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
    (function(){
        var deleteButtons = document.querySelectorAll('button.btn.del[data-delete-url]');
        var modal = document.getElementById('group-delete-modal');
        var cancel = document.getElementById('gdel-cancel');
        var confirm = document.getElementById('gdel-confirm');
        var targetUrl = null;

        function openModal(url){
            targetUrl = url;
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden','false');
            // focus the cancel button for accessibility
            cancel && cancel.focus();
        }

        function closeModal(){
            targetUrl = null;
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden','true');
        }

        deleteButtons.forEach(function(btn){
            btn.addEventListener('click', function(e){
                var url = btn.getAttribute('data-delete-url');
                if(!url) return;
                openModal(url);
            });
        });

        if(cancel){ cancel.addEventListener('click', closeModal); }

    // CSRF helper: read cookie
    function getCookie(name) {
      var v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }

    if(confirm){ confirm.addEventListener('click', function(){
        if(!targetUrl){ closeModal(); return; }
        // send POST via fetch to delete endpoint
        var csrf = getCookie('csrftoken') || getCookie('csrf');
        fetch(targetUrl, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrf,
                'Accept': 'application/json'
            }
        }).then(function(resp){
            if(!resp.ok){ return resp.json().then(function(j){ throw j; }); }
            return resp.json();
        }).then(function(json){
            // Success: remove the group row element
            try{
                // find the button that opened the modal (nearest match by data-delete-url)
                var opener = document.querySelector('button.btn.del[data-delete-url="' + targetUrl + '"]');
                if(opener){
                    var row = opener.closest('.group-row');
                    if(row){ row.parentNode.removeChild(row); }
                }
            }catch(e){ /* ignore DOM errors */ }
            closeModal();
        }).catch(function(err){
            // show an alert on error
            try{
                var msg = (err && err.error) ? err.error : 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ';
                alert(msg);
            }catch(e){ alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
            closeModal();
        });
    }); }

        // ESC ã§é–‰ã˜ã‚‹
        document.addEventListener('keydown', function(ev){ if(ev.key === 'Escape' && modal && modal.style.display === 'flex'){ closeModal(); } });
    })();
    </script>

        </div>
    </div>
</body>
</html>