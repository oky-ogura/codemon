<script>
// ---------------------- ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿ãƒ–ãƒ­ãƒƒã‚¯ ----------------------
Blockly.Blocks['load_system'] = {
  init: function() {
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰ã‚·ã‚¹ãƒ†ãƒ ä¸€è¦§ã‚’å–å¾—
    const systems = window._systemsList || [];
    
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’ä½œæˆ
    const options = systems.length > 0 
      ? systems.map(sys => [sys.system_name, sys.system_id.toString()])
      : [['ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“', '0']];
    
    this.appendDummyInput()
      .appendField("ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚ˆã¿ã“ã‚€:")
      .appendField(new Blockly.FieldDropdown(options), "SYSTEM_ID");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(290);
  }
};

// ---------------------- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ----------------------
window.blockSystemHelpers = {
  // ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ©ãƒ™ãƒ«ä¸€è¦§ã‚’å–å¾—
  async getSystemLabels(systemId) {
    if (!systemId || systemId === '0') {
      return [['ã›ã‚“ãŸãã—ã¦ã­', '']];
    }
    
    try {
      const response = await fetch(`/accounts/system/api/system-elements/${systemId}/`);
      if (!response.ok) throw new Error('Failed to fetch labels');
      
      const data = await response.json();
      const labels = [['ã›ã‚“ãŸãã—ã¦ã­', '']];
      
      if (data.elements && Array.isArray(data.elements)) {
        data.elements.forEach(elem => {
          if (elem.element_label) {
            labels.push([elem.element_label, JSON.stringify({
              label: elem.element_label,
              type: elem.element_type,
              config: elem.element_config
            })]);
          }
        });
      }
      
      console.log('ğŸ“‹ ãƒ©ãƒ™ãƒ«ä¸€è¦§å–å¾—:', labels);
      return labels;
    } catch (error) {
      console.error('âŒ ãƒ©ãƒ™ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      return [['ã‚¨ãƒ©ãƒ¼', '']];
    }
  },
  
  // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªã®é …ç›®ä¸€è¦§ã‚’å–å¾—
  getCheckboxItems(labelData) {
    try {
      const data = JSON.parse(labelData);
      if (data.config && data.config.options && Array.isArray(data.config.options)) {
        const items = [['ã›ã‚“ãŸãã—ã¦ã­', '']];
        data.config.options.forEach(opt => {
          items.push([opt, opt]);
        });
        console.log('âœ… é …ç›®ä¸€è¦§:', items);
        return items;
      }
    } catch (e) {
      console.error('âŒ é …ç›®å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
    }
    return [['é …ç›®ãªã—', '']];
  }
};

// ---------------------- ã‚·ã‚¹ãƒ†ãƒ æ¡ä»¶åˆ†å²ãƒ–ãƒ­ãƒƒã‚¯ ----------------------
Blockly.Blocks['system_condition'] = {
  init: function() {
    const block = this;
    const systems = window._systemsList || [];
    
    const systemOptions = systems.length > 0 
      ? [['ã›ã‚“ãŸãã—ã¦ã­', '0'], ...systems.map(sys => [sys.system_name, sys.system_id.toString()])]
      : [['ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“', '0']];
    
    // ã‚·ã‚¹ãƒ†ãƒ é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
    this.appendDummyInput('SYSTEM_INPUT')
      .appendField("ã‚‚ã— ã‚·ã‚¹ãƒ†ãƒ ")
      .appendField(new Blockly.FieldDropdown(systemOptions, function(newValue) {
        console.log('ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ é¸æŠ:', newValue);
        block.onSystemChange(newValue);
      }), "SYSTEM_ID")
      .appendField("ã®");
    
    // ãƒ©ãƒ™ãƒ«é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³
    this.appendDummyInput('LABEL_INPUT')
      .appendField("ãƒ©ãƒ™ãƒ«ï¼š")
      .appendField(new Blockly.FieldDropdown([['ã›ã‚“ãŸãã—ã¦ã­', '']], function(newValue) {
        console.log('ğŸ”„ ãƒ©ãƒ™ãƒ«é¸æŠ:', newValue);
        block.onLabelChange(newValue);
      }), "ELEMENT_NAME");
    
    // æ¡ä»¶å…¥åŠ›ï¼ˆåˆæœŸã¯æ‰‹å…¥åŠ›ï¼‰
    this.appendDummyInput('CONDITION_INPUT')
      .appendField("ãŒ")
      .appendField(new Blockly.FieldDropdown([
        ["=","EQ"],
        ["â‰ ","NEQ"],
        [">","GT"],
        ["<","LT"],
        ["â‰¥","GTE"],
        ["â‰¤","LTE"],
        ["ãµãã‚€","CONTAINS"],
        ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹","CHECKED"]
      ]), "OP")
      .appendField(new Blockly.FieldTextInput("ã‚ãŸã„"), "VALUE")
      .appendField("ãªã‚‰");
    
    this.appendStatementInput("DO")
      .appendField("ã™ã‚‹ã“ã¨");
    this.appendStatementInput("ELSE")
      .appendField("ãã†ã§ãªã‘ã‚Œã°");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(290);
    
    // é …ç›®æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªç”¨ï¼‰
    this.itemCount = 0;
    this.isCheckboxMode = false;
    
    // ã‚·ã‚¹ãƒ†ãƒ å¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
    this.onSystemChange = async function(systemId) {
      console.log('ğŸ“ onSystemChange called:', systemId);
      const labels = await window.blockSystemHelpers.getSystemLabels(systemId);
      const labelField = this.getField('ELEMENT_NAME');
      if (labelField) {
        labelField.menuGenerator_ = labels;
        labelField.setValue(labels[0][1]);
        console.log('âœ… ãƒ©ãƒ™ãƒ«ä¸€è¦§æ›´æ–°å®Œäº†');
      }
    };
    
    // ãƒ©ãƒ™ãƒ«å¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
    this.onLabelChange = function(labelData) {
      console.log('ğŸ“ onLabelChange called:', labelData);
      if (!labelData) return;
      
      try {
        const data = JSON.parse(labelData);
        console.log('ğŸ“¦ ãƒ©ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿:', data);
        
        // æ—¢å­˜ã®æ¡ä»¶å…¥åŠ›ã‚’å‰Šé™¤
        if (this.getInput('CONDITION_INPUT')) {
          this.removeInput('CONDITION_INPUT');
        }
        // æ—¢å­˜ã®é …ç›®å…¥åŠ›ã‚’å…¨å‰Šé™¤
        for (let i = 0; i < this.itemCount; i++) {
          if (this.getInput('ITEM_INPUT_' + i)) {
            this.removeInput('ITEM_INPUT_' + i);
          }
        }
        if (this.getInput('LOGIC_INPUT')) {
          this.removeInput('LOGIC_INPUT');
        }
        if (this.getInput('CHECK_STATUS_INPUT')) {
          this.removeInput('CHECK_STATUS_INPUT');
        }
        if (this.getInput('BUTTONS_INPUT')) {
          this.removeInput('BUTTONS_INPUT');
        }
        
        // DO/ELSEã‚’ä¸€æ—¦å‰Šé™¤
        const doConnection = this.getInput('DO') ? this.getInput('DO').connection.targetConnection : null;
        const elseConnection = this.getInput('ELSE') ? this.getInput('ELSE').connection.targetConnection : null;
        if (this.getInput('DO')) this.removeInput('DO');
        if (this.getInput('ELSE')) this.removeInput('ELSE');
        
        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªã®å ´åˆ
        if (data.type === 'checkbox_group' || data.type === 'radio_group') {
          const items = window.blockSystemHelpers.getCheckboxItems(labelData);
          this.itemCount = 1;
          this.currentItems = items;
          this.isCheckboxMode = true;
          
          // é …ç›®é¸æŠå…¥åŠ›ï¼ˆæœ€åˆã®1ã¤ - å‰Šé™¤ãƒœã‚¿ãƒ³ãªã—ï¼‰
          this.appendDummyInput('ITEM_INPUT_0')
            .appendField("ã®ã€€é …ç›®ï¼š")
            .appendField(new Blockly.FieldDropdown(items), "ITEM_0");
          
          // ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³ã®ã¿
          this.appendDummyInput('BUTTONS_INPUT')
    .appendField(new Blockly.FieldImage('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjNGNhZjUwIi8+PHBhdGggZD0iTTEwIDUgdjEwIE01IDEwIGgxMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+', 20, 20, '+', function() {
        block.addItem();
    }));
          
          // AND/ORé¸æŠï¼ˆã€Œã®ã¿ã€ã€Œãµãã‚ã‚‹ã€ï¼‰
          this.appendDummyInput('LOGIC_INPUT')
            .appendField(new Blockly.FieldDropdown([
              ["ã®ã¿","AND"],
              ["ãµãã‚ã‚‹","OR"]
            ]), "LOGIC")
            .appendField("ãŒ");
          
          // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹é¸æŠ
          this.appendDummyInput('CHECK_STATUS_INPUT')
            .appendField(new Blockly.FieldDropdown([
              ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹","CHECKED"],
              ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„","UNCHECKED"]
            ]), "CHECK_STATUS")
            .appendField("ãªã‚‰");
          
          console.log('âœ… ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹/ãƒ©ã‚¸ã‚ªãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´');
        } else {
          // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®å ´åˆ
          this.itemCount = 0;
          this.isCheckboxMode = false;
          this.appendDummyInput('CONDITION_INPUT')
            .appendField("ãŒ")
            .appendField(new Blockly.FieldDropdown([
              ["=","EQ"],
              ["â‰ ","NEQ"],
              [">","GT"],
              ["<","LT"],
              ["â‰¥","GTE"],
              ["â‰¤","LTE"],
              ["ãµãã‚€","CONTAINS"],
              ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹","CHECKED"]
            ]), "OP")
            .appendField(new Blockly.FieldTextInput("ã‚ãŸã„"), "VALUE")
            .appendField("ãªã‚‰");
          
          console.log('âœ… ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´');
        }
        
        // DO/ELSEã‚’å†è¿½åŠ 
        this.appendStatementInput("DO")
          .appendField("ã™ã‚‹ã“ã¨");
        this.appendStatementInput("ELSE")
          .appendField("ãã†ã§ãªã‘ã‚Œã°");
        
        // æ¥ç¶šã‚’å¾©å…ƒ
        if (doConnection) {
          this.getInput('DO').connection.connect(doConnection);
        }
        if (elseConnection) {
          this.getInput('ELSE').connection.connect(elseConnection);
        }
        
      } catch (e) {
        console.error('âŒ ãƒ©ãƒ™ãƒ«å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
        if (!this.getInput('CONDITION_INPUT')) {
          this.appendDummyInput('CONDITION_INPUT')
            .appendField("ãŒ")
            .appendField(new Blockly.FieldDropdown([
              ["=","EQ"],
              ["â‰ ","NEQ"],
              [">","GT"],
              ["<","LT"],
              ["â‰¥","GTE"],
              ["â‰¤","LTE"],
              ["ãµãã‚€","CONTAINS"],
              ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹","CHECKED"]
            ]), "OP")
            .appendField(new Blockly.FieldTextInput("ã‚ãŸã„"), "VALUE")
            .appendField("ãªã‚‰");
        }
        // DO/ELSEã‚’å†è¿½åŠ 
        if (!this.getInput('DO')) {
          this.appendStatementInput("DO")
            .appendField("ã™ã‚‹ã“ã¨");
        }
        if (!this.getInput('ELSE')) {
          this.appendStatementInput("ELSE")
            .appendField("ãã†ã§ãªã‘ã‚Œã°");
        }
      }
    };
    
    // é …ç›®è¿½åŠ 
    this.addItem = function() {
      if (!this.currentItems || this.itemCount >= 10) return;
      
      const newIndex = this.itemCount;
      const block = this;
      
      // BUTTONS_INPUTã®å‰ã«æŒ¿å…¥ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãï¼‰
      this.appendDummyInput('ITEM_INPUT_' + newIndex)
        .appendField("ã€€ã€€ã€€ã€€ã€€")
        .appendField(new Blockly.FieldDropdown(this.currentItems), "ITEM_" + newIndex)
        .appendField(new Blockly.FieldImage('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZjQ0MzM2Ii8+PHBhdGggZD0iTTUgMTAgaDEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=', 20, 20, '-', (function(index) {
          return function() {
            block.removeItem(index);
          };
        })(newIndex)));
      this.moveInputBefore('ITEM_INPUT_' + newIndex, 'BUTTONS_INPUT');
      
      this.itemCount++;
      console.log('â• é …ç›®è¿½åŠ :', newIndex);
    };
    
    // é …ç›®å‰Šé™¤ï¼ˆå€‹åˆ¥å‰Šé™¤ï¼‰
    this.removeItem = function(index) {
      if (this.getInput('ITEM_INPUT_' + index)) {
        this.removeInput('ITEM_INPUT_' + index);
        console.log('â– é …ç›®å‰Šé™¤:', index);
      }
    };
  },
  
  // ä¿å­˜æ©Ÿèƒ½ï¼ˆmutationã‚’ä½¿ç”¨ï¼‰
  mutationToDom: function() {
    const container = document.createElement('mutation');
    container.setAttribute('item_count', this.itemCount);
    container.setAttribute('is_checkbox', this.isCheckboxMode);
    if (this.currentItems) {
      container.setAttribute('items_json', JSON.stringify(this.currentItems));
    }
    // SYSTEM_IDã¨ELEMENT_NAMEã®å€¤ã‚’ä¿å­˜
    const systemIdField = this.getField('SYSTEM_ID');
    const elementNameField = this.getField('ELEMENT_NAME');
    if (systemIdField) {
      container.setAttribute('system_id_value', systemIdField.getValue());
    }
    if (elementNameField) {
      container.setAttribute('element_name_value', elementNameField.getValue());
    }
    // å„é …ç›®ã®å€¤ã‚’ä¿å­˜
    for (let i = 0; i < this.itemCount; i++) {
      const field = this.getField('ITEM_' + i);
      if (field) {
        container.setAttribute('item_' + i + '_value', field.getValue());
      }
    }
    return container;
  },
  
  // å¾©å…ƒæ©Ÿèƒ½
  domToMutation: function(xmlElement) {
    const itemCount = parseInt(xmlElement.getAttribute('item_count')) || 0;
    const isCheckbox = xmlElement.getAttribute('is_checkbox') === 'true';
    const itemsJson = xmlElement.getAttribute('items_json');
    
    if (isCheckbox && itemCount > 0) {
      this.isCheckboxMode = true;
      this.currentItems = itemsJson ? JSON.parse(itemsJson) : [['ã›ã‚“ãŸãã—ã¦ã­', '']];
      
      // æ—¢å­˜ã®å…¥åŠ›ã‚’å‰Šé™¤
      if (this.getInput('CONDITION_INPUT')) {
        this.removeInput('CONDITION_INPUT');
      }
      
      // DO/ELSEã‚’ä¸€æ—¦å‰Šé™¤
      const doConnection = this.getInput('DO') ? this.getInput('DO').connection.targetConnection : null;
      const elseConnection = this.getInput('ELSE') ? this.getInput('ELSE').connection.targetConnection : null;
      if (this.getInput('DO')) this.removeInput('DO');
      if (this.getInput('ELSE')) this.removeInput('ELSE');
      
      // æœ€åˆã®é …ç›®ã‚’è¿½åŠ 
      this.appendDummyInput('ITEM_INPUT_0')
        .appendField("ã®ã€€é …ç›®ï¼š")
        .appendField(new Blockly.FieldDropdown(this.currentItems), "ITEM_0");
      
      // 2ç•ªç›®ä»¥é™ã®é …ç›®ã‚’å¾©å…ƒ
      for (let i = 1; i < itemCount; i++) {
        const block = this;
        this.appendDummyInput('ITEM_INPUT_' + i)
          .appendField("ã€€ã€€ã€€ã€€ã€€")
          .appendField(new Blockly.FieldDropdown(this.currentItems), "ITEM_" + i)
          .appendField(new Blockly.FieldImage('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjZjQ0MzM2Ii8+PHBhdGggZD0iTTUgMTAgaDEwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiLz48L3N2Zz4=', 20, 20, '-', (function(index) {
            return function() {
              block.removeItem(index);
            };
          })(i)));
      }
      
      // ãƒ—ãƒ©ã‚¹ãƒœã‚¿ãƒ³
      this.appendDummyInput('BUTTONS_INPUT')
        .appendField(new Blockly.FieldImage('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCI+PHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiBmaWxsPSIjNGNhZjUwIi8+PHBhdGggZD0iTTEwIDUgdjEwIE01IDE0IGgxMCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+PC9zdmc+', 20, 20, '+', () => {
          this.addItem();
        }));
      
      // LOGIC ã¨ CHECK_STATUS
      this.appendDummyInput('LOGIC_INPUT')
        .appendField(new Blockly.FieldDropdown([
          ["ã®ã¿","AND"],
          ["ãµãã‚ã‚‹","OR"]
        ]), "LOGIC")
        .appendField("ãŒ");
      
      this.appendDummyInput('CHECK_STATUS_INPUT')
        .appendField(new Blockly.FieldDropdown([
          ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹","CHECKED"],
          ["ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„","UNCHECKED"]
        ]), "CHECK_STATUS")
        .appendField("ãªã‚‰");
      
      this.itemCount = itemCount;
      
      // DO/ELSEã‚’å†è¿½åŠ 
      this.appendStatementInput("DO")
        .appendField("ã™ã‚‹ã“ã¨");
      this.appendStatementInput("ELSE")
        .appendField("ãã†ã§ãªã‘ã‚Œã°");
      
      // æ¥ç¶šã‚’å¾©å…ƒ
      if (doConnection) {
        this.getInput('DO').connection.connect(doConnection);
      }
      if (elseConnection) {
        this.getInput('ELSE').connection.connect(elseConnection);
      }
      
      // å„é …ç›®ã®å€¤ã‚’å¾©å…ƒ
      setTimeout(() => {
        for (let i = 0; i < itemCount; i++) {
          const savedValue = xmlElement.getAttribute('item_' + i + '_value');
          if (savedValue) {
            const field = this.getField('ITEM_' + i);
            if (field) {
              field.setValue(savedValue);
            }
          }
        }
      }, 100);
    }
  }
};

// ---------------------- ã‚·ã‚¹ãƒ†ãƒ è¡¨ç¤ºãƒ–ãƒ­ãƒƒã‚¯ ----------------------
Blockly.Blocks['display_system'] = {
  init: function() {
    const systems = window._systemsList || [];
    
    const options = systems.length > 0 
      ? systems.map(sys => [sys.system_name, sys.system_id.toString()])
      : [['ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“', '0']];
    
    this.appendDummyInput()
      .appendField("ã‚·ã‚¹ãƒ†ãƒ ã‚’ã²ã‚‡ã†ã˜:")
      .appendField(new Blockly.FieldDropdown(options), "SYSTEM_ID");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(290);
  }
};
</script>
