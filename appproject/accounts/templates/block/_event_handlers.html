<script>
// ä¿å­˜ãƒœã‚¿ãƒ³(Blocklyãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä¿å­˜ã—ã¦é·ç§»)
document.getElementById('saveBtn').addEventListener('click', function() {
  // Blocklyã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’XMLã«å¤‰æ›
  const xml = Blockly.Xml.workspaceToDom(workspace);
  const xmlText = Blockly.Xml.domToText(xml);
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
  sessionStorage.setItem('blockly_xml', xmlText);
  
  // ä¸€æ™‚ä¿å­˜ã•ã‚ŒãŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ åã¨è©³ç´°ã‚’å–å¾—ï¼ˆæˆ»ã‚‹ãƒœã‚¿ãƒ³çµŒç”±ã§ä¿å­˜ã•ã‚ŒãŸå†…å®¹ï¼‰
  const tempName = sessionStorage.getItem('temp_algorithm_name');
  const tempDescription = sessionStorage.getItem('temp_algorithm_description');
  const tempId = sessionStorage.getItem('temp_algorithm_id');
  
  // ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚ŒãŸå ´åˆã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
  const systemId = '{{ system_id|default:"" }}';
  const buttonId = '{{ button_id|default:"" }}';
  const action = '{{ action|default:"" }}';
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ: Django ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ IDã‚’å–å¾—
  const existingAlgorithmData = {
    algorithmId: tempId || '{{ algorithm_id|default:"" }}',
    algorithmName: tempName || '{{ algorithm_name|default:""|escapejs }}',
    algorithmDescription: tempDescription || '{{ algorithm_description|default:""|escapejs }}'
  };
  
  // ä¸€æ™‚ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ï¼ˆä½¿ã„çµ‚ã‚ã£ãŸã®ã§ï¼‰
  sessionStorage.removeItem('temp_algorithm_name');
  sessionStorage.removeItem('temp_algorithm_description');
  sessionStorage.removeItem('temp_algorithm_id');
  
  // ã‚·ã‚¹ãƒ†ãƒ IDã¨ãƒœã‚¿ãƒ³IDã‚’ä¿å­˜ï¼ˆä¿å­˜å¾Œã«ä½¿ç”¨ï¼‰
  if (systemId) {
    sessionStorage.setItem('return_system_id', systemId);
  }
  if (buttonId) {
    sessionStorage.setItem('return_button_id', buttonId);
  }
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
  if (existingAlgorithmData.algorithmId) {
    window.location.href = `/accounts/block/create/?id=${existingAlgorithmData.algorithmId}`;
  } else {
    // æ–°è¦ä½œæˆã®å ´åˆ
    window.location.href = '/accounts/block/create/';
  }
});

// æœªä¿å­˜ã®å¤‰æ›´ã‚’è¿½è·¡
let isDirty = false;
let initialWorkspaceXml = '';

// åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆBlocklyãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹èª­ã¿è¾¼ã¿å¾Œã«å®Ÿè¡Œï¼‰
function saveInitialWorkspaceState() {
  if (typeof workspace !== 'undefined' && workspace) {
    try {
      const xml = Blockly.Xml.workspaceToDom(workspace);
      initialWorkspaceXml = Blockly.Xml.domToText(xml);
      console.log('ğŸ“¸ åˆæœŸãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹çŠ¶æ…‹ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (error) {
      console.error('åˆæœŸçŠ¶æ…‹ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
}

// Blocklyãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å¤‰æ›´ã‚’æ¤œçŸ¥
function setupBlocklyChangeDetection() {
  if (typeof workspace !== 'undefined' && workspace) {
    workspace.addChangeListener(function(event) {
      // UIç³»ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé¸æŠã€ç§»å‹•ãªã©ï¼‰ã¯ç„¡è¦–
      if (event.type === Blockly.Events.UI) {
        return;
      }
      
      // åˆæœŸåŒ–ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯ç„¡è¦–
      if (event.type === Blockly.Events.FINISHED_LOADING) {
        saveInitialWorkspaceState();
        return;
      }
      
      // ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å†…å®¹ãŒå¤‰æ›´ã•ã‚ŒãŸ
      try {
        const currentXml = Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(workspace));
        if (currentXml !== initialWorkspaceXml) {
          isDirty = true;
          console.log('âœï¸ ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ - isDirty = true');
        }
      } catch (error) {
        console.error('å¤‰æ›´æ¤œçŸ¥ã‚¨ãƒ©ãƒ¼:', error);
      }
    });
    console.log('ğŸ‘€ Blocklyå¤‰æ›´æ¤œçŸ¥ã‚’è¨­å®šã—ã¾ã—ãŸ');
  }
}

// ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åˆæœŸåŒ–å¾Œã«å¤‰æ›´æ¤œçŸ¥ã‚’è¨­å®š
if (typeof workspace !== 'undefined' && workspace) {
  setupBlocklyChangeDetection();
} else {
  // workspaceãŒå¾Œã§åˆæœŸåŒ–ã•ã‚Œã‚‹å ´åˆã«å‚™ãˆã¦ã€å°‘ã—å¾…ã¤
  setTimeout(function() {
    setupBlocklyChangeDetection();
  }, 1000);
}

// ãƒ–ãƒ©ã‚¦ã‚¶é–‰ã˜ã‚‹/ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®è­¦å‘Š
window.addEventListener('beforeunload', function(e) {
  if (!isDirty) return;
  e.preventDefault();
  e.returnValue = 'ä¿å­˜ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
  return e.returnValue;
});

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯æ™‚ã®è­¦å‘Š
(function handleNavigation(){
  const tabs = document.querySelectorAll('.top-tabs a[id^="tab-"]');
  tabs.forEach(tab => {
    tab.addEventListener('click', function(e) {
      // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚¿ãƒ–è‡ªèº«ã®ã‚¯ãƒªãƒƒã‚¯ã¯è¨±å¯
      if (this.id === 'tab-algorithms') return;
      
      if (isDirty) {
        e.preventDefault();
        const confirmed = confirm('ä¿å­˜ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
        if (confirmed) {
          isDirty = false;
          window.location.href = this.href;
        }
      }
    });
  });
})();

// ä¿å­˜æ™‚ã«isDirtyã‚’ãƒªã‚»ãƒƒãƒˆ
const originalSaveBtn = document.getElementById('saveBtn');
if (originalSaveBtn) {
  originalSaveBtn.addEventListener('click', function() {
    isDirty = false;
  });
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã§ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«è¨­å®š
(function setActiveTab(){
  const algorithmTab = document.getElementById('tab-algorithms');
  if (algorithmTab) {
    algorithmTab.classList.add('active');
  }
})();

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é‡ãªã‚Šã‚’æ¤œå‡ºã—ã¦éè¡¨ç¤ºã«ã™ã‚‹
(function handleNavbarOverlap(){
  const navbar = document.querySelector('.top-tabs');
  const container = document.getElementById('container');
  
  if (!navbar || !container) return;
  
  function checkOverlap() {
    const navbarRect = navbar.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã¨ã‚³ãƒ³ãƒ†ãƒŠãŒé‡ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const isOverlapping = !(
      navbarRect.bottom < containerRect.top ||
      navbarRect.top > containerRect.bottom ||
      navbarRect.right < containerRect.left ||
      navbarRect.left > containerRect.right
    );
    
    if (isOverlapping) {
      navbar.classList.add('hidden');
    } else {
      navbar.classList.remove('hidden');
    }
  }
  
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã¨ãƒªã‚µã‚¤ã‚ºæ™‚ã«ãƒã‚§ãƒƒã‚¯
  window.addEventListener('scroll', checkOverlap);
  window.addEventListener('resize', checkOverlap);
  
  // åˆå›ãƒã‚§ãƒƒã‚¯
  checkOverlap();
})();
</script>
