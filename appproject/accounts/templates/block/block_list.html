{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_purple.png' %}"
  alt=""
  class="bg-frame"
  onerror="this.style.display='none';">
{% endblock %}

{% block title %}アルゴリズム一覧 - Codemon{% endblock %}

{% block extra_css %}
<style>
    main { 
      width:100%; 
      max-width:1000px; 
      margin:6px auto; 
      margin-top:82px;
      box-sizing:border-box;
    }

    .list-card {
      background: transparent;
      border-radius:10px;
      padding:16px;
      padding-bottom:80px;
      box-shadow: none;
      border: none;
      max-width:1000px;
      margin:0 auto;
    }
    .list-empty { color:#666; padding:28px; text-align:center; }
    
    /* アルゴリズム一覧項目の背景画像 */
    #algorithmsList li {
      background: url("{% static 'codemon/images/backgrounds/system_list_bg.png' %}") no-repeat center center !important;
      background-size: contain !important;
      border: none !important;
      min-height: 70px;
    }
    
    /* 詳細ボタンの画像スタイル */
    .algorithm-detail-btn {
      background: url("{% static 'codemon/images/button/algorithm_list_button.png' %}") no-repeat center center !important;
      background-size: contain !important;
      background-color: transparent !important;
      border: none !important;
      color: transparent !important;
      box-shadow: none !important;
      width: 110px;
      height: 55px;
      cursor: pointer;
      padding: 0 !important;
      flex-shrink: 0;
    }
    
    /* ページネーション */
    .pagination {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:16px 0 12px 0;
      position:relative;
    }
    .pagination-controls {
      display:flex;
      gap:16px;
      align-items:center;
      position:absolute;
      left:50%;
      transform:translateX(-50%);
    }
    .pagination-info {
      color:#666;
      font-size:14px;
    }
    .pagination-btn {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #d0d7de;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition: all .12s ease;
    }
    .pagination-btn:hover:not(:disabled) {
      background:#f0f6ff;
      color:var(--primary);
      border-color:var(--primary);
    }
    .pagination-btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    
    /* 検索機能 */
    .search-container {
      display:flex;
      gap:8px;
      align-items:center;
      margin-left:auto;
    }
    #searchInput {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #d0d7de;
      font-size:14px;
      width:200px;
      transition: all .12s ease;
    }
    #searchInput:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(7,55,99,0.1);
    }
    #clearSearchBtn {
      padding:6px 10px;
      border-radius:6px;
      border:1px solid #d0d7de;
      background:#fff;
      cursor:pointer;
      font-size:16px;
      color:#666;
      transition: all .12s ease;
      display:none;
    }
    #clearSearchBtn.visible {
      display:block;
    }
    #clearSearchBtn:hover {
      background:#f0f6ff;
      color:var(--primary);
      border-color:var(--primary);
    }
    
    .actions { display:flex; gap:12px; margin-top:12px; justify-content:center; }
    .btn {
      padding:10px 14px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn-primary {
      background: linear-gradient(180deg,#e6f0ff,#cfe6ff);
      color:#073763;
      box-shadow:0 8px 18px rgba(10,59,110,0.06);
    }
    .btn-ghost {
      background: #fff;
      color:#444;
      border:1px solid #e6e9ee;
    }

    @media (max-width:640px){
      .list-empty { padding:18px; }
    }
</style>
{% endblock %}

{% block content %}
<main class="page-wrap" role="main">
    <div class="list-card" role="region" aria-label="アルゴリズム一覧">
      <!-- ページネーション（上部） -->
      <div class="pagination" id="topPagination">
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn" disabled>← 前へ</button>
          <span class="pagination-info" id="pageInfo">1 / 1</span>
          <button class="pagination-btn" id="nextBtn" disabled>次へ →</button>
        </div>
        <div class="search-container">
          <input type="text" id="searchInput" placeholder="アルゴリズムを検索..." />
          <button id="clearSearchBtn">×</button>
        </div>
      </div>

      <div id="algorithmsContainer">
        {% if algorithms %}
        <div class="algorithm-list">
          <ul id="algorithmsList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:3px;">
            {% for a in algorithms %}
            <li data-id="{{ a.algorithm_id }}" style="border-radius:8px;padding:12px 14px;display:flex;align-items:center;gap:16px;">
              <div style="flex:1;min-width:0;font-weight:700;font-size:15px;color:#0b2f5a;">{{ a.algorithm_name }}</div>
              <div style="flex:1;min-width:0;color:#666;font-size:13px;">作成日: {{ a.created_at|date:"Y年n月j日 H:i" }}</div>
              {% if a.created_at != a.updated_at %}
              <div style="flex:1;min-width:0;color:#666;font-size:13px;">更新日: {{ a.updated_at|date:"Y年n月j日 H:i" }}</div>
              {% else %}
              <div style="flex:1;min-width:0;color:#666;font-size:13px;">更新日:</div>
              {% endif %}
              <button class="algorithm-detail-btn" data-algorithm-id="{{ a.algorithm_id }}">詳細</button>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <div class="list-empty">
          作成済みのアルゴリズムはまだありません。<br />
          「新しいアルゴリズムを作成」ボタンで作成を開始できます。
        </div>
        {% endif %}
      </div>

      <div class="actions" aria-hidden="false">
        <button class="btn btn-primary" id="btn-new">新しいアルゴリズムを作成</button>
        <button class="btn btn-ghost" id="btn-back">戻る</button>
      </div>
    </div>
  </main>

<script>
    // ページネーション設定
    const ITEMS_PER_PAGE = 4;
    let currentPage = 1;
    let allAlgorithms = [];
    let filteredAlgorithms = [];
    let searchQuery = '';

    // 初期データの読み込み
    (function initializeAlgorithms() {
      const algorithmsListElement = document.getElementById('algorithmsList');
      if (algorithmsListElement) {
        // Django テンプレートから初期データを取得
        const items = algorithmsListElement.querySelectorAll('li[data-id]');
        allAlgorithms = Array.from(items).map(item => {
          const algorithmId = item.getAttribute('data-id');
          const nameElement = item.querySelector('div[style*="font-weight:700"]');
          const dateElements = item.querySelectorAll('div[style*="color:#666"]');
          
          return {
            algorithm_id: algorithmId,
            algorithm_name: nameElement ? nameElement.textContent : '',
            created_at: dateElements[0] ? dateElements[0].textContent : '',
            updated_at: dateElements[1] ? dateElements[1].textContent : ''
          };
        });
        
        // 初期表示
        renderPage(1);
      } else {
        // アルゴリズムが1つもない場合
        updatePaginationButtons();
      }
    })();

    function renderPage(page) {
      currentPage = page;
      const container = document.getElementById('algorithmsContainer');
      if (!container) return;

      const displayAlgorithms = searchQuery ? filteredAlgorithms : allAlgorithms;

      if (!displayAlgorithms || displayAlgorithms.length === 0) {
        if (searchQuery) {
          container.innerHTML = `
            <div class="list-empty">「${escapeHtml(searchQuery)}」に一致するアルゴリズムが見つかりませんでした。</div>`;
        } else {
          container.innerHTML = `
            <div class="list-empty">作成済みのアルゴリズムはまだありません。<br />「新しいアルゴリズムを作成」ボタンで作成を開始できます。</div>`;
        }
        updatePaginationButtons();
        return;
      }

      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const pageAlgorithms = displayAlgorithms.slice(startIndex, endIndex);

      let html = '<div class="algorithm-list"><ul id="algorithmsList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:3px;">';
      for (const a of pageAlgorithms) {
        html += `<li data-id="${a.algorithm_id}" style="border-radius:8px;padding:12px 14px;display:flex;align-items:center;gap:16px;">`;
        html += `<div style="flex:1;min-width:0;font-weight:700;font-size:15px;color:#0b2f5a;">${escapeHtml(a.algorithm_name)}</div>`;
        html += `<div style="flex:1;min-width:0;color:#666;font-size:13px;">${escapeHtml(a.created_at)}</div>`;
        if (a.updated_at && a.updated_at !== '更新日:') {
          html += `<div style="flex:1;min-width:0;color:#666;font-size:13px;">${escapeHtml(a.updated_at)}</div>`;
        } else {
          html += `<div style="flex:1;min-width:0;color:#666;font-size:13px;">更新日:</div>`;
        }
        html += `<button class="algorithm-detail-btn" data-algorithm-id="${a.algorithm_id}">詳細</button>`;
        html += `</li>`;
      }
      html += '</ul></div>';
      container.innerHTML = html;
      
      // 詳細ボタンにイベントリスナーを追加
      attachDetailButtonListeners();
      
      // ページネーションボタンの状態更新
      updatePaginationButtons();
    }

    function updatePaginationButtons() {
      const displayAlgorithms = searchQuery ? filteredAlgorithms : allAlgorithms;
      const totalPages = Math.ceil(displayAlgorithms.length / ITEMS_PER_PAGE) || 1;
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
      if (pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages}`;
    }

    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>\"]/g, function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
      });
    }

    // ページネーションボタンのイベントリスナー
    document.getElementById('prevBtn')?.addEventListener('click', function() {
      if (currentPage > 1) {
        renderPage(currentPage - 1);
      }
    });

    document.getElementById('nextBtn')?.addEventListener('click', function() {
      const displayAlgorithms = searchQuery ? filteredAlgorithms : allAlgorithms;
      const totalPages = Math.ceil(displayAlgorithms.length / ITEMS_PER_PAGE);
      if (currentPage < totalPages) {
        renderPage(currentPage + 1);
      }
    });

    // 検索機能
    function performSearch(query) {
      searchQuery = query.toLowerCase().trim();
      const clearBtn = document.getElementById('clearSearchBtn');
      
      if (searchQuery) {
        filteredAlgorithms = allAlgorithms.filter(algorithm => {
          return algorithm.algorithm_name.toLowerCase().includes(searchQuery);
        });
        if (clearBtn) clearBtn.classList.add('visible');
      } else {
        filteredAlgorithms = [];
        if (clearBtn) clearBtn.classList.remove('visible');
      }
      
      renderPage(1);
    }

    // 検索入力イベント
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', function(e) {
        performSearch(e.target.value);
      });
    }

    // 検索クリアボタン
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', function() {
        if (searchInput) {
          searchInput.value = '';
          performSearch('');
          searchInput.focus();
        }
      });
    }

    // 詳細ボタンのイベントリスナーを追加する関数
    function attachDetailButtonListeners() {
      document.querySelectorAll('.algorithm-detail-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const algorithmId = this.getAttribute('data-algorithm-id');
          if (algorithmId) {
            window.location.href = `/accounts/block/details/?id=${algorithmId}`;
          }
        });
      });
    }

    // ページ読み込み時に詳細ボタンのイベントリスナーを追加
    document.addEventListener('DOMContentLoaded', function() {
      attachDetailButtonListeners();
    });

 // ナビタブ見た目切替。システムタブとアルゴリズムタブで遷移（画面構成は変更しない）
    document.querySelectorAll('.nav-tab').forEach(tab=>{
      tab.addEventListener('click', function(e){
        e.preventDefault();
        // 見た目更新
        document.querySelectorAll('.nav-tab').forEach(t=>{
          t.classList.remove('active');
          t.setAttribute('aria-pressed','false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed','true');

        // システムタブのみ system_choice へ遷移
        if (this.id === 'tab-system') {
          window.location.href = '/accounts/system/choice/';
          return;
        }
        // 変更: アルゴリズムタブ押下で block/choice へ遷移
        if (this.id === 'tab-algorithm') {
          window.location.href = '/accounts/block/choice';
          return;
        }
        // それ以外は遷移しない（表示のみ）
      });
    });

    // ページ読み込み時にアルゴリズムタブをアクティブに設定
    (function setActiveTab(){
      const algorithmTab = document.getElementById('tab-algorithm');
      if (algorithmTab) {
        document.querySelectorAll('.nav-tab').forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-pressed', 'false');
        });
        algorithmTab.classList.add('active');
        algorithmTab.setAttribute('aria-pressed', 'true');
      }
    })();

    // 「新しいアルゴリズムを作成」ボタンは index.html へ遷移
    const btnNew = document.getElementById('btn-new');
    if (btnNew) {
      btnNew.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = '/accounts/block/';
      });
    }

    // 戻るボタン -> block_choice へ遷移
    const btnBack = document.getElementById('btn-back');
    if (btnBack) {
      btnBack.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = '/accounts/block/choice/';
      });
    }

</script>
</main>
{% endblock %}