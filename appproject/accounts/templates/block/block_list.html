<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>アルゴリズム一覧</title>
<style>
  /* ----- 上部ナビゲーション ----- */
  :root { --nav-height:56px; --primary:#1976d2; --muted:#666; --bg:#f9f9fb; }
    body{
      font-family: -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "メイリオ", sans-serif;
      margin:20px;
      display:flex;
      flex-direction:column;
      align-items:center;
      min-height:100vh;
      background:var(--bg);
      color:#111;
    }
    .top-nav {
      box-sizing:border-box;
      width:100%;
      max-width:980px;
      height:var(--nav-height);
      margin:16px auto 12px;
      display:flex;
      align-items:center;
      gap:12px;
      padding:6px 12px;
      background:linear-gradient(180deg,#fff,#fafafa);
      border-radius:10px;
      box-shadow:0 1px 3px rgba(0,0,0,0.06);
      border:1px solid #e6e6e9;
    }
    .nav-brand { display:flex; align-items:center; gap:8px; padding-right:8px; border-right:1px solid #eee; }
    .nav-brand .logo { width:36px; height:36px; border-radius:6px; background:var(--primary); display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:18px; }
    .nav-brand .title { font-size:15px; color:#111; font-weight:600; }
    .nav-tabs {
      display:flex;
      justify-content: space-evenly;
      width:100%;
      align-items:center;
      gap:0;
      margin:0;
    }
    .nav-tab {
      appearance:none; border:0; background:transparent; padding:8px 12px; border-radius:8px;
      font-size:14px; cursor:pointer; color:var(--muted); transition: all .12s ease;
    }
    .nav-tab:hover { background:#f0f6ff; color:var(--primary); transform:translateY(-1px); }
    .nav-tab.active { background:var(--primary); color:#fff; box-shadow:0 2px 6px rgba(25,118,210,0.18); }

    main { width:100%; max-width:980px; margin:6px auto; box-sizing:border-box; }
    h1 { margin:2px 0 12px 0; font-size:20px; text-align:center; }

    .list-card {
      background:#fff;
      border-radius:10px;
      padding:16px;
      box-shadow:0 6px 18px rgba(10,10,10,0.04);
      border:1px solid #eef2f6;
    }
    .list-empty { color:#666; padding:28px; text-align:center; min-width:420px; }
    
    /* ページネーション */
    .pagination {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:16px;
      margin:16px 0 12px 0;
    }
    .pagination-info {
      color:#666;
      font-size:14px;
    }
    .pagination-btn {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #d0d7de;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition: all .12s ease;
    }
    .pagination-btn:hover:not(:disabled) {
      background:#f0f6ff;
      color:var(--primary);
      border-color:var(--primary);
    }
    .pagination-btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    
    .actions { display:flex; gap:12px; margin-top:12px; justify-content:center; }
    .btn {
      padding:10px 14px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn-primary {
      background: linear-gradient(180deg,#e6f0ff,#cfe6ff);
      color:#073763;
      box-shadow:0 8px 18px rgba(10,59,110,0.06);
    }
    .btn-ghost {
      background:transparent;
      color:#444;
      border:1px solid #e6e9ee;
    }

    @media (max-width:640px){
      .list-empty { padding:18px; }
    }

</style>
</head>
<body>
  <header class="top-nav" role="banner" aria-label="メインナビゲーション">

    <nav class="nav-tabs" role="navigation" aria-label="タブメニュー">
      <button type="button" class="nav-tab" id="tab-system" aria-pressed="false" title="システム">システム</button>
      <button type="button" class="nav-tab active" id="tab-algorithm" aria-pressed="true" title="アルゴリズム">アルゴリズム</button>
      <button type="button" class="nav-tab" id="tab-progress" aria-pressed="false" title="進捗確認">進捗確認</button>
      <button type="button" class="nav-tab" id="tab-account" aria-pressed="false" title="アカウント">アカウント</button>
    </nav>
  </header>

  <main class="page-wrap" role="main">
    <h1>アルゴリズム一覧</h1>

    <div class="list-card" role="region" aria-label="アルゴリズム一覧">
      <!-- ページネーション（上部） -->
      <div class="pagination" id="topPagination">
        <button class="pagination-btn" id="prevBtn" disabled>← 前へ</button>
        <span class="pagination-info" id="pageInfo">1 / 1</span>
        <button class="pagination-btn" id="nextBtn" disabled>次へ →</button>
      </div>

      <div id="algorithmsContainer">
        {% if algorithms %}
        <div class="algorithm-list">
          <ul id="algorithmsList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px;">
            {% for a in algorithms %}
            <li data-id="{{ a.algorithm_id }}" style="background:#fbfdff;border-radius:8px;padding:12px 14px;border:1px solid #eef4fb;display:flex;justify-content:space-between;align-items:center;gap:12px;">
              <div style="flex:1;">
                <div style="font-weight:700;font-size:15px;color:#0b2f5a;">{{ a.algorithm_name }}</div>
                {% if a.algorithm_description %}
                <div style="color:#666;font-size:13px;margin-top:4px;">{{ a.algorithm_description }}</div>
                {% endif %}
                {% if a.updated_at|date:"Y-m-d H:i" != a.created_at|date:"Y-m-d H:i" %}
                <div style="color:#999;font-size:12px;margin-top:4px;">更新日: {{ a.updated_at|date:"Y年n月j日 H:i" }}</div>
                {% else %}
                <div style="color:#999;font-size:12px;margin-top:4px;">{{ a.created_at|date:"Y年n月j日 H:i" }}</div>
                {% endif %}
              </div>
              <button class="btn btn-primary algorithm-detail-btn" data-algorithm-id="{{ a.algorithm_id }}" style="white-space:nowrap;padding:8px 16px;font-size:13px;">詳細</button>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <div class="list-empty">
          作成済みのアルゴリズムはまだありません。<br />
          「新しいアルゴリズムを作成」ボタンで作成を開始できます。
        </div>
        {% endif %}
      </div>

      <div class="actions" aria-hidden="false">
        <button class="btn btn-primary" id="btn-new">新しいアルゴリズムを作成</button>
        <button class="btn btn-ghost" id="btn-refresh">一覧を更新</button>
        <button class="btn btn-ghost" id="btn-back">戻る</button>
      </div>
    </div>
  </main>

<script>
    // ページネーション設定
    const ITEMS_PER_PAGE = 5;
    let currentPage = 1;
    let allAlgorithms = [];

    // 初期データの読み込み
    (function initializeAlgorithms() {
      const algorithmsListElement = document.getElementById('algorithmsList');
      if (algorithmsListElement) {
        // Django テンプレートから初期データを取得
        const items = algorithmsListElement.querySelectorAll('li[data-id]');
        allAlgorithms = Array.from(items).map(item => {
          const algorithmId = item.getAttribute('data-id');
          const nameElement = item.querySelector('div[style*="font-weight:700"]');
          const descElement = item.querySelector('div[style*="color:#666"]');
          const dateElement = item.querySelector('div[style*="color:#999"]');
          
          return {
            algorithm_id: algorithmId,
            algorithm_name: nameElement ? nameElement.textContent : '',
            algorithm_description: descElement ? descElement.textContent : '',
            date_display: dateElement ? dateElement.textContent : ''
          };
        });
        
        // 初期表示
        renderPage(1);
      } else {
        // アルゴリズムが1つもない場合
        updatePaginationButtons();
      }
    })();

    function renderPage(page) {
      currentPage = page;
      const container = document.getElementById('algorithmsContainer');
      if (!container) return;

      if (!allAlgorithms || allAlgorithms.length === 0) {
        container.innerHTML = `
          <div class="list-empty">作成済みのアルゴリズムはまだありません。<br />「新しいアルゴリズムを作成」ボタンで作成を開始できます。</div>`;
        updatePaginationButtons();
        return;
      }

      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const pageAlgorithms = allAlgorithms.slice(startIndex, endIndex);

      let html = '<div class="algorithm-list"><ul id="algorithmsList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px;">';
      for (const a of pageAlgorithms) {
        html += `<li data-id="${a.algorithm_id}" style="background:#fbfdff;border-radius:8px;padding:12px 14px;border:1px solid #eef4fb;display:flex;justify-content:space-between;align-items:center;gap:12px;">`;
        html += `<div style="flex:1;"><div style="font-weight:700;font-size:15px;color:#0b2f5a;">${escapeHtml(a.algorithm_name)}</div>`;
        if (a.algorithm_description) html += `<div style="color:#666;font-size:13px;margin-top:4px;">${escapeHtml(a.algorithm_description)}</div>`;
        html += `<div style="color:#999;font-size:12px;margin-top:4px;">${escapeHtml(a.date_display)}</div></div>`;
        html += `<button class="btn btn-primary algorithm-detail-btn" data-algorithm-id="${a.algorithm_id}" style="white-space:nowrap;padding:8px 16px;font-size:13px;">詳細</button>`;
        html += `</li>`;
      }
      html += '</ul></div>';
      container.innerHTML = html;
      
      // 詳細ボタンにイベントリスナーを追加
      attachDetailButtonListeners();
      
      // ページネーションボタンの状態更新
      updatePaginationButtons();
    }

    function updatePaginationButtons() {
      const totalPages = Math.ceil(allAlgorithms.length / ITEMS_PER_PAGE) || 1;
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
      if (pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages}`;
    }

    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>\"]/g, function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
      });
    }

    // ページネーションボタンのイベントリスナー
    document.getElementById('prevBtn')?.addEventListener('click', function() {
      if (currentPage > 1) {
        renderPage(currentPage - 1);
      }
    });

    document.getElementById('nextBtn')?.addEventListener('click', function() {
      const totalPages = Math.ceil(allAlgorithms.length / ITEMS_PER_PAGE);
      if (currentPage < totalPages) {
        renderPage(currentPage + 1);
      }
    });

    // 「一覧を更新」: サーバから最新データを取得して DOM を更新する
    const btnRefresh = document.getElementById('btn-refresh');
    async function loadAlgorithmsFromServer() {
      try {
        const res = await fetch('/accounts/block/list/data/');
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        
        // サーバーから取得したデータを allAlgorithms に格納
        allAlgorithms = (data.algorithms || []).map(a => ({
          algorithm_id: a.algorithm_id,
          algorithm_name: a.algorithm_name,
          algorithm_description: a.algorithm_description,
          created_at: a.created_at,
          updated_at: a.updated_at,
          // 更新されたアルゴリズムは「更新日:」を表示、それ以外は作成日を表示
          date_display: (a.updated_at && a.created_at && a.updated_at !== a.created_at) 
            ? `更新日: ${a.updated_at}` 
            : a.created_at
        }));
        
        // 1ページ目を表示
        renderPage(1);
      } catch (err) {
        console.error(err);
        alert('一覧の取得に失敗しました。');
      }
    }

    if (btnRefresh) {
      btnRefresh.addEventListener('click', async function(e){
        e.preventDefault();
        btnRefresh.disabled = true;
        await loadAlgorithmsFromServer();
        btnRefresh.disabled = false;
      });
    }

    // 詳細ボタンのイベントリスナーを追加する関数
    function attachDetailButtonListeners() {
      document.querySelectorAll('.algorithm-detail-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const algorithmId = this.getAttribute('data-algorithm-id');
          if (algorithmId) {
            window.location.href = `/accounts/block/details/?id=${algorithmId}`;
          }
        });
      });
    }

    // ページ読み込み時に詳細ボタンのイベントリスナーを追加
    document.addEventListener('DOMContentLoaded', function() {
      attachDetailButtonListeners();
    });

 // ナビタブ見た目切替。システムタブとアルゴリズムタブで遷移（画面構成は変更しない）
    document.querySelectorAll('.nav-tab').forEach(tab=>{
      tab.addEventListener('click', function(e){
        e.preventDefault();
        // 見た目更新
        document.querySelectorAll('.nav-tab').forEach(t=>{
          t.classList.remove('active');
          t.setAttribute('aria-pressed','false');
        });
        this.classList.add('active');
        this.setAttribute('aria-pressed','true');

        // システムタブのみ system_choice へ遷移
        if (this.id === 'tab-system') {
          window.location.href = '/accounts/system/choice/';
          return;
        }
        // 変更: アルゴリズムタブ押下で block/choice へ遷移
        if (this.id === 'tab-algorithm') {
          window.location.href = '/accounts/block/choice';
          return;
        }
        // それ以外は遷移しない（表示のみ）
      });
    });

    // 「新しいアルゴリズムを作成」ボタンは index.html へ遷移
    const btnNew = document.getElementById('btn-new');
    if (btnNew) {
      btnNew.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = '/accounts/block/';
      });
    }

    // 戻るボタン -> block_choice へ遷移
    const btnBack = document.getElementById('btn-back');
    if (btnBack) {
      btnBack.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = '/accounts/block/choice/';
      });
    }

</script>
</body>
</html>