{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_purple.png' %}" 
     alt="" 
     class="bg-frame"
     onerror="this.style.display='none';">
{% endblock %}

{% block title %}アルゴリズム作成 - Codemon{% endblock %}

{% block extra_css %}
{% include 'block/_styles.html' %}
{% endblock %}

{% block content %}
  <main class="page-wrap" role="main">

    <div class="shortcut-btns">
      <button id="undoBtn" title="もどす (Ctrl+Z)"><i class="fas fa-undo"></i></button>
      <button id="redoBtn" title="やり直す (Ctrl+Y)"><i class="fas fa-redo"></i></button>
      <button id="runBtn" onclick="runBlocks()"><i class="fas fa-play"></i> うごかす</button>
      <button id="saveBtn"><i class="fas fa-save"></i> ほぞん</button>
    </div>

    <div id="container">
      <div id="blocklyDiv"></div>
      <div id="visual-area">ここに結果がでるよ</div>
    </div>
  </main>

{% include 'block/_toolbox.html' %}
{% include 'block/_blocks_input.html' %}
{% include 'block/_blocks_calculation.html' %}
{% include 'block/_blocks_control.html' %}
{% include 'block/_blocks_system.html' %}
{% include 'block/_workspace_init.html' %}
{% include 'block/_execution_logic.html' %}
{% include 'block/_event_handlers.html' %}

<script src="{% static 'codemon/js/tutorial_overlay.js' %}"></script>
<script src="{% static 'codemon/js/tutorial_helper.js' %}"></script>
<script src="{% static 'codemon/js/tutorial_manager.js' %}"></script>
<script src="{% static 'codemon/js/tutorials/tutorial_algorithm.js' %}"></script>
<link rel="stylesheet" href="{% static 'codemon/css/tutorial_overlay.css' %}">

<script>
// チュートリアル自動開始
document.addEventListener('DOMContentLoaded', function() {
  if (window.tutorialManager) {
    tutorialManager.autoStart();
  }
  console.log('🎓 アルゴリズム作成画面 読み込み完了');
});

window.TutorialHelper = {
  enableDebug: function() {
    if (window.tutorialManager) {
      tutorialManager.enableDebugMode();
    }
  }
};

console.log('🔧 TutorialHelper loaded (Block Page)');

    // ステップ1: 導入
    {
      target: null,
      centerMessage: true,
      message: 'ここは アルゴリズムを つくる がめんです！<br><br>ここでは、ボタンを おしたときの どうさを きめます。',
      nextText: 'つぎへ',
      showSkip: true
    },
    // ステップ2: システムカテゴリを開く
    {
      target: null,
      centerMessage: true,
      message: 'ひだりの メニューから「システム」を クリックして、<br>システムブロックを ひょうじして ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ2: システムカテゴリ展開待機');
        
        // システムカテゴリが展開されるまで待つ
        const checkCategory = setInterval(() => {
          const systemCategory = document.querySelector('.blocklyTreeRow[id*="システム"]');
          if (systemCategory && systemCategory.getAttribute('aria-expanded') === 'true') {
            clearInterval(checkCategory);
            console.log('✅ システムカテゴリが展開されました');
            setTimeout(() => tutorialOverlay.next(), 500);
          }
        }, 100);
      }
    },
    // ステップ3: system_conditionブロックを探す
    {
      target: null,
      centerMessage: true,
      message: '「もし システム ○○の」という ブロックを さがして、<br>みぎの ワークスペースに ドラッグして ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ3: system_conditionブロック配置待機');
        
        // system_conditionブロックが配置されるまで待つ
        const checkBlock = setInterval(() => {
          const workspace = Blockly.getMainWorkspace();
          const blocks = workspace.getAllBlocks();
          const systemConditionBlock = blocks.find(b => b.type === 'system_condition');
          
          if (systemConditionBlock) {
            clearInterval(checkBlock);
            console.log('✅ system_conditionブロックが配置されました');
            window.tutorialState.systemConditionBlock = systemConditionBlock;
            setTimeout(() => tutorialOverlay.next(), 500);
          }
        }, 100);
      }
    },
    // ステップ4: システム選択
    {
      target: null,
      centerMessage: true,
      message: 'ブロックの「せんたくしてね」を クリックして、<br>「もんだい」を えらんで ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ4: システム選択待機');
        
        // システムが選択されるまで待つ
        const checkSelection = setInterval(() => {
          const block = window.tutorialState.systemConditionBlock;
          if (block) {
            const systemId = block.getFieldValue('SYSTEM_ID');
            if (systemId && systemId !== '0') {
              clearInterval(checkSelection);
              console.log('✅ システムが選択されました:', systemId);
              setTimeout(() => tutorialOverlay.next(), 500);
            }
          }
        }, 100);
      }
    },
    // ステップ5: ラベル選択
    {
      target: null,
      centerMessage: true,
      message: 'つぎに、「ラベル」の ところで<br>「1+1は?」を えらんで ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ5: ラベル選択待機');
        
        // ラベルが選択されるまで待つ
        const checkLabel = setInterval(() => {
          const block = window.tutorialState.systemConditionBlock;
          if (block) {
            const elementName = block.getFieldValue('ELEMENT_NAME');
            if (elementName && elementName !== '') {
              try {
                const data = JSON.parse(elementName);
                if (data.label === '1+1は?') {
                  clearInterval(checkLabel);
                  console.log('✅ ラベルが選択されました: 1+1は?');
                  setTimeout(() => tutorialOverlay.next(), 500);
                }
              } catch (e) {
                // JSON解析エラーは無視
              }
            }
          }
        }, 100);
      }
    },
    // ステップ6: 条件設定（項目選択）
    {
      target: null,
      centerMessage: true,
      message: 'じょうけんを せっていします！<br><br>「が」の あとの ぷるだうんから<br>「2」を えらんで ください。',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ6: 項目選択待機');
        
        // 項目が選択されるまで待つ
        const checkItem = setInterval(() => {
          const block = window.tutorialState.systemConditionBlock;
          if (block) {
            const itemValue = block.getFieldValue('ITEM_0');
            if (itemValue === '2') {
              clearInterval(checkItem);
              console.log('✅ 項目「2」が選択されました');
              setTimeout(() => tutorialOverlay.next(), 500);
            }
          }
        }, 100);
      }
    },
    // ステップ7: display_systemブロックを追加
    {
      target: null,
      centerMessage: true,
      message: 'つぎは、せいかいのときに ひょうじする システムを えらびます！<br><br>「システムをひょうじ」ブロックを<br>「すること」の なかに ドラッグして ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ7: display_systemブロック配置待機');
        
        // display_systemブロックがDOブロック内に配置されるまで待つ
        const checkDisplayBlock = setInterval(() => {
          const block = window.tutorialState.systemConditionBlock;
          if (block) {
            const doConnection = block.getInput('DO').connection;
            if (doConnection && doConnection.targetBlock()) {
              const targetBlock = doConnection.targetBlock();
              if (targetBlock.type === 'display_system') {
                clearInterval(checkDisplayBlock);
                console.log('✅ display_systemブロックが配置されました');
                window.tutorialState.displayBlock = targetBlock;
                setTimeout(() => tutorialOverlay.next(), 500);
              }
            }
          }
        }, 100);
      }
    },
    // ステップ8: せいかいシステムを選択
    {
      target: null,
      centerMessage: true,
      message: '「システムをひょうじ」ブロックで<br>「せいかい」を えらんで ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ8: せいかいシステム選択待機');
        
        // せいかいが選択されるまで待つ
        const checkSeikai = setInterval(() => {
          const block = window.tutorialState.displayBlock;
          if (block) {
            const systemId = block.getFieldValue('SYSTEM_ID');
            // システム名が「せいかい」のIDを探す（実際のIDは動的に変わる可能性がある）
            if (systemId && systemId !== '0') {
              // システム一覧から名前を確認
              const systems = window._systemsList || [];
              const selectedSystem = systems.find(s => s.system_id.toString() === systemId);
              if (selectedSystem && selectedSystem.system_name === 'せいかい') {
                clearInterval(checkSeikai);
                console.log('✅ せいかいシステムが選択されました');
                setTimeout(() => tutorialOverlay.next(), 500);
              }
            }
          }
        }, 100);
      }
    },
    // ステップ9: ふせいかいシステムも追加
    {
      target: null,
      centerMessage: true,
      message: 'おなじように、「そうでなければ」の なかにも<br>「システムをひょうじ」ブロックを ついかして、<br>「ふせいかい」を えらんで ください！',
      nextText: null,
      showSkip: true,
      onShow: function() {
        console.log('🎯 ステップ9: ふせいかいシステム配置待機');
        
        // ふせいかいブロックが配置され選択されるまで待つ
        const checkFuseikai = setInterval(() => {
          const block = window.tutorialState.systemConditionBlock;
          if (block) {
            const elseConnection = block.getInput('ELSE').connection;
            if (elseConnection && elseConnection.targetBlock()) {
              const targetBlock = elseConnection.targetBlock();
              if (targetBlock.type === 'display_system') {
                const systemId = targetBlock.getFieldValue('SYSTEM_ID');
                if (systemId && systemId !== '0') {
                  const systems = window._systemsList || [];
                  const selectedSystem = systems.find(s => s.system_id.toString() === systemId);
                  if (selectedSystem && selectedSystem.system_name === 'ふせいかい') {
                    clearInterval(checkFuseikai);
                    console.log('✅ ふせいかいシステムが選択されました');
                    setTimeout(() => tutorialOverlay.next(), 500);
                  }
                }
              }
            }
          }
        }, 100);
      }
    },
    // ステップ10: 保存ボタンへ誘導
    {
      target: '#saveBtn',
      message: 'アルゴリズムが かんせいしました！<br><br>「ほぞん」ボタンを おして、<br>アルゴリズムを ほぞんしましょう！',
      requireClick: true,
      showSkip: true
    },
    // ステップ11: 完了メッセージ
    {
      target: null,
      centerMessage: true,
      message: 'おめでとう ございます！<br><br>アルゴリズムが ほぞん されました！<br><br>つぎは、この もんだいシステムを<br>じっさいに テストして みましょう！',
      nextText: 'つぎへ',
      showSkip: false,
      onNext: function() {
        console.log('✅ アルゴリズムチュートリアル完了');
        // アルゴリズム作成完了フラグをセット
        sessionStorage.setItem('tutorial_step2_algorithm_saved', 'true');
        // 作成フラグをクリア
        sessionStorage.removeItem('tutorial_step2_mondai_created');
      }
    }
  ];
  
  tutorialOverlay.init(steps, {
    onComplete: function() {
      console.log('✅ もんだいアルゴリズムチュートリアル完了');
      // 完了フラグをセット
      sessionStorage.setItem('tutorial_step2_algorithm_saved', 'true');
      // 作成フラグをクリア
      sessionStorage.removeItem('tutorial_step2_mondai_created');
    },
    onSkip: function() {
      console.log('⏭️ もんだいアルゴリズムチュートリアルをスキップ');
      // チュートリアルをスキップした場合もフラグをクリア
      sessionStorage.removeItem('tutorial_step2_mondai_created');
      return true;
    }
  });
}

// ページ読み込み時にチュートリアル開始チェック
document.addEventListener('DOMContentLoaded', function() {
  // もんだい作成完了フラグをチェック
  if (sessionStorage.getItem('tutorial_step2_mondai_created') === 'true') {
    console.log('🎓 もんだい作成完了を検知、アルゴリズムチュートリアルを開始');
    
    // Blocklyの初期化を待つ
    setTimeout(() => {
      if (window.tutorialOverlay && typeof startMondaiAlgorithmTutorial === 'function') {
        startMondaiAlgorithmTutorial();
      }
    }, 1000);
  }
});

// ========================================
// デバッグ用ユーティリティ
// ========================================
window.TutorialHelper = window.TutorialHelper || {};
window.TutorialHelper = {
  enableDebug: function() {
    if (window.tutorialManager) {
      tutorialManager.enableDebugMode();
    }
  }
};

console.log('🔧 TutorialHelper loaded (Block Page)');
</script>

{% endblock %}
