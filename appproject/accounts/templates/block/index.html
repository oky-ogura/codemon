<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>アルゴリズム作成</title>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>
<style>
  /* ----- 上部ナビゲーション ----- */
  :root {
    --nav-height:56px;
    --primary:#1976d2;
    --bg:#f9f9f9;
    --card:#ffffff;
    --muted:#666;
  }
  body{
    margin:0;
    font-family: "Yu Gothic","Hiragino Kaku Gothic ProN","Segoe UI",sans-serif;
    background:var(--bg);
    color:#222;
  }
  .top-nav {
    box-sizing:border-box;
    width:100%;
    max-width:1180px;
    height:var(--nav-height);
    margin:12px auto;
    display:flex;
    align-items:center;
    gap:12px;
    padding:6px 12px;
    background:linear-gradient(180deg,#fff,#fafafa);
    border-radius:10px;
    box-shadow:0 1px 3px rgba(0,0,0,0.06);
    border:1px solid #e6e6e9;
  }
  .nav-brand{
    display:flex;
    align-items:center;
    gap:8px;
    margin-right:12px;
    padding-right:8px;
    border-right:1px solid #eee;
  }
  .nav-brand .logo{
    width:36px;
    height:36px;
    border-radius:6px;
    background:var(--primary);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color:#fff;
    font-weight:700;
    font-size:18px;
  }
  .nav-brand .title{
    font-size:15px;
    color:#111;
    font-weight:600;
  }
  .nav-tabs{
    display:flex;
    /* タブの間隔を均等にする */
    justify-content: space-evenly;
    align-items:center;
    width:100%;
  }
  .nav-tab{
    appearance:none;
    border:0;
    background:transparent;
    padding:8px 12px;
    border-radius:8px;
    font-size:14px;
    cursor:pointer;
    color:var(--muted);
    transition: all .12s ease;
  }
  .nav-tab:hover{
    background:#f0f6ff;
    color:var(--primary);
    transform:translateY(-1px);
  }
  .nav-tab.active{
    background:var(--primary);
    color:#fff;
    box-shadow:0 2px 6px rgba(25,118,210,0.18);
  }

  /* ----- ページレイアウト ----- */
  .page-wrap{
    max-width:1180px;
    margin:0 auto 40px;
    padding:12px;
    box-sizing:border-box;
  }

  /* ----- 既存スタイル（元ファイルを保持） ----- */
  #container { display: flex; }
  #blocklyDiv { height: 480px; width: 700px; border: 1px solid #ccc; }
  #visual-area {
    width: 500px;
    height: 470px;
    border: 1px solid #000;
    background: #f9f9f9;
    margin-left: 10px;
    overflow-y: auto;
    padding: 5px;
  }
  label { margin-right: 5px; }
  .form-row { margin-bottom: 10px; }
  .shortcut-btns {
    margin-bottom: 10px;
    display: flex;
    align-items: center;
  }
  .shortcut-btns button {
    font-size: 18px;
    margin-right: 5px;
    padding: 4px 12px;
    cursor: pointer;
  }
  .shortcut-btns #runBtn {
    font-size: 18px;
    margin-left: 10px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 4px 16px;
  }
  .shortcut-btns #runBtn:hover {
    background: #0056b3;
  }

  /* 保存ボタンスタイル追加 */
  .shortcut-btns #saveBtn {
    font-size: 18px;
    margin-left: 8px;
    background: #28a745;
    color: #fff;
    border: none;
    border-radius: 4px;
    padding: 4px 14px;
    cursor: pointer;
  }
  .shortcut-btns #saveBtn:hover {
    background: #1e7e34;
  }

  /* レスポンシブ調整 */
  @media (max-width:1100px){
    #blocklyDiv { width: 60%; }
    #visual-area { width: 36%; margin-left: 8px; }
    .top-nav, .page-wrap { padding-left:10px; padding-right:10px; }
  }
  @media (max-width:760px){
    .top-nav .title { display:none; }
    #container { flex-direction: column; }
    #blocklyDiv, #visual-area { width:100%; margin:6px 0; height:420px; }
  }
</style>
</head>
<body>
  <header class="top-nav" role="banner" aria-label="メインナビゲーション">

    <nav class="nav-tabs" role="navigation" aria-label="タブメニュー">
      <button class="nav-tab" id="tab-system" aria-pressed="false" title="システム">システム</button>
      <button class="nav-tab active" id="tab-algorithm" aria-pressed="true" title="アルゴリズム">アルゴリズム</button>
      <button class="nav-tab" id="tab-progress" aria-pressed="false" title="進捗確認">進捗確認</button>
      <button class="nav-tab" id="tab-account" aria-pressed="false" title="アカウント">アカウント</button>
    </nav>
  </header>

  <main class="page-wrap" role="main">
    <h1>アルゴリズム作成</h1>

    <div class="shortcut-btns">
      <button id="undoBtn" title="元に戻す (Ctrl+Z)">←</button>
      <button id="redoBtn" title="やり直し (Ctrl+Y)">→</button>
      <button id="runBtn" onclick="runBlocks()">実行</button>
      <button id="saveBtn">保存</button>
    </div>

    <div id="container">
      <div id="blocklyDiv"></div>
      <div id="visual-area">ここに実行結果が表示されます</div>
    </div>
  </main>

<!-- ツールボックス -->
<xml id="toolbox" style="display:none">
  <category name="動き" colour="230">
    <block type="move_steps"></block>
    <block type="turn_right"></block>
    <block type="turn_left"></block>
    <block type="goto_xy"></block>
  </category>
  <category name="フォーム" colour="160">
    <block type="show_text"></block>
    <block type="radio_choice"></block>
    <block type="radio_free"></block>
    <block type="checkbox_free"></block> 
    <block type="number_input"></block>
    <block type="print_text"></block>
  </category>
  <category name="演算" colour="200">
    <block type="direct_number"></block>
    <block type="arithmetic"></block>
  </category>
  <category name="制御" colour="120">
    <block type="controls_repeat_custom"></block>
    <block type="controls_if_custom"></block>
  </category>
</xml>

<script>
const visual = document.getElementById("visual-area");

/* ---------------------- ナビタブ（見た目切替 / 遷移） ---------------------- */
(function(){
  try{
    const tabs = document.querySelectorAll('.nav-tab');
    tabs.forEach(tab=>{
      tab.addEventListener('click', (e)=>{
        try{
          // クリックで見た目を切替（押せるようにする）
          tabs.forEach(t=>{
            t.classList.remove('active');
            t.setAttribute('aria-pressed','false');
          });
          tab.classList.add('active');
          tab.setAttribute('aria-pressed','true');
          if(typeof tab.blur === 'function') tab.blur();

          // システムタブ
          if(tab.id === 'tab-system'){
            // system_choice.html へ遷移
            window.location.href = 'http://127.0.0.1:8000/accounts/system/choice/';
            return;
          }
          // アルゴリズムタブ
          if(tab.id === 'tab-algorithm'){
            window.location.href = 'http://127.0.0.1:8000/accounts/block/';
            return;
          }
          // 他タブは現状見た目のみ（遷移未実装）
        }catch(err){
          console.error('tab click handler error', err);
        }
      });
    });
  }catch(err){
    console.error('tabs init error', err);
  }
})();

// ---------------------- フォームブロック ----------------------

// テキスト入力フォーム
Blockly.Blocks['show_text'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("テキスト入力フォーム (ラベル: ")
      .appendField(new Blockly.FieldTextInput("テキスト"), "label")
      .appendField(")");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(160);
    this.updateVisual = function(container) {
      const inputId = "block_" + this.id;
      const labelText = this.getFieldValue("label");
      container.innerHTML += `<div class="form-row">
          <label for="${inputId}">${labelText}</label>
          <input type="text" id="${inputId}"></div>`;
    };
    this.getValue = function() {
      const inputId = "block_" + this.id;
      return document.getElementById(inputId)?.value || "";
    };
  }
};

// 数値入力フォーム
Blockly.Blocks['number_input'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("数値入力フォーム (ラベル: ")
      .appendField(new Blockly.FieldTextInput("数値"), "label")
      .appendField(")");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(160);
    this.updateVisual = function(container) {
      const inputId = "block_" + this.id;
      const labelText = this.getFieldValue("label");
      container.innerHTML += `<div class="form-row">
          <label for="${inputId}">${labelText}</label>
          <input type="number" id="${inputId}"></div>`;
    };
    this.getValue = function() {
      const inputId = "block_" + this.id;
      return Number(document.getElementById(inputId)?.value || 0);
    };
  }
};

// ラジオボタン (固定選択肢)
Blockly.Blocks['radio_choice'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("固定ラジオ (ラベル: ")
      .appendField(new Blockly.FieldTextInput("質問:"), "label")
      .appendField(")");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(160);
    this.updateVisual = function(container) {
      const name = "radio_" + this.id;
      const labelText = this.getFieldValue("label");
      container.innerHTML += `
        <div class="form-row">${labelText}
          <label><input type="radio" name="${name}" value="はい">はい</label>
          <label><input type="radio" name="${name}" value="いいえ">いいえ</label>
        </div>`;
    };
    this.getValue = function() {
      const name = "radio_" + this.id;
      const checked = document.querySelector(`input[name="${name}"]:checked`);
      return checked ? checked.value : "";
    };
  }
};

// ラジオボタン (自由選択肢)
Blockly.Blocks['radio_free'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("自由ラジオ (ラベル: ")
      .appendField(new Blockly.FieldTextInput("質問:"), "label")
      .appendField(" 選択肢: ")
      .appendField(new Blockly.FieldTextInput("はい/いいえ/わからない"), "options")
      .appendField(")");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(160);
    this.updateVisual = function(container) {
      const name = "radio_" + this.id;
      const labelText = this.getFieldValue("label");
      const opts = this.getFieldValue("options").split("/");
      container.innerHTML += `<div class="form-row">${labelText}`;
      opts.forEach(o => {
        container.innerHTML += `<label><input type="radio" name="${name}" value="${o}">${o}</label>`;
      });
      container.innerHTML += `</div>`;
    };
    this.getValue = function() {
      const name = "radio_" + this.id;
      const checked = document.querySelector(`input[name="${name}"]:checked`);
      return checked ? checked.value : "";
    };
  }
};

// チェックボックス (自由選択肢)
Blockly.Blocks['checkbox_free'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("チェックボックス (ラベル: ")
      .appendField(new Blockly.FieldTextInput("質問:"), "label")
      .appendField(" 選択肢: ")
      .appendField(new Blockly.FieldTextInput("a/b/c/d"), "options")
      .appendField(")");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(160);
    this.updateVisual = function(container) {
      const labelText = this.getFieldValue("label");
      const opts = this.getFieldValue("options").split("/");
      container.innerHTML += `<div class="form-row">${labelText}</div>`;
      opts.forEach((o,i)=>{
        container.innerHTML += `<label><input type="checkbox" id="checkbox_${this.id}_${i}" value="${o}">${o}</label>`;
      });
      container.innerHTML += `</div>`;
    };
    this.getValue = function() {
      const inputs = Array.from(document.querySelectorAll(`#visual-area input[type="checkbox"]`))
                          .filter(input => input.parentElement && input.parentElement.innerText.includes(this.getFieldValue("label")));
      return inputs.filter(input => input.checked).map(i=>i.value).join(", ");
    };
  }
};

// ---------------------- 演算ブロック ----------------------

// 直接数値入力
Blockly.Blocks['direct_number'] = {
  init: function() {
    this.appendDummyInput()
      .appendField(new Blockly.FieldNumber(0, -1000, 1000, 1), "value");
    this.setOutput(true, "Number");
    this.setColour(200);
  }
};

// 四則演算
Blockly.Blocks['arithmetic'] = {
  init: function() {
    this.appendValueInput("A").setCheck("Number");
    this.appendDummyInput()
      .appendField(new Blockly.FieldDropdown([["+","ADD"],["-","MINUS"],["×","MULTIPLY"],["÷","DIVIDE"]]), "OP");
    this.appendValueInput("B").setCheck("Number");
    this.setInputsInline(true);
    this.setOutput(true, "Number");
    this.setColour(200);
  }
};

// ---------------------- 動き系ブロック ----------------------
Blockly.Blocks['move_steps'] = {
  init: function() {
    this.appendDummyInput()
      .appendField(new Blockly.FieldNumber(10), "steps")
      .appendField("歩動かす");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(230);
  }
};

Blockly.Blocks['turn_right'] = {
  init: function() {
    this.appendDummyInput()
      .appendField(new Blockly.FieldNumber(15), "degrees")
      .appendField("度回す (右)");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(230);
  }
};

Blockly.Blocks['turn_left'] = {
  init: function() {
    this.appendDummyInput()
      .appendField(new Blockly.FieldNumber(15), "degrees")
      .appendField("度回す (左)");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(230);
  }
};

Blockly.Blocks['goto_xy'] = {
  init: function() {
    this.appendDummyInput()
      .appendField("x座標を")
      .appendField(new Blockly.FieldNumber(0), "x")
      .appendField("に、y座標を")
      .appendField(new Blockly.FieldNumber(0), "y")
      .appendField("にする");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(230);
  }
};

// ---------------------- 繰り返しブロック ----------------------
Blockly.Blocks['controls_repeat_custom'] = {
  init: function() {
    this.appendValueInput("TIMES")
        .setCheck("Number")
        .appendField("次の処理を");
    this.appendDummyInput()
        .appendField("回繰り返す");
    this.appendStatementInput("DO")
        .appendField("処理");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(120);
  }
};

// ---------------------- 条件分岐ブロック ----------------------
Blockly.Blocks['controls_if_custom'] = {
  init: function() {
    this.appendValueInput("LEFT")
        .setCheck(null)
        .appendField("もし");
    this.appendDummyInput()
        .appendField("が")
        .appendField(new Blockly.FieldDropdown([
          ["=","EQ"],
          ["≠","NEQ"],
          [">","GT"],
          ["<","LT"],
          ["≥","GTE"],
          ["≤","LTE"]
        ]), "OP");
    this.appendValueInput("RIGHT")
        .setCheck(null);
    this.appendDummyInput()
        .appendField("なら");
    this.appendStatementInput("DO")
        .appendField("処理");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(120);
  }
};

// ---------------------- テキスト表示ブロック ----------------------
Blockly.Blocks['print_text'] = {
  init: function() {
    this.appendDummyInput()
        .appendField("表示するテキスト:")
        .appendField(new Blockly.FieldTextInput("ここに文字を入力"), "TEXT");
    this.setPreviousStatement(true);
    this.setNextStatement(true);
    this.setColour(160);
  }
};

// ---------------------- ワークスペース ----------------------
const workspace = Blockly.inject('blocklyDiv', {
  toolbox: document.getElementById('toolbox')
});

// Undoボタン
document.getElementById('undoBtn').addEventListener('click', function() {
  workspace.undo(false);
});

// Redoボタン
document.getElementById('redoBtn').addEventListener('click', function() {
  workspace.undo(true);
});

// 保存ボタン（画面は未実装だが遷移できるようにする）
document.getElementById('saveBtn').addEventListener('click', function() {
  // 保存画面のURL（未実装）へ遷移
  window.location.href = 'http://127.0.0.1:8000/accounts/block/save/';
});

// ショートカットキー（Ctrl+Z, Ctrl+Y）
document.addEventListener('keydown', function(e) {
  // Ctrl+Z（元に戻す）
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
    e.preventDefault();
    workspace.undo(false);
  }
  // Ctrl+Y（やり直し）
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'y') {
    e.preventDefault();
    workspace.undo(true);
  }
});

// ---------------------- 条件評価関数 ----------------------
function evalCondition(block){
  if(!block) return 0;
  if(block.getValue) {
    const val = block.getValue();
    if(typeof val === "string") return val !== "" ? 1 : 0;
    return Number(val);
  }
  if(block.type === "direct_number") return Number(block.getFieldValue("value"));
  if(block.type === "arithmetic") {
    const A = evalCondition(block.getInputTargetBlock("A")) || 0;
    const B = evalCondition(block.getInputTargetBlock("B")) || 0;
    const op = block.getFieldValue("OP");
    switch(op){
      case "ADD": return A + B;
      case "MINUS": return A - B;
      case "MULTIPLY": return A * B;
      case "DIVIDE": return B !== 0 ? A / B : 0;
    }
  }
  return 0;
}

function evalIfCondition(block){
  if(!block) return false;
  const left = evalCondition(block.getInputTargetBlock("LEFT"));
  const right = evalCondition(block.getInputTargetBlock("RIGHT"));
  const op = block.getFieldValue("OP");
  switch(op){
    case "EQ": return left == right;
    case "NEQ": return left != right;
    case "GT": return left > right;
    case "LT": return left < right;
    case "GTE": return left >= right;
    case "LTE": return left <= right;
  }
  return false;
}

// ---------------------- 実行関数 ----------------------
function runBlocks(){
  visual.innerHTML = "";
  const blocks = workspace.getTopBlocks(true);

  function processBlock(block){
    if(!block) return;

    if(block.updateVisual) block.updateVisual(visual);
    else{
      switch(block.type){
        case 'controls_repeat_custom':
          const times = evalCondition(block.getInputTargetBlock("TIMES")) || 0;
          const doBlock = block.getInputTargetBlock("DO");
          for(let i = 0; i < times; i++){
            if(doBlock) processBlock(doBlock);
          }
          break;

        case 'controls_if_custom':
          if(evalIfCondition(block)){
            const doBlock = block.getInputTargetBlock("DO");
            if(doBlock) processBlock(doBlock);
          }
          break;

        case 'print_text':
          const textVal = block.getFieldValue("TEXT");
          visual.innerHTML += `<p>${textVal}</p>`;
          break;

        case 'radio_choice':
        case 'radio_free':
        case 'checkbox_free':
        case 'number_input':
        case 'show_text':
          const val = block.getValue?.();
          if(val !== undefined && val !== null && val !== "") {
            visual.innerHTML += `<p>${val}</p>`;
          }
          break;

        case 'move_steps':
          visual.innerHTML += `<p>${block.getFieldValue('steps')}歩動かす</p>`; break;
        case 'turn_right':
          visual.innerHTML += `<p>${block.getFieldValue('degrees')}度右に回す</p>`; break;
        case 'turn_left':
          visual.innerHTML += `<p>${block.getFieldValue('degrees')}度左に回す</p>`; break;
        case 'goto_xy':
          visual.innerHTML += `<p>座標を (${block.getFieldValue('x')}, ${block.getFieldValue('y')}) にする</p>`; break;
        case 'direct_number':
        case 'arithmetic':
          visual.innerHTML += `<p>演算結果: ${evalCondition(block)}</p>`; break;
      }
    }

    const next = block.getNextBlock();
    if(next) processBlock(next);
  }

  blocks.forEach(b => processBlock(b));
}

visual.innerHTML = "ここに実行結果が表示されます";
</script>
</body>
</html>