  <!-- Blocklyå‹•çš„ãƒ­ãƒ¼ãƒ‰ -->
  <script>
    // Blocklyã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
    function loadBlockly() {
      return new Promise((resolve, reject) => {
        if (typeof Blockly !== 'undefined') {
          console.log('âœ… Blockly already loaded');
          resolve();
          return;
        }

        console.log('ğŸ“¥ Loading Blockly...');
        
        // blockly.min.js ã‚’èª­ã¿è¾¼ã¿
        const script1 = document.createElement('script');
        script1.src = 'https://unpkg.com/blockly/blockly.min.js';
        script1.onload = function() {
          console.log('âœ… blockly.min.js loaded');
          
          // javascript_compressed.js ã‚’èª­ã¿è¾¼ã¿
          const script2 = document.createElement('script');
          script2.src = 'https://unpkg.com/blockly/javascript_compressed.js';
          script2.onload = function() {
            console.log('âœ… javascript_compressed.js loaded');
            
            // ja.js ã‚’èª­ã¿è¾¼ã¿
            const script3 = document.createElement('script');
            script3.src = 'https://unpkg.com/blockly/msg/ja.js';
            script3.onload = function() {
              console.log('âœ… Blockly fully loaded');
              window.blocklyReady = true;
              resolve();
            };
            script3.onerror = () => reject(new Error('Failed to load ja.js'));
            document.head.appendChild(script3);
          };
          script2.onerror = () => reject(new Error('Failed to load javascript_compressed.js'));
          document.head.appendChild(script2);
        };
        script1.onerror = () => reject(new Error('Failed to load blockly.min.js'));
        document.head.appendChild(script1);
      });
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«Blocklyã‚’ãƒ­ãƒ¼ãƒ‰
    window.blocklyReady = false;
    loadBlockly().catch(err => {
      console.error('âŒ Blockly loading failed:', err);
    });
  </script>

  <script>
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’ä¿æŒ
    const existingSystemData = {
      systemId: '{{ system_id|default:"" }}',
      systemName: '{{ system_name|default:""|escapejs }}',
      systemDescription: '{{ system_description|default:""|escapejs }}'
    };
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ—¢å­˜è¦ç´ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ
    const existingElementsData = {{ elements_json|default:"[]"|safe }};
    
    // æœªä¿å­˜ã®å¤‰æ›´ã‚’è¿½è·¡
    let isDirty = false;
    let initialContent = '';

    // åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
    (function saveInitialState(){
      const slideArea = document.getElementById('slideArea');
      if (slideArea) {
        initialContent = slideArea.innerHTML;
      }
    })();

    // å¤‰æ›´ã‚’æ¤œçŸ¥ã™ã‚‹é–¢æ•°
    function markDirty() {
      const slideArea = document.getElementById('slideArea');
      if (slideArea && slideArea.innerHTML !== initialContent) {
        isDirty = true;
      }
    }

    // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¨ãƒªã‚¢ã®å¤‰æ›´ã‚’ç›£è¦–
    (function watchChanges(){
      const slideArea = document.getElementById('slideArea');
      if (!slideArea) return;
      
      // MutationObserverã§å¤‰æ›´ã‚’ç›£è¦–
      const observer = new MutationObserver(function() {
        markDirty();
      });
      
      observer.observe(slideArea, {
        childList: true,
        subtree: true,
        attributes: true,
        characterData: true
      });
    })();

    // ãƒ–ãƒ©ã‚¦ã‚¶é–‰ã˜ã‚‹/ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã®è­¦å‘Š
    window.addEventListener('beforeunload', function(e) {
      if (!isDirty) return;
      e.preventDefault();
      e.returnValue = '';
    });
  </script>
