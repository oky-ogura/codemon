<script>
// è¦ç´ ä½œæˆé–¢æ•°ç¾¤

// ãƒ©ãƒ³ãƒ€ãƒ ä½ç½®å–å¾—
function getRandomPosition(w = 200, h = 100) {
  const slide = document.getElementById('slideArea');
  if (!slide) return { x: 50, y: 50 };
  const maxW = 860 - w - 20;
  const maxH = 440 - h - 20;
  return {
    x: Math.max(20, Math.floor(Math.random() * maxW)),
    y: Math.max(20, Math.floor(Math.random() * maxH))
  };
}

// æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿
window.attachNumberFilter = function attachNumberFilter(input) {
  input.addEventListener('beforeinput', e => {
    if (e.inputType === 'insertText' && !/^\d$/.test(e.data || '')) {
      e.preventDefault();
    }
  });
  input.addEventListener('input', e => {
    const start = input.selectionStart;
    const oldVal = input.value;
    const sanitized = oldVal.replace(/\D/g, '');
    if (oldVal !== sanitized) {
      input.value = sanitized;
    }
    const newVal = input.value;
    input.value = newVal;
    const pos = start + sanitized.length - oldVal.length + start;
    try { input.setSelectionRange(pos, pos); } catch(e){}
    input.dispatchEvent(new Event('input', { bubbles: true }));
  });
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
window.createCheckboxGroup = function createCheckboxGroup(count, groupLabel = '') {
  count = Math.min(count || 0, 10);
  const slide = document.getElementById('slideArea');
  if (!slide) return;
  const group = document.createElement('div');
  group.className = 'checkbox-group';

  // ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
  if (groupLabel) {
    const labelDiv = document.createElement('div');
    labelDiv.className = 'checkbox-group-label';
    labelDiv.contentEditable = 'true';
    labelDiv.textContent = groupLabel;
    labelDiv.style.fontWeight = 'bold';
    labelDiv.style.marginBottom = '4px';
    labelDiv.style.cursor = 'text';
    group.appendChild(labelDiv);
  }

  for (let i = 0; i < count; i++) {
    const row = document.createElement('div');
    row.className = 'checkbox-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.tabIndex = 0;

    const lbl = document.createElement('div');
    lbl.className = 'checkbox-label';
    lbl.contentEditable = 'true';
    lbl.textContent = 'é …ç›® ' + (i + 1);

    row.appendChild(cb);
    row.appendChild(lbl);
    group.appendChild(row);
  }

  const pos = getRandomPosition(200, Math.max(80, (groupLabel ? 20 : 0) + count * 28));
  group.style.left = pos.x + 'px';
  group.style.top = pos.y + 'px';

  addDragHandleIfMissing(group);
  makeDraggable(group);
  slide.appendChild(group);
  saveHistory();
}

// ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
window.createRadioGroup = function createRadioGroup(count, groupLabel = '') {
  count = Math.min(count || 0, 10);
  const slide = document.getElementById('slideArea');
  if (!slide) return;
  const group = document.createElement('div');
  group.className = 'radio-group';

  const uniqueName = 'radio_group_' + Date.now() + '_' + Math.floor(Math.random()*1000);

  if (groupLabel) {
    const labelDiv = document.createElement('div');
    labelDiv.className = 'radio-group-label';
    labelDiv.contentEditable = 'true';
    labelDiv.textContent = groupLabel;
    labelDiv.style.fontWeight = 'bold';
    labelDiv.style.marginBottom = '4px';
    labelDiv.style.cursor = 'text';
    group.appendChild(labelDiv);
  }

  for (let i = 0; i < count; i++) {
    const row = document.createElement('div');
    row.className = 'radio-row';

    const rb = document.createElement('input');
    rb.type = 'radio';
    rb.name = uniqueName;
    rb.tabIndex = 0;

    const lbl = document.createElement('div');
    lbl.className = 'radio-label';
    lbl.contentEditable = 'true';
    lbl.textContent = 'é …ç›® ' + (i + 1);

    row.appendChild(rb);
    row.appendChild(lbl);
    group.appendChild(row);
  }

  const pos = getRandomPosition(200, Math.max(80, (groupLabel ? 20 : 0) + count * 28));
  group.style.left = pos.x + 'px';
  group.style.top = pos.y + 'px';

  addDragHandleIfMissing(group);
  makeDraggable(group);
  slide.appendChild(group);
  saveHistory();
}

// ãƒ†ã‚­ã‚¹ãƒˆ/æ•°å€¤å…¥åŠ›ä½œæˆ
function createInput(defaultLabel, placeholder, onlyNumber=false) {
  let container = document.createElement("div");
  container.classList.add("input-container");

  let label = document.createElement("div");
  label.classList.add("input-label");
  label.textContent = defaultLabel;
  label.contentEditable = "true";

  if (onlyNumber) {
    let input = document.createElement("input");
    input.type = "text";
    input.inputMode = "numeric";
    input.pattern = "\\d*";
    input.classList.add("input-box");
    input.placeholder = placeholder;
    input.setAttribute('data-only-number', 'true');

    container.appendChild(label);
    container.appendChild(input);

    attachNumberFilter(input);
  } else {
    let textarea = document.createElement("textarea");
    textarea.classList.add("input-box");
    textarea.placeholder = placeholder;
    container.appendChild(label);
    container.appendChild(textarea);
  }

  let pos = getRandomPosition();
  container.style.left = pos.x + "px";
  container.style.top = pos.y + "px";
  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
  saveHistory();
}

// ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ä½œæˆï¼ˆãƒ‰ãƒ©ãƒƒã‚°ã§ã‚µã‚¤ã‚ºæ±ºå®šï¼‰
function createTextBox() {
  const slideArea = document.getElementById("slideArea");
  if (!slideArea) return;
  
  // ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒ—ãƒ©ã‚¹ãƒãƒ¼ã‚¯ã«å¤‰æ›´
  slideArea.style.cursor = "crosshair";
  
  let startX, startY;
  let isDrawing = false;
  let previewBox = null;
  
  function onMouseDown(e) {
    // slideAreaã¾ãŸã¯trashã‚¨ãƒªã‚¢ä»¥å¤–ã¯ã‚¹ã‚­ãƒƒãƒ—
    if (e.target !== slideArea && e.target.id !== 'trash') return;
    
    isDrawing = true;
    const rect = slideArea.getBoundingClientRect();
    startX = e.clientX - rect.left + slideArea.scrollLeft;
    startY = e.clientY - rect.top + slideArea.scrollTop;
    
    // æ—¢å­˜ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
    if (previewBox) {
      previewBox.remove();
    }
    
    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
    previewBox = document.createElement("div");
    previewBox.className = "textbox-preview";
    previewBox.style.position = "absolute";
    previewBox.style.left = startX + "px";
    previewBox.style.top = startY + "px";
    previewBox.style.width = "0px";
    previewBox.style.height = "0px";
    previewBox.style.border = "2px dashed #3fbcd9";
    previewBox.style.background = "rgba(63, 188, 217, 0.1)";
    previewBox.style.pointerEvents = "none";
    previewBox.style.zIndex = "9999";
    slideArea.appendChild(previewBox);
    
    e.preventDefault();
    e.stopPropagation();
  }
  
  function onMouseMove(e) {
    if (!isDrawing || !previewBox) return;
    
    const rect = slideArea.getBoundingClientRect();
    const currentX = e.clientX - rect.left + slideArea.scrollLeft;
    const currentY = e.clientY - rect.top + slideArea.scrollTop;
    
    const width = Math.abs(currentX - startX);
    const height = Math.abs(currentY - startY);
    const left = Math.min(startX, currentX);
    const top = Math.min(startY, currentY);
    
    previewBox.style.left = left + "px";
    previewBox.style.top = top + "px";
    previewBox.style.width = width + "px";
    previewBox.style.height = height + "px";
  }
  
  function onMouseUp(e) {
    if (!isDrawing) {
      cleanup();
      return;
    }
    
    isDrawing = false;
    
    if (previewBox) {
      const width = parseInt(previewBox.style.width) || 0;
      const height = parseInt(previewBox.style.height) || 0;
      const left = parseInt(previewBox.style.left) || 0;
      const top = parseInt(previewBox.style.top) || 0;
      
      // æœ€å°ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆå°ã•ã™ãã‚‹å ´åˆã¯ä½œæˆã—ãªã„ï¼‰
      if (width >= 50 && height >= 30) {
        // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
        const container = document.createElement("div");
        container.className = "text-box-container";
        container.style.position = "absolute";
        container.style.left = left + "px";
        container.style.top = top + "px";
        container.style.width = width + "px";
        container.style.height = height + "px";
        
        const textarea = document.createElement("textarea");
        textarea.className = "text-box";
        textarea.placeholder = "ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...";
        textarea.style.width = "100%";
        textarea.style.height = "100%";
        textarea.style.resize = "none";
        textarea.style.boxSizing = "border-box";
        
        container.appendChild(textarea);
        addDragHandleIfMissing(container);
        makeDraggable(container);
        slideArea.appendChild(container);
        saveHistory();
        
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹
        setTimeout(() => textarea.focus(), 100);
      }
    }
    
    cleanup();
  }
  
  function cleanup() {
    slideArea.removeEventListener("mousedown", onMouseDown);
    slideArea.removeEventListener("mousemove", onMouseMove);
    slideArea.removeEventListener("mouseup", onMouseUp);
    slideArea.style.cursor = "default";
    
    // ã™ã¹ã¦ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
    const previews = slideArea.querySelectorAll('.textbox-preview');
    previews.forEach(p => p.remove());
    
    if (previewBox && previewBox.parentNode) {
      previewBox.remove();
    }
    previewBox = null;
  }
  
  slideArea.addEventListener("mousedown", onMouseDown);
  slideArea.addEventListener("mousemove", onMouseMove);
  slideArea.addEventListener("mouseup", onMouseUp);
  
  // ESCã‚­ãƒ¼ã§ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  function onKeyDown(e) {
    if (e.key === 'Escape') {
      isDrawing = false;
      cleanup();
      document.removeEventListener('keydown', onKeyDown);
    }
  }
  document.addEventListener('keydown', onKeyDown);
}

// æ—¥æ™‚å…¥åŠ›ä½œæˆ
function createDatetimeInput() {
  let container = document.createElement("div");
  container.classList.add("input-container");

  let label = document.createElement("div");
  label.classList.add("input-label");
  label.textContent = "æ—¥æ™‚ï¼š";
  label.contentEditable = "true";

  let input = document.createElement("input");
  input.type = "datetime-local";
  input.style.minWidth = "180px";
  input.style.minHeight = "36px";
  input.style.fontSize = "16px";
  input.style.padding = "4px 8px";
  input.style.boxSizing = "border-box";
  input.classList.add("input-box");

  container.appendChild(label);
  container.appendChild(input);

  let pos = getRandomPosition(240, 40);
  container.style.left = pos.x + "px";
  container.style.top = pos.y + "px";
  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
  saveHistory();
}

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹é–¢æ•°
window.attachRouletteListeners = function attachRouletteListeners(container) {
  if (!container) return;
  
  const spinBtn = container.querySelector('.roulette-btn.spin');
  const wheel = container.querySelector('.roulette-wheel');
  const result = container.querySelector('.roulette-result');
  
  if (!spinBtn || !wheel || !result) return;
  
  // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
  const newSpinBtn = spinBtn.cloneNode(true);
  spinBtn.parentNode.replaceChild(newSpinBtn, spinBtn);
  
  // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
  newSpinBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    const spinning = container.getAttribute('data-roulette-spinning') === 'true';
    if (spinning) return;
    
    const itemsStr = container.getAttribute('data-roulette-items');
    if (!itemsStr) return;
    
    const items = JSON.parse(itemsStr);
    
    container.setAttribute('data-roulette-spinning', 'true');
    newSpinBtn.disabled = true;
    newSpinBtn.style.cursor = 'not-allowed';
    newSpinBtn.style.opacity = '0.6';
    
    const currentRotation = parseFloat(wheel.dataset.currentRotation) || 0;
    const spins = 5 + Math.random() * 3;
    const extraDegrees = Math.random() * 360;
    const newRotation = currentRotation + spins * 360 + extraDegrees;
    
    wheel.style.transform = `rotate(${newRotation}deg)`;
    wheel.dataset.currentRotation = newRotation;
    
    setTimeout(() => {
      const finalAngle = ((newRotation % 360) + 360) % 360;
      const segmentAngle = 360 / items.length;
      const angleOnWheel = (270 - finalAngle + 360) % 360;
      const selectedIndex = Math.floor((angleOnWheel + 90) / segmentAngle) % items.length;
      
      result.textContent = `çµæœ: ${items[selectedIndex]}`;
      container.setAttribute('data-roulette-spinning', 'false');
      newSpinBtn.disabled = false;
      newSpinBtn.style.cursor = 'pointer';
      newSpinBtn.style.opacity = '1';
    }, 3000);
  });
};

// ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä½œæˆ
async function createRoulette() {
  const itemCountStr = await customPrompt("ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é …ç›®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (2-20)", "6", {
    title: 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä½œæˆ',
    type: 'number'
  });
  
  if (itemCountStr === null) return;
  const itemCount = parseInt(itemCountStr) || 6;
  
  if (itemCount < 2 || itemCount > 20) {
    await customAlert("é …ç›®æ•°ã¯2ï½20ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„", {
      title: 'ã‚¨ãƒ©ãƒ¼'
    });
    return;
  }
  
  // è¤‡æ•°å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§ä¸€åº¦ã«ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›
  const items = await customMultiInput(itemCount, {
    title: 'ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆé …ç›®ã®å…¥åŠ›',
    message: `${itemCount}å€‹ã®é …ç›®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`,
    labelPrefix: 'é …ç›®',
    defaultPrefix: 'é …ç›®'
  });
  
  if (items === null) return;
  
  const container = document.createElement("div");
  container.classList.add("roulette-container");
  container.setAttribute('data-roulette-items', JSON.stringify(items));
  container.setAttribute('data-roulette-spinning', 'false');
  
  const wheel = document.createElement("div");
  wheel.classList.add("roulette-wheel");
  wheel.style.position = "relative";
  wheel.style.width = "200px";
  wheel.style.height = "200px";
  wheel.style.transition = "transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)";
  wheel.dataset.currentRotation = "0";
  
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "200");
  svg.setAttribute("height", "200");
  svg.setAttribute("viewBox", "0 0 200 200");
  
  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52C41A'];
  const centerX = 100;
  const centerY = 100;
  const radius = 95;
  const anglePerSegment = (2 * Math.PI) / items.length;
  
  items.forEach((item, index) => {
    const startAngle = index * anglePerSegment - Math.PI / 2;
    const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
    
    const x1 = centerX + radius * Math.cos(startAngle);
    const y1 = centerY + radius * Math.sin(startAngle);
    const x2 = centerX + radius * Math.cos(endAngle);
    const y2 = centerY + radius * Math.sin(endAngle);
    
    const largeArcFlag = anglePerSegment > Math.PI ? 1 : 0;
    
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
    path.setAttribute("fill", colors[index % colors.length]);
    path.setAttribute("stroke", "#fff");
    path.setAttribute("stroke-width", "2");
    svg.appendChild(path);
    
    const textAngle = startAngle + anglePerSegment / 2;
    const textRadius = radius * 0.65;
    const textX = centerX + textRadius * Math.cos(textAngle);
    const textY = centerY + textRadius * Math.sin(textAngle);
    
    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", textX);
    text.setAttribute("y", textY);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("dominant-baseline", "middle");
    text.setAttribute("fill", "#fff");
    text.setAttribute("font-size", "14");
    text.setAttribute("font-weight", "bold");
    text.setAttribute("transform", `rotate(${(textAngle * 180 / Math.PI) + 90}, ${textX}, ${textY})`);
    text.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";
    text.textContent = item;
    svg.appendChild(text);
  });
  
  const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  circle.setAttribute("cx", centerX);
  circle.setAttribute("cy", centerY);
  circle.setAttribute("r", radius);
  circle.setAttribute("fill", "none");
  circle.setAttribute("stroke", "#333");
  circle.setAttribute("stroke-width", "4");
  svg.appendChild(circle);
  
  wheel.appendChild(svg);
  
  const pin = document.createElement("div");
  pin.style.position = "absolute";
  pin.style.top = "-15px";
  pin.style.left = "48%";
  pin.style.transform = "translateX(-50%)";
  pin.style.width = "0";
  pin.style.height = "0";
  pin.style.borderLeft = "10px solid transparent";
  pin.style.borderRight = "10px solid transparent";
  pin.style.borderTop = "20px solid #FF0000";
  pin.style.zIndex = "10";
  pin.style.pointerEvents = "none";
  
  const result = document.createElement("div");
  result.classList.add("roulette-result");
  result.style.marginTop = "10px";
  result.style.padding = "12px 16px";
  result.style.background = "linear-gradient(135deg, #667eea 0%, #764ba2 100%)";
  result.style.borderRadius = "20px";
  result.style.textAlign = "center";
  result.style.fontWeight = "bold";
  result.style.fontSize = "18px";
  result.style.color = "#fff";
  result.style.boxShadow = "0 4px 15px rgba(102, 126, 234, 0.4)";
  result.style.transition = "all 0.3s ease";
  result.textContent = "çµæœ: -";
  
  const spinBtn = document.createElement("button");
  spinBtn.classList.add("roulette-btn", "spin");
  spinBtn.textContent = "ğŸ² ã‚¹ãƒ”ãƒ³";
  spinBtn.style.marginTop = "10px";
  spinBtn.style.padding = "12px 30px";
  spinBtn.style.fontSize = "18px";
  spinBtn.style.fontWeight = "bold";
  spinBtn.style.cursor = "pointer";
  spinBtn.style.position = "relative";
  spinBtn.style.zIndex = "100";
  spinBtn.style.background = "linear-gradient(135deg, #f093fb 0%, #f5576c 100%)";
  spinBtn.style.color = "#fff";
  spinBtn.style.border = "none";
  spinBtn.style.borderRadius = "25px";
  spinBtn.style.boxShadow = "0 4px 15px rgba(245, 87, 108, 0.4)";
  spinBtn.style.transition = "all 0.3s ease";
  
  spinBtn.addEventListener('mouseenter', function() {
    spinBtn.style.transform = "translateY(-2px) scale(1.05)";
    spinBtn.style.boxShadow = "0 6px 20px rgba(245, 87, 108, 0.5)";
  });
  
  spinBtn.addEventListener('mouseleave', function() {
    spinBtn.style.transform = "translateY(0) scale(1)";
    spinBtn.style.boxShadow = "0 4px 15px rgba(245, 87, 108, 0.4)";
  });
  
  spinBtn.addEventListener('mousedown', function() {
    spinBtn.style.transform = "translateY(2px) scale(0.98)";
  });
  
  spinBtn.addEventListener('mouseup', function() {
    spinBtn.style.transform = "translateY(-2px) scale(1.05)";
  });
  
  const wheelWrapper = document.createElement("div");
  wheelWrapper.style.position = "relative";
  wheelWrapper.style.pointerEvents = "none";
  wheelWrapper.appendChild(pin);
  wheelWrapper.appendChild(wheel);
  
  container.appendChild(wheelWrapper);
  container.appendChild(result);
  container.appendChild(spinBtn);
  
  const pos = getRandomPosition(220, 280);
  container.style.left = pos.x + "px";
  container.style.top = pos.y + "px";
  container.style.width = "220px";
  container.style.height = "280px";
  
  const slide = document.getElementById("slideArea");
  slide.appendChild(container);
  makeDraggable(container);
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  attachRouletteListeners(container);
  saveHistory();
}

// ã‚¿ã‚¤ãƒãƒ¼ä½œæˆ
async function createTimer() {
  let mode = null;
  while (mode === null) {
    const modeInput = await customPrompt("ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„\n\n1: ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—\n2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³", "1", {
      title: 'ã‚¿ã‚¤ãƒãƒ¼è¨­å®š'
    });
    
    if (modeInput === null) return;
    
    if (modeInput === '1') {
      mode = 'up';
    } else if (modeInput === '2') {
      mode = 'down';
    } else {
      await customAlert("1ã¾ãŸã¯2ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", {
        title: 'ã‚¨ãƒ©ãƒ¼'
      });
    }
  }
  
  let targetSeconds = 0;
  let displayText = "00:00:00";
  
  if (mode === 'down') {
    const hours = parseInt(await customPrompt("æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-23)", "0", {title: 'æ™‚é–“è¨­å®š'})) || 0;
    const minutes = parseInt(await customPrompt("åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", "1", {title: 'åˆ†è¨­å®š'})) || 0;
    const seconds = parseInt(await customPrompt("ç§’ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", "0", {title: 'ç§’è¨­å®š'})) || 0;
    
    targetSeconds = Math.max(0, Math.min(hours, 23)) * 3600 + 
                   Math.max(0, Math.min(minutes, 59)) * 60 + 
                   Math.max(0, Math.min(seconds, 59));
    
    if (targetSeconds === 0) {
      await customAlert("æ™‚é–“ãŒ0ç§’ã§ã™ã€‚æœ€ä½1ç§’ä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„ã€‚", {
        title: 'ã‚¨ãƒ©ãƒ¼'
      });
      return;
    }
    
    const h = Math.floor(targetSeconds / 3600);
    const m = Math.floor((targetSeconds % 3600) / 60);
    const s = targetSeconds % 60;
    displayText = String(h).padStart(2, '0') + ':' +
                 String(m).padStart(2, '0') + ':' +
                 String(s).padStart(2, '0');
  }
  
  let container = document.createElement("div");
  container.classList.add("timer-container");
  container.setAttribute('data-timer-seconds', mode === 'down' ? targetSeconds.toString() : '0');
  container.setAttribute('data-timer-running', 'false');
  container.setAttribute('data-timer-mode', mode);
  container.setAttribute('data-timer-target', targetSeconds.toString());

  let settingsBtn = document.createElement("button");
  settingsBtn.classList.add("timer-settings-btn");
  settingsBtn.textContent = "âš™ è¨­å®š";
  settingsBtn.title = "ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´";
  settingsBtn.onclick = function(e) {
    e.stopPropagation();
    openTimerSettings(container, display);
  };

  let display = document.createElement("div");
  display.classList.add("timer-display");
  display.textContent = displayText;

  let controls = document.createElement("div");
  controls.classList.add("timer-controls");

  let startBtn = document.createElement("button");
  startBtn.classList.add("timer-btn", "start");
  startBtn.textContent = "é–‹å§‹";
  startBtn.onclick = function(e) {
    e.stopPropagation();
    const running = container.getAttribute('data-timer-running') === 'true';
    const timerMode = container.getAttribute('data-timer-mode');
    
    if (!running) {
      if (timerMode === 'down') {
        const target = parseInt(container.getAttribute('data-timer-target') || '0');
        if (target === 0) {
          alert('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
          return;
        }
      }
      container.setAttribute('data-timer-running', 'true');
      startBtn.textContent = "åœæ­¢";
      startBtn.classList.remove('start');
      startBtn.classList.add('pause');
    } else {
      container.setAttribute('data-timer-running', 'false');
      startBtn.textContent = "é–‹å§‹";
      startBtn.classList.remove('pause');
      startBtn.classList.add('start');
    }
  };

  let resetBtn = document.createElement("button");
  resetBtn.classList.add("timer-btn", "reset");
  resetBtn.textContent = "ãƒªã‚»ãƒƒãƒˆ";
  resetBtn.onclick = function(e) {
    e.stopPropagation();
    const timerMode = container.getAttribute('data-timer-mode');
    container.setAttribute('data-timer-running', 'false');
    
    if (timerMode === 'up') {
      container.setAttribute('data-timer-seconds', '0');
      display.textContent = "00:00:00";
    } else {
      const target = parseInt(container.getAttribute('data-timer-target') || '0');
      container.setAttribute('data-timer-seconds', target.toString());
      const h = Math.floor(target / 3600);
      const m = Math.floor((target % 3600) / 60);
      const s = target % 60;
      display.textContent = 
        String(h).padStart(2, '0') + ':' +
        String(m).padStart(2, '0') + ':' +
        String(s).padStart(2, '0');
    }
    
    startBtn.textContent = "é–‹å§‹";
    startBtn.classList.remove('pause');
    startBtn.classList.add('start');
  };

  controls.appendChild(startBtn);
  controls.appendChild(resetBtn);
  
  container.appendChild(settingsBtn);
  container.appendChild(display);
  container.appendChild(controls);

  let pos = getRandomPosition(220, 120);
  container.style.left = pos.x + "px";
  container.style.top = pos.y + "px";
  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
  saveHistory();
}

// ã‚¿ã‚¤ãƒãƒ¼è¨­å®šå¤‰æ›´
window.openTimerSettings = async function openTimerSettings(container, display) {
  const currentMode = container.getAttribute('data-timer-mode');
  const currentTarget = parseInt(container.getAttribute('data-timer-target') || '0');
  
  let newMode = null;
  while (newMode === null) {
    const currentModeText = currentMode === 'up' ? 'ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—' : 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³';
    const modeInput = await customPrompt("ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„\n\nç¾åœ¨: " + currentModeText + "\n\n1: ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—\n2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³", currentMode === 'up' ? '1' : '2', {
      title: 'ã‚¿ã‚¤ãƒãƒ¼è¨­å®š'
    });
    
    if (modeInput === null) return;
    
    if (modeInput === '1') {
      newMode = 'up';
    } else if (modeInput === '2') {
      newMode = 'down';
    } else {
      await customAlert("1ã¾ãŸã¯2ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", {
        title: 'ã‚¨ãƒ©ãƒ¼'
      });
    }
  }
  
  let newTarget = 0;
  
  if (newMode === 'down') {
    const currentH = Math.floor(currentTarget / 3600);
    const currentM = Math.floor((currentTarget % 3600) / 60);
    const currentS = currentTarget % 60;
    
    const hours = parseInt(await customPrompt("æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-23)", currentH.toString(), {title: 'æ™‚é–“è¨­å®š'})) || 0;
    const minutes = parseInt(await customPrompt("åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", currentM.toString(), {title: 'åˆ†è¨­å®š'})) || 0;
    const seconds = parseInt(await customPrompt("ç§’ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", currentS.toString(), {title: 'ç§’è¨­å®š'})) || 0;
    
    newTarget = Math.max(0, Math.min(hours, 23)) * 3600 + 
               Math.max(0, Math.min(minutes, 59)) * 60 + 
               Math.max(0, Math.min(seconds, 59));
    
    if (newTarget === 0) {
      alert("æ™‚é–“ãŒ0ç§’ã§ã™ã€‚è¨­å®šã‚’å¤‰æ›´ã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
      return;
    }
  }
  
  container.setAttribute('data-timer-mode', newMode);
  container.setAttribute('data-timer-target', newTarget.toString());
  container.setAttribute('data-timer-running', 'false');
  
  if (newMode === 'up') {
    container.setAttribute('data-timer-seconds', '0');
    display.textContent = "00:00:00";
  } else {
    container.setAttribute('data-timer-seconds', newTarget.toString());
    const h = Math.floor(newTarget / 3600);
    const m = Math.floor((newTarget % 3600) / 60);
    const s = newTarget % 60;
    display.textContent = 
      String(h).padStart(2, '0') + ':' +
      String(m).padStart(2, '0') + ':' +
      String(s).padStart(2, '0');
  }
  
  const startBtn = container.querySelector('.timer-btn.start, .timer-btn.pause');
  if (startBtn) {
    startBtn.textContent = "é–‹å§‹";
    startBtn.classList.remove('pause');
    startBtn.classList.add('start');
  }
  
  saveHistory();
}

// ãƒœã‚¿ãƒ³ä½œæˆ
function createButton(labelText, width, height, color, textColor, targetSystemId, targetAlgorithmId, algorithmXml) {
  let btn = document.createElement("button");
  btn.classList.add("draggable-btn");
  btn.textContent = labelText;

  btn.style.width = width + "px";
  btn.style.height = height + "px";
  btn.style.background = color;
  btn.style.color = textColor || "#fff";
  
  // button_idã‚’ç”Ÿæˆã—ã¦ä¿å­˜
  const buttonId = 'btn_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
  btn.setAttribute('data-button-id', buttonId);

  if (targetSystemId) {
    btn.setAttribute('data-target-system', targetSystemId);
  }
  
  if (targetAlgorithmId) {
    btn.setAttribute('data-algorithm-id', targetAlgorithmId);
  }
  if (algorithmXml) {
    btn.setAttribute('data-algorithm-xml', algorithmXml);
  }

  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    
    const isPreview = btn.closest('#previewSlideArea');
    
    console.log('ğŸ”˜ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ (æ–°è¦ä½œæˆ):', {
      text: labelText,
      isPreview: !!isPreview,
      targetAlgorithmId: targetAlgorithmId,
      algorithmXml: algorithmXml ? `${algorithmXml.length}æ–‡å­—` : 'ãªã—',
      targetSystemId: targetSystemId
    });
    
    if (isPreview) {
      if (targetAlgorithmId && algorithmXml) {
        console.log('âœ… ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ:', targetAlgorithmId);
        executeAlgorithmFromButton(algorithmXml, labelText);
      } else if (targetSystemId) {
        console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ é·ç§»:', targetSystemId);
        loadSystemInPreview(targetSystemId);
      } else {
        console.warn('âš ï¸ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚‚ã‚·ã‚¹ãƒ†ãƒ ã‚‚è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
    } else {
      console.log('â„¹ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒœã‚¿ãƒ³ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚å®Ÿè¡Œãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ãã ã•ã„ã€‚');
    }
  });

  let pos = getRandomPosition(width, height);
  btn.style.left = pos.x + "px";
  btn.style.top = pos.y + "px";
  addDragHandleIfMissing(btn);
  makeDraggable(btn);
  document.getElementById("slideArea").appendChild(btn);
  saveHistory();
}

// ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©è¨­å®š
const addTextBtn = document.getElementById("addTextBtn");
if (addTextBtn) {
  addTextBtn.addEventListener("click", function(e) {
    e.stopPropagation();
    createInput("æ–‡å­—ï¼š", "æ–‡å­—ã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œå¯ï¼‰");
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹å‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
    const slideArea = document.getElementById('slideArea');
    if (slideArea) slideArea.focus();
    
    const formDropdown = document.getElementById('formDropdown');
    if (formDropdown) {
      formDropdown.classList.remove('show');
      formDropdown.setAttribute('aria-hidden', 'true');
    }
  });
}

const addNumberBtn = document.getElementById("addNumberBtn");
if (addNumberBtn) {
  addNumberBtn.addEventListener("click", function(e) {
    e.stopPropagation();
    createInput("æ•°å­—ï¼š", "æ•°å­—ã‚’å…¥åŠ›", true);
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹å‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
    const slideArea = document.getElementById('slideArea');
    if (slideArea) slideArea.focus();
    
    const formDropdown = document.getElementById('formDropdown');
    if (formDropdown) {
      formDropdown.classList.remove('show');
      formDropdown.setAttribute('aria-hidden', 'true');
    }
  });
}

const addDatetimeBtn = document.getElementById("addDatetimeBtn");
if (addDatetimeBtn) {
  addDatetimeBtn.addEventListener("click", function(e) {
    e.stopPropagation();
    createDatetimeInput();
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹å‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
    const slideArea = document.getElementById('slideArea');
    if (slideArea) slideArea.focus();
    
    const formDropdown = document.getElementById('formDropdown');
    if (formDropdown) {
      formDropdown.classList.remove('show');
      formDropdown.setAttribute('aria-hidden', 'true');
    }
  });
}

const addTextBoxBtn = document.getElementById("addTextBoxBtn");
if (addTextBoxBtn) {
  addTextBoxBtn.addEventListener("click", function(e) {
    e.stopPropagation();
    createTextBox();
    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹å‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
    const slideArea = document.getElementById('slideArea');
    if (slideArea) slideArea.focus();
    
    const formDropdown = document.getElementById('formDropdown');
    if (formDropdown) {
      formDropdown.classList.remove('show');
      formDropdown.setAttribute('aria-hidden', 'true');
    }
  });
}

const addRouletteBtn = document.getElementById("addRouletteBtn");
if (addRouletteBtn) {
  addRouletteBtn.addEventListener("click", function() {
    createRoulette();
  });
}

const addTimerBtn = document.getElementById("addTimerBtn");
if (addTimerBtn) {
  addTimerBtn.addEventListener("click", async function() {
    await createTimer();
  });
}

const addButtonBtn = document.getElementById("addButtonBtn");
if (addButtonBtn) {
  addButtonBtn.addEventListener("click", async function() {
    const algorithms = {{ algorithms_json|safe }};
    const otherSystems = {{ other_systems_json|safe }};
    
    const settings = await customButtonSettings(algorithms, otherSystems);
    if (!settings) return;
    
    let targetSystemId = null;
    let targetAlgorithmId = null;
    let algorithmXml = null;
    
    // ãƒ†ã‚­ã‚¹ãƒˆè‰²ã‚’è¨ˆç®—ï¼ˆæ˜ã‚‹ã„èƒŒæ™¯ãªã‚‰æš—ã„æ–‡å­—ã€æš—ã„èƒŒæ™¯ãªã‚‰æ˜ã‚‹ã„æ–‡å­—ï¼‰
    const bgColor = settings.color;
    const r = parseInt(bgColor.slice(1, 3), 16);
    const g = parseInt(bgColor.slice(3, 5), 16);
    const b = parseInt(bgColor.slice(5, 7), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    const textColor = brightness > 128 ? '#000000' : '#ffffff';
    
    if (settings.actionType === 'algorithm' && algorithms && settings.algorithmIndex !== null) {
      const algo = algorithms[settings.algorithmIndex];
      if (algo) {
        targetAlgorithmId = algo.algorithm_id;
        algorithmXml = algo.blockly_xml;
      }
    } else if (settings.actionType === 'system' && otherSystems && settings.systemIndex !== null) {
      const sys = otherSystems[settings.systemIndex];
      if (sys) {
        targetSystemId = sys.system_id;
      }
    }

    createButton(settings.name, settings.width, settings.height, bgColor, textColor, targetSystemId, targetAlgorithmId, algorithmXml);
  });
}

// ========================================
// å›³å½¢ä½œæˆæ©Ÿèƒ½
// ========================================

// å›³å½¢ä½œæˆé–¢æ•°
window.createShape = function createShape(shapeType) {
  const slide = document.getElementById('slideArea');
  if (!slide) return;

  const shape = document.createElement('div');
  shape.className = `shape-element shape-${shapeType}`;
  shape.setAttribute('data-shape-type', shapeType);
  shape.setAttribute('data-shape-color', '#333333');
  shape.setAttribute('data-shape-fill', 'transparent');
  
  let defaultWidth = 100;
  let defaultHeight = 100;

  switch (shapeType) {
    case 'rectangle':
      shape.style.width = defaultWidth + 'px';
      shape.style.height = defaultHeight + 'px';
      break;
    case 'circle':
      shape.style.width = defaultWidth + 'px';
      shape.style.height = defaultWidth + 'px';
      break;
    case 'triangle':
      // ä¸‰è§’å½¢ã¯ç‰¹æ®Šãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨
      defaultWidth = 100;
      defaultHeight = 87;
      break;
    case 'line':
      defaultWidth = 150;
      defaultHeight = 2;
      shape.style.width = defaultWidth + 'px';
      shape.style.height = defaultHeight + 'px';
      break;
    case 'arrow':
      defaultWidth = 150;
      defaultHeight = 12;
      shape.style.width = defaultWidth + 'px';
      shape.style.height = defaultHeight + 'px';
      break;
  }

  const pos = getRandomPosition(defaultWidth, defaultHeight);
  shape.style.left = pos.x + 'px';
  shape.style.top = pos.y + 'px';

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
  shape.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    openShapeSettings(shape);
  });

  // å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
  shape.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    openShapeSettings(shape);
  });

  addDragHandleIfMissing(shape);
  makeDraggable(shape);
  slide.appendChild(shape);
  
  // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã‚’è¿½åŠ 
  if (typeof attachResizeHandlers === 'function') {
    attachResizeHandlers(shape, shapeType);
  }
  
  saveHistory();
};

// å›³å½¢è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
window.openShapeSettings = function openShapeSettings(shapeElement) {
  // æ—¢å­˜ã®ãƒ‘ãƒãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
  const existingPanel = document.querySelector('.shape-settings-panel');
  if (existingPanel) existingPanel.remove();

  const panel = document.createElement('div');
  panel.className = 'shape-settings-panel show';

  const shapeType = shapeElement.getAttribute('data-shape-type');
  const currentColor = shapeElement.getAttribute('data-shape-color') || '#333333';
  const currentFill = shapeElement.getAttribute('data-shape-fill') || 'transparent';
  
  let currentWidth, currentHeight;
  if (shapeType === 'triangle') {
    const borderBottom = shapeElement.style.borderBottomWidth || shapeElement.style.borderBottom;
    currentHeight = parseInt(borderBottom) || 87;
    currentWidth = Math.floor(currentHeight * 100 / 87);
  } else {
    currentWidth = parseInt(shapeElement.style.width) || 100;
    currentHeight = parseInt(shapeElement.style.height) || 100;
  }

  panel.innerHTML = `
    <div class="setting-row">
      <label>ç·šã®è‰²</label>
      <div class="color-picker-wrapper">
        <input type="color" id="shapeColorPicker" value="${currentColor}" />
        <span id="shapeColorValue">${currentColor}</span>
      </div>
    </div>
    ${shapeType !== 'line' && shapeType !== 'arrow' ? `
      <div class="setting-row">
        <label>å¡—ã‚Šã¤ã¶ã—è‰²</label>
        <div class="color-picker-wrapper">
          <input type="color" id="shapeFillPicker" value="${currentFill !== 'transparent' ? currentFill : '#ffffff'}" />
          <span id="shapeFillValue">${currentFill !== 'transparent' ? currentFill : 'é€æ˜'}</span>
          <label style="display: inline; margin-left: 8px;">
            <input type="checkbox" id="shapeFillTransparent" ${currentFill === 'transparent' ? 'checked' : ''} /> é€æ˜
          </label>
        </div>
      </div>
    ` : ''}
    ${shapeType === 'circle' ? `
      <div class="setting-row">
        <label>ã‚µã‚¤ã‚º (px)</label>
        <input type="number" id="shapeSize" value="${currentWidth}" min="20" max="500" />
      </div>
    ` : shapeType !== 'triangle' ? `
      <div class="setting-row">
        <label>å¹… (px)</label>
        <input type="number" id="shapeWidth" value="${currentWidth}" min="20" max="800" />
      </div>
      <div class="setting-row">
        <label>é«˜ã• (px)</label>
        <input type="number" id="shapeHeight" value="${currentHeight}" min="2" max="500" />
      </div>
    ` : `
      <div class="setting-row">
        <label>ã‚µã‚¤ã‚º (px)</label>
        <input type="number" id="shapeSize" value="${currentWidth}" min="20" max="500" />
      </div>
    `}
    <div class="panel-actions">
      <button id="shapeCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="shapeApplyBtn" class="primary">é©ç”¨</button>
    </div>
  `;

  document.body.appendChild(panel);

  // ãƒ‘ãƒãƒ«ã‚’å›³å½¢ã®è¿‘ãã«é…ç½®
  const rect = shapeElement.getBoundingClientRect();
  panel.style.left = (rect.right + 10) + 'px';
  panel.style.top = rect.top + 'px';

  // è‰²é¸æŠã®æ›´æ–°
  const colorPicker = document.getElementById('shapeColorPicker');
  const colorValue = document.getElementById('shapeColorValue');
  if (colorPicker && colorValue) {
    colorPicker.addEventListener('input', function() {
      colorValue.textContent = this.value;
    });
  }

  const fillPicker = document.getElementById('shapeFillPicker');
  const fillValue = document.getElementById('shapeFillValue');
  const fillTransparent = document.getElementById('shapeFillTransparent');
  if (fillPicker && fillValue) {
    fillPicker.addEventListener('input', function() {
      if (fillTransparent && !fillTransparent.checked) {
        fillValue.textContent = this.value;
      }
    });
  }
  if (fillTransparent) {
    fillTransparent.addEventListener('change', function() {
      if (this.checked) {
        fillValue.textContent = 'é€æ˜';
        if (fillPicker) fillPicker.disabled = true;
      } else {
        if (fillPicker) {
          fillPicker.disabled = false;
          fillValue.textContent = fillPicker.value;
        }
      }
    });
    if (fillTransparent.checked && fillPicker) {
      fillPicker.disabled = true;
    }
  }

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
  document.getElementById('shapeCancelBtn').addEventListener('click', function() {
    panel.remove();
  });

  // é©ç”¨ãƒœã‚¿ãƒ³
  document.getElementById('shapeApplyBtn').addEventListener('click', function() {
    const newColor = colorPicker ? colorPicker.value : currentColor;
    let newFill = currentFill;
    
    if (fillTransparent && fillTransparent.checked) {
      newFill = 'transparent';
    } else if (fillPicker) {
      newFill = fillPicker.value;
    }

    shapeElement.setAttribute('data-shape-color', newColor);
    shapeElement.setAttribute('data-shape-fill', newFill);

    // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    if (shapeType === 'triangle') {
      shapeElement.style.borderBottomColor = newColor;
      shapeElement.style.borderLeftColor = 'transparent';
      shapeElement.style.borderRightColor = 'transparent';
      
      const sizeInput = document.getElementById('shapeSize');
      if (sizeInput) {
        const newSize = parseInt(sizeInput.value) || 100;
        const newHeight = Math.floor(newSize * 0.866);
        shapeElement.style.borderLeftWidth = (newSize / 2) + 'px';
        shapeElement.style.borderRightWidth = (newSize / 2) + 'px';
        shapeElement.style.borderBottomWidth = newHeight + 'px';
      }
    } else if (shapeType === 'line') {
      shapeElement.style.background = newColor;
      const widthInput = document.getElementById('shapeWidth');
      const heightInput = document.getElementById('shapeHeight');
      if (widthInput) shapeElement.style.width = widthInput.value + 'px';
      if (heightInput) shapeElement.style.height = heightInput.value + 'px';
    } else if (shapeType === 'arrow') {
      const beforeStyle = `content: ''; flex: 1; height: 2px; background: ${newColor};`;
      const afterStyle = `content: ''; width: 0; height: 0; border-left: 10px solid ${newColor}; border-top: 6px solid transparent; border-bottom: 6px solid transparent;`;
      
      shapeElement.setAttribute('data-before-style', beforeStyle);
      shapeElement.setAttribute('data-after-style', afterStyle);
      
      // ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆã«å‹•çš„ã«è¿½åŠ 
      updateArrowStyles(shapeElement, newColor);
      
      const widthInput = document.getElementById('shapeWidth');
      const heightInput = document.getElementById('shapeHeight');
      if (widthInput) shapeElement.style.width = widthInput.value + 'px';
      if (heightInput) shapeElement.style.height = heightInput.value + 'px';
    } else if (shapeType === 'circle') {
      shapeElement.style.borderColor = newColor;
      shapeElement.style.background = newFill;
      
      const sizeInput = document.getElementById('shapeSize');
      if (sizeInput) {
        const newSize = sizeInput.value + 'px';
        shapeElement.style.width = newSize;
        shapeElement.style.height = newSize;
      }
    } else {
      shapeElement.style.borderColor = newColor;
      shapeElement.style.background = newFill;
      
      const widthInput = document.getElementById('shapeWidth');
      const heightInput = document.getElementById('shapeHeight');
      if (widthInput) shapeElement.style.width = widthInput.value + 'px';
      if (heightInput) shapeElement.style.height = heightInput.value + 'px';
    }

    saveHistory();
    panel.remove();
  });

  // ãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  setTimeout(() => {
    document.addEventListener('click', function closePanel(e) {
      if (!panel.contains(e.target) && !shapeElement.contains(e.target)) {
        panel.remove();
        document.removeEventListener('click', closePanel);
      }
    });
  }, 10);
};

// çŸ¢å°ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‹•çš„ã«æ›´æ–°
window.updateArrowStyles = function updateArrowStyles(arrowElement, color) {
  const styleId = 'arrow-' + Date.now();
  arrowElement.setAttribute('data-style-id', styleId);
  
  let styleEl = document.getElementById(styleId);
  if (!styleEl) {
    styleEl = document.createElement('style');
    styleEl.id = styleId;
    document.head.appendChild(styleEl);
  }
  
  styleEl.textContent = `
    [data-style-id="${styleId}"]::before {
      content: '';
      flex: 1;
      height: 2px;
      background: ${color};
    }
    [data-style-id="${styleId}"]::after {
      content: '';
      width: 0;
      height: 0;
      border-left: 10px solid ${color};
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
    }
  `;
};

// å›³å½¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
const shapeBtn = document.getElementById('shapeBtn');
const shapeDropdown = document.getElementById('shapeDropdown');
const shapeDropdownWrap = document.getElementById('shapeDropdownWrap');

if (shapeBtn && shapeDropdown) {
  shapeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    const isOpen = shapeDropdown.classList.contains('show');
    if (isOpen) {
      shapeDropdown.classList.remove('show');
      shapeDropdown.setAttribute('aria-hidden', 'true');
      shapeBtn.setAttribute('aria-expanded', 'false');
    } else {
      shapeDropdown.classList.add('show');
      shapeDropdown.setAttribute('aria-hidden', 'false');
      shapeBtn.setAttribute('aria-expanded', 'true');
    }
  });

  // å›³å½¢é¸æŠãƒœã‚¿ãƒ³
  document.getElementById('addRectangleBtn')?.addEventListener('click', function() {
    createShape('rectangle');
    shapeDropdown.classList.remove('show');
  });

  document.getElementById('addCircleBtn')?.addEventListener('click', function() {
    createShape('circle');
    shapeDropdown.classList.remove('show');
  });

  document.getElementById('addTriangleBtn')?.addEventListener('click', function() {
    createShape('triangle');
    shapeDropdown.classList.remove('show');
  });

  document.getElementById('addLineBtn')?.addEventListener('click', function() {
    createShape('line');
    shapeDropdown.classList.remove('show');
  });

  document.getElementById('addArrowBtn')?.addEventListener('click', function() {
    createShape('arrow');
    shapeDropdown.classList.remove('show');
  });

  // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.addEventListener('click', function(e) {
    if (shapeDropdownWrap && !shapeDropdownWrap.contains(e.target)) {
      shapeDropdown.classList.remove('show');
      shapeDropdown.setAttribute('aria-hidden', 'true');
      shapeBtn.setAttribute('aria-expanded', 'false');
    }
  });
}
</script>
<!-- ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹æç”»æ©Ÿèƒ½ -->
<script>
  (function(){
    const slide = document.getElementById('slideArea');
    const buttonBar = document.querySelector('.button-bar');
    if (!slide || !buttonBar) return;

    const drawBtn = document.createElement('button');
    drawBtn.id = 'drawTextBtn';
    drawBtn.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹';
    drawBtn.title = 'ãƒ‰ãƒ©ãƒƒã‚°ã§é¸æŠã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ';
    buttonBar.appendChild(drawBtn);

    let drawing = false;
    let startX = 0, startY = 0;
    let selRect = null;

    function toLocalCoords(clientX, clientY) {
      const rect = slide.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      return {x, y};
    }

    function startDrawing(e) {
      if (!drawing) return;
      if (e.button !== 0) return;
      const coords = toLocalCoords(e.clientX, e.clientY);
      startX = Math.max(0, Math.min(slide.clientWidth, coords.x));
      startY = Math.max(0, Math.min(slide.clientHeight, coords.y));
      selRect = document.createElement('div');
      selRect.className = 'textarea-selection';
      selRect.style.left = startX + 'px';
      selRect.style.top = startY + 'px';
      selRect.style.width = '0px';
      selRect.style.height = '0px';
      slide.appendChild(selRect);
      document.addEventListener('mousemove', onMouseMoveDuringDraw);
      document.addEventListener('mouseup', onMouseUpAfterDraw);
    }

    function onMouseMoveDuringDraw(e) {
      if (!selRect) return;
      const coords = toLocalCoords(e.clientX, e.clientY);
      let curX = Math.max(0, Math.min(slide.clientWidth, coords.x));
      let curY = Math.max(0, Math.min(slide.clientHeight, coords.y));
      const left = Math.min(startX, curX);
      const top = Math.min(startY, curY);
      const w = Math.max(2, Math.abs(curX - startX));
      const h = Math.max(2, Math.abs(curY - startY));
      selRect.style.left = left + 'px';
      selRect.style.top = top + 'px';
      selRect.style.width = w + 'px';
      selRect.style.height = h + 'px';
    }

    function onMouseUpAfterDraw(e) {
      document.removeEventListener('mousemove', onMouseMoveDuringDraw);
      document.removeEventListener('mouseup', onMouseUpAfterDraw);
      if (!selRect) return;
      const rect = selRect.getBoundingClientRect();
      const slideRect = slide.getBoundingClientRect();
      const left = rect.left - slideRect.left;
      const top = rect.top - slideRect.top;
      const width = rect.width;
      const height = rect.height;
      selRect.remove();
      selRect = null;
      if (width < 8 || height < 8) {
        drawing = false;
        drawBtn.classList.remove('active');
        slide.style.cursor = '';
        return;
      }
      const container = document.createElement('div');
      container.className = 'text-input-container';
      container.style.left = left + 'px';
      container.style.top = top + 'px';
      container.style.width = width + 'px';
      container.style.height = height + 'px';
      const ta = document.createElement('textarea');
      ta.className = 'text-input';
      ta.placeholder = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›';
      ta.spellcheck = false;
      container.appendChild(ta);
      addDragHandleIfMissing(container);
      makeDraggable(container);
      slide.appendChild(container);
      saveHistory();
      drawing = false;
      drawBtn.classList.remove('active');
      slide.style.cursor = '';
    }

    drawBtn.addEventListener('click', function(){
      drawing = !drawing;
      drawBtn.classList.toggle('active', drawing);
      slide.style.cursor = drawing ? 'crosshair' : '';
    });

    slide.addEventListener('mousedown', function(e){
      startDrawing(e);
    });

    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && drawing) {
        if (selRect) { selRect.remove(); selRect = null; }
        drawing = false;
        drawBtn.classList.remove('active');
        slide.style.cursor = '';
      }
    });

    window.addEventListener('resize', function(){
      if (selRect) { selRect.remove(); selRect = null; }
    });

  })();
</script>
<!-- ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹è‰²å¤‰æ›´æ©Ÿèƒ½ -->
<script>
  (function(){
    // ã™ã¹ã¦ã®ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã«å³ã‚¯ãƒªãƒƒã‚¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ 
    document.addEventListener('contextmenu', function(e) {
      // ãƒœã‚¿ãƒ³è¦ç´  (.draggable-btn)
      const button = e.target.closest('.draggable-btn');
      if (button) {
        console.log('ğŸ–±ï¸ Button right-clicked:', button);
        e.preventDefault();
        showButtonAlgorithmMenu(e, button);
        return;
      }
      
      // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹
      const textInput = e.target.closest('.text-input-container');
      if (textInput) {
        e.preventDefault();
        showColorMenu(e, textInput, 'textbox');
        return;
      }
      
      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆinput-containerï¼‰
      const inputContainer = e.target.closest('.input-container');
      if (inputContainer) {
        e.preventDefault();
        showColorMenu(e, inputContainer, 'input');
        return;
      }
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
      const checkboxGroup = e.target.closest('.checkbox-group');
      if (checkboxGroup) {
        e.preventDefault();
        showColorMenu(e, checkboxGroup, 'checkbox');
        return;
      }
      
      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
      const radioGroup = e.target.closest('.radio-group');
      if (radioGroup) {
        e.preventDefault();
        showColorMenu(e, radioGroup, 'radio');
        return;
      }
    });
    
    function showColorMenu(e, element, type) {
      // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
      const existingMenu = document.querySelector('.text-color-menu');
      if (existingMenu) existingMenu.remove();
      
      const menu = document.createElement('div');
      menu.className = 'text-color-menu';
      menu.style.position = 'fixed';
      menu.style.left = e.clientX + 'px';
      menu.style.top = e.clientY + 'px';
      menu.style.background = '#fff';
      menu.style.border = '1px solid #ddd';
      menu.style.borderRadius = '6px';
      menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      menu.style.padding = '12px';
      menu.style.zIndex = '10000';
      menu.style.minWidth = '220px';
      
      // ç¾åœ¨ã®è‰²ã‚’å–å¾—
      let currentBgColor = '#ffffff';
      let currentTextColor = '#000000';
      let currentBorderColor = '#dddddd';
      
      if (type === 'textbox') {
        currentBgColor = element.style.backgroundColor || '#ffffff';
        const textarea = element.querySelector('.text-input');
        if (textarea) {
          currentTextColor = rgbToHex(window.getComputedStyle(textarea).color);
        }
        currentBorderColor = element.style.borderColor || '#dddddd';
      } else if (type === 'input') {
        currentBgColor = element.style.backgroundColor || '#ffffff';
        const label = element.querySelector('.input-label');
        const input = element.querySelector('.input-box');
        if (label) {
          currentTextColor = rgbToHex(window.getComputedStyle(label).color);
        }
        currentBorderColor = element.style.borderColor || '#dddddd';
      } else if (type === 'checkbox' || type === 'radio') {
        currentBgColor = element.style.backgroundColor || 'transparent';
        const labels = element.querySelectorAll(type === 'checkbox' ? '.checkbox-label' : '.radio-label');
        if (labels.length > 0) {
          currentTextColor = rgbToHex(window.getComputedStyle(labels[0]).color);
        }
        currentBorderColor = element.style.borderColor || 'transparent';
      }
      
      menu.innerHTML = `
        <div style="padding: 4px 0 8px 0; font-weight: 600; border-bottom: 1px solid #eee; margin-bottom: 12px;">è‰²ã®è¨­å®š</div>
        <div style="padding: 4px 0;">
          <label style="display: block; margin-bottom: 6px; font-size: 13px;">èƒŒæ™¯è‰²</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="color" id="elementBgColor" value="${currentBgColor}" style="width: 60px; height: 32px; cursor: pointer; border: 1px solid #ddd; border-radius: 4px;" />
            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;">
              <input type="checkbox" id="bgTransparent" ${currentBgColor === 'transparent' ? 'checked' : ''} /> é€æ˜
            </label>
          </div>
        </div>
        <div style="padding: 4px 0; margin-top: 12px;">
          <label style="display: block; margin-bottom: 6px; font-size: 13px;">æ–‡å­—è‰²</label>
          <input type="color" id="elementTextColor" value="${currentTextColor}" style="width: 100%; height: 32px; cursor: pointer; border: 1px solid #ddd; border-radius: 4px;" />
        </div>
        <div style="padding: 4px 0; margin-top: 12px;">
          <label style="display: block; margin-bottom: 6px; font-size: 13px;">æ ç·šè‰²</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input type="color" id="elementBorderColor" value="${currentBorderColor}" style="width: 60px; height: 32px; cursor: pointer; border: 1px solid #ddd; border-radius: 4px;" />
            <label style="display: flex; align-items: center; gap: 4px; font-size: 13px;">
              <input type="checkbox" id="borderTransparent" ${currentBorderColor === 'transparent' ? 'checked' : ''} /> é€æ˜
            </label>
          </div>
        </div>
        <div style="margin-top: 16px; display: flex; gap: 8px; justify-content: flex-end;">
          <button id="colorMenuCancel" style="padding: 6px 14px; border: 1px solid #ddd; border-radius: 4px; background: #fff; cursor: pointer; font-size: 13px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="colorMenuApply" style="padding: 6px 14px; border: none; border-radius: 4px; background: #1976d2; color: white; cursor: pointer; font-size: 13px;">é©ç”¨</button>
        </div>
      `;
      
      document.body.appendChild(menu);
      
      // é€æ˜ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†
      const bgColorInput = document.getElementById('elementBgColor');
      const bgTransparent = document.getElementById('bgTransparent');
      const borderColorInput = document.getElementById('elementBorderColor');
      const borderTransparent = document.getElementById('borderTransparent');
      
      if (bgTransparent) {
        bgTransparent.addEventListener('change', function() {
          bgColorInput.disabled = this.checked;
        });
        bgColorInput.disabled = bgTransparent.checked;
      }
      
      if (borderTransparent) {
        borderTransparent.addEventListener('change', function() {
          borderColorInput.disabled = this.checked;
        });
        borderColorInput.disabled = borderTransparent.checked;
      }
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      document.getElementById('colorMenuCancel').addEventListener('click', function() {
        menu.remove();
      });
      
      // é©ç”¨ãƒœã‚¿ãƒ³
      document.getElementById('colorMenuApply').addEventListener('click', function() {
        const bgColor = bgTransparent.checked ? 'transparent' : bgColorInput.value;
        const textColor = document.getElementById('elementTextColor').value;
        const borderColor = borderTransparent.checked ? 'transparent' : borderColorInput.value;
        
        applyColors(element, type, bgColor, textColor, borderColor);
        
        if (typeof saveHistory === 'function') saveHistory();
        menu.remove();
      });
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      setTimeout(() => {
        document.addEventListener('click', function closeMenu(e) {
          if (!menu.contains(e.target)) {
            menu.remove();
            document.removeEventListener('click', closeMenu);
          }
        });
      }, 10);
    }
    
    function applyColors(element, type, bgColor, textColor, borderColor) {
      element.style.backgroundColor = bgColor;
      element.style.borderColor = borderColor;
      
      if (type === 'textbox') {
        const textarea = element.querySelector('.text-input');
        if (textarea) {
          textarea.style.color = textColor;
          textarea.style.backgroundColor = bgColor;
        }
      } else if (type === 'input') {
        const label = element.querySelector('.input-label');
        const input = element.querySelector('.input-box');
        if (label) {
          label.style.color = textColor;
        }
        if (input) {
          input.style.color = textColor;
          input.style.backgroundColor = bgColor;
          input.style.borderColor = borderColor;
        }
      } else if (type === 'checkbox') {
        const labels = element.querySelectorAll('.checkbox-label');
        const groupLabel = element.querySelector('.checkbox-group-label');
        labels.forEach(label => {
          label.style.color = textColor;
        });
        if (groupLabel) {
          groupLabel.style.color = textColor;
        }
      } else if (type === 'radio') {
        const labels = element.querySelectorAll('.radio-label');
        const groupLabel = element.querySelector('.radio-group-label');
        labels.forEach(label => {
          label.style.color = textColor;
        });
        if (groupLabel) {
          groupLabel.style.color = textColor;
        }
      }
    }
    
    function rgbToHex(rgb) {
      if (!rgb || rgb === 'transparent') return '#000000';
      const match = rgb.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (match) {
        const r = parseInt(match[1]).toString(16).padStart(2, '0');
        const g = parseInt(match[2]).toString(16).padStart(2, '0');
        const b = parseInt(match[3]).toString(16).padStart(2, '0');
        return '#' + r + g + b;
      }
      // ã™ã§ã«hexå½¢å¼ã®å ´åˆ
      if (rgb.startsWith('#')) return rgb;
      return '#000000';
    }
  })();
</script>
<!-- ç”»åƒæŒ¿å…¥æ©Ÿèƒ½ -->
<script>
  (function(){
    const addImageBtn = document.getElementById('addImageBtn');
    if (!addImageBtn) return;

    addImageBtn.addEventListener('click', function() {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”¨ã®inputã‚’ä½œæˆ
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = 'image/*';
      fileInput.style.display = 'none';
      
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ5MBä»¥ä¸‹ï¼‰
        if (file.size > 5 * 1024 * 1024) {
          alert('ç”»åƒã‚µã‚¤ã‚ºã¯5MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
          return;
        }
        
        // ç”»åƒã‚’èª­ã¿è¾¼ã‚€
        const reader = new FileReader();
        reader.onload = function(event) {
          createImageElement(event.target.result);
        };
        reader.readAsDataURL(file);
      });
      
      fileInput.click();
    });

    function createImageElement(imageSrc) {
      const slide = document.getElementById('slideArea');
      if (!slide) return;

      const container = document.createElement('div');
      container.className = 'image-element';
      container.setAttribute('data-image-src', imageSrc);
      
      const img = document.createElement('img');
      img.src = imageSrc;
      img.style.pointerEvents = 'none'; // ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã«ç”»åƒãŒãƒ‰ãƒ©ãƒƒã‚°ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹
      
      // ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ã‚µã‚¤ã‚ºã‚’è¨­å®š
      img.onload = function() {
        const maxWidth = 300;
        const maxHeight = 300;
        let width = img.naturalWidth;
        let height = img.naturalHeight;
        
        // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿ã¡ãªãŒã‚‰æœ€å¤§ã‚µã‚¤ã‚ºã«åã‚ã‚‹
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = width * ratio;
          height = height * ratio;
        }
        
        container.style.width = width + 'px';
        container.style.height = height + 'px';
        
        const pos = getRandomPosition(width, height);
        container.style.left = pos.x + 'px';
        container.style.top = pos.y + 'px';
      };
      
      container.appendChild(img);
      
      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
      container.addEventListener('dblclick', function(e) {
        e.stopPropagation();
        openImageSettings(container);
      });
      
      // å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
      container.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        openImageSettings(container);
      });
      
      addDragHandleIfMissing(container);
      makeDraggable(container);
      slide.appendChild(container);
      
      // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã‚’è¿½åŠ 
      if (typeof attachResizeHandlers === 'function') {
        attachResizeHandlers(container, 'image');
      }
      
      saveHistory();
    }

    // ç”»åƒè¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
    window.openImageSettings = function openImageSettings(imageElement) {
      // æ—¢å­˜ã®ãƒ‘ãƒãƒ«ãŒã‚ã‚Œã°å‰Šé™¤
      const existingPanel = document.querySelector('.image-settings-panel');
      if (existingPanel) existingPanel.remove();

      const panel = document.createElement('div');
      panel.className = 'image-settings-panel show';

      const currentWidth = parseInt(imageElement.style.width) || 100;
      const currentHeight = parseInt(imageElement.style.height) || 100;

      panel.innerHTML = `
        <div style="padding-bottom: 8px; border-bottom: 1px solid #eee; margin-bottom: 12px; font-weight: 600;">ç”»åƒè¨­å®š</div>
        <div class="setting-row">
          <label>å¹… (px)</label>
          <input type="number" id="imageWidth" value="${currentWidth}" min="20" max="800" />
        </div>
        <div class="setting-row">
          <label>é«˜ã• (px)</label>
          <input type="number" id="imageHeight" value="${currentHeight}" min="20" max="800" />
        </div>
        <div class="setting-row">
          <label style="display: inline; font-weight: normal;">
            <input type="checkbox" id="imageKeepRatio" checked /> ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒ
          </label>
        </div>
        <div class="panel-actions">
          <button id="imageCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button id="imageDeleteBtn" style="background: #ef4444; color: white; border-color: #ef4444;">å‰Šé™¤</button>
          <button id="imageApplyBtn" class="primary">é©ç”¨</button>
        </div>
      `;

      document.body.appendChild(panel);

      // ãƒ‘ãƒãƒ«ã‚’ç”»åƒã®è¿‘ãã«é…ç½®
      const rect = imageElement.getBoundingClientRect();
      panel.style.left = (rect.right + 10) + 'px';
      panel.style.top = rect.top + 'px';

      const widthInput = document.getElementById('imageWidth');
      const heightInput = document.getElementById('imageHeight');
      const keepRatioCheckbox = document.getElementById('imageKeepRatio');
      
      const img = imageElement.querySelector('img');
      const aspectRatio = currentWidth / currentHeight;

      // å¹…å¤‰æ›´æ™‚
      widthInput.addEventListener('input', function() {
        if (keepRatioCheckbox.checked) {
          const newHeight = Math.round(parseInt(this.value) / aspectRatio);
          heightInput.value = newHeight;
        }
      });

      // é«˜ã•å¤‰æ›´æ™‚
      heightInput.addEventListener('input', function() {
        if (keepRatioCheckbox.checked) {
          const newWidth = Math.round(parseInt(this.value) * aspectRatio);
          widthInput.value = newWidth;
        }
      });

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
      document.getElementById('imageCancelBtn').addEventListener('click', function() {
        panel.remove();
      });

      // å‰Šé™¤ãƒœã‚¿ãƒ³
      document.getElementById('imageDeleteBtn').addEventListener('click', async function() {
        const confirmed = await customConfirm('ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', {
          title: 'ç”»åƒã®å‰Šé™¤',
          confirmText: 'å‰Šé™¤ã™ã‚‹',
          cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
          danger: true
        });
        
        if (confirmed) {
          imageElement.remove();
          if (typeof saveHistory === 'function') saveHistory();
          panel.remove();
        }
      });

      // é©ç”¨ãƒœã‚¿ãƒ³
      document.getElementById('imageApplyBtn').addEventListener('click', function() {
        const newWidth = parseInt(widthInput.value);
        const newHeight = parseInt(heightInput.value);

        imageElement.style.width = newWidth + 'px';
        imageElement.style.height = newHeight + 'px';

        if (typeof saveHistory === 'function') saveHistory();
        panel.remove();
      });

      // ãƒ‘ãƒãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
      setTimeout(() => {
        document.addEventListener('click', function closePanel(e) {
          if (!panel.contains(e.target) && !imageElement.contains(e.target)) {
            panel.remove();
            document.removeEventListener('click', closePanel);
          }
        });
      }, 10);
    };
  })();
</script>
<!-- ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ -->
<script>
  // å›³å½¢ã¨ç”»åƒã®ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
  window.attachResizeHandlers = function attachResizeHandlers(element, elementType) {
    const resizeZone = 8; // ãƒªã‚µã‚¤ã‚ºå¯èƒ½ãªç«¯ã‹ã‚‰ã®è·é›¢ï¼ˆãƒ”ã‚¯ã‚»ãƒ«ï¼‰
    
    let isResizing = false;
    let resizeDirection = null;
    let startX = 0;
    let startY = 0;
    let startWidth = 0;
    let startHeight = 0;
    let startLeft = 0;
    let startTop = 0;
    
    // ãƒã‚¦ã‚¹ãƒ ãƒ¼ãƒ–ã§ã‚«ãƒ¼ã‚½ãƒ«ã‚’å¤‰æ›´
    element.addEventListener('mousemove', function(e) {
      if (isResizing) return;
      
      const rect = element.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const onLeft = x <= resizeZone;
      const onRight = x >= rect.width - resizeZone;
      const onTop = y <= resizeZone;
      const onBottom = y >= rect.height - resizeZone;
      
      if ((onTop && onLeft) || (onBottom && onRight)) {
        element.style.cursor = 'nwse-resize';
      } else if ((onTop && onRight) || (onBottom && onLeft)) {
        element.style.cursor = 'nesw-resize';
      } else if (onLeft || onRight) {
        element.style.cursor = 'ew-resize';
      } else if (onTop || onBottom) {
        element.style.cursor = 'ns-resize';
      } else {
        element.style.cursor = 'move';
      }
    });
    
    element.addEventListener('mouseleave', function() {
      if (!isResizing) {
        element.style.cursor = 'move';
      }
    });
    
    // ãƒã‚¦ã‚¹ãƒ€ã‚¦ãƒ³ã§ãƒªã‚µã‚¤ã‚ºé–‹å§‹
    element.addEventListener('mousedown', function(e) {
      const rect = element.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      const onLeft = x <= resizeZone;
      const onRight = x >= rect.width - resizeZone;
      const onTop = y <= resizeZone;
      const onBottom = y >= rect.height - resizeZone;
      
      if (onLeft || onRight || onTop || onBottom) {
        e.stopPropagation();
        isResizing = true;
        
        // ãƒªã‚µã‚¤ã‚ºæ–¹å‘ã‚’æ±ºå®š
        if (onTop && onLeft) resizeDirection = 'nw';
        else if (onTop && onRight) resizeDirection = 'ne';
        else if (onBottom && onLeft) resizeDirection = 'sw';
        else if (onBottom && onRight) resizeDirection = 'se';
        else if (onLeft) resizeDirection = 'w';
        else if (onRight) resizeDirection = 'e';
        else if (onTop) resizeDirection = 'n';
        else if (onBottom) resizeDirection = 's';
        
        startX = e.clientX;
        startY = e.clientY;
        startWidth = parseFloat(element.style.width) || rect.width;
        startHeight = parseFloat(element.style.height) || rect.height;
        startLeft = parseFloat(element.style.left) || 0;
        startTop = parseFloat(element.style.top) || 0;
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
        
        document.body.style.userSelect = 'none';
      }
    });
    
    function onMouseMove(e) {
      if (!isResizing) return;
      
      const dx = e.clientX - startX;
      const dy = e.clientY - startY;
      
      let newWidth = startWidth;
      let newHeight = startHeight;
      let newLeft = startLeft;
      let newTop = startTop;
      
      // ä¸‰è§’å½¢ã®å ´åˆã®ç‰¹åˆ¥å‡¦ç†
      if (elementType === 'triangle') {
        if (resizeDirection.includes('e')) {
          newWidth = Math.max(20, startWidth + dx);
        } else if (resizeDirection.includes('w')) {
          newWidth = Math.max(20, startWidth - dx);
          newLeft = startLeft + dx;
        }
        
        if (resizeDirection.includes('s')) {
          newHeight = Math.max(20, startHeight + dy);
        } else if (resizeDirection.includes('n')) {
          newHeight = Math.max(20, startHeight - dy);
          newTop = startTop + dy;
        }
        
        // ä¸‰è§’å½¢ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’æ›´æ–°
        const halfWidth = newWidth / 2;
        element.style.borderLeftWidth = halfWidth + 'px';
        element.style.borderRightWidth = halfWidth + 'px';
        element.style.borderBottomWidth = newHeight + 'px';
        element.style.left = newLeft + 'px';
        element.style.top = newTop + 'px';
        return;
      }
      
      // å††ã®å ´åˆã¯ç¸¦æ¨ªæ¯”ã‚’ä¿ã¤
      if (elementType === 'circle') {
        if (resizeDirection.includes('e')) {
          newWidth = Math.max(20, startWidth + dx);
          newHeight = newWidth;
        } else if (resizeDirection.includes('w')) {
          newWidth = Math.max(20, startWidth - dx);
          newHeight = newWidth;
          newLeft = startLeft + dx;
          newTop = startTop + dx;
        } else if (resizeDirection.includes('s')) {
          newHeight = Math.max(20, startHeight + dy);
          newWidth = newHeight;
        } else if (resizeDirection.includes('n')) {
          newHeight = Math.max(20, startHeight - dy);
          newWidth = newHeight;
          newTop = startTop + dy;
          newLeft = startLeft + dy;
        }
      } else {
        // ãã®ä»–ã®å›³å½¢ã¨ç”»åƒ
        if (resizeDirection.includes('e')) {
          newWidth = Math.max(20, startWidth + dx);
        } else if (resizeDirection.includes('w')) {
          newWidth = Math.max(20, startWidth - dx);
          newLeft = startLeft + dx;
        }
        
        if (resizeDirection.includes('s')) {
          newHeight = Math.max(20, startHeight + dy);
        } else if (resizeDirection.includes('n')) {
          newHeight = Math.max(20, startHeight - dy);
          newTop = startTop + dy;
        }
      }
      
      element.style.width = newWidth + 'px';
      element.style.height = newHeight + 'px';
      element.style.left = newLeft + 'px';
      element.style.top = newTop + 'px';
    }
    
    function onMouseUp() {
      if (isResizing) {
        isResizing = false;
        resizeDirection = null;
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        document.body.style.userSelect = '';
        
        if (typeof saveHistory === 'function') {
          saveHistory();
        }
      }
    }
  };
</script>

<!-- ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ -->
<script>
  // ãƒœã‚¿ãƒ³ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºé–¢æ•°
  window.showButtonAlgorithmMenu = function(e, button) {
    console.log('ğŸ¯ showButtonAlgorithmMenu called', {
      pageX: e.pageX,
      pageY: e.pageY,
      button: button,
      hasAlgorithm: button.hasAttribute('data-algorithm-id')
    });
    
    // æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Œã°å‰Šé™¤
    const existingMenu = document.querySelector('.button-algorithm-menu');
    if (existingMenu) {
      console.log('ğŸ—‘ï¸ Removing existing menu');
      existingMenu.remove();
    }
    
    const menu = document.createElement('div');
    menu.className = 'button-algorithm-menu';
    
    // ä»®ã®ä½ç½®è¨­å®šï¼ˆã‚µã‚¤ã‚ºè¨ˆç®—ã®ãŸã‚ï¼‰
    menu.style.left = '0px';
    menu.style.top = '0px';
    menu.style.visibility = 'hidden';
    
    const hasAlgorithm = button.hasAttribute('data-algorithm-id');
    const algorithmIcon = hasAlgorithm ? '<i class="fas fa-check-circle" style="color: #4CAF50; margin-right: 6px;"></i>' : '<i class="fas fa-circle" style="color: #ccc; margin-right: 6px;"></i>';
    
    console.log('ğŸ“‹ Creating menu HTML');
    
    menu.innerHTML = `
      <div class="menu-header">
        ${algorithmIcon}
        <span>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¨­å®š</span>
      </div>
      <button class="algo-menu-item" data-action="create-new">
        <i class="fas fa-plus"></i>
        <span>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’æ–°è¦ä½œæˆ</span>
      </button>
      <button class="algo-menu-item" data-action="select-existing">
        <i class="fas fa-list"></i>
        <span>æ—¢å­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é¸æŠ</span>
      </button>
      ${hasAlgorithm ? `
        <div class="menu-divider"></div>
        <button class="algo-menu-item" data-action="edit">
          <i class="fas fa-edit"></i>
          <span>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ç·¨é›†</span>
        </button>
        <button class="algo-menu-item danger" data-action="delete">
          <i class="fas fa-trash-alt"></i>
          <span>ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å‰Šé™¤</span>
        </button>
      ` : ''}
    `;
    
    // ä¸€æ—¦DOMã«è¿½åŠ ã—ã¦ã‚µã‚¤ã‚ºã‚’å–å¾—
    document.body.appendChild(menu);
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã¯ CSS ã§è‡ªå‹•çš„ã«ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã•ã‚Œã‚‹
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
    const menuWidth = menu.offsetWidth;
    const menuHeight = menu.offsetHeight;
    
    // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã®ã‚µã‚¤ã‚ºã‚’å–å¾—
    const viewportWidth = window.innerWidth;
    const viewportHeight = window.innerHeight;
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä½ç½®ã‚’è¨ˆç®—ï¼ˆç”»é¢å†…ã«åã‚ã‚‹ï¼‰
    let menuLeft = e.pageX;
    let menuTop = e.pageY;
    
    // å³ç«¯ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆã¯å·¦ã«è¡¨ç¤º
    if (menuLeft + menuWidth > viewportWidth) {
      menuLeft = viewportWidth - menuWidth - 10;
    }
    
    // ä¸‹ç«¯ã‹ã‚‰ã¯ã¿å‡ºã‚‹å ´åˆã¯ä¸Šã«è¡¨ç¤º
    if (menuTop + menuHeight > viewportHeight) {
      menuTop = viewportHeight - menuHeight - 10;
    }
    
    // å·¦ç«¯ãƒ»ä¸Šç«¯ã‚ˆã‚Šå¤–ã«å‡ºãªã„ã‚ˆã†ã«ã™ã‚‹
    menuLeft = Math.max(10, menuLeft);
    menuTop = Math.max(10, menuTop);
    
    // å®Ÿéš›ã®ä½ç½®ã‚’è¨­å®š
    menu.style.position = 'fixed';
    menu.style.left = menuLeft + 'px';
    menu.style.top = menuTop + 'px';
    menu.style.visibility = 'visible';
    
    console.log('âœ… Algorithm menu displayed at', {left: menuLeft, top: menuTop});
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å…¨ä½“ã§ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œå‡ºï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    menu.addEventListener('click', async function(e) {
      console.log('ğŸ–±ï¸ Menu clicked, target:', e.target);
      
      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸè¦ç´ ãŒ .algo-menu-item ã¾ãŸã¯ ãã®å­è¦ç´ ã‹ç¢ºèª
      const menuItem = e.target.closest('.algo-menu-item');
      
      if (!menuItem) {
        console.log('âš ï¸ Not a menu item, ignoring');
        return;
      }
      
      const action = menuItem.getAttribute('data-action');
      console.log('âœ… Menu item detected:', action);
      
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å…ˆã«å‰Šé™¤
      menu.remove();
      
      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      if (action === 'create-new') {
        console.log('â¡ï¸ Calling handleCreateNewAlgorithm');
        await window.handleCreateNewAlgorithm(button);
      } else if (action === 'select-existing') {
        console.log('â¡ï¸ Calling handleSelectExistingAlgorithm');
        await window.handleSelectExistingAlgorithm(button);
      } else if (action === 'edit') {
        console.log('â¡ï¸ Calling handleEditAlgorithm');
        await window.handleEditAlgorithm(button);
      } else if (action === 'delete') {
        console.log('â¡ï¸ Calling handleDeleteAlgorithm');
        window.handleDeleteAlgorithm(button);
      }
    }, true);
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    setTimeout(() => {
      document.addEventListener('click', function closeMenu(e) {
        if (!menu.contains(e.target)) {
          menu.remove();
          document.removeEventListener('click', closeMenu);
        }
      });
    }, 100);
  };
  
  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰system_idã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  window.getSystemIdFromUrl = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const systemId = urlParams.get('id');  // /accounts/system/?id=xxx å½¢å¼
    console.log('ğŸ” getSystemIdFromUrl:', systemId, 'URL:', window.location.href);
    return systemId;
  };
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ æ–°è¦ä½œæˆ
  window.handleCreateNewAlgorithm = async function(button) {
    console.log('ğŸš€ handleCreateNewAlgorithm called');
    let systemId = getSystemIdFromUrl();
    console.log('ğŸ“Œ System ID:', systemId);
    
    if (!systemId) {
      // ã‚·ã‚¹ãƒ†ãƒ ãŒæœªä¿å­˜ã®å ´åˆã€è‡ªå‹•çš„ã«ä»®ä¿å­˜ï¼ˆAjaxã§ç›´æ¥ä¿å­˜ï¼‰
      console.log('ğŸ’¾ ã‚·ã‚¹ãƒ†ãƒ ãŒæœªä¿å­˜ã®ãŸã‚ã€è‡ªå‹•ä¿å­˜ã‚’å®Ÿè¡Œ');
      
      // collectCurrentElementsé–¢æ•°ã§ç¾åœ¨ã®è¦ç´ ã‚’åé›†
      if (typeof collectCurrentElements !== 'function') {
        alert('ä¿å­˜æ©Ÿèƒ½ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      const elementsData = collectCurrentElements();
      console.log('ğŸ“¦ åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿:', elementsData);
      
      // ã‚·ã‚¹ãƒ†ãƒ åã¨è©³ç´°ã‚’ç”Ÿæˆ
      const systemName = existingSystemData.systemName || 'ä»®ä¿å­˜_' + new Date().toLocaleString('ja-JP');
      const systemDetail = existingSystemData.systemDescription || 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ä½œæˆã®ãŸã‚è‡ªå‹•ä¿å­˜';
      
      // button_idã‚’ç”Ÿæˆ
      const buttonId = generateButtonId(button);
      
      // Ajaxã§ä¿å­˜
      try {
        const formData = new FormData();
        formData.append('system_name', systemName);
        formData.append('system_detail', systemDetail);
        formData.append('elements_data', JSON.stringify(elementsData));
        formData.append('created_at', new Date().toISOString().split('T')[0]);
        
        // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                         document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        
        console.log('ğŸ“¡ Ajaxã§ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿å­˜ã—ã¾ã™...');
        const response = await fetch('/accounts/system/create/', {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP ' + response.status + ')');
        }
        
        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ç¢ºèª
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json();
          if (data.success && data.system_id) {
            systemId = data.system_id;
            console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ID:', systemId);
          } else {
            throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        } else {
          // HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰ã®å ´åˆã€URLã‚’è§£æã—ã¦system_idã‚’å–å¾—
          const finalUrl = response.url;
          console.log('ğŸ”— Final URL:', finalUrl);
          
          // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆã®URLã‹ã‚‰system_idã‚’å–å¾—ã™ã‚‹ã‹ã€å†åº¦ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
          // ã¨ã‚Šã‚ãˆãšä¿å­˜ã¯æˆåŠŸã—ãŸã¨ã¿ãªã—ã¦ã€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ä½œæˆç”»é¢ã«é·ç§»
          // system_idãŒå¿…è¦ãªã®ã§ã€æœ€æ–°ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
          alert('ã‚·ã‚¹ãƒ†ãƒ ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒœã‚¿ãƒ³ã‚’å³ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
          location.reload();
          return;
        }
      } catch (error) {
        console.error('âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚·ã‚¹ãƒ†ãƒ ã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        return;
      }
    }
    
    // ä¿å­˜æ¸ˆã¿ã®ã‚·ã‚¹ãƒ†ãƒ ï¼ˆã¾ãŸã¯ä¿å­˜æˆåŠŸå¾Œï¼‰
    const buttonId = generateButtonId(button);
    console.log('ğŸ†” Button ID:', buttonId);
    const url = `/accounts/block/?system_id=${systemId}&button_id=${buttonId}&action=create`;
    console.log('ğŸ”— Navigating to:', url);
    window.location.href = url;
  };
  
  // æ—¢å­˜ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é¸æŠ
  window.handleSelectExistingAlgorithm = async function(button) {
    const algorithms = {{ algorithms_json|safe }} || [];
    if (algorithms.length === 0) {
      alert('é¸æŠã§ãã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    
    // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const selectedAlgorithm = await showAlgorithmSelectionModal(algorithms);
    if (selectedAlgorithm) {
      // ãƒœã‚¿ãƒ³ã«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é©ç”¨
      button.setAttribute('data-algorithm-id', selectedAlgorithm.algorithm_id);
      button.setAttribute('data-algorithm-xml', selectedAlgorithm.blockly_xml || '');
      
      // ã‚¢ã‚¤ã‚³ãƒ³è¿½åŠ ï¼ˆè¨­å®šæ¸ˆã¿è¡¨ç¤ºï¼‰
      addAlgorithmIndicator(button);
      
      saveHistory();
      
      alert(`ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€Œ${selectedAlgorithm.algorithm_name}ã€ã‚’è¨­å®šã—ã¾ã—ãŸã€‚`);
    }
  };
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ç·¨é›†
  window.handleEditAlgorithm = async function(button) {
    const algorithmId = button.getAttribute('data-algorithm-id');
    if (!algorithmId) return;
    
    const systemId = getSystemIdFromUrl();
    const buttonId = generateButtonId(button);
    
    window.location.href = `/accounts/block/?id=${algorithmId}&system_id=${systemId}&button_id=${buttonId}&action=edit`;
  };
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å‰Šé™¤
  window.handleDeleteAlgorithm = function(button) {
    if (confirm('ã“ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é–¢é€£ä»˜ã‘ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      button.removeAttribute('data-algorithm-id');
      button.removeAttribute('data-algorithm-xml');
      
      // ã‚¢ã‚¤ã‚³ãƒ³å‰Šé™¤
      removeAlgorithmIndicator(button);
      
      saveHistory();
      
      alert('ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®é–¢é€£ä»˜ã‘ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    }
  };
  
  // ãƒœã‚¿ãƒ³IDã‚’ç”Ÿæˆï¼ˆä¸€æ„ã®è­˜åˆ¥å­ï¼‰
  window.generateButtonId = function(button) {
    if (!button.hasAttribute('data-button-id')) {
      const buttonId = 'btn_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      button.setAttribute('data-button-id', buttonId);
    }
    return button.getAttribute('data-button-id');
  };
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¨­å®šæ¸ˆã¿ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¿½åŠ 
  window.addAlgorithmIndicator = function(button) {
    if (button.querySelector('.algorithm-indicator')) return;
    
    const indicator = document.createElement('span');
    indicator.className = 'algorithm-indicator';
    indicator.innerHTML = '<i class="fas fa-cog"></i>';
    indicator.title = 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¨­å®šæ¸ˆã¿';
    button.appendChild(indicator);
  };
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼å‰Šé™¤
  window.removeAlgorithmIndicator = function(button) {
    const indicator = button.querySelector('.algorithm-indicator');
    if (indicator) indicator.remove();
  };
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
  window.showAlgorithmSelectionModal = function(algorithms) {
    return new Promise((resolve) => {
      const overlay = document.createElement('div');
      overlay.className = 'custom-confirm-overlay';
      overlay.style.display = 'flex';
      
      const modal = document.createElement('div');
      modal.className = 'custom-confirm-box';
      modal.style.maxWidth = '600px';
      modal.style.maxHeight = '80vh';
      modal.style.overflow = 'hidden';
      modal.style.display = 'flex';
      modal.style.flexDirection = 'column';
      
      const title = document.createElement('div');
      title.className = 'custom-confirm-title';
      title.textContent = 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é¸æŠ';
      
      const listContainer = document.createElement('div');
      listContainer.style.flex = '1';
      listContainer.style.overflowY = 'auto';
      listContainer.style.padding = '10px 0';
      
      algorithms.forEach(algo => {
        const item = document.createElement('div');
        item.className = 'algorithm-list-item';
        item.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 4px;">${algo.algorithm_name}</div>
          <div style="font-size: 12px; color: #666;">
            ä½œæˆæ—¥: ${algo.created_at || 'ä¸æ˜'}
          </div>
        `;
        item.style.padding = '12px';
        item.style.margin = '8px 0';
        item.style.border = '1px solid #ddd';
        item.style.borderRadius = '8px';
        item.style.cursor = 'pointer';
        item.style.transition = 'all 0.2s';
        
        item.addEventListener('mouseenter', function() {
          this.style.background = '#f0f4f8';
          this.style.borderColor = '#3fbcd9';
        });
        
        item.addEventListener('mouseleave', function() {
          this.style.background = '#fff';
          this.style.borderColor = '#ddd';
        });
        
        item.addEventListener('click', function() {
          overlay.remove();
          resolve(algo);
        });
        
        listContainer.appendChild(item);
      });
      
      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'custom-confirm-buttons';
      buttonsDiv.style.marginTop = '20px';
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'custom-confirm-btn cancel';
      cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      cancelBtn.onclick = () => {
        overlay.remove();
        resolve(null);
      };
      
      buttonsDiv.appendChild(cancelBtn);
      
      modal.appendChild(title);
      modal.appendChild(listContainer);
      modal.appendChild(buttonsDiv);
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
    });
  }
</script>
