<script>
// ========================================
// å±¥æ­´ç®¡ç†ï¼ˆã‚¢ãƒ³ãƒ‰ã‚¥ãƒ»ãƒªãƒ‰ã‚¥ï¼‰
// ========================================
(function(){
  let history = [];
  let historyIndex = -1;

  window.saveHistory = function() {
    const slide = document.getElementById('slideArea');
    if (!slide) return;
    const snapshot = slide.innerHTML;
    history = history.slice(0, historyIndex + 1);
    history.push(snapshot);
    historyIndex = history.length - 1;
    updateUndoRedoButtons();
  };

  window.restoreHistory = function() {
    const slide = document.getElementById('slideArea');
    if (!slide || historyIndex < 0 || historyIndex >= history.length) return;
    slide.innerHTML = history[historyIndex];
    const inputContainers = slide.querySelectorAll('.input-container');
    inputContainers.forEach(container => makeDraggable(container));
    const draggableBtns = slide.querySelectorAll('.draggable-btn');
    draggableBtns.forEach(btn => makeDraggable(btn));
    const textInputContainers = slide.querySelectorAll('.text-input-container');
    textInputContainers.forEach(container => makeDraggable(container));
    const checkboxGroups = slide.querySelectorAll('.checkbox-group');
    checkboxGroups.forEach(g => makeDraggable(g));
    const radioGroups = slide.querySelectorAll('.radio-group');
    radioGroups.forEach(g => makeDraggable(g));
    const roulettes = slide.querySelectorAll('.roulette-container');
    roulettes.forEach(r => {
      makeDraggable(r);
      if (typeof attachRouletteListeners === 'function') {
        attachRouletteListeners(r);
      }
    });
    const timers = slide.querySelectorAll('.timer-container');
    timers.forEach(t => makeDraggable(t));
    const shapes = slide.querySelectorAll('.shape-element');
    shapes.forEach(s => {
      makeDraggable(s);
      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
      s.addEventListener('dblclick', function(e) {
        e.stopPropagation();
        if (typeof openShapeSettings === 'function') {
          openShapeSettings(s);
        }
      });
      // å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
      s.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (typeof openShapeSettings === 'function') {
          openShapeSettings(s);
        }
      });
      // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å†è¨­å®š
      const shapeType = s.getAttribute('data-shape-type');
      if (typeof attachResizeHandlers === 'function' && shapeType) {
        attachResizeHandlers(s, shapeType);
      }
      // çŸ¢å°ã®å ´åˆã¯ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å†é©ç”¨
      if (s.classList.contains('shape-arrow')) {
        const color = s.getAttribute('data-shape-color') || '#333';
        if (typeof updateArrowStyles === 'function') {
          updateArrowStyles(s, color);
        }
      }
    });
    const images = slide.querySelectorAll('.image-element');
    images.forEach(img => {
      makeDraggable(img);
      // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
      img.addEventListener('dblclick', function(e) {
        e.stopPropagation();
        if (typeof openImageSettings === 'function') {
          openImageSettings(img);
        }
      });
      // å³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†è¨­å®š
      img.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (typeof openImageSettings === 'function') {
          openImageSettings(img);
        }
      });
      // ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å†è¨­å®š
      if (typeof attachResizeHandlers === 'function') {
        attachResizeHandlers(img, 'image');
      }
    });
    updateUndoRedoButtons();
  };

  window.undo = function() {
    if (historyIndex > 0) {
      historyIndex--;
      restoreHistory();
    }
  };

  window.redo = function() {
    if (historyIndex < history.length - 1) {
      historyIndex++;
      restoreHistory();
    }
  };

  function updateUndoRedoButtons() {
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    if (undoBtn) undoBtn.disabled = historyIndex <= 0;
    if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
  }

  // åˆæœŸå±¥æ­´ã‚’ä¿å­˜
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      saveHistory();
    }, 100);
  });

  // ã‚¢ãƒ³ãƒ‰ã‚¥ãƒ»ãƒªãƒ‰ã‚¥ãƒœã‚¿ãƒ³
  const undoBtn = document.getElementById('undoBtn');
  if (undoBtn) {
    undoBtn.addEventListener('click', function(e){
      e.preventDefault();
      undo();
    });
  }

  const redoBtn = document.getElementById('redoBtn');
  if (redoBtn) {
    redoBtn.addEventListener('click', function(e){
      e.preventDefault();
      redo();
    });
  }

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
  document.addEventListener('keydown', function(e){
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
      if (e.shiftKey) {
        e.preventDefault();
        redo();
      } else {
        e.preventDefault();
        undo();
      }
    }
  });
})();

// ========================================
// ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¨isDirtyãƒªã‚»ãƒƒãƒˆ
// ========================================
(function(){
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', function(){
      try { isDirty = false; } catch(e){}
    });
  });
})();

// ========================================
// è‰²ã‚ªãƒ—ã‚·ãƒ§ãƒ³é…åˆ—
// ========================================
const colorOptions = [
  { name: "ã‚ãŠ", value: "#2196F3" },
  { name: "ã‚ã‹", value: "#F44336" },
  { name: "ã¿ã©ã‚Š", value: "#4CAF50" },
  { name: "ãã„ã‚", value: "#FFEB3B", textColor: "#333" },
  { name: "ã‚ªãƒ¬ãƒ³ã‚¸", value: "#FF9800" },
  { name: "ã‚€ã‚‰ã•ã", value: "#9C27B0" },
  { name: "ãã‚", value: "#333" },
  { name: "ã—ã‚", value: "#fff", textColor: "#333" }
];

// ========================================
// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆ¶å¾¡
// ========================================
(function(){
  const btn = document.getElementById('formBtn');
  const dropdown = document.getElementById('formDropdown');
  const wrap = document.getElementById('formDropdownWrap');
  const panel = document.getElementById('createOptionsPanel');

  function closeDropdown() {
    if (dropdown) { dropdown.classList.remove('show'); dropdown.setAttribute('aria-hidden','true'); }
    if (btn) { btn.setAttribute('aria-expanded','false'); }
  }
  function hideOptionsPanel() {
    if (panel) { panel.classList.remove('show'); panel.setAttribute('aria-hidden','true'); }
  }

  if (btn && dropdown) {
    btn.addEventListener('click', function(e){
      e.stopPropagation();
      const isOpen = dropdown.classList.contains('show');
      if (isOpen) { 
        closeDropdown(); 
      } else { 
        dropdown.classList.add('show'); 
        dropdown.setAttribute('aria-hidden','false'); 
        btn.setAttribute('aria-expanded','true');
      }
    });
  }

  document.addEventListener('click', function(e){
    if (!wrap || !wrap.contains(e.target)) {
      closeDropdown();
      hideOptionsPanel();
    }
  });

  document.addEventListener('keydown', function(e){
    if (e.key === 'Escape') {
      closeDropdown();
      hideOptionsPanel();
    }
  });
})();

// ========================================
// å…±é€šä½œæˆãƒ‘ãƒãƒ«åˆ¶å¾¡ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ / ãƒ©ã‚¸ã‚ªï¼‰
// ========================================
(function(){
  const addCheckboxBtn = document.getElementById('addCheckboxBtn');
  const addRadioBtn = document.getElementById('addRadioBtn');
  const panel = document.getElementById('createOptionsPanel');
  const countInput = document.getElementById('optionsCount');
  const cancelBtn = document.getElementById('createOptionsCancel');
  const confirmBtn = document.getElementById('createOptionsConfirm');
  const wrap = document.getElementById('formDropdownWrap');

  let pendingType = null;

  function showOptionsPanel(type) {
    pendingType = type;
    panel.classList.add('show');
    panel.setAttribute('aria-hidden','false');
    setTimeout(()=>{ countInput.focus(); countInput.select(); },10);
  }
  function hideOptionsPanel() {
    pendingType = null;
    panel.classList.remove('show');
    panel.setAttribute('aria-hidden','true');
  }

  if (addCheckboxBtn) {
    addCheckboxBtn.addEventListener('click', function(e){
      e.stopPropagation();
      if (panel.classList.contains('show') && pendingType === 'checkbox') hideOptionsPanel(); else showOptionsPanel('checkbox');
    });
  }
  if (addRadioBtn) {
    addRadioBtn.addEventListener('click', function(e){
      e.stopPropagation();
      if (panel.classList.contains('show') && pendingType === 'radio') hideOptionsPanel(); else showOptionsPanel('radio');
    });
  }
  if (cancelBtn) {
    cancelBtn.addEventListener('click', function(e){
      e.preventDefault();
      hideOptionsPanel();
    });
  }
  if (confirmBtn) {
    confirmBtn.addEventListener('click', async function(e){
      e.preventDefault();
      const labelInput = document.getElementById('optionsLabel');
      const label = labelInput ? labelInput.value.trim() : '';
      
      // ãƒ©ãƒ™ãƒ«ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
      if (!label) {
        await customAlert('ãƒ©ãƒ™ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', {
          title: 'ã‚¨ãƒ©ãƒ¼'
        });
        labelInput.focus();
        return;
      }
      
      const n = parseInt(countInput.value, 10) || 0;
      if (n <= 0) {
        await customAlert('é …ç›®æ•°ã¯1ä»¥ä¸Šã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚', {
          title: 'ã‚¨ãƒ©ãƒ¼'
        });
        return;
      }
      const capped = Math.min(n, 10);
      if (n > 10) {
        await customAlert('é …ç›®æ•°ã¯æœ€å¤§10ã¾ã§ã§ã™ã€‚10ã«è¨­å®šã—ã¾ã™ã€‚', {
          title: 'é€šçŸ¥'
        });
      }
      if (pendingType === 'checkbox') {
        createCheckboxGroup(capped, label);
      } else if (pendingType === 'radio') {
        createRadioGroup(capped, label);
      }
      if (labelInput) labelInput.value = '';
      hideOptionsPanel();
      const dropdown = document.getElementById('formDropdown');
      if (dropdown) { dropdown.classList.remove('show'); dropdown.setAttribute('aria-hidden','true'); }
    });
  }

  document.addEventListener('click', function(e){
    if (!wrap.contains(e.target)) hideOptionsPanel();
  });
})();

// ========================================
// ä¿å­˜ãƒœã‚¿ãƒ³
// ========================================
const saveBtn = document.getElementById('saveBtn');
console.log('ğŸ” ä¿å­˜ãƒœã‚¿ãƒ³è¦ç´ :', saveBtn);
console.log('ğŸ” collectCurrentElementsé–¢æ•°:', typeof collectCurrentElements);

if (saveBtn) {
  saveBtn.addEventListener('click', function(e){
    e.preventDefault();
    console.log('ğŸ’¾ ä¿å­˜ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    
    const slide = document.getElementById('slideArea');
    if (slide) {
      try {
        const elementsData = collectCurrentElements();
        console.log('ğŸ“¦ åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿:', elementsData);
        
        sessionStorage.setItem('systemDesignContent', JSON.stringify(elementsData));
        sessionStorage.setItem('navigatingToCreate', 'true');
        
        if (existingSystemData.systemId) {
          sessionStorage.setItem('systemId', existingSystemData.systemId);
        }
        if (existingSystemData.systemName) {
          sessionStorage.setItem('systemName', existingSystemData.systemName);
        }
        if (existingSystemData.systemDescription) {
          sessionStorage.setItem('systemDescription', existingSystemData.systemDescription);
        }
        
        console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        
        // ä¿å­˜ç”»é¢ã«é·ç§»ã™ã‚‹ãŸã‚ã€isDirtyã‚’falseã«ã—ã¦è­¦å‘Šã‚’é˜²ã
        try { isDirty = false; } catch(e){}
        
        window.location.href = '/accounts/system/create/';
      } catch(error) {
        console.error('âŒ ä¿å­˜å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    } else {
      console.error('âŒ slideAreaãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  });
} else {
  console.error('âŒ ä¿å­˜ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}

// ========================================
// å®Ÿè¡Œãƒœã‚¿ãƒ³
// ========================================
const executeBtn = document.getElementById('executeBtn');
if (executeBtn) {
  executeBtn.addEventListener('click', function(e){
    e.preventDefault();
    openPreview();
  });
}

// ========================================
// å…¨å‰Šé™¤ãƒœã‚¿ãƒ³
// ========================================
const clearAllBtn = document.getElementById('clearAllBtn');
if (clearAllBtn) {
  clearAllBtn.addEventListener('click', async function(e){
    e.preventDefault();
    const confirmed = await customConfirm('ã™ã¹ã¦ã®è¦ç´ ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚', {
      title: 'å…¨å‰Šé™¤ã®ç¢ºèª',
      confirmText: 'å‰Šé™¤ã™ã‚‹',
      cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      danger: true
    });
    
    if (confirmed) {
      const slide = document.getElementById('slideArea');
      if (slide) {
        const trash = slide.querySelector('#trash');
        const trashHTML = trash ? trash.outerHTML : '<div id="trash" title="ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã§å‰Šé™¤"><i class="fas fa-trash-alt"></i></div>';
        slide.innerHTML = trashHTML;
        saveHistory();
        console.log('ã™ã¹ã¦ã®è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    }
  });
}

// ========================================
// ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œæ©Ÿèƒ½
// ========================================
let selectedElement = null;

// è¦ç´ é¸æŠã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
function selectElement(element) {
  // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
  if (selectedElement && selectedElement !== element) {
    selectedElement.style.outline = '';
    selectedElement.style.outlineOffset = '';
  }
  
  selectedElement = element;
  
  // é¸æŠã•ã‚ŒãŸè¦ç´ ã«ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³è¡¨ç¤º
  if (selectedElement) {
    selectedElement.style.outline = '3px solid #3fbcd9';
    selectedElement.style.outlineOffset = '2px';
  }
}

// ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¨ãƒªã‚¢å†…ã®è¦ç´ ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
document.addEventListener('DOMContentLoaded', function() {
  const slideArea = document.getElementById('slideArea');
  if (slideArea) {
    slideArea.addEventListener('click', function(e) {
      const target = e.target;
      
      // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªè¦ç´ ã‹ãƒã‚§ãƒƒã‚¯
      const draggableElement = target.closest('.input-container, .text-input-container, .checkbox-group, .radio-group, .roulette-container, .timer-container, .draggable-btn, .shape-element, .draggable-image');
      
      if (draggableElement && draggableElement.id !== 'trash') {
        selectElement(draggableElement);
        e.stopPropagation();
      } else if (!target.closest('#trash')) {
        // ç©ºç™½ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é¸æŠè§£é™¤
        if (selectedElement) {
          selectedElement.style.outline = '';
          selectedElement.style.outlineOffset = '';
          selectedElement = null;
        }
      }
    });
  }
});

// ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œé–¢æ•°
function getAllDraggableElements() {
  const slideArea = document.getElementById('slideArea');
  if (!slideArea) return [];
  
  return Array.from(slideArea.querySelectorAll('.input-container, .text-input-container, .checkbox-group, .radio-group, .roulette-container, .timer-container, .draggable-btn, .shape-element, .draggable-image'))
    .filter(el => el.id !== 'trash');
}

function getElementZIndex(element) {
  const zIndex = element.style.zIndex || '1';
  return parseInt(zIndex);
}

function setElementZIndex(element, zIndex) {
  element.style.zIndex = zIndex.toString();
}

// æœ€å‰é¢ã¸
function bringToFront() {
  if (!selectedElement) {
    customAlert('è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„', { title: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ' });
    return;
  }
  
  const elements = getAllDraggableElements();
  const maxZ = Math.max(...elements.map(el => getElementZIndex(el)), 1);
  setElementZIndex(selectedElement, maxZ + 1);
  saveHistory();
}

// å‰é¢ã¸
function bringForward() {
  if (!selectedElement) {
    customAlert('è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„', { title: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ' });
    return;
  }
  
  const currentZ = getElementZIndex(selectedElement);
  setElementZIndex(selectedElement, currentZ + 1);
  saveHistory();
}

// èƒŒé¢ã¸
function sendBackward() {
  if (!selectedElement) {
    customAlert('è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„', { title: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ' });
    return;
  }
  
  const currentZ = getElementZIndex(selectedElement);
  if (currentZ > 1) {
    setElementZIndex(selectedElement, currentZ - 1);
    saveHistory();
  }
}

// æœ€èƒŒé¢ã¸
function sendToBack() {
  if (!selectedElement) {
    customAlert('è¦ç´ ã‚’é¸æŠã—ã¦ãã ã•ã„', { title: 'ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œ' });
    return;
  }
  
  const elements = getAllDraggableElements();
  const minZ = Math.min(...elements.map(el => getElementZIndex(el)), 1);
  setElementZIndex(selectedElement, Math.max(minZ - 1, 1));
  saveHistory();
}

// ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
const layerToFrontBtn = document.getElementById('layerToFrontBtn');
if (layerToFrontBtn) {
  layerToFrontBtn.addEventListener('click', bringToFront);
}

const layerForwardBtn = document.getElementById('layerForwardBtn');
if (layerForwardBtn) {
  layerForwardBtn.addEventListener('click', bringForward);
}

const layerBackwardBtn = document.getElementById('layerBackwardBtn');
if (layerBackwardBtn) {
  layerBackwardBtn.addEventListener('click', sendBackward);
}

const layerToBackBtn = document.getElementById('layerToBackBtn');
if (layerToBackBtn) {
  layerToBackBtn.addEventListener('click', sendToBack);
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¬é–‹
window.selectedElement = selectedElement;
window.selectElement = selectElement;
</script>

