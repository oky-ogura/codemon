<script>
// ========================================
// window.onload - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
// ========================================
window.onload = function() {
  const slide = document.getElementById('slideArea');
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æ—¢å­˜è¦ç´ ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’å¾©å…ƒ
  if (existingElementsData && existingElementsData.length > 0) {
    console.log('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ è¦ç´ ã‚’å¾©å…ƒã—ã¾ã™:', existingElementsData);
    restoreSystemElements(existingElementsData);
  } else {
    // ä¿å­˜ç”»é¢ã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆã®ã¿ã€sessionStorageã‹ã‚‰ä»¥å‰ã®ç·¨é›†å†…å®¹ã‚’å¾©å…ƒ
    const returnFromCreate = sessionStorage.getItem('returnFromCreate');
    const savedContent = sessionStorage.getItem('systemDesignContent');
    
    if (returnFromCreate === 'true' && savedContent && slide) {
      try {
        // JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è§£æã‚’è©¦ã¿ã‚‹
        const elementsData = JSON.parse(savedContent);
        console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆJSONå½¢å¼ï¼‰:', elementsData);
        restoreSystemElements(elementsData);
      } catch (e) {
        // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆã¯ã€å¾“æ¥ã®HTMLå½¢å¼ã¨ã—ã¦å‡¦ç†
        console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆHTMLå½¢å¼ï¼‰');
        const trash = slide.querySelector('#trash');
        const trashHTML = trash ? trash.outerHTML : '<div id="trash" title="ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã§å‰Šé™¤">ğŸ—‘ï¸</div>';
        slide.innerHTML = savedContent + trashHTML;
      }
    }
  }
  
  // å¾©å…ƒå¾Œã¯ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ¬¡å›ã®é€šå¸¸ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å¾©å…ƒã—ãªã„ã‚ˆã†ã«ï¼‰
  sessionStorage.removeItem('returnFromCreate');
  
  // navigatingToCreateãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢ï¼ˆä¿å­˜ç”»é¢ã«é·ç§»ã—ãŸå¾Œã¯ä¸è¦ï¼‰
  sessionStorage.removeItem('navigatingToCreate');
  
  // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªè¦ç´ ã«ãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ 
  Array.from(document.querySelectorAll('.input-container, .draggable-btn, .text-input_container, .text-input-container, .checkbox-group, .radio-group, .timer-container, .roulette-container')).forEach(el=>{
    addDragHandleIfMissing(el);
    makeDraggable(el);
  });
  
  // æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
  document.querySelectorAll('input[data-only-number="true"]').forEach(inp => {
    try { attachNumberFilter(inp); } catch(e){ console.error(e); }
  });
  
  // ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°å‡¦ç†ã‚’é–‹å§‹
  startTimerUpdates();
  
  saveHistory();
};

// ========================================
// ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°å‡¦ç†
// ========================================
function startTimerUpdates() {
  setInterval(function() {
    document.querySelectorAll('.timer-container').forEach(timer => {
      const running = timer.getAttribute('data-timer-running') === 'true';
      if (running) {
        const mode = timer.getAttribute('data-timer-mode') || 'up';
        let seconds = parseInt(timer.getAttribute('data-timer-seconds') || '0');
        
        if (mode === 'up') {
          seconds++;
          timer.setAttribute('data-timer-seconds', seconds.toString());
        } else {
          seconds--;
          if (seconds < 0) seconds = 0;
          timer.setAttribute('data-timer-seconds', seconds.toString());
          
          if (seconds === 0) {
            timer.setAttribute('data-timer-running', 'false');
            const startBtn = timer.querySelector('.timer-btn.pause');
            if (startBtn) {
              startBtn.textContent = "é–‹å§‹";
              startBtn.classList.remove('pause');
              startBtn.classList.add('start');
            }
          }
        }
        
        const display = timer.querySelector('.timer-display');
        if (display) {
          const h = Math.floor(seconds / 3600);
          const m = Math.floor((seconds % 3600) / 60);
          const s = seconds % 60;
          display.textContent = 
            String(h).padStart(2, '0') + ':' +
            String(m).padStart(2, '0') + ':' +
            String(s).padStart(2, '0');
        }
      }
    });
  }, 1000);
}

// ========================================
// JSONå½¢å¼ã®è¦ç´ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLè¦ç´ ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
// ========================================
function restoreSystemElements(elementsData) {
  const slide = document.getElementById('slideArea');
  if (!slide) return;
  
  elementsData.forEach(elem => {
    try {
      switch(elem.element_type) {
        case 'text_input':
          restoreTextInput(elem, false);
          break;
        case 'number_input':
          restoreTextInput(elem, true);
          break;
        case 'datetime_input':
          restoreDatetimeInput(elem);
          break;
        case 'checkbox_group':
          restoreCheckboxGroup(elem);
          break;
        case 'radio_group':
          restoreRadioGroup(elem);
          break;
        case 'button':
          restoreButton(elem);
          break;
        case 'text_box':
          restoreTextBox(elem);
          break;
        case 'roulette':
          restoreRoulette(elem);
          break;
        case 'timer':
          restoreTimer(elem);
          break;
      }
    } catch (error) {
      console.error('è¦ç´ ã®å¾©å…ƒã«å¤±æ•—:', elem, error);
    }
  });
}

function restoreTextInput(elem, onlyNumber) {
  const container = document.createElement("div");
  container.classList.add("input-container");

  const label = document.createElement("div");
  label.classList.add("input-label");
  label.textContent = elem.element_label || (onlyNumber ? "æ•°å­—ï¼š" : "æ–‡å­—ï¼š");
  label.contentEditable = "true";

  const placeholder = elem.element_config?.placeholder || (onlyNumber ? "æ•°å­—ã‚’å…¥åŠ›" : "æ–‡å­—ã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œå¯ï¼‰");
  const actualValue = elem.element_value || "";

  if (onlyNumber) {
    const input = document.createElement("input");
    input.type = "text";
    input.inputMode = "numeric";
    input.pattern = "\\d*";
    input.classList.add("input-box");
    input.placeholder = placeholder;
    input.value = actualValue;
    input.setAttribute('data-only-number', 'true');
    container.appendChild(label);
    container.appendChild(input);
    attachNumberFilter(input);
  } else {
    const textarea = document.createElement("textarea");
    textarea.classList.add("input-box");
    textarea.placeholder = placeholder;
    textarea.value = actualValue;
    container.appendChild(label);
    container.appendChild(textarea);
  }

  container.style.left = elem.position_x + "px";
  container.style.top = elem.position_y + "px";
  if (elem.width) container.style.width = elem.width + "px";
  if (elem.height) container.style.height = elem.height + "px";

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
}

function restoreDatetimeInput(elem) {
  const container = document.createElement("div");
  container.classList.add("input-container");

  const label = document.createElement("div");
  label.classList.add("input-label");
  label.textContent = elem.element_label || "æ—¥æ™‚ï¼š";
  label.contentEditable = "true";

  const input = document.createElement("input");
  input.type = "datetime-local";
  input.style.minWidth = "180px";
  input.style.minHeight = "36px";
  input.style.fontSize = "16px";
  input.style.padding = "4px 8px";
  input.style.boxSizing = "border-box";
  input.classList.add("input-box");
  input.value = elem.element_value || "";

  container.appendChild(label);
  container.appendChild(input);

  container.style.left = elem.position_x + "px";
  container.style.top = elem.position_y + "px";
  if (elem.width) container.style.width = elem.width + "px";
  if (elem.height) container.style.height = elem.height + "px";

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
}

function restoreCheckboxGroup(elem) {
  const group = document.createElement('div');
  group.className = 'checkbox-group';

  // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ 
  if (elem.element_label) {
    const labelDiv = document.createElement('div');
    labelDiv.className = 'checkbox-group-label';
    labelDiv.contentEditable = 'true';
    labelDiv.textContent = elem.element_label;
    labelDiv.style.fontWeight = 'bold';
    labelDiv.style.marginBottom = '4px';
    labelDiv.style.cursor = 'text';
    group.appendChild(labelDiv);
  }

  const options = elem.element_config?.options || [];
  options.forEach((optText, i) => {
    const row = document.createElement('div');
    row.className = 'checkbox-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.tabIndex = 0;

    const lbl = document.createElement('div');
    lbl.className = 'checkbox-label';
    lbl.contentEditable = 'true';
    lbl.textContent = optText || ('é …ç›® ' + (i + 1));

    row.appendChild(cb);
    row.appendChild(lbl);
    group.appendChild(row);
  });

  group.style.left = elem.position_x + 'px';
  group.style.top = elem.position_y + 'px';
  if (elem.width) group.style.width = elem.width + 'px';
  if (elem.height) group.style.height = elem.height + 'px';

  addDragHandleIfMissing(group);
  makeDraggable(group);
  document.getElementById('slideArea').appendChild(group);
}

function restoreRadioGroup(elem) {
  const group = document.createElement('div');
  group.className = 'radio-group';

  // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ 
  if (elem.element_label) {
    const labelDiv = document.createElement('div');
    labelDiv.className = 'radio-group-label';
    labelDiv.contentEditable = 'true';
    labelDiv.textContent = elem.element_label;
    labelDiv.style.fontWeight = 'bold';
    labelDiv.style.marginBottom = '4px';
    labelDiv.style.cursor = 'text';
    group.appendChild(labelDiv);
  }

  const uniqueName = 'radio_group_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  const options = elem.element_config?.options || [];
  options.forEach((optText, i) => {
    const row = document.createElement('div');
    row.className = 'radio-row';

    const rb = document.createElement('input');
    rb.type = 'radio';
    rb.name = uniqueName;
    rb.tabIndex = 0;

    const lbl = document.createElement('div');
    lbl.className = 'radio-label';
    lbl.contentEditable = 'true';
    lbl.textContent = optText || ('é …ç›® ' + (i + 1));

    row.appendChild(rb);
    row.appendChild(lbl);
    group.appendChild(row);
  });

  group.style.left = elem.position_x + 'px';
  group.style.top = elem.position_y + 'px';
  if (elem.width) group.style.width = elem.width + 'px';
  if (elem.height) group.style.height = elem.height + 'px';

  addDragHandleIfMissing(group);
  makeDraggable(group);
  document.getElementById('slideArea').appendChild(group);
}

function restoreButton(elem) {
  const btn = document.createElement("button");
  btn.classList.add("draggable-btn");
  btn.textContent = elem.element_label || "ãƒœã‚¿ãƒ³";

  if (elem.width) btn.style.width = elem.width + "px";
  if (elem.height) btn.style.height = elem.height + "px";
  
  if (elem.style_data?.background) btn.style.background = elem.style_data.background;
  if (elem.style_data?.color) btn.style.color = elem.style_data.color;

  const targetSystemId = elem.element_config?.target_system_id;
  const algorithmId = elem.element_config?.algorithm_id;
  const algorithmXml = elem.element_config?.algorithm_xml;
  
  if (targetSystemId) {
    btn.setAttribute('data-target-system', targetSystemId);
  }
  if (algorithmId) {
    btn.setAttribute('data-algorithm-id', algorithmId);
  }
  if (algorithmXml) {
    btn.setAttribute('data-algorithm-xml', algorithmXml);
  }

  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    const isPreview = btn.closest('#previewSlideArea');
    
    if (isPreview) {
      if (algorithmId && algorithmXml) {
        // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ
        executeAlgorithmFromButton(algorithmXml, btn.textContent);
      } else if (targetSystemId) {
        // ã‚·ã‚¹ãƒ†ãƒ é·ç§»
        loadSystemInPreview(targetSystemId);
      }
    }
  });

  btn.style.left = elem.position_x + "px";
  btn.style.top = elem.position_y + "px";

  addDragHandleIfMissing(btn);
  makeDraggable(btn);
  document.getElementById("slideArea").appendChild(btn);
}

function restoreTextBox(elem) {
  const container = document.createElement('div');
  container.className = 'text-input-container';
  
  container.style.left = elem.position_x + 'px';
  container.style.top = elem.position_y + 'px';
  if (elem.width) container.style.width = elem.width + 'px';
  if (elem.height) container.style.height = elem.height + 'px';

  const ta = document.createElement('textarea');
  ta.className = 'text-input';
  ta.value = elem.element_value || '';
  ta.placeholder = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›';
  ta.spellcheck = false;

  container.appendChild(ta);
  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById('slideArea').appendChild(container);
}

function restoreRoulette(elem) {
  const container = document.createElement("div");
  container.classList.add("roulette-container");
  
  const config = elem.element_config || {};
  const items = config.items || ['é …ç›®1', 'é …ç›®2', 'é …ç›®3'];
  
  container.setAttribute('data-roulette-items', JSON.stringify(items));
  container.setAttribute('data-roulette-spinning', 'false');
  
  // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å††ã‚’ä½œæˆï¼ˆSVGãƒ™ãƒ¼ã‚¹ï¼‰
  const wheel = document.createElement("div");
  wheel.classList.add("roulette-wheel");
  wheel.style.position = "relative";
  wheel.style.width = "200px";
  wheel.style.height = "200px";
  wheel.style.transition = "transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)";
  wheel.dataset.currentRotation = "0";
  
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "200");
  svg.setAttribute("height", "200");
  svg.setAttribute("viewBox", "0 0 200 200");
  
  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52C41A'];
  const centerX = 100;
  const centerY = 100;
  const radius = 95;
  const anglePerSegment = (2 * Math.PI) / items.length;
  
  items.forEach((item, index) => {
    const startAngle = index * anglePerSegment - Math.PI / 2;
    const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
    
    const x1 = centerX + radius * Math.cos(startAngle);
    const y1 = centerY + radius * Math.sin(startAngle);
    const x2 = centerX + radius * Math.cos(endAngle);
    const y2 = centerY + radius * Math.sin(endAngle);
    
    const largeArcFlag = anglePerSegment > Math.PI ? 1 : 0;
    
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
    path.setAttribute("fill", colors[index % colors.length]);
    path.setAttribute("stroke", "#fff");
    path.setAttribute("stroke-width", "2");
    svg.appendChild(path);
    
    const textAngle = startAngle + anglePerSegment / 2;
    const textRadius = radius * 0.65;
    const textX = centerX + textRadius * Math.cos(textAngle);
    const textY = centerY + textRadius * Math.sin(textAngle);
    
    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", textX);
    text.setAttribute("y", textY);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("dominant-baseline", "middle");
    text.setAttribute("fill", "#fff");
    text.setAttribute("font-size", "14");
    text.setAttribute("font-weight", "bold");
    text.setAttribute("transform", `rotate(${(textAngle * 180 / Math.PI) + 90}, ${textX}, ${textY})`);
    text.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";
    text.textContent = item;
    svg.appendChild(text);
  });
  
  const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  circle.setAttribute("cx", centerX);
  circle.setAttribute("cy", centerY);
  circle.setAttribute("r", radius);
  circle.setAttribute("fill", "none");
  circle.setAttribute("stroke", "#333");
  circle.setAttribute("stroke-width", "4");
  svg.appendChild(circle);
  
  wheel.appendChild(svg);
  
  const pin = document.createElement("div");
  pin.style.position = "absolute";
  pin.style.top = "-15px";
  pin.style.left = "48%";
  pin.style.transform = "translateX(-50%)";
  pin.style.width = "0";
  pin.style.height = "0";
  pin.style.borderLeft = "10px solid transparent";
  pin.style.borderRight = "10px solid transparent";
  pin.style.borderTop = "20px solid #FF0000";
  pin.style.zIndex = "10";
  pin.style.pointerEvents = "none";
  
  const result = document.createElement("div");
  result.classList.add("roulette-result");
  result.style.marginTop = "10px";
  result.style.padding = "8px";
  result.style.background = "#f0f0f0";
  result.style.borderRadius = "4px";
  result.style.textAlign = "center";
  result.style.fontWeight = "bold";
  result.textContent = "çµæœ: -";
  
  const spinBtn = document.createElement("button");
  spinBtn.classList.add("roulette-btn", "spin");
  spinBtn.textContent = "ã‚¹ãƒ”ãƒ³";
  spinBtn.style.marginTop = "10px";
  spinBtn.style.padding = "8px 20px";
  spinBtn.style.fontSize = "16px";
  spinBtn.style.cursor = "pointer";
  spinBtn.style.position = "relative";
  spinBtn.style.zIndex = "100";
  spinBtn.onclick = function(e) {
    e.stopPropagation();
    const spinning = container.getAttribute('data-roulette-spinning') === 'true';
    if (spinning) return;
    
    container.setAttribute('data-roulette-spinning', 'true');
    spinBtn.disabled = true;
    spinBtn.style.cursor = 'not-allowed';
    spinBtn.style.opacity = '0.6';
    
    const currentRotation = parseFloat(wheel.dataset.currentRotation) || 0;
    const spins = 5 + Math.random() * 3;
    const extraDegrees = Math.random() * 360;
    const newRotation = currentRotation + spins * 360 + extraDegrees;
    
    wheel.style.transform = `rotate(${newRotation}deg)`;
    wheel.dataset.currentRotation = newRotation;
    
    setTimeout(() => {
      const finalAngle = ((newRotation % 360) + 360) % 360;
      const segmentAngle = 360 / items.length;
      const angleOnWheel = (270 - finalAngle + 360) % 360;
      const selectedIndex = Math.floor((angleOnWheel + 90) / segmentAngle) % items.length;
      
      result.textContent = `çµæœ: ${items[selectedIndex]}`;
      container.setAttribute('data-roulette-spinning', 'false');
      spinBtn.disabled = false;
      spinBtn.style.cursor = 'pointer';
      spinBtn.style.opacity = '1';
    }, 3000);
  };
  
  const wheelWrapper = document.createElement("div");
  wheelWrapper.style.position = "relative";
  wheelWrapper.style.pointerEvents = "none";
  wheelWrapper.appendChild(pin);
  wheelWrapper.appendChild(wheel);
  
  container.appendChild(wheelWrapper);
  container.appendChild(result);
  container.appendChild(spinBtn);
  
  container.style.left = elem.position_x + "px";
  container.style.top = elem.position_y + "px";
  if (elem.width) container.style.width = elem.width + "px";
  if (elem.height) container.style.height = elem.height + "px";

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
}

function restoreTimer(elem) {
  const container = document.createElement("div");
  container.classList.add("timer-container");
  
  const mode = elem.element_config?.mode || 'up';
  const targetSeconds = elem.element_config?.target || 0;
  
  container.setAttribute('data-timer-seconds', elem.element_value || '0');
  container.setAttribute('data-timer-running', 'false');
  container.setAttribute('data-timer-mode', mode);
  container.setAttribute('data-timer-target', targetSeconds.toString());

  const settingsBtn = document.createElement("button");
  settingsBtn.classList.add("timer-settings-btn");
  settingsBtn.textContent = "âš™ è¨­å®š";
  settingsBtn.title = "ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´";
  settingsBtn.onclick = function(e) {
    e.stopPropagation();
    openTimerSettings(container, display);
  };

  const display = document.createElement("div");
  display.classList.add("timer-display");
  
  const seconds = parseInt(elem.element_value || '0');
  const hDisp = Math.floor(seconds / 3600);
  const mDisp = Math.floor((seconds % 3600) / 60);
  const sDisp = seconds % 60;
  display.textContent = 
    String(hDisp).padStart(2, '0') + ':' +
    String(mDisp).padStart(2, '0') + ':' +
    String(sDisp).padStart(2, '0');

  const controls = document.createElement("div");
  controls.classList.add("timer-controls");

  const startBtn = document.createElement("button");
  startBtn.classList.add("timer-btn", "start");
  startBtn.textContent = "é–‹å§‹";
  startBtn.onclick = function(e) {
    e.stopPropagation();
    const running = container.getAttribute('data-timer-running') === 'true';
    const timerMode = container.getAttribute('data-timer-mode');
    
    if (!running) {
      if (timerMode === 'down') {
        const target = parseInt(container.getAttribute('data-timer-target') || '0');
        if (target === 0) {
          alert('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
          return;
        }
      }
      container.setAttribute('data-timer-running', 'true');
      startBtn.textContent = "åœæ­¢";
      startBtn.classList.remove('start');
      startBtn.classList.add('pause');
    } else {
      container.setAttribute('data-timer-running', 'false');
      startBtn.textContent = "é–‹å§‹";
      startBtn.classList.remove('pause');
      startBtn.classList.add('start');
    }
  };

  const resetBtn = document.createElement("button");
  resetBtn.classList.add("timer-btn", "reset");
  resetBtn.textContent = "ãƒªã‚»ãƒƒãƒˆ";
  resetBtn.onclick = function(e) {
    e.stopPropagation();
    const timerMode = container.getAttribute('data-timer-mode');
    container.setAttribute('data-timer-running', 'false');
    
    if (timerMode === 'up') {
      container.setAttribute('data-timer-seconds', '0');
      display.textContent = "00:00:00";
    } else {
      const target = parseInt(container.getAttribute('data-timer-target') || '0');
      container.setAttribute('data-timer-seconds', target.toString());
      const h = Math.floor(target / 3600);
      const m = Math.floor((target % 3600) / 60);
      const s = target % 60;
      display.textContent = 
        String(h).padStart(2, '0') + ':' +
        String(m).padStart(2, '0') + ':' +
        String(s).padStart(2, '0');
    }
    
    startBtn.textContent = "é–‹å§‹";
    startBtn.classList.remove('pause');
    startBtn.classList.add('start');
  };

  controls.appendChild(startBtn);
  controls.appendChild(resetBtn);
  
  container.appendChild(settingsBtn);
  container.appendChild(display);
  container.appendChild(controls);

  container.style.left = elem.position_x + 'px';
  container.style.top = elem.position_y + 'px';
  if (elem.width) container.style.width = elem.width + 'px';
  if (elem.height) container.style.height = elem.height + 'px';

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById('slideArea').appendChild(container);
}
</script>
