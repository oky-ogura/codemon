<script>
// ========================================
// ã‚«ã‚¹ã‚¿ãƒ confirmãƒ€ã‚¤ã‚¢ãƒ­ã‚°
// ========================================
function customConfirm(message, options = {}) {
  return new Promise((resolve) => {
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
    const overlay = document.createElement('div');
    overlay.className = 'custom-confirm-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'custom-confirm-dialog';
    
    const header = document.createElement('div');
    header.className = 'custom-confirm-header';
    header.textContent = options.title || 'ç¢ºèª';
    
    const body = document.createElement('div');
    body.className = 'custom-confirm-body';
    body.textContent = message;
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'custom-confirm-buttons';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'custom-confirm-btn cancel';
    cancelBtn.textContent = options.cancelText || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = () => {
      overlay.remove();
      resolve(false);
    };
    
    const confirmBtn = document.createElement('button');
    confirmBtn.className = `custom-confirm-btn ${options.danger ? 'danger' : 'confirm'}`;
    confirmBtn.textContent = options.confirmText || 'OK';
    confirmBtn.onclick = () => {
      overlay.remove();
      resolve(true);
    };
    
    buttonsDiv.appendChild(cancelBtn);
    buttonsDiv.appendChild(confirmBtn);
    
    dialog.appendChild(header);
    dialog.appendChild(body);
    dialog.appendChild(buttonsDiv);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.remove();
        resolve(false);
      }
    };
  });
}

// ========================================
// ã‚«ã‚¹ã‚¿ãƒ promptãƒ€ã‚¤ã‚¢ãƒ­ã‚°
// ========================================
function customPrompt(message, defaultValue = '', options = {}) {
  return new Promise((resolve) => {
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã¨ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’ä½œæˆ
    const overlay = document.createElement('div');
    overlay.className = 'custom-confirm-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'custom-confirm-dialog';
    
    const header = document.createElement('div');
    header.className = 'custom-confirm-header';
    header.textContent = options.title || 'å…¥åŠ›';
    
    const body = document.createElement('div');
    body.className = 'custom-confirm-body';
    body.style.textAlign = 'left';
    body.textContent = message;
    
    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const inputWrapper = document.createElement('div');
    inputWrapper.style.marginTop = '15px';
    
    const input = document.createElement('input');
    input.type = options.type || 'text';
    input.value = defaultValue;
    input.style.width = '100%';
    input.style.padding = '10px 12px';
    input.style.border = '2px solid #e0e0e0';
    input.style.borderRadius = '10px';
    input.style.fontSize = '14px';
    input.style.boxSizing = 'border-box';
    input.style.transition = 'border-color 0.2s';
    input.onfocus = () => {
      input.style.borderColor = '#3fbcd9';
      input.style.outline = 'none';
    };
    input.onblur = () => {
      input.style.borderColor = '#e0e0e0';
    };
    
    inputWrapper.appendChild(input);
    body.appendChild(inputWrapper);
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'custom-confirm-buttons';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'custom-confirm-btn cancel';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = () => {
      overlay.remove();
      resolve(null);
    };
    
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'custom-confirm-btn confirm';
    confirmBtn.textContent = 'OK';
    confirmBtn.onclick = () => {
      overlay.remove();
      resolve(input.value);
    };
    
    buttonsDiv.appendChild(cancelBtn);
    buttonsDiv.appendChild(confirmBtn);
    
    dialog.appendChild(header);
    dialog.appendChild(body);
    dialog.appendChild(buttonsDiv);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // Enterã‚­ãƒ¼ã§ç¢ºå®š
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        overlay.remove();
        resolve(input.value);
      }
    });
    
    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«
    setTimeout(() => {
      input.focus();
      input.select();
    }, 100);
    
    // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.remove();
        resolve(null);
      }
    };
  });
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«confirmã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ï¼ˆéåŒæœŸç‰ˆã‚’åŒæœŸçš„ã«ä½¿ã†ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ï¼‰
const originalConfirm = window.confirm;
window.confirm = function(message) {
  // åŒæœŸçš„ã«ä½¿ã‚ã‚Œã‚‹å ´åˆã¯ã€ã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦çµæœã‚’è¿”ã™
  // æ³¨æ„: Promiseã‚’è¿”ã™ãŸã‚ã€async/awaitã§å‘¼ã³å‡ºã™å¿…è¦ãŒã‚ã‚‹
  console.warn('confirm() was called synchronously. Please use customConfirm() with async/await instead.');
  // ç·Šæ€¥çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦å…ƒã®confirmã‚’ä½¿ç”¨
  return originalConfirm(message);
};

// ã‚°ãƒ­ãƒ¼ãƒãƒ«promptã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
const originalPrompt = window.prompt;
window.prompt = function(message, defaultValue) {
  console.warn('prompt() was called synchronously. Please use customPrompt() with async/await instead.');
  return originalPrompt(message, defaultValue);
};

// ã‚«ã‚¹ã‚¿ãƒ alertï¼ˆconfirmã®å˜ä¸€ãƒœã‚¿ãƒ³ç‰ˆï¼‰
function customAlert(message, options = {}) {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.className = 'custom-confirm-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'custom-confirm-dialog';
    
    const header = document.createElement('div');
    header.className = 'custom-confirm-header';
    header.textContent = options.title || 'é€šçŸ¥';
    
    const body = document.createElement('div');
    body.className = 'custom-confirm-body';
    body.textContent = message;
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'custom-confirm-buttons';
    
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'custom-confirm-btn confirm';
    confirmBtn.textContent = 'OK';
    confirmBtn.style.maxWidth = '200px';
    confirmBtn.onclick = () => {
      overlay.remove();
      resolve(true);
    };
    
    buttonsDiv.appendChild(confirmBtn);
    
    dialog.appendChild(header);
    dialog.appendChild(body);
    dialog.appendChild(buttonsDiv);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    overlay.onclick = (e) => {
      if (e.target === overlay) {
        overlay.remove();
        resolve(true);
      }
    };
  });
}

// ã‚«ã‚¹ã‚¿ãƒ è¤‡æ•°å…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function customMultiInput(count, options = {}) {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.className = 'custom-confirm-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'custom-confirm-dialog';
    dialog.style.maxWidth = '500px';
    
    const header = document.createElement('div');
    header.className = 'custom-confirm-header';
    header.textContent = options.title || 'å…¥åŠ›';
    
    const body = document.createElement('div');
    body.className = 'custom-confirm-body';
    body.style.textAlign = 'left';
    body.style.maxHeight = '400px';
    body.style.overflowY = 'auto';
    
    if (options.message) {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = options.message;
      messageDiv.style.marginBottom = '15px';
      body.appendChild(messageDiv);
    }
    
    const inputs = [];
    for (let i = 0; i < count; i++) {
      const inputWrapper = document.createElement('div');
      inputWrapper.style.marginBottom = '12px';
      
      const label = document.createElement('label');
      label.textContent = options.labelPrefix ? `${options.labelPrefix} ${i + 1}` : `é …ç›® ${i + 1}`;
      label.style.display = 'block';
      label.style.marginBottom = '6px';
      label.style.fontWeight = '600';
      label.style.color = '#333';
      label.style.fontSize = '13px';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = options.defaultPrefix ? `${options.defaultPrefix}${i + 1}` : `é …ç›®${i + 1}`;
      input.style.width = '100%';
      input.style.padding = '8px 12px';
      input.style.border = '2px solid #e0e0e0';
      input.style.borderRadius = '10px';
      input.style.fontSize = '14px';
      input.style.boxSizing = 'border-box';
      input.style.transition = 'border-color 0.2s';
      input.onfocus = () => {
        input.style.borderColor = '#3fbcd9';
        input.style.outline = 'none';
      };
      input.onblur = () => {
        input.style.borderColor = '#e0e0e0';
      };
      
      inputs.push(input);
      inputWrapper.appendChild(label);
      inputWrapper.appendChild(input);
      body.appendChild(inputWrapper);
    }
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'custom-confirm-buttons';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'custom-confirm-btn cancel';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = () => {
      overlay.remove();
      resolve(null);
    };
    
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'custom-confirm-btn confirm';
    confirmBtn.textContent = 'OK';
    confirmBtn.onclick = () => {
      const values = inputs.map(input => input.value);
      overlay.remove();
      resolve(values);
    };
    
    buttonsDiv.appendChild(cancelBtn);
    buttonsDiv.appendChild(confirmBtn);
    
    dialog.appendChild(header);
    dialog.appendChild(body);
    dialog.appendChild(buttonsDiv);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // æœ€åˆã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    setTimeout(() => {
      if (inputs[0]) {
        inputs[0].focus();
        inputs[0].select();
      }
    }, 100);
  });
}

// ãƒœã‚¿ãƒ³ä½œæˆç”¨ã®ä¸€æ‹¬è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°
function customButtonSettings(algorithms, otherSystems) {
  return new Promise((resolve) => {
    const overlay = document.createElement('div');
    overlay.className = 'custom-confirm-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'custom-confirm-dialog';
    dialog.style.maxWidth = '600px';
    dialog.style.maxHeight = '90vh';
    dialog.style.overflowY = 'auto';
    
    const header = document.createElement('div');
    header.className = 'custom-confirm-header';
    header.textContent = 'ãƒœã‚¿ãƒ³ã®è¨­å®š';
    
    const body = document.createElement('div');
    body.className = 'custom-confirm-body';
    body.style.textAlign = 'left';
    
    // ãƒœã‚¿ãƒ³å
    const nameWrapper = createInputField('ãƒœã‚¿ãƒ³å', 'text', 'ãƒœã‚¿ãƒ³');
    const nameInput = nameWrapper.querySelector('input');
    body.appendChild(nameWrapper);
    
    // å¹…
    const widthWrapper = createInputField('å¹… (px)', 'number', '100');
    const widthInput = widthWrapper.querySelector('input');
    widthInput.min = '50';
    body.appendChild(widthWrapper);
    
    // é«˜ã•
    const heightWrapper = createInputField('é«˜ã• (px)', 'number', '40');
    const heightInput = heightWrapper.querySelector('input');
    heightInput.min = '30';
    body.appendChild(heightWrapper);
    
    // è‰²é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³
    const colorSection = document.createElement('div');
    colorSection.style.marginBottom = '15px';
    
    const colorLabel = document.createElement('label');
    colorLabel.textContent = 'ãƒœã‚¿ãƒ³ã®è‰²';
    colorLabel.style.display = 'block';
    colorLabel.style.marginBottom = '8px';
    colorLabel.style.fontWeight = '600';
    colorLabel.style.color = '#333';
    colorSection.appendChild(colorLabel);
    
    const colorInputGroup = document.createElement('div');
    colorInputGroup.style.display = 'flex';
    colorInputGroup.style.gap = '10px';
    colorInputGroup.style.alignItems = 'center';
    
    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼
    const colorPicker = document.createElement('input');
    colorPicker.type = 'color';
    colorPicker.value = '#3fbcd9';
    colorPicker.style.width = '60px';
    colorPicker.style.height = '40px';
    colorPicker.style.border = '2px solid #e0e0e0';
    colorPicker.style.borderRadius = '10px';
    colorPicker.style.cursor = 'pointer';
    
    // HEXå…¥åŠ›
    const hexInput = document.createElement('input');
    hexInput.type = 'text';
    hexInput.value = '#3fbcd9';
    hexInput.placeholder = '#FF5733';
    hexInput.style.flex = '1';
    hexInput.style.padding = '8px 12px';
    hexInput.style.border = '2px solid #e0e0e0';
    hexInput.style.borderRadius = '10px';
    hexInput.style.fontSize = '14px';
    hexInput.style.fontFamily = 'monospace';
    
    // ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã¨HEXå…¥åŠ›ã‚’åŒæœŸ
    colorPicker.addEventListener('input', () => {
      hexInput.value = colorPicker.value;
    });
    
    hexInput.addEventListener('input', () => {
      if (/^#[0-9A-Fa-f]{6}$/.test(hexInput.value)) {
        colorPicker.value = hexInput.value;
      }
    });
    
    colorInputGroup.appendChild(colorPicker);
    colorInputGroup.appendChild(hexInput);
    colorSection.appendChild(colorInputGroup);
    body.appendChild(colorSection);
    
    // å‹•ä½œé¸æŠ
    const actionWrapper = document.createElement('div');
    actionWrapper.style.marginBottom = '15px';
    
    const actionLabel = document.createElement('label');
    actionLabel.textContent = 'ãƒœã‚¿ãƒ³ã®å‹•ä½œ';
    actionLabel.style.display = 'block';
    actionLabel.style.marginBottom = '8px';
    actionLabel.style.fontWeight = '600';
    actionLabel.style.color = '#333';
    actionWrapper.appendChild(actionLabel);
    
    const actionSelect = document.createElement('select');
    actionSelect.style.width = '100%';
    actionSelect.style.padding = '8px 12px';
    actionSelect.style.border = '2px solid #e0e0e0';
    actionSelect.style.borderRadius = '10px';
    actionSelect.style.fontSize = '14px';
    actionSelect.innerHTML = `
      <option value="none">å‹•ä½œãªã—</option>
      <option value="algorithm">ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ</option>
      <option value="system">ã‚·ã‚¹ãƒ†ãƒ é·ç§»</option>
    `;
    actionWrapper.appendChild(actionSelect);
    body.appendChild(actionWrapper);
    
    // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ é¸æŠ
    const algorithmWrapper = document.createElement('div');
    algorithmWrapper.style.marginBottom = '15px';
    algorithmWrapper.style.display = 'none';
    
    const algorithmLabel = document.createElement('label');
    algorithmLabel.textContent = 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ';
    algorithmLabel.style.display = 'block';
    algorithmLabel.style.marginBottom = '8px';
    algorithmLabel.style.fontWeight = '600';
    algorithmLabel.style.color = '#333';
    algorithmWrapper.appendChild(algorithmLabel);
    
    const algorithmSelect = document.createElement('select');
    algorithmSelect.style.width = '100%';
    algorithmSelect.style.padding = '8px 12px';
    algorithmSelect.style.border = '2px solid #e0e0e0';
    algorithmSelect.style.borderRadius = '10px';
    algorithmSelect.style.fontSize = '14px';
    
    if (algorithms && algorithms.length > 0) {
      algorithms.forEach((algo, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = algo.algorithm_name;
        algorithmSelect.appendChild(opt);
      });
    } else {
      const opt = document.createElement('option');
      opt.textContent = 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒã‚ã‚Šã¾ã›ã‚“';
      algorithmSelect.appendChild(opt);
    }
    algorithmWrapper.appendChild(algorithmSelect);
    body.appendChild(algorithmWrapper);
    
    // ã‚·ã‚¹ãƒ†ãƒ é¸æŠ
    const systemWrapper = document.createElement('div');
    systemWrapper.style.marginBottom = '15px';
    systemWrapper.style.display = 'none';
    
    const systemLabel = document.createElement('label');
    systemLabel.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ';
    systemLabel.style.display = 'block';
    systemLabel.style.marginBottom = '8px';
    systemLabel.style.fontWeight = '600';
    systemLabel.style.color = '#333';
    systemWrapper.appendChild(systemLabel);
    
    const systemSelect = document.createElement('select');
    systemSelect.style.width = '100%';
    systemSelect.style.padding = '8px 12px';
    systemSelect.style.border = '2px solid #e0e0e0';
    systemSelect.style.borderRadius = '10px';
    systemSelect.style.fontSize = '14px';
    
    if (otherSystems && otherSystems.length > 0) {
      otherSystems.forEach((sys, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = sys.system_name;
        systemSelect.appendChild(opt);
      });
    } else {
      const opt = document.createElement('option');
      opt.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“';
      systemSelect.appendChild(opt);
    }
    systemWrapper.appendChild(systemSelect);
    body.appendChild(systemWrapper);
    
    // å‹•ä½œé¸æŠã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    actionSelect.addEventListener('change', () => {
      algorithmWrapper.style.display = actionSelect.value === 'algorithm' ? 'block' : 'none';
      systemWrapper.style.display = actionSelect.value === 'system' ? 'block' : 'none';
    });
    
    const buttonsDiv = document.createElement('div');
    buttonsDiv.className = 'custom-confirm-buttons';
    
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'custom-confirm-btn cancel';
    cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    cancelBtn.onclick = () => {
      overlay.remove();
      resolve(null);
    };
    
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'custom-confirm-btn confirm';
    confirmBtn.textContent = 'ä½œæˆ';
    confirmBtn.onclick = () => {
      const result = {
        name: nameInput.value || 'ãƒœã‚¿ãƒ³',
        width: parseInt(widthInput.value) || 100,
        height: parseInt(heightInput.value) || 40,
        color: hexInput.value,
        actionType: actionSelect.value,
        algorithmIndex: algorithmSelect.value !== '' ? parseInt(algorithmSelect.value) : null,
        systemIndex: systemSelect.value !== '' ? parseInt(systemSelect.value) : null
      };
      overlay.remove();
      resolve(result);
    };
    
    buttonsDiv.appendChild(cancelBtn);
    buttonsDiv.appendChild(confirmBtn);
    
    dialog.appendChild(header);
    dialog.appendChild(body);
    dialog.appendChild(buttonsDiv);
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    setTimeout(() => nameInput.focus(), 100);
  });
}

function createInputField(labelText, type, defaultValue) {
  const wrapper = document.createElement('div');
  wrapper.style.marginBottom = '15px';
  
  const label = document.createElement('label');
  label.textContent = labelText;
  label.style.display = 'block';
  label.style.marginBottom = '8px';
  label.style.fontWeight = '600';
  label.style.color = '#333';
  label.style.fontSize = '13px';
  
  const input = document.createElement('input');
  input.type = type;
  input.value = defaultValue;
  input.style.width = '100%';
  input.style.padding = '8px 12px';
  input.style.border = '2px solid #e0e0e0';
  input.style.borderRadius = '10px';
  input.style.fontSize = '14px';
  input.style.boxSizing = 'border-box';
  input.style.transition = 'border-color 0.2s';
  input.onfocus = () => {
    input.style.borderColor = '#3fbcd9';
    input.style.outline = 'none';
  };
  input.onblur = () => {
    input.style.borderColor = '#e0e0e0';
  };
  
  wrapper.appendChild(label);
  wrapper.appendChild(input);
  return wrapper;
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«alertã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
const originalAlert = window.alert;
window.alert = function(message) {
  console.warn('alert() was called synchronously. Please use customAlert() with async/await instead.');
  return originalAlert(message);
};

// ========================================
// window.onload - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
// ========================================
window.onload = function() {
  const slide = document.getElementById('slideArea');
  
  // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æ—¢å­˜è¦ç´ ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’å¾©å…ƒ
  if (existingElementsData && existingElementsData.length > 0) {
    console.log('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ è¦ç´ ã‚’å¾©å…ƒã—ã¾ã™:', existingElementsData);
    restoreSystemElements(existingElementsData);
  } else {
    // ä¿å­˜ç”»é¢ã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆã®ã¿ã€sessionStorageã‹ã‚‰ä»¥å‰ã®ç·¨é›†å†…å®¹ã‚’å¾©å…ƒ
    const returnFromCreate = sessionStorage.getItem('returnFromCreate');
    const savedContent = sessionStorage.getItem('systemDesignContent');
    
    console.log('ğŸ” å¾©å…ƒãƒã‚§ãƒƒã‚¯:');
    console.log('  - returnFromCreate:', returnFromCreate);
    console.log('  - savedContent:', savedContent ? `${savedContent.length}æ–‡å­—` : 'ãªã—');
    console.log('  - slideè¦ç´ :', slide);
    
    if (returnFromCreate === 'true' && savedContent && slide) {
      console.log('âœ… å¾©å…ƒæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã™ã€‚å¾©å…ƒã‚’é–‹å§‹ã—ã¾ã™ã€‚');
      try {
        // JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è§£æã‚’è©¦ã¿ã‚‹
        const elementsData = JSON.parse(savedContent);
        console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆJSONå½¢å¼ï¼‰:', elementsData);
        console.log('ğŸ“Š å¾©å…ƒã™ã‚‹è¦ç´ æ•°:', elementsData.length);
        restoreSystemElements(elementsData);
      } catch (e) {
        console.error('âŒ JSONè§£æã‚¨ãƒ©ãƒ¼:', e);
        // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆã¯ã€å¾“æ¥ã®HTMLå½¢å¼ã¨ã—ã¦å‡¦ç†
        console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆHTMLå½¢å¼ï¼‰');
        const trash = slide.querySelector('#trash');
        const trashHTML = trash ? trash.outerHTML : '<div id="trash" title="ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã§å‰Šé™¤">ğŸ—‘ï¸</div>';
        slide.innerHTML = savedContent + trashHTML;
      }
    } else {
      console.log('âš ï¸ å¾©å…ƒæ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“:');
      if (returnFromCreate !== 'true') console.log('  - returnFromCreateãŒ"true"ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
      if (!savedContent) console.log('  - savedContentãŒã‚ã‚Šã¾ã›ã‚“');
      if (!slide) console.log('  - slideè¦ç´ ãŒã‚ã‚Šã¾ã›ã‚“');
    }
  }
  
  // å¾©å…ƒå¾Œã¯ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ¬¡å›ã®é€šå¸¸ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å¾©å…ƒã—ãªã„ã‚ˆã†ã«ï¼‰
  sessionStorage.removeItem('returnFromCreate');
  
  // navigatingToCreateãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢ï¼ˆä¿å­˜ç”»é¢ã«é·ç§»ã—ãŸå¾Œã¯ä¸è¦ï¼‰
  sessionStorage.removeItem('navigatingToCreate');
  
  // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªè¦ç´ ã«ãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ 
  Array.from(document.querySelectorAll('.input-container, .draggable-btn, .text-input_container, .text-input-container, .text-box-container, .checkbox-group, .radio-group, .timer-container, .roulette-container, .shape-element, .image-element')).forEach(el=>{
    addDragHandleIfMissing(el);
    makeDraggable(el);
  });
  
  // æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
  document.querySelectorAll('input[data-only-number="true"]').forEach(inp => {
    try { attachNumberFilter(inp); } catch(e){ console.error(e); }
  });
  
  // ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°å‡¦ç†ã‚’é–‹å§‹
  startTimerUpdates();
  
  saveHistory();
};

// ========================================
// ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°å‡¦ç†
// ========================================
function startTimerUpdates() {
  setInterval(function() {
    document.querySelectorAll('.timer-container').forEach(timer => {
      const running = timer.getAttribute('data-timer-running') === 'true';
      if (running) {
        const mode = timer.getAttribute('data-timer-mode') || 'up';
        let seconds = parseInt(timer.getAttribute('data-timer-seconds') || '0');
        
        if (mode === 'up') {
          seconds++;
          timer.setAttribute('data-timer-seconds', seconds.toString());
        } else {
          seconds--;
          if (seconds < 0) seconds = 0;
          timer.setAttribute('data-timer-seconds', seconds.toString());
          
          if (seconds === 0) {
            timer.setAttribute('data-timer-running', 'false');
            const startBtn = timer.querySelector('.timer-btn.pause');
            if (startBtn) {
              startBtn.textContent = "é–‹å§‹";
              startBtn.classList.remove('pause');
              startBtn.classList.add('start');
            }
          }
        }
        
        const display = timer.querySelector('.timer-display');
        if (display) {
          const h = Math.floor(seconds / 3600);
          const m = Math.floor((seconds % 3600) / 60);
          const s = seconds % 60;
          display.textContent = 
            String(h).padStart(2, '0') + ':' +
            String(m).padStart(2, '0') + ':' +
            String(s).padStart(2, '0');
        }
      }
    });
  }, 1000);
}

// ========================================
// JSONå½¢å¼ã®è¦ç´ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLè¦ç´ ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
// ========================================
function restoreSystemElements(elementsData) {
  const slide = document.getElementById('slideArea');
  if (!slide) return;
  
  elementsData.forEach(elem => {
    try {
      switch(elem.element_type) {
        case 'text_input':
          restoreTextInput(elem, false);
          break;
        case 'number_input':
          restoreTextInput(elem, true);
          break;
        case 'datetime_input':
          restoreDatetimeInput(elem);
          break;
        case 'checkbox_group':
          restoreCheckboxGroup(elem);
          break;
        case 'radio_group':
          restoreRadioGroup(elem);
          break;
        case 'button':
          restoreButton(elem);
          break;
        case 'text_box':
          restoreTextBox(elem);
          break;
        case 'roulette':
          restoreRoulette(elem);
          break;
        case 'timer':
          restoreTimer(elem);
          break;
        case 'shape':
          restoreShape(elem);
          break;
        case 'image':
          restoreImage(elem);
          break;
      }
    } catch (error) {
      console.error('è¦ç´ ã®å¾©å…ƒã«å¤±æ•—:', elem, error);
    }
  });
}

function restoreTextInput(elem, onlyNumber) {
  const container = document.createElement("div");
  container.classList.add("input-container");

  const label = document.createElement("div");
  label.classList.add("input-label");
  label.textContent = elem.element_label || (onlyNumber ? "æ•°å­—ï¼š" : "æ–‡å­—ï¼š");
  label.contentEditable = "true";

  const placeholder = elem.element_config?.placeholder || (onlyNumber ? "æ•°å­—ã‚’å…¥åŠ›" : "æ–‡å­—ã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œå¯ï¼‰");
  const actualValue = elem.element_value || "";

  if (onlyNumber) {
    const input = document.createElement("input");
    input.type = "text";
    input.inputMode = "numeric";
    input.pattern = "\\d*";
    input.classList.add("input-box");
    input.placeholder = placeholder;
    input.value = actualValue;
    input.setAttribute('data-only-number', 'true');
    container.appendChild(label);
    container.appendChild(input);
    attachNumberFilter(input);
  } else {
    const textarea = document.createElement("textarea");
    textarea.classList.add("input-box");
    textarea.placeholder = placeholder;
    textarea.value = actualValue;
    container.appendChild(label);
    container.appendChild(textarea);
  }

  container.style.left = elem.position_x + "px";
  container.style.top = elem.position_y + "px";
  if (elem.width) container.style.width = elem.width + "px";
  if (elem.height) container.style.height = elem.height + "px";

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
}

function restoreDatetimeInput(elem) {
  const container = document.createElement("div");
  container.classList.add("input-container");

  const label = document.createElement("div");
  label.classList.add("input-label");
  label.textContent = elem.element_label || "æ—¥æ™‚ï¼š";
  label.contentEditable = "true";

  const input = document.createElement("input");
  input.type = "datetime-local";
  input.style.minWidth = "180px";
  input.style.minHeight = "36px";
  input.style.fontSize = "16px";
  input.style.padding = "4px 8px";
  input.style.boxSizing = "border-box";
  input.classList.add("input-box");
  input.value = elem.element_value || "";

  container.appendChild(label);
  container.appendChild(input);

  container.style.left = elem.position_x + "px";
  container.style.top = elem.position_y + "px";
  if (elem.width) container.style.width = elem.width + "px";
  if (elem.height) container.style.height = elem.height + "px";

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
}

function restoreCheckboxGroup(elem) {
  const group = document.createElement('div');
  group.className = 'checkbox-group';

  // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ 
  if (elem.element_label) {
    const labelDiv = document.createElement('div');
    labelDiv.className = 'checkbox-group-label';
    labelDiv.contentEditable = 'true';
    labelDiv.textContent = elem.element_label;
    labelDiv.style.fontWeight = 'bold';
    labelDiv.style.marginBottom = '4px';
    labelDiv.style.cursor = 'text';
    group.appendChild(labelDiv);
  }

  const options = elem.element_config?.options || [];
  options.forEach((optText, i) => {
    const row = document.createElement('div');
    row.className = 'checkbox-row';

    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.tabIndex = 0;

    const lbl = document.createElement('div');
    lbl.className = 'checkbox-label';
    lbl.contentEditable = 'true';
    lbl.textContent = optText || ('é …ç›® ' + (i + 1));

    row.appendChild(cb);
    row.appendChild(lbl);
    group.appendChild(row);
  });

  group.style.left = elem.position_x + 'px';
  group.style.top = elem.position_y + 'px';
  if (elem.width) group.style.width = elem.width + 'px';
  if (elem.height) group.style.height = elem.height + 'px';

  addDragHandleIfMissing(group);
  makeDraggable(group);
  document.getElementById('slideArea').appendChild(group);
}

function restoreRadioGroup(elem) {
  const group = document.createElement('div');
  group.className = 'radio-group';

  // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ 
  if (elem.element_label) {
    const labelDiv = document.createElement('div');
    labelDiv.className = 'radio-group-label';
    labelDiv.contentEditable = 'true';
    labelDiv.textContent = elem.element_label;
    labelDiv.style.fontWeight = 'bold';
    labelDiv.style.marginBottom = '4px';
    labelDiv.style.cursor = 'text';
    group.appendChild(labelDiv);
  }

  const uniqueName = 'radio_group_' + Date.now() + '_' + Math.floor(Math.random()*1000);
  const options = elem.element_config?.options || [];
  options.forEach((optText, i) => {
    const row = document.createElement('div');
    row.className = 'radio-row';

    const rb = document.createElement('input');
    rb.type = 'radio';
    rb.name = uniqueName;
    rb.tabIndex = 0;

    const lbl = document.createElement('div');
    lbl.className = 'radio-label';
    lbl.contentEditable = 'true';
    lbl.textContent = optText || ('é …ç›® ' + (i + 1));

    row.appendChild(rb);
    row.appendChild(lbl);
    group.appendChild(row);
  });

  group.style.left = elem.position_x + 'px';
  group.style.top = elem.position_y + 'px';
  if (elem.width) group.style.width = elem.width + 'px';
  if (elem.height) group.style.height = elem.height + 'px';

  addDragHandleIfMissing(group);
  makeDraggable(group);
  document.getElementById('slideArea').appendChild(group);
}

function restoreButton(elem) {
  const btn = document.createElement("button");
  btn.classList.add("draggable-btn");
  btn.textContent = elem.element_label || "ãƒœã‚¿ãƒ³";

  if (elem.width) btn.style.width = elem.width + "px";
  if (elem.height) btn.style.height = elem.height + "px";
  
  if (elem.style_data?.background) btn.style.background = elem.style_data.background;
  if (elem.style_data?.color) btn.style.color = elem.style_data.color;

  const targetSystemId = elem.element_config?.target_system_id;
  const algorithmId = elem.element_config?.algorithm_id;
  let algorithmXml = elem.element_config?.algorithm_xml;
  const buttonId = elem.element_config?.button_id;
  
  // algorithm_idãŒã‚ã‚‹ãŒalgorithm_xmlãŒãªã„å ´åˆã€algorithms_jsonã‹ã‚‰å–å¾—
  if (algorithmId && !algorithmXml) {
    try {
      const algorithms = {{ algorithms_json|safe }};
      const algorithm = algorithms.find(a => a.algorithm_id == algorithmId);
      if (algorithm && algorithm.blockly_xml) {
        algorithmXml = algorithm.blockly_xml;
        console.log('âœ… ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ XMLã‚’å–å¾—ã—ã¾ã—ãŸ:', algorithmId, 'XMLé•·:', algorithmXml.length);
      } else {
        console.warn('âš ï¸ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ XMLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', algorithmId);
      }
    } catch (error) {
      console.error('âŒ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ XMLå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    }
  }
  
  if (targetSystemId) {
    btn.setAttribute('data-target-system', targetSystemId);
  }
  if (algorithmId) {
    btn.setAttribute('data-algorithm-id', algorithmId);
  }
  if (algorithmXml) {
    btn.setAttribute('data-algorithm-xml', algorithmXml);
  }
  if (buttonId) {
    btn.setAttribute('data-button-id', buttonId);
  }

  btn.addEventListener('click', function(e) {
    e.stopPropagation();
    const isPreview = btn.closest('#previewSlideArea');
    
    console.log('ğŸ”˜ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ (å¾©å…ƒ):', {
      text: btn.textContent,
      isPreview: !!isPreview,
      algorithmId: algorithmId,
      algorithmXml: algorithmXml ? `${algorithmXml.length}æ–‡å­—` : 'ãªã—',
      targetSystemId: targetSystemId
    });
    
    if (isPreview) {
      if (algorithmId && algorithmXml) {
        // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ
        console.log('âœ… ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ:', algorithmId);
        executeAlgorithmFromButton(algorithmXml, btn.textContent);
      } else if (targetSystemId) {
        // ã‚·ã‚¹ãƒ†ãƒ é·ç§»
        console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ é·ç§»:', targetSystemId);
        loadSystemInPreview(targetSystemId);
      } else {
        console.warn('âš ï¸ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚‚ã‚·ã‚¹ãƒ†ãƒ ã‚‚è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
    } else {
      console.log('â„¹ï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒœã‚¿ãƒ³ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚å®Ÿè¡Œãƒœã‚¿ãƒ³ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ãã ã•ã„ã€‚');
    }
  });

  btn.style.left = elem.position_x + "px";
  btn.style.top = elem.position_y + "px";

  addDragHandleIfMissing(btn);
  makeDraggable(btn);
  document.getElementById("slideArea").appendChild(btn);
  
  // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã€ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã‚’è¡¨ç¤º
  if (algorithmId && typeof addAlgorithmIndicator === 'function') {
    addAlgorithmIndicator(btn);
  }
}

function restoreTextBox(elem) {
  const container = document.createElement('div');
  // ç·¨é›†ç”»é¢ã¨ã®ä¸€è²«æ€§ã®ãŸã‚.text-box-containerã‚’ä½¿ç”¨
  container.className = 'text-box-container';
  
  container.style.position = 'absolute';
  container.style.left = elem.position_x + 'px';
  container.style.top = elem.position_y + 'px';
  if (elem.width) container.style.width = elem.width + 'px';
  if (elem.height) container.style.height = elem.height + 'px';

  const ta = document.createElement('textarea');
  ta.className = 'text-box';
  ta.value = elem.element_value || '';
  ta.placeholder = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...';
  ta.spellcheck = false;
  ta.style.width = '100%';
  ta.style.height = '100%';
  ta.style.resize = 'none';
  ta.style.boxSizing = 'border-box';

  container.appendChild(ta);
  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById('slideArea').appendChild(container);
}

function restoreRoulette(elem) {
  const container = document.createElement("div");
  container.classList.add("roulette-container");
  
  const config = elem.element_config || {};
  const items = config.items || ['é …ç›®1', 'é …ç›®2', 'é …ç›®3'];
  
  container.setAttribute('data-roulette-items', JSON.stringify(items));
  container.setAttribute('data-roulette-spinning', 'false');
  
  // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å††ã‚’ä½œæˆï¼ˆSVGãƒ™ãƒ¼ã‚¹ï¼‰
  const wheel = document.createElement("div");
  wheel.classList.add("roulette-wheel");
  wheel.style.position = "relative";
  wheel.style.width = "200px";
  wheel.style.height = "200px";
  wheel.style.transition = "transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)";
  wheel.dataset.currentRotation = "0";
  
  const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  svg.setAttribute("width", "200");
  svg.setAttribute("height", "200");
  svg.setAttribute("viewBox", "0 0 200 200");
  
  const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52C41A'];
  const centerX = 100;
  const centerY = 100;
  const radius = 95;
  const anglePerSegment = (2 * Math.PI) / items.length;
  
  items.forEach((item, index) => {
    const startAngle = index * anglePerSegment - Math.PI / 2;
    const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
    
    const x1 = centerX + radius * Math.cos(startAngle);
    const y1 = centerY + radius * Math.sin(startAngle);
    const x2 = centerX + radius * Math.cos(endAngle);
    const y2 = centerY + radius * Math.sin(endAngle);
    
    const largeArcFlag = anglePerSegment > Math.PI ? 1 : 0;
    
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    path.setAttribute("d", `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
    path.setAttribute("fill", colors[index % colors.length]);
    path.setAttribute("stroke", "#fff");
    path.setAttribute("stroke-width", "2");
    svg.appendChild(path);
    
    const textAngle = startAngle + anglePerSegment / 2;
    const textRadius = radius * 0.65;
    const textX = centerX + textRadius * Math.cos(textAngle);
    const textY = centerY + textRadius * Math.sin(textAngle);
    
    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", textX);
    text.setAttribute("y", textY);
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("dominant-baseline", "middle");
    text.setAttribute("fill", "#fff");
    text.setAttribute("font-size", "14");
    text.setAttribute("font-weight", "bold");
    text.setAttribute("transform", `rotate(${(textAngle * 180 / Math.PI) + 90}, ${textX}, ${textY})`);
    text.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";
    text.textContent = item;
    svg.appendChild(text);
  });
  
  const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  circle.setAttribute("cx", centerX);
  circle.setAttribute("cy", centerY);
  circle.setAttribute("r", radius);
  circle.setAttribute("fill", "none");
  circle.setAttribute("stroke", "#333");
  circle.setAttribute("stroke-width", "4");
  svg.appendChild(circle);
  
  wheel.appendChild(svg);
  
  const pin = document.createElement("div");
  pin.style.position = "absolute";
  pin.style.top = "-15px";
  pin.style.left = "48%";
  pin.style.transform = "translateX(-50%)";
  pin.style.width = "0";
  pin.style.height = "0";
  pin.style.borderLeft = "10px solid transparent";
  pin.style.borderRight = "10px solid transparent";
  pin.style.borderTop = "20px solid #FF0000";
  pin.style.zIndex = "10";
  pin.style.pointerEvents = "none";
  
  const result = document.createElement("div");
  result.classList.add("roulette-result");
  result.style.marginTop = "10px";
  result.style.padding = "8px";
  result.style.background = "#f0f0f0";
  result.style.borderRadius = "4px";
  result.style.textAlign = "center";
  result.style.fontWeight = "bold";
  result.textContent = "çµæœ: -";
  
  const spinBtn = document.createElement("button");
  spinBtn.classList.add("roulette-btn", "spin");
  spinBtn.textContent = "ã‚¹ãƒ”ãƒ³";
  spinBtn.style.marginTop = "10px";
  spinBtn.style.padding = "8px 20px";
  spinBtn.style.fontSize = "16px";
  spinBtn.style.cursor = "pointer";
  spinBtn.style.position = "relative";
  spinBtn.style.zIndex = "100";
  spinBtn.onclick = function(e) {
    e.stopPropagation();
    const spinning = container.getAttribute('data-roulette-spinning') === 'true';
    if (spinning) return;
    
    container.setAttribute('data-roulette-spinning', 'true');
    spinBtn.disabled = true;
    spinBtn.style.cursor = 'not-allowed';
    spinBtn.style.opacity = '0.6';
    
    const currentRotation = parseFloat(wheel.dataset.currentRotation) || 0;
    const spins = 5 + Math.random() * 3;
    const extraDegrees = Math.random() * 360;
    const newRotation = currentRotation + spins * 360 + extraDegrees;
    
    wheel.style.transform = `rotate(${newRotation}deg)`;
    wheel.dataset.currentRotation = newRotation;
    
    setTimeout(() => {
      const finalAngle = ((newRotation % 360) + 360) % 360;
      const segmentAngle = 360 / items.length;
      const angleOnWheel = (270 - finalAngle + 360) % 360;
      const selectedIndex = Math.floor((angleOnWheel + 90) / segmentAngle) % items.length;
      
      result.textContent = `çµæœ: ${items[selectedIndex]}`;
      container.setAttribute('data-roulette-spinning', 'false');
      spinBtn.disabled = false;
      spinBtn.style.cursor = 'pointer';
      spinBtn.style.opacity = '1';
    }, 3000);
  };
  
  const wheelWrapper = document.createElement("div");
  wheelWrapper.style.position = "relative";
  wheelWrapper.style.pointerEvents = "none";
  wheelWrapper.appendChild(pin);
  wheelWrapper.appendChild(wheel);
  
  container.appendChild(wheelWrapper);
  container.appendChild(result);
  container.appendChild(spinBtn);
  
  container.style.left = elem.position_x + "px";
  container.style.top = elem.position_y + "px";
  if (elem.width) container.style.width = elem.width + "px";
  if (elem.height) container.style.height = elem.height + "px";

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById("slideArea").appendChild(container);
}

function restoreTimer(elem) {
  const container = document.createElement("div");
  container.classList.add("timer-container");
  
  const mode = elem.element_config?.mode || 'up';
  const targetSeconds = elem.element_config?.target || 0;
  
  container.setAttribute('data-timer-seconds', elem.element_value || '0');
  container.setAttribute('data-timer-running', 'false');
  container.setAttribute('data-timer-mode', mode);
  container.setAttribute('data-timer-target', targetSeconds.toString());

  const settingsBtn = document.createElement("button");
  settingsBtn.classList.add("timer-settings-btn");
  settingsBtn.textContent = "âš™ è¨­å®š";
  settingsBtn.title = "ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´";
  settingsBtn.onclick = function(e) {
    e.stopPropagation();
    openTimerSettings(container, display);
  };

  const display = document.createElement("div");
  display.classList.add("timer-display");
  
  const seconds = parseInt(elem.element_value || '0');
  const hDisp = Math.floor(seconds / 3600);
  const mDisp = Math.floor((seconds % 3600) / 60);
  const sDisp = seconds % 60;
  display.textContent = 
    String(hDisp).padStart(2, '0') + ':' +
    String(mDisp).padStart(2, '0') + ':' +
    String(sDisp).padStart(2, '0');

  const controls = document.createElement("div");
  controls.classList.add("timer-controls");

  const startBtn = document.createElement("button");
  startBtn.classList.add("timer-btn", "start");
  startBtn.textContent = "é–‹å§‹";
  startBtn.onclick = function(e) {
    e.stopPropagation();
    const running = container.getAttribute('data-timer-running') === 'true';
    const timerMode = container.getAttribute('data-timer-mode');
    
    if (!running) {
      if (timerMode === 'down') {
        const target = parseInt(container.getAttribute('data-timer-target') || '0');
        if (target === 0) {
          alert('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
          return;
        }
      }
      container.setAttribute('data-timer-running', 'true');
      startBtn.textContent = "åœæ­¢";
      startBtn.classList.remove('start');
      startBtn.classList.add('pause');
    } else {
      container.setAttribute('data-timer-running', 'false');
      startBtn.textContent = "é–‹å§‹";
      startBtn.classList.remove('pause');
      startBtn.classList.add('start');
    }
  };

  const resetBtn = document.createElement("button");
  resetBtn.classList.add("timer-btn", "reset");
  resetBtn.textContent = "ãƒªã‚»ãƒƒãƒˆ";
  resetBtn.onclick = function(e) {
    e.stopPropagation();
    const timerMode = container.getAttribute('data-timer-mode');
    container.setAttribute('data-timer-running', 'false');
    
    if (timerMode === 'up') {
      container.setAttribute('data-timer-seconds', '0');
      display.textContent = "00:00:00";
    } else {
      const target = parseInt(container.getAttribute('data-timer-target') || '0');
      container.setAttribute('data-timer-seconds', target.toString());
      const h = Math.floor(target / 3600);
      const m = Math.floor((target % 3600) / 60);
      const s = target % 60;
      display.textContent = 
        String(h).padStart(2, '0') + ':' +
        String(m).padStart(2, '0') + ':' +
        String(s).padStart(2, '0');
    }
    
    startBtn.textContent = "é–‹å§‹";
    startBtn.classList.remove('pause');
    startBtn.classList.add('start');
  };

  controls.appendChild(startBtn);
  controls.appendChild(resetBtn);
  
  container.appendChild(settingsBtn);
  container.appendChild(display);
  container.appendChild(controls);

  container.style.left = elem.position_x + 'px';
  container.style.top = elem.position_y + 'px';
  if (elem.width) container.style.width = elem.width + 'px';
  if (elem.height) container.style.height = elem.height + 'px';

  addDragHandleIfMissing(container);
  makeDraggable(container);
  document.getElementById('slideArea').appendChild(container);
}

// ========================================
// å›³å½¢è¦ç´ ã®å¾©å…ƒ
// ========================================
function restoreShape(elem) {
  const slide = document.getElementById('slideArea');
  if (!slide) return;

  const shapeType = elem.element_config?.shape_type || 'rectangle';
  const shapeColor = elem.element_config?.color || '#333333';
  const shapeFill = elem.element_config?.fill_color || 'transparent';

  const shape = document.createElement('div');
  shape.className = `shape-element shape-${shapeType}`;
  shape.setAttribute('data-shape-type', shapeType);
  shape.setAttribute('data-shape-color', shapeColor);
  shape.setAttribute('data-shape-fill', shapeFill);

  // ä½ç½®ã‚’è¨­å®š
  shape.style.left = elem.position_x + 'px';
  shape.style.top = elem.position_y + 'px';

  // å›³å½¢ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚µã‚¤ã‚ºã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
  switch (shapeType) {
    case 'rectangle':
      shape.style.width = elem.width + 'px';
      shape.style.height = elem.height + 'px';
      shape.style.borderColor = shapeColor;
      shape.style.background = shapeFill;
      break;

    case 'circle':
      shape.style.width = elem.width + 'px';
      shape.style.height = elem.width + 'px'; // å††ã¯å¹…ã¨é«˜ã•ãŒåŒã˜
      shape.style.borderColor = shapeColor;
      shape.style.background = shapeFill;
      break;

    case 'triangle':
      // ä¸‰è§’å½¢ã¯ç‰¹æ®Šãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨
      const height = elem.height || 87;
      const width = elem.width || 100;
      shape.style.width = '0px';
      shape.style.height = '0px';
      shape.style.borderLeftWidth = (width / 2) + 'px';
      shape.style.borderRightWidth = (width / 2) + 'px';
      shape.style.borderBottomWidth = height + 'px';
      shape.style.borderLeftColor = 'transparent';
      shape.style.borderRightColor = 'transparent';
      shape.style.borderBottomColor = shapeColor;
      shape.style.borderTopWidth = '0px';
      break;

    case 'line':
      shape.style.width = elem.width + 'px';
      shape.style.height = elem.height + 'px';
      shape.style.background = shapeColor;
      shape.style.border = 'none';
      break;

    case 'arrow':
      shape.style.width = elem.width + 'px';
      shape.style.height = elem.height + 'px';
      
      // çŸ¢å°ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‹•çš„ã«é©ç”¨
      if (typeof updateArrowStyles === 'function') {
        updateArrowStyles(shape, shapeColor);
      } else {
        // updateArrowStylesãŒå­˜åœ¨ã—ãªã„å ´åˆã®ä»£æ›¿
        const styleId = 'arrow-' + Date.now();
        shape.setAttribute('data-style-id', styleId);
        const styleEl = document.createElement('style');
        styleEl.id = styleId;
        styleEl.textContent = `
          [data-style-id="${styleId}"]::before {
            content: '';
            flex: 1;
            height: 2px;
            background: ${shapeColor};
          }
          [data-style-id="${styleId}"]::after {
            content: '';
            width: 0;
            height: 0;
            border-left: 10px solid ${shapeColor};
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
          }
        `;
        document.head.appendChild(styleEl);
      }
      break;
  }

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
  shape.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    if (typeof openShapeSettings === 'function') {
      openShapeSettings(shape);
    }
  });

  // å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
  shape.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (typeof openShapeSettings === 'function') {
      openShapeSettings(shape);
    }
  });

  addDragHandleIfMissing(shape);
  makeDraggable(shape);
  slide.appendChild(shape);

  // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã‚’è¿½åŠ 
  if (typeof attachResizeHandlers === 'function') {
    attachResizeHandlers(shape, shapeType);
  }

  console.log('âœ… å›³å½¢ã‚’å¾©å…ƒ:', { type: shapeType, color: shapeColor, x: elem.position_x, y: elem.position_y });
}

// ========================================
// ç”»åƒè¦ç´ ã®å¾©å…ƒ
// ========================================
function restoreImage(elem) {
  const slide = document.getElementById('slideArea');
  if (!slide) return;

  const imageSrc = elem.element_value;
  if (!imageSrc) {
    console.warn('âš ï¸ ç”»åƒã®ã‚½ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }

  const container = document.createElement('div');
  container.className = 'image-element';
  container.setAttribute('data-image-src', imageSrc);

  const img = document.createElement('img');
  img.src = imageSrc;
  img.style.pointerEvents = 'none'; // ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã«ç”»åƒãŒãƒ‰ãƒ©ãƒƒã‚°ã•ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹

  container.appendChild(img);

  // ä½ç½®ã¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
  container.style.left = elem.position_x + 'px';
  container.style.top = elem.position_y + 'px';
  container.style.width = elem.width + 'px';
  container.style.height = elem.height + 'px';

  // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
  container.addEventListener('dblclick', function(e) {
    e.stopPropagation();
    if (typeof openImageSettings === 'function') {
      openImageSettings(container);
    }
  });

  // å³ã‚¯ãƒªãƒƒã‚¯ã§ã‚‚è¨­å®šãƒ‘ãƒãƒ«ã‚’é–‹ã
  container.addEventListener('contextmenu', function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (typeof openImageSettings === 'function') {
      openImageSettings(container);
    }
  });

  addDragHandleIfMissing(container);
  makeDraggable(container);
  slide.appendChild(container);

  // ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ã‚’è¿½åŠ 
  if (typeof attachResizeHandlers === 'function') {
    attachResizeHandlers(container, 'image');
  }

  console.log('âœ… ç”»åƒã‚’å¾©å…ƒ:', { src: imageSrc.substring(0, 50) + '...', x: elem.position_x, y: elem.position_y });
}

// ========================================
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚: ä»®ä¿å­˜å¾Œã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ä½œæˆç”»é¢ã¸ã®é·ç§»
// ========================================
document.addEventListener('DOMContentLoaded', function() {
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã« pending_algorithm_action ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const pendingAction = sessionStorage.getItem('pending_algorithm_action');
  const pendingButtonId = sessionStorage.getItem('pending_algorithm_button_id');
  
  if (pendingAction === 'create' && pendingButtonId) {
    console.log('ğŸ’¾ ä»®ä¿å­˜å¾Œã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ä½œæˆç”»é¢ã¸ã®è‡ªå‹•é·ç§»ã‚’å®Ÿè¡Œ');
    
    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    sessionStorage.removeItem('pending_algorithm_action');
    sessionStorage.removeItem('pending_algorithm_button_id');
    
    // URLã‹ã‚‰system_idã‚’å–å¾—
    const systemId = window.getSystemIdFromUrl();
    if (systemId) {
      const url = `/accounts/block/?system_id=${systemId}&button_id=${pendingButtonId}&action=create`;
      console.log('ğŸ”— è‡ªå‹•é·ç§»å…ˆ:', url);
      window.location.href = url;
    } else {
      console.error('âŒ System ID ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
  }
});
</script>
