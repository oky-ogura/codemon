{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_blue.png' %}" 
     alt="" 
     class="bg-frame"
     onerror="this.style.display='none';">
{% endblock %}

{% block title %}システム作成 - Codemon{% endblock %}

{% block extra_css %}
<link href="{% static 'codemon/css/tutorial_overlay.css' %}" rel="stylesheet">
{% include 'system/_styles.html' %}
{% endblock %}

{% block content %}
{% include 'system/_content.html' %}
{% endblock %}

{% block extra_js %}
{% include 'system/_blockly_loader.html' %}
{% include 'system/_drag_drop.html' %}
{% include 'system/_history.html' %}
{% include 'system/_preview.html' %}
{% include 'system/_element_creators.html' %}
{% include 'system/_initialization.html' %}

<script src="{% static 'codemon/js/tutorial_overlay.js' %}"></script>
<script>
console.log('システム編集画面を読み込みました');

// getCookie関数を定義（グローバルスコープ）
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// STEP2チュートリアル関数を定義（グローバルスコープ）
function startStep2Tutorial() {
  // チュートリアル状態管理
  window.tutorialState = {
    isActive: true,
    waitingForColorChange: false,
    waitingForSizeChange: false,
    waitingForTextInput: false,
    targetColor: '#ff0000',
    targetSize: 150
  };
  
  const steps = [
    {
      target: null,
      centerMessage: true,
      message: 'それでは、じっさいに クイズシステムを つくって みましょう！<br><br>まずは 「せいかい」がめんを つくります。',
      nextText: 'つぎへ',
      onNext: null
    },
    {
      target: '#executeBtn',
      message: 'これは じっこうボタンだよ。<br>つくった システムを うごかすことが できるよ。<br><br>いまは まだ つかわないで OK！',
      nextText: 'わかった',
      onNext: null
    },
    {
      target: '#saveBtn',
      message: 'これは ほぞんボタンだよ。<br>つくった システムを ほぞんするときに つかうよ。',
      nextText: 'わかった',
      onNext: null
    },
    
    // === せいかい画面の作成開始 ===
    {
      target: null,
      centerMessage: true,
      message: 'それでは、せいかいがめんを つくりましょう！<br><br>まずは まるい かたちを えらびます。',
      nextText: 'つぎへ',
      onNext: null
    },
    {
      target: '#shapeBtn',
      message: 'この ずけい ボタンを クリックして、<br>メニューを ひらいてください！',
      messagePosition: 'left', // パネルを左寄せ
      requireClick: true,
      onNext: function() {
        // 図形メニューを開く
        const shapeBtn = document.getElementById('shapeBtn');
        if (shapeBtn && (!shapeBtn.getAttribute('aria-expanded') || shapeBtn.getAttribute('aria-expanded') === 'false')) {
          shapeBtn.click();
        }
        // 自動で次のステップへ
        setTimeout(() => {
          tutorialOverlay.next();
        }, 300);
      }
    },
    {
      target: '#addCircleBtn',
      message: 'メニューから「えん」を クリックして ください！',
      requireClick: true,
      onNext: function() {
        console.log('🔵 ステップ6: 円ボタンがクリックされました');
        
        // 円が配置されるのを待つ
        let checkCount = 0;
        const maxChecks = 20;
        
        const waitForCircle = setInterval(() => {
          checkCount++;
          const circles = document.querySelectorAll('[data-shape-type="circle"]');
          
          if (circles.length > 0 || checkCount >= maxChecks) {
            clearInterval(waitForCircle);
            
            if (circles.length > 0) {
              const lastCircle = circles[circles.length - 1];
              console.log('✅ 円が配置されました:', lastCircle);
              
              // 円の位置を取得して保存
              window.tutorialState.createdCircle = lastCircle;
              
              // キャンバス全体を取得
              window.tutorialState.canvas = document.querySelector('.main-area');
              
              console.log('🔍 tutorialOverlay.currentStep:', tutorialOverlay.currentStep);
              console.log('🔍 tutorialOverlay.steps.length:', tutorialOverlay.steps.length);
              
              // 次のステップへ進む
              setTimeout(() => {
                console.log('➡️ ステップ7（円フォーカス）へ進みます - next()呼び出し前');
                tutorialOverlay.next();
                console.log('✅ next()呼び出し完了 - 現在のステップ:', tutorialOverlay.currentStep);
              }, 500);
            } else {
              console.warn('⚠️ 円が見つかりませんでした。次のステップへ進みます。');
              tutorialOverlay.next();
            }
          }
        }, 100);
      }
    },
    {
      target: '.main-area', // キャンバス全体をターゲットにする
      centerMessage: false,
      message: 'まるが がめんに でてきましたね！<br><br>つぎは、この まるを みぎクリックして、<br>「へんしゅう」パネルを ひらいてください。',
      messagePosition: 'left', // 円の左側に表示
      nextText: null,
      showSkip: false,
      onShow: function() {
        console.log('🎯 ステップ7: 円フォーカス開始');
        
        // 作成された円とキャンバスを取得
        const circle = window.tutorialState.createdCircle;
        const canvas = window.tutorialState.canvas;
        
        if (circle && canvas) {
          console.log('🎯 円とキャンバスをフォーカスします:', circle, canvas);
          
          // 円をハイライト（円が操作対象であることを示す）
          tutorialOverlay.positionHighlight(circle);
          tutorialOverlay.positionOverlayParts(circle);
          
          // メッセージボックスを円の左側に表示
          const circleRect = circle.getBoundingClientRect();
          const messageBox = tutorialOverlay.messageBox;
          
          // メッセージ内容を構築
          messageBox.innerHTML = `
            <div class="tutorial-step-indicator">
              STEP ${tutorialOverlay.currentStep + 1} / ${tutorialOverlay.steps.length}
            </div>
            <div class="tutorial-message-content">
              まるが がめんに でてきましたね！<br><br>つぎは、この まるを みぎクリックして、<br>「へんしゅう」パネルを ひらいてください。
            </div>
            <div class="tutorial-buttons">
              <button class="tutorial-btn tutorial-btn-skip" onclick="tutorialOverlay.skip()">とばす</button>
            </div>
          `;
          
          // 円の左側に配置（画面内に収まるように）
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          
          messageBox.style.display = 'block';
          messageBox.style.visibility = 'hidden';
          const messageRect = messageBox.getBoundingClientRect();
          
          // 円の左側に配置
          let left = circleRect.left - messageRect.width - 20;
          let top = circleRect.top;
          
          // 左側にスペースがない場合は右側に配置
          if (left < 20) {
            left = circleRect.right + 20;
            if (left + messageRect.width > viewportWidth - 20) {
              // 右側にもスペースがない場合は下に配置
              left = circleRect.left;
              top = circleRect.bottom + 20;
            }
          }
          
          // 上下の調整
          if (top + messageRect.height > viewportHeight - 20) {
            top = viewportHeight - messageRect.height - 20;
          }
          if (top < 20) {
            top = 20;
          }
          
          messageBox.style.top = `${top}px`;
          messageBox.style.left = `${left}px`;
          messageBox.style.visibility = 'visible';
          messageBox.className = 'tutorial-message';
          
          console.log('✅ 円フォーカス表示完了');
          
          // 編集パネルの監視を開始
          console.log('🔍 ステップ7: 編集パネルを待機中...');
          window.tutorialState.waitingForRightClick = true;
          
          const checkForPanel = setInterval(() => {
            const panel = document.querySelector('.shape-settings-panel');
            if (panel) {
              clearInterval(checkForPanel);
              console.log('✅ 編集パネルが開きました');
              
              // パネルが開いたら自動で次のステップへ
              setTimeout(() => {
                console.log('➡️ 次のステップ（色と大きさ変更）へ進みます');
                tutorialOverlay.next();
              }, 300);
            }
          }, 100);
        } else {
          console.warn('⚠️ 円またはキャンバスが見つかりません');
        }
      }
    },
    {
      target: '.shape-settings-panel',
      centerMessage: false,
      message: 'すばらしい！<br><br>それでは、まるの「いろ」と「おおきさ」を かえましょう！<br><br><strong>【いろ】</strong><br>RGBで <strong>255, 0, 0</strong> と にゅうりょくするか、<br>カラーピッカーで <strong>あか</strong>を えらんでください。<br><br><strong>【おおきさ】</strong><br><strong>150</strong> に してください。<br><br>できたら、したの <strong>「てきよう」ボタン</strong>を おしてください！',
      messagePosition: 'left',
      nextText: null,
      showSkip: false,
      onShow: function() {
        console.log('🎨 ステップ8: 色と大きさ変更開始');
        
        // 編集パネルの上側にフォーカス
        const panel = document.querySelector('.shape-settings-panel');
        if (panel) {
          console.log('🎨 編集パネルの上側にフォーカスします');
          tutorialOverlay.positionHighlight(panel);
          tutorialOverlay.positionOverlayParts(panel);
          
          // メッセージボックスをパネルの左側に配置
          const rect = panel.getBoundingClientRect();
          const messageBox = tutorialOverlay.messageBox;
          
          messageBox.style.display = 'block';
          messageBox.style.left = '20px';
          messageBox.style.top = `${Math.max(20, rect.top)}px`;
          messageBox.style.visibility = 'visible';
          
          console.log('✅ 色と大きさ変更のメッセージ表示完了');
          
          // 適用ボタンの監視を開始
          console.log('🎨 ステップ8: 適用ボタンを待機中...');
          window.tutorialState.waitingForColorAndSizeChange = true;
          
          const checkApplyButton = setInterval(() => {
            const applyBtn = document.getElementById('shapeApplyBtn');
            
            if (applyBtn) {
              if (!applyBtn.dataset.tutorialListenerAdded) {
                // 適用ボタンにイベントリスナーを追加（一度だけ）
                applyBtn.dataset.tutorialListenerAdded = 'true';
                
                const applyClickHandler = function(e) {
                  console.log('✅ 適用ボタンが押されました');
                  clearInterval(checkApplyButton);
                  window.tutorialState.waitingForColorAndSizeChange = false;
                  
                  // パネルが閉じるのを待ってから次のステップへ
                  setTimeout(() => {
                    console.log('➡️ 次のステップ（フォームボタン）へ進みます');
                    tutorialOverlay.next();
                  }, 500);
                  
                  // イベントリスナーを削除
                  applyBtn.removeEventListener('click', applyClickHandler);
                  delete applyBtn.dataset.tutorialListenerAdded;
                };
                
                applyBtn.addEventListener('click', applyClickHandler);
                console.log('🔧 適用ボタンにイベントリスナーを追加しました');
              }
            }
          }, 100);
        } else {
          console.warn('⚠️ 編集パネルが見つかりません');
        }
      }
    },
    {
      target: '#formBtn',
      message: 'すばらしい！<br><br>つぎは もじを いれる はこを つくります。<br>この フォーム ボタンを クリックして ください！',
      messagePosition: 'left',
      requireClick: true,
      onNext: function() {
        // フォームメニューを開く
        const formBtn = document.getElementById('formBtn');
        if (formBtn && (!formBtn.getAttribute('aria-expanded') || formBtn.getAttribute('aria-expanded') === 'false')) {
          formBtn.click();
        }
        // 自動で次のステップへ
        setTimeout(() => {
          tutorialOverlay.next();
        }, 300);
      }
    },
    {
      target: '#addTextBoxBtn',
      message: 'メニューから「テキストボックス」を クリックして ください！',
      messagePosition: 'left',
      requireClick: true,
      onNext: function() {
        // テキストボックスボタンクリック後、自動で次へ
        setTimeout(() => {
          tutorialOverlay.next();
        }, 300);
      }
    },
    {
      target: '.main-area',
      centerMessage: false,
      message: 'がめんを クリックして、<br>カーソルを うごかして、<br>テキストボックスを はいち してください！',
      messagePosition: 'left',
      nextText: null,
      showSkip: false,
      onShow: function() {
        console.log('📝 ステップ10: テキストボックス配置開始');
        
        // 初期のテキストボックス数を記録
        const initialTextBoxCount = document.querySelectorAll('.text-box-container').length;
        window.tutorialState.initialTextBoxCount = initialTextBoxCount;
        
        console.log(`🔍 初期テキストボックス数: ${initialTextBoxCount}`);
        
        // テキストボックス配置を監視
        const checkTextBoxPlacement = setInterval(() => {
          const textBoxes = document.querySelectorAll('.text-box-container');
          console.log(`🔍 現在のテキストボックス数: ${textBoxes.length}`);
          
          if (textBoxes.length > initialTextBoxCount) {
            clearInterval(checkTextBoxPlacement);
            console.log('✅ テキストボックスが配置されました');
            
            // 最新のテキストボックスを保存
            window.tutorialState.createdTextBox = textBoxes[textBoxes.length - 1];
            
            // 自動で次のステップへ
            setTimeout(() => {
              console.log('➡️ 次のステップ（テキスト入力）へ進みます');
              tutorialOverlay.next();
            }, 500);
          }
        }, 100);
      }
    },
    {
      target: '.text-box-container',
      centerMessage: false,
      message: 'テキストボックスが はいち できましたね！<br><br>このテキストボックスを クリックして、<br>「せいかい！」と にゅうりょく してください！',
      messagePosition: 'right',
      nextText: null,
      showSkip: false,
      onShow: function() {
        console.log('✏️ ステップ11: テキスト入力開始');
        
        // 作成されたテキストボックスを取得
        const textBox = window.tutorialState.createdTextBox;
        
        if (textBox) {
          console.log('🎯 テキストボックスをフォーカスします:', textBox);
          
          // テキストボックスをハイライト
          tutorialOverlay.positionHighlight(textBox);
          tutorialOverlay.positionOverlayParts(textBox);
          
          // メッセージボックスをテキストボックスの右側に表示
          const rect = textBox.getBoundingClientRect();
          const messageBox = tutorialOverlay.messageBox;
          
          // メッセージ内容を構築
          messageBox.innerHTML = `
            <div class="tutorial-step-indicator">
              STEP ${tutorialOverlay.currentStep + 1} / ${tutorialOverlay.steps.length}
            </div>
            <div class="tutorial-message-content">
              テキストボックスが はいち できましたね！<br><br>このテキストボックスを クリックして、<br>「せいかい！」と にゅうりょく してください！
            </div>
            <div class="tutorial-buttons">
              <button class="tutorial-btn tutorial-btn-skip" onclick="tutorialOverlay.skip()">とばす</button>
            </div>
          `;
          
          // テキストボックスの右側に配置
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          
          messageBox.style.display = 'block';
          messageBox.style.visibility = 'hidden';
          const messageRect = messageBox.getBoundingClientRect();
          
          let left = rect.right + 20;
          let top = rect.top;
          
          // 右側にスペースがない場合は左側に配置
          if (left + messageRect.width > viewportWidth - 20) {
            left = rect.left - messageRect.width - 20;
            if (left < 20) {
              // 左側にもスペースがない場合は下に配置
              left = rect.left;
              top = rect.bottom + 20;
            }
          }
          
          // 上下の調整
          if (top + messageRect.height > viewportHeight - 20) {
            top = viewportHeight - messageRect.height - 20;
          }
          if (top < 20) {
            top = 20;
          }
          
          messageBox.style.top = `${top}px`;
          messageBox.style.left = `${left}px`;
          messageBox.style.visibility = 'visible';
          messageBox.className = 'tutorial-message';
          
          console.log('✅ テキストボックスフォーカス表示完了');
        } else {
          console.warn('⚠️ テキストボックスが見つかりません');
        }
        
        // テキスト入力を監視
        console.log('🔍 ステップ11: テキスト入力を待機中...');
        window.tutorialState.waitingForTextInput = true;
        
        const checkTextInput = setInterval(() => {
          const textAreas = document.querySelectorAll('.text-box');
          let textCorrect = false;
          
          textAreas.forEach(textArea => {
            const value = textArea.value.trim();
            if (value.includes('せいかい！') || value.includes('せいかい!') || value.includes('せいかい')) {
              textCorrect = true;
            }
          });
          
          if (textCorrect) {
            clearInterval(checkTextInput);
            console.log('✅ 正しいテキストが入力されました');
            window.tutorialState.waitingForTextInput = false;
            
            // 次のステップへ
            setTimeout(() => {
              console.log('➡️ 次のステップ（保存）へ進みます');
              tutorialOverlay.next();
            }, 500);
          }
        }, 100);
      }
    },
    {
      target: '#saveBtn',
      message: 'よくできました！<br><br>それでは、ほぞんボタンを おして、<br>「せいかい」という なまえで ほぞん してください！',
      nextText: 'わかった',
      showNextButton: false,
      onShow: function() {
        console.log('💾 ステップ12: 保存ボタン説明');
        
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) {
          // 保存ボタンをハイライト
          tutorialOverlay.positionHighlight(saveBtn);
          tutorialOverlay.positionOverlayParts(saveBtn);
          
          // 保存ボタンクリック監視
          const saveClickHandler = function(e) {
            console.log('✅ 保存ボタンがクリックされました');
            
            // チュートリアルを終了
            tutorialOverlay.end();
            
            // せいかい保存画面のチュートリアルフラグを設定
            sessionStorage.setItem('tutorial_step2_seikai_save', 'true');
            console.log('📝 tutorial_step2_seikai_save フラグを設定しました');
            
            // 保存処理を続行
            saveBtn.removeEventListener('click', saveClickHandler);
          };
          
          saveBtn.addEventListener('click', saveClickHandler);
        }
      }
    }
  ];
  
  tutorialOverlay.init(steps, {
    onComplete: function() {
      console.log('✅ STEP2チュートリアル完了');
    },
    onSkip: function() {
      if (confirm('チュートリアルを とちゅうで やめますか？')) {
        fetch('/accounts/skip-tutorial-step/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ step: 2 })
        });
        return true;
      }
      return false;
    }
  });
}

// STEP2チュートリアル起動処理
(function() {
  const shouldStartStep2 = sessionStorage.getItem('tutorial_step2_start');
  console.log('🔍 tutorial_step2_start チェック:', shouldStartStep2);
  
  if (shouldStartStep2 === 'true') {
    console.log('✅ STEP2チュートリアル開始準備 (system/index.html)');
    sessionStorage.removeItem('tutorial_step2_start');
    
    // チュートリアルを開始する関数
    function initTutorial() {
      console.log('🚀 チュートリアル初期化開始');
      
      // tutorialOverlayが読み込まれているか確認
      if (typeof tutorialOverlay === 'undefined') {
        console.error('❌ tutorialOverlay not found');
        return;
      }
      
      // 必要な要素が存在するか確認
      const executeBtn = document.getElementById('executeBtn');
      const saveBtn = document.getElementById('saveBtn');
      const shapeBtn = document.getElementById('shapeBtn');
      
      console.log('📋 要素確認:', {
        executeBtn: !!executeBtn,
        saveBtn: !!saveBtn,
        shapeBtn: !!shapeBtn
      });
      
      if (executeBtn && saveBtn && shapeBtn) {
        console.log('✅ すべての要素が準備完了、チュートリアル開始');
        setTimeout(() => {
          startStep2Tutorial();
        }, 500);
      } else {
        console.warn('⚠️ 要素が見つかりません、再試行します');
        setTimeout(initTutorial, 500);
      }
    }
    
    // ページの読み込み状態に応じて実行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTutorial);
    } else if (document.readyState === 'interactive' || document.readyState === 'complete') {
      // 既に読み込み済みの場合は即実行
      setTimeout(initTutorial, 1000);
    }
  }
})();
</script>
{% endblock %}

{% block ai_chat_widget %}
  {% include 'includes/ai_chat_base.html' %}
{% endblock %}
