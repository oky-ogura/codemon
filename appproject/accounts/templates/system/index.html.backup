{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_blue.png' %}" 
     alt="" 
     class="bg-frame"
     onerror="this.style.display='none';">
{% endblock %}

{% block title %}ã‚·ã‚¹ãƒ†ãƒ ä½œæˆ - Codemon{% endblock %}

{% block extra_css %}
{% include 'system/_styles.html' %}
  /* Blocklyã¯å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã‚€ */
  :root { --nav-height:56px; --primary:#1976d2; --bg:#f9f9fb; --muted:#666; }

  /* ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
  body {
    overflow: visible !important;
    height: auto !important;
  }

  /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤ºçŠ¶æ…‹ã®åˆ¶å¾¡ */
  .top-tabs {
    display: block; /* å¸¸ã«è¡¨ç¤º */
  }

  /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å…¨ä½“ã®é…ç½® */
  .content-wrapper {
    display: flex;
    flex-direction: row; /* æ¨ªä¸¦ã³ã«å¤‰æ›´ */
    align-items: flex-start;
    justify-content: center;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding-top: 60px !important; /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã¨é©åº¦ãªé–“éš”ã‚’ä¿ã¤ */
    padding-bottom: 40px;
    min-height: auto;
    overflow-y: visible;
    gap: 20px;
  }

  /* å·¦å´ã®ãƒœã‚¿ãƒ³ãƒãƒ¼ï¼ˆç¸¦ä¸¦ã³ï¼‰ */
  .button-bar {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 180px;
    flex-shrink: 0;
    margin-top: 0; /* ãƒœã‚¿ãƒ³ãƒãƒ¼ã‚’ä¸Šã«ç§»å‹• */
  }

  /* çŸ¢å°ãƒœã‚¿ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
  .undo-redo-btns {
    display: flex;
    gap: 5px;
    margin-bottom: 5px;
  }

  .undo-redo-btns button {
    flex: 1;
    font-size: 15px;
    padding: 7px;
    border-radius: 4px;
    border: 1px solid #bbb;
    background: #f5f5f5;
    cursor: pointer;
    transition: background 0.2s;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .undo-redo-btns button:hover {
    background: #e0e0e0;
  }

  .button-bar button {
    width: 100%;
    font-size: 15px;
    padding: 9px 16px;
    border-radius: 4px;
    border: 1px solid #bbb;
    background: #f5f5f5;
    cursor: pointer;
    transition: background 0.2s;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .button-bar button:hover {
    background: #e0e0e0;
  }

  .button-bar button.active {
    background:#1976d2;
    color:#fff;
    box-shadow:0 6px 16px rgba(25,118,210,0.12);
  }

  /* å·¦å´ãƒœã‚¿ãƒ³ãƒãƒ¼å†…ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .button-bar #saveBtn {
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 100%;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .button-bar #saveBtn img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .button-bar #saveBtn:hover {
    opacity: 0.8;
  }

  .button-bar #executeBtn {
    background: transparent;
    border: none;
    padding: 0;
    cursor: pointer;
    width: 100%;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .button-bar #executeBtn img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .button-bar #executeBtn:hover {
    opacity: 0.8;
  }

  /* å³å´ã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
  .main-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 860px;
  }

    /* ãƒ•ã‚©ãƒ¼ãƒ ç”¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ */
    .form-dropdown {
      position: relative;
      display: inline-block;
    }
    .form-dropdown .dropdown-menu {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.08);
      padding: 6px;
      min-width: 180px;
      z-index: 1200;
      display: none;
    }
    .form-dropdown .dropdown-menu.show {
      display: block;
    }
    .form-dropdown .dropdown-menu button {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px 10px;
      margin: 4px 0;
      background: #fff;
      border: 1px solid #eee;
      border-radius: 4px;
      cursor: pointer;
    }
    .form-dropdown .dropdown-menu button:hover {
      background: #f0f6ff;
      color: var(--primary);
    }

    /* checkbox / radio create panel (å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ) */
    .create-options-panel {
      position: absolute;
      top: calc(100% + 8px);
      left: 190px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      padding: 10px;
      z-index: 1300;
      min-width: 220px;
      display: none;
    }
    .create-options-panel.show { display: block; }
    .create-options-panel label { display:block; margin-bottom:6px; color:#333; font-size:13px; }
    .create-options-panel input[type="number"] { width: 80px; padding:4px 6px; margin-right:8px; }
    .create-options-panel .panel-actions { margin-top:8px; display:flex; gap:8px; justify-content:flex-end; }

    .shortcut-bar {
      width: 860px;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 16px;
      margin-top: 0;
    }
    .shortcut-bar button {
      margin-right: 10px;
      font-size: 18px;
      padding: 6px 18px;
      border-radius: 4px;
      border: 1px solid #bbb;
      background: #f5f5f5;
      cursor: pointer;
      transition: background 0.2s;
    }
    .shortcut-bar button:hover {
      background: #e0e0e0;
    }
    .shortcut-bar .shortcut-label {
      font-size: 14px;
      color: #555;
      margin-right: 20px;
    }

    /* æ—¢å­˜ã®é’ã„ä¿å­˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå‚ç…§ç”¨ï¼‰ */
    .shortcut-save {
      padding: 10px 18px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid rgba(10,59,110,0.08);
      background: linear-gradient(180deg,#cfe7ff,#b6d9ff);
      color: #0a3b6e;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(10,59,110,0.06);
      margin-left: 6px;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .shortcut-save:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(10,59,110,0.10);
    }
    .shortcut-save[aria-disabled="true"]{
      opacity: 0.7;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    /* ã”å¸Œæœ›ã®ç·‘ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå„ªå…ˆçš„ã«é©ç”¨ã•ã‚Œã‚‹ã‚ˆã†ã‚»ãƒ¬ã‚¯ã‚¿ã‚’å…·ä½“åŒ–ï¼‰ */
    .shortcut-bar .shortcut-btns #saveBtn {
      font-size: 18px;
      margin-left: 8px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 14px;
      cursor: pointer;
    }
    .shortcut-bar .shortcut-btns #saveBtn:hover {
      background: #1e7e34;
    }

    /* å…¨å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .shortcut-bar .shortcut-btns #clearAllBtn {
      font-size: 18px;
      margin-left: 8px;
      background: #dc3545;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 16px;
      cursor: pointer;
    }
    .shortcut-bar .shortcut-btns #clearAllBtn:hover {
      background: #c82333;
    }

    /* Run/å®Ÿè¡Œ ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ã‚’çµ±ä¸€ */
    .shortcut-bar .shortcut-btns #executeBtn {
      font-size: 18px;
      margin-left: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 16px;
      cursor: pointer;
    }
    .shortcut-bar .shortcut-btns #executeBtn:hover {
      background: #0056b3;
    }
    #slideArea {
      width: 860px;
      height: 440px;
      border: 2px dashed #666;
      position: relative;
      background-color: #fdfdfd;
      overflow: hidden;
      margin: 0 auto 20px auto;
      display: block;
      flex-shrink: 0;
    }

    .input-container {
      position: absolute;
      display: flex;
      align-items: center;
      min-width: 180px;
      min-height: 40px;
      cursor: grab;
      box-sizing: border-box;
      left: 0;
      top: 0;
    }

    .input-container.grabbing { cursor: grabbing; }

    .input-label {
      margin-right: 5px;
      white-space: nowrap;
      padding: 2px 4px;
      border: 1px dashed transparent;
      min-width: 40px;
    }
    .input-label[contenteditable="true"]:focus {
      outline: none;
      border: 1px dashed #999;
      background: #f0f0f0;
    }

    .input-box {
      resize: like;
      overflow: auto;
      min-width: 120px;
      min-height: 40px;
      padding: 5px;
      box-sizing: border-box;
    }

    /* checkbox / radio group: èƒŒæ™¯ãƒ»æ ãƒ»å½±ã‚’å®Œå…¨ã«éè¡¨ç¤º */
    .checkbox-group,
    .radio-group {
      position: absolute;
      min-width: 140px;
      background: transparent !important; /* èƒŒæ™¯ã‚’é€æ˜åŒ– */
      border: none !important;            /* æ ã‚’éè¡¨ç¤º */
      box-shadow: none !important;        /* å½±ã‚’æ¶ˆã™ */
      padding: 0;                          /* è¡Œé–“ã¯å€‹åˆ¥ã«èª¿æ•´ */
      border-radius: 0;                    /* è§’ä¸¸ã‚’æ¶ˆã™ */
      box-sizing: border-box;
      cursor: grab;
    }
    .checkbox-group.grabbing, .radio-group.grabbing { cursor: grabbing; }
    .checkbox-row, .radio-row {
      display:flex;
      align-items:center;
      gap:8px;
      padding:4px 0; /* è¡Œé–“ã®ã¿æ®‹ã™ */
      background: transparent;
    }
    .checkbox-row input[type="checkbox"],
    .radio-row input[type="radio"] {
      width:18px;
      height:18px;
      background: transparent; /* ãƒ–ãƒ©ã‚¦ã‚¶æ—¢å®šã®èƒŒæ™¯ã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã« */
      appearance: auto;
    }
    .checkbox-label, .radio-label {
      flex:1;
      padding: 0 6px;
      border-radius:0;
      background: transparent; /* ãƒ©ãƒ™ãƒ«èƒŒæ™¯ã‚‚é€æ˜åŒ– */
    }
    .checkbox-label[contenteditable="true"]:focus,
    .radio-label[contenteditable="true"]:focus {
      outline: none;
      background: rgba(0,0,0,0.03);
      border: none;
    }

    .draggable-btn {
      position: absolute;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: grab;
      min-width: 60px;
      min-height: 30px;
      box-sizing: border-box;
    }
    .draggable-btn.grabbing { cursor: grabbing; }
    .draggable-btn:hover {
      filter: brightness(0.9);
    }
    /* drag handle */
    .drag-handle {
      position: absolute;
      left: -10px;
      top: -10px;
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: rgba(0,0,0,0.06);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      color: rgba(0,0,0,0.6);
      cursor: grab;
      user-select: none;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      z-index: 1000;
    }
    .drag-handle:active { cursor: grabbing; }
    .drag-handle.hidden { display:none; }

    /* ã‚´ãƒŸç®±ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰ã®å³ä¸Šã«é…ç½® */
    #slideArea #trash {
      position: absolute;
      right: 12px;
      top: 12px;
      width: 52px;
      height: 52px;
      background: #eee;
      border: 2px solid #888;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: #888;
      z-index: 2000;
      transition: background 0.2s, color 0.2s;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      user-select: none;
    }
    #slideArea #trash.dragover {
      background: #ffdddd;
      color: #d32f2f;
      border-color: #d32f2f;
    }

    /* è¿½è¨˜ç”¨ CSS: é¸æŠçŸ©å½¢ã¨ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ */
    .textarea-selection {
      position: absolute;
      border: 2px dashed rgba(25,118,210,0.9);
      background: rgba(25,118,210,0.07);
      z-index: 1500;
      pointer-events: none;
      box-sizing:border-box;
    }

    /* éé¸æŠæ™‚ã¯ã‚³ãƒ³ãƒ†ãƒŠæ ã‚’éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆè¦æœ›ï¼‰ */
    .text-input-container {
      position: absolute;
      box-sizing: border-box;
      z-index: 1200;
      display: block;
      min-width: 40px;
      min-height: 24px;
      border: none;           /* éé¸æŠæ™‚ã¯æ ã‚’æ¶ˆã™ */
      background: transparent;
      cursor: grab;           /* ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ */
      overflow: auto;
      /* ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã§ãƒªã‚µã‚¤ã‚ºã•ã›ã‚‹ï¼ˆå†…å´ã®è¦ç´ ã¯ãƒªã‚µã‚¤ã‚ºä¸å¯ã«ã™ã‚‹ï¼‰ */
      resize: both;
    }
    .text-input-container.grabbing { cursor: grabbing; }

    /* ãƒ†ã‚­ã‚¹ãƒˆè‡ªä½“ã¯ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã¦ä¼¸ç¸®ã—ã€å€‹åˆ¥ã®ãƒªã‚µã‚¤ã‚ºãƒãƒ³ãƒ‰ãƒ«ã¯æŒãŸãªã„ */
    .text-input {
      width: 100%;
      height: 100%;
      padding: 6px 8px;
      box-sizing: border-box;
      /* å†…å´ã¯ãƒªã‚µã‚¤ã‚ºã‚’ç„¡åŠ¹åŒ–ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠã®ãƒªã‚µã‚¤ã‚ºã ã‘ã«ã™ã‚‹ */
      resize: none !important;
      overflow: auto;
      outline: none;
      border: none;           /* éé¸æŠæ™‚ã¯æ ã‚’æ¶ˆã™ */
      background: transparent; /* èƒŒæ™¯ã‚’é€æ˜åŒ–ï¼ˆç™½ã‚’ãªãã™ï¼‰ */
      font-size: 14px;
      line-height: 1.4;
      min-height: 20px;
      min-width: 20px;
      display: block;
    }

    /* ç·¨é›†ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹ï¼‰æ™‚ã«ã®ã¿æ ï¼å½±ã‚’è¡¨ç¤ºï¼ˆã‚»ãƒ¬ã‚¯ã‚¿ä¿®æ­£æ¸ˆã¿ï¼‰ */
    .text-input-container:focus-within {
      border: 1px dashed rgba(0,0,0,0.12);
      background: transparent; /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã‚‚ç™½èƒŒæ™¯ã‚’å…¥ã‚Œãªã„ */
      box-shadow: 0 6px 18px rgba(25,118,210,0.04);
      cursor: text;
    }
    .text-input-container:focus-within .text-input {
      border: 1px solid rgba(0,0,0,0.12);
      background: transparent; /* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã‚‚ç™½èƒŒæ™¯ã‚’å…¥ã‚Œãªã„ */
    }

    /* è¡¨ç¤ºç”¨ã®ãƒªã‚µã‚¤ã‚ºä¸­ã‚¯ãƒ©ã‚¹ï¼ˆè¦–è¦šã®ãƒ’ãƒ³ãƒˆã€ä»»æ„ï¼‰ */
    .text-input-container.resizing {
      box-shadow: 0 0 0 2px rgba(25,118,210,0.06) inset;
      pointer-events: auto;
      cursor: nwse-resize;
    }

    /* ã‚¿ã‚¤ãƒãƒ¼è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .timer-container {
      position: absolute;
      background: linear-gradient(180deg, #f0f9ff, #e0f2fe);
      border: 2px solid #0284c7;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      min-width: 200px;
      cursor: grab;
      box-sizing: border-box;
    }
    .timer-container.grabbing { cursor: grabbing; }
    
    .timer-settings-btn {
      display: block;
      margin: 0 auto 8px auto;
      padding: 3px 10px;
      font-size: 11px;
      border: 1px solid #0284c7;
      border-radius: 4px;
      background: white;
      color: #0284c7;
      cursor: pointer;
      transition: all 0.2s;
    }
    .timer-settings-btn:hover {
      background: #e0f2fe;
    }
    
    .timer-display {
      font-size: 28px;
      font-weight: 700;
      color: #0c4a6e;
      text-align: center;
      font-family: 'Courier New', monospace;
      margin-bottom: 6px;
      user-select: none;
    }
    
    .timer-controls {
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    .timer-btn {
      padding: 5px 12px;
      font-size: 13px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }
    .timer-btn.start {
      background: #22c55e;
      color: white;
    }
    .timer-btn.start:hover {
      background: #16a34a;
    }
    .timer-btn.pause {
      background: #f97316;
      color: white;
    }
    .timer-btn.pause:hover {
      background: #ea580c;
    }
    .timer-btn.reset {
      background: #ef4444;
      color: white;
    }
    .timer-btn.reset:hover {
      background: #dc2626;
    }

    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚ˆã‚Šç”»é¢å…¨ä½“ã«è¡¨ç¤ºï¼‰ */
    .preview-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      display: flex;
      flex-direction: column;
      z-index: 9999;
      align-items: stretch;
      justify-content: center;
      padding: 8px;                 /* å°‘ãªã‚ã®ä½™ç™½ã§ã‚ˆã‚Šå…¨ç”»é¢ã«è¦‹ã›ã‚‹ */
      box-sizing:border-box;
    }
    .preview-header {
      height: 48px;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
      z-index: 10010;
    }
    .preview-close {
      background:#fff;
      border:1px solid #ccc;
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
    }
    .preview-area {
      flex:1;
      background:transparent;
      border-radius:6px;
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:4px;                  /* è»½ã„å†…å´ä½™ç™½ */
      box-sizing:border-box;
    }
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã»ã¼å…¨ç”»é¢è¡¨ç¤ºã«ã™ã‚‹ï¼ˆmax åˆ¶é™ã‚’é™¤å»ï¼‰ */
    #previewSlideArea {
      width: calc(100vw - 16px);    /* å·¦å³ã«å°ã•ãªä½™ç™½ã‚’æ®‹ã™ */
      height: calc(100vh - 72px);   /* ãƒ˜ãƒƒãƒ€åˆ†ã¨ä¸Šä¸‹ã«ä½™ç™½ã‚’æ®‹ã™ */
      max-width: none;
      max-height: none;
      border: 2px dashed #666;
      position:relative;
      background:#fff;
      box-sizing:border-box;
      border-radius:6px;
      overflow:auto;
    }

    /* ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãƒãƒ¼ */
    .shortcut-bar {
      width: 100%;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      margin-bottom: 10px;
    }

    @media (max-width:980px){
      .content-wrapper {
        flex-direction: column;
        align-items: center;
      }
      .button-bar {
        width: 100%;
        max-width: 860px;
      }
      .main-area, .shortcut-bar, #slideArea { width: 92%; max-width:860px; }
      #previewSlideArea { width: calc(100vw - 8px); height: calc(100vh - 72px); }
      .create-options-panel { left: 8px; top: auto; }
    }
{% include 'system/_styles.html' %}
{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
{% include 'system/_content.html' %}

{% include 'system/_blockly_loader.html' %}

{% include 'system/_drag_drop.html' %}

  <script>
    // æ®‹ã‚Šã®ã™ã¹ã¦ã®JavaScriptæ©Ÿèƒ½ã‚’å«ã‚€å¤§ããªãƒ•ã‚¡ã‚¤ãƒ«
  (function(){
      try{
        const tabs = document.querySelectorAll('.nav-tab');
        tabs.forEach(tab=>{
          tab.addEventListener('click', function(e){
            // ã‚·ã‚¹ãƒ†ãƒ ã‚¿ãƒ–è‡ªèº«ã®ã‚¯ãƒªãƒƒã‚¯ã¯è¨±å¯
            if(this.id === 'tab-system'){
              tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-pressed','false'); });
              this.classList.add('active');
              this.setAttribute('aria-pressed','true');
              return;
            }
            
            // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯è­¦å‘Š
            if (isDirty) {
              e.preventDefault();
              const confirmed = confirm('ä¿å­˜ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ç§»å‹•ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹?');
              if (!confirmed) return;
              isDirty = false;
            }
            
            // è¦‹ãŸç›®ã®åˆ‡æ›¿
            tabs.forEach(t => { t.classList.remove('active'); t.setAttribute('aria-pressed','false'); });
            this.classList.add('active');
            this.setAttribute('aria-pressed','true');

            // ã‚¿ãƒ–ã”ã¨ã®é·ç§»
            // ã‚·ã‚¹ãƒ†ãƒ ã‚¿ãƒ–æŠ¼ä¸‹ã§ system/choiceã«é·ç§»
            if (this.id === 'tab-system') {
              // ã‚¿ãƒ–ç§»å‹•æ™‚ã¯sessionStorageã‚’ã‚¯ãƒªã‚¢
              sessionStorage.removeItem('systemDesignContent');
              sessionStorage.removeItem('returnFromCreate');
              sessionStorage.removeItem('systemId');
              sessionStorage.removeItem('systemName');
              sessionStorage.removeItem('systemDescription');
              window.location.href = '/accounts/system/choice';
              // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚¿ãƒ–æŠ¼ä¸‹ã§ block/choiceã«é·ç§»
            } else if (this.id === 'tab-algorithm') {
              // ã‚¿ãƒ–ç§»å‹•æ™‚ã¯sessionStorageã‚’ã‚¯ãƒªã‚¢
              sessionStorage.removeItem('systemDesignContent');
              sessionStorage.removeItem('returnFromCreate');
              sessionStorage.removeItem('systemId');
              sessionStorage.removeItem('systemName');
              sessionStorage.removeItem('systemDescription');
              window.location.href = '/accounts/block/choice';
            }
          });
        });
      }catch(err){
        console.error('tabs init error', err);
      }
    })();

    // ä¿å­˜æ™‚ã«isDirtyã‚’ãƒªã‚»ãƒƒãƒˆ
    const originalSaveBtn = document.getElementById('saveBtn');
    if (originalSaveBtn) {
      originalSaveBtn.addEventListener('click', function() {
        isDirty = false;
      });
    }

    const colorOptions = [
      { name: "ã‚ãŠ", value: "#2196F3" },
      { name: "ã‚ã‹", value: "#F44336" },
      { name: "ã¿ã©ã‚Š", value: "#4CAF50" },
      { name: "ãã„ã‚", value: "#FFEB3B", textColor: "#333" },
      { name: "ã‚ªãƒ¬ãƒ³ã‚¸", value: "#FF9800" },
      { name: "ã‚€ã‚‰ã•ã", value: "#9C27B0" },
      { name: "ãã‚", value: "#333" },
      { name: "ã—ã‚", value: "#fff", textColor: "#333" }
    ];

    let history = [];
    let historyIndex = -1;

    function saveHistory() {
      const slide = document.getElementById("slideArea");
      // ä¿å­˜å‰ã«ä¸è¦ãªä¸€æ™‚è¦ç´ ã‚’å–ã‚Šé™¤ãï¼ˆé¸æŠçŸ©å½¢ãªã©ï¼‰
      const temp = slide.querySelectorAll('.textarea-selection');
      temp.forEach(t => t.remove());
      history = history.slice(0, historyIndex + 1);
      history.push(slide.innerHTML);
      historyIndex++;
    }

    function restoreHistory(index) {
      const slide = document.getElementById("slideArea");
      slide.innerHTML = history[index] || '';
      Array.from(slide.children).forEach(el => {
        if (el.classList && (el.classList.contains("input-container") || el.classList.contains("draggable-btn") || el.classList.contains("text-input-container") || el.classList.contains("checkbox-group") || el.classList.contains("radio-group"))) {
          addDragHandleIfMissing(el);
          makeDraggable(el);
        }
      });
      slide.querySelectorAll('input[data-only-number="true"]').forEach(inp=>{
        try { attachNumberFilter(inp); } catch(e){ console.error(e); }
      });
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        restoreHistory(historyIndex);
      }
    }

    function redo() {
      if (historyIndex < history.length - 1) {
        historyIndex++;
        restoreHistory(historyIndex);
      }
    }

    document.getElementById("undoBtn").addEventListener("click", undo);
    document.getElementById("redoBtn").addEventListener("click", redo);
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && !e.shiftKey && e.key.toLowerCase() === "z") {
        e.preventDefault();
        undo();
      }
      if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "y") {
        e.preventDefault();
        redo();
      }
    });

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³æ“ä½œ
    (function(){
      const formBtn = document.getElementById('formBtn');
      const dropdown = document.getElementById('formDropdown');
      const wrap = document.getElementById('formDropdownWrap');
      if (!formBtn || !dropdown) return;

      function openDropdown() {
        dropdown.classList.add('show');
        dropdown.setAttribute('aria-hidden','false');
        formBtn.setAttribute('aria-expanded','true');
      }
      function closeDropdown() {
        dropdown.classList.remove('show');
        dropdown.setAttribute('aria-hidden','true');
        formBtn.setAttribute('aria-expanded','false');
      }
      function toggleDropdown() {
        if (dropdown.classList.contains('show')) closeDropdown(); else openDropdown();
      }

      formBtn.addEventListener('click', function(e){
        e.stopPropagation();
        toggleDropdown();
      });

      document.addEventListener('click', function(e){
        if (!wrap.contains(e.target)) {
          closeDropdown();
          hideOptionsPanel();
        }
      });

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') {
          closeDropdown();
          hideOptionsPanel();
        }
      });
    })();

    // å…±é€šä½œæˆãƒ‘ãƒãƒ«åˆ¶å¾¡ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ / ãƒ©ã‚¸ã‚ªï¼‰
    (function(){
      const addCheckboxBtn = document.getElementById('addCheckboxBtn');
      const addRadioBtn = document.getElementById('addRadioBtn');
      const panel = document.getElementById('createOptionsPanel');
      const countInput = document.getElementById('optionsCount');
      const cancelBtn = document.getElementById('createOptionsCancel');
      const confirmBtn = document.getElementById('createOptionsConfirm');
      const wrap = document.getElementById('formDropdownWrap');

      // ä½œæˆã‚¿ã‚¤ãƒ—ã‚’ä¿æŒï¼ˆ'checkbox' | 'radio' | nullï¼‰
      let pendingType = null;

      function showOptionsPanel(type) {
        pendingType = type;
        panel.classList.add('show');
        panel.setAttribute('aria-hidden','false');
        setTimeout(()=>{ countInput.focus(); countInput.select(); },10);
      }
      function hideOptionsPanel() {
        pendingType = null;
        panel.classList.remove('show');
        panel.setAttribute('aria-hidden','true');
      }

      if (addCheckboxBtn) {
        addCheckboxBtn.addEventListener('click', function(e){
          e.stopPropagation();
          if (panel.classList.contains('show') && pendingType === 'checkbox') hideOptionsPanel(); else showOptionsPanel('checkbox');
        });
      }
      if (addRadioBtn) {
        addRadioBtn.addEventListener('click', function(e){
          e.stopPropagation();
          if (panel.classList.contains('show') && pendingType === 'radio') hideOptionsPanel(); else showOptionsPanel('radio');
        });
      }
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e){
          e.preventDefault();
          hideOptionsPanel();
        });
      }
      if (confirmBtn) {
        confirmBtn.addEventListener('click', function(e){
          e.preventDefault();
          const labelInput = document.getElementById('optionsLabel');
          const label = labelInput ? labelInput.value.trim() : '';
          const n = parseInt(countInput.value, 10) || 0;
          if (n <= 0) {
            alert('é …ç›®æ•°ã¯1ä»¥ä¸Šã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
            return;
          }
          const capped = Math.min(n, 10);
          if (n > 10) {
            alert('é …ç›®æ•°ã¯æœ€å¤§10ã¾ã§ã§ã™ã€‚10ã«è¨­å®šã—ã¾ã™ã€‚');
          }
          if (pendingType === 'checkbox') {
            createCheckboxGroup(capped, label);
          } else if (pendingType === 'radio') {
            createRadioGroup(capped, label);
          }
          // ãƒ©ãƒ™ãƒ«å…¥åŠ›ã‚’ãƒªã‚»ãƒƒãƒˆ
          if (labelInput) labelInput.value = '';
          hideOptionsPanel();
          const dropdown = document.getElementById('formDropdown');
          if (dropdown) { dropdown.classList.remove('show'); dropdown.setAttribute('aria-hidden','true'); }
        });
      }

      document.addEventListener('click', function(e){
        if (!wrap.contains(e.target)) hideOptionsPanel();
      });
    })();

    // ä¿å­˜ãƒœã‚¿ãƒ³
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', function(e){
        e.preventDefault();
        // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜
        const slide = document.getElementById('slideArea');
        if (slide) {
          // è¦ç´ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦ä¿å­˜
          const elementsData = collectCurrentElements();
          sessionStorage.setItem('systemDesignContent', JSON.stringify(elementsData));
          // ä¿å­˜ç”»é¢ã«é·ç§»ã™ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
          sessionStorage.setItem('navigatingToCreate', 'true');
          
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚‚ä¿å­˜
          if (existingSystemData.systemId) {
            sessionStorage.setItem('systemId', existingSystemData.systemId);
          }
          if (existingSystemData.systemName) {
            sessionStorage.setItem('systemName', existingSystemData.systemName);
          }
          if (existingSystemData.systemDescription) {
            sessionStorage.setItem('systemDescription', existingSystemData.systemDescription);
          }
          
          console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }
        window.location.href = '/accounts/system/create/';
      });
    }
    // å®Ÿè¡Œãƒœã‚¿ãƒ³
    const executeBtn = document.getElementById('executeBtn');
    if (executeBtn) {
      executeBtn.addEventListener('click', function(e){
        e.preventDefault();
        openPreview();
      });
    }

    // å…¨å‰Šé™¤ãƒœã‚¿ãƒ³
    const clearAllBtn = document.getElementById('clearAllBtn');
    if (clearAllBtn) {
      clearAllBtn.addEventListener('click', function(e){
        e.preventDefault();
        if (confirm('ã™ã¹ã¦ã®è¦ç´ ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
          const slide = document.getElementById('slideArea');
          if (slide) {
            // ã‚´ãƒŸç®±ä»¥å¤–ã®ã™ã¹ã¦ã®è¦ç´ ã‚’å‰Šé™¤
            const trash = slide.querySelector('#trash');
            const trashHTML = trash ? trash.outerHTML : '<div id="trash" title="ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã§å‰Šé™¤">ğŸ—‘ï¸</div>';
            slide.innerHTML = trashHTML;
            saveHistory();
            console.log('ã™ã¹ã¦ã®è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          }
        }
      });
    }

    function addDragHandleIfMissing(container) {
      if (!container || container.querySelector('.drag-handle')) return;
      const handle = document.createElement('div');
      handle.className = 'drag-handle';
      handle.title = 'ç§»å‹•';
      handle.textContent = 'â‰¡';
      container.appendChild(handle);
    }

    function makeDraggableForPreview(el, parent) {
      return;
    }

    function makeDraggable(el) {
      if (!el) return;
      el.style.position = 'absolute';
      addDragHandleIfMissing(el);

      const handle = el.querySelector('.drag-handle');
      let dragging = false;
      let startX = 0, startY = 0;
      let offsetX = 0, offsetY = 0;
      let moved = false;
      const threshold = 5;

      let resizing = false;
      let resizeTimer = null;
      let initialWidth = el.offsetWidth;
      let initialHeight = el.offsetHeight;

      let ro = null;
      try {
        ro = new ResizeObserver(() => {
          resizing = true;
          if (resizeTimer) clearTimeout(resizeTimer);
          resizeTimer = setTimeout(() => { resizing = false; }, 120);
        });
        ro.observe(el);
      } catch (err) { ro = null; }

      // ã‚´ãƒŸç®±è¦ç´ ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã‚‚ã‚ã‚‹ï¼‰
      const trash = document.getElementById('trash');
      let lastOverTrash = false;

      function pointInRect(clientX, clientY, rect) {
        return clientX >= rect.left && clientX <= rect.right && clientY >= rect.top && clientY <= rect.bottom;
      }

      function setGrabbing(state){
        if (state) {
          el.classList.add('grabbing');
          if (el.classList.contains('draggable-btn')) el.classList.add('grabbing');
          if (el.classList.contains('checkbox-group')) el.classList.add('grabbing');
          if (el.classList.contains('radio-group')) el.classList.add('grabbing');
          try { window._currentDraggingEl = el; } catch(e){}
        } else {
          el.classList.remove('grabbing');
          if (el.classList.contains('draggable-btn')) el.classList.remove('grabbing');
          if (el.classList.contains('checkbox-group')) el.classList.remove('grabbing');
          if (el.classList.contains('radio-group')) el.classList.remove('grabbing');
          try { window._currentDraggingEl = null; } catch(e){}
        }
      }

      function onDown(clientX, clientY, isHandle) {
        const active = document.elementFromPoint(clientX, clientY);
        if (active) {
          const editable = active.closest('input,textarea,.text-input,.input-box') || active.isContentEditable;
          if (editable && !isHandle) {
            return false;
          }
        }
        const elRect = el.getBoundingClientRect();
        offsetX = clientX - elRect.left;
        offsetY = clientY - elRect.top;
        startX = clientX;
        startY = clientY;
        moved = false;
        document.body.style.userSelect = 'none';
        initialWidth = el.offsetWidth;
        initialHeight = el.offsetHeight;
        return true;
      }

      function startDrag() {
        if (resizing) return;
        dragging = true;
        setGrabbing(true);
        el.style.zIndex = 1000;
      }

      function stopDrag() {
        if (dragging) dragging = false;
        setGrabbing(false);
        el.style.zIndex = '';
        document.body.style.userSelect = '';
        // ã‚´ãƒŸç®±ã®è¦–è¦šçŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        try { if (trash) trash.classList.remove('dragover'); lastOverTrash = false; } catch(e){}
      }

      function mousedownHandler(e) {
        if (e.button !== 0) return;
        const isHandle = handle && (e.target === handle || e.target.closest('.drag-handle'));
        if (!onDown(e.clientX, e.clientY, isHandle)) return;

        const parent = el.parentElement;
        const parentRect = parent.getBoundingClientRect();

        const onMoveWhileDown = function(ev){
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          if (!moved && Math.hypot(dx, dy) > threshold) {
            startDrag();
            moved = true;
          }
          if (!dragging) return;
          if (resizing) return;
          let x = ev.clientX - parentRect.left - offsetX;
          let y = ev.clientY - parentRect.top - offsetY;
          x = Math.max(0, Math.min(x, parent.clientWidth - el.offsetWidth));
          y = Math.max(0, Math.min(y, parent.clientHeight - el.offsetHeight));
          el.style.left = x + 'px';
          el.style.top = y + 'px';
          // ã‚´ãƒŸç®±ä¸Šåˆ¤å®šï¼ˆãƒã‚¦ã‚¹ãƒã‚¤ãƒ³ã‚¿ä½ç½®ï¼‰
          if (trash) {
            const over = pointInRect(ev.clientX, ev.clientY, trash.getBoundingClientRect());
            if (over && !lastOverTrash) { trash.classList.add('dragover'); lastOverTrash = true; }
            if (!over && lastOverTrash) { trash.classList.remove('dragover'); lastOverTrash = false; }
          }
        };
        const onUpWhileDown = function(ev){
          document.removeEventListener('mousemove', onMoveWhileDown);
          document.removeEventListener('mouseup', onUpWhileDown);
          // ãƒ‰ãƒ­ãƒƒãƒ—åˆ¤å®šï¼šãƒã‚¦ã‚¹ãŒã‚´ãƒŸç®±ä¸Šã«ã‚ã‚Œã°å‰Šé™¤
          let droppedOnTrash = false;
          try {
            if (trash) {
              droppedOnTrash = pointInRect(ev.clientX, ev.clientY, trash.getBoundingClientRect());
            }
          } catch(e){}
          if (droppedOnTrash) {
            // å‰Šé™¤
            try { el.remove(); } catch(e){ if (el.parentElement) el.parentElement.removeChild(el); }
            try { trash.classList.remove('dragover'); } catch(e){}
            stopDrag();
            saveHistory();
            return;
          }
          if (dragging) {
            stopDrag();
            saveHistory();
          }
        };
        document.addEventListener('mousemove', onMoveWhileDown);
        document.addEventListener('mouseup', onUpWhileDown);
      }

      function touchstartHandler(e) {
        if (!e.touches || e.touches.length === 0) return;
        const touch = e.touches[0];
        const isHandle = handle && (e.target === handle || e.target.closest('.drag-handle'));
        if (!onDown(touch.clientX, touch.clientY, isHandle)) return;

        const parent = el.parentElement;
        const parentRect = parent.getBoundingClientRect();

        const onTouchMove = function(ev){
          if (!ev.touches || ev.touches.length === 0) return;
          const t = ev.touches[0];
          const dx = t.clientX - startX;
          const dy = t.clientY - startY;
          if (!moved && Math.hypot(dx, dy) > threshold) {
            startDrag();
            moved = true;
          }
          if (!dragging) return;
          if (resizing) return;
          let x = t.clientX - parentRect.left - offsetX;
          let y = t.clientY - parentRect.top - offsetY;
          x = Math.max(0, Math.min(x, parent.clientWidth - el.offsetWidth));
          y = Math.max(0, Math.min(y, parent.clientHeight - el.offsetHeight));
          el.style.left = x + 'px';
          el.style.top = y + 'px';
          // ã‚´ãƒŸç®±ä¸Šåˆ¤å®šï¼ˆã‚¿ãƒƒãƒåº§æ¨™ï¼‰
          if (trash) {
            const over = pointInRect(t.clientX, t.clientY, trash.getBoundingClientRect());
            if (over && !lastOverTrash) { trash.classList.add('dragover'); lastOverTrash = true; }
            if (!over && lastOverTrash) { trash.classList.remove('dragover'); lastOverTrash = false; }
          }
          ev.preventDefault();
        };
        const onTouchEnd = function(ev){
          document.removeEventListener('touchmove', onTouchMove);
          document.removeEventListener('touchend', onTouchEnd);
          // ã‚¿ãƒƒãƒçµ‚äº†æ™‚ã®åº§æ¨™ã¯å–å¾—ã—ã«ãã„ã®ã§ã€ã‚´ãƒŸç®±ã¨ã®é‡ãªã‚Šã¯è¦ç´ ä¸­å¿ƒã§åˆ¤å®šã™ã‚‹
          let droppedOnTrash = false;
          try {
            if (trash) {
              const elRect = el.getBoundingClientRect();
              const cx = elRect.left + elRect.width/2;
              const cy = elRect.top + elRect.height/2;
              droppedOnTrash = pointInRect(cx, cy, trash.getBoundingClientRect());
            }
          } catch(e){}
          if (droppedOnTrash) {
            try { el.remove(); } catch(e){ if (el.parentElement) el.parentElement.removeChild(el); }
            try { trash.classList.remove('dragover'); } catch(e){}
            stopDrag();
            saveHistory();
            return;
          }
          if (dragging) {
            stopDrag();
            saveHistory();
          }
        };
        document.addEventListener('touchmove', onTouchMove, {passive:false});
        document.addEventListener('touchend', onTouchEnd);
      }

      if (handle) {
        handle.addEventListener('mousedown', mousedownHandler);
        handle.addEventListener('touchstart', touchstartHandler, {passive:true});
      }
      el.addEventListener('mousedown', mousedownHandler);
      el.addEventListener('touchstart', touchstartHandler, {passive:true});

      const mo = new MutationObserver(mutations => {
        if (!document.body.contains(el)) {
          try { if (ro) ro.disconnect(); } catch(e){}
          mo.disconnect();
        }
      });
      mo.observe(document.body, {childList: true, subtree: true});
    }

    function openPreview(){
      if (document.getElementById('previewOverlay')) return;
      const original = document.getElementById('slideArea');
      if (!original) return;

      const overlay = document.createElement('div');
      overlay.id = 'previewOverlay';
      overlay.className = 'preview-overlay';
      overlay.setAttribute('role','dialog');
      overlay.setAttribute('aria-modal','true');

      const header = document.createElement('div');
      header.className = 'preview-header';

      const closeBtn = document.createElement('button');
      closeBtn.className = 'preview-close';
      closeBtn.textContent = 'é–‰ã˜ã‚‹ (Esc)';
      closeBtn.setAttribute('aria-label','é–‰ã˜ã‚‹');
      header.appendChild(closeBtn);

      const areaWrap = document.createElement('div');
      areaWrap.className = 'preview-area';

      const clone = original.cloneNode(true);
      clone.id = 'previewSlideArea';
      const trash = clone.querySelector('#trash');
      if (trash) trash.remove();

      clone.querySelectorAll('input,textarea').forEach(el => {
        try {
          el.style.resize = 'none';
        } catch(e){}
      });
      clone.querySelectorAll('input[data-only-number="true"]').forEach(inp=>{
        try { attachNumberFilter(inp); } catch(e){ console.error(e); }
      });

      clone.querySelectorAll('.text-input, [contenteditable]').forEach(el => {
        try {
          if (el.classList && el.classList.contains('text-input')) {
            el.setAttribute('contenteditable','false');
          } else {
            el.setAttribute('contenteditable','false');
          }
        } catch(e){}
      });

      clone.querySelectorAll('.drag-handle').forEach(h => h.remove());

      // å®Ÿè¡Œç”»é¢ã§ã¯ã‚¿ã‚¤ãƒãƒ¼ã®è¨­å®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
      clone.querySelectorAll('.timer-settings-btn').forEach(el => {
        el.style.display = 'none';
      });

      const previewStyle = document.createElement('style');
      previewStyle.textContent = `
        #previewSlideArea * { pointer-events: none !important; }
        #previewSlideArea button,
        #previewSlideArea .draggable-btn,
        #previewSlideArea .timer-btn { pointer-events: auto !important; }
        #previewSlideArea input,
        #previewSlideArea textarea,
        #previewSlideArea .input-box { pointer-events: auto !important; }
        #previewSlideArea .text-input,
        #previewSlideArea .text-input-container { pointer-events: none !important; }
        #previewSlideArea .input-container,
        #previewSlideArea .draggable-btn,
        #previewSlideArea .text-input-container,
        #previewSlideArea .checkbox-group,
        #previewSlideArea .radio-group,
        #previewSlideArea .timer-container { user-select: text !important; }
        #previewSlideArea .input-label,
        #previewSlideArea .text-input,
        #previewSlideArea input,
        #previewSlideArea textarea { outline: none !important; box-shadow: none !important; }
        #previewSlideArea { -webkit-user-select: text !important; user-select: text !important; box-shadow: 0 6px 30px rgba(0,0,0,0.24); }
        #previewSlideArea .timer-settings-btn { display: none !important; }
        #previewSlideArea .checkbox-group-label { display: none !important; }
        #previewSlideArea .radio-group-label { display: none !important; }
      `;
      overlay.appendChild(previewStyle);

      clone.querySelectorAll('button, .draggable-btn').forEach(btn => {
        try {
          // ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã§ã¯ãªã„å ´åˆ
          if (!btn.classList.contains('timer-btn') && !btn.classList.contains('timer-mode-btn')) {
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ IDã¨ã‚·ã‚¹ãƒ†ãƒ IDã‚’å–å¾—
            const targetSystemId = newBtn.getAttribute('data-target-system');
            const algorithmId = newBtn.getAttribute('data-algorithm-id');
            const algorithmXml = newBtn.getAttribute('data-algorithm-xml');
            
            console.log('ğŸ”§ ãƒœã‚¿ãƒ³è¨­å®š:', {
              text: newBtn.textContent,
              systemId: targetSystemId,
              algorithmId: algorithmId,
              hasXml: !!algorithmXml,
              xmlLength: algorithmXml ? algorithmXml.length : 0
            });
            
            newBtn.addEventListener('click', async function(e){
              e.stopPropagation();
              
              console.log('ğŸ–±ï¸ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯:', newBtn.textContent);
              
              if (algorithmId && algorithmXml) {
                // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè¡Œ
                console.log('â–¶ï¸ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œé–‹å§‹:', algorithmId);
                await executeAlgorithmFromButton(algorithmXml, newBtn.textContent);
              } else if (targetSystemId) {
                // ã‚·ã‚¹ãƒ†ãƒ é·ç§»
                console.log('ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ é·ç§»:', targetSystemId);
                loadSystemInPreview(targetSystemId);
              } else {
                console.log('âš ï¸ ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ - å‹•ä½œãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
              }
            });
          }
        } catch(err) {
          console.error('ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼:', err);
        }
      });

      // ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
      clone.querySelectorAll('.timer-container').forEach(timer => {
        const startBtn = timer.querySelector('.timer-btn.start');
        const resetBtn = timer.querySelector('.timer-btn.reset');
        const display = timer.querySelector('.timer-display');
        
        if (startBtn) {
          startBtn.onclick = function(e) {
            e.stopPropagation();
            const running = timer.getAttribute('data-timer-running') === 'true';
            const mode = timer.getAttribute('data-timer-mode');
            
            if (!running) {
              if (mode === 'down') {
                const target = parseInt(timer.getAttribute('data-timer-target') || '0');
                if (target === 0) {
                  alert('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                  return;
                }
              }
              timer.setAttribute('data-timer-running', 'true');
              startBtn.textContent = "åœæ­¢";
              startBtn.classList.remove('start');
              startBtn.classList.add('pause');
            } else {
              timer.setAttribute('data-timer-running', 'false');
              startBtn.textContent = "é–‹å§‹";
              startBtn.classList.remove('pause');
              startBtn.classList.add('start');
            }
          };
        }
        
        if (resetBtn) {
          resetBtn.onclick = function(e) {
            e.stopPropagation();
            const mode = timer.getAttribute('data-timer-mode');
            timer.setAttribute('data-timer-running', 'false');
            
            if (mode === 'up') {
              timer.setAttribute('data-timer-seconds', '0');
              if (display) display.textContent = "00:00:00";
            } else {
              const target = parseInt(timer.getAttribute('data-timer-target') || '0');
              timer.setAttribute('data-timer-seconds', target.toString());
              if (display) {
                const h = Math.floor(target / 3600);
                const m = Math.floor((target % 3600) / 60);
                const s = target % 60;
                display.textContent = 
                  String(h).padStart(2, '0') + ':' +
                  String(m).padStart(2, '0') + ':' +
                  String(s).padStart(2, '0');
              }
            }
            
            if (startBtn) {
              startBtn.textContent = "é–‹å§‹";
              startBtn.classList.remove('pause');
              startBtn.classList.add('start');
            }
          };
        }
      });

      areaWrap.appendChild(clone);
      overlay.appendChild(header);
      overlay.appendChild(areaWrap);
      document.body.appendChild(overlay);

      const prevOverflow = document.body.style.overflow;
      document.body.style.overflow = 'hidden';

      function closeOverlay(){
        try{ overlay.remove(); }catch(err){}
        document.body.style.overflow = prevOverflow || '';
      }
      closeBtn.addEventListener('click', closeOverlay);
      overlay.addEventListener('click', function(evt){
        if (evt.target === overlay) closeOverlay();
      });
      document.addEventListener('keydown', function onEsc(e){
        if (e.key === 'Escape') {
          closeOverlay();
          document.removeEventListener('keydown', onEsc);
        }
      });
    }

    // ä»–ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’å®Ÿè¡Œç”»é¢ã«èª­ã¿è¾¼ã‚€é–¢æ•°
    async function loadSystemInPreview(systemId) {
      try {
        console.log(`ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ ID ${systemId} ã‚’èª­ã¿è¾¼ã¿ä¸­...`);
        const response = await fetch(`/accounts/system/elements/?system_id=${systemId}`);
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error(`ã‚·ã‚¹ãƒ†ãƒ ID ${systemId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚·ã‚¹ãƒ†ãƒ ãŒå­˜åœ¨ã™ã‚‹ã‹ã€ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
          } else if (response.status === 401) {
            throw new Error('èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
          } else {
            throw new Error(`ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status})`);
          }
        }
        
        const data = await response.json();
        console.log('ğŸ“¦ å—ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
        
        if (!data.success) {
          throw new Error(data.error || 'ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        // ç¾åœ¨ã®å®Ÿè¡Œç”»é¢ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’å–å¾—
        const previewArea = document.getElementById('previewSlideArea');
        if (!previewArea) {
          console.error('å®Ÿè¡Œç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã®å†…å®¹ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚´ãƒŸç®±ä»¥å¤–ï¼‰
        const children = Array.from(previewArea.children);
        children.forEach(child => {
          if (child.id !== 'trash') {
            child.remove();
          }
        });
        
        // æ–°ã—ã„ã‚·ã‚¹ãƒ†ãƒ ã®è¦ç´ ã‚’å¾©å…ƒ
        restoreSystemElementsToPreview(data.elements, previewArea);
        console.log(`âœ… ã‚·ã‚¹ãƒ†ãƒ ID ${systemId} ã®èª­ã¿è¾¼ã¿å®Œäº†`);
        
      } catch (error) {
        console.error('âŒ ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + error.message);
      }
    }

    // å®Ÿè¡Œç”»é¢ã«è¦ç´ ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
    function restoreSystemElementsToPreview(elementsData, targetArea) {
      if (!targetArea) return;
      
      elementsData.forEach(elem => {
        try {
          let element = null;
          
          switch(elem.element_type) {
            case 'text_input':
              element = createPreviewTextInput(elem, false);
              break;
            case 'number_input':
              element = createPreviewTextInput(elem, true);
              break;
            case 'datetime_input':
              element = createPreviewDatetimeInput(elem);
              break;
            case 'checkbox_group':
              element = createPreviewCheckboxGroup(elem);
              break;
            case 'radio_group':
              element = createPreviewRadioGroup(elem);
              break;
            case 'button':
              element = createPreviewButton(elem);
              break;
            case 'text_box':
              element = createPreviewTextBox(elem);
              break;
            case 'roulette':
              element = createPreviewRoulette(elem);
              break;
            case 'timer':
              element = createPreviewTimer(elem);
              break;
          }
          
          if (element) {
            targetArea.appendChild(element);
          }
        } catch (error) {
          console.error('è¦ç´ ã®å¾©å…ƒã«å¤±æ•—:', elem, error);
        }
      });
    }

    // ä»¥ä¸‹ã€å®Ÿè¡Œç”»é¢ç”¨ã®è¦ç´ ä½œæˆé–¢æ•°
    function createPreviewTextInput(elem, onlyNumber) {
      const container = document.createElement("div");
      container.classList.add("input-container");

      const label = document.createElement("div");
      label.classList.add("input-label");
      label.textContent = elem.element_label || (onlyNumber ? "æ•°å­—ï¼š" : "æ–‡å­—ï¼š");

      const placeholder = elem.element_config?.placeholder || (onlyNumber ? "æ•°å­—ã‚’å…¥åŠ›" : "æ–‡å­—ã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œå¯ï¼‰");
      const actualValue = elem.element_value || ""; // å®Ÿéš›ã®å…¥åŠ›å€¤

      if (onlyNumber) {
        const input = document.createElement("input");
        input.type = "text";
        input.inputMode = "numeric";
        input.pattern = "\\d*";
        input.classList.add("input-box");
        input.placeholder = placeholder;
        input.value = actualValue; // å®Ÿéš›ã®å…¥åŠ›å€¤ã®ã¿è¨­å®š
        input.setAttribute('data-only-number', 'true');
        container.appendChild(label);
        container.appendChild(input);
        attachNumberFilter(input);
      } else {
        const textarea = document.createElement("textarea");
        textarea.classList.add("input-box");
        textarea.placeholder = placeholder;
        textarea.value = actualValue; // å®Ÿéš›ã®å…¥åŠ›å€¤ã®ã¿è¨­å®š
        container.appendChild(label);
        container.appendChild(textarea);
      }

      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      return container;
    }

    function createPreviewDatetimeInput(elem) {
      const container = document.createElement("div");
      container.classList.add("input-container");

      const label = document.createElement("div");
      label.classList.add("input-label");
      label.textContent = elem.element_label || "æ—¥æ™‚ï¼š";

      const input = document.createElement("input");
      input.type = "datetime-local";
      input.style.minWidth = "180px";
      input.style.minHeight = "36px";
      input.style.fontSize = "16px";
      input.style.padding = "4px 8px";
      input.style.boxSizing = "border-box";
      input.classList.add("input-box");
      input.value = elem.element_value || "";

      container.appendChild(label);
      container.appendChild(input);

      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      return container;
    }

    function createPreviewCheckboxGroup(elem) {
      const group = document.createElement('div');
      group.className = 'checkbox-group';

      // æ³¨: å®Ÿè¡Œç”»é¢ã§ã¯ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«(element_label)ã‚’è¡¨ç¤ºã—ãªã„
      // ç·¨é›†ç”»é¢ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

      const options = elem.element_config?.options || [];
      options.forEach((optText, i) => {
        const row = document.createElement('div');
        row.className = 'checkbox-row';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.tabIndex = 0;

        const lbl = document.createElement('div');
        lbl.className = 'checkbox-label';
        lbl.textContent = optText;

        row.appendChild(cb);
        row.appendChild(lbl);
        group.appendChild(row);
      });

      group.style.left = elem.position_x + "px";
      group.style.top = elem.position_y + "px";
      if (elem.width) group.style.width = elem.width + "px";
      if (elem.height) group.style.height = elem.height + "px";

      return group;
    }

    function createPreviewRadioGroup(elem) {
      const group = document.createElement('div');
      group.className = 'radio-group';

      // æ³¨: å®Ÿè¡Œç”»é¢ã§ã¯ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«(element_label)ã‚’è¡¨ç¤ºã—ãªã„
      // ç·¨é›†ç”»é¢ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹

      const uniqueName = 'radio_group_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      const options = elem.element_config?.options || [];
      
      options.forEach((optText, i) => {
        const row = document.createElement('div');
        row.className = 'radio-row';

        const rb = document.createElement('input');
        rb.type = 'radio';
        rb.name = uniqueName;
        rb.tabIndex = 0;

        const lbl = document.createElement('div');
        lbl.className = 'radio-label';
        lbl.textContent = optText;

        row.appendChild(rb);
        row.appendChild(lbl);
        group.appendChild(row);
      });

      group.style.left = elem.position_x + "px";
      group.style.top = elem.position_y + "px";
      if (elem.width) group.style.width = elem.width + "px";
      if (elem.height) group.style.height = elem.height + "px";

      return group;
    }

    function createPreviewButton(elem) {
      const btn = document.createElement("button");
      btn.classList.add("draggable-btn");
      btn.textContent = elem.element_label || "ãƒœã‚¿ãƒ³";

      const styleData = elem.style_data || {};
      if (elem.width) btn.style.width = elem.width + "px";
      if (elem.height) btn.style.height = elem.height + "px";
      if (styleData.background) btn.style.background = styleData.background;
      if (styleData.color) btn.style.color = styleData.color;

      btn.style.left = elem.position_x + "px";
      btn.style.top = elem.position_y + "px";

      // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ IDã¨XMLã‚’å–å¾—
      const algorithmId = elem.element_config?.algorithm_id;
      const algorithmXml = elem.element_config?.algorithm_xml;
      
      // é·ç§»å…ˆã‚·ã‚¹ãƒ†ãƒ IDãŒã‚ã‚‹å ´åˆ
      const targetSystemId = elem.element_config?.target_system_id;
      
      // dataå±æ€§ã«è¨­å®š
      if (algorithmId) btn.setAttribute('data-algorithm-id', algorithmId);
      if (algorithmXml) btn.setAttribute('data-algorithm-xml', algorithmXml);
      if (targetSystemId) btn.setAttribute('data-target-system', targetSystemId);
      
      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        
        if (algorithmId && algorithmXml) {
          // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å®Ÿè¡Œ
          console.log('ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ:', algorithmId);
          executeAlgorithmFromButton(algorithmXml, btn.textContent);
        } else if (targetSystemId) {
          // ã‚·ã‚¹ãƒ†ãƒ é·ç§»
          console.log('ã‚·ã‚¹ãƒ†ãƒ é·ç§»:', targetSystemId);
          loadSystemInPreview(targetSystemId);
        }
      });

      return btn;
    }

    function createPreviewTextBox(elem) {
      const container = document.createElement("div");
      container.classList.add("text-input-container");

      const textDiv = document.createElement("div");
      textDiv.classList.add("text-input");
      textDiv.textContent = elem.element_value || "";

      container.appendChild(textDiv);

      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      return container;
    }

    function createPreviewRoulette(elem) {
      const container = document.createElement("div");
      container.classList.add("roulette-container");
      
      const config = elem.element_config || {};
      const items = config.items || ['é …ç›®1', 'é …ç›®2', 'é …ç›®3'];
      
      container.setAttribute('data-roulette-items', JSON.stringify(items));
      container.setAttribute('data-roulette-spinning', 'false');
      
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å††ã‚’ä½œæˆï¼ˆSVGãƒ™ãƒ¼ã‚¹ï¼‰
      const wheel = document.createElement("div");
      wheel.classList.add("roulette-wheel");
      wheel.style.position = "relative";
      wheel.style.width = "200px";
      wheel.style.height = "200px";
      wheel.style.transition = "transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)";
      wheel.dataset.currentRotation = "0"; // ç¾åœ¨ã®å›è»¢è§’åº¦ã‚’ä¿æŒ
      
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "200");
      svg.setAttribute("height", "200");
      svg.setAttribute("viewBox", "0 0 200 200");
      
      // é …ç›®ã‚’å††çŠ¶ã«é…ç½®
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52C41A'];
      const centerX = 100;
      const centerY = 100;
      const radius = 95;
      const anglePerSegment = (2 * Math.PI) / items.length;
      
      items.forEach((item, index) => {
        const startAngle = index * anglePerSegment - Math.PI / 2;
        const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
        
        // æ‰‡å½¢ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        
        const largeArcFlag = anglePerSegment > Math.PI ? 1 : 0;
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
        path.setAttribute("fill", colors[index % colors.length]);
        path.setAttribute("stroke", "#fff");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®ã«é…ç½®
        const textAngle = startAngle + anglePerSegment / 2;
        const textRadius = radius * 0.65;
        const textX = centerX + textRadius * Math.cos(textAngle);
        const textY = centerY + textRadius * Math.sin(textAngle);
        
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", textX);
        text.setAttribute("y", textY);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.setAttribute("fill", "#fff");
        text.setAttribute("font-size", "14");
        text.setAttribute("font-weight", "bold");
        text.setAttribute("transform", `rotate(${(textAngle * 180 / Math.PI) + 90}, ${textX}, ${textY})`);
        text.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";
        text.textContent = item;
        svg.appendChild(text);
      });
      
      // å¤–æ ã®å††
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", centerX);
      circle.setAttribute("cy", centerY);
      circle.setAttribute("r", radius);
      circle.setAttribute("fill", "none");
      circle.setAttribute("stroke", "#333");
      circle.setAttribute("stroke-width", "4");
      svg.appendChild(circle);
      
      wheel.appendChild(svg);
      
      // ä¸­å¤®ã®ãƒ”ãƒ³ï¼ˆ12æ™‚ã®ä½ç½®ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ0ã®é–‹å§‹ç‚¹ï¼‰
      const pin = document.createElement("div");
      pin.style.position = "absolute";
      pin.style.top = "-15px"; // çŸ¢å°ã®å…ˆç«¯ãŒå††ã®ä¸Šç«¯ï¼ˆy=5pxï¼‰ã«è§¦ã‚Œã‚‹ä½ç½®
      pin.style.left = "46%";
      pin.style.transform = "translateX(-50%)";
      pin.style.width = "0";
      pin.style.height = "0";
      pin.style.borderLeft = "10px solid transparent";
      pin.style.borderRight = "10px solid transparent";
      pin.style.borderTop = "20px solid #FF0000"; // ä¸‹å‘ãã®çŸ¢å°
      pin.style.zIndex = "10";
      pin.style.pointerEvents = "none";
      
      // çµæœè¡¨ç¤º
      const result = document.createElement("div");
      result.classList.add("roulette-result");
      result.style.marginTop = "10px";
      result.style.padding = "8px";
      result.style.background = "#f0f0f0";
      result.style.borderRadius = "4px";
      result.style.textAlign = "center";
      result.style.fontWeight = "bold";
      result.textContent = "çµæœ: -";
      
      // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³
      const spinBtn = document.createElement("button");
      spinBtn.classList.add("roulette-btn", "spin");
      spinBtn.textContent = "ã‚¹ãƒ”ãƒ³";
      spinBtn.style.marginTop = "10px";
      spinBtn.style.padding = "8px 20px";
      spinBtn.style.fontSize = "16px";
      spinBtn.style.cursor = "pointer";
      spinBtn.style.position = "relative";
      spinBtn.style.zIndex = "100";
      spinBtn.onclick = function(e) {
        e.stopPropagation();
        const spinning = container.getAttribute('data-roulette-spinning') === 'true';
        if (spinning) return;
        
        container.setAttribute('data-roulette-spinning', 'true');
        spinBtn.disabled = true;
        spinBtn.style.cursor = 'not-allowed';
        spinBtn.style.opacity = '0.6';
        
        // ç¾åœ¨ã®å›è»¢è§’åº¦ã‚’å–å¾—
        const currentRotation = parseFloat(wheel.dataset.currentRotation) || 0;
        
        // ãƒ©ãƒ³ãƒ€ãƒ ã«å›è»¢ï¼ˆå¸¸ã«æ­£ã®æ–¹å‘ã«ç´¯ç©ï¼‰
        const spins = 5 + Math.random() * 3;
        const extraDegrees = Math.random() * 360;
        const newRotation = currentRotation + spins * 360 + extraDegrees;
        
        wheel.style.transform = `rotate(${newRotation}deg)`;
        wheel.dataset.currentRotation = newRotation;
        
        // 3ç§’å¾Œã«çµæœã‚’è¡¨ç¤º
        setTimeout(() => {
          // çŸ¢å°ã¯ä¸Šéƒ¨ï¼ˆ-90åº¦ = 270åº¦ï¼‰ã«å›ºå®š
          // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒæ™‚è¨ˆå›ã‚Šã«finalAngleåº¦å›è»¢ã—ãŸå ´åˆã€
          // çŸ¢å°ãŒæŒ‡ã™ã®ã¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸Šã® (270 - finalAngle) åº¦ã®ä½ç½®
          const finalAngle = ((newRotation % 360) + 360) % 360;
          const segmentAngle = 360 / items.length;
          const angleOnWheel = (270 - finalAngle + 360) % 360;
          // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯270åº¦ï¼ˆ-90åº¦ï¼‰ã‹ã‚‰é–‹å§‹ã™ã‚‹ã®ã§ã€è£œæ­£ã—ã¦è¨ˆç®—
          const selectedIndex = Math.floor((angleOnWheel + 90) / segmentAngle) % items.length;
          
          result.textContent = `çµæœ: ${items[selectedIndex]}`;
          container.setAttribute('data-roulette-spinning', 'false');
          spinBtn.disabled = false;
          spinBtn.style.cursor = 'pointer';
          spinBtn.style.opacity = '1';
        }, 3000);
      };
      
      // è¦ç´ ã‚’çµ„ã¿ç«‹ã¦
      const wheelWrapper = document.createElement("div");
      wheelWrapper.style.position = "relative";
      wheelWrapper.style.pointerEvents = "none";
      wheelWrapper.appendChild(pin);
      wheelWrapper.appendChild(wheel);
      
      container.appendChild(wheelWrapper);
      container.appendChild(result);
      container.appendChild(spinBtn);
      
      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      return container;
    }

    function createPreviewTimer(elem) {
      const container = document.createElement('div');
      container.className = 'timer-container';
      
      const config = elem.element_config || {};
      const mode = config.mode || 'countup';
      const initialTime = config.initial_time || 0;
      
      container.setAttribute('data-timer-mode', mode);
      container.setAttribute('data-timer-running', 'false');
      container.setAttribute('data-timer-value', initialTime.toString());
      container.setAttribute('data-initial-time', initialTime.toString());

      const display = document.createElement('div');
      display.className = 'timer-display';
      display.textContent = formatTimerDisplay(initialTime);

      const btnContainer = document.createElement('div');
      btnContainer.className = 'timer-buttons';

      const startBtn = document.createElement('button');
      startBtn.className = 'timer-btn start';
      startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';

      const resetBtn = document.createElement('button');
      resetBtn.className = 'timer-btn reset';
      resetBtn.textContent = 'ãƒªã‚»ãƒƒãƒˆ';

      btnContainer.appendChild(startBtn);
      btnContainer.appendChild(resetBtn);

      container.appendChild(display);
      container.appendChild(btnContainer);

      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      // ã‚¿ã‚¤ãƒãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      setupTimerEvents(container, startBtn, resetBtn, display, mode, initialTime);

      return container;
    }

    function setupTimerEvents(container, startBtn, resetBtn, display, mode, initialTime) {
      let intervalId = null;

      startBtn.onclick = function(e) {
        e.stopPropagation();
        const running = container.getAttribute('data-timer-running') === 'true';
        
        if (running) {
          // åœæ­¢
          if (intervalId) clearInterval(intervalId);
          container.setAttribute('data-timer-running', 'false');
          startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
        } else {
          // é–‹å§‹
          container.setAttribute('data-timer-running', 'true');
          startBtn.textContent = 'ã‚¹ãƒˆãƒƒãƒ—';
          
          intervalId = setInterval(() => {
            let currentValue = parseInt(container.getAttribute('data-timer-value')) || 0;
            
            if (mode === 'countdown') {
              currentValue = Math.max(0, currentValue - 1);
              container.setAttribute('data-timer-value', currentValue.toString());
              display.textContent = formatTimerDisplay(currentValue);
              
              if (currentValue === 0) {
                if (intervalId) clearInterval(intervalId);
                container.setAttribute('data-timer-running', 'false');
                startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
              }
            } else {
              // countup
              currentValue += 1;
              container.setAttribute('data-timer-value', currentValue.toString());
              display.textContent = formatTimerDisplay(currentValue);
            }
          }, 1000);
        }
      };

      resetBtn.onclick = function(e) {
        e.stopPropagation();
        if (intervalId) clearInterval(intervalId);
        container.setAttribute('data-timer-running', 'false');
        container.setAttribute('data-timer-value', initialTime.toString());
        display.textContent = formatTimerDisplay(initialTime);
        startBtn.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
      };
    }

    function formatTimerDisplay(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      return String(h).padStart(2, '0') + ':' + 
             String(m).padStart(2, '0') + ':' + 
             String(s).padStart(2, '0');
    }

    // ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¨ãƒªã‚¢ã®è¦ç´ ã‚’åé›†ã™ã‚‹é–¢æ•°
    function collectCurrentElements() {
      const slide = document.getElementById('slideArea');
      if (!slide) return [];
      
      const elements = [];
      
      // ãƒ†ã‚­ã‚¹ãƒˆ/æ•°å€¤/æ—¥æ™‚å…¥åŠ›
      slide.querySelectorAll('.input-container').forEach(container => {
        const label = container.querySelector('.input-label');
        const input = container.querySelector('.input-box');
        const labelText = label ? label.textContent.trim() : '';
        const inputValue = input ? input.value.trim() : ''; // å®Ÿéš›ã®å…¥åŠ›å€¤ã‚’å–å¾—
        const placeholder = input ? input.placeholder : '';
        const onlyNumber = input && input.getAttribute('data-only-number') === 'true';
        const isDatetime = input && input.type === 'datetime-local';
        
        let elementType = 'text_input';
        if (onlyNumber) elementType = 'number_input';
        if (isDatetime) elementType = 'datetime_input';
        
        elements.push({
          element_type: elementType,
          element_label: labelText,
          element_value: inputValue,
          position_x: parseInt(container.style.left) || 0,
          position_y: parseInt(container.style.top) || 0,
          width: container.offsetWidth || null,
          height: container.offsetHeight || null,
          style_data: {},
          element_config: {
            placeholder: placeholder
          }
        });
      });
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—
      slide.querySelectorAll('.checkbox-group').forEach(group => {
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        const groupLabelDiv = group.querySelector('.checkbox-group-label');
        const groupLabel = groupLabelDiv ? groupLabelDiv.textContent.trim() : '';
        
        const rows = group.querySelectorAll('.checkbox-row');
        const options = [];
        rows.forEach(row => {
          const label = row.querySelector('.checkbox-label');
          if (label) options.push(label.textContent.trim());
        });
        
        elements.push({
          element_type: 'checkbox_group',
          element_label: groupLabel,
          element_value: '',
          position_x: parseInt(group.style.left) || 0,
          position_y: parseInt(group.style.top) || 0,
          width: group.offsetWidth || null,
          height: group.offsetHeight || null,
          style_data: {},
          element_config: { options: options }
        });
      });
      
      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—
      slide.querySelectorAll('.radio-group').forEach(group => {
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
        const groupLabelDiv = group.querySelector('.radio-group-label');
        const groupLabel = groupLabelDiv ? groupLabelDiv.textContent.trim() : '';
        
        const rows = group.querySelectorAll('.radio-row');
        const options = [];
        rows.forEach(row => {
          const label = row.querySelector('.radio-label');
          if (label) options.push(label.textContent.trim());
        });
        
        elements.push({
          element_type: 'radio_group',
          element_label: groupLabel,
          element_value: '',
          position_x: parseInt(group.style.left) || 0,
          position_y: parseInt(group.style.top) || 0,
          width: group.offsetWidth || null,
          height: group.offsetHeight || null,
          style_data: {},
          element_config: { options: options }
        });
      });
      
      // ãƒœã‚¿ãƒ³
      slide.querySelectorAll('.draggable-btn').forEach(btn => {
        const targetSystemId = btn.getAttribute('data-target-system');
        const algorithmId = btn.getAttribute('data-algorithm-id');
        const algorithmXml = btn.getAttribute('data-algorithm-xml');
        let buttonText = btn.textContent.trim();
        buttonText = buttonText.replace(/â‰¡/g, '').trim();
        
        elements.push({
          element_type: 'button',
          element_label: buttonText,
          element_value: '',
          position_x: parseInt(btn.style.left) || 0,
          position_y: parseInt(btn.style.top) || 0,
          width: parseInt(btn.style.width) || null,
          height: parseInt(btn.style.height) || null,
          style_data: {
            background: btn.style.background || btn.style.backgroundColor,
            color: btn.style.color
          },
          element_config: {
            target_system_id: targetSystemId,
            algorithm_id: algorithmId,
            algorithm_xml: algorithmXml
          }
        });
      });
      
      // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹
      slide.querySelectorAll('.text-input-container').forEach(container => {
        const textInput = container.querySelector('.text-input');
        const content = textInput ? (textInput.value || textInput.textContent || '').trim() : '';
        
        elements.push({
          element_type: 'text_box',
          element_label: '',
          element_value: content,
          position_x: parseInt(container.style.left) || 0,
          position_y: parseInt(container.style.top) || 0,
          width: parseInt(container.style.width) || null,
          height: parseInt(container.style.height) || null,
          style_data: {},
          element_config: {}
        });
      });
      
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆ
      slide.querySelectorAll('.roulette-container').forEach(roulette => {
        const items = JSON.parse(roulette.getAttribute('data-roulette-items') || '[]');
        
        elements.push({
          element_type: 'roulette',
          element_label: '',
          element_value: '',
          position_x: parseInt(roulette.style.left) || 0,
          position_y: parseInt(roulette.style.top) || 0,
          width: parseInt(roulette.style.width) || null,
          height: parseInt(roulette.style.height) || null,
          style_data: {},
          element_config: {
            items: items
          }
        });
      });
      
      // ã‚¿ã‚¤ãƒãƒ¼
      slide.querySelectorAll('.timer-container').forEach(timer => {
        const mode = timer.getAttribute('data-timer-mode') || 'countup';
        const initialTime = parseInt(timer.getAttribute('data-initial-time')) || 0;
        
        elements.push({
          element_type: 'timer',
          element_label: '',
          element_value: '',
          position_x: parseInt(timer.style.left) || 0,
          position_y: parseInt(timer.style.top) || 0,
          width: parseInt(timer.style.width) || null,
          height: parseInt(timer.style.height) || null,
          style_data: {},
          element_config: {
            mode: mode,
            initial_time: initialTime
          }
        });
      });
      
      return elements;
    }

    function getRandomPosition(width=100, height=40) {
      const slide = document.getElementById("slideArea");
      const x = Math.random() * Math.max(0, slide.clientWidth - width);
      const y = Math.random() * Math.max(0, slide.clientHeight - height);
      return {x, y};
    }

    function attachNumberFilter(input){
      if(!input) return;
      if (input._numberFilterAttached) return;
      input._numberFilterAttached = true;
      input.addEventListener('input', function(){
        const prevPos = input.selectionStart;
        const sanitized = input.value.replace(/[^\d\.\-]/g, '');
        if (sanitized !== input.value) {
          input.value = sanitized;
          try { input.setSelectionRange(Math.max(0, prevPos - 1), Math.max(0, prevPos - 1)); } catch(e){}
        }
      });
      input.addEventListener('keydown', function(e){
        const allowedKeys = ['Backspace','Tab','Enter','ArrowLeft','ArrowRight','Delete','ArrowUp','ArrowDown','Home','End'];
        if (allowedKeys.indexOf(e.key) !== -1) return;
        if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','z','y'].indexOf(e.key.toLowerCase()) !== -1) return;
        if (!/^[0-9.\-]$/.test(e.key)) {
          e.preventDefault();
        }
      });
      input.addEventListener('paste', function(e){
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData('text') || '';
        const sanitized = text.replace(/[^\d\.\-]/g, '');
        const start = input.selectionStart || 0;
        const end = input.selectionEnd || 0;
        const newVal = input.value.slice(0,start) + sanitized + input.value.slice(end);
        input.value = newVal;
        const pos = start + sanitized.length;
        try { input.setSelectionRange(pos, pos); } catch(e){}
        input.dispatchEvent(new Event('input', { bubbles: true }));
      });
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
    function createCheckboxGroup(count, groupLabel = '') {
      count = Math.min(count || 0, 10);
      const slide = document.getElementById('slideArea');
      if (!slide) return;
      const group = document.createElement('div');
      group.className = 'checkbox-group';

      // ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
      if (groupLabel) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'checkbox-group-label';
        labelDiv.contentEditable = 'true';
        labelDiv.textContent = groupLabel;
        labelDiv.style.fontWeight = 'bold';
        labelDiv.style.marginBottom = '4px';
        labelDiv.style.cursor = 'text';
        group.appendChild(labelDiv);
      }

      for (let i = 0; i < count; i++) {
        const row = document.createElement('div');
        row.className = 'checkbox-row';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.tabIndex = 0;

        const lbl = document.createElement('div');
        lbl.className = 'checkbox-label';
        lbl.contentEditable = 'true';
        lbl.textContent = 'é …ç›® ' + (i + 1);

        row.appendChild(cb);
        row.appendChild(lbl);
        group.appendChild(row);
      }

      const pos = getRandomPosition(200, Math.max(80, (groupLabel ? 20 : 0) + count * 28));
      group.style.left = pos.x + 'px';
      group.style.top = pos.y + 'px';

      addDragHandleIfMissing(group);
      makeDraggable(group);
      slide.appendChild(group);
      saveHistory();
    }

    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆï¼ˆåŒæ§˜ã®æ¡ä»¶ï¼‰
    function createRadioGroup(count, groupLabel = '') {
      count = Math.min(count || 0, 10);
      const slide = document.getElementById('slideArea');
      if (!slide) return;
      const group = document.createElement('div');
      group.className = 'radio-group';

      // ãƒ©ã‚¸ã‚ªã® name ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®ã¿æ’ä»–ã«ã™ã‚‹
      const uniqueName = 'radio_group_' + Date.now() + '_' + Math.floor(Math.random()*1000);

      // ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
      if (groupLabel) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'radio-group-label';
        labelDiv.contentEditable = 'true';
        labelDiv.textContent = groupLabel;
        labelDiv.style.fontWeight = 'bold';
        labelDiv.style.marginBottom = '4px';
        labelDiv.style.cursor = 'text';
        group.appendChild(labelDiv);
      }

      for (let i = 0; i < count; i++) {
        const row = document.createElement('div');
        row.className = 'radio-row';

        const rb = document.createElement('input');
        rb.type = 'radio';
        rb.name = uniqueName;
        rb.tabIndex = 0;

        const lbl = document.createElement('div');
        lbl.className = 'radio-label';
        lbl.contentEditable = 'true';
        lbl.textContent = 'é …ç›® ' + (i + 1);

        row.appendChild(rb);
        row.appendChild(lbl);
        group.appendChild(row);
      }

      const pos = getRandomPosition(200, Math.max(80, (groupLabel ? 20 : 0) + count * 28));
      group.style.left = pos.x + 'px';
      group.style.top = pos.y + 'px';

      addDragHandleIfMissing(group);
      makeDraggable(group);
      slide.appendChild(group);
      saveHistory();
    }

    function createInput(defaultLabel, placeholder, onlyNumber=false) {
      let container = document.createElement("div");
      container.classList.add("input-container");

      let label = document.createElement("div");
      label.classList.add("input-label");
      label.textContent = defaultLabel;
      label.contentEditable = "true";

      if (onlyNumber) {
        let input = document.createElement("input");
        input.type = "text";
        input.inputMode = "numeric";
        input.pattern = "\\d*";
        input.classList.add("input-box");
        input.placeholder = placeholder;
        input.setAttribute('data-only-number', 'true');

        container.appendChild(label);
        container.appendChild(input);

        attachNumberFilter(input);
      } else {
        let textarea = document.createElement("textarea");
        textarea.classList.add("input-box");
        textarea.placeholder = placeholder;
        container.appendChild(label);
        container.appendChild(textarea);
      }

      let pos = getRandomPosition();
      container.style.left = pos.x + "px";
      container.style.top = pos.y + "px";
      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById("slideArea").appendChild(container);
      saveHistory();
    }

    function createDatetimeInput() {
      let container = document.createElement("div");
      container.classList.add("input-container");

      let label = document.createElement("div");
      label.classList.add("input-label");
      label.textContent = "æ—¥æ™‚ï¼š";
      label.contentEditable = "true";

      let input = document.createElement("input");
      input.type = "datetime-local";
      input.style.minWidth = "180px";
      input.style.minHeight = "36px";
      input.style.fontSize = "16px";
      input.style.padding = "4px 8px";
      input.style.boxSizing = "border-box";
      input.classList.add("input-box");

      container.appendChild(label);
      container.appendChild(input);

      let pos = getRandomPosition(240, 40);
      container.style.left = pos.x + "px";
      container.style.top = pos.y + "px";
      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById("slideArea").appendChild(container);
      saveHistory();
    }

    function createRoulette() {
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é …ç›®æ•°ã‚’å…¥åŠ›
      const itemCount = parseInt(prompt("ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®é …ç›®æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (2-20)", "6")) || 6;
      
      if (itemCount < 2 || itemCount > 20) {
        alert("é …ç›®æ•°ã¯2ï½20ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      // å„é …ç›®ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›
      const items = [];
      for (let i = 0; i < itemCount; i++) {
        const itemText = prompt(`é …ç›® ${i + 1} ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, `é …ç›®${i + 1}`);
        if (itemText === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆ
        items.push(itemText || `é …ç›®${i + 1}`);
      }
      
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
      const container = document.createElement("div");
      container.classList.add("roulette-container");
      container.setAttribute('data-roulette-items', JSON.stringify(items));
      container.setAttribute('data-roulette-spinning', 'false');
      
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å††ã‚’ä½œæˆï¼ˆSVGãƒ™ãƒ¼ã‚¹ï¼‰
      const wheel = document.createElement("div");
      wheel.classList.add("roulette-wheel");
      wheel.style.position = "relative";
      wheel.style.width = "200px";
      wheel.style.height = "200px";
      wheel.style.transition = "transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)";
      wheel.dataset.currentRotation = "0"; // ç¾åœ¨ã®å›è»¢è§’åº¦ã‚’ä¿æŒ
      
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "200");
      svg.setAttribute("height", "200");
      svg.setAttribute("viewBox", "0 0 200 200");
      
      // é …ç›®ã‚’å††çŠ¶ã«é…ç½®
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52C41A'];
      const centerX = 100;
      const centerY = 100;
      const radius = 95;
      const anglePerSegment = (2 * Math.PI) / items.length;
      
      items.forEach((item, index) => {
        const startAngle = index * anglePerSegment - Math.PI / 2;
        const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
        
        // æ‰‡å½¢ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        
        const largeArcFlag = anglePerSegment > Math.PI ? 1 : 0;
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
        path.setAttribute("fill", colors[index % colors.length]);
        path.setAttribute("stroke", "#fff");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®ã«é…ç½®
        const textAngle = startAngle + anglePerSegment / 2;
        const textRadius = radius * 0.65;
        const textX = centerX + textRadius * Math.cos(textAngle);
        const textY = centerY + textRadius * Math.sin(textAngle);
        
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", textX);
        text.setAttribute("y", textY);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.setAttribute("fill", "#fff");
        text.setAttribute("font-size", "14");
        text.setAttribute("font-weight", "bold");
        text.setAttribute("transform", `rotate(${(textAngle * 180 / Math.PI) + 90}, ${textX}, ${textY})`);
        text.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";
        text.textContent = item;
        svg.appendChild(text);
      });
      
      // å¤–æ ã®å††
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", centerX);
      circle.setAttribute("cy", centerY);
      circle.setAttribute("r", radius);
      circle.setAttribute("fill", "none");
      circle.setAttribute("stroke", "#333");
      circle.setAttribute("stroke-width", "4");
      svg.appendChild(circle);
      
      wheel.appendChild(svg);
      
      // ä¸­å¤®ã®ãƒ”ãƒ³ï¼ˆ12æ™‚ã®ä½ç½®ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ0ã®é–‹å§‹ç‚¹ï¼‰
      const pin = document.createElement("div");
      pin.style.position = "absolute";
      pin.style.top = "-15px"; // çŸ¢å°ã®å…ˆç«¯ãŒå††ã®ä¸Šç«¯ï¼ˆy=5pxï¼‰ã«è§¦ã‚Œã‚‹ä½ç½®
      pin.style.left = "48%";
      pin.style.transform = "translateX(-50%)";
      pin.style.width = "0";
      pin.style.height = "0";
      pin.style.borderLeft = "10px solid transparent";
      pin.style.borderRight = "10px solid transparent";
      pin.style.borderTop = "20px solid #FF0000"; // ä¸‹å‘ãã®çŸ¢å°
      pin.style.zIndex = "10";
      pin.style.pointerEvents = "none";
      
      // çµæœè¡¨ç¤º
      const result = document.createElement("div");
      result.classList.add("roulette-result");
      result.style.marginTop = "10px";
      result.style.padding = "8px";
      result.style.background = "#f0f0f0";
      result.style.borderRadius = "4px";
      result.style.textAlign = "center";
      result.style.fontWeight = "bold";
      result.textContent = "çµæœ: -";
      
      // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³
      const spinBtn = document.createElement("button");
      spinBtn.classList.add("roulette-btn", "spin");
      spinBtn.textContent = "ã‚¹ãƒ”ãƒ³";
      spinBtn.style.marginTop = "10px";
      spinBtn.style.padding = "8px 20px";
      spinBtn.style.fontSize = "16px";
      spinBtn.style.cursor = "pointer";
      spinBtn.style.position = "relative";
      spinBtn.style.zIndex = "100";
      spinBtn.onclick = function(e) {
        e.stopPropagation();
        const spinning = container.getAttribute('data-roulette-spinning') === 'true';
        if (spinning) return;
        
        container.setAttribute('data-roulette-spinning', 'true');
        spinBtn.disabled = true;
        spinBtn.style.cursor = 'not-allowed';
        spinBtn.style.opacity = '0.6';
        
        // ç¾åœ¨ã®å›è»¢è§’åº¦ã‚’å–å¾—
        const currentRotation = parseFloat(wheel.dataset.currentRotation) || 0;
        
        // ãƒ©ãƒ³ãƒ€ãƒ ã«å›è»¢ï¼ˆå¸¸ã«æ­£ã®æ–¹å‘ã«ç´¯ç©ï¼‰
        const spins = 5 + Math.random() * 3; // 5-8å›è»¢
        const extraDegrees = Math.random() * 360;
        const newRotation = currentRotation + spins * 360 + extraDegrees;
        
        wheel.style.transform = `rotate(${newRotation}deg)`;
        wheel.dataset.currentRotation = newRotation;
        
        // 3ç§’å¾Œã«çµæœã‚’è¡¨ç¤º
        setTimeout(() => {
          // çŸ¢å°ã¯ä¸Šéƒ¨ï¼ˆ-90åº¦ = 270åº¦ï¼‰ã«å›ºå®š
          // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒæ™‚è¨ˆå›ã‚Šã«finalAngleåº¦å›è»¢ã—ãŸå ´åˆã€
          // çŸ¢å°ãŒæŒ‡ã™ã®ã¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸Šã® (270 - finalAngle) åº¦ã®ä½ç½®
          const finalAngle = ((newRotation % 360) + 360) % 360;
          const segmentAngle = 360 / items.length;
          const angleOnWheel = (270 - finalAngle + 360) % 360;
          // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯270åº¦ï¼ˆ-90åº¦ï¼‰ã‹ã‚‰é–‹å§‹ã™ã‚‹ã®ã§ã€è£œæ­£ã—ã¦è¨ˆç®—
          const selectedIndex = Math.floor((angleOnWheel + 90) / segmentAngle) % items.length;
          
          result.textContent = `çµæœ: ${items[selectedIndex]}`;
          container.setAttribute('data-roulette-spinning', 'false');
          spinBtn.disabled = false;
          spinBtn.style.cursor = 'pointer';
          spinBtn.style.opacity = '1';
        }, 3000);
      };
      
      // è¦ç´ ã‚’çµ„ã¿ç«‹ã¦
      const wheelWrapper = document.createElement("div");
      wheelWrapper.style.position = "relative";
      wheelWrapper.style.pointerEvents = "none";
      wheelWrapper.appendChild(pin);
      wheelWrapper.appendChild(wheel);
      
      container.appendChild(wheelWrapper);
      container.appendChild(result);
      container.appendChild(spinBtn);
      
      const pos = getRandomPosition(220, 280);
      container.style.left = pos.x + "px";
      container.style.top = pos.y + "px";
      container.style.width = "220px";
      container.style.height = "280px";
      
      const slide = document.getElementById("slideArea");
      slide.appendChild(container);
      makeDraggable(container);
      makeResizable(container);
    }

    function createTimer() {
      // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆ1: ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã€2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼‰
      let mode = null;
      while (mode === null) {
        const modeInput = prompt("ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„\n\n1: ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—\n2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³", "1");
        
        if (modeInput === null) {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
          return;
        }
        
        if (modeInput === '1') {
          mode = 'up';
        } else if (modeInput === '2') {
          mode = 'down';
        } else {
          alert("1ã¾ãŸã¯2ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        }
      }
      
      let targetSeconds = 0;
      let displayText = "00:00:00";
      
      // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®å ´åˆã¯æ™‚é–“è¨­å®š
      if (mode === 'down') {
        const hours = parseInt(prompt("æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-23)", "0")) || 0;
        const minutes = parseInt(prompt("åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", "1")) || 0;
        const seconds = parseInt(prompt("ç§’ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", "0")) || 0;
        
        targetSeconds = Math.max(0, Math.min(hours, 23)) * 3600 + 
                       Math.max(0, Math.min(minutes, 59)) * 60 + 
                       Math.max(0, Math.min(seconds, 59));
        
        if (targetSeconds === 0) {
          alert("æ™‚é–“ãŒ0ç§’ã§ã™ã€‚æœ€ä½1ç§’ä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        
        const h = Math.floor(targetSeconds / 3600);
        const m = Math.floor((targetSeconds % 3600) / 60);
        const s = targetSeconds % 60;
        displayText = String(h).padStart(2, '0') + ':' +
                     String(m).padStart(2, '0') + ':' +
                     String(s).padStart(2, '0');
      }
      
      // ã‚¿ã‚¤ãƒãƒ¼ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
      let container = document.createElement("div");
      container.classList.add("timer-container");
      container.setAttribute('data-timer-seconds', mode === 'down' ? targetSeconds.toString() : '0');
      container.setAttribute('data-timer-running', 'false');
      container.setAttribute('data-timer-mode', mode);
      container.setAttribute('data-timer-target', targetSeconds.toString());

      // ã‚¿ã‚¤ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³(ç·¨é›†ç”¨)
      let settingsBtn = document.createElement("button");
      settingsBtn.classList.add("timer-settings-btn");
      settingsBtn.textContent = "âš™ è¨­å®š";
      settingsBtn.title = "ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´";

      settingsBtn.textContent = "âš™ è¨­å®š";
      settingsBtn.title = "ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´";
      settingsBtn.onclick = function(e) {
        e.stopPropagation();
        openTimerSettings(container, display);
      };

      // è¡¨ç¤ºéƒ¨åˆ†
      let display = document.createElement("div");
      display.classList.add("timer-display");
      display.textContent = displayText;

      // æ“ä½œãƒœã‚¿ãƒ³
      let controls = document.createElement("div");
      controls.classList.add("timer-controls");

      let startBtn = document.createElement("button");
      startBtn.classList.add("timer-btn", "start");
      startBtn.textContent = "é–‹å§‹";
      startBtn.onclick = function(e) {
        e.stopPropagation();
        const running = container.getAttribute('data-timer-running') === 'true';
        const timerMode = container.getAttribute('data-timer-mode');
        
        if (!running) {
          if (timerMode === 'down') {
            const target = parseInt(container.getAttribute('data-timer-target') || '0');
            if (target === 0) {
              alert('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
              return;
            }
          }
          container.setAttribute('data-timer-running', 'true');
          startBtn.textContent = "åœæ­¢";
          startBtn.classList.remove('start');
          startBtn.classList.add('pause');
        } else {
          container.setAttribute('data-timer-running', 'false');
          startBtn.textContent = "é–‹å§‹";
          startBtn.classList.remove('pause');
          startBtn.classList.add('start');
        }
      };

      let resetBtn = document.createElement("button");
      resetBtn.classList.add("timer-btn", "reset");
      resetBtn.textContent = "ãƒªã‚»ãƒƒãƒˆ";
      resetBtn.onclick = function(e) {
        e.stopPropagation();
        const timerMode = container.getAttribute('data-timer-mode');
        container.setAttribute('data-timer-running', 'false');
        
        if (timerMode === 'up') {
          container.setAttribute('data-timer-seconds', '0');
          display.textContent = "00:00:00";
        } else {
          const target = parseInt(container.getAttribute('data-timer-target') || '0');
          container.setAttribute('data-timer-seconds', target.toString());
          const h = Math.floor(target / 3600);
          const m = Math.floor((target % 3600) / 60);
          const s = target % 60;
          display.textContent = 
            String(h).padStart(2, '0') + ':' +
            String(m).padStart(2, '0') + ':' +
            String(s).padStart(2, '0');
        }
        
        startBtn.textContent = "é–‹å§‹";
        startBtn.classList.remove('pause');
        startBtn.classList.add('start');
      };

      controls.appendChild(startBtn);
      controls.appendChild(resetBtn);
      
      container.appendChild(settingsBtn);
      container.appendChild(display);
      container.appendChild(controls);

      let pos = getRandomPosition(220, 120);
      container.style.left = pos.x + "px";
      container.style.top = pos.y + "px";
      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById("slideArea").appendChild(container);
      saveHistory();
    }

    // ã‚¿ã‚¤ãƒãƒ¼è¨­å®šå¤‰æ›´ãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function openTimerSettings(container, display) {
      const currentMode = container.getAttribute('data-timer-mode');
      const currentTarget = parseInt(container.getAttribute('data-timer-target') || '0');
      
      // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆ1: ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã€2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ï¼‰
      let newMode = null;
      while (newMode === null) {
        const currentModeText = currentMode === 'up' ? 'ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—' : 'ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³';
        const modeInput = prompt("ã‚¿ã‚¤ãƒãƒ¼ã®ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„\n\nç¾åœ¨: " + currentModeText + "\n\n1: ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—\n2: ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³", currentMode === 'up' ? '1' : '2');
        
        if (modeInput === null) {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ã‚’ä¸­æ–­
          return;
        }
        
        if (modeInput === '1') {
          newMode = 'up';
        } else if (modeInput === '2') {
          newMode = 'down';
        } else {
          alert("1ã¾ãŸã¯2ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        }
      }
      
      let newTarget = 0;
      
      if (newMode === 'down') {
        const currentH = Math.floor(currentTarget / 3600);
        const currentM = Math.floor((currentTarget % 3600) / 60);
        const currentS = currentTarget % 60;
        
        const hours = parseInt(prompt("æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-23)", currentH.toString())) || 0;
        const minutes = parseInt(prompt("åˆ†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", currentM.toString())) || 0;
        const seconds = parseInt(prompt("ç§’ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (0-59)", currentS.toString())) || 0;
        
        newTarget = Math.max(0, Math.min(hours, 23)) * 3600 + 
                   Math.max(0, Math.min(minutes, 59)) * 60 + 
                   Math.max(0, Math.min(seconds, 59));
        
        if (newTarget === 0) {
          alert("æ™‚é–“ãŒ0ç§’ã§ã™ã€‚è¨­å®šã‚’å¤‰æ›´ã—ã¾ã›ã‚“ã§ã—ãŸã€‚");
          return;
        }
      }
      
      // è¨­å®šã‚’æ›´æ–°
      container.setAttribute('data-timer-mode', newMode);
      container.setAttribute('data-timer-target', newTarget.toString());
      container.setAttribute('data-timer-running', 'false');
      
      if (newMode === 'up') {
        container.setAttribute('data-timer-seconds', '0');
        display.textContent = "00:00:00";
      } else {
        container.setAttribute('data-timer-seconds', newTarget.toString());
        const h = Math.floor(newTarget / 3600);
        const m = Math.floor((newTarget % 3600) / 60);
        const s = newTarget % 60;
        display.textContent = 
          String(h).padStart(2, '0') + ':' +
          String(m).padStart(2, '0') + ':' +
          String(s).padStart(2, '0');
      }
      
      // ãƒœã‚¿ãƒ³ã®ãƒªã‚»ãƒƒãƒˆ
      const startBtn = container.querySelector('.timer-btn.start, .timer-btn.pause');
      if (startBtn) {
        startBtn.textContent = "é–‹å§‹";
        startBtn.classList.remove('pause');
        startBtn.classList.add('start');
      }
      
      saveHistory();
    }

    function createButton(labelText, width, height, color, textColor, targetSystemId, targetAlgorithmId, algorithmXml) {
      let btn = document.createElement("button");
      btn.classList.add("draggable-btn");
      btn.textContent = labelText;

      btn.style.width = width + "px";
      btn.style.height = height + "px";
      btn.style.background = color;
      btn.style.color = textColor || "#fff";

      // é·ç§»å…ˆã‚·ã‚¹ãƒ†ãƒ IDã‚’ data å±æ€§ã¨ã—ã¦ä¿å­˜
      if (targetSystemId) {
        btn.setAttribute('data-target-system', targetSystemId);
      }
      
      // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ IDã¨XMLã‚’ data å±æ€§ã¨ã—ã¦ä¿å­˜
      if (targetAlgorithmId) {
        btn.setAttribute('data-algorithm-id', targetAlgorithmId);
      }
      if (algorithmXml) {
        btn.setAttribute('data-algorithm-xml', algorithmXml);
      }

      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        
        // å®Ÿè¡Œç”»é¢ã§ã®ã¿å‹•ä½œ
        const isPreview = btn.closest('#previewSlideArea');
        if (isPreview) {
          // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œã‚’å„ªå…ˆ
          if (targetAlgorithmId && algorithmXml) {
            console.log('ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ:', targetAlgorithmId);
            executeAlgorithmFromButton(algorithmXml, labelText);
          } else if (targetSystemId) {
            // ã‚·ã‚¹ãƒ†ãƒ é·ç§»
            console.log('ã‚·ã‚¹ãƒ†ãƒ é·ç§»:', targetSystemId);
            loadSystemInPreview(targetSystemId);
          }
        }
      });

      let pos = getRandomPosition(width, height);
      btn.style.left = pos.x + "px";
      btn.style.top = pos.y + "px";
      addDragHandleIfMissing(btn);
      makeDraggable(btn);
      document.getElementById("slideArea").appendChild(btn);
      saveHistory();
    }

    const addTextBtn = document.getElementById("addTextBtn");
    if (addTextBtn) {
      addTextBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        createInput("æ–‡å­—ï¼š", "æ–‡å­—ã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œå¯ï¼‰");
      });
    }

    const addNumberBtn = document.getElementById("addNumberBtn");
    if (addNumberBtn) {
      addNumberBtn.addEventListener("click", function(e) {
        e.stopPropagation();
        createInput("æ•°å­—ï¼š", "æ•°å­—ã‚’å…¥åŠ›", true);
      });
    }

    const addDatetimeBtn = document.getElementById("addDatetimeBtn");
    if (addDatetimeBtn) {
      addDatetimeBtn.addEventListener("click", function() {
        createDatetimeInput();
      });
    }

    const addRouletteBtn = document.getElementById("addRouletteBtn");
    if (addRouletteBtn) {
      addRouletteBtn.addEventListener("click", function() {
        createRoulette();
      });
    }

    const addTimerBtn = document.getElementById("addTimerBtn");
    if (addTimerBtn) {
      addTimerBtn.addEventListener("click", function() {
        createTimer();
      });
    }

    const addButtonBtn = document.getElementById("addButtonBtn");
    if (addButtonBtn) {
      addButtonBtn.addEventListener("click", function() {
        let name = prompt("ãƒœã‚¿ãƒ³ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "ãƒœã‚¿ãƒ³");
        if (!name) return;

        let width = parseInt(prompt("ãƒœã‚¿ãƒ³ã®å¹…(px)", "100"));
        let height = parseInt(prompt("ãƒœã‚¿ãƒ³ã®é«˜ã•(px)", "40"));
        if (isNaN(width) || isNaN(height)) {
          alert("æ•°å€¤ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„");
          return;
        }

        let colorNameList = colorOptions.map(opt => opt.name).join(" / ");
        let colorName = prompt(
          "ãƒœã‚¿ãƒ³ã®è‰²ã‚’é¸ã‚“ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š\n" + colorNameList,
          colorOptions[0].name
        );
        if (!colorName) colorName = colorOptions[0].name;
        let colorObj = colorOptions.find(opt => opt.name === colorName);
        if (!colorObj) {
          alert("è‰²ã®åå‰ã¯ã€Œ" + colorNameList + "ã€ã‹ã‚‰é¸ã‚“ã§ãã ã•ã„ã€‚");
          return;
        }

        // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ä¸€è¦§ã‚’å–å¾—ï¼ˆDjangoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ï¼‰
        const algorithms = {{ algorithms_json|safe }};
        const otherSystems = {{ other_systems_json|safe }};
        
        let actionType = prompt("ãƒœã‚¿ãƒ³ã®å‹•ä½œã‚’é¸æŠã—ã¦ãã ã•ã„:\n1. ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ\n2. ã‚·ã‚¹ãƒ†ãƒ é·ç§»\n3. å‹•ä½œãªã—", "1");
        
        let targetSystemId = null;
        let targetAlgorithmId = null;
        let algorithmXml = null;
        
        if (actionType === "1" && algorithms && algorithms.length > 0) {
          // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œã‚’é¸æŠ
          let algorithmList = algorithms.map((algo, idx) => `${idx + 1}. ${algo.algorithm_name}`).join('\n');
          let selectMsg = "å®Ÿè¡Œã™ã‚‹ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„\n\n" + algorithmList;
          let selectedNum = prompt(selectMsg, "1");
          
          if (selectedNum !== null && selectedNum !== "") {
            let idx = parseInt(selectedNum) - 1;
            if (idx >= 0 && idx < algorithms.length) {
              targetAlgorithmId = algorithms[idx].algorithm_id;
              algorithmXml = algorithms[idx].blockly_xml;
            }
          } else {
            return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          }
        } else if (actionType === "2" && otherSystems && otherSystems.length > 0) {
          // ã‚·ã‚¹ãƒ†ãƒ é·ç§»ã‚’é¸æŠ
          let systemList = otherSystems.map((sys, idx) => `${idx + 1}. ${sys.system_name}`).join('\n');
          let selectMsg = "é·ç§»å…ˆã®ã‚·ã‚¹ãƒ†ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆå®Ÿè¡Œç”»é¢ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰\n\n" + systemList;
          let selectedNum = prompt(selectMsg, "1");
          
          if (selectedNum !== null && selectedNum !== "") {
            let idx = parseInt(selectedNum) - 1;
            if (idx >= 0 && idx < otherSystems.length) {
              targetSystemId = otherSystems[idx].system_id;
            }
          } else {
            return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          }
        }

        createButton(name, width, height, colorObj.value, colorObj.textColor, targetSystemId, targetAlgorithmId, algorithmXml);
      });
    }

    window.onload = function() {
      const slide = document.getElementById('slideArea');
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§æ—¢å­˜è¦ç´ ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’å¾©å…ƒ
      if (existingElementsData && existingElementsData.length > 0) {
        console.log('æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ è¦ç´ ã‚’å¾©å…ƒã—ã¾ã™:', existingElementsData);
        restoreSystemElements(existingElementsData);
      } else {
        // ä¿å­˜ç”»é¢ã‹ã‚‰æˆ»ã£ã¦ããŸå ´åˆã®ã¿ã€sessionStorageã‹ã‚‰ä»¥å‰ã®ç·¨é›†å†…å®¹ã‚’å¾©å…ƒ
        const returnFromCreate = sessionStorage.getItem('returnFromCreate');
        const savedContent = sessionStorage.getItem('systemDesignContent');
        
        if (returnFromCreate === 'true' && savedContent && slide) {
          try {
            // JSONå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦è§£æã‚’è©¦ã¿ã‚‹
            const elementsData = JSON.parse(savedContent);
            console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆJSONå½¢å¼ï¼‰:', elementsData);
            restoreSystemElements(elementsData);
          } catch (e) {
            // JSONè§£æã«å¤±æ•—ã—ãŸå ´åˆã¯ã€å¾“æ¥ã®HTMLå½¢å¼ã¨ã—ã¦å‡¦ç†
            console.log('ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆå†…å®¹ã‚’å¾©å…ƒã—ã¾ã™ï¼ˆHTMLå½¢å¼ï¼‰');
            const trash = slide.querySelector('#trash');
            const trashHTML = trash ? trash.outerHTML : '<div id="trash" title="ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã§å‰Šé™¤">ğŸ—‘ï¸</div>';
            slide.innerHTML = savedContent + trashHTML;
          }
        }
      }
      
      // å¾©å…ƒå¾Œã¯ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ¬¡å›ã®é€šå¸¸ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«å¾©å…ƒã—ãªã„ã‚ˆã†ã«ï¼‰
      sessionStorage.removeItem('returnFromCreate');
      
      // navigatingToCreateãƒ•ãƒ©ã‚°ã‚‚ã‚¯ãƒªã‚¢ï¼ˆä¿å­˜ç”»é¢ã«é·ç§»ã—ãŸå¾Œã¯ä¸è¦ï¼‰
      sessionStorage.removeItem('navigatingToCreate');
      
      // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªè¦ç´ ã«ãƒãƒ³ãƒ‰ãƒ«ã‚’è¿½åŠ 
      Array.from(document.querySelectorAll('.input-container, .draggable-btn, .text-input_container, .text-input-container, .checkbox-group, .radio-group, .timer-container')).forEach(el=>{
        addDragHandleIfMissing(el);
        makeDraggable(el);
      });
      
      // æ•°å€¤å…¥åŠ›ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
      document.querySelectorAll('input[data-only-number="true"]').forEach(inp => {
        try { attachNumberFilter(inp); } catch(e){ console.error(e); }
      });
      
      // ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°å‡¦ç†ã‚’é–‹å§‹
      startTimerUpdates();
      
      saveHistory();
    };

    // ã‚¿ã‚¤ãƒãƒ¼ã®æ›´æ–°å‡¦ç†
    function startTimerUpdates() {
      setInterval(function() {
        document.querySelectorAll('.timer-container').forEach(timer => {
          const running = timer.getAttribute('data-timer-running') === 'true';
          if (running) {
            const mode = timer.getAttribute('data-timer-mode') || 'up';
            let seconds = parseInt(timer.getAttribute('data-timer-seconds') || '0');
            
            if (mode === 'up') {
              // ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
              seconds++;
              timer.setAttribute('data-timer-seconds', seconds.toString());
            } else {
              // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
              seconds--;
              if (seconds < 0) seconds = 0;
              timer.setAttribute('data-timer-seconds', seconds.toString());
              
              // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãŒ0ã«ãªã£ãŸã‚‰åœæ­¢
              if (seconds === 0) {
                timer.setAttribute('data-timer-running', 'false');
                const startBtn = timer.querySelector('.timer-btn.pause');
                if (startBtn) {
                  startBtn.textContent = "é–‹å§‹";
                  startBtn.classList.remove('pause');
                  startBtn.classList.add('start');
                }
                // çµ‚äº†éŸ³ã‚’é³´ã‚‰ã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                try {
                  const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBCZ+zPDTgjMGHm7A7+OZSA0PVKXi8bljHAU5j9nyzn0wBSd7y+/aizsIGGS36+mlUxIIRp/j8L5sIAQngM/u2Ig7Bxlqvezom1AQC1Kk4/C0YRsFN47X8s5+MwUneMnv24o5Bxdhu+znnFARC0yi5PC2ZB0FNI/Y8c9/NAYqd8rw2YU1BxhluezloFIRCkug5PC7aB8FNJDa8c+ANAUpfsvv24c4Bxdqu+vkn1ETCkif5/C8aiEFN5Ha8dB9MgUmecnv2og5BxdmuuvjoFQSDEqf5fC7Zh4FNZHa8c9+NAYne8rv3Ic4BxhpuuvhpFMSC0me5/C8aiAFOJLb8dB8MgUmeMjw2og4BxZlvOvhoFETC0qf5fC7aB8FNJDa8c9/NAYneMrv24g5Bxhpuuvho1MTDE2f5O++aR4FNpHb8c99MgUleMju2Yc5BxZkvOvhoFETCkud5e+8ah8FMZHY8c9+MwUneMrv24o4B');
                  audio.play().catch(e => console.log('Audio play failed:', e));
                } catch(e) {}
              }
            }
            
            const display = timer.querySelector('.timer-display');
            if (display) {
              const h = Math.floor(seconds / 3600);
              const m = Math.floor((seconds % 3600) / 60);
              const s = seconds % 60;
              display.textContent = 
                String(h).padStart(2, '0') + ':' +
                String(m).padStart(2, '0') + ':' +
                String(s).padStart(2, '0');
            }
          }
        });
      }, 1000);
    }

    // JSONå½¢å¼ã®è¦ç´ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰HTMLè¦ç´ ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
    function restoreSystemElements(elementsData) {
      const slide = document.getElementById('slideArea');
      if (!slide) return;
      
      elementsData.forEach(elem => {
        try {
          switch(elem.element_type) {
            case 'text_input':
              restoreTextInput(elem, false);
              break;
            case 'number_input':
              restoreTextInput(elem, true);
              break;
            case 'datetime_input':
              restoreDatetimeInput(elem);
              break;
            case 'checkbox_group':
              restoreCheckboxGroup(elem);
              break;
            case 'radio_group':
              restoreRadioGroup(elem);
              break;
            case 'button':
              restoreButton(elem);
              break;
            case 'text_box':
              restoreTextBox(elem);
              break;
            case 'roulette':
              restoreRoulette(elem);
              break;
            case 'timer':
              restoreTimer(elem);
              break;
          }
        } catch (error) {
          console.error('è¦ç´ ã®å¾©å…ƒã«å¤±æ•—:', elem, error);
        }
      });
    }

    function restoreTextInput(elem, onlyNumber) {
      const container = document.createElement("div");
      container.classList.add("input-container");

      const label = document.createElement("div");
      label.classList.add("input-label");
      label.textContent = elem.element_label || (onlyNumber ? "æ•°å­—ï¼š" : "æ–‡å­—ï¼š");
      label.contentEditable = "true";

      const placeholder = elem.element_config?.placeholder || (onlyNumber ? "æ•°å­—ã‚’å…¥åŠ›" : "æ–‡å­—ã‚’å…¥åŠ›ï¼ˆæ”¹è¡Œå¯ï¼‰");
      const actualValue = elem.element_value || ""; // å®Ÿéš›ã®å…¥åŠ›å€¤ï¼ˆç©ºã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ï¼‰

      if (onlyNumber) {
        const input = document.createElement("input");
        input.type = "text";
        input.inputMode = "numeric";
        input.pattern = "\\d*";
        input.classList.add("input-box");
        input.placeholder = placeholder;
        input.value = actualValue; // å®Ÿéš›ã®å…¥åŠ›å€¤ã®ã¿è¨­å®šï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯è¨­å®šã—ãªã„ï¼‰
        input.setAttribute('data-only-number', 'true');
        container.appendChild(label);
        container.appendChild(input);
        attachNumberFilter(input);
      } else {
        const textarea = document.createElement("textarea");
        textarea.classList.add("input-box");
        textarea.placeholder = placeholder;
        textarea.value = actualValue; // å®Ÿéš›ã®å…¥åŠ›å€¤ã®ã¿è¨­å®šï¼ˆãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã¯è¨­å®šã—ãªã„ï¼‰
        container.appendChild(label);
        container.appendChild(textarea);
      }

      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById("slideArea").appendChild(container);
    }

    function restoreDatetimeInput(elem) {
      const container = document.createElement("div");
      container.classList.add("input-container");

      const label = document.createElement("div");
      label.classList.add("input-label");
      label.textContent = elem.element_label || "æ—¥æ™‚ï¼š";
      label.contentEditable = "true";

      const input = document.createElement("input");
      input.type = "datetime-local";
      input.style.minWidth = "180px";
      input.style.minHeight = "36px";
      input.style.fontSize = "16px";
      input.style.padding = "4px 8px";
      input.style.boxSizing = "border-box";
      input.classList.add("input-box");
      input.value = elem.element_value || ""; // æ—¥æ™‚ã®å…¥åŠ›å€¤ã‚’å¾©å…ƒ

      container.appendChild(label);
      container.appendChild(input);

      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = elem.height + "px";

      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById("slideArea").appendChild(container);
    }

    function restoreCheckboxGroup(elem) {
      const group = document.createElement('div');
      group.className = 'checkbox-group';

      // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ 
      if (elem.element_label) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'checkbox-group-label';
        labelDiv.contentEditable = 'true';
        labelDiv.textContent = elem.element_label;
        labelDiv.style.fontWeight = 'bold';
        labelDiv.style.marginBottom = '4px';
        labelDiv.style.cursor = 'text';
        group.appendChild(labelDiv);
      }

      const options = elem.element_config?.options || [];
      options.forEach((optText, i) => {
        const row = document.createElement('div');
        row.className = 'checkbox-row';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.tabIndex = 0;

        const lbl = document.createElement('div');
        lbl.className = 'checkbox-label';
        lbl.contentEditable = 'true';
        lbl.textContent = optText || ('é …ç›® ' + (i + 1));

        row.appendChild(cb);
        row.appendChild(lbl);
        group.appendChild(row);
      });

      group.style.left = elem.position_x + 'px';
      group.style.top = elem.position_y + 'px';
      if (elem.width) group.style.width = elem.width + 'px';
      if (elem.height) group.style.height = elem.height + 'px';

      addDragHandleIfMissing(group);
      makeDraggable(group);
      document.getElementById('slideArea').appendChild(group);
    }

    function restoreRadioGroup(elem) {
      const group = document.createElement('div');
      group.className = 'radio-group';

      // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ©ãƒ™ãƒ«ãŒã‚ã‚Œã°å…ˆé ­ã«è¿½åŠ 
      if (elem.element_label) {
        const labelDiv = document.createElement('div');
        labelDiv.className = 'radio-group-label';
        labelDiv.contentEditable = 'true';
        labelDiv.textContent = elem.element_label;
        labelDiv.style.fontWeight = 'bold';
        labelDiv.style.marginBottom = '4px';
        labelDiv.style.cursor = 'text';
        group.appendChild(labelDiv);
      }

      const uniqueName = 'radio_group_' + Date.now() + '_' + Math.floor(Math.random()*1000);
      const options = elem.element_config?.options || [];
      options.forEach((optText, i) => {
        const row = document.createElement('div');
        row.className = 'radio-row';

        const rb = document.createElement('input');
        rb.type = 'radio';
        rb.name = uniqueName;
        rb.tabIndex = 0;

        const lbl = document.createElement('div');
        lbl.className = 'radio-label';
        lbl.contentEditable = 'true';
        lbl.textContent = optText || ('é …ç›® ' + (i + 1));

        row.appendChild(rb);
        row.appendChild(lbl);
        group.appendChild(row);
      });

      group.style.left = elem.position_x + 'px';
      group.style.top = elem.position_y + 'px';
      if (elem.width) group.style.width = elem.width + 'px';
      if (elem.height) group.style.height = elem.height + 'px';

      addDragHandleIfMissing(group);
      makeDraggable(group);
      document.getElementById('slideArea').appendChild(group);
    }

    function restoreButton(elem) {
      const btn = document.createElement("button");
      btn.classList.add("draggable-btn");
      btn.textContent = elem.element_label || "ãƒœã‚¿ãƒ³";

      if (elem.width) btn.style.width = elem.width + "px";
      if (elem.height) btn.style.height = elem.height + "px";
      
      if (elem.style_data?.background) btn.style.background = elem.style_data.background;
      if (elem.style_data?.color) btn.style.color = elem.style_data.color;

      const targetSystemId = elem.element_config?.target_system_id;
      const algorithmId = elem.element_config?.algorithm_id;
      const algorithmXml = elem.element_config?.algorithm_xml;
      
      if (targetSystemId) {
        btn.setAttribute('data-target-system', targetSystemId);
      }
      if (algorithmId) {
        btn.setAttribute('data-algorithm-id', algorithmId);
      }
      if (algorithmXml) {
        btn.setAttribute('data-algorithm-xml', algorithmXml);
      }

      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const isPreview = btn.closest('#previewSlideArea');
        
        if (isPreview) {
          if (algorithmId && algorithmXml) {
            // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œ
            executeAlgorithmFromButton(algorithmXml, btn.textContent);
          } else if (targetSystemId) {
            // ã‚·ã‚¹ãƒ†ãƒ é·ç§»
            loadSystemInPreview(targetSystemId);
          }
        }
      });

      btn.style.left = elem.position_x + "px";
      btn.style.top = elem.position_y + "px";

      addDragHandleIfMissing(btn);
      makeDraggable(btn);
      document.getElementById("slideArea").appendChild(btn);
    }

    function restoreTextBox(elem) {
      const container = document.createElement('div');
      container.className = 'text-input-container';
      
      container.style.left = elem.position_x + 'px';
      container.style.top = elem.position_y + 'px';
      if (elem.width) container.style.width = elem.width + 'px';
      if (elem.height) container.style.height = elem.height + 'px';

      const ta = document.createElement('textarea');
      ta.className = 'text-input';
      ta.value = elem.element_value || '';
      ta.placeholder = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›';
      ta.spellcheck = false;

      container.appendChild(ta);
      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById('slideArea').appendChild(container);
    }

    function restoreRoulette(elem) {
      const container = document.createElement("div");
      container.classList.add("roulette-container");
      
      const config = elem.element_config || {};
      const items = config.items || ['é …ç›®1', 'é …ç›®2', 'é …ç›®3'];
      
      container.setAttribute('data-roulette-items', JSON.stringify(items));
      container.setAttribute('data-roulette-spinning', 'false');
      
      // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆã®å††ã‚’ä½œæˆï¼ˆSVGãƒ™ãƒ¼ã‚¹ï¼‰
      const wheel = document.createElement("div");
      wheel.classList.add("roulette-wheel");
      wheel.style.position = "relative";
      wheel.style.width = "200px";
      wheel.style.height = "200px";
      wheel.style.transition = "transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)";
      wheel.dataset.currentRotation = "0"; // ç¾åœ¨ã®å›è»¢è§’åº¦ã‚’ä¿æŒ
      
      const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      svg.setAttribute("width", "200");
      svg.setAttribute("height", "200");
      svg.setAttribute("viewBox", "0 0 200 200");
      
      // é …ç›®ã‚’å††çŠ¶ã«é…ç½®
      const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B500', '#52C41A'];
      const centerX = 100;
      const centerY = 100;
      const radius = 95;
      const anglePerSegment = (2 * Math.PI) / items.length;
      
      items.forEach((item, index) => {
        const startAngle = index * anglePerSegment - Math.PI / 2;
        const endAngle = (index + 1) * anglePerSegment - Math.PI / 2;
        
        // æ‰‡å½¢ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
        const x1 = centerX + radius * Math.cos(startAngle);
        const y1 = centerY + radius * Math.sin(startAngle);
        const x2 = centerX + radius * Math.cos(endAngle);
        const y2 = centerY + radius * Math.sin(endAngle);
        
        const largeArcFlag = anglePerSegment > Math.PI ? 1 : 0;
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("d", `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
        path.setAttribute("fill", colors[index % colors.length]);
        path.setAttribute("stroke", "#fff");
        path.setAttribute("stroke-width", "2");
        svg.appendChild(path);
        
        // ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸­å¤®ã«é…ç½®
        const textAngle = startAngle + anglePerSegment / 2;
        const textRadius = radius * 0.65;
        const textX = centerX + textRadius * Math.cos(textAngle);
        const textY = centerY + textRadius * Math.sin(textAngle);
        
        const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
        text.setAttribute("x", textX);
        text.setAttribute("y", textY);
        text.setAttribute("text-anchor", "middle");
        text.setAttribute("dominant-baseline", "middle");
        text.setAttribute("fill", "#fff");
        text.setAttribute("font-size", "14");
        text.setAttribute("font-weight", "bold");
        text.setAttribute("transform", `rotate(${(textAngle * 180 / Math.PI) + 90}, ${textX}, ${textY})`);
        text.style.textShadow = "1px 1px 2px rgba(0,0,0,0.8)";
        text.textContent = item;
        svg.appendChild(text);
      });
      
      // å¤–æ ã®å††
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", centerX);
      circle.setAttribute("cy", centerY);
      circle.setAttribute("r", radius);
      circle.setAttribute("fill", "none");
      circle.setAttribute("stroke", "#333");
      circle.setAttribute("stroke-width", "4");
      svg.appendChild(circle);
      
      wheel.appendChild(svg);
      
      // ä¸­å¤®ã®ãƒ”ãƒ³ï¼ˆ12æ™‚ã®ä½ç½®ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ0ã®é–‹å§‹ç‚¹ï¼‰
      const pin = document.createElement("div");
      pin.style.position = "absolute";
      pin.style.top = "-15px"; // çŸ¢å°ã®å…ˆç«¯ãŒå††ã®ä¸Šç«¯ï¼ˆy=5pxï¼‰ã«è§¦ã‚Œã‚‹ä½ç½®
      pin.style.left = "48%";
      pin.style.transform = "translateX(-50%)";
      pin.style.width = "0";
      pin.style.height = "0";
      pin.style.borderLeft = "10px solid transparent";
      pin.style.borderRight = "10px solid transparent";
      pin.style.borderTop = "20px solid #FF0000"; // ä¸‹å‘ãã®çŸ¢å°
      pin.style.zIndex = "10";
      pin.style.pointerEvents = "none";
      
      // çµæœè¡¨ç¤º
      const result = document.createElement("div");
      result.classList.add("roulette-result");
      result.style.marginTop = "10px";
      result.style.padding = "8px";
      result.style.background = "#f0f0f0";
      result.style.borderRadius = "4px";
      result.style.textAlign = "center";
      result.style.fontWeight = "bold";
      result.textContent = "çµæœ: -";
      
      // ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³
      const spinBtn = document.createElement("button");
      spinBtn.classList.add("roulette-btn", "spin");
      spinBtn.textContent = "ã‚¹ãƒ”ãƒ³";
      spinBtn.style.marginTop = "10px";
      spinBtn.style.padding = "8px 20px";
      spinBtn.style.fontSize = "16px";
      spinBtn.style.cursor = "pointer";
      spinBtn.style.position = "relative";
      spinBtn.style.zIndex = "100";
      spinBtn.onclick = function(e) {
        e.stopPropagation();
        const spinning = container.getAttribute('data-roulette-spinning') === 'true';
        if (spinning) return;
        
        container.setAttribute('data-roulette-spinning', 'true');
        spinBtn.disabled = true;
        spinBtn.style.cursor = 'not-allowed';
        spinBtn.style.opacity = '0.6';
        
        // ç¾åœ¨ã®å›è»¢è§’åº¦ã‚’å–å¾—
        const currentRotation = parseFloat(wheel.dataset.currentRotation) || 0;
        
        // ãƒ©ãƒ³ãƒ€ãƒ ã«å›è»¢ï¼ˆå¸¸ã«æ­£ã®æ–¹å‘ã«ç´¯ç©ï¼‰
        const spins = 5 + Math.random() * 3;
        const extraDegrees = Math.random() * 360;
        const newRotation = currentRotation + spins * 360 + extraDegrees;
        
        wheel.style.transform = `rotate(${newRotation}deg)`;
        wheel.dataset.currentRotation = newRotation;
        
        // 3ç§’å¾Œã«çµæœã‚’è¡¨ç¤º
        setTimeout(() => {
          // çŸ¢å°ã¯ä¸Šéƒ¨ï¼ˆ-90åº¦ = 270åº¦ï¼‰ã«å›ºå®š
          // ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆãŒæ™‚è¨ˆå›ã‚Šã«finalAngleåº¦å›è»¢ã—ãŸå ´åˆã€
          // çŸ¢å°ãŒæŒ‡ã™ã®ã¯ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆä¸Šã® (270 - finalAngle) åº¦ã®ä½ç½®
          const finalAngle = ((newRotation % 360) + 360) % 360;
          const segmentAngle = 360 / items.length;
          const angleOnWheel = (270 - finalAngle + 360) % 360;
          // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯270åº¦ï¼ˆ-90åº¦ï¼‰ã‹ã‚‰é–‹å§‹ã™ã‚‹ã®ã§ã€è£œæ­£ã—ã¦è¨ˆç®—
          const selectedIndex = Math.floor((angleOnWheel + 90) / segmentAngle) % items.length;
          
          result.textContent = `çµæœ: ${items[selectedIndex]}`;
          container.setAttribute('data-roulette-spinning', 'false');
          spinBtn.disabled = false;
          spinBtn.style.cursor = 'pointer';
          spinBtn.style.opacity = '1';
        }, 3000);
      };
      
      // è¦ç´ ã‚’çµ„ã¿ç«‹ã¦
      const wheelWrapper = document.createElement("div");
      wheelWrapper.style.position = "relative";
      wheelWrapper.style.pointerEvents = "none";
      wheelWrapper.appendChild(pin);
      wheelWrapper.appendChild(wheel);
      
      container.appendChild(wheelWrapper);
      container.appendChild(result);
      container.appendChild(spinBtn);
      
      container.style.left = elem.position_x + "px";
      container.style.top = elem.position_y + "px";
      if (elem.width) container.style.width = elem.width + "px";
      if (elem.height) container.style.height = "px";

      addDragHandleIfMissing(container);
      makeDraggable(container);
      makeResizable(container);
      document.getElementById('slideArea').appendChild(container);
    }

    function restoreTimer(elem) {
      const container = document.createElement("div");
      container.classList.add("timer-container");
      
      // element_configã‹ã‚‰ãƒ¢ãƒ¼ãƒ‰ã¨ç›®æ¨™æ™‚é–“ã‚’å–å¾—
      const mode = elem.element_config?.mode || 'up';
      const targetSeconds = elem.element_config?.target || 0;
      
      container.setAttribute('data-timer-seconds', elem.element_value || '0');
      container.setAttribute('data-timer-running', 'false');
      container.setAttribute('data-timer-mode', mode);
      container.setAttribute('data-timer-target', targetSeconds.toString());

      // ã‚¿ã‚¤ãƒãƒ¼è¨­å®šãƒœã‚¿ãƒ³(ç·¨é›†ç”¨)
      const settingsBtn = document.createElement("button");
      settingsBtn.classList.add("timer-settings-btn");
      settingsBtn.textContent = "âš™ è¨­å®š";
      settingsBtn.title = "ã‚¿ã‚¤ãƒãƒ¼è¨­å®šã‚’å¤‰æ›´";
      settingsBtn.onclick = function(e) {
        e.stopPropagation();
        openTimerSettings(container, display);
      };

      // è¡¨ç¤ºéƒ¨åˆ†
      const display = document.createElement("div");
      display.classList.add("timer-display");
      
      const seconds = parseInt(elem.element_value || '0');
      const hDisp = Math.floor(seconds / 3600);
      const mDisp = Math.floor((seconds % 3600) / 60);
      const sDisp = seconds % 60;
      display.textContent = 
        String(hDisp).padStart(2, '0') + ':' +
        String(mDisp).padStart(2, '0') + ':' +
        String(sDisp).padStart(2, '0');

      // æ“ä½œãƒœã‚¿ãƒ³
      const controls = document.createElement("div");
      controls.classList.add("timer-controls");

      const startBtn = document.createElement("button");
      startBtn.classList.add("timer-btn", "start");
      startBtn.textContent = "é–‹å§‹";
      startBtn.onclick = function(e) {
        e.stopPropagation();
        const running = container.getAttribute('data-timer-running') === 'true';
        const timerMode = container.getAttribute('data-timer-mode');
        
        if (!running) {
          if (timerMode === 'down') {
            const target = parseInt(container.getAttribute('data-timer-target') || '0');
            if (target === 0) {
              alert('ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®æ™‚é–“ã‚’è¨­å®šã—ã¦ãã ã•ã„');
              return;
            }
          }
          container.setAttribute('data-timer-running', 'true');
          startBtn.textContent = "åœæ­¢";
          startBtn.classList.remove('start');
          startBtn.classList.add('pause');
        } else {
          container.setAttribute('data-timer-running', 'false');
          startBtn.textContent = "é–‹å§‹";
          startBtn.classList.remove('pause');
          startBtn.classList.add('start');
        }
      };

      const resetBtn = document.createElement("button");
      resetBtn.classList.add("timer-btn", "reset");
      resetBtn.textContent = "ãƒªã‚»ãƒƒãƒˆ";
      resetBtn.onclick = function(e) {
        e.stopPropagation();
        const timerMode = container.getAttribute('data-timer-mode');
        container.setAttribute('data-timer-running', 'false');
        
        if (timerMode === 'up') {
          container.setAttribute('data-timer-seconds', '0');
          display.textContent = "00:00:00";
        } else {
          const target = parseInt(container.getAttribute('data-timer-target') || '0');
          container.setAttribute('data-timer-seconds', target.toString());
          const h = Math.floor(target / 3600);
          const m = Math.floor((target % 3600) / 60);
          const s = target % 60;
          display.textContent = 
            String(h).padStart(2, '0') + ':' +
            String(m).padStart(2, '0') + ':' +
            String(s).padStart(2, '0');
        }
        
        startBtn.textContent = "é–‹å§‹";
        startBtn.classList.remove('pause');
        startBtn.classList.add('start');
      };

      controls.appendChild(startBtn);
      controls.appendChild(resetBtn);
      
      container.appendChild(settingsBtn);
      container.appendChild(display);
      container.appendChild(controls);

      container.style.left = elem.position_x + 'px';
      container.style.top = elem.position_y + 'px';
      if (elem.width) container.style.width = elem.width + 'px';
      if (elem.height) container.style.height = elem.height + 'px';

      addDragHandleIfMissing(container);
      makeDraggable(container);
      document.getElementById('slideArea').appendChild(container);
    }
  </script>

  <!-- ã“ã“ã‹ã‚‰è¿½åŠ : PowerPointé¢¨ã«é¸æŠç¯„å›²ã§ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã§ãã‚‹æ©Ÿèƒ½ -->
  <script>
    (function(){
      const slide = document.getElementById('slideArea');
      const buttonBar = document.querySelector('.button-bar');
      if (!slide || !buttonBar) return;

      const drawBtn = document.createElement('button');
      drawBtn.id = 'drawTextBtn';
      drawBtn.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹';
      drawBtn.title = 'ãƒ‰ãƒ©ãƒƒã‚°ã§é¸æŠã—ã¦ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ';
      buttonBar.appendChild(drawBtn);

      let drawing = false;
      let startX = 0, startY = 0;
      let selRect = null;

      function toLocalCoords(clientX, clientY) {
        const rect = slide.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        return {x, y};
      }

      function startDrawing(e) {
        if (!drawing) return;
        if (e.button !== 0) return;
        const coords = toLocalCoords(e.clientX, e.clientY);
        startX = Math.max(0, Math.min(slide.clientWidth, coords.x));
        startY = Math.max(0, Math.min(slide.clientHeight, coords.y));
        selRect = document.createElement('div');
        selRect.className = 'textarea-selection';
        selRect.style.left = startX + 'px';
        selRect.style.top = startY + 'px';
        selRect.style.width = '0px';
        selRect.style.height = '0px';
        slide.appendChild(selRect);
        document.addEventListener('mousemove', onMouseMoveDuringDraw);
        document.addEventListener('mouseup', onMouseUpAfterDraw);
      }

      function onMouseMoveDuringDraw(e) {
        if (!selRect) return;
        const coords = toLocalCoords(e.clientX, e.clientY);
        let curX = Math.max(0, Math.min(slide.clientWidth, coords.x));
        let curY = Math.max(0, Math.min(slide.clientHeight, coords.y));
        const left = Math.min(startX, curX);
        const top = Math.min(startY, curY);
        const w = Math.max(2, Math.abs(curX - startX));
        const h = Math.max(2, Math.abs(curY - startY));
        selRect.style.left = left + 'px';
        selRect.style.top = top + 'px';
        selRect.style.width = w + 'px';
        selRect.style.height = h + 'px';
      }

      function onMouseUpAfterDraw(e) {
        document.removeEventListener('mousemove', onMouseMoveDuringDraw);
        document.removeEventListener('mouseup', onMouseUpAfterDraw);
        if (!selRect) return;
        const rect = selRect.getBoundingClientRect();
        const slideRect = slide.getBoundingClientRect();
        const left = rect.left - slideRect.left;
        const top = rect.top - slideRect.top;
        const width = rect.width;
        const height = rect.height;
        selRect.remove();
        selRect = null;
        if (width < 8 || height < 8) {
          drawing = false;
          drawBtn.classList.remove('active');
          slide.style.cursor = '';
          return;
        }
        const container = document.createElement('div');
        container.className = 'text-input-container';
        container.style.left = left + 'px';
        container.style.top = top + 'px';
        container.style.width = width + 'px';
        container.style.height = height + 'px';
        const ta = document.createElement('textarea');
        ta.className = 'text-input';
        ta.placeholder = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›';
        ta.spellcheck = false;
        container.appendChild(ta);
        addDragHandleIfMissing(container);
        makeDraggable(container);
        slide.appendChild(container);
        saveHistory();
        drawing = false;
        drawBtn.classList.remove('active');
        slide.style.cursor = '';
      }

      drawBtn.addEventListener('click', function(){
        drawing = !drawing;
        drawBtn.classList.toggle('active', drawing);
        slide.style.cursor = drawing ? 'crosshair' : '';
      });

      slide.addEventListener('mousedown', function(e){
        startDrawing(e);
      });

      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape' && drawing) {
          if (selRect) { selRect.remove(); selRect = null; }
          drawing = false;
          drawBtn.classList.remove('active');
          slide.style.cursor = '';
        }
      });

      window.addEventListener('resize', function(){
        if (selRect) { selRect.remove(); selRect = null; }
      });

    })();

    // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œé–¢æ•°ï¼ˆblock/index.htmlã¨åŒã˜æ–¹å¼ï¼‰
    async function executeAlgorithmFromButton(blocklyXml, buttonName) {
      console.log('ğŸ¯ ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œé–‹å§‹:', buttonName);
      
      if (!blocklyXml) {
        alert('ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // BlocklyãŒã¾ã ãƒ­ãƒ¼ãƒ‰ä¸­ã®å ´åˆã¯ã€loadBlockly()ã‚’å¾…æ©Ÿ
      if (typeof Blockly === 'undefined') {
        console.log('â³ Blocklyã‚’ãƒ­ãƒ¼ãƒ‰ä¸­...');
        try {
          await loadBlockly();
          console.log('âœ… Blockly loaded successfully');
        } catch (error) {
          console.error('âŒ Blockly loading failed:', error);
          const retry = confirm('Blocklyã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\nãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ');
          if (retry) {
            location.reload();
          }
          return;
        }
      }
      
      console.log('âœ… Blockly ready, executing algorithm');

      try {
        // éè¡¨ç¤ºã®Blocklyãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆ
        const tempDiv = document.createElement('div');
        tempDiv.style.display = 'none';
        document.body.appendChild(tempDiv);

        const workspace = Blockly.inject(tempDiv, {
          toolbox: '<xml></xml>'
        });

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®šç¾©
        if (!Blockly.Blocks['load_system']) {
          Blockly.Blocks['load_system'] = {
            init: function() {
              this.appendDummyInput()
                .appendField("ã‚·ã‚¹ãƒ†ãƒ ã‚’ã‚ˆã¿ã“ã‚€:")
                .appendField(new Blockly.FieldTextInput("0"), "SYSTEM_ID");
              this.setPreviousStatement(true);
              this.setNextStatement(true);
              this.setColour(290);
            }
          };
        }

        if (!Blockly.Blocks['system_condition']) {
          Blockly.Blocks['system_condition'] = {
            init: function() {
              this.appendDummyInput()
                .appendField("ã‚‚ã— ã‚·ã‚¹ãƒ†ãƒ ")
                .appendField(new Blockly.FieldTextInput("0"), "SYSTEM_ID")
                .appendField("ã®");
              this.appendDummyInput()
                .appendField("ãƒ©ãƒ™ãƒ«ï¼š")
                .appendField(new Blockly.FieldTextInput("æ–‡å­—ï¼š"), "ELEMENT_NAME")
                .appendField("ãŒ");
              this.appendDummyInput()
                .appendField(new Blockly.FieldTextInput("="), "OP")
                .appendField(new Blockly.FieldTextInput("ã‚ãŸã„"), "VALUE")
                .appendField("ãªã‚‰");
              this.appendStatementInput("DO")
                .appendField("ã™ã‚‹ã“ã¨");
              this.appendStatementInput("ELSE")
                .appendField("ãã†ã§ãªã‘ã‚Œã°");
              this.setPreviousStatement(true);
              this.setNextStatement(true);
              this.setColour(290);
            }
          };
        }

        if (!Blockly.Blocks['display_system']) {
          Blockly.Blocks['display_system'] = {
            init: function() {
              this.appendDummyInput()
                .appendField("ã‚·ã‚¹ãƒ†ãƒ ã‚’ã²ã‚‡ã†ã˜:")
                .appendField(new Blockly.FieldTextInput("0"), "SYSTEM_ID");
              this.setPreviousStatement(true);
              this.setNextStatement(true);
              this.setColour(290);
            }
          };
        }

        if (!Blockly.Blocks['text_block']) {
          Blockly.Blocks['text_block'] = {
            init: function() {
              this.appendDummyInput()
                .appendField("ãƒ†ã‚­ã‚¹ãƒˆ:")
                .appendField(new Blockly.FieldTextInput("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"), "message");
              this.setPreviousStatement(true);
              this.setNextStatement(true);
              this.setColour(160);
            }
          };
        }

        // XMLã‹ã‚‰ãƒ–ãƒ­ãƒƒã‚¯ã‚’èª­ã¿è¾¼ã‚€
        const xml = Blockly.utils.xml.textToDom(blocklyXml);
        Blockly.Xml.domToWorkspace(xml, workspace);

        // ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç›´æ¥å‡¦ç†ï¼ˆblock/index.htmlã¨åŒã˜æ–¹å¼ï¼‰
        const blocks = workspace.getTopBlocks(true);
        
        // processBlocké–¢æ•°ã‚’å®šç¾©ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        async function processBlock(block) {
          if (!block) return;
          
          switch(block.type) {
            case 'text_block':
              const msg = block.getFieldValue('message') || '';
              console.log('ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ:', msg);
              break;
              
            case 'system_condition':
              const sysId = block.getFieldValue('SYSTEM_ID');
              const elementName = block.getFieldValue('ELEMENT_NAME');
              const op = block.getFieldValue('OP');
              const expectedValue = block.getFieldValue('VALUE');
              
              try {
                // ç¾åœ¨ã®å®Ÿè¡Œç”»é¢ã‹ã‚‰è¦ç´ ã®å€¤ã‚’å–å¾—
                const previewArea = document.getElementById('previewSlideArea');
                if (!previewArea) {
                  throw new Error('å®Ÿè¡Œç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // ãƒ©ãƒ™ãƒ«ãŒä¸€è‡´ã™ã‚‹å…¥åŠ›è¦ç´ ã‚’æ¢ã™
                let actualValue = '';
                
                // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ»æ•°å€¤å…¥åŠ›ãƒ»æ—¥æ™‚å…¥åŠ›ã‚’æ¢ã™
                const inputContainers = previewArea.querySelectorAll('.input-container');
                for (const container of inputContainers) {
                  const label = container.querySelector('.input-label');
                  if (label && label.textContent.trim() === elementName) {
                    const input = container.querySelector('.input-box');
                    if (input) {
                      actualValue = input.value || '';
                      console.log(`ğŸ“ å…¥åŠ›æ¬„ã€Œ${elementName}ã€ã‹ã‚‰å€¤ã‚’å–å¾—: "${actualValue}"`);
                      break;
                    }
                  }
                }
                
                // ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ¢ã™
                if (!actualValue) {
                  const textContainers = previewArea.querySelectorAll('.text-input-container');
                  for (const container of textContainers) {
                    const textDiv = container.querySelector('.text-input');
                    if (textDiv && textDiv.textContent.trim() === elementName) {
                      actualValue = textDiv.textContent || '';
                      console.log(`ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã€Œ${elementName}ã€ã‹ã‚‰å€¤ã‚’å–å¾—: "${actualValue}"`);
                      break;
                    }
                  }
                }
                
                let conditionMet = false;
                switch(op) {
                  case 'EQ': conditionMet = (actualValue == expectedValue); break;
                  case 'NEQ': conditionMet = (actualValue != expectedValue); break;
                  case 'GT': conditionMet = (Number(actualValue) > Number(expectedValue)); break;
                  case 'LT': conditionMet = (Number(actualValue) < Number(expectedValue)); break;
                  case 'GTE': conditionMet = (Number(actualValue) >= Number(expectedValue)); break;
                  case 'LTE': conditionMet = (Number(actualValue) <= Number(expectedValue)); break;
                  case 'CONTAINS': conditionMet = actualValue.includes(expectedValue); break;
                }
                
                console.log(`ğŸ” ã€Œ${elementName}ã€ã®å€¤: "${actualValue}" ${conditionMet ? 'âœ“æ¡ä»¶æº€ãŸã™' : 'âœ—æ¡ä»¶æº€ãŸã•ãªã„'} (æœŸå¾…å€¤: "${expectedValue}", æ¼”ç®—å­: ${op})`);
                
                if (conditionMet) {
                  const doBlock = block.getInputTargetBlock('DO');
                  if (doBlock) await processBlock(doBlock);
                } else {
                  const elseBlock = block.getInputTargetBlock('ELSE');
                  if (elseBlock) await processBlock(elseBlock);
                }
              } catch (error) {
                console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error.message);
              }
              break;
              
            case 'load_system':
              const loadSysId = block.getFieldValue('SYSTEM_ID');
              console.log(`ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿: ID=${loadSysId}`);
              if (loadSysId && loadSysId !== '0') {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã‚€
                if (typeof loadSystemInPreview === 'function') {
                  loadSystemInPreview(loadSysId);
                }
              }
              break;
              
            case 'display_system':
              const displaySysId = block.getFieldValue('SYSTEM_ID');
              console.log(`ğŸ“º ã‚·ã‚¹ãƒ†ãƒ è¡¨ç¤º: ID=${displaySysId}`);
              if (displaySysId && displaySysId !== '0') {
                // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã§ã‚·ã‚¹ãƒ†ãƒ ã‚’è¡¨ç¤º
                if (typeof loadSystemInPreview === 'function') {
                  loadSystemInPreview(displaySysId);
                }
              }
              break;
              
            default:
              // ãã®ä»–ã®ãƒ–ãƒ­ãƒƒã‚¯ã¯ãƒ­ã‚°ã®ã¿
              console.log(`ğŸ”§ ãƒ–ãƒ­ãƒƒã‚¯å®Ÿè¡Œ: ${block.type}`);
          }
          
          const next = block.getNextBlock();
          if (next) await processBlock(next);
        }
        
        // ã™ã¹ã¦ã®ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ã‚’å®Ÿè¡Œ
        for (const b of blocks) {
          await processBlock(b);
        }

        console.log(`âœ… ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€Œ${buttonName}ã€ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ`);

        // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        workspace.dispose();
        tempDiv.remove();

      } catch (error) {
        console.error('ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
        alert(`ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${error.message}`);
      }
    }
  </script>

{% endblock %}