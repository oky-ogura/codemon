{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
{% include 'system/_styles.html' %}
{% endblock %}

{% block content %}
{% include 'system/_content.html' %}
{% endblock %}

{% block extra_js %}
{% include 'system/_blockly_loader.html' %}
{% include 'system/_drag_drop.html' %}
{% include 'system/_history.html' %}
{% include 'system/_preview.html' %}

<script>
// ========================================
// ユーティリティ関数
// ========================================

function getRandomPosition(width=100, height=40) {
  const slide = document.getElementById("slideArea");
  const x = Math.random() * Math.max(0, slide.clientWidth - width);
  const y = Math.random() * Math.max(0, slide.clientHeight - height);
  return {x, y};
}

function attachNumberFilter(input){
  if(!input) return;
  if (input._numberFilterAttached) return;
  input._numberFilterAttached = true;
  input.addEventListener('input', function(){
    const prevPos = input.selectionStart;
    const sanitized = input.value.replace(/[^\d\.\-]/g, '');
    if (sanitized !== input.value) {
      input.value = sanitized;
      try { input.setSelectionRange(Math.max(0, prevPos - 1), Math.max(0, prevPos - 1)); } catch(e){}
    }
  });
  input.addEventListener('keydown', function(e){
    const allowedKeys = ['Backspace','Tab','Enter','ArrowLeft','ArrowRight','Delete','ArrowUp','ArrowDown','Home','End'];
    if (allowedKeys.indexOf(e.key) !== -1) return;
    if ((e.ctrlKey || e.metaKey) && ['a','c','v','x','z','y'].indexOf(e.key.toLowerCase()) !== -1) return;
    if (!/^[0-9.\-]$/.test(e.key)) {
      e.preventDefault();
    }
  });
  input.addEventListener('paste', function(e){
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text') || '';
    const sanitized = text.replace(/[^\d\.\-]/g, '');
    const start = input.selectionStart || 0;
    const end = input.selectionEnd || 0;
    const newVal = input.value.slice(0,start) + sanitized + input.value.slice(end);
    input.value = newVal;
    const pos = start + sanitized.length;
    try { input.setSelectionRange(pos, pos); } catch(e){}
    input.dispatchEvent(new Event('input', { bubbles: true }));
  });
}
</script>

{% include 'system/_elements_create.html' %}
{% include 'system/_elements_restore.html' %}
{% include 'system/_algorithm.html' %}
{% endblock %}
