{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_blue.png' %}" 
     alt="" 
     class="bg-frame"
     onerror="this.style.display='none';">
{% endblock %}

{% block title %}ルーレットお題表示 - Codemon{% endblock %}

{% block extra_css %}
<style>
    :root{ --nav-height:56px; --primary:#1976d2; --muted:#666; --bg:#f9f9fb; }
    
    /* ページ全体のスクロールを有効化 */
    html, body {
      overflow-y: auto !important;
      height: auto !important;
      min-height: 100vh;
    }
    
    /* ナビゲーション表示状態の制御 */
    .top-tabs {
      display: block; /* 常に表示 */
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .top-tabs.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    /* メインコンテンツエリア */
    main { 
      width:100%; 
      max-width:980px; 
      margin:100px auto 40px auto; 
      box-sizing:border-box; 
      padding: 0 20px 40px 20px;
      min-height: calc(100vh - 140px);
    }

    /* ルーレットセクション */
    .roulette-section {
      background:#fff;
      border-radius:10px;
      padding:24px;
      box-shadow:0 6px 18px rgba(10,10,10,0.04);
      border:1px solid #eef2f6;
      max-width:820px;
      margin:18px auto;
    }

    .roulette-title {
      font-size:20px;
      font-weight:700;
      color:#223;
      margin-bottom:16px;
      text-align:center;
    }

    .roulette-container {
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:20px;
      margin-bottom:24px;
    }

    .roulette-wheel {
      width:300px;
      height:300px;
      border:4px solid #1976d2;
      border-radius:50%;
      position:relative;
      background:conic-gradient(
        from 270deg,
        #ff6b6b 0deg 72deg,
        #4ecdc4 72deg 144deg,
        #ffe66d 144deg 216deg,
        #a8e6cf 216deg 288deg,
        #ffd3b6 288deg 360deg
      );
      transition:transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }

    .roulette-wheel::after {
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      width:40px;
      height:40px;
      background:#fff;
      border:3px solid #1976d2;
      border-radius:50%;
    }

    .roulette-arrow {
      width:0;
      height:0;
      border-left:15px solid transparent;
      border-right:15px solid transparent;
      border-top:30px solid #b00020;
      margin-bottom:-10px;
    }

    .roulette-topics {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));
      gap:12px;
      width:100%;
      max-width:600px;
    }

    .topic-item {
      padding:12px;
      border-radius:8px;
      text-align:center;
      font-size:14px;
      font-weight:600;
      color:#fff;
      border:3px solid transparent;
      transition:all 0.3s ease;
    }

    .topic-item:nth-child(1) { background:#ff6b6b; } /* クイズシステム - 赤 */
    .topic-item:nth-child(2) { background:#4ecdc4; } /* 料理システム - 青緑 */
    .topic-item:nth-child(3) { background:#ffe66d; color:#223; } /* 睡眠管理システム - 黄 */
    .topic-item:nth-child(4) { background:#a8e6cf; color:#223; } /* スケジュール管理システム - 緑 */
    .topic-item:nth-child(5) { background:#ffd3b6; color:#223; } /* 翻訳システム - オレンジ */

    .topic-item.selected {
      border-color:#1976d2;
      box-shadow:0 4px 12px rgba(25, 118, 210, 0.4);
      transform:scale(1.05);
    }

    .roulette-controls {
      display:flex;
      gap:12px;
      justify-content:center;
      margin-top:16px;
    }

    .btn-roulette {
      padding:12px 24px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      font-size:16px;
      background: linear-gradient(180deg,#e6f0ff,#cfe6ff);
      color:#073763;
      box-shadow:0 8px 18px rgba(10,59,110,0.06);
      transition:transform 0.2s;
    }

    .btn-roulette:hover {
      transform:translateY(-2px);
    }

    .btn-roulette:disabled {
      opacity:0.5;
      cursor:not-allowed;
    }

    /* フォーム周り */
    .form-card {
      background:#fff;
      border-radius:10px;
      padding:18px;
      box-shadow:0 6px 18px rgba(10,10,10,0.04);
      border:1px solid #eef2f6;
      max-width:820px;
      margin:18px auto;
      display:none; /* 初期状態では非表示 */
    }

    .form-card.show {
      display:block;
    }

    .form-row { 
      display:flex; 
      flex-direction:column; 
      gap:8px; 
      margin-bottom:12px; 
    }
    
    label { 
      font-weight:600; 
      color:#223; 
      font-size:14px; 
    }
    
    input[type="text"], textarea, input[type="date"] {
      width:100%;
      box-sizing:border-box;
      padding:10px 12px;
      border-radius:8px;
      border:1px solid #d7dce1;
      font-size:15px;
      background:#fff;
      color:#111;
    }
    
    textarea { 
      height: 100px; 
      min-height: 100px;
      max-height: 100px;
      resize: none; 
      overflow-y: auto;
    }
    
    .controls { 
      display:flex; 
      gap:12px; 
      justify-content:flex-end; 
      margin-top:8px; 
    }
    
    .btn {
      padding:10px 16px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    
    .btn-primary {
      background: linear-gradient(180deg,#e6f0ff,#cfe6ff);
      color:#073763;
      box-shadow:0 8px 18px rgba(10,59,110,0.06);
    }
    
    .btn-ghost {
      background:transparent;
      color:#444;
      border:1px solid #e6e9ee;
    }
    
    .hint { 
      font-size:13px; 
      color:#666; 
      margin-top:6px; 
    }
    
    .error { 
      color:#b00020; 
      font-size:13px; 
      margin-top:6px; 
      display:none; 
    }

    @media (max-width:640px){
      .controls { 
        flex-direction:column-reverse; 
        align-items:stretch; 
      }
      .roulette-wheel {
        width:250px;
        height:250px;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <main>
    <!-- ルーレットセクション -->
    <div class="roulette-section">
      <h2 class="roulette-title">ルーレットでトピックを選択</h2>
      
      <div class="roulette-container">
        <div class="roulette-arrow"></div>
        <div class="roulette-wheel" id="rouletteWheel"></div>
      </div>

      <div class="roulette-topics" id="rouletteTopics">
        <div class="topic-item">クイズシステム</div>
        <div class="topic-item">料理システム</div>
        <div class="topic-item">睡眠管理システム</div>
        <div class="topic-item">スケジュール管理システム</div>
        <div class="topic-item">翻訳システム</div>
      </div>

      <div class="roulette-controls">
        <button class="btn-roulette" id="spinBtn">ルーレットを回す</button>
      </div>
    </div>

    <!-- システム作成フォーム -->
    <form method="post" action="{% url 'accounts:system_create' %}" class="form-card" id="systemForm" aria-labelledby="formTitle">
      {% csrf_token %}
      <div id="formTitle" style="display:none">システム作成フォーム</div>

      <!-- 編集モードの場合、システムIDを送信 -->
      <input type="hidden" id="systemId" name="system_id" value="" />
      
      <!-- システム要素データをJSON形式で送信 -->
      <input type="hidden" id="elementsData" name="elements_data" value="" />

      <div class="form-row">
        <label for="systemName">システム名 <span aria-hidden="true">※</span></label>
        <input id="systemName" name="system_name" type="text" placeholder="例：顧客管理システム" maxlength="20" required aria-required="true" />
        <div class="hint" id="nameHint">必須（最大20文字）</div>
        <div class="error" id="nameError">このフィールドに入力してください</div>
      </div>

      <div class="form-row">
        <label for="systemDetail">システムの詳細 <span aria-hidden="true">※</span></label>
        <textarea id="systemDetail" name="system_detail" placeholder="システムの目的や概要、要件などを入力してください。" required aria-required="true"></textarea>
        <div class="hint" id="detailHint">必須（改行可）</div>
        <div class="error" id="detailError">このフィールドに入力してください</div>
      </div>

      <div class="form-row">
        <label for="createdAt">作成日（自動入力のため編集不可）</label>
        <input id="createdAt" name="created_at" type="date" readonly />
        <div class="hint" id="createdAtHint">今日の日付が自動入力</div>
      </div>

      <div class="controls">
        <button class="btn btn-ghost" id="cancelBtn" type="button">戻る</button>
        <button class="btn btn-primary" id="saveBtn" type="submit">保存</button>
      </div>
    </form>
  </main>

  <script>
    // ルーレットのトピックス
    const topics = [
      'クイズシステム',
      '料理システム',
      '睡眠管理システム',
      'スケジュール管理システム',
      '翻訳システム'
    ];

    // ルーレット関連の要素
    const rouletteWheel = document.getElementById('rouletteWheel');
    const spinBtn = document.getElementById('spinBtn');
    const systemForm = document.getElementById('systemForm');
    const topicItems = document.querySelectorAll('.topic-item');

    let selectedTopic = null;
    let isSpinning = false;

    // ルーレットを回す
    spinBtn.addEventListener('click', function() {
      if (isSpinning) return;
      
      isSpinning = true;
      spinBtn.disabled = true;
      
      const degreesPerTopic = 360 / topics.length; // 72度
      
      // トランジションを一時的に無効化して位置をリセット
      rouletteWheel.style.transition = 'none';
      rouletteWheel.style.transform = 'rotate(0deg)';
      
      // ブラウザに再描画を強制
      rouletteWheel.offsetHeight;
      
      // トランジションを再度有効化
      rouletteWheel.style.transition = 'transform 3s cubic-bezier(0.25, 0.1, 0.25, 1)';
      
      // 完全にランダムな回転角度を生成（最低3回転 + ランダム）
      const randomRotation = 1080 + Math.random() * 360;
      
      // 次のフレームで回転を開始
      requestAnimationFrame(() => {
        rouletteWheel.style.transform = `rotate(${randomRotation}deg)`;
      });
      
      // 3秒後に結果を表示
      setTimeout(() => {
        // 最終的な回転角度を0-360の範囲に正規化
        let finalRotation = randomRotation % 360;
        if (finalRotation < 0) finalRotation += 360;
        
        // グラデーションは from 270deg（9時の位置）から開始
        // つまりグラデーションの0度は画面上の270度（9時）にある
        // 画面上の12時（0度）には、グラデーションの90度がある
        // ルーレットを時計回りにfinalRotation度回転すると、
        // 12時の位置にはグラデーションの (90 - finalRotation) 度の色が来る
        let angleAt12 = (90 - finalRotation + 360) % 360;
        
        // その角度がどの項目に該当するかを判定
        let selectedIndex = Math.floor(angleAt12 / degreesPerTopic) % topics.length;
        
        console.log('最終回転角度:', finalRotation, '12時の位置の角度:', angleAt12, '選択インデックス:', selectedIndex);
        
        selectedTopic = topics[selectedIndex];
        
        isSpinning = false;
        spinBtn.disabled = false;
        
        // 選択されたトピックをハイライト
        topicItems.forEach((item, index) => {
          if (index === selectedIndex) {
            item.classList.add('selected');
          } else {
            item.classList.remove('selected');
          }
        });
      }, 3000);
    });

    // --- フォーム処理 ---
    let isDirty = false;

    const nameInput = document.getElementById('systemName');
    const detailInput = document.getElementById('systemDetail');
    const createdAtInput = document.getElementById('createdAt');
    const systemIdInput = document.getElementById('systemId');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const nameError = document.getElementById('nameError');
    const detailError = document.getElementById('detailError');

    // 作成日を YYYY-MM-DD 形式で自動入力
    (function fillCreatedAt(){
      if (!createdAtInput) return;
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      createdAtInput.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    })();

    // フォーム変更で isDirty を true にする
    function markDirty() { isDirty = true; }
    if (nameInput) nameInput.addEventListener('input', markDirty);
    if (detailInput) detailInput.addEventListener('input', markDirty);

    // beforeunload: ブラウザ閉じる/リロード/バックで確認（変更あり時のみ）
    window.addEventListener('beforeunload', function (e) {
      if (!isDirty) return;
      e.preventDefault();
      e.returnValue = '';
    });

    // タブクリック時の共通処理
    document.querySelectorAll('.nav-tab').forEach(tab=>{
      tab.addEventListener('click', function(e){
        e.preventDefault();

        let targetUrl = null;
        if (this.id === 'tab-system') targetUrl = '/accounts/system/choice/';
        else if (this.id === 'tab-algorithm') targetUrl = '/accounts/block/choice';

        if (!targetUrl) {
          document.querySelectorAll('.nav-tab').forEach(t=>{
            t.classList.remove('active');
            t.setAttribute('aria-pressed','false');
          });
          this.classList.add('active');
          this.setAttribute('aria-pressed','true');
          return;
        }

        if (isDirty) {
          const leave = confirm('入力内容が破棄されます。移動してもよろしいですか？');
          if (!leave) return;
          isDirty = false;
        }

        sessionStorage.removeItem('systemDesignContent');
        sessionStorage.removeItem('returnFromCreate');
        sessionStorage.removeItem('navigatingToCreate');
        sessionStorage.removeItem('systemId');
        sessionStorage.removeItem('systemName');
        sessionStorage.removeItem('systemDescription');

        window.location.href = targetUrl;
      });
    });

    // フォームバリデーション
    function validate() {
      let ok = true;
      const name = nameInput ? nameInput.value.trim() : '';
      const detail = detailInput ? detailInput.value.trim() : '';

      const requiredMsg = 'このフィールドに入力してください';

      if (!name) {
        if (nameError) {
          nameError.textContent = requiredMsg;
          nameError.style.display = 'block';
        }
        ok = false;
      } else {
        if (nameError) nameError.style.display = 'none';
      }

      if (!detail) {
        if (detailError) {
          detailError.textContent = requiredMsg;
          detailError.style.display = 'block';
        }
        ok = false;
      } else {
        if (detailError) detailError.style.display = 'none';
      }

      if (!ok) {
        if (!name && nameInput) nameInput.focus();
        else if (!detail && detailInput) detailInput.focus();
      }

      return ok;
    }

    // 保存ボタン
    saveBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (!validate()) return;
      
      isDirty = false;
      sessionStorage.removeItem('systemDesignContent');
      sessionStorage.removeItem('returnFromCreate');
      sessionStorage.removeItem('navigatingToCreate');
      sessionStorage.removeItem('systemId');
      sessionStorage.removeItem('systemName');
      sessionStorage.removeItem('systemDescription');
      
      saveBtn.closest('form').submit();
    });

    // 戻るボタン
    cancelBtn.addEventListener('click', function(e){
      e.preventDefault();
      if (!isDirty) {
        sessionStorage.setItem('returnFromCreate', 'true');
        window.location.href = '/accounts/system/choice/';
        return;
      }
      const ok = confirm('入力を破棄してシステム選択画面に戻りますか？');
      if (!ok) return;
      nameInput.value = '';
      detailInput.value = '';
      if (nameError) nameError.style.display = 'none';
      if (detailError) detailError.style.display = 'none';
      const d = new Date();
      const pad = n => String(n).padStart(2,'0');
      if (createdAtInput) createdAtInput.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      isDirty = false;
      sessionStorage.setItem('returnFromCreate', 'true');
      window.location.href = '/accounts/system/choice/';
    });

    // 入力時にエラー表示を消す
    if (nameInput) {
      nameInput.addEventListener('input', function(){
        if (nameInput.value.trim() && nameError) nameError.style.display = 'none';
      });
    }
    if (detailInput) {
      detailInput.addEventListener('input', function(){
        if (detailInput.value.trim() && detailError) detailError.style.display = 'none';
      });
    }

    // ナビゲーションバーとカードの重なり検出
    function checkNavOverlap() {
      const nav = document.querySelector('.top-tabs');
      const rouletteSection = document.querySelector('.roulette-section');
      const formCard = document.querySelector('.form-card');
      
      if (!nav) return;
      
      const navRect = nav.getBoundingClientRect();
      const navBottom = navRect.bottom;
      
      let isOverlapping = false;
      
      // ルーレットセクションとの重なりをチェック
      if (rouletteSection) {
        const sectionRect = rouletteSection.getBoundingClientRect();
        if (sectionRect.top < navBottom && sectionRect.bottom > navRect.top) {
          isOverlapping = true;
        }
      }
      
      // フォームカードとの重なりをチェック（表示されている場合）
      if (formCard && formCard.classList.contains('show')) {
        const formRect = formCard.getBoundingClientRect();
        if (formRect.top < navBottom && formRect.bottom > navRect.top) {
          isOverlapping = true;
        }
      }
      
      // 重なっている場合は非表示、そうでない場合は表示
      if (isOverlapping) {
        nav.classList.add('hidden');
      } else {
        nav.classList.remove('hidden');
      }
    }
    
    // スクロールイベントで監視
    window.addEventListener('scroll', checkNavOverlap);
    // リサイズイベントでも監視
    window.addEventListener('resize', checkNavOverlap);
    // 初期チェック
    checkNavOverlap();
    
    // フォームが表示されたときもチェック
    const observer = new MutationObserver(checkNavOverlap);
    if (systemForm) {
      observer.observe(systemForm, { attributes: true, attributeFilter: ['class'] });
    }
  </script>
{% endblock %}
