{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_blue.png' %}" 
     alt="" 
     class="bg-frame"
     onerror="this.style.display='none';">
{% endblock %}

{% block title %}システム一覧 - Codemon{% endblock %}

{% block messages %}
  <!-- メッセージを表示しない -->
{% endblock %}

{% block extra_css %}
  <style>
    /* メッセージを非表示 */
    .messages {
      display: none !important;
    }
    
    main { width:100%; max-width:1000px; margin:6px auto; margin-top:82px; box-sizing:border-box; }

    .list-card {
      background: transparent;
      border-radius:10px;
      padding:16px;
      padding-bottom:80px;
      box-shadow: none;
      border: none;
      max-width:1000px;
      margin:0 auto;
    }
    .list-empty { color:#666; padding:28px; text-align:center; }
    
    /* システム一覧項目の背景画像 */
    #systemsList li {
      background: url("{% static 'codemon/images/backgrounds/system_list_bg.png' %}") no-repeat center center !important;
      background-size: contain !important;
      border: none !important;
      min-height: 70px;
    }
    
    /* 詳細ボタンの画像スタイル */
    .system-detail-btn {
      background: url("{% static 'codemon/images/button/system_list_button.png' %}") no-repeat center center !important;
      background-size: contain !important;
      background-color: transparent !important;
      border: none !important;
      color: transparent !important;
      box-shadow: none !important;
      width: 110px;
      height: 55px;
      cursor: pointer;
      padding: 0 !important;
      flex-shrink: 0;
    }
    
    /* ページネーション */
    .pagination {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin:16px 0 12px 0;
      position: relative;
    }
    .pagination-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 16px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .pagination-info {
      color:#666;
      font-size:14px;
    }
    .pagination-btn {
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #d0d7de;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      transition: all .12s ease;
    }
    .pagination-btn:hover:not(:disabled) {
      background:#f0f6ff;
      color:var(--primary);
      border-color:var(--primary);
    }
    .pagination-btn:disabled {
      opacity:0.4;
      cursor:not-allowed;
    }
    
    /* 検索ボックス */
    .search-container {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
      position: relative;
    }
    .search-input {
      padding: 8px 32px 8px 12px;
      border-radius: 8px;
      border: 1px solid #d0d7de;
      font-size: 14px;
      width: 200px;
      transition: all .12s ease;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }
    .search-clear-btn {
      position: absolute;
      right: 8px;
      background: transparent;
      border: none;
      color: #999;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all .12s ease;
    }
    .search-clear-btn:hover {
      background: #f0f0f0;
      color: #333;
    }
    .search-clear-btn.show {
      display: flex;
    }
    
    .actions { display:flex; gap:12px; margin-top:12px; justify-content:center; }
    .btn {
      padding:10px 14px;
      border-radius:8px;
      border:0;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn-primary {
      background: linear-gradient(180deg,#e6f0ff,#cfe6ff);
      color:#073763;
      box-shadow:0 8px 18px rgba(10,59,110,0.06);
    }
    .btn-ghost {
      background: #fff;
      color:#444;
      border:1px solid #e6e9ee;
    }

    @media (max-width:640px){
      .list-empty { padding:18px; }
    }
  </style>
{% endblock %}

{% block content %}
  <main>
    <div class="list-card" role="region" aria-label="システム一覧">
      <!-- ページネーション（上部） -->
      <div class="pagination" id="topPagination">
        <div class="pagination-controls">
          <button class="pagination-btn" id="prevBtn" disabled>← 前へ</button>
          <span class="pagination-info" id="pageInfo">1 / 1</span>
          <button class="pagination-btn" id="nextBtn" disabled>次へ →</button>
        </div>
        <div class="search-container">
          <input type="text" id="searchInput" class="search-input" placeholder="システム名で検索..." />
          <button class="search-clear-btn" id="clearSearchBtn" title="クリア">×</button>
        </div>
      </div>

      <div id="systemsContainer">
        {% if systems %}
        <div class="system-list">
          <ul id="systemsList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:3px;">
            {% for s in systems %}
            <li data-id="{{ s.system_id }}" style="border-radius:8px;padding:12px 14px;display:flex;align-items:center;gap:16px;">
              <div style="flex:1;min-width:0;font-weight:700;font-size:15px;color:#0b2f5a;">{{ s.system_name }}</div>
              <div style="flex:1;min-width:0;color:#666;font-size:13px;">作成日: {{ s.created_at|date:"Y年n月j日 H:i" }}</div>
              {% if s.created_at != s.updated_at %}
              <div style="flex:1;min-width:0;color:#666;font-size:13px;">更新日: {{ s.updated_at|date:"Y年n月j日 H:i" }}</div>
              {% else %}
              <div style="flex:1;min-width:0;color:#666;font-size:13px;"></div>
              {% endif %}
              <button class="system-detail-btn" data-system-id="{{ s.system_id }}">詳細</button>
            </li>
            {% endfor %}
          </ul>
        </div>
        {% else %}
        <div class="list-empty">
          作成済みのシステムはまだありません。<br />
          「新しいシステムを作成」ボタンで作成を開始できます。
        </div>
        {% endif %}
      </div>

      <div class="actions" aria-hidden="false">
        <button class="btn btn-primary" id="btn-new">新しいシステムを作成</button>
        <button class="btn btn-ghost" id="btn-back">戻る</button>
      </div>
    </div>
  </main>

  <script>
    // ページネーション設定
    const ITEMS_PER_PAGE = 4;
    let currentPage = 1;
    let allSystems = [];
    let filteredSystems = []; // 検索結果を保持
    let searchQuery = ''; // 現在の検索クエリ

    // 初期データの読み込み
    (function initializeSystems() {
      const systemsListElement = document.getElementById('systemsList');
      if (systemsListElement) {
        // Django テンプレートから初期データを取得
        const items = systemsListElement.querySelectorAll('li[data-id]');
        allSystems = Array.from(items).map(item => {
          const systemId = item.getAttribute('data-id');
          const elements = item.querySelectorAll('div');
          
          return {
            system_id: systemId,
            system_name: elements[0] ? elements[0].textContent : '',
            created_at: elements[1] ? elements[1].textContent.replace('作成日: ', '') : '',
            updated_at: elements[2] ? elements[2].textContent.replace('更新日: ', '') : ''
          };
        });
        
        // 初期表示
        filteredSystems = allSystems;
        renderPage(1);
      } else {
        // システムが1つもない場合
        updatePaginationButtons();
      }
    })();

    function renderPage(page) {
      currentPage = page;
      const container = document.getElementById('systemsContainer');
      if (!container) return;

      if (!filteredSystems || filteredSystems.length === 0) {
        container.innerHTML = `
          <div class="list-empty">検索結果が見つかりません。</div>`;
        updatePaginationButtons();
        return;
      }

      const startIndex = (page - 1) * ITEMS_PER_PAGE;
      const endIndex = startIndex + ITEMS_PER_PAGE;
      const pageSystems = filteredSystems.slice(startIndex, endIndex);

      let html = '<div class="system-list"><ul id="systemsList" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:3px;">';
      for (const s of pageSystems) {
        html += `<li data-id="${s.system_id}" style="border-radius:8px;padding:12px 14px;display:flex;align-items:center;gap:16px;">`;
        html += `<div style="flex:1;min-width:0;font-weight:700;font-size:15px;color:#0b2f5a;">${escapeHtml(s.system_name)}</div>`;
        html += `<div style="flex:1;min-width:0;color:#666;font-size:13px;">作成日: ${escapeHtml(s.created_at)}</div>`;
        // 作成日と更新日が異なる場合のみ更新日を表示
        if (s.created_at !== s.updated_at) {
          html += `<div style="flex:1;min-width:0;color:#666;font-size:13px;">更新日: ${escapeHtml(s.updated_at)}</div>`;
        } else {
          html += `<div style="flex:1;min-width:0;color:#666;font-size:13px;"></div>`;
        }
        html += `<button class="system-detail-btn" data-system-id="${s.system_id}">詳細</button>`;
        html += `</li>`;
      }
      html += '</ul></div>';
      container.innerHTML = html;
      
      // 詳細ボタンにイベントリスナーを追加
      attachDetailButtonListeners();
      
      // ページネーションボタンの状態更新
      updatePaginationButtons();
    }

    function updatePaginationButtons() {
      const totalPages = Math.ceil(filteredSystems.length / ITEMS_PER_PAGE) || 1;
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      if (prevBtn) prevBtn.disabled = currentPage <= 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
      if (pageInfo) pageInfo.textContent = `${currentPage} / ${totalPages}`;
    }

    function escapeHtml(str){
      if (!str) return '';
      return String(str).replace(/[&<>\"]/g, function(c){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c];
      });
    }

    // ページネーションボタンのイベントリスナー
    document.getElementById('prevBtn')?.addEventListener('click', function() {
      if (currentPage > 1) {
        renderPage(currentPage - 1);
      }
    });

    document.getElementById('nextBtn')?.addEventListener('click', function() {
      const totalPages = Math.ceil(filteredSystems.length / ITEMS_PER_PAGE);
      if (currentPage < totalPages) {
        renderPage(currentPage + 1);
      }
    });

    // 検索機能
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearchBtn');

    function performSearch(query) {
      searchQuery = query.toLowerCase().trim();
      
      if (!searchQuery) {
        // 検索クエリが空の場合は全件表示
        filteredSystems = allSystems;
      } else {
        // システム名でフィルタリング
        filteredSystems = allSystems.filter(system => {
          return system.system_name.toLowerCase().includes(searchQuery);
        });
      }
      
      // 1ページ目に戻して表示
      renderPage(1);
      
      // クリアボタンの表示/非表示
      if (clearSearchBtn) {
        if (searchQuery) {
          clearSearchBtn.classList.add('show');
        } else {
          clearSearchBtn.classList.remove('show');
        }
      }
    }

    if (searchInput) {
      // 入力中にリアルタイム検索
      searchInput.addEventListener('input', function(e) {
        performSearch(e.target.value);
      });
      
      // Enterキーで検索
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          performSearch(e.target.value);
        }
      });
    }

    if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', function() {
        if (searchInput) {
          searchInput.value = '';
          performSearch('');
          searchInput.focus();
        }
      });
    }

    // 「新しいシステムを作成」ボタンは index.html へ遷移
    const btnNew = document.getElementById('btn-new');
    if (btnNew) {
      btnNew.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = '/accounts/system/';
      });
    }
    // 「一覧を更新」: サーバから最新データを取得して DOM を更新する
    const btnRefresh = document.getElementById('btn-refresh');
    async function loadSystemsFromServer() {
      try {
        const res = await fetch('/accounts/system/list/data/');
        if (!res.ok) throw new Error('Network response was not ok');
        const data = await res.json();
        
        // サーバーから取得したデータを allSystems に格納
        allSystems = (data.systems || []).map(s => ({
          system_id: s.system_id,
          system_name: s.system_name,
          created_at: s.created_at,
          updated_at: s.updated_at
        }));
        
        // 検索をリセット
        filteredSystems = allSystems;
        if (searchInput) searchInput.value = '';
        searchQuery = '';
        if (clearSearchBtn) clearSearchBtn.classList.remove('show');
        
        // 1ページ目を表示
        renderPage(1);
      } catch (err) {
        console.error(err);
        alert('一覧の取得に失敗しました。');
      }
    }

    if (btnRefresh) {
      btnRefresh.addEventListener('click', async function(e){
        e.preventDefault();
        btnRefresh.disabled = true;
        await loadSystemsFromServer();
        btnRefresh.disabled = false;
      });
    }

    // 戻るボタン -> system_choice へ遷移
    const btnBack = document.getElementById('btn-back');
    if (btnBack) {
      btnBack.addEventListener('click', function(e){
        e.preventDefault();
        window.location.href = '/accounts/system/choice/';
      });
    }
    // 詳細ボタンのイベントリスナーを追加する関数
    function attachDetailButtonListeners() {
      document.querySelectorAll('.system-detail-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const systemId = this.getAttribute('data-system-id');
          if (systemId) {
            window.location.href = `/accounts/system/details/?id=${systemId}`;
          }
        });
      });
    }

    // ページ読み込み時に詳細ボタンのイベントリスナーを追加
    document.addEventListener('DOMContentLoaded', function() {
      attachDetailButtonListeners();
    });
  </script>
  </main>
{% endblock %}