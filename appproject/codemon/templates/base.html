{% load static %}
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{% block title %}Codemon{% endblock %}</title>
  {% block extra_css %}{% endblock %}
  
  <!-- å…±é€šã‚¹ã‚¿ã‚¤ãƒ« -->
  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "Yu Gothic UI", Meiryo, "Noto Sans JP", Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
      min-height: 100vh;
    }
    
    /* èƒŒæ™¯ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå…¨ç”»é¢å…±é€šï¼‰ */
    .bg-common {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      object-fit: cover;
    }
    
    .bg-frame {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      object-fit: cover;
      pointer-events: none;
    }
    
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
    .content-wrapper {
      position: relative;
      z-index: 10;
      max-width: 100%;
      margin: 0;
      padding: 20px;
      background: transparent;
      min-height: calc(100vh - 80px);
      overflow-y: auto;
    }
    
    /* ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ä½¿ç”¨æ™‚ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    body.no-scroll .content-wrapper {
      overflow: hidden;
    }
    
    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
    .messages {
      list-style: none;
      margin: 20px auto;
      padding: 0;
      max-width: 1200px;
    }
    
    .messages li {
      padding: 12px 20px;
      margin-bottom: 10px;
      border-radius: 4px;
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
    
  </style>
</head>
<body{% block body_class %}{% endblock %}>

  <!-- ãƒšãƒ¼ã‚¸å›ºæœ‰ãƒãƒŠãƒ¼è¡¨ç¤ºç”¨ blockï¼ˆkarihome ãªã©ã§ä¸Šæ›¸ãå¯èƒ½ï¼‰ -->
  {% block banner_nav %}{% endblock %}

  <!-- èƒŒæ™¯ç”»åƒï¼ˆå…¨ç”»é¢å…±é€šï¼‰ -->
  <img src="{% static 'codemon/images/backgrounds/bg_common.png' %}" 
       alt="" 
       class="bg-common"
       onerror="this.style.display='none';">

  <!-- å¤–æ ç”»åƒï¼ˆç”»é¢ã”ã¨ã«è‰²é•ã„ï¼‰ -->
  {% block background_frame %}
  <!-- å„ãƒšãƒ¼ã‚¸ã§bg_frame_*.pngã‚’æŒ‡å®š -->
  {% endblock %}

  {% block global_navigation %}
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
  {% include 'includes/header.html' %}
  {% endblock %}

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
  <div class="content-wrapper">
    {% block content %}{% endblock %}
  </div>

  <!-- (å³ä¸‹ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã¯å‰Šé™¤æ¸ˆ: karihome ã®ä¸­å¤®ãƒãƒ£ãƒƒãƒˆã‚’ä½¿ç”¨) -->

  {% csrf_token %}

  <!-- å…±é€šJavaScript -->
  <script>
  (function(){
    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const currentPath = window.location.pathname;
    const tabLinks = {
      'tab-home': ['/accounts/karihome/'],
      // ã‚·ã‚¹ãƒ†ãƒ : æ–°ã—ã„é·ç§»å…ˆï¼ˆsystem_choiceï¼‰ã¨æ—¢å­˜ã®ä¸‹å±¤URLã®ä¸¡æ–¹ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å¯¾è±¡ã«å«ã‚ã‚‹
      'tab-systems': [
        '/accounts/system/',
        '/codemon/systems/', '/codemon/groups/', '/codemon/threads/'
      ],
      // ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : æ–°ã—ã„é·ç§»å…ˆï¼ˆblock_choiceï¼‰ã¨æ—¢å­˜ã®ä¸‹å±¤URLã®ä¸¡æ–¹ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–å¯¾è±¡ã«å«ã‚ã‚‹
      'tab-algorithms': [
        '/accounts/block/',
        '/codemon/algorithms/', '/codemon/blocks/'
      ],
      'tab-checklist': ['/codemon/checklists/'],
      'tab-account': ['/accounts/']
    };
    
    for (const [tabId, paths] of Object.entries(tabLinks)) {
      const matchesPath = paths.some(path => currentPath.startsWith(path));
      if (matchesPath) {
        const tabLink = document.getElementById(tabId);
        if (tabLink) {
          tabLink.classList.add('active');
        }
        break;
      }
    }
  })();
  </script>
  
  {% block extra_js %}{% endblock %}

  {% block ai_chat_widget %}
  {# AIä¼šè©±æ©Ÿèƒ½ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ã§ ai_chat_base.html ã‚’ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ #}
  {# ä¾‹: {% include 'includes/ai_chat_base.html' %} #}
  {% endblock %}

  {% block global_character_widget %}
    {% with current_path=request.path %}
      {# --- è¡¨ç¤ºãƒ»éè¡¨ç¤ºã®åˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ --- #}
      {# karihomeãƒšãƒ¼ã‚¸ã¯è‡ªèº«ã§widgetã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã™ã‚‹ã®ã§ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„ #}
      {% if '/accounts/karihome/' in current_path or '/accounts/home/' in current_path %}
        {# karihome.htmlãŒè‡ªèº«ã§widgetã‚’è¡¨ç¤ºã™ã‚‹ã®ã§éè¡¨ç¤º #}
      {# ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒšãƒ¼ã‚¸ã‚’é™¤å¤– #}
      {% elif '/accounts/student/' in current_path or '/accounts/teacher/' in current_path %}
        {# éè¡¨ç¤º #}
      {% elif '/group/' in current_path %}
        {# éè¡¨ç¤º #}
      {# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç”»é¢ã‚’é™¤å¤– #}
      {% elif '/accounts/account_entry/' in current_path %}
        {# éè¡¨ç¤º #}

      {% elif '/groups/join_confirm/' in current_path %}

      {% else %}
        {# ä»–ã®ç”»é¢ã§ã¯sidebarãƒ¢ãƒ¼ãƒ‰ã§è¡¨ç¤ºï¼ˆaccounts/blockã€accounts/systemã‚’å«ã‚€ï¼‰ #}
        {% include 'includes/character_widget.html' with mode='sidebar' %}
      {% endif %}
    {% endwith %}
  {% endblock %}
  
  <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚¨ãƒªã‚¢ -->
  <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>
  
  <script>
  // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥è¡¨ç¤ºé–¢æ•°
  function showAchievementToast(achievement) {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'achievement-toast';
    toast.innerHTML = `
      <div class="achievement-toast-icon">${achievement.icon}</div>
      <div class="achievement-toast-content">
        <div class="achievement-toast-title">ğŸ‰ å®Ÿç¸¾é”æˆï¼</div>
        <div class="achievement-toast-name">${achievement.name}</div>
        <div class="achievement-toast-reward">ğŸ’° ${achievement.reward}ã‚³ã‚¤ãƒ³ ç²å¾—ï¼</div>
      </div>
    `;
    
    container.appendChild(toast);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    setTimeout(() => toast.classList.add('show'), 10);
    
    // 5ç§’å¾Œã«å‰Šé™¤
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 5000);
  }
  
  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰é€šçŸ¥ã‚’å–å¾—ã—ã¦è¡¨ç¤º
  {% if request.session.achievement_notifications %}
    const notifications = {{ request.session.achievement_notifications|safe }};
    notifications.forEach((achievement, index) => {
      setTimeout(() => showAchievementToast(achievement), index * 300);
    });
    // è¡¨ç¤ºå¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å‰Šé™¤
    fetch('{% url "codemon:clear_achievement_notifications" %}', {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    });
  {% endif %}
  </script>
  
  <style>
  .achievement-toast {
    background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 10px;
    box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
    display: flex;
    gap: 15px;
    align-items: center;
    min-width: 300px;
    opacity: 0;
    transform: translateX(400px);
    transition: all 0.3s ease;
  }
  
  .achievement-toast.show {
    opacity: 1;
    transform: translateX(0);
  }
  
  .achievement-toast-icon {
    font-size: 3rem;
    animation: bounce 0.6s ease infinite alternate;
  }
  
  @keyframes bounce {
    from { transform: translateY(0); }
    to { transform: translateY(-10px); }
  }
  
  .achievement-toast-content {
    flex: 1;
  }
  
  .achievement-toast-title {
    font-size: 0.85rem;
    opacity: 0.9;
    margin-bottom: 5px;
  }
  
  .achievement-toast-name {
    font-size: 1.2rem;
    font-weight: bold;
    margin-bottom: 5px;
  }
  
  .achievement-toast-reward {
    font-size: 1rem;
    background: rgba(255,255,255,0.2);
    display: inline-block;
    padding: 5px 10px;
    border-radius: 8px;
  }
  </style>
</body>
</html>