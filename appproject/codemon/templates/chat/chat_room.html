{% extends "base.html" %}
{% load static %}

{% block title %}{{ room.name }} - „ÉÅ„É£„ÉÉ„Éà{% endblock %}

{% block extra_css %}
<style>
    .chat-room-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding: 0;
    }

    .chat-room-header {
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        background: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-room-title {
        font-weight: bold;
        font-size: 16px;
    }

    .chat-room-info-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 20px;
        color: #666;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: white;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .message {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.own {
        justify-content: flex-end;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .message-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }

    .message-content {
        max-width: 60%;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .message-header {
        font-size: 12px;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
    }

    .message-bubble {
        background: #f0f0f0;
        padding: 10px 15px;
        border-radius: 12px;
        word-wrap: break-word;
        word-break: break-word;
        position: relative;
        font-size: 14px;
    }

    .message.own .message-bubble {
        background: #2196F3;
        color: white;
        border-radius: 12px 3px 12px 12px;
    }

    .message.other .message-bubble {
        background: #f0f0f0;
        color: #333;
        border-radius: 3px 12px 12px 12px;
    }

    .message-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 8px;
        cursor: pointer;
    }

    .message-file {
        background: #fff3cd;
        padding: 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: background 0.2s;
    }

    .message-file:hover {
        background: #ffe69c;
    }

    .file-icon {
        font-size: 20px;
    }

    .file-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .file-name {
        font-weight: 500;
        font-size: 13px;
    }

    .file-size {
        font-size: 12px;
        color: #666;
    }

    .read-status {
        font-size: 11px;
        color: #999;
        margin-top: 5px;
    }

    .message.own .read-status {
        color: #90CAF9;
        text-align: right;
    }

    .read-users {
        font-size: 10px;
        color: #0066cc;
        margin-top: 2px;
    }

    .chat-input-area {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        background: white;
        display: flex;
        gap: 10px;
        align-items: flex-end;
    }

    .input-controls {
        display: flex;
        gap: 8px;
    }

    .file-upload-btn, .image-upload-btn {
        background: #f0f0f0;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: background 0.2s;
    }

    .file-upload-btn:hover, .image-upload-btn:hover {
        background: #e0e0e0;
    }

    input[type="file"] {
        display: none;
    }

    .message-input-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .message-input {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 14px;
        resize: none;
        max-height: 100px;
        font-family: inherit;
        font-size: 14px;
    }

    .message-input:focus {
        outline: none;
        border-color: #2196F3;
        box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
    }

    .image-preview-container {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        max-width: 100%;
    }

    .image-preview {
        position: relative;
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        background: #f0f0f0;
    }

    .image-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .remove-preview {
        position: absolute;
        top: 2px;
        right: 2px;
        background: rgba(0,0,0,0.6);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
    }

    .send-btn {
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        transition: background 0.2s;
    }

    .send-btn:hover {
        background: #1976D2;
    }

    .send-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .message-time {
        font-size: 11px;
        color: #999;
    }

    @media (max-width: 768px) {
        .message-content {
            max-width: 80%;
        }

        .message-bubble {
            font-size: 13px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-room-container">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="chat-room-header">
        <div class="chat-room-title">{{ room.name }}</div>
        <button class="chat-room-info-btn" onclick="showRoomInfo()">‚ÑπÔ∏è</button>
    </div>

    <!-- „É°„ÉÉ„Çª„Éº„Ç∏‰∏ÄË¶ß -->
    <div class="chat-messages" id="chat-messages">
        {% for message in messages %}
        <div class="message {% if message.sender == request.user %}own{% else %}other{% endif %}" 
             data-message-id="{{ message.id }}">
            {% if message.sender != request.user %}
            <div class="message-avatar">
                {% if message.sender.avatar %}
                    <img src="{{ message.sender.avatar.url }}" alt="{{ message.sender.username }}">
                {% else %}
                    <span>{{ message.sender.username|first|upper }}</span>
                {% endif %}
            </div>
            {% endif %}
            
            <div class="message-content">
                {% if message.sender != request.user %}
                <div class="message-header">
                    <span>{{ message.sender.username }}</span>
                    <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
                </div>
                {% endif %}

                {% if message.file %}
                <div class="message-file" onclick="downloadFile('{{ message.file.url }}')">
                    <div class="file-icon">üìé</div>
                    <div class="file-info">
                        <div class="file-name">{{ message.file.name|truncatewords:3 }}</div>
                        <div class="file-size">{{ message.file.size|filesizeformat }}</div>
                    </div>
                </div>
                {% endif %}

                {% if message.image %}
                <img src="{{ message.image.url }}" alt="Message image" class="message-image"
                     onclick="openImagePreview('{{ message.image.url }}')">
                {% endif %}

                {% if message.text %}
                <div class="message-bubble">{{ message.text }}</div>
                {% endif %}

                {% if message.sender == request.user %}
                <div class="message-header" style="text-align: right;">
                    <span class="message-time">{{ message.timestamp|date:"H:i" }}</span>
                </div>
                {% if message.is_read %}
                <div class="read-status">‚úì‚úì Êó¢Ë™≠</div>
                {% if message.read_by_users %}
                <div class="read-users">
                    Êó¢Ë™≠: {{ message.read_by_users|join:", " }}
                </div>
                {% endif %}
                {% else %}
                <div class="read-status">‚úì ÈÄÅ‰ø°Ê∏à„Åø</div>
                {% endif %}
                {% endif %}
            </div>

            {% if message.sender == request.user %}
            <div style="margin-left: auto;">
                <button onclick="deleteMessage({{ message.id }})" 
                        style="background: none; border: none; cursor: pointer; color: #999;">
                    ‚úï
                </button>
            </div>
            {% endif %}
        </div>
        {% empty %}
        <div style="text-align: center; color: #999; margin: auto;">
            „É°„ÉÉ„Çª„Éº„Ç∏„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì
        </div>
        {% endfor %}
    </div>

    <!-- „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ„Ç®„É™„Ç¢ -->
    <div class="chat-input-area">
        <div class="input-controls">
            <input type="file" id="file-input" onchange="handleFileSelect(event)">
            <button class="file-upload-btn" onclick="document.getElementById('file-input').click()"
                    title="„Éï„Ç°„Ç§„É´„ÇíÈÄÅ‰ø°">
                üìé
            </button>

            <input type="file" id="image-input" accept="image/*" onchange="handleImageSelect(event)">
            <button class="image-upload-btn" onclick="document.getElementById('image-input').click()"
                    title="ÁîªÂÉè„ÇíÈÄÅ‰ø°">
                üñºÔ∏è
            </button>
        </div>

        <div class="message-input-wrapper">
            <div class="image-preview-container" id="image-preview-container"></div>
            <textarea class="message-input" id="message-input" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ..."
                      rows="1"></textarea>
        </div>

        <button class="send-btn" id="send-btn" onclick="sendMessage()" title="ÈÄÅ‰ø°">
            ‚û§
        </button>
    </div>
</div>

<!-- ÁîªÂÉè„Éó„É¨„Éì„É•„Éº„É¢„Éº„ÉÄ„É´ -->
<div id="image-modal" style="display: none; position: fixed; top: 0; left: 0; 
                             width: 100%; height: 100%; background: rgba(0,0,0,0.8); 
                             z-index: 1000; align-items: center; justify-content: center;">
    <div style="position: relative; max-width: 90%; max-height: 90%;">
        <img id="modal-image" src="" alt="" style="max-width: 100%; max-height: 100%;">
        <button onclick="closeImagePreview()" 
                style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.8);
                       border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">
            ‚úï
        </button>
    </div>
</div>

<script>
    const roomId = {{ room.id }};
    const userId = {{ request.user.id }};
    let selectedImages = [];

    // „É°„ÉÉ„Çª„Éº„Ç∏ÂÖ•Âäõ„ÅÆ„Ç™„Éº„Éà„É™„Çµ„Ç§„Ç∫
    const messageInput = document.getElementById('message-input');
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 100) + 'px';
    });

    // Enter„Ç≠„Éº„ÅßÈÄÅ‰ø°
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // ÁîªÂÉèÈÅ∏ÊäûÂá¶ÁêÜ
    function handleImageSelect(event) {
        const files = event.target.files;
        for (let file of files) {
            const reader = new FileReader();
            reader.onload = function(e) {
                selectedImages.push({
                    file: file,
                    preview: e.target.result
                });
                updateImagePreview();
            };
            reader.readAsDataURL(file);
        }
    }

    // „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (file) {
            // „Éï„Ç°„Ç§„É´ÈÄÅ‰ø°Âá¶ÁêÜ„Çí„Åì„Åì„ÅßÂÆüË£Ö
            console.log('„Éï„Ç°„Ç§„É´ÈÅ∏Êäû:', file.name);
        }
    }

    // ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºË°®Á§∫
    function updateImagePreview() {
        const container = document.getElementById('image-preview-container');
        container.innerHTML = '';
        selectedImages.forEach((img, index) => {
            const div = document.createElement('div');
            div.className = 'image-preview';
            div.innerHTML = `<img src="${img.preview}" alt="">
                            <button class="remove-preview" onclick="removeImagePreview(${index})">‚úï</button>`;
            container.appendChild(div);
        });
    }

    // ÁîªÂÉè„Éó„É¨„Éì„É•„ÉºÂâäÈô§
    function removeImagePreview(index) {
        selectedImages.splice(index, 1);
        updateImagePreview();
    }

    // ÁîªÂÉèË°®Á§∫Ôºà„É¢„Éº„ÉÄ„É´Ôºâ
    function openImagePreview(src) {
        document.getElementById('modal-image').src = src;
        document.getElementById('image-modal').style.display = 'flex';
    }

    // ÁîªÂÉè„É¢„Éº„ÉÄ„É´Èñâ„Åò„Çã
    function closeImagePreview() {
        document.getElementById('image-modal').style.display = 'none';
    }

    // „Éï„Ç°„Ç§„É´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
    function downloadFile(url) {
        const link = document.createElement('a');
        link.href = url;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // „É°„ÉÉ„Çª„Éº„Ç∏ÈÄÅ‰ø°
    async function sendMessage() {
        const text = messageInput.value.trim();
        const hasImages = selectedImages.length > 0;
        const fileInput = document.getElementById('file-input');
        const hasFile = fileInput.files.length > 0;

        if (!text && !hasImages && !hasFile) return;

        const formData = new FormData();
        formData.append('text', text);
        formData.append('room_id', roomId);

        // ÁîªÂÉèËøΩÂä†
        selectedImages.forEach(img => {
            formData.append('images', img.file);
        });

        // „Éï„Ç°„Ç§„É´ËøΩÂä†
        if (fileInput.files.length > 0) {
            formData.append('file', fileInput.files[0]);
        }

        try {
            const response = await fetch('{% url "chat:send_message" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                const data = await response.json();
                // „É°„ÉÉ„Çª„Éº„Ç∏ËøΩÂä†
                addMessageToUI(data.message);
                messageInput.value = '';
                messageInput.style.height = 'auto';
                selectedImages = [];
                updateImagePreview();
                fileInput.value = '';
                scrollToBottom();
            }
        } catch (error) {
            console.error('„Ç®„É©„Éº:', error);
        }
    }

    // UI„Å´„É°„ÉÉ„Çª„Éº„Ç∏„ÇíËøΩÂä†
    function addMessageToUI(message) {
        const messagesDiv = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message own';
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-header" style="text-align: right;">
                    <span class="message-time">${new Date().toLocaleTimeString('ja-JP', {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div class="message-bubble">${message.text}</div>
                <div class="read-status">‚úì ÈÄÅ‰ø°Ê∏à„Åø</div>
            </div>
        `;
        messagesDiv.appendChild(messageDiv);
        scrollToBottom();
    }

    // „Çπ„ÇØ„É≠„Éº„É´ÊúÄ‰∏ãÈÉ®„Å∏
    function scrollToBottom() {
        const messagesDiv = document.getElementById('chat-messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // „É°„ÉÉ„Çª„Éº„Ç∏ÂâäÈô§
    async function deleteMessage(messageId) {
        if (!confirm('„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;

        try {
            const response = await fetch(`/chat/message/${messageId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                document.querySelector(`[data-message-id="${messageId}"]`).remove();
            }
        } catch (error) {
            console.error('ÂâäÈô§„Ç®„É©„Éº:', error);
        }
    }

    // „É´„Éº„É†ÊÉÖÂ†±Ë°®Á§∫
    function showRoomInfo() {
        alert('{{ room.name }} „ÅÆ„É´„Éº„É†ÊÉÖÂ†±');
    }

    // ÂàùÊúüÂåñ
    window.addEventListener('load', function() {
        scrollToBottom();
        // WebSocket„Åæ„Åü„ÅØ„Éù„Éº„É™„É≥„Ç∞„Åß„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆËá™ÂãïÂèó‰ø°
        setupMessageListener();
    });

    // „É°„ÉÉ„Çª„Éº„Ç∏„É™„Çπ„Éä„ÉºË®≠ÂÆö
    function setupMessageListener() {
        // WebSocket„ÅÆÂ†¥Âêà„ÅÆ‰æã
        const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
        const ws = new WebSocket(`${protocol}://${window.location.host}/ws/chat/${roomId}/`);
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'chat_message') {
                // Âèó‰ø°„Åó„Åü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                // ÔºàÂÆüË£Ö„ÅØÂâ≤ÊÑõÔºâ
            }
        };
    }
</script>
{% endblock %}
