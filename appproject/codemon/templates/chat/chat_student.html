{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'codemon/css/chat_student.css' %}?v=4">
<style>
:root {
  --chat-max-width: 800px;
  --chat-max-height: 70vh;
  --chat-border-radius: 12px;
  --chat-box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --chat-position: fixed;
  --chat-position-x: 50px;
  --chat-position-y: 130px;
}

body.no-scroll {
  overflow-x: hidden !important;
  overflow-y: visible !important;
  touch-action: pan-y;
  height: auto !important;
}

.chat-container {
  overflow-x: hidden !important;
  overflow-y: visible;
  touch-action: pan-y;
}

.chat-messages {
  overflow-x: hidden !important;
  overflow-y: auto !important;
}

/* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
body::-webkit-scrollbar:horizontal,
.chat-container::-webkit-scrollbar:horizontal {
  display: none;
}

html {
  overflow-x: hidden !important;
  overflow-y: visible !important;
}

.btn-join-group {
  width: 100%;
  padding: 12px 16px;
  margin: 16px 0;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
}

.btn-join-group:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.btn-join-group:active {
  transform: translateY(0);
}

.btn-join-group .icon-plus {
  font-size: 18px;
  font-weight: bold;
}
</style>
{% endblock %}

{% block content %}
<!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒªã‚¹ãƒˆï¼‰ -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>ãƒãƒ£ãƒƒãƒˆä¸€è¦§</h2>
    <button class="btn-close-sidebar" id="closeSidebar">Ã—</button>
  </div>
  <div class="sidebar-content">
    <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ</h3>

    {% if groups %}
      <ul class="group-list">
        {% for group in groups %}
          <li class="group-item" data-group-id="{{ group.group_id }}" data-group-name="{{ group.group_name }}">
            <div class="group-icon">ğŸ‘¥</div>
            <div class="group-info">
              <div class="group-name">{{ group.group_name }}</div>
              <div class="group-members">{{ group.members.count }}äºº</div>
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-groups">å‚åŠ ã—ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    {% endif %}

    <div style="margin-top: 20px;">
      <h3 style="font-size: 14px; color: #666; margin-bottom: 8px;">å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ</h3>
      {% if direct_threads %}
        <ul class="group-list">
          {% for thread in direct_threads %}
            <li class="group-item dm-item" data-thread-id="{{ thread.thread_id }}" data-thread-name="{% if thread.owner.user_id == request.session.account_user_id %}{{ thread.participant_email }}{% else %}{{ thread.owner.user_name }}{% endif %}">
              <div class="group-icon">ğŸ’¬</div>
              <div class="group-info">
                <div class="group-name">
                  {% if thread.owner.user_id == request.session.account_user_id %}
                    {{ thread.participant_email }}
                  {% else %}
                    {{ thread.owner.user_name }}
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <ul class="group-list">
          <li class="group-item" style="opacity: 0.6;">
            <div class="group-icon">ğŸ’¬</div>
            <div class="group-info">
              <div class="group-name">ç¾åœ¨ã€å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </li>
        </ul>
      {% endif %}
    </div>
  </div>
</div>

<!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="chat-container student-chat">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
  <div class="chat-header">
    <div class="header-left">
      <button class="btn-hamburger" id="hamburgerBtn" title="ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1 class="chat-title">ãƒãƒ£ãƒƒãƒˆ</h1>
    </div>
    <div class="header-right">
      <a href="{% url 'codemon:submission_list_student' %}" class="btn-icon-settings" title="æå‡ºèª²é¡Œä¸€è¦§" style="margin-right: 8px;">ğŸ“‹</a>
      <a href="{% url 'codemon:student_icon_settings' %}" class="btn-icon-settings">âš™</a>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="chat-content">
    <div class="messages-container"></div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼å…¥åŠ›éƒ¨åˆ† -->
  <div class="chat-footer">
    <div class="input-area">
      <button class="btn-attach" title="ãƒ•ã‚¡ã‚¤ãƒ«æŠ•å‡½">
        <svg class="icon-attach" viewBox="0 0 24 24">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>
        </svg>
      </button>
      <button class="btn-image" title="ç”»åƒæŠ•å‡½">
        <svg class="icon-image" viewBox="0 0 24 24">
          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
        </svg>
      </button>
      <input type="text" class="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
      <button class="btn-send">
        <svg class="icon-send" viewBox="0 0 24 24">
          <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.9702544,11.6889879 22.9702544,11.5318905 22.9702544,11.4748131 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99721575 L3.03521743,10.4382088 C3.03521743,10.5953061 3.34915502,10.7524035 3.50612381,10.7524035 L16.6915026,11.5318905 C16.6915026,11.5318905 17.1624089,11.5318905 17.1624089,11.0606983 L17.1624089,12.0032827 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"/>
        </svg>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    const currentUserId = {{ request.session.account_user_id|default:"null" }};
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—
    const currentUserAvatar = "{% if user_avatar %}{{ user_avatar }}{% endif %}" || null;
    console.log('currentUserId:', currentUserId);
    console.log('currentUserAvatar:', currentUserAvatar);
    
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const closeSidebar = document.getElementById('closeSidebar');
    const messagesContainer = document.querySelector('.messages-container');
    const messageInput = document.querySelector('.message-input');
    const btnSend = document.querySelector('.btn-send');
    const btnJoinGroup = document.getElementById('btnJoinGroup');
    const chatTitle = document.querySelector('.chat-title');

    let currentGroupId = null;
    let currentGroupName = null;
    let currentThreadId = null;
    let pollingInterval = null;
    let lastMessageId = null;
    let pendingReadIds = new Set();

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    const csrftoken = getCookie('csrftoken');

    function openSidebar() {
      console.log('openSidebar called');
      console.log('sidebar:', sidebar);
      console.log('sidebarOverlay:', sidebarOverlay);
      if (sidebar) {
        sidebar.classList.add('open');
      }
      if (sidebarOverlay) {
        sidebarOverlay.classList.add('open');
      }
    }

    function closeSidebarFunc() {
      console.log('closeSidebarFunc called');
      if (sidebar) {
        sidebar.classList.remove('open');
      }
      if (sidebarOverlay) {
        sidebarOverlay.classList.remove('open');
      }
    }

    if (hamburgerBtn) {
      console.log('hamburgerBtn found, adding click listener');
      hamburgerBtn.addEventListener('click', openSidebar);
    } else {
      console.log('hamburgerBtn NOT found');
    }
    if (closeSidebar) {
      console.log('closeSidebar found, adding click listener');
      closeSidebar.addEventListener('click', closeSidebarFunc);
    } else {
      console.log('closeSidebar NOT found');
    }
    if (sidebarOverlay) {
      console.log('sidebarOverlay found, adding click listener');
      sidebarOverlay.addEventListener('click', closeSidebarFunc);
    } else {
      console.log('sidebarOverlay NOT found');
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
    function saveMessages(groupId, messages) {
      const key = `messages_group_${groupId}`;
      localStorage.setItem(key, JSON.stringify(messages));
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
    function loadMessages(groupId) {
      const key = `messages_group_${groupId}`;
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    async function deleteMessage(messageId) {
      if (!messageId) return;
      if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        const res = await fetch(`/codemon/chat/message/${messageId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken
          }
        });

        if (!res.ok) {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const target = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (target) {
          target.remove();
        }
      } catch (e) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†
    function editMessage(messageId) {
      if (!currentGroupId) return;
      
      const messages = loadMessages(currentGroupId);
      const message = messages.find(msg => msg.id === messageId);
      if (!message) return;
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒƒãƒˆ
      messageInput.value = message.text;
      messageInput.focus();
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
      messageInput.dataset.editingId = messageId;
      document.querySelector('.btn-send').textContent = 'æ›´æ–°';
    }

    // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelEdit() {
      delete messageInput.dataset.editingId;
      messageInput.value = '';
      document.querySelector('.btn-send').innerHTML = `
        <svg class="icon-send" viewBox="0 0 24 24">
          <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.9702544,11.6889879 22.9702544,11.5318905 22.9702544,11.4748131 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99721575 L3.03521743,10.4382088 C3.03521743,10.5953061 3.34915502,10.7524035 3.50612381,10.7524035 L16.6915026,11.5318905 C16.6915026,11.5318905 17.1624089,11.5318905 17.1624089,11.0606983 L17.1624089,12.0032827 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"/>
        </svg>
      `;
    }

    // URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function linkify(text) {
      const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
      return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: #1e90ff; text-decoration: underline;">$1</a>');
    }

    function formatTime(dateInput) {
      const now = dateInput ? new Date(dateInput) : new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes();
      return hours + ':' + minutes;
    }

    function addMessage(text, sender = 'user', save = true, messageId = null, senderUserId = null, senderAvatar = null, attachments = [], createdAt = null, readCount = 0, readBy = []) {
      console.log('[DEBUG] addMessage called with:', { messageId, senderUserId, currentUserId, readCount, readBy });
      const messageEl = document.createElement('div');
      // è‡ªåˆ†ãŒé€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆé€ä¿¡è€…IDãŒç¾åœ¨ã®IDã¨ä¸€è‡´ã™ã‚‹ã‹ï¼‰
      const isMyMessage = senderUserId === currentUserId;
      messageEl.className = `message ${isMyMessage ? 'sent' : 'received'}`;
      const time = formatTime(createdAt);
      const id = messageId || 'msg_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
      
      messageEl.dataset.messageId = id;
      messageEl.dataset.senderId = senderUserId || '';
      
      console.log('addMessage called:', { text, senderUserId, currentUserId, isMyMessage, senderAvatar });
      
      // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¡¨ç¤ºï¼ˆã‚ã‚Œã°imgã€ãªã‘ã‚Œã°çµµæ–‡å­—ï¼‰
      let avatarHtml = `<div class="message-avatar">${isMyMessage ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ«'}</div>`;
      if (senderAvatar) {
        avatarHtml = `<div class="message-avatar"><img src="${senderAvatar}" alt="avatar"></div>`;
      }

      const messageTextHtml = text ? `<div class="message-text">${linkify(text)}</div>` : '';
      const attachmentsHtml = (attachments && attachments.length)
        ? `<div class="message-attachments">
            ${attachments.map(att => {
              if (att.type === 'image') {
                return `<div class="attachment-image"><img src="${att.url}" alt="${att.name || 'image'}" style="max-width: 220px; border-radius: 6px;" /></div>`;
              }
              return `<div class="attachment-file"><a href="${att.url}" target="_blank" rel="noopener noreferrer" style="color: #1e90ff; text-decoration: underline;">ğŸ“ ${att.name || 'file'}</a></div>`;
            }).join('')}
          </div>`
        : '';

      let readLabel = '';
      if (isMyMessage) {
        if (readBy && readBy.length > 0) {
          readLabel = `æ—¢èª­ ${readBy.length}`;
        } else if (readCount > 0) {
          readLabel = `æ—¢èª­ ${readCount}`;
        }
      }
      const readHtml = isMyMessage ? `<span class="message-read" data-read-for="${id}">${readLabel}</span>` : '';
      
      messageEl.innerHTML = `
        ${avatarHtml}
        <div class="message-content">
          <div class="message-bubble">
            ${messageTextHtml}
            ${attachmentsHtml}
            ${isMyMessage ? `
            <div class="message-actions">
              <button class="btn-delete-message" onclick="deleteMessage('${id}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
            </div>
            ` : ''}
          </div>
          <div class="message-meta">
            <span class="message-time">${time}</span>
            ${readHtml}
          </div>
        </div>
      `;
      messagesContainer.appendChild(messageEl);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
      if (save && currentGroupId) {
        const messages = loadMessages(currentGroupId);
        messages.push({
          id: id,
          text: text,
          sender: sender,
          senderUserId: senderUserId || currentUserId,
          senderAvatar: senderAvatar,
          attachments: attachments || [],
          timestamp: new Date().getTime(),
          time: time
        });
        saveMessages(currentGroupId, messages);
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
    window.deleteMessage = deleteMessage;
    window.editMessage = editMessage;

    // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã™ã‚‹é–¢æ•°
    async function ensureGroupThread(groupId) {
      const res = await fetch(`/codemon/chat/group/${groupId}/thread/`);
      if (!res.ok) {
        throw new Error('failed');
      }
      return await res.json();
    }

    async function loadGroupMessages(groupId) {
      console.log('loadGroupMessages called for groupId:', groupId);
      const res = await fetch(`/codemon/chat/group/${groupId}/messages/`);
      if (!res.ok) {
        console.error('Failed to fetch messages:', res.status, res.statusText);
        throw new Error('failed');
      }
      const data = await res.json();
      console.log('Messages data received:', data);
      console.log('Messages count:', data.messages ? data.messages.length : 0);
      console.log('Messages array:', data.messages);
      if (data.thread_id) {
        currentThreadId = data.thread_id;
      }
      
      messagesContainer.innerHTML = '';
      lastMessageId = null;
      
      const unreadIds = [];
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(msg => {
          console.log('[DEBUG] Message:', msg.message_id, 'read_by:', msg.read_by, 'read_count:', msg.read_count);
          addMessage(
            msg.content || '',
            'user',
            false,
            msg.message_id,
            msg.sender_user_id,
            msg.sender_avatar || null,
            msg.attachments || [],
            msg.created_at,
            msg.read_count || 0,
            msg.read_by || []
          );
          if (msg.sender_user_id !== currentUserId) {
            unreadIds.push(msg.message_id);
          }
          lastMessageId = msg.message_id;
        });
      } else {
        console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“');
      }

      if (unreadIds.length) {
        markMessagesRead(unreadIds);
      }
    }

    async function loadNewMessages(groupId) {
      if (!groupId || groupId !== currentGroupId) return;
      
      try {
        const res = await fetch(`/codemon/chat/group/${groupId}/messages/`);
        if (!res.ok) return;
        
        const data = await res.json();
        const unreadIds = [];
        
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—
            if (lastMessageId && msg.message_id <= lastMessageId) {
              // æ—¢èª­æ•°ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
              if (msg.read_by && msg.sender_user_id === currentUserId) {
                updateReadCount(msg.message_id, msg.read_by);
              }
              return;
            }
            
            addMessage(
              msg.content || '',
              'user',
              false,
              msg.message_id,
              msg.sender_user_id,
              msg.sender_avatar || null,
              msg.attachments || [],
              msg.created_at,
              msg.read_count || 0,
              msg.read_by || []
            );
            
            if (msg.sender_user_id !== currentUserId) {
              unreadIds.push(msg.message_id);
            }
            lastMessageId = msg.message_id;
          });
        }
        
        if (unreadIds.length) {
          markMessagesRead(unreadIds);
        }
      } catch (e) {
        console.error('æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function updateReadCount(messageId, readers) {
      const messageEl = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (!messageEl) return;
      if (String(messageEl.dataset.senderId) !== String(currentUserId)) return;

      const readEl = messageEl.querySelector('.message-read');
      if (!readEl) return;
      const readCount = readers.length;
      readEl.textContent = readCount > 0 ? `æ—¢èª­ ${readCount}` : '';
    }

    async function markMessagesRead(messageIds) {
      if (!messageIds || messageIds.length === 0) return;
      
      try {
        const response = await fetch('/codemon/api/mark-messages-read/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ message_ids: messageIds })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log(`æ—¢èª­ãƒãƒ¼ã‚¯é€ä¿¡: ${result.marked_count}ä»¶`);
        }
      } catch (error) {
        console.error('æ—¢èª­ãƒãƒ¼ã‚¯é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    async function selectGroup(groupId, groupName) {
      currentGroupId = groupId;
      currentGroupName = groupName;
      currentThreadId = null;
      
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      chatTitle.textContent = groupName + ' ãƒãƒ£ãƒƒãƒˆ';
      
      // localStorageã«ä¿å­˜
      localStorage.setItem('lastGroupId_student', groupId);
      localStorage.setItem('lastGroupName_student', groupName);
      
      closeSidebarFunc();
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      messagesContainer.innerHTML = '';

      try {
        await loadGroupMessages(groupId, groupName);
        
        // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆ3ç§’ã”ã¨ï¼‰
        pollingInterval = setInterval(() => {
          loadNewMessages(groupId);
        }, 3000);
      } catch (e) {
        console.error('ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        messagesContainer.innerHTML = '<p style="color:#999;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>';
      }
    }

    function setInputEnabled(enabled) {
      messageInput.disabled = !enabled;
      btnSend.disabled = !enabled;
      messageInput.placeholder = enabled ? 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...' : 'å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã¯é–²è¦§ã®ã¿ã§ã™';
    }

    async function loadDirectMessages(threadId, threadName) {
      messagesContainer.innerHTML = '';
      try {
        const res = await fetch(`/codemon/chat/direct/${threadId}/messages/`);
        if (!res.ok) {
          throw new Error('failed');
        }
        const data = await res.json();
        data.messages.forEach(msg => {
          addMessage(msg.content, 'user', false, msg.id, msg.sender_user_id || null, msg.sender_avatar || null);
        });
        chatTitle.textContent = threadName + ' ãƒãƒ£ãƒƒãƒˆ';
      } catch (e) {
        messagesContainer.innerHTML = '<p style="color:#999;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>';
      }
    }

    function selectDirectThread(threadId, threadName) {
      currentGroupId = null;
      currentGroupName = null;
      currentThreadId = null;
      
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      setInputEnabled(false);
      closeSidebarFunc();
      loadDirectMessages(threadId, threadName);
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.group-item[data-group-id]').forEach(item => {
      item.addEventListener('click', function() {
        setInputEnabled(true);
        selectGroup(this.dataset.groupId, this.dataset.groupName);
      });
    });

    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.dm-item').forEach(item => {
      item.addEventListener('click', function() {
        selectDirectThread(this.dataset.threadId, this.dataset.threadName);
      });
    });

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€å¾Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¾©å…ƒ
    const lastGroupId = localStorage.getItem('lastGroupId_student');
    const lastGroupName = localStorage.getItem('lastGroupName_student');
    if (lastGroupId && lastGroupName) {
      // ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      const groupItem = document.querySelector(`.group-item[data-group-id="${lastGroupId}"]`);
      if (groupItem) {
        selectGroup(lastGroupId, lastGroupName);
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (text === '') return;
      
      // ã‚°ãƒ«ãƒ¼ãƒ—ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯è­¦å‘Š
      if (!currentGroupId) {
        alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const res = await fetch(`/codemon/chat/group/${currentGroupId}/messages/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            content: text
          })
        });
        
        if (!res.ok) {
          const error = await res.json();
          alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          return;
        }
        
        const data = await res.json();
        if (data.status === 'ok' && data.message) {
          // é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³åº§ã«è¡¨ç¤º
          addMessage(
            data.message.content,
            'user',
            false,
            data.message.message_id,
            data.message.sender_user_id,
            data.message.sender_avatar,
            data.message.attachments || [],
            data.message.created_at,
            data.message.read_count || 0
          );
          lastMessageId = data.message.message_id;
        }
        
        messageInput.value = '';
        messageInput.focus();
      } catch (e) {
        console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    btnSend.addEventListener('click', sendMessage);
    
    // Enterã‚­ãƒ¼ã§é€ä¿¡
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    function buildUploadUrl(baseUrl) {
      if (!currentGroupId) {
        alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return null;
      }
      const params = new URLSearchParams({
        group_id: currentGroupId,
        group_name: currentGroupName || ''
      });
      return `${baseUrl}?${params.toString()}`;
    }

    document.querySelector('.btn-attach').addEventListener('click', () => {
      const url = buildUploadUrl("{% url 'codemon:upload_file_teacher' %}");
      if (url) {
        window.location.href = url;
      }
    });

    document.querySelector('.btn-image').addEventListener('click', () => {
      const url = buildUploadUrl("{% url 'codemon:upload_image_teacher' %}");
      if (url) {
        window.location.href = url;
      }
    });
  });
</script>
{% endblock %}