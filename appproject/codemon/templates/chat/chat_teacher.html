{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'codemon/css/chat_teacher.css' %}?v=4">
<style>
:root {
  --chat-max-width: 800px;
  --chat-max-height: 70vh;
  --chat-border-radius: 12px;
  --chat-box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --chat-position: fixed;
  --chat-position-x: 50px;
  --chat-position-y: 130px;
}

body.no-scroll {
  overflow-x: hidden !important;
  overflow-y: visible !important;
  touch-action: pan-y;
  height: auto !important;
}

.chat-container {
  overflow-x: hidden !important;
  overflow-y: visible;
  touch-action: pan-y;
}

.chat-messages {
  overflow-x: hidden !important;
  overflow-y: auto !important;
}

/* æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤º */
body::-webkit-scrollbar:horizontal,
.chat-container::-webkit-scrollbar:horizontal {
  display: none;
}

html {
  overflow-x: hidden !important;
  overflow-y: visible !important;
}
</style>
{% endblock %}

{% block content %}
<!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ãƒªã‚¹ãƒˆï¼‰ -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <h2>ãƒãƒ£ãƒƒãƒˆä¸€è¦§</h2>
    <button class="btn-close-sidebar" id="closeSidebar">Ã—</button>
  </div>
  <div class="sidebar-content">
    <h3 class="sidebar-section-title">ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ</h3>
    {% if groups %}
      <ul class="group-list">
        {% for group in groups %}
          <li class="group-item" data-group-id="{{ group.group_id }}" data-group-name="{{ group.group_name }}">
            <div class="group-icon">ğŸ‘¥</div>
            <div class="group-info">
              <div class="group-name">{{ group.group_name }}</div>
              <div class="group-members">{{ group.members.count }}äºº</div>
            </div>
            <button class="btn-add-member" data-group-id="{{ group.group_id }}" title="ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…">ğŸ“¨</button>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="no-groups">å‚åŠ ã—ã¦ã„ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚ã‚Šã¾ã›ã‚“</p>
    {% endif %}

    <div class="sidebar-section">
      <h3 class="sidebar-section-title">å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ</h3>
      {% if direct_threads %}
        <ul class="group-list">
          {% for thread in direct_threads %}
            <li class="group-item dm-item" data-thread-id="{{ thread.thread_id }}" data-thread-name="{% if thread.owner.user_id == request.session.account_user_id %}{{ thread.participant_email }}{% else %}{{ thread.owner.user_name }}{% endif %}">
              <div class="group-icon">ğŸ’¬</div>
              <div class="group-info">
                <div class="group-name">
                  {% if thread.owner.user_id == request.session.account_user_id %}
                    {{ thread.participant_email }}
                  {% else %}
                    {{ thread.owner.user_name }}
                  {% endif %}
                </div>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <ul class="group-list">
          <li class="group-item group-item--disabled">
            <div class="group-icon">ğŸ’¬</div>
            <div class="group-info">
              <div class="group-name">ç¾åœ¨ã€å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</div>
            </div>
          </li>
        </ul>
      {% endif %}
    </div>

    {% if submission_boxes %}
    <div class="sidebar-section">
      <h3 class="sidebar-section-title">ğŸ“¥ æŠ•å‡½ãƒœãƒƒã‚¯ã‚¹</h3>
      <ul class="group-list">
        {% for box in submission_boxes %}
        <li class="group-item submission-box-item" data-box-id="{{ box.thread_id }}" data-group-id="{{ selected_group_id }}">
          <div class="group-icon">ğŸ“</div>
          <div class="group-info">
            <div class="group-name">{{ box.title }}</div>
            <div class="group-members">{{ box.messages.count }}ä»¶ã®æŠ•ç¨¿</div>
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
</div>

<!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="chat-container teacher-chat">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
  <div class="chat-header">
    <div class="header-left">
      <button class="btn-hamburger" id="hamburgerBtn" title="ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ‹ãƒ¥ãƒ¼">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <h1 class="chat-title">ãƒãƒ£ãƒƒãƒˆ</h1>
    </div>
    <div class="header-right">
      <a href="{% url 'codemon:teacher_icon_settings' %}" class="btn-icon-settings" title="ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š">âš™</a>
      <a href="{% url 'codemon:group_management' %}" class="btn-group" title="ã‚°ãƒ«ãƒ¼ãƒ—ç®¡ç†">ğŸ‘¥</a>
      <a href="{% url 'codemon:submission_box' %}" class="btn-submission" title="æŠ•å‡½ãƒœãƒƒã‚¯ã‚¹">ğŸ“¥</a>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="chat-content">
    <div class="messages-container"></div>
  </div>
  
  <!-- ãƒ•ãƒƒã‚¿ãƒ¼å…¥åŠ›éƒ¨åˆ† -->
  <div class="chat-footer">
    <div class="input-area">
      <button class="btn-attach" title="ãƒ•ã‚¡ã‚¤ãƒ«æŠ•å‡½">
        <svg class="icon-attach" viewBox="0 0 24 24">
          <path d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96z"/>
        </svg>
      </button>
      <button class="btn-image" title="ç”»åƒæŠ•å‡½">
        <svg class="icon-image" viewBox="0 0 24 24">
          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
        </svg>
      </button>
      <input type="text" class="message-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
      <button class="btn-send">
        <svg class="icon-send" viewBox="0 0 24 24">
          <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.9702544,11.6889879 22.9702544,11.5318905 22.9702544,11.4748131 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99721575 L3.03521743,10.4382088 C3.03521743,10.5953061 3.34915502,10.7524035 3.50612381,10.7524035 L16.6915026,11.5318905 C16.6915026,11.5318905 17.1624089,11.5318905 17.1624089,11.0606983 L17.1624089,12.0032827 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"/>
        </svg>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
    const currentUserId = {{ request.session.account_user_id|default:"null" }};
    // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ãƒã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—
    const currentUserAvatar = "{% if user_avatar %}{{ user_avatar }}{% endif %}" || null;
    console.log('currentUserId:', currentUserId);
    console.log('currentUserAvatar:', currentUserAvatar);
    
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    const closeSidebar = document.getElementById('closeSidebar');
    const messagesContainer = document.querySelector('.messages-container');
    const messageInput = document.querySelector('.message-input');
    const btnSend = document.querySelector('.btn-send');
    const chatTitle = document.querySelector('.chat-title');

    console.log('[DEBUG INIT] messagesContainer:', messagesContainer);
    console.log('[DEBUG INIT] messageInput:', messageInput);
    console.log('[DEBUG INIT] btnSend:', btnSend);

    let currentGroupId = null;
    let currentGroupName = null;
    let currentThreadId = null;
    let pollingInterval = null;
    let lastMessageId = null;
    let pendingReadIds = new Set();

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    const csrftoken = getCookie('csrftoken');

    function openSidebar() {
      sidebar.classList.add('open');
      sidebarOverlay.classList.add('open');
    }

    function closeSidebarFunc() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('open');
    }

    hamburgerBtn.addEventListener('click', openSidebar);
    if (closeSidebar) {
      closeSidebar.addEventListener('click', closeSidebarFunc);
    }
    if (sidebarOverlay) {
      sidebarOverlay.addEventListener('click', closeSidebarFunc);
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
    function saveMessages(groupId, messages) {
      const key = `messages_group_${groupId}`;
      localStorage.setItem(key, JSON.stringify(messages));
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿
    function loadMessages(groupId) {
      const key = `messages_group_${groupId}`;
      const data = localStorage.getItem(key);
      return data ? JSON.parse(data) : [];
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    async function deleteMessage(messageId) {
      if (!messageId) return;

      if (!confirm('ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

      try {
        const res = await fetch(`/codemon/chat/message/${messageId}/delete/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': csrftoken
          }
        });

        if (!res.ok) {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          return;
        }

        const target = document.querySelector(`.message[data-message-id="${messageId}"]`);
        if (target) {
          target.remove();
        }
      } catch (e) {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç·¨é›†
    function editMessage(messageId) {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‹ã‚‰å†…å®¹ã‚’å–å¾—
      const messageEl = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (!messageEl) return;
      
      const messageTextEl = messageEl.querySelector('.message-text');
      if (!messageTextEl) return;
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’å–å¾—ï¼ˆãƒªãƒ³ã‚¯ã®HTMLã‚’é™¤ãï¼‰
      const messageText = messageTextEl.innerText || messageTextEl.textContent;
      
      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒƒãƒˆ
      messageInput.value = messageText.trim();
      messageInput.focus();
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
      messageInput.dataset.editingId = messageId;
      btnSend.innerHTML = 'æ›´æ–°';
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      if (!document.querySelector('.btn-cancel-edit')) {
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn-cancel-edit';
        cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelBtn.onclick = cancelEdit;
        btnSend.parentNode.insertBefore(cancelBtn, btnSend);
      }
    }

    // ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    function cancelEdit() {
      delete messageInput.dataset.editingId;
      messageInput.value = '';
      btnSend.innerHTML = `
        <svg class="icon-send" viewBox="0 0 24 24">
          <path d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.41,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.9702544,11.6889879 C22.9702544,11.6889879 22.9702544,11.5318905 22.9702544,11.4748131 L4.13399899,1.16346272 C3.34915502,0.9 2.40734225,1.00636533 1.77946707,1.4776575 C0.994623095,2.10604706 0.837654326,3.0486314 1.15159189,3.99721575 L3.03521743,10.4382088 C3.03521743,10.5953061 3.34915502,10.7524035 3.50612381,10.7524035 L16.6915026,11.5318905 C16.6915026,11.5318905 17.1624089,11.5318905 17.1624089,11.0606983 L17.1624089,12.0032827 C17.1624089,12.4744748 16.6915026,12.4744748 16.6915026,12.4744748 Z"/>
        </svg>
      `;
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
      const cancelBtn = document.querySelector('.btn-cancel-edit');
      if (cancelBtn) {
        cancelBtn.remove();
      }
    }

    // URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›ã™ã‚‹é–¢æ•°
    function linkify(text) {
      const urlPattern = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
      return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer" class="message-link">$1</a>');
    }

    function formatTime(dateInput) {
      const now = dateInput ? new Date(dateInput) : new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes();
      return hours + ':' + minutes;
    }

    function setReadTooltip(readEl, readers) {
      if (!readEl) return;
      if (!readers || readers.length === 0) {
        readEl.title = '';
        readEl.style.cursor = '';
        readEl.style.textDecoration = '';
        return;
      }
      const readerNames = readers.map(reader => reader.user_name || reader.name || 'ä¸æ˜').join('\n');
      readEl.title = readerNames;
      readEl.style.cursor = 'help';
      readEl.style.textDecoration = 'underline dotted';
    }

    function addMessage(text, sender = 'user', save = true, messageId = null, senderUserId = null, senderAvatar = null, attachments = [], createdAt = null, readCount = 0, readBy = []) {
      console.log('[DEBUG] addMessage called with:', { messageId, senderUserId, currentUserId, readCount, readBy });
      const messageEl = document.createElement('div');
      // è‡ªåˆ†ãŒé€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆé€ä¿¡è€…IDãŒç¾åœ¨ã®IDã¨ä¸€è‡´ã™ã‚‹ã‹ï¼‰
      // å‹ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€ã—ã¦æ¯”è¼ƒ
      const isMyMessage = String(senderUserId) === String(currentUserId);
      messageEl.className = `message ${isMyMessage ? 'sent' : 'received'}`;
      const time = formatTime(createdAt);
      const id = messageId || 'msg_' + new Date().getTime() + '_' + Math.random().toString(36).substr(2, 9);
      
      messageEl.dataset.messageId = id;
      messageEl.dataset.senderId = senderUserId || '';
      
      console.log('addMessage called:', { text, senderUserId, currentUserId, isMyMessage, senderAvatar });
      
      // ã‚¢ãƒã‚¿ãƒ¼ç”»åƒã‚’è¡¨ç¤ºï¼ˆã‚ã‚Œã°imgã€ãªã‘ã‚Œã°çµµæ–‡å­—ï¼‰
      let avatarHtml = `<div class="message-avatar">${isMyMessage ? 'ğŸ‘¤' : 'ğŸ‘¨â€ğŸ“'}</div>`;
      if (senderAvatar) {
        avatarHtml = `<div class="message-avatar"><img src="${senderAvatar}" alt="avatar"></div>`;
      }
      
      const messageTextHtml = text ? `<div class="message-text">${linkify(text)}</div>` : '';
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      function getFileIcon(fileName) {
        const ext = fileName.split('.').pop().toLowerCase();
        const iconMap = {
          'pdf': 'ğŸ“„', 'xlsx': 'ğŸ“Š', 'xls': 'ğŸ“Š', 'csv': 'ğŸ“Š',
          'docx': 'ğŸ“', 'doc': 'ğŸ“', 'pptx': 'ğŸ¯', 'ppt': 'ğŸ¯',
          'txt': 'ğŸ“‹', 'zip': 'ğŸ—‚ï¸', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸'
        };
        return iconMap[ext] || 'ğŸ“';
      }
      
      function formatFileSize(bytes) {
        if (!bytes) return 'N/A';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        while (size >= 1024 && unitIndex < units.length - 1) {
          size /= 1024;
          unitIndex++;
        }
        return Math.round(size * 100) / 100 + ' ' + units[unitIndex];
      }
      
      const attachmentsHtml = (attachments && attachments.length)
        ? `<div class="message-attachments">
            ${attachments.map(att => {
              const attachmentId = att.id || att.attachment_id || '';
              const downloadUrl = att.download_url || (attachmentId ? `/codemon/chat/attachment/${attachmentId}/download/` : att.url);
              const fileName = att.name || 'file';
              const fileSize = att.size ? formatFileSize(att.size) : '';
              const fileIcon = getFileIcon(fileName);
              
              if (att.type === 'image') {
                return `<div class="attachment-image">
                  <a href="${att.url}" target="_blank" rel="noopener noreferrer">
                    <img src="${att.url}" alt="${fileName}" class="attachment-image-img" style="max-width: 220px; border-radius: 6px;" />
                  </a>
                  <div class="image-download-wrapper">
                    <a href="${downloadUrl}" download="${fileName}" class="attachment-download-btn" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ï¸</a>
                  </div>
                </div>`;
              }
              
              return `<div class="attachment-card">
                <div class="attachment-card-header">
                  <span class="attachment-icon">${fileIcon}</span>
                  <span class="attachment-name">${fileName}</span>
                </div>
                <div class="attachment-card-info">
                  ${fileSize ? `<span class="attachment-size">${fileSize}</span>` : ''}
                  <a href="${downloadUrl}" download="${fileName}" class="attachment-download" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ï¸</a>
                </div>
              </div>`;
            }).join('')}
          </div>`
        : '';

      // æ—¢èª­è¡¨ç¤ºï¼ˆè‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿ï¼‰
      let readLabel = '';
      if (isMyMessage) {
        console.log('[DEBUG] My message - readBy:', readBy, 'readCount:', readCount);
        // readByãŒé…åˆ—ã®å ´åˆã¯ãã®é•·ã•ã‚’ã€ãã†ã§ãªã„å ´åˆã¯readCountã‚’ä½¿ç”¨
        const readerCount = (readBy && Array.isArray(readBy)) ? readBy.length : (readCount || 0);
        if (readerCount > 0) {
          readLabel = `æ—¢èª­ ${readerCount}`;
          console.log('[DEBUG] Using readerCount:', readerCount);
        }
        console.log('[DEBUG] Final readLabel:', readLabel);
      }
      const readHtml = isMyMessage ? `<span class="message-read" data-read-for="${id}">${readLabel}</span>` : '';
      console.log('[DEBUG] readHtml:', readHtml);

      const finalHtml = `
        ${avatarHtml}
        <div class="message-content">
          ${text ? `
          <div class="message-bubble">
            ${messageTextHtml}
            ${isMyMessage ? `
            <div class="message-actions">
              <button class="btn-edit-message" onclick="editMessage('${id}')" title="ç·¨é›†">âœï¸</button>
              <button class="btn-delete-message" onclick="deleteMessage('${id}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
            </div>
            ` : ''}
          </div>
          ` : `
          ${attachmentsHtml}
          ${isMyMessage ? `
          <div class="message-actions" style="margin-top: 8px;">
            <button class="btn-delete-message" onclick="deleteMessage('${id}')" title="å‰Šé™¤">ğŸ—‘ï¸</button>
          </div>
          ` : ''}
          `}
          ${text ? attachmentsHtml : ''}
          <div class="message-meta">
            <span class="message-time">${time}</span>
            ${readHtml}
          </div>
        </div>
      `;
      
      console.log('[DEBUG] Setting innerHTML for message', id);
      messageEl.innerHTML = finalHtml;
      console.log('[DEBUG] After innerHTML, message-read exists:', messageEl.querySelector('.message-read') !== null);
      
      messagesContainer.appendChild(messageEl);
      console.log('[DEBUG] Message appended. Container children count:', messagesContainer.children.length);
      console.log('[DEBUG] Message element:', messageEl);
      setReadTooltip(messageEl.querySelector('.message-read'), readBy);
      
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜
      if (save && currentGroupId) {
        const messages = loadMessages(currentGroupId);
        messages.push({
          id: id,
          text: text,
          sender: sender,
          senderUserId: senderUserId || currentUserId,
          senderAvatar: senderAvatar,
          attachments: attachments || [],
          timestamp: new Date().getTime(),
          time: time
        });
        saveMessages(currentGroupId, messages);
      }
    }

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«å…¬é–‹
    window.deleteMessage = deleteMessage;
    window.editMessage = editMessage;

    // ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã™ã‚‹é–¢æ•°
    async function ensureGroupThread(groupId) {
      const res = await fetch(`/codemon/chat/group/${groupId}/thread/`);
      if (!res.ok) {
        throw new Error('failed');
      }
      return await res.json();
    }

    async function loadGroupMessages(groupId) {
      console.log('loadGroupMessages called for groupId:', groupId);
      const res = await fetch(`/codemon/chat/group/${groupId}/messages/`);
      if (!res.ok) {
        console.error('Failed to fetch messages:', res.status, res.statusText);
        throw new Error('failed');
      }
      const data = await res.json();
      console.log('Messages data received:', data);
      console.log('Messages count:', data.messages ? data.messages.length : 0);
      console.log('Messages array:', data.messages);
      if (data.thread_id) {
        currentThreadId = data.thread_id;
      }
      
      messagesContainer.innerHTML = '';
      lastMessageId = null;
      
      const unreadIds = [];
      if (data.messages && data.messages.length > 0) {
        data.messages.forEach(msg => {
          console.log('[DEBUG] Message:', msg.message_id, 'read_by:', msg.read_by, 'read_count:', msg.read_count);
          addMessage(
            msg.content || '',
            'user',
            false,
            msg.message_id,
            msg.sender_user_id,
            msg.sender_avatar || null,
            msg.attachments || [],
            msg.created_at,
            msg.read_count || 0,
            msg.read_by || []
          );
          // å‹ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€ã—ã¦æ¯”è¼ƒ
          if (String(msg.sender_user_id) !== String(currentUserId)) {
            unreadIds.push(msg.message_id);
          }
          lastMessageId = msg.message_id;
        });
      } else {
        console.log('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Šã¾ã›ã‚“');
      }

      if (unreadIds.length) {
        console.log('[DEBUG] Marking messages as read:', unreadIds);
        markMessagesRead(unreadIds);
      }
    }

    async function loadNewMessages(groupId) {
      if (!groupId || groupId !== currentGroupId) return;
      
      try {
        const res = await fetch(`/codemon/chat/group/${groupId}/messages/`);
        if (!res.ok) return;
        
        const data = await res.json();
        const unreadIds = [];
        
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãŸã ã—æ—¢èª­æ•°ã¯æ›´æ–°ï¼‰
            if (lastMessageId && msg.message_id <= lastMessageId) {
              // æ—¢èª­æ•°ã‚’å¸¸ã«æ›´æ–°ï¼ˆå‹ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€ã—ã¦æ¯”è¼ƒï¼‰
              if (String(msg.sender_user_id) === String(currentUserId)) {
                updateReadCount(msg.message_id, msg.read_by || []);
              }
              return;
            }
            
            addMessage(
              msg.content || '',
              'user',
              false,
              msg.message_id,
              msg.sender_user_id,
              msg.sender_avatar || null,
              msg.attachments || [],
              msg.created_at,
              msg.read_count || 0,
              msg.read_by || []
            );
            
            // å‹ã‚’æ–‡å­—åˆ—ã«çµ±ä¸€ã—ã¦æ¯”è¼ƒ
            if (String(msg.sender_user_id) !== String(currentUserId)) {
              unreadIds.push(msg.message_id);
            }
            lastMessageId = msg.message_id;
          });
        }
        
        if (unreadIds.length) {
          markMessagesRead(unreadIds);
        }
      } catch (e) {
        console.error('æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadNewDirectMessages(threadId) {
      if (!threadId || threadId !== currentThreadId) return;
      
      try {
        const res = await fetch(`/codemon/chat/direct/${threadId}/messages/`);
        if (!res.ok) return;
        
        const data = await res.json();
        
        if (data.messages && data.messages.length > 0) {
          data.messages.forEach(msg => {
            // æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—
            const msgId = msg.message_id || msg.id;
            if (lastMessageId && msgId <= lastMessageId) {
              return;
            }
            
            addMessage(
              msg.content || '',
              'user',
              false,
              msgId,
              msg.sender_user_id || null,
              msg.sender_avatar || null,
              [],
              msg.created_at
            );
            
            lastMessageId = msgId;
          });
        }
      } catch (e) {
        console.error('æ–°ã—ã„å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function updateReadCount(messageId, readers) {
      const messageEl = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (!messageEl) return;
      if (String(messageEl.dataset.senderId) !== String(currentUserId)) return;

      const readEl = messageEl.querySelector('.message-read');
      if (!readEl) return;
      const readCount = readers.length;
      readEl.textContent = readCount > 0 ? `æ—¢èª­ ${readCount}` : '';
      setReadTooltip(readEl, readers);
    }

    async function markMessagesRead(messageIds) {
      if (!messageIds || messageIds.length === 0) return;
      
      try {
        const response = await fetch('/codemon/api/mark-messages-read/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ message_ids: messageIds })
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log(`æ—¢èª­ãƒãƒ¼ã‚¯é€ä¿¡: ${result.marked_count}ä»¶`);
        }
      } catch (error) {
        console.error('æ—¢èª­ãƒãƒ¼ã‚¯é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }

    async function selectGroup(groupId, groupName) {
      currentGroupId = groupId;
      currentGroupName = groupName;
      currentThreadId = null;
      
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      // ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      chatTitle.textContent = groupName + ' ãƒãƒ£ãƒƒãƒˆ';
      
      // localStorageã«ä¿å­˜
      localStorage.setItem('lastGroupId_teacher', groupId);
      localStorage.setItem('lastGroupName_teacher', groupName);
      
      closeSidebarFunc();
      setInputEnabled(true);
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      messagesContainer.innerHTML = '';

      try {
        await loadGroupMessages(groupId, groupName);
        
        // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆ3ç§’ã”ã¨ï¼‰
        pollingInterval = setInterval(() => {
          loadNewMessages(groupId);
        }, 3000);
      } catch (e) {
        console.error('ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        messagesContainer.innerHTML = '<p style="color:#999;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>';
        setInputEnabled(true);
      }
    }

    function setInputEnabled(enabled) {
      messageInput.disabled = !enabled;
      btnSend.disabled = !enabled;
      messageInput.placeholder = enabled ? 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...' : 'ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„';
    }

    async function loadDirectMessages(threadId, threadName) {
      messagesContainer.innerHTML = '';
      lastMessageId = null;
      
      try {
        const res = await fetch(`/codemon/chat/direct/${threadId}/messages/`);
        if (!res.ok) {
          throw new Error('failed');
        }
        const data = await res.json();
        data.messages.forEach(msg => {
          const msgId = msg.message_id || msg.id;
          addMessage(msg.content, 'user', false, msgId, msg.sender_user_id || null, msg.sender_avatar || null);
          lastMessageId = msgId;
        });
        chatTitle.textContent = threadName + ' ãƒãƒ£ãƒƒãƒˆ';
      } catch (e) {
        messagesContainer.innerHTML = '<p style="color:#999;">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ</p>';
      }
    }

    function selectDirectThread(threadId, threadName) {
      currentGroupId = null;
      currentGroupName = null;
      currentThreadId = threadId;
      
      if (pollingInterval) {
        clearInterval(pollingInterval);
      }
      
      // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã§ã‚‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚’æœ‰åŠ¹åŒ–
      setInputEnabled(true);
      closeSidebarFunc();
      loadDirectMessages(threadId, threadName);
      
      // localStorageã«ä¿å­˜
      localStorage.setItem('lastThreadId_teacher', threadId);
      localStorage.setItem('lastThreadName_teacher', threadName);
      
      // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹ï¼ˆ3ç§’ã”ã¨ï¼‰
      pollingInterval = setInterval(() => {
        loadNewDirectMessages(threadId);
      }, 3000);
    }

    // ã‚°ãƒ«ãƒ¼ãƒ—ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.group-item[data-group-id]').forEach(item => {
      item.addEventListener('click', function(e) {
        // ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (e.target.closest('.btn-add-member')) {
          return;
        }
        
        setInputEnabled(true);
        selectGroup(this.dataset.groupId, this.dataset.groupName);
      });
    });

    // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.dm-item').forEach(item => {
      item.addEventListener('click', function() {
        selectDirectThread(this.dataset.threadId, this.dataset.threadName);
      });
    });

    // æŠ•å‡½ãƒœãƒƒã‚¯ã‚¹ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.submission-box-item').forEach(item => {
      item.addEventListener('click', function() {
        const boxId = this.dataset.boxId;
        // æŠ•å‡½ãƒœãƒƒã‚¯ã‚¹è©³ç´°ç”»é¢ã¸é·ç§»
        window.location.href = '/codemon/chat/submission-box/' + boxId + '/';
      });
    });

    // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æœ€å¾Œã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å¾©å…ƒ
    const lastGroupId = localStorage.getItem('lastGroupId_teacher');
    const lastGroupName = localStorage.getItem('lastGroupName_teacher');
    if (lastGroupId && lastGroupName) {
      // ã‚°ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
      const groupItem = document.querySelector(`.group-item[data-group-id="${lastGroupId}"]`);
      if (groupItem) {
        selectGroup(lastGroupId, lastGroupName);
      }
    }

    // ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.querySelectorAll('.btn-add-member').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        const groupId = this.dataset.groupId;
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…ãƒšãƒ¼ã‚¸ã¸é·ç§»
        window.location.href = "{% url 'codemon:chat_invitation' %}?group_id=" + groupId;
      });
    });

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (text === '') return;
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
      const editingId = messageInput.dataset.editingId;
      
      if (editingId) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        try {
          const res = await fetch(`/codemon/chat/message/${editingId}/edit/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
              content: text
            })
          });
          
          if (!res.ok) {
            const error = await res.json();
            alert('ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            return;
          }
          
          const data = await res.json();
          
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’æ›´æ–°
          const messageEl = document.querySelector(`.message[data-message-id="${editingId}"]`);
          if (messageEl) {
            const messageTextEl = messageEl.querySelector('.message-text');
            if (messageTextEl) {
              messageTextEl.innerHTML = linkify(data.content);
            }
          }
          
          // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤
          cancelEdit();
        } catch (e) {
          console.error('ç·¨é›†ã‚¨ãƒ©ãƒ¼:', e);
          alert('ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        return;
      }
      
      console.log('[DEBUG] sendMessage started - currentGroupId:', currentGroupId, 'currentThreadId:', currentThreadId);
      
      // ã‚°ãƒ«ãƒ¼ãƒ—ã¾ãŸã¯å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯è­¦å‘Š
      if (!currentGroupId && !currentThreadId) {
        alert('ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        let url, messageData;
        
        // ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆã‹å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆã‹ã§é€ä¿¡å…ˆã‚’åˆ†å²
        if (currentGroupId) {
          // ã‚°ãƒ«ãƒ¼ãƒ—ãƒãƒ£ãƒƒãƒˆ
          url = `/codemon/chat/group/${currentGroupId}/messages/`;
        } else if (currentThreadId) {
          // å€‹åˆ¥ãƒãƒ£ãƒƒãƒˆ
          url = `/codemon/chat/direct/${currentThreadId}/messages/`;
        } else {
          alert('ãƒãƒ£ãƒƒãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        console.log('[DEBUG] Sending to URL:', url);
        
        const res = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({
            content: text
          })
        });
        
        console.log('[DEBUG] Response status:', res.status);
        
        if (!res.ok) {
          const error = await res.json();
          console.error('[DEBUG] Error response:', error);
          alert('é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          return;
        }
        
        const data = await res.json();
        console.log('[DEBUG] Response data:', data);
        
        if (data.status === 'ok' && data.message) {
          console.log('[DEBUG] Message received, adding to display:', data.message);
          // é€ä¿¡ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å³åº§ã«è¡¨ç¤º
          addMessage(
            data.message.content,
            'user',
            false,
            data.message.message_id,
            data.message.sender_user_id,
            data.message.sender_avatar,
            data.message.attachments || [],
            data.message.created_at,
            data.message.read_count || 0
          );
          lastMessageId = data.message.message_id;
          console.log('[DEBUG] Message added successfully');
        } else {
          console.error('[DEBUG] Unexpected response format:', data);
          alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        messageInput.value = '';
        messageInput.focus();
      } catch (e) {
        console.error('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    btnSend.addEventListener('click', sendMessage);
    
    // Enterã‚­ãƒ¼ã§é€ä¿¡
    messageInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
      }
    });

    function buildUploadUrl(baseUrl) {
      if (!currentGroupId) {
        alert('ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return null;
      }
      const params = new URLSearchParams({
        group_id: currentGroupId,
        group_name: currentGroupName || ''
      });
      return `${baseUrl}?${params.toString()}`;
    }

    document.querySelector('.btn-attach').addEventListener('click', () => {
      const url = buildUploadUrl("{% url 'codemon:upload_file_teacher' %}");
      if (url) {
        window.location.href = url;
      }
    });

    document.querySelector('.btn-image').addEventListener('click', () => {
      const url = buildUploadUrl("{% url 'codemon:upload_image_teacher' %}");
      if (url) {
        window.location.href = url;
      }
    });
  });
</script>
{% endblock %}