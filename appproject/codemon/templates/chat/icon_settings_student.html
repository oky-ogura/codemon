{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'codemon/css/icon_settings.css' %}">
<style>
:root {
  --chat-max-width: 800px;
  --chat-max-height: 70vh;
  --chat-border-radius: 12px;
  --chat-box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --chat-position: fixed;
  --chat-position-x: 50px;
  --chat-position-y: 130px;
}
</style>
{% endblock %}

{% block content %}
<div class="icon-settings-container student">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="settings-header">
    <button class="btn-back" onclick="history.back()">â†</button>
    <h1 class="settings-title">ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š</h1>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="settings-content">
    <!-- ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤º -->
    <div class="current-icon-section">
      <h2>ç¾åœ¨ã®ã‚¢ã‚¤ã‚³ãƒ³</h2>
      <div class="current-icon-display">
        <img src="{% if current_avatar %}{{ current_avatar }}{% else %}{% static 'codemon/images/avatars/default_student.png' %}{% endif %}" 
             alt="Current Avatar" 
             class="current-avatar-image">
      </div>
    </div>

    <!-- ã‚¢ã‚¤ã‚³ãƒ³é¸æŠã‚¨ãƒªã‚¢ -->
    <div class="icon-selection-section">
      <h2>ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ</h2>
      <div class="icon-grid">
        <div class="icon-item">
          <input type="radio" id="avatar-1" name="avatar" value="avatar-1" class="avatar-radio">
          <label for="avatar-1">
            <img src="{% static 'codemon/images/avatars/avatar_1.png' %}" alt="Avatar 1">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-2" name="avatar" value="avatar-2" class="avatar-radio">
          <label for="avatar-2">
            <img src="{% static 'codemon/images/avatars/avatar_2.png' %}" alt="Avatar 2">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-3" name="avatar" value="avatar-3" class="avatar-radio">
          <label for="avatar-3">
            <img src="{% static 'codemon/images/avatars/avatar_3.png' %}" alt="Avatar 3">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-4" name="avatar" value="avatar-4" class="avatar-radio">
          <label for="avatar-4">
            <img src="{% static 'codemon/images/avatars/avatar_4.png' %}" alt="Avatar 4">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-5" name="avatar" value="avatar-5" class="avatar-radio">
          <label for="avatar-5">
            <img src="{% static 'codemon/images/avatars/avatar_5.png' %}" alt="Avatar 5">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-6" name="avatar" value="avatar-6" class="avatar-radio">
          <label for="avatar-6">
            <img src="{% static 'codemon/images/avatars/avatar_6.png' %}" alt="Avatar 6">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-7" name="avatar" value="avatar-7" class="avatar-radio">
          <label for="avatar-7">
            <img src="{% static 'codemon/images/avatars/avatar_7.png' %}" alt="Avatar 7">
          </label>
        </div>

        <div class="icon-item">
          <input type="radio" id="avatar-8" name="avatar" value="avatar-8" class="avatar-radio">
          <label for="avatar-8">
            <img src="{% static 'codemon/images/avatars/avatar_8.png' %}" alt="Avatar 8">
          </label>
        </div>
      </div>
    </div>

    <!-- ã¾ãŸã¯ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ -->
    <div class="upload-section">
      <h2>ã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
      <div class="upload-area">
        <input type="file" id="avatar-upload" class="file-input" accept="image/*">
        <label for="avatar-upload" class="upload-label">
          <span class="upload-icon">ğŸ“</span>
          <span class="upload-text">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>
        </label>
      </div>
      <div class="upload-preview-area hidden">
        <img id="preview-image" src="" alt="Preview" class="preview-image">
      </div>
    </div>
  </div>

  <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <div class="settings-footer">
    <button class="btn-cancel" onclick="history.back()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn-save">ä¿å­˜ã™ã‚‹</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  document.querySelectorAll('.avatar-radio').forEach(radio => {
    radio.addEventListener('change', (e) => {
      const selectedImg = e.target.nextElementSibling.querySelector('img');
      document.querySelector('.current-avatar-image').src = selectedImg.src;
      // é¸æŠã•ã‚ŒãŸã‚¢ãƒã‚¿ãƒ¼ã‚’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«æ ¼ç´
      document.querySelector('.icon-settings-container').dataset.selectedAvatarValue = e.target.value;
      document.querySelector('.icon-settings-container').dataset.selectedAvatarSrc = selectedImg.src;
    });
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
  const fileInput = document.querySelector('#avatar-upload');
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (event) => {
        const preview = document.querySelector('.upload-preview-area');
        const previewImg = document.querySelector('#preview-image');
        previewImg.src = event.target.result;
        preview.classList.remove('hidden');
        document.querySelector('.current-avatar-image').src = event.target.result;
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã«æ ¼ç´
        document.querySelector('.icon-settings-container').dataset.uploadedFile = file;
        document.querySelector('.icon-settings-container').dataset.isUploadedFile = 'true';
      };
      reader.readAsDataURL(file);
    }
  });

  // ä¿å­˜å‡¦ç†
  document.querySelector('.btn-save').addEventListener('click', async () => {
    const container = document.querySelector('.icon-settings-container');
    const isUploadedFile = container.dataset.isUploadedFile === 'true';
    const selectedAvatarValue = container.dataset.selectedAvatarValue;
    
    if (isUploadedFile) {
      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜
      const formData = new FormData();
      formData.append('avatar', fileInput.files[0]);
      
      try {
        const response = await fetch('{% url "codemon:save_avatar" %}', {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: formData
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('ã‚¢ãƒã‚¿ãƒ¼ä¿å­˜æˆåŠŸ:', data);
          // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã‚‹
          window.location.href = "{% url 'codemon:chat_student' %}";
        } else {
          alert('ã‚¢ãƒã‚¿ãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¢ãƒã‚¿ãƒ¼ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    } else if (selectedAvatarValue) {
      // ãƒ—ãƒªã‚»ãƒƒãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ä¿å­˜
      const selectedImg = document.querySelector(`label[for="${selectedAvatarValue}"] img`);
      const formData = new FormData();
      
      // ç”»åƒã‚’blobã«å¤‰æ›ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = async () => {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(async (blob) => {
          formData.append('avatar', blob, `${selectedAvatarValue}.png`);
          
          try {
            const response = await fetch('{% url "codemon:save_avatar" %}', {
              method: 'POST',
              headers: {
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: formData
            });
            
            if (response.ok) {
              const data = await response.json();
              console.log('ã‚¢ãƒã‚¿ãƒ¼ä¿å­˜æˆåŠŸ:', data);
              // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã‚‹
              window.location.href = "{% url 'codemon:chat_student' %}";
            } else {
              alert('ã‚¢ãƒã‚¿ãƒ¼ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
          } catch (error) {
            console.error('ã‚¨ãƒ©ãƒ¼:', error);
            alert('ã‚¢ãƒã‚¿ãƒ¼ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
          }
        });
      };
      img.src = selectedImg.src;
    } else {
      alert('ã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
  });
  
  // CSRF tokenã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
