{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'codemon/css/group_management.css' %}">
<style>
.edit-container {
  position: fixed;
  left: 50px;
  top: 130px;
  width: 800px;
  max-height: 70vh;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.edit-header {
  display: flex;
  align-items: center;
  padding: 16px 20px;
  border-bottom: 1px solid #e5e5ea;
  background: #f8f8f8;
}

.btn-back {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  padding: 8px;
  color: #333;
  transition: opacity 0.2s;
}

.btn-back:hover {
  opacity: 0.6;
}

.edit-title {
  flex: 1;
  margin: 0;
  font-size: 20px;
  font-weight: 600;
  color: #333;
  text-align: center;
}

.edit-content {
  flex: 1;
  overflow-y: auto;
  padding: 30px;
}

.form-group {
  margin-bottom: 24px;
}

.form-group label {
  display: block;
  font-size: 16px;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
}

.form-group input[type="text"],
.form-group textarea {
  width: 100%;
  padding: 12px;
  border: 1px solid #e5e5ea;
  border-radius: 8px;
  font-size: 16px;
  box-sizing: border-box;
  transition: border-color 0.3s;
}

.form-group input[type="text"]:focus,
.form-group textarea:focus {
  outline: none;
  border-color: #06c755;
}

.form-group textarea {
  min-height: 100px;
  resize: vertical;
}

.members-section {
  margin-top: 30px;
}

.members-section h3 {
  font-size: 18px;
  margin-bottom: 15px;
  color: #333;
}

.member-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.member-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f8f8f8;
  border-radius: 8px;
  margin-bottom: 8px;
}

.member-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.member-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #ddd;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.member-name {
  font-size: 16px;
  color: #333;
}

.member-role {
  font-size: 14px;
  color: #666;
  margin-left: 8px;
}

.btn-remove-member {
  padding: 6px 12px;
  background: #ff4444;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-remove-member:hover {
  background: #cc0000;
}

.edit-footer {
  display: flex;
  gap: 12px;
  padding: 16px 20px;
  border-top: 1px solid #e5e5ea;
  background: #f8f8f8;
}

.btn-cancel, .btn-save {
  flex: 1;
  padding: 12px 16px;
  border: none;
  border-radius: 6px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s;
}

.btn-cancel {
  background-color: #e5e5ea;
  color: #333;
}

.btn-cancel:hover {
  background-color: #d1d1d6;
}

.btn-save {
  background-color: #06c755;
  color: white;
}

.btn-save:hover {
  background-color: #05b04b;
}

.add-member-section {
  margin-top: 20px;
  padding: 20px;
  background: #f8f8f8;
  border-radius: 8px;
}

.add-member-section h4 {
  font-size: 16px;
  margin-bottom: 12px;
  color: #333;
}

.add-member-form {
  display: flex;
  gap: 10px;
}

.add-member-form input {
  flex: 1;
  padding: 10px;
  border: 1px solid #e5e5ea;
  border-radius: 6px;
  font-size: 14px;
}

.btn-add-member {
  padding: 10px 20px;
  background: #06c755;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
  transition: background 0.3s;
}

.btn-add-member:hover {
  background: #05b04b;
}
</style>
{% endblock %}

{% block content %}
<div class="edit-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="edit-header">
    <button class="btn-back" onclick="history.back()">â†</button>
    <h1 class="edit-title">ã‚°ãƒ«ãƒ¼ãƒ—ç·¨é›†</h1>
    <div style="width: 40px;"></div>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="edit-content">
    <form method="post" id="edit-group-form">
      {% csrf_token %}
      
      <div class="form-group">
        <label for="group-name">ã‚°ãƒ«ãƒ¼ãƒ—å *</label>
        <input type="text" id="group-name" name="group_name" value="{{ group.group_name }}" required>
      </div>

      <div class="form-group">
        <label for="group-description">èª¬æ˜</label>
        <textarea id="group-description" name="description">{{ group.description }}</textarea>
      </div>

      <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="members-section">
        <h3>ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h3>
        <ul class="member-list">
          {% for membership in group.memberships.all %}
          <li class="member-item">
            <div class="member-info">
              <div class="member-avatar">
                {% if membership.member.avatar %}
                  <img src="{{ membership.member.avatar.url }}" alt="avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                {% else %}
                  ğŸ‘¤
                {% endif %}
              </div>
              <span class="member-name">{{ membership.member.user_name }}</span>
              <span class="member-role">({{ membership.get_role_display }})</span>
            </div>
            {% if membership.role != 'owner' %}
            <a href="{% url 'codemon:group_member_delete' group.group_id membership.member.user_id %}" class="btn-remove-member" style="text-decoration: none; display: inline-block;">å‰Šé™¤</a>
            {% endif %}
          </li>
          {% endfor %}
        </ul>

        <!-- ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ  -->
        <div class="add-member-section">
          <h4>æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼ã‚’æ‹›å¾…</h4>
          <div class="add-member-form">
            <input type="email" id="member-email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›">
            <button type="button" class="btn-add-member" onclick="addMember()">æ‹›å¾…</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <div class="edit-footer">
    <button class="btn-cancel" onclick="history.back()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn-save" onclick="saveGroup()">ä¿å­˜</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function saveGroup() {
    const form = document.getElementById('edit-group-form');
    const formData = new FormData(form);
    
    const groupName = formData.get('group_name');
    if (!groupName || groupName.trim() === '') {
      alert('ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    form.submit();
  }

  function removeMember(membershipId) {
    if (confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
      fetch(`/codemon/groups/{{ group.group_id }}/members/${membershipId}/remove/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => {
        if (response.ok) {
          alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          location.reload();
        } else {
          alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      });
    }
  }

  function addMember() {
    const email = document.getElementById('member-email').value;
    if (!email || email.trim() === '') {
      alert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    // TODO: ãƒ¡ãƒ³ãƒãƒ¼æ‹›å¾…APIã‚’å®Ÿè£…
    alert('æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
    document.getElementById('member-email').value = '';
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
</script>
{% endblock %}
