{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
:root {
  --box-max-width: 800px;
  --box-position-x: 50px;
  --box-position-y: 135px;
}

.submission-box-container {
  position: fixed;
  left: var(--box-position-x);
  top: var(--box-position-y);
  width: calc(100% - 100px);
  max-width: var(--box-max-width);
  height: calc(85vh - 100px);
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.box-header {
  padding: 20px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.box-title {
  margin: 0 0 8px 0;
  font-size: 22px;
  font-weight: 600;
}

.box-meta {
  display: flex;
  gap: 20px;
  font-size: 14px;
  opacity: 0.9;
}

.box-meta-item {
  display: flex;
  align-items: center;
  gap: 6px;
}

.box-description {
  margin: 12px 0 0 0;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 6px;
  font-size: 14px;
  line-height: 1.6;
}

.box-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.submissions-list {
  flex: 1;
  padding: 20px 24px;
  overflow-y: auto;
}

.submission-item {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  border: 1px solid #e9ecef;
}

.submission-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.submitter-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.submitter-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #667eea;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
}

.submitter-name {
  font-weight: 600;
  color: #333;
}

.submission-time {
  font-size: 13px;
  color: #6c757d;
}

.submission-content {
  color: #495057;
  line-height: 1.6;
  margin-bottom: 12px;
}

.submission-attachments {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  margin-top: 12px;
}

.attachment-item {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  font-size: 13px;
  color: #495057;
  text-decoration: none;
  transition: all 0.2s;
}

.attachment-item:hover {
  background: #e9ecef;
  border-color: #adb5bd;
}

/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆsubmission_boxç”¨ï¼‰ */
.submission-attachments .attachment-card {
  flex: 0 1 calc(50% - 6px);
  max-width: 350px;
}

.box-footer {
  padding: 16px 24px;
  border-top: 1px solid #e9ecef;
  background: #f8f9fa;
}

.form-toggle {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
}

.btn-toggle-form {
  padding: 8px 12px;
  border-radius: 6px;
  border: 1px solid #cbd5f5;
  background: #eef2ff;
  color: #374151;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-toggle-form:hover {
  background: #e0e7ff;
}

.form-collapsible.is-collapsed {
  display: none;
}

.submission-form {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.form-row {
  display: flex;
  gap: 8px;
}

.message-input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: 14px;
  resize: none;
  font-family: inherit;
}

.message-input:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.btn-attach, .btn-submit {
  padding: 12px 20px;
  border: none;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.btn-attach {
  background: #6c757d;
  color: white;
}

.btn-attach:hover {
  background: #5a6268;
}

.btn-submit {
  background: #667eea;
  color: white;
}

.btn-submit:hover {
  background: #5568d3;
}

.btn-submit:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6c757d;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.btn-back {
  position: absolute;
  top: 24px;
  right: 24px;
  background: rgba(255, 255, 255, 0.2);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.btn-back:hover {
  background: rgba(255, 255, 255, 0.3);
}

.expired-banner {
  background: #fff3cd;
  border: 1px solid #ffeeba;
  color: #856404;
  padding: 10px 14px;
  border-radius: 8px;
  margin-top: 12px;
  font-size: 14px;
}

.form-disabled {
  opacity: 0.6;
  pointer-events: none;
}

.submission-check {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #555;
  background: #f3f4f6;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
}

.submission-check input {
  width: 14px;
  height: 14px;
  cursor: pointer;
}

.grade-check {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #1f2937;
  background: #e0f2fe;
  padding: 4px 8px;
  border-radius: 999px;
  border: 1px solid #bae6fd;
}

.grade-check input {
  width: 14px;
  height: 14px;
  cursor: pointer;
}

.btn-grade {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid #4f46e5;
  background: #4f46e5;
  color: #fff;
  text-decoration: none;
  cursor: pointer;
  transition: opacity 0.2s;
}

.btn-grade:hover {
  opacity: 0.9;
}

.btn-view-grade {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
  border: 1px solid #059669;
  background: #059669;
  color: #fff;
  cursor: pointer;
  transition: opacity 0.2s;
  border: none;
}

.btn-view-grade:hover {
  opacity: 0.9;
}
</style>
{% endblock %}

{% block content %}
<div class="submission-box-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="box-header">
    {% if is_teacher %}
    <button class="btn-back" onclick="location.href='{% url 'codemon:submission_box' %}'">æˆ»ã‚‹</button>
    {% else %}
    <button class="btn-back" onclick="location.href='{% url 'codemon:chat_student' %}'">æˆ»ã‚‹</button>
    {% endif %}
    <h1 class="box-title">{{ box.title }}</h1>
    <div class="box-meta">
      {% if box.group %}
      <div class="box-meta-item">
        <span>ğŸ‘¥</span>
        <span>{{ box.group.group_name }}</span>
      </div>
      {% endif %}
      <div class="box-meta-item">
        <span>ğŸ“…</span>
        <span>ä½œæˆæ—¥: {{ box.created_at|date:"Y/m/d H:i" }}</span>
      </div>
      <div class="box-meta-item">
        <span>ğŸ“</span>
        <span>æŠ•ç¨¿æ•°: {{ submissions.count }}ä»¶</span>
      </div>
    </div>
    {% if box.description %}
    <div class="box-description">
      {{ box.description }}
    </div>
    {% endif %}
    {% if is_expired %}
    <div class="expired-banner">ã“ã®æŠ•å‡½ãƒœãƒƒã‚¯ã‚¹ã¯æœŸé™åˆ‡ã‚Œã®ãŸã‚ã€æŠ•ç¨¿ã§ãã¾ã›ã‚“ã€‚</div>
    {% endif %}
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="box-content">
    <div class="submissions-list" id="submissionsList">
      {% if submissions %}
        {% for submission in submissions %}
        <div class="submission-item">
          <div class="submission-header">
            <div class="submitter-info">
              <div class="submitter-avatar">
                {% if submission.sender.avatar %}
                <img src="{{ submission.sender.avatar.url }}" alt="" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                {% else %}
                {{ submission.sender.user_name|first|upper }}
                {% endif %}
              </div>
              <div>
                <div class="submitter-name">{{ submission.sender.user_name }}</div>
                <div class="submission-time">{{ submission.created_at|date:"Y/m/d H:i" }}</div>
              </div>
            </div>
            {% if is_teacher %}
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
              <label class="grade-check">
                <input type="checkbox" 
                       class="grade-check-input" 
                       data-message-id="{{ submission.message_id }}"
                       {% if submission.scores.first and submission.scores.first.is_checked %}checked{% endif %}
                       onchange="toggleGradeCheck(this)">
                æ¡ç‚¹æ¸ˆã¿
              </label>
              <a class="btn-grade" href="{% url 'codemon:grading_with_message' submission.message_id %}">æ¡ç‚¹</a>
              {% if submission.scores.first %}
              <a class="btn-view-grade" href="{% url 'codemon:grading_detail' submission.message_id %}">è©³ç´°ã‚’è¦‹ã‚‹</a>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% if submission.content %}
          <div class="submission-content">
            {{ submission.content|linebreaks }}
          </div>
          {% endif %}
          {% if submission.attachments.all %}
          <div class="submission-attachments">
            {% for attachment in submission.attachments.all %}
            <div class="attachment-card">
              <div class="attachment-card-header">
                <span class="attachment-icon" data-filename="{{ attachment.file.name }}">ğŸ“</span>
                <span class="attachment-name">{{ attachment.file.name }}</span>
              </div>
              <div class="attachment-card-info">
                <span class="attachment-size">
                  {{ attachment.file.size|filesizeformat }}
                </span>
                <a href="{% url 'codemon:download_attachment' attachment.attachment_id %}" class="attachment-download" target="_blank" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">â¬‡ï¸</a>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ“­</div>
          <p style="font-size: 16px; margin-bottom: 8px;">ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p style="font-size: 14px;">æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†</p>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ï¼ˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
  <div class="box-footer {% if is_expired %}form-disabled{% endif %}">
    <div class="form-toggle">
      <button type="button" class="btn-toggle-form" id="toggleFormBtn" aria-expanded="false">
        å…¥åŠ›ã‚’é–‹ã
      </button>
    </div>
    <div class="form-collapsible is-collapsed" id="formCollapsible">
      <form class="submission-form" method="POST" enctype="multipart/form-data" id="submissionForm">
      {% csrf_token %}
      <textarea 
        class="message-input" 
        name="content" 
        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." 
        rows="3"
        required
        id="messageInput"></textarea>
      <div class="form-row">
        <input type="file" id="fileInput" name="attachments" multiple style="display: none;">
        <button type="button" class="btn-attach" onclick="document.getElementById('fileInput').click()">
          ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜
        </button>
        <button type="submit" class="btn-submit" id="submitBtn">æŠ•ç¨¿ã™ã‚‹</button>
      </div>
      <div id="fileList" style="font-size: 13px; color: #6c757d;"></div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const submissionForm = document.getElementById('submissionForm');
  const submissionsList = document.getElementById('submissionsList');
  const toggleFormBtn = document.getElementById('toggleFormBtn');
  const formCollapsible = document.getElementById('formCollapsible');

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
  fileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
      const fileNames = Array.from(this.files).map(f => f.name).join(', ');
      fileList.textContent = `é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: ${fileNames}`;
    } else {
      fileList.textContent = '';
    }
  });

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
  submissionForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'æŠ•ç¨¿ä¸­...';

    const formData = new FormData(this);

    try {
      const response = await fetch(window.location.href, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (response.ok) {
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ–°ã—ã„æŠ•ç¨¿ã‚’è¡¨ç¤º
        window.location.reload();
      } else {
        alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'æŠ•ç¨¿ã™ã‚‹';
    }
  });

  // æŠ•ç¨¿ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼ˆæœ€æ–°ãŒä¸‹ï¼‰
  const list = document.getElementById('submissionsList');
  list.scrollTop = list.scrollHeight;
  
  // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®é–‹é–‰
  if (toggleFormBtn && formCollapsible) {
    toggleFormBtn.addEventListener('click', () => {
      const isCollapsed = formCollapsible.classList.toggle('is-collapsed');
      toggleFormBtn.setAttribute('aria-expanded', (!isCollapsed).toString());
      toggleFormBtn.textContent = isCollapsed ? 'å…¥åŠ›ã‚’é–‹ã' : 'å…¥åŠ›ã‚’é–‰ã˜ã‚‹';
    });
  }
</script>

<script>
// æ¡ç‚¹æ¸ˆã¿ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒˆã‚°ãƒ«
async function toggleGradeCheck(checkbox) {
  const messageId = checkbox.dataset.messageId;
  const isChecked = checkbox.checked;
  
  try {
    const response = await fetch(`/codemon/api/toggle-grading-check/${messageId}/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: `is_checked=${isChecked}`
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      // æˆåŠŸæ™‚ã¯ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ç¶­æŒ
      checkbox.checked = data.is_checked;
    } else {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã«æˆ»ã™
      checkbox.checked = !isChecked;
      alert('ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  } catch (error) {
    console.error('Error:', error);
    checkbox.checked = !isChecked;
    alert('ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³è¨­å®šï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ç”¨ï¼‰
function setFileIcons() {
  document.querySelectorAll('.attachment-icon').forEach(icon => {
    const fileName = icon.getAttribute('data-filename') || '';
    const ext = fileName.split('.').pop().toLowerCase();
    const iconMap = {
      'pdf': 'ğŸ“„', 'xlsx': 'ğŸ“Š', 'xls': 'ğŸ“Š', 'csv': 'ğŸ“Š',
      'docx': 'ğŸ“', 'doc': 'ğŸ“', 'pptx': 'ğŸ¯', 'ppt': 'ğŸ¯',
      'txt': 'ğŸ“‹', 'zip': 'ğŸ—‚ï¸', 'jpg': 'ğŸ–¼ï¸', 'jpeg': 'ğŸ–¼ï¸', 'png': 'ğŸ–¼ï¸', 'gif': 'ğŸ–¼ï¸'
    };
    icon.textContent = iconMap[ext] || 'ğŸ“';
  });
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', setFileIcons);
</script>
{% endblock %}
