{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'codemon/css/file_upload_teacher.css' %}">
<style>
:root {
  --chat-max-width: 800px;
  --chat-max-height: 70vh;
  --chat-border-radius: 12px;
  --chat-box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --chat-position: fixed;
  --chat-position-x: 50px;
  --chat-position-y: 130px;
}

.upload-alert {
  margin: 0 20px 12px;
  padding: 10px 12px;
  border-radius: 6px;
  font-size: 14px;
  display: none;
}

.upload-alert.error {
  display: block;
  background: #fdecea;
  color: #611a15;
  border: 1px solid #f5c6cb;
}

.upload-alert.success {
  display: block;
  background: #e6ffed;
  color: #164d2b;
  border: 1px solid #b3e6c1;
}
</style>
{% endblock %}

{% block content %}
<div class="file-upload-container teacher">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="upload-header">
    <button class="btn-back" onclick="location.href='{% url 'codemon:chat_teacher' %}'">â†</button>
    <h1 class="upload-title">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ•å‡½</h1>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="upload-content">
    <!-- å®›å…ˆé¸æŠ -->
    <div class="recipient-section">
      <h2>å®›å…ˆã‚’é¸æŠ</h2>
      <select id="recipient-select" class="recipient-dropdown">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <!-- å®›å…ˆãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </select>
    </div>

    <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ -->
    <div class="file-selection-section">
      <h2>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</h2>
      <div class="upload-area" id="upload-area">
        <input type="file" id="file-input" class="file-input" multiple>
        <label for="file-input" class="upload-label">
          <span class="upload-icon">ğŸ“</span>
          <span class="upload-text">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>
          <span class="upload-hint">å¯¾å¿œå½¢å¼: PDFã€DOCXã€XLSXã€JPGã€PNGç­‰</span>
        </label>
      </div>

      <!-- é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
      <div class="selected-files-section">
        <h3>é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«</h3>
        <ul id="file-list" class="file-list">
          <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </ul>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› -->
    <div class="message-section">
      <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
      <textarea id="message" class="message-textarea" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <div id="upload-alert" class="upload-alert" role="status" aria-live="polite"></div>
  <div class="upload-footer">
    <button class="btn-cancel" onclick="history.back()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn-upload">æŠ•å‡½ã™ã‚‹</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let selectedFiles = [];
  const currentUserId = {{ request.session.account_user_id|default:"null" }};

  const uploadArea = document.querySelector('#upload-area');
  const fileInput = document.querySelector('#file-input');
  const fileList = document.querySelector('#file-list');
  const recipientSelect = document.querySelector('#recipient-select');
  const uploadAlert = document.querySelector('#upload-alert');

  function showAlert(message, type) {
    if (!uploadAlert) return;
    uploadAlert.textContent = message;
    uploadAlert.className = `upload-alert ${type}`;
  }

  window.alert = (message) => {
    showAlert(message, 'error');
  };

  function applyRecipientFromQuery() {
    const params = new URLSearchParams(window.location.search);
    const groupId = params.get('group_id');
    const groupName = params.get('group_name') || '';
    if (!groupId || !recipientSelect) {
      return;
    }
    recipientSelect.innerHTML = '';
    const option = document.createElement('option');
    option.value = groupId;
    option.textContent = groupName ? `ã‚°ãƒ«ãƒ¼ãƒ—: ${groupName}` : `ã‚°ãƒ«ãƒ¼ãƒ—ID: ${groupId}`;
    recipientSelect.appendChild(option);
    recipientSelect.value = groupId;
    recipientSelect.disabled = true;
  }

  applyRecipientFromQuery();

  function saveAttachmentMessage(groupId, text, attachments) {
    const key = `messages_group_${groupId}`;
    const messages = JSON.parse(localStorage.getItem(key) || '[]');
    const now = new Date();
    const hours = now.getHours();
    const minutes = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes();
    const time = hours + ':' + minutes;
    messages.push({
      id: 'msg_' + now.getTime() + '_' + Math.random().toString(36).substr(2, 9),
      text: text || '',
      sender: 'user',
      senderUserId: currentUserId,
      senderAvatar: null,
      attachments: attachments || [],
      timestamp: now.getTime(),
      time: time
    });
    localStorage.setItem(key, JSON.stringify(messages));
  }

  // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    
    const files = Array.from(e.dataTransfer.files);
    handleFiles(files);
  });

  // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå‡¦ç†
  fileInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    handleFiles(files);
  });

  function handleFiles(files) {
    selectedFiles = [...selectedFiles, ...files];
    updateFileList();
  }

  function updateFileList() {
    fileList.innerHTML = '';
    selectedFiles.forEach((file, index) => {
      const li = document.createElement('li');
      li.className = 'file-item';
      li.innerHTML = `
        <span class="file-name">
          <span class="file-icon">ğŸ“„</span>
          ${file.name}
        </span>
        <span class="file-size">${(file.size / 1024).toFixed(2)} KB</span>
        <button class="btn-remove-file" onclick="removeFile(${index})">Ã—</button>
      `;
      fileList.appendChild(li);
    });
  }

  function removeFile(index) {
    selectedFiles.splice(index, 1);
    updateFileList();
  }

  async function resolveThreadId(groupId) {
    const res = await fetch(`/codemon/chat/group/${groupId}/thread/`);
    if (!res.ok) {
      throw new Error('thread fetch failed');
    }
    const data = await res.json();
    return data.thread_id;
  }

  // æŠ•å‡½å‡¦ç†
  document.querySelector('.btn-upload').addEventListener('click', async () => {
    const recipient = document.querySelector('#recipient-select').value;
    const message = document.querySelector('#message').value;

    if (!recipient) {
      showAlert('å®›å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }

    if (selectedFiles.length === 0) {
      showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }

    console.log('ãƒ•ã‚¡ã‚¤ãƒ«æŠ•å‡½:', {
      recipient: recipient,
      files: selectedFiles.map(f => f.name),
      message: message
    });

    let threadId;
    try {
      threadId = await resolveThreadId(recipient);
    } catch (e) {
      showAlert('å®›å…ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      return;
    }

    // FormDataã‚’ä½œæˆã—ã¦ã€è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    const formData = new FormData();
    formData.append('thread_id', threadId);
    selectedFiles.forEach((file) => {
      formData.append('files', file);
    });

    try {
      console.log('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹:', {
        endpoint: '/codemon/chat/upload_attachment/',
        thread_id: recipient,
        fileCount: selectedFiles.length
      });
      
      const response = await fetch('/codemon/chat/upload_attachment/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      });

      console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);

      if (!response.ok) {
        let errorMessage = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ';
        try {
          const error = await response.json();
          errorMessage = error.error || errorMessage;
          console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        } catch (e) {
          const errorText = await response.text();
          console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', errorText);
          errorMessage = `ã‚¨ãƒ©ãƒ¼ (${response.status}): ${errorText.substring(0, 100)}`;
        }
        showAlert(errorMessage, 'error');
        return;
      }

      const result = await response.json();
      showAlert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒæŠ•å‡½ã•ã‚Œã¾ã—ãŸï¼', 'success');
      
      setTimeout(() => {
        window.location.href = document.referrer || '/codemon/chat/teacher/';
        // referrerãŒãªã‘ã‚Œã°ãƒãƒ£ãƒƒãƒˆç”»é¢ã«æˆ»ã‚‹
      }, 800);
    } catch (error) {
      console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
      showAlert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  });

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
</script>
{% endblock %}
