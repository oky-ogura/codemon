{% extends "base.html" %}
{% load static %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" 
       alt="" 
       class="bg-frame frame-yellow"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'codemon/css/image_upload.css' %}">
<style>
/* ã“ã“ã§ãƒãƒ£ãƒƒãƒˆç”»é¢ã®ã‚µã‚¤ã‚ºã¨ä½ç½®ã‚’ç›´æ¥ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã§ãã¾ã™ */
:root {
  /* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ä¸­å¤®é…ç½®(ã‚«ãƒ¼ãƒ‰é¢¨) */
  --chat-max-width: 800px;
  --chat-max-height: 70vh;
  --chat-margin: 20px auto;
  --chat-border-radius: 12px;
  --chat-box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  --chat-position: fixed;
  --chat-position-x: 50px;
  --chat-position-y: 130px;
  --chat-margin: 0;
  */
}
</style>
{% endblock %}

{% block content %}
<div class="image-upload-container">
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="upload-header">
    <button class="btn-back" onclick="history.back()">â†</button>
    <h1 class="upload-title">ç”»åƒã‚’æŠ•å‡½</h1>
  </div>

  <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="upload-content">
    <!-- å®›å…ˆé¸æŠ -->
    <div class="recipient-section">
      <h2>å®›å…ˆã‚’é¸æŠ</h2>
      <select id="recipient-select" class="recipient-dropdown">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        <!-- å®›å…ˆãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </select>
    </div>

    <!-- ç”»åƒé¸æŠã‚¨ãƒªã‚¢ -->
    <div class="image-selection-section">
      <h2>ç”»åƒã‚’é¸æŠ</h2>
      <div class="upload-area" id="upload-area">
        <input type="file" id="image-input" class="image-input" accept="image/*" multiple>
        <label for="image-input" class="upload-label">
          <span class="upload-icon">ğŸ–¼ï¸</span>
          <span class="upload-text">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</span>
          <span class="upload-hint">å¯¾å¿œå½¢å¼: JPGã€PNGã€GIFç­‰</span>
        </label>
      </div>

      <!-- é¸æŠã•ã‚ŒãŸç”»åƒä¸€è¦§ -->
      <div class="selected-images-section">
        <h3>é¸æŠã•ã‚ŒãŸç”»åƒ</h3>
        <div id="image-preview-grid" class="image-preview-grid">
          <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>

    <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ› -->
    <div class="message-section">
      <h2>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</h2>
      <textarea id="message" class="message-textarea" placeholder="ç”»åƒã«é–¢ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."></textarea>
    </div>
  </div>

  <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
  <div class="upload-footer">
    <button class="btn-cancel" onclick="history.back()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn-upload">æŠ•å‡½ã™ã‚‹</button>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  let selectedImages = [];

  const uploadArea = document.querySelector('#upload-area');
  const imageInput = document.querySelector('#image-input');
  const previewGrid = document.querySelector('#image-preview-grid');

  // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
    handleImages(files);
  });

  // ç”»åƒé¸æŠå‡¦ç†
  imageInput.addEventListener('change', (e) => {
    const files = Array.from(e.target.files);
    handleImages(files);
  });

  function handleImages(files) {
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        selectedImages.push({
          file: file,
          data: event.target.result
        });
        updatePreviewGrid();
      };
      reader.readAsDataURL(file);
    });
  }

  function updatePreviewGrid() {
    previewGrid.innerHTML = '';
    selectedImages.forEach((image, index) => {
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <img src="${image.data}" alt="Preview ${index}">
        <button class="btn-remove-image" onclick="removeImage(${index})">Ã—</button>
      `;
      previewGrid.appendChild(div);
    });
  }

  function removeImage(index) {
    selectedImages.splice(index, 1);
    updatePreviewGrid();
  }

  // æŠ•å‡½å‡¦ç†
  document.querySelector('.btn-upload').addEventListener('click', () => {
    const recipient = document.querySelector('#recipient-select').value;
    const message = document.querySelector('#message').value;

    if (!recipient) {
      alert('å®›å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (selectedImages.length === 0) {
      alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    console.log('ç”»åƒæŠ•å‡½:', {
      recipient: recipient,
      images: selectedImages.map(img => img.file.name),
      message: message
    });

    alert('ç”»åƒãŒæŠ•å‡½ã•ã‚Œã¾ã—ãŸï¼');
    history.back();
  });
</script>
{% endblock %}
