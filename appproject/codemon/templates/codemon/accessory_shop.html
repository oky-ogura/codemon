{% extends 'base.html' %}
{% load static %}
{% load accessory_filters %}

{% block title %}„Ç¢„ÇØ„Çª„Çµ„É™„Éº„Ç∑„Éß„ÉÉ„Éó - Codemon{% endblock %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_yellow.png' %}" alt="" class="bg-frame frame-yellow">
{% endblock %}

{% block extra_css %}
<style>
  /* --- ÂÖ®‰Ωì„É¨„Ç§„Ç¢„Ç¶„Éà --- */
  body {
    background-color: #fef9e7;
    overflow-x: hidden;
  }

  .shop-wrapper {
    max-width: 1100px;
    margin: 110px auto 50px;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    gap: 25px;
    position: relative;
    z-index: 10;
  }

  /* --- üåü „Éñ„É©„ÉÉ„Ç∑„É•„Ç¢„ÉÉ„Éó„Åó„Åü„Çπ„ÉÜ„Éº„Çø„Çπ„Éê„Éº --- */
  .shop-status-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    padding: 10px;
  }

  /* Â∑¶Ôºö„Ç∑„É≥„Éó„É´„Å™„Çø„Ç§„Éà„É´ÁúãÊùø */
  .shop-sign {
    background: white;
    padding: 12px 30px;
    border-radius: 25px;
    border: 5px solid #FFD700;
    box-shadow: 0 6px 0 #FFB900;
  }
  .shop-sign h1 {
    font-size: 26px;
    font-weight: 900;
    color: #FFA500;
    margin: 0;
    letter-spacing: 2px;
  }

  /* ‰∏≠Â§ÆÔºö‰ªä„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÁîªÂÉè„ÇíÂ§ß„Åç„Åè„É°„Ç§„É≥„Å´Ôºâ */
  .style-fitting-room {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    background: #ffffff;
    padding: 15px 30px;
    border-radius: 30px;
    border: 5px solid #3fbcd9;
    box-shadow: 0 8px 0 rgba(63, 188, 217, 0.2);
    min-width: 160px;
    position: relative;
  }

  .style-label {
    font-size: 13px;
    font-weight: 900;
    color: white;
    background: #3fbcd9;
    padding: 2px 15px;
    border-radius: 50px;
    position: absolute;
    top: -12px;
  }

  .main-preview-circle {
    width: 85px; /* ÁîªÂÉè„ÇíÂ§ß„Åç„ÅèË°®Á§∫ */
    height: 85px;
    background: #fdfcf0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 3px solid #eee;
    margin-top: 5px;
    overflow: visible;
  }

  .main-preview-circle img {
    width: 70px; /* „Ç¢„ÇØ„Çª„Çµ„É™„ÉºÁîªÂÉè„Çí‰∏ªÂΩπ„Å´ */
    height: auto;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
  }

  .btn-remove-acc {
    background: #ff7675;
    color: white;
    border: none;
    padding: 4px 12px;
    border-radius: 50px;
    font-size: 11px;
    font-weight: 900;
    cursor: pointer;
    margin-top: 5px;
    box-shadow: 0 3px 0 #e55a5a;
    transition: 0.2s;
  }
  .btn-remove-acc:hover { transform: scale(1.1); background: #ff4d4d; }

  /* Âè≥Ôºö„Ç≥„Ç§„É≥„Éù„Ç±„ÉÉ„ÉàÔºàÂçò‰Ωç„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíÊòéÁ§∫Ôºâ */
  .coin-pocket {
    background: white;
    padding: 12px 25px;
    border-radius: 25px;
    border: 5px solid #FFA500;
    display: flex;
    flex-direction: column;
    align-items: center;
    box-shadow: 0 6px 0 #e67e22;
  }
  
  .coin-label {
    font-size: 12px;
    font-weight: 900;
    color: #e67e22;
    margin-bottom: 2px;
  }

  .coin-value {
    color: #FFA500;
    font-size: 24px;
    font-weight: 900;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .coin-value i { font-size: 22px; }

  /* --- „Ç´„ÉÜ„Ç¥„É™„Éº„Çø„Éñ --- */
  .shop-nav {
    display: flex; gap: 12px; overflow-x: auto; padding: 10px 5px; scrollbar-width: none;
  }
  .shop-nav::-webkit-scrollbar { display: none; }

  .nav-tab {
    padding: 12px 28px; background: white; border-radius: 50px; font-weight: 900;
    cursor: pointer; border: 3px solid #eee; color: #888;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    white-space: nowrap; box-shadow: 0 4px 0 #eee;
  }
  .nav-tab:hover { transform: translateY(-3px); border-color: #3fbcd9; color: #3fbcd9; }
  .nav-tab.active { background: #3fbcd9; color: white; border-color: #3fbcd9; box-shadow: 0 5px 0 #2a8da4; transform: translateY(-2px); }
  .nav-tab:active { transform: translateY(2px); box-shadow: none !important; }

  /* --- ÂïÜÂìÅ„Ç´„Éº„Éâ --- */
  .accessory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 25px; }

  .accessory-card {
    background: white; border-radius: 40px; padding: 25px; border: 5px solid #f1f5f9;
    text-align: center; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.05);
  }
  .accessory-card:hover { transform: translateY(-10px) scale(1.02); border-color: #3fbcd9; box-shadow: 0 20px 40px rgba(63, 188, 217, 0.15); }

  .item-preview-circle {
    width: 110px; height: 110px; background: #fdfcf0; border-radius: 50%;
    margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
    border: 3px solid #fff; box-shadow: inset 0 5px 10px rgba(0,0,0,0.03);
  }

  .accessory-name { font-size: 18px; font-weight: 900; color: #333; margin-bottom: 8px; }
  .accessory-price { font-size: 16px; font-weight: 900; color: #FFA500; margin-bottom: 15px; display: block; }

  .btn-action { width: 100%; padding: 12px 0; border-radius: 50px; font-weight: 900; border: none; cursor: pointer; transition: 0.2s; }
  .btn-buy { background: #FFD200; color: #634A00; box-shadow: 0 5px 0 #d4af00; }
  .btn-equip { background: #4cd97b; color: white; box-shadow: 0 5px 0 #39a65d; }
  .btn-equipped { background: #3fbcd9; color: white; cursor: default; }
  .btn-action:active { transform: translateY(3px); box-shadow: none; }

  .category-hidden { display: none; }
</style>
{% endblock %}

{% block content %}
<div class="shop-wrapper">

  <div class="shop-status-bar">
    <div class="shop-sign">
      <h1>„Ç∑„Éß„ÉÉ„Éó</h1>
    </div>

    <div class="style-fitting-room">
      <span class="style-label">‰ªä„ÅÆ„Çπ„Çø„Ç§„É´</span>
      <div class="main-preview-circle">
        {% if equipped_accessory %}
          <img src="{% static equipped_accessory.accessory.image_path %}" alt="Ë£ÖÂÇô‰∏≠">
        {% else %}
          <span style="font-size: 14px; color: #ccc; font-weight: 800;">„Å™„Åó</span>
        {% endif %}
      </div>
      
      {% if equipped_accessory %}
        <form method="post" action="{% url 'codemon:unequip_accessory' %}">
          {% csrf_token %}
          <button type="submit" class="btn-remove-acc">Ë£ÖÂÇô„ÇíÂ§ñ„Åô</button>
        </form>
      {% endif %}
    </div>

    <div class="coin-pocket">
      <span class="coin-label">„ÇÇ„Å£„Å¶„Çã„ÅäÈáë</span>
      <div class="coin-value">
        <i class="fas fa-coins"></i>
        <span>{{ user_coin.balance }}</span>
        <span style="font-size: 14px;">„Ç≥„Ç§„É≥</span>
      </div>
    </div>
  </div>

  <nav class="shop-nav">
    <button class="nav-tab active" onclick="filterCategory('all')">„Åú„Çì„Å∂</button>
    {% regroup accessories by accessory.get_category_display as category_list %}
    {% for category in category_list %}
      <button class="nav-tab" onclick="filterCategory('{{ category.grouper }}')">{{ category.grouper }}</button>
    {% endfor %}
  </nav>

  <div class="accessory-grid" id="accessoryGrid">
    {% for item in accessories %}
      <div class="accessory-card" data-category="{{ item.accessory.get_category_display }}">
        {% if item.is_owned %}
          <span style="position: absolute; top: 15px; right: 15px; background: #4cd97b; color: white; padding: 4px 12px; border-radius: 50px; font-size: 11px; font-weight: 900;">ÊåÅ„Å£„Å¶„Çã</span>
        {% endif %}

        <div class="item-preview-circle">
           <img src="{% static item.accessory.image_path %}" style="width: 75px;">
        </div>

        <h3 class="accessory-name">{{ item.accessory.name }}</h3>
        
        {% if not item.is_owned %}
          <span class="accessory-price">üí∞ {{ item.accessory.unlock_coins }} „Ç≥„Ç§„É≥</span>
        {% else %}
          <span class="accessory-price" style="color: #4cd97b;">GETÊ∏à„Åø!</span>
        {% endif %}

        <div class="accessory-action">
          {% if item.is_equipped %}
            <button class="btn-action btn-equipped" disabled>Ë£ÖÂÇô‰∏≠</button>
          {% elif item.is_owned %}
            <form method="post" action="{% url 'codemon:equip_accessory' item.accessory.accessory_id %}">
              {% csrf_token %}
              <button type="submit" class="btn-action btn-equip">Ë£ÖÂÇô„Åô„Çã</button>
            </form>
          {% elif item.can_unlock %}
            <form method="post" action="{% url 'codemon:purchase_accessory' item.accessory.accessory_id %}">
              {% csrf_token %}
              <button type="submit" class="btn-action btn-buy">Ë≥ºÂÖ•„Åô„Çã</button>
            </form>
          {% else %}
            <button class="btn-action" style="background: #ccc; color: #fff; cursor: not-allowed;" disabled>
              üîí „É©„É≥„ÇØ‰∏çË∂≥
            </button>
          {% endif %}
        </div>
      </div>
    {% endfor %}
  </div>

  <a href="{% url 'accounts:karihome' %}" style="align-self: center; margin-top: 20px; background: white; color: #888; padding: 12px 40px; border-radius: 50px; text-decoration: none; font-weight: 900; box-shadow: 0 5px 0 #ddd; transition: 0.2s;">‚Üê „ÅäÂ∫ó„ÇíÂá∫„Çã</a>

</div>

<script>
  function filterCategory(category) {
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.classList.remove('active');
      if (tab.innerText === category || (category === 'all' && tab.innerText === '„Åú„Çì„Å∂')) {
        tab.classList.add('active');
      }
    });

    const cards = document.querySelectorAll('.accessory-card');
    cards.forEach(card => {
      if (category === 'all' || card.dataset.category === category) {
        card.classList.remove('category-hidden');
      } else {
        card.classList.add('category-hidden');
      }
    });
  }
</script>
{% endblock %}