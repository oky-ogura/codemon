{% extends 'base.html' %}
{% load static %}

{% block title %}ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ã¤ãã‚‹ - Codemon{% endblock %}
{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.content-wrapper { padding-top: 80px !important; }

.create-container {
    max-width: 800px;
    width: 92vw;
    margin: 0 auto 40px;
    padding: 30px;
    background-color: rgba(255, 255, 255, 0.98);
    border-radius: 40px;
    border: 8px solid #ffffff;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 20;
}

/* --- ã‚·ã‚¹ãƒ†ãƒ è£½ã‚¿ã‚¤ãƒˆãƒ« --- */
.page-title {
    text-align: center;
    margin-bottom: 30px;
}
.page-title h1 {
    font-size: 32px;
    font-weight: 900;
    color: #3fbcd9;
    text-shadow: 2px 2px 0 #fff, 4px 4px 0 rgba(63, 188, 217, 0.2);
    margin: 0;
}
.page-title p {
    color: #718096;
    font-weight: 800;
    margin-top: 5px;
    font-size: 14px;
}

/* --- ãƒ•ã‚©ãƒ¼ãƒ ã‚¹ã‚¿ã‚¤ãƒ« --- */
.form-section {
    margin-bottom: 25px;
}
.section-label {
    display: block;
    font-size: 16px;
    font-weight: 900;
    color: #2d3748;
    margin-bottom: 10px;
    padding-left: 10px;
    border-left: 5px solid #3fbcd9;
}

.input-main {
    width: 100%;
    padding: 15px 20px;
    border-radius: 15px;
    border: 3px solid #edf2f7;
    background: #f8fafc;
    font-size: 16px;
    font-weight: 700;
    transition: all 0.2s;
    box-sizing: border-box;
}
.input-main:focus {
    outline: none;
    border-color: #3fbcd9;
    background: white;
    box-shadow: 0 0 0 4px rgba(63, 188, 217, 0.1);
}

/* --- å‹•çš„ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ã‚¨ãƒªã‚¢ --- */
.item-list-container {
    background: #f1f5f9;
    padding: 20px;
    border-radius: 20px;
}
.checklist-item-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    animation: slideIn 0.3s ease-out;
}
@keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.item-number {
    width: 30px;
    height: 30px;
    background: #3fbcd9;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 14px;
    flex-shrink: 0;
}

.btn-remove {
    background: #ff7675;
    color: white;
    border: none;
    width: 35px;
    height: 35px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 900;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
}
.btn-remove:hover { background: #ff4d4d; transform: scale(1.1); }

.btn-add-item {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    background: white;
    color: #3fbcd9;
    border: 3px dashed #3fbcd9;
    border-radius: 15px;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.2s;
}
.btn-add-item:hover {
    background: #e6f7ff;
    transform: translateY(-2px);
}

/* --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆæˆ»ã‚‹ãƒ»ä½œæˆï¼‰ --- */
.form-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 3px dashed #edf2f7;
}

.btn-pop {
    padding: 15px 40px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 900;
    font-size: 18px;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}
.btn-pop:hover { transform: translateY(-5px) scale(1.03); }
.btn-pop:active { transform: translateY(2px); }

.btn-back {
    background: #cbd5e0;
    color: #4a5568;
    box-shadow: 0 6px 0 #a0aec0;
}
.btn-create-submit {
    background: #FFD200;
    color: #333;
    box-shadow: 0 6px 0 #d9b300;
}

textarea.input-main {
    resize: none;
    min-height: 100px;
}
</style>
{% endblock %}

{% block content %}
<div class="create-container">
    <div class="page-title">
        <h1>ğŸ“ ã‚ãŸã‚‰ã—ã„ãƒªã‚¹ãƒˆã‚’ã¤ãã‚ã†</h1>
        <p>ã‚„ã‚‹ã“ã¨ã‚’ãã‚ã¦ã€ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ã‹ã‚“ã›ã„ã•ã›ã‚ˆã†ï¼</p>
    </div>

    <form method="post" id="checklist-form">
        {% csrf_token %}

        <div class="form-section">
            <label class="section-label" for="checklist_name">ãƒªã‚¹ãƒˆã®åå‰</label>
            <input type="text" name="name" id="checklist_name" class="input-main" 
                   placeholder="ä¾‹ï¼šã‚ã•ã®ã˜ã‚…ã‚“ã³ã€ã—ã‚…ãã ã„ã‚»ãƒƒãƒˆ" required>
        </div>

        <div class="form-section">
            <label class="section-label" for="description">ã©ã‚“ãªãƒªã‚¹ãƒˆï¼Ÿï¼ˆã›ã¤ã‚ã„ï¼‰</label>
            <textarea name="description" id="description" class="input-main" 
                      placeholder="ã“ã®ãƒªã‚¹ãƒˆã‚’ä½•ã«ã¤ã‹ã†ã‹æ›¸ã„ã¦ã¿ã‚ˆã†ï¼"></textarea>
        </div>

        <div class="form-section">
            <label class="section-label" for="due_date">ğŸ—“ï¸ ã„ã¤ã¾ã§ã«ã‚„ã‚‹ï¼Ÿï¼ˆæœŸé™ï¼‰</label>
            <input type="date" name="due_date" id="due_date" class="input-main">
            <p style="font-size: 12px; color: #718096; margin-top: 5px; padding-left: 10px;">
                â€»æœŸé™ã‚’æ±ºã‚ã‚‹ã¨ã€ãƒ›ãƒ¼ãƒ ç”»é¢ã«ã€Œã‚ã¨ã€‡æ—¥ï¼ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆ
            </p>
        </div>

        <div class="form-section">
            <label class="section-label">ã‚„ã‚‹å†…å®¹ï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ï¼‰</label>
            <div id="items-container" class="item-list-container">
                <div class="checklist-item-row">
                    <div class="item-number">1</div>
                    <input type="text" name="items[]" class="input-main" placeholder="ä¾‹ï¼šæ•™ç§‘æ›¸ã‚’ã‹ã°ã‚“ã«å…¥ã‚Œã‚‹" required>
                    <button type="button" class="btn-remove" onclick="removeItem(this)">Ã—</button>
                </div>
            </div>
            <button type="button" class="btn-add-item" onclick="addItem()">
                ï¼‹ é …ç›®ã‚’ãµã‚„ã™
            </button>
        </div>

        <div class="form-actions">
            <a href="{% url 'codemon:checklist_selection' %}" class="btn-pop btn-back">
                ã‚‚ã©ã‚‹
            </a>
            <button type="submit" class="btn-pop btn-create-submit">
                ãƒªã‚¹ãƒˆã‚’ã¤ãã‚‹ï¼
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®åæ˜ ï¼ˆæœ€åˆã«å®Ÿè¡Œï¼‰
document.addEventListener('DOMContentLoaded', function() {
    const editingName = "{{ editing_name|escapejs }}";
    const editingDesc = "{{ editing_description|escapejs }}";
    const editingDueDate = "{{ editing_due_date|escapejs }}";
    const editingItemsJson = '{{ editing_items_json|escapejs }}';
    
    console.log('Editing name:', editingName);
    console.log('Editing desc:', editingDesc);
    console.log('Editing due date:', editingDueDate);
    console.log('Editing items JSON:', editingItemsJson);
    
    // JSONã‚’ãƒ‘ãƒ¼ã‚¹
    let editingItems = [];
    if (editingItemsJson) {
        try {
            editingItems = JSON.parse(editingItemsJson);
            console.log('Parsed items:', editingItems);
        } catch (e) {
            console.error('Failed to parse editing items:', e);
        }
    }
    
    if (editingName) {
        document.getElementById('checklist_name').value = editingName;
    }
    
    if (editingDesc) {
        document.getElementById('description').value = editingDesc;
    }
    
    if (editingDueDate) {
        document.getElementById('due_date').value = editingDueDate;
    }
    
    if (editingItems && editingItems.length > 0) {
        const container = document.getElementById('items-container');
        container.innerHTML = '';
        
        editingItems.forEach((item, index) => {
            const newRow = document.createElement('div');
            newRow.className = 'checklist-item-row';
            newRow.innerHTML = `
                <div class="item-number">${index + 1}</div>
                <input type="text" name="items[]" class="input-main" value="${item.item_text.replace(/"/g, '&quot;')}" required>
                <button type="button" class="btn-remove" onclick="removeItem(this)">Ã—</button>
            `;
            container.appendChild(newRow);
        });
    }
});

function addItem() {
    const container = document.getElementById('items-container');
    const rowCount = container.getElementsByClassName('checklist-item-row').length;
    
    if (rowCount >= 20) {
        alert("é …ç›®ã¯20å€‹ã¾ã§ã ã‚ˆ!");
        return;
    }

    const newRow = document.createElement('div');
    newRow.className = 'checklist-item-row';
    newRow.innerHTML = `
        <div class="item-number">${rowCount + 1}</div>
        <input type="text" name="items[]" class="input-main" placeholder="æ¬¡ã®ã‚„ã‚‹ã“ã¨ã‚’æ›¸ã“ã†" required>
        <button type="button" class="btn-remove" onclick="removeItem(this)">Ã—</button>
    `;
    container.appendChild(newRow);
    newRow.querySelector('input').focus();
}

function removeItem(button) {
    const container = document.getElementById('items-container');
    const rows = container.getElementsByClassName('checklist-item-row');
    
    if (rows.length > 1) {
        button.parentElement.remove();
        reorderNumbers();
    } else {
        alert("é …ç›®ã¯1ã¤ä»¥ä¸Šä½œã£ã¦ã­!");
    }
}

function reorderNumbers() {
    const numbers = document.querySelectorAll('.item-number');
    numbers.forEach((num, index) => {
        num.innerText = index + 1;
    });
}

document.getElementById('checklist-form').onsubmit = function() {
    const submitBtn = this.querySelector('.btn-create-submit');
    submitBtn.innerText = "ã•ãã›ã„ä¸­...";
    submitBtn.style.opacity = "0.7";
    submitBtn.style.pointerEvents = "none";
    return true;
};
</script>
{% endblock %}
