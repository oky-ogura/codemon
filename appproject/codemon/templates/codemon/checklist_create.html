{% extends 'base.html' %}
{% load static %}

{% block title %}チェックリストをつくる - Codemon{% endblock %}
{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root {
    --bg-main: #f0f4f8;
    --panel-bg: rgba(255, 255, 255, 0.95);
    --accent-main: #3fbcd9;    /* シアン */
    --btn-pop: #FFD200;       /* イエロー */
    --btn-shadow: #e6bd00;
    --btn-cyan-shadow: #2c8a9e;
    --error-pop: #ff7675;     /* ピンク */
    --text-dark: #2d3748;
    --input-bg: #f8fafc;
  }

  body {
    background-color: var(--bg-main);
    font-family: "M PLUS Rounded 1c", sans-serif;
    height: 100vh !important;
    overflow: hidden !important;
  }

  .content-wrapper {
    overflow: hidden !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    min-height: 100vh !important;
    padding: 0 !important;
  }

  /* メインエリア */
  main {
    width: 100%;
    max-width: 1200px; 
    margin: 0 auto;
    padding: 20px;
    box-sizing: border-box;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* 作成パネル */
  .create-panel {
    background: var(--panel-bg);
    border: 6px solid var(--accent-main);
    border-radius: 30px;
    padding: 30px;
    width: 100%;
    height: 100%;
    box-shadow: 0 15px 0 rgba(63, 188, 217, 0.2), 0 10px 30px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden; 
  }

  /* ヘッダーエリア */
  .panel-header {
    text-align: center;
    border-bottom: 3px dashed #e2e8f0;
    padding-bottom: 10px;
    margin-bottom: 15px;
    flex-shrink: 0;
  }
  
  .panel-title {
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-main);
    margin: 0;
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  /* フォーム全体（左右分割） */
  .panel-body {
    display: flex;
    gap: 30px;
    flex: 1; /* 残りの高さを埋める */
    overflow: hidden;
    flex-direction: column; 
  }

  @media (min-width: 801px) {
    .panel-body {
      flex-direction: row; /* PCでは横並び */
    }
  }

  /* --- 左カラム（基本情報＋ボタン） --- */
  .left-column {
    flex: 0 0 350px; /* 幅固定 */
    display: flex;
    flex-direction: column;
    gap: 15px;
    overflow-y: auto; /* 必要ならスクロール */
    padding-right: 5px;
  }

  /* --- 右カラム（チェック項目リスト） --- */
  .right-column {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    background: #e0f7fa; /* エリア背景 */
    border-radius: 20px;
    padding: 20px;
    border: 3px dashed #b2ebf2;
  }

  .right-title {
    font-size: 16px;
    font-weight: 800;
    color: var(--accent-main);
    margin-bottom: 10px;
    text-align: center;
  }

  /* フォームグループ */
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-label {
    font-size: 14px;
    font-weight: 800;
    color: var(--text-dark);
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .form-label i { color: var(--accent-main); font-size: 16px; }

  /* 入力フィールド */
  .input-field {
    padding: 10px 15px;
    border-radius: 12px;
    border: 3px solid #cbd5e0;
    background: var(--input-bg);
    font-size: 15px;
    font-weight: 700;
    width: 100%;
    box-sizing: border-box;
    outline: none;
    transition: all 0.2s;
  }
  .input-field:focus { border-color: var(--accent-main); background: #fff; }
  
  textarea.input-field { resize: none; height: 80px; }

  /* --- 項目リストエリア --- */
  .item-list-container {
    flex: 1;
    overflow-y: auto;
    padding-right: 5px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  /* リスト項目のアニメーション */
  .checklist-item-row {
    display: flex;
    align-items: center;
    gap: 10px;
    animation: slideIn 0.3s ease-out;
    background: white;
    padding: 8px;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateX(20px); }
    to { opacity: 1; transform: translateX(0); }
  }

  .item-number {
    width: 28px; height: 28px;
    background: var(--accent-main);
    color: white;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 12px;
    flex-shrink: 0;
  }

  .btn-remove {
    background: var(--error-pop);
    color: white; border: none;
    width: 32px; height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 900;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
  }
  .btn-remove:hover { transform: scale(1.1); background: #ff4d4d; }

  /* 項目追加ボタン */
  .btn-add-item {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    background: white;
    color: var(--accent-main);
    border: 3px dashed var(--accent-main);
    border-radius: 15px;
    font-weight: 900;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 15px;
  }
  .btn-add-item:hover { background: #e0f7fa; transform: translateY(-2px); }

  /* --- アクションボタンエリア --- */
  .action-area {
    margin-top: auto;
    display: flex;
    gap: 15px;
    padding-top: 15px;
    border-top: 3px dashed #e2e8f0;
  }

  .action-btn {
    border: none;
    padding: 12px;
    border-radius: 50px;
    font-weight: 800;
    font-size: 15px;
    cursor: pointer;
    flex: 1;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    text-decoration: none;
  }

  .btn-save { background: var(--btn-pop); color: #5d4037; box-shadow: 0 4px 0 var(--btn-shadow); }
  .btn-save:hover { transform: translateY(2px); box-shadow: 0 2px 0 var(--btn-shadow); background: #ffe033; }
  .btn-save:active { transform: translateY(4px); box-shadow: none; }

  .btn-cancel { background: #fff; color: var(--text-dark); border: 2px solid #e2e8f0; box-shadow: 0 4px 0 #cbd5e0; }
  .btn-cancel:hover { transform: translateY(2px); box-shadow: 0 2px 0 #cbd5e0; background: #f7fafc; }
  .btn-cancel:active { transform: translateY(4px); box-shadow: none; }

  /* ヒントテキスト */
  .hint-text {
    font-size: 11px; color: #718096; margin-left: 5px;
  }

  /* スクロールバー装飾 */
  .item-list-container::-webkit-scrollbar { width: 8px; }
  .item-list-container::-webkit-scrollbar-track { background: transparent; }
  .item-list-container::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }

  /* スマホ対応 */
  @media (max-width: 800px) {
    body, main { height: auto; overflow: auto; }
    main { display: block; padding: 100px 20px 40px 20px; }
    .create-panel { height: auto; padding: 20px; }
    .panel-body { flex-direction: column; gap: 20px; }
    .left-column { flex: none; width: 100%; overflow: visible; }
    .right-column { flex: none; height: 400px; }
    .action-area { margin-top: 20px; }
  }

</style>
{% endblock %}

{% block content %}
<main>
  
  <form method="post" id="checklist-form" class="create-panel">
    {% csrf_token %}
    
    <div class="panel-header">
      <h1 class="panel-title">
        <i class="fas fa-tasks"></i> チェックリストをつくろう
      </h1>
    </div>

    <div class="panel-body">
      
      <div class="left-column">
        
        <div class="form-group">
          <label class="form-label" for="checklist_name">
            <i class="fas fa-tag"></i> リストのなまえ
          </label>
          <input type="text" name="name" id="checklist_name" class="input-field" 
                 placeholder="例：あさのじゅんび" required>
        </div>

        <div class="form-group">
          <label class="form-label" for="description">
            <i class="fas fa-align-left"></i> どんなリスト？
          </label>
          <textarea name="description" id="description" class="input-field" 
                    placeholder="このリストをなににつかう？"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label" for="due_date">
            <i class="far fa-calendar-alt"></i> いつまでにやる？
          </label>
          <input type="date" name="due_date" id="due_date" class="input-field">
          <div class="hint-text">※きげんを きめると ホームに ひょうじされるよ</div>
        </div>

        <div class="action-area">
          <button type="submit" class="action-btn btn-save btn-create-submit">
            <i class="fas fa-check-circle"></i> リストをつくる！
          </button>
          
          <a href="{% url 'codemon:checklist_selection' %}" class="action-btn btn-cancel">
            <i class="fas fa-reply"></i> もどる
          </a>
        </div>

      </div>

      <div class="right-column">
        <div class="right-title">
          <i class="fas fa-list-ul"></i> やることを かいていこう！
        </div>

        <div id="items-container" class="item-list-container">
          <div class="checklist-item-row">
            <div class="item-number">1</div>
            <input type="text" name="items[]" class="input-field" placeholder="例：きょうかしょを いれる" required>
            <button type="button" class="btn-remove" onclick="removeItem(this)">×</button>
          </div>
        </div>

        <button type="button" class="btn-add-item" onclick="addItem()">
          <i class="fas fa-plus"></i> こうもくを ふやす
        </button>
      </div>

    </div>

  </form>

</main>

<script>
// 編集データの反映
document.addEventListener('DOMContentLoaded', function() {
    const editingName = "{{ editing_name|escapejs }}";
    const editingDesc = "{{ editing_description|escapejs }}";
    const editingDueDate = "{{ editing_due_date|escapejs }}";
    const editingItemsJson = '{{ editing_items_json|escapejs }}';
    
    // JSONをパース
    let editingItems = [];
    if (editingItemsJson) {
        try {
            editingItems = JSON.parse(editingItemsJson);
        } catch (e) {
            console.error('Failed to parse editing items:', e);
        }
    }
    
    if (editingName) document.getElementById('checklist_name').value = editingName;
    if (editingDesc) document.getElementById('description').value = editingDesc;
    if (editingDueDate) document.getElementById('due_date').value = editingDueDate;
    
    if (editingItems && editingItems.length > 0) {
        const container = document.getElementById('items-container');
        container.innerHTML = '';
        
        editingItems.forEach((item, index) => {
            const newRow = document.createElement('div');
            newRow.className = 'checklist-item-row';
            newRow.innerHTML = `
                <div class="item-number">${index + 1}</div>
                <input type="text" name="items[]" class="input-field" value="${item.item_text.replace(/"/g, '&quot;')}" required>
                <button type="button" class="btn-remove" onclick="removeItem(this)">×</button>
            `;
            container.appendChild(newRow);
        });
    }
});

function addItem() {
    const container = document.getElementById('items-container');
    const rowCount = container.getElementsByClassName('checklist-item-row').length;
    
    if (rowCount >= 20) {
        alert("項目は20個までだよ!");
        return;
    }

    const newRow = document.createElement('div');
    newRow.className = 'checklist-item-row';
    newRow.innerHTML = `
        <div class="item-number">${rowCount + 1}</div>
        <input type="text" name="items[]" class="input-field" placeholder="つぎの やることを かこう" required>
        <button type="button" class="btn-remove" onclick="removeItem(this)">×</button>
    `;
    container.appendChild(newRow);
    newRow.querySelector('input').focus();
    
    // スクロールを一番下に
    container.scrollTop = container.scrollHeight;
}

function removeItem(button) {
    const container = document.getElementById('items-container');
    const rows = container.getElementsByClassName('checklist-item-row');
    
    if (rows.length > 1) {
        button.parentElement.remove();
        reorderNumbers();
    } else {
        alert("項目は1つ以上作ってね!");
    }
}

function reorderNumbers() {
    const numbers = document.querySelectorAll('.item-number');
    numbers.forEach((num, index) => {
        num.innerText = index + 1;
    });
}

document.getElementById('checklist-form').onsubmit = function() {
    const submitBtn = this.querySelector('.btn-create-submit');
    submitBtn.innerText = "さくせい中...";
    submitBtn.style.opacity = "0.7";
    submitBtn.style.pointerEvents = "none";
    return true;
};
</script>
{% endblock %}