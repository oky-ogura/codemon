{% extends 'base.html' %}
{% load static %}

{% block title %}ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè©³ç´° - Codemon{% endblock %}
{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
     alt="" 
     class="bg-frame frame-green"
     onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.content-wrapper { padding-top: 100px !important; }

.detail-container {
    max-width: 800px;
    width: 92vw;
    margin: 0 auto 40px;
    padding: 30px;
    background-color: rgba(255, 255, 255, 0.98);
    border-radius: 40px;
    border: 8px solid #ffffff;
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 20;
    display: flex;
    flex-direction: column;
    max-height: 85vh; /* ç”»é¢ã‹ã‚‰ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã« */
}

/* --- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆåå‰ãƒ»æ—¥ä»˜ãƒ»èª¬æ˜ï¼‰ --- */
.detail-header {
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 3px dashed #edf2f7;
    position: relative;
}

.created-badge {
    position: absolute;
    top: -10px;
    right: 0;
    background: #e2e8f0;
    color: #718096;
    padding: 4px 12px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 800;
}

.checklist-title {
    font-size: 28px;
    font-weight: 900;
    color: #3fbcd9;
    margin: 0 0 10px 0;
    line-height: 1.2;
}

.checklist-desc {
    font-size: 15px;
    color: #4a5568;
    background: #f8fafc;
    padding: 12px 18px;
    border-radius: 15px;
    line-height: 1.5;
    font-weight: 600;
}

/* --- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰ --- */
.checklist-scroll-area {
    overflow-y: auto;
    flex-grow: 1;
    padding-right: 10px;
    margin-bottom: 20px;
}

.item-card {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 3px solid #f1f5f9;
    border-radius: 20px;
    padding: 15px 20px;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
}

.item-card:hover {
    border-color: #3fbcd9;
    background: #f0f9ff;
    transform: translateX(5px);
}

.item-card.is-done {
    background: #f1f5f9;
    border-color: transparent;
}

/* ã‚«ã‚¹ã‚¿ãƒ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.checkbox-wrapper {
    margin-right: 15px;
}

.custom-checkbox {
    width: 32px;
    height: 32px;
    border: 4px solid #3fbcd9;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    background: white;
}

input[type="checkbox"] { display: none; }

input[type="checkbox"]:checked + .custom-checkbox {
    background: #3fbcd9;
    border-color: #3fbcd9;
}

input[type="checkbox"]:checked + .custom-checkbox::after {
    content: "âœ“";
    color: white;
    font-size: 20px;
    font-weight: 900;
}

.item-text {
    font-size: 18px;
    font-weight: 800;
    color: #2d3748;
    transition: all 0.2s;
}

input[type="checkbox"]:checked ~ .item-text {
    text-decoration: line-through;
    color: #a0aec0;
}

/* --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ --- */
.detail-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
}

.btn-pop {
    padding: 12px 25px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 900;
    font-size: 15px;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-pop:hover { transform: translateY(-4px) scale(1.05); }
.btn-pop:active { transform: translateY(2px); }

.btn-back { background: #cbd5e0; color: #4a5568; box-shadow: 0 4px 0 #a0aec0; }
.btn-edit { background: #FFD200; color: #333; box-shadow: 0 4px 0 #d9b300; }
.btn-delete { background: #ff7675; color: white; box-shadow: 0 4px 0 #e55a5a; }

/* ã‚¹ãƒãƒ›å¯¾å¿œ */
@media (max-width: 600px) {
    .checklist-title { font-size: 22px; }
    .btn-pop { padding: 10px 20px; font-size: 14px; flex: 1; justify-content: center; }
}

/* è©³ç´°ç”»é¢ã‹ã‚‰ç§»æ¤ã—ãŸã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.item-card {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 3px solid #f1f5f9;
    border-radius: 20px;
    padding: 12px 18px;
    margin-bottom: 10px;
    transition: all 0.2s;
    cursor: pointer;
}
.item-card:hover { border-color: #3fbcd9; background: #f0f9ff; }
.item-card.is-done { background: #f1f5f9; opacity: 0.8; }

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
.custom-checkbox {
    width: 28px; height: 28px;
    border: 3px solid #3fbcd9;
    border-radius: 8px;
    margin-right: 12px;
    display: flex; align-items: center; justify-content: center;
    background: white;
}
input[type="checkbox"]:checked + .custom-checkbox { background: #3fbcd9; }
input[type="checkbox"]:checked + .custom-checkbox::after {
    content: "âœ“"; color: white; font-size: 18px; font-weight: 900;
}
.item-text { font-size: 16px; font-weight: 800; color: #2d3748; }
input[type="checkbox"]:checked ~ .item-text { text-decoration: line-through; color: #a0aec0; }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <div class="detail-header">
        <div class="created-badge">ğŸ“… {{ checklist.created_at|date:"Y/m/d" }} ã«ä½œæˆ</div>
        <h1 class="checklist-title">{{ checklist.checklist_name }}</h1>
        {% if checklist.checklist_description %}
        <div class="checklist-desc">{{ checklist.checklist_description }}</div>
        {% endif %}
    </div>

    <div class="checklist-scroll-area">
        {% for item in checklist.items.all %}
        <label class="item-card {% if item.is_done %}is-done{% endif %}" for="item_{{ item.checklist_item_id }}">
            <div class="checkbox-wrapper">
                <input type="checkbox" id="item_{{ item.checklist_item_id }}"
                       {% if item.is_done %}checked{% endif %}
                       onchange="handleToggle(this, {{ checklist.checklist_id }}, {{ item.checklist_item_id }})">
                <div class="custom-checkbox"></div>
            </div>
            <span class="item-text">{{ item.item_text }}</span>
        </label>
        {% empty %}
        <div style="text-align: center; color: #a0aec0; padding: 40px;">
            é …ç›®ãŒã²ã¨ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        {% endfor %}
    </div>

    <div class="detail-actions">
        <a href="{% url 'codemon:checklist_list' %}" class="btn-pop btn-back">
            â† ã‚‚ã©ã‚‹
        </a>
        <a href="{% url 'codemon:checklist_edit' pk=checklist.checklist_id %}" class="btn-pop btn-edit">
            âœï¸ ã¸ã‚“ã—ã‚…ã†
        </a>
        <a href="{% url 'codemon:checklist_delete_confirm' pk=checklist.checklist_id %}" class="btn-pop btn-delete">
            ğŸ—‘ï¸ ã‘ã™
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ãƒã‚§ãƒƒã‚¯ã®åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¿å­˜
function handleToggle(checkbox, checklistId, itemId) {
    const card = checkbox.closest('.item-card');
    
    // è¦‹ãŸç›®ã®å³æ™‚åæ˜ 
    if (checkbox.checked) {
        card.classList.add('is-done');
    } else {
        card.classList.remove('is-done');
    }

    // ã‚µãƒ¼ãƒãƒ¼ã¸ä¿å­˜
    fetch(`/codemon/checklists/${checklistId}/items/${itemId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'is_done': checkbox.checked }),
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ã„ã¡ã©è©¦ã—ã¦ã¿ã¦ã­ï¼');
            // å¤±æ•—ã—ãŸå ´åˆã¯ãƒã‚§ãƒƒã‚¯ã‚’æˆ»ã™
            checkbox.checked = !checkbox.checked;
            card.classList.toggle('is-done');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒãŠããŸã‚ˆã€‚');
    });
}
</script>
{% endblock %}