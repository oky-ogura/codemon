{% extends 'base.html' %}
{% load static %}
{% block background_frame %}

<img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
     alt="" 
     class="bg-frame frame-green"
     onerror="this.style.display='none';">
{% endblock %}
{% block extra_css %}
<style>
/* ãƒšãƒ¼ã‚¸å›ºæœ‰ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å›ºå®šãƒ˜ãƒƒãƒ€åˆ†ã®ä½™ç™½ã‚’ç¢ºä¿ */
.content-wrapper { padding-top: 140px !important; }

.checklist-detail {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 30px;
  min-height: calc(100vh - 140px);
  gap: 18px;
  position: relative;
  max-width: min(92vw, 980px);
  margin: 0 auto;
}

.checklist-info-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 24px;
  background: transparent;
  border-radius: 12px;
  overflow: visible;
  box-shadow: none;
  border: none;
  table-layout: auto;
}

.checklist-info-table th {
  background: transparent;
  padding: 12px 16px;
  text-align: left;
  font-weight: 700;
  color: #151515;
  width: auto;
}

.checklist-info-table td {
  padding: 12px 16px;
  text-align: left;
  color: #333;
  width: auto;
  vertical-align: top;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.checklist-info-table tr {
  border-bottom: none;
}

.checklist-info-table tr:last-child {
  border-bottom: none;
}

/* ===== ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè¡Œå€‹åˆ¥èª¿æ•´ ===== */
.checklist-row-name {
  /* åå‰è¡Œç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ç”¨ */
  --name-offset-x: 30px;
  --name-offset-y: -85px;
  transform: translate(var(--name-offset-x), var(--name-offset-y));
}

.checklist-row-name td {
  /* åå‰ã‚»ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  padding: 16px;
  font-weight: 700;
  font-size: 18px;
  color: #151515;
}

.checklist-row-description {
  /* èª¬æ˜è¡Œç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ç”¨ */
  --description-offset-x: 220px;
  --description-offset-y: -130px;
  transform: translate(var(--description-offset-x), var(--description-offset-y));
}

.checklist-row-description td {
  /* èª¬æ˜ã‚»ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  padding: 12px 16px;
  font-size: 14px;
  color: #555;
}

.checklist-row-line {
  /* ç”»åƒãƒ©ã‚¤ãƒ³è¡Œç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ç”¨ */
  --line-offset-x: 0px;
  --line-offset-y: -90px;
  transform: translate(var(--line-offset-x), var(--line-offset-y));
}

.checklist-row-line td {
  /* ç”»åƒãƒ©ã‚¤ãƒ³ã‚»ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
  padding: 12px 16px;
  text-align: center;
}

.checklist-line-image {
  /* ç”»åƒãƒ©ã‚¤ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ç”¨ */
  --image-offset-x: 0px;
  --image-offset-y: 0px;
  max-width: 100%;
  height: auto;
  display: block;
  transform: translate(var(--image-offset-x), var(--image-offset-y));
}

.checklist-items-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 24px;
  background: transparent;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: none;
  border: none;
}

.checklist-items-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: none;
}

.checklist-items-table tr:last-child td {
  border-bottom: none;
}

.checklist-items-table input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
}

.checklist-items-table label {
  cursor: pointer;
  font-size: 16px;
  color: #333;
}

/* ===== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ ===== */
.actions {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 18px;
  margin-top: 24px;
  position: relative;
  z-index: 1000;
}

/* ===== æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆbtn-backï¼‰å€‹åˆ¥èª¿æ•´ç”¨ ===== */
.btn-back {
  --back-width: 100%;
  --back-max-width: 180px;
  --back-height: auto;
  --back-padding: 0;
  --back-margin-top: 0;
  --back-margin-bottom: 0;
  --back-img-width: 100%;
  --back-img-max-width: 180px;
  --back-img-height: auto;
  --back-img-object-fit: contain;
  --back-img-offset-x: -435px;
  --back-img-offset-y: 30px;
  --back-img-scale: 1;
  
  position: relative;
  display: inline-block;
  width: var(--back-width);
  max-width: var(--back-max-width);
  height: var(--back-height);
  padding: var(--back-padding);
  margin-top: var(--back-margin-top);
  margin-bottom: var(--back-margin-bottom);
  background: none;
  border: none;
  text-decoration: none;
  cursor: pointer;
  transition: transform 0.22s ease;
}

.btn-back img {
  width: var(--back-img-width);
  max-width: var(--back-img-max-width);
  height: var(--back-img-height);
  object-fit: var(--back-img-object-fit);
  display: block;
  border-radius: 999px;
  box-shadow: none !important;
  transform: translate(var(--back-img-offset-x), var(--back-img-offset-y)) scale(var(--back-img-scale));
}

.btn-back:hover {
  /* hoveråŠ¹æœãªã— */
}

.btn-back:hover img {
  box-shadow: none !important;
}

/* ===== ç·¨é›†ãƒœã‚¿ãƒ³ï¼ˆbtn-editï¼‰å€‹åˆ¥èª¿æ•´ç”¨ ===== */
.btn-edit {
  --edit-width: 100%;
  --edit-max-width: 180px;
  --edit-height: auto;
  --edit-padding: 0;
  --edit-margin-top: 0;
  --edit-margin-bottom: 0;
  --edit-img-width: 100%;
  --edit-img-max-width: 180px;
  --edit-img-height: auto;
  --edit-img-object-fit: contain;
  --edit-img-offset-x: -530px;
  --edit-img-offset-y: -130px;
  --edit-img-scale: 1;
  
  position: relative;
  display: inline-block;
  width: var(--edit-width);
  max-width: var(--edit-max-width);
  height: var(--edit-height);
  padding: var(--edit-padding);
  margin-top: var(--edit-margin-top);
  margin-bottom: var(--edit-margin-bottom);
  background: none;
  border: none;
  text-decoration: none;
  cursor: pointer;
  transition: transform 0.22s ease;
}

.btn-edit img {
  width: var(--edit-img-width);
  max-width: var(--edit-img-max-width);
  height: var(--edit-img-height);
  object-fit: var(--edit-img-object-fit);
  display: block;
  border-radius: 999px;
  box-shadow: none !important;
  transform: translate(var(--edit-img-offset-x), var(--edit-img-offset-y)) scale(var(--edit-img-scale));
}

.btn-edit:hover {
  /* hoveråŠ¹æœãªã— */
}

.btn-edit:hover img {
  box-shadow: none !important;
}

/* ===== å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆbtn-deleteï¼‰å€‹åˆ¥èª¿æ•´ç”¨ ===== */
.btn-delete {
  --delete-width: 100%;
  --delete-max-width: 180px;
  --delete-height: auto;
  --delete-padding: 0;
  --delete-margin-top: 0;
  --delete-margin-bottom: 0;
  --delete-img-width: 100%;
  --delete-img-max-width: 180px;
  --delete-img-height: auto;
  --delete-img-object-fit: contain;
  --delete-img-offset-x: -635px;
  --delete-img-offset-y: -50px;
  --delete-img-scale: 1;
  
  position: relative;
  display: inline-block;
  width: var(--delete-width);
  max-width: var(--delete-max-width);
  height: var(--delete-height);
  padding: var(--delete-padding);
  margin-top: var(--delete-margin-top);
  margin-bottom: var(--delete-margin-bottom);
  background: none;
  border: none;
  text-decoration: none;
  cursor: pointer;
  transition: transform 0.22s ease;
}

.btn-delete img {
  width: var(--delete-img-width);
  max-width: var(--delete-img-max-width);
  height: var(--delete-img-height);
  object-fit: var(--delete-img-object-fit);
  display: block;
  border-radius: 999px;
  box-shadow: none !important;
  transform: translate(var(--delete-img-offset-x), var(--delete-img-offset-y)) scale(var(--delete-img-scale));
}

.btn-delete:hover {
  /* hoveråŠ¹æœãªã— */
}

.btn-delete:hover img {
  box-shadow: none !important;
}

/* ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã¨ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒ–ãƒ©ã‚¦ã‚¶ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ ã‚’ç„¡åŠ¹åŒ– */
.btn-back:focus,
.btn-back:active,
.btn-back:focus-visible,
.btn-edit:focus,
.btn-edit:active,
.btn-edit:focus-visible,
.btn-delete:focus,
.btn-delete:active,
.btn-delete:focus-visible {
  outline: none !important;
  box-shadow: none !important;
}

/* ã‚¿ãƒƒãƒ—ãƒã‚¤ãƒ©ã‚¤ãƒˆã®ç„¡åŠ¹åŒ– */
.btn-back, .btn-back img,
.btn-edit, .btn-edit img,
.btn-delete, .btn-delete img {
  -webkit-tap-highlight-color: transparent;
}

@media (max-width: 768px) {
  .checklist-detail {
    padding: 20px;
  }
  
  .checklist-info-table th {
    width: 35%;
    font-size: 14px;
  }
  
  .checklist-info-table td,
  .checklist-items-table td {
    font-size: 14px;
  }

  /* æ¨ªä¸¦ã³ã‚’ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
  .checklist-info-table td {
    display: block;
    width: 100%;
  }
  
  .btn-back {
    --back-max-width: 150px;
  }
  
  .btn-edit {
    --edit-max-width: 150px;
  }
  
  .btn-delete {
    --delete-max-width: 150px;
  }
  
  .actions {
    gap: 12px;
  }
}

@media (max-width: 480px) {
  .checklist-detail {
    padding: 16px;
  }
  
  .checklist-info-table th {
    width: 40%;
    font-size: 13px;
    padding: 10px 12px;
  }
  
  .checklist-info-table td,
  .checklist-items-table td {
    font-size: 13px;
    padding: 10px 12px;
  }
  
  .btn-back {
    --back-max-width: 120px;
  }
  
  .btn-edit {
    --edit-max-width: 120px;
  }
  
  .btn-delete {
    --delete-max-width: 120px;
  }
  
  .actions {
    flex-wrap: wrap;
    gap: 10px;
  }
}
</style>
{% endblock %}
{% block content %}

<!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè©³ç´° -->
<div class="checklist-detail">

  <table class="checklist-info-table">
    <tr class="checklist-row-name">
      <td class="checklist-name">{{ checklist.checklist_name }}</td>
    </tr>
    <tr class="checklist-row-description">
      <td class="checklist-description">{{ checklist.checklist_description }}</td>
    </tr>
    <tr class="checklist-row-line">
      <td colspan="2">
        <img src="{% static 'codemon/images/tags/checklist_list_line.png' %}" alt="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆãƒ©ã‚¤ãƒ³" class="checklist-line-image">
      </td>
    </tr>
  </table>

  <!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›® -->
  <form method="POST" action="">
    {% csrf_token %}
    <table class="checklist-items-table">
      {% for item in checklist.items.all %}
      <tr>
        <td>
          <input type="checkbox" id="item_{{ item.checklist_item_id }}" 
          {% if item.is_done %}checked{% endif %}
          onchange="toggleItem({{ checklist.checklist_id }}, {{ item.checklist_item_id }}, this.checked)">
        </td>
        <td>
          <label for="item_{{ item.checklist_item_id }}" {% if item.is_done %}style="text-decoration: line-through; color: gray;"{% endif %}>
          {{ item.item_text }}
        </label>
        </td>
      </tr>
      {% endfor %}
    </table>
  </form>

  <!-- ğŸ”¹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="actions">
    <a href="{% url 'codemon:checklist_list' %}" class="btn-back" aria-label="ä¸€è¦§ã«æˆ»ã‚‹">
      <img src="{% static 'codemon/images/buttons/back.png' %}" alt="">
    </a>
    <a href="{% url 'codemon:checklist_edit' pk=checklist.checklist_id %}" class="btn-edit" aria-label="ç·¨é›†">
      <img src="{% static 'codemon/images/buttons/edit.png' %}" alt="">
    </a>
    <a href="{% url 'codemon:checklist_delete_confirm' pk=checklist.checklist_id %}" class="btn-delete" aria-label="å‰Šé™¤">
      <img src="{% static 'codemon/images/buttons/delete.png' %}" alt="">
    </a>
  </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}
});
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleItem(checklistId, itemId, isDone) {
    fetch(`/codemon/checklists/${checklistId}/items/${itemId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'is_done': isDone })
    })
    .then(response => {
        if (!response.ok) alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    })
    .catch(error => alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™'));
}
</script>

{% endblock %}
