{% extends 'base.html' %}
{% block content %}

<!-- ğŸ”¹ ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
<div class="chat-ai-bubble">
  <a href="{% url 'codemon:chat' %}" class="chat-button">
    <i class="fas fa-comments"></i> AIãƒãƒ£ãƒƒãƒˆ
  </a>
</div>

<!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè©³ç´° -->
<div class="checklist-detail">

  <table class="checklist-info-table">
    <tr>
      <th>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå</th>
      <td>{{ checklist.checklist_name }}</td>
    </tr>
    <tr>
      <th>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ¦‚è¦</th>
      <td>{{ checklist.checklist_description }}</td>
    </tr>
    <tr>
      <th>ä½œæˆæ—¥</th>
      <td>{{ checklist.created_at|date:"Y/m/d H:i" }}</td>
    </tr>
    <tr>
      <th>æœ€çµ‚æ›´æ–°æ—¥</th>
      <td>{{ checklist.updated_at|date:"Y/m/d H:i" }}</td>
    </tr>
  </table>

  <!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›® -->
  <form method="POST" action="">
    {% csrf_token %}
    <table class="checklist-items-table">
      {% for item in checklist.items.all %}
      <tr>
        <td>
          <input type="checkbox" id="item_{{ item.checklist_item_id }}" 
          {% if item.is_done %}checked{% endif %}
          onchange="toggleItem({{ checklist.checklist_id }}, {{ item.checklist_item_id }}, this.checked)">
        </td>
        <td>
          <label for="item_{{ item.checklist_item_id }}" {% if item.is_done %}style="text-decoration: line-through; color: gray;"{% endif %}>
          {{ item.item_text }}
        </label>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="2">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</td>
      </tr>
      {% endfor %}
    </table>
  </form>

  <!-- ğŸ”¹ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
  <div class="actions">
    <a href="{% url 'codemon:checklist_list' %}" class="btn-back">ä¸€è¦§ã«æˆ»ã‚‹</a>
    <a href="{% url 'codemon:checklist_edit' pk=checklist.checklist_id %}" class="btn-edit">ç·¨é›†ã™ã‚‹</a>
    <a href="{% url 'codemon:checklist_delete_confirm' pk=checklist.checklist_id %}" class="btn-delete">å‰Šé™¤ã™ã‚‹</a>
  </div>

</div>

<!-- ğŸ”¹ ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
/* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ */
.chat-ai-bubble {
  position: fixed;
  bottom: 20px;
  right: 20px;
}
.chat-button {
  display: inline-flex;
  align-items: center;
  padding: 10px 15px;
  background-color: #007bff;
  color: white;
  text-decoration: none;
  border-radius: 20px;
}

/* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆè©³ç´° */
.checklist-detail {
  max-width: 800px;
  margin: 30px auto;
  padding: 20px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background-color: #fafafa;
}
.checklist-info-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}
.checklist-info-table th {
  width: 180px;
  background-color: #f8f8f8;
  text-align: left;
  padding: 10px;
  border-bottom: 1px solid #ddd;
}
.checklist-info-table td {
  padding: 10px;
  border-bottom: 1px solid #ddd;
  background-color: #fff;
}

/* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆé …ç›®ãƒ†ãƒ¼ãƒ–ãƒ« */
.checklist-items-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
}
.checklist-items-table td {
  padding: 8px;
  vertical-align: middle;
}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
.actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 20px;
}
.btn-back { padding: 10px 20px; background-color: #6c757d; color: white; border-radius: 4px; text-decoration: none; }
.btn-edit { padding: 10px 20px; background-color: #28a745; color: white; border-radius: 4px; text-decoration: none; }
.btn-delete { padding: 10px 20px; background-color: #dc3545; color: white; border-radius: 4px; text-decoration: none; }
.btn-back:hover { background-color: #5a6268; }
.btn-edit:hover { background-color: #218838; }
.btn-delete:hover { background-color: #c82333; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}
});
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i=0; i<cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function toggleItem(checklistId, itemId, isDone) {
    fetch(`/codemon/checklists/${checklistId}/items/${itemId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'is_done': isDone })
    })
    .then(response => {
        if (!response.ok) alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    })
    .catch(error => alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼ã§ã™'));
}
</script>

{% endblock %}
