{% extends 'base.html' %}
{% load static %}
{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}
{% block extra_css %}
<style>
/* ãƒšãƒ¼ã‚¸å›ºæœ‰ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã•åˆ†ã ã‘ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸‹ã’ã‚‹ */
.content-wrapper { padding-top: 140px !important; }

/* ãƒ’ãƒ¼ãƒ­ãƒ¼ç”»åƒ */
.page-hero { text-align: center; margin-bottom: 12px; }
.page-hero-img { max-width: 640px; width: 60%; height: auto; display: inline-block; }

.checklist-edit-container { max-width: 700px; margin: 120px auto 160px; padding: 25px 30px; position: relative; z-index:20; background-color:#f9f9f9; border:1px solid #ddd; border-radius:10px; }
.checklist-edit-container h2 { text-align:center; margin-bottom:25px; }

/* å·¦å´ã«ç¸¦ä¸¦ã³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé …ç›®è¿½åŠ ï¼ä¿å­˜ï¼æˆ»ã‚‹ï¼‰ã‚’é…ç½® */
.side-actions { position: absolute; left: -120px; top: 60px; display: flex; flex-direction: column; gap: 12px; }
.side-actions a, .side-actions button { display: inline-block; background: none; border: none; padding: 0; cursor: pointer; }
.side-actions img { height: 56px; display: block; }
.side-actions .btn-add img { height: 48px; }

@media (max-width: 800px) {
  .side-actions { left: 10px; position: relative; top: 0; flex-direction: row; gap: 8px; }
  .side-actions img { height: 44px; }
  .checklist-edit-container { margin: 80px 20px; }
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…±é€š */
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 6px; font-weight: bold; }
input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

/* é …ç›®ç”¨ */
#checklist-items-container .checklist-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
.remove-item-btn { background-color: #dc3545; color: white; border: none; padding: 0 8px; border-radius: 4px; cursor: pointer; }
.remove-item-btn:hover { background-color: #c82333; }

.btn-save-fallback { display: inline-block; padding: 10px 25px; border-radius: 4px; background-color: #28a745; border: none; color: white; font-weight: bold; cursor: pointer; }
.btn-save-fallback:hover { background-color: #218838; }

.form-actions { text-align: center; margin-top: 20px; }
.form-actions .btn-back, .form-actions .btn-save { display:inline-block; margin:0 8px; }
.form-actions img { height:56px; max-width:220px; }
@media (max-width:480px){ .form-actions img { height:44px; } }

/* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ */
.chat-ai-bubble { position: fixed; bottom: 20px; right: 20px; z-index:9999; }
.chat-button { display: inline-flex; align-items: center; gap:8px; padding:10px 15px; background-color:#007bff; color:white; text-decoration:none; border-radius:20px; font-weight:bold; }

</style>
{% endblock %}

{% block content %}

<!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->

<div class="checklist-edit-container">
  <div class="page-hero">
    <img src="{% static 'codemon/images/titles/checklist_edit.png' %}" alt="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç·¨é›†" class="page-hero-img" onerror="this.style.display='none'">
  </div>
  <form method="POST" action="{% url 'codemon:checklist_save' pk=checklist.checklist_id %}">
  {% csrf_token %}

  <div>
    <label>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå</label>
    <input type="text" name="checklist_name" value="{{ checklist.checklist_name }}" required>
  </div>

  <div>
    <label>æ¦‚è¦</label>
    <textarea name="checklist_description">{{ checklist.checklist_description }}</textarea>
  </div>

  <h3>é …ç›®</h3>
  <div id="items-container">
    {% for item in checklist.items.all %}
      <div class="item-row">
        <input type="text" name="item_{{ forloop.counter }}" value="{{ item.item_text }}">
        <input type="checkbox" name="done_{{ forloop.counter }}" {% if item.is_done %}checked{% endif %}>
      </div>
    {% endfor %}
  </div>

  <!-- å·¦å´ã®ç¸¦ä¸¦ã³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å†…éƒ¨ã«å…¥ã‚Œã¦ submit ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼‰ -->
  <div class="side-actions" aria-hidden="false">
    <!-- é …ç›®è¿½åŠ ï¼ˆJSã§å‡¦ç†ï¼‰ -->
    <button type="button" id="add-item" class="btn-add" aria-label="é …ç›®è¿½åŠ ">
      <img src="{% static 'codemon/images/nav/add_item.png' %}" alt="é …ç›®è¿½åŠ ">
    </button>

    <!-- ä¿å­˜ï¼ˆç”»åƒãƒœã‚¿ãƒ³ï¼‰ -->
    <button type="submit" name="show_confirm" value="1" class="btn-save" aria-label="ä¿å­˜">
      <img src="{% static 'codemon/images/nav/save.png' %}" alt="ä¿å­˜">
    </button>

    <!-- æˆ»ã‚‹ -->
    <a href="{% url 'codemon:checklist_selection' %}" class="btn-back" aria-label="æˆ»ã‚‹">
      <img src="{% static 'codemon/images/buttons/back.png' %}" alt="æˆ»ã‚‹">
    </a>
  </div>

  <!-- äº’æ›æ€§ã®ãŸã‚ã®ä¸­å¤®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã«æ®‹ã™ï¼‰ -->
  <div class="form-actions" style="display:none;">
    <a href="{% url 'codemon:checklist_selection' %}" class="btn-back" aria-label="æˆ»ã‚‹">
      <img src="{% static 'codemon/images/buttons/back.png' %}" alt="æˆ»ã‚‹">
    </a>
    <button type="submit" class="btn-save" aria-label="ä¿å­˜">
      <img src="{% static 'codemon/images/buttons/save.png' %}" alt="ä¿å­˜">
    </button>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // account tab redirect for teachers
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    if (accountTab) accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}

  // dynamic item add/remove
  let itemIndex = {{ checklist.items.count }} + 1;
  const addBtn = document.getElementById('add-item');
  const container = document.getElementById('items-container');

  function removeItem(btn) { btn.parentElement.remove(); }

  if (addBtn && container) {
    addBtn.addEventListener('click', function() {
      const div = document.createElement('div');
      div.className = 'item-row';
      div.innerHTML = `
        <input type="text" name="item_${itemIndex}" value="">
        <input type="checkbox" name="done_${itemIndex}">
        <button type="button" class="remove-item-btn" onclick="this.parentElement.remove()">å‰Šé™¤</button>
      `;
      container.appendChild(div);
      itemIndex++;
    });
  }
});
</script>

{% endblock %}