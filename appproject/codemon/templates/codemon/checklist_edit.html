{% extends 'base.html' %}
{% load static %}
{% block title %}チェックリスト編集 - Codemon{% endblock %}

{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
<img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
     alt=""
     class="bg-frame frame-green"
     onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* 全体レイアウト */
.checklist-edit-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  text-align: center;
  padding: 30px;
  min-height: calc(100vh - 140px);
  gap: 18px;
  position: relative;
}

/* ページタイトル画像 */
.page-hero {
  --hero-width: 100%;
  --hero-max-width: 320px;
  --hero-height: auto;
  --hero-offset-x: 0;
  --hero-offset-y: 120px;
  --hero-scale: 1;

  width: var(--hero-width);
  max-width: var(--hero-max-width);
  height: var(--hero-height);
  display: block;
  position: relative;
  margin-bottom: 16px;
}

.page-hero-img {
  width: 100%;
  max-width: 100%;
  height: auto;
  display: block;
  object-fit: contain;
  position: absolute;
  left: 0;
  top: 120px;
  transform: scale(var(--hero-scale));
}

/* フォームラッパー */
form.checklist-form {
  width: 100%;
  max-width: min(92vw, 820px);
  display: flex;
  flex-direction: column;
  gap: 18px;
  align-items: center;
  position: relative;
  overflow: visible;
}

/* 共通セクションの土台 */
.section-box {
  position: relative;
  width: 100%;
  max-width: 760px;
  min-height: 160px;
  margin-bottom: 4px;
  overflow: visible;
}

/* ===== チェックリスト名セクション可変プロパティ ===== */

/* 背景画像 */
.checklist-name img.bg {
  position: absolute;
  left: -90px;
  top: 150px;
  width: var(--name-bg-width, 100%);
  max-width: var(--name-bg-max-width, 270px);
  height: var(--name-bg-height, auto);
  max-height: var(--name-bg-max-height, none);
  display: block;
  object-fit: var(--name-bg-object-fit, contain);
  z-index: 1;
  transform: scale(var(--name-bg-scale, 1));
}

/* タイトル */
.checklist-name .section-title {
  position: absolute;
  left: -50px;
  top: 160px;
  width: var(--name-title-width, auto);
  max-width: var(--name-title-max-width, none);
  height: var(--name-title-height, auto);
  max-height: var(--name-title-max-height, none);
  display: block;
  z-index: 3;
  font-size: var(--name-title-size, 20px);
  color: var(--name-title-color, #000);
  font-weight: var(--name-title-weight, 700);
  letter-spacing: var(--name-title-spacing, 0);
  overflow: hidden;
  text-overflow: ellipsis;
  transform: scale(var(--name-title-scale, 1));
}

/* 入力フォーム */
.checklist-name .section-input {
  position: absolute;
  left: -85px;
  top: 185px;
  width: var(--name-input-width, 100%);
  max-width: var(--name-input-max-width, 260px);
  height: var(--name-input-height, auto);
  max-height: var(--name-input-max-height, none);
  z-index: 2;
  transform: scale(var(--name-input-scale, 1));
}

.checklist-name .section-input input[type="text"] {
  width: 100%;
  max-width: 100%;
  background: transparent;
  border: none;
  color: var(--name-input-color, #000);
  font-size: var(--name-input-size, 18px);
  font-weight: var(--name-input-weight, 400);
  letter-spacing: var(--name-input-spacing, 0);
  padding: var(--name-input-padding-y, 8px) var(--name-input-padding-x, 10px);
  box-sizing: border-box;
}

/* ===== チェックリスト概要セクション可変プロパティ ===== */

/* 背景画像 */
.checklist-overview img.bg {
  position: absolute;
  left: -90px;
  top: 75px;
  width: var(--overview-bg-width, 100%);
  max-width: var(--overview-bg-max-width, 270px);
  height: var(--overview-bg-height, auto);
  max-height: var(--overview-bg-max-height, none);
  display: block;
  object-fit: var(--overview-bg-object-fit, contain);
  z-index: 1;
  transform: scale(var(--overview-bg-scale, 1));
}

/* タイトル */
.checklist-overview .section-title {
  position: absolute;
  left: -55px;
  top: 85px;
  width: var(--overview-title-width, auto);
  max-width: var(--overview-title-max-width, none);
  height: var(--overview-title-height, auto);
  max-height: var(--overview-title-max-height, none);
  display: block;
  z-index: 3;
  font-size: var(--overview-title-size, 20px);
  color: var(--overview-title-color, #000);
  font-weight: var(--overview-title-weight, 700);
  letter-spacing: var(--overview-title-spacing, 0);
  overflow: hidden;
  text-overflow: ellipsis;
  transform: scale(var(--overview-title-scale, 1));
}

/* 入力フォーム */
.checklist-overview .section-input {
  position: absolute;
  left: -87px;
  top: 124px;
  width: var(--overview-input-width, 100%);
  max-width: var(--overview-input-max-width, 260px);
  height: var(--overview-input-height, auto);
  max-height: var(--overview-input-max-height, none);
  z-index: 2;
  transform: scale(var(--overview-input-scale, 1));
}

.checklist-overview .section-input textarea {
  width: 100%;
  max-width: 100%;
  background: transparent;
  border: none;
  color: var(--overview-input-color, #000);
  font-size: var(--overview-input-size, 18px);
  font-weight: var(--overview-input-weight, 400);
  letter-spacing: var(--overview-input-spacing, 0);
  padding: var(--overview-input-padding-y, 8px) var(--overview-input-padding-x, 10px);
  box-sizing: border-box;
  resize: none;
}

/* ===== チェックリスト項目セクション可変プロパティ ===== */

/* 背景画像 */
.checklist-items img.bg {
  position: absolute;
  left: 220px;
  top: -215px;
  width: var(--items-bg-width, 100%);
  max-width: var(--items-bg-max-width, 440px);
  height: var(--items-bg-height, auto);
  max-height: var(--items-bg-max-height, none);
  display: block;
  object-fit: var(--items-bg-object-fit, contain);
  z-index: 1;
  transform: scale(var(--items-bg-scale, 1));
}

/* タイトル */
.checklist-items .section-title {
  position: absolute;
  left: 0;
  top: 40px;
  width: var(--items-title-width, 100%);
  max-width: var(--items-title-max-width, 270px);
  height: var(--items-title-height, auto);
  max-height: var(--items-title-max-height, none);
  display: block;
  z-index: 3;
  font-size: var(--items-title-size, 20px);
  color: var(--items-title-color, #000);
  font-weight: var(--items-title-weight, 700);
  letter-spacing: var(--items-title-spacing, 0);
  overflow: hidden;
  text-overflow: ellipsis;
  transform: translate(var(--items-title-x, 200px), var(--items-title-y, -245px)) scale(var(--items-title-scale, 1));
}

/* 項目コンテナ */
#items-container {
  position: absolute;
  left: 40px;
  top: 40px;
  width: 100%;
  max-width: 400px;
  z-index: 2;
  transform: translate(200px, -200px);
}

/* 項目1行 */
.item-row {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.item-title input[type="text"] {
  width: 100%;
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 16px;
  box-sizing: border-box;
}

.item-delete {
  width: 32px;
  height: 32px;
  padding: 0;
  background: none;
  border: none;
  cursor: pointer;
}

.item-delete img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  display: block;
}

/* ===== サイドアクションボタン可変プロパティ ===== */

.side-actions {
  position: var(--actions-position, relative);  
  --actions-x: 0;
  --actions-y: -100px;          /* 画面下から100px上 */
  --actions-z-index: 100;       /* 最前面に */  --actions-position: fixed;     /* 固定配置 */
  display: var(--actions-display, flex);
  flex-direction: var(--actions-direction, row);
  justify-content: var(--actions-justify, center);
  align-items: var(--actions-align, center);
  gap: var(--actions-gap, 20px);
  width: var(--actions-width, auto);
  max-width: var(--actions-max-width, none);
  margin-top: var(--actions-margin-top, 20px);
  margin-bottom: var(--actions-margin-bottom, 0);
  padding: var(--actions-padding, 0);
  transform: translate(var(--actions-x, 0), var(--actions-y, 0)) scale(var(--actions-scale, 1));
  z-index: var(--actions-z-index, 10);
}

/* 各ボタン共通 */
.side-actions button,
.side-actions a {
  width: var(--actions-btn-width, auto);
  max-width: var(--actions-btn-max-width, 80px);
  height: var(--actions-btn-height, auto);
  padding: var(--actions-btn-padding, 0);
  background: var(--actions-btn-bg, transparent);
  border: var(--actions-btn-border, none);
  cursor: pointer;
  display: block;
}

.side-actions button img,
.side-actions a img {
  width: 100%;
  height: auto;
  display: block;
  object-fit: contain;
  pointer-events: none;
}

/* 個別ボタン調整 */
.side-actions .btn-add {
  position: var(--actions-add-position, relative);
  width: var(--actions-add-width, auto);
  max-width: var(--actions-add-max-width, 120px);
  height: var(--actions-add-height, auto);
  margin: var(--actions-add-margin, 0);
  padding: var(--actions-add-padding, 0);
  background: var(--actions-add-bg, transparent);
  border: var(--actions-add-border, none);
  z-index: var(--actions-add-z-index, auto);
  transform: translate(var(--actions-add-x, -450px), var(--actions-add-y, 340px)) scale(var(--actions-add-scale, 1));
}

.side-actions .btn-save {
  position: var(--actions-save-position, relative);
  width: var(--actions-save-width, auto);
  max-width: var(--actions-save-max-width, 120px);
  height: var(--actions-save-height, auto);
  margin: var(--actions-save-margin, 0);
  padding: var(--actions-save-padding, 0);
  background: var(--actions-save-bg, transparent);
  border: var(--actions-save-border, none);
  z-index: var(--actions-save-z-index, auto);
  transform: translate(var(--actions-save-x, -583px), var(--actions-save-y, 397px)) scale(var(--actions-save-scale, 1));
}

.side-actions .btn-back {
  position: var(--actions-back-position, relative);
  width: var(--actions-back-width, auto);
  max-width: var(--actions-back-max-width, 80px);
  height: var(--actions-back-height, auto);
  margin: var(--actions-back-margin, 0);
  padding: var(--actions-back-padding, 0);
  background: var(--actions-back-bg, transparent);
  border: var(--actions-back-border, none);
  z-index: var(--actions-back-z-index, auto);
  transform: translate(var(--actions-back-x, -672px), var(--actions-back-y, 485px)) scale(var(--actions-back-scale, 1));
}

/* モバイル調整 */
@media (max-width: 768px) {
  .checklist-edit-container { padding: 20px; }
  form.checklist-form { gap: 14px; }
  .section-box { min-height: 180px; }
  .side-actions {
    flex-direction: column;
    gap: 12px;
  }
}

</style>
{% endblock %}

{% block content %}
<div class="checklist-edit-container">
  <div class="page-hero">
    <img src="{% static 'codemon/images/titles/checklist_edit.png' %}" alt="チェックリスト編集" class="page-hero-img" onerror="this.style.display='none'">
  </div>

  <form class="checklist-form" method="POST" action="{% url 'codemon:checklist_save' pk=checklist.checklist_id %}">
    {% csrf_token %}

    <!-- チェックリスト名 -->
    <div class="section-box checklist-name">
      <img class="bg" src="{% static 'codemon/images/backgrounds/checklist_edit_bule_bg.png' %}" alt="チェックリスト名" onerror="this.style.display='none'">
      <div class="section-title">チェックリスト名</div>
      <div class="section-input">
        <input type="text" name="checklist_name" value="{{ checklist.checklist_name }}" required>
      </div>
    </div>

    <!-- チェックリスト概要 -->
    <div class="section-box checklist-overview">
      <img class="bg" src="{% static 'codemon/images/backgrounds/checklist_edit_blue2_bg.png' %}" alt="チェックリスト概要" onerror="this.style.display='none'">
      <div class="section-title">チェックリスト概要</div>
      <div class="section-input">
        <textarea name="checklist_description" rows="3">{{ checklist.checklist_description }}</textarea>
      </div>
    </div>

    <!-- チェックリスト項目 -->
    <div class="section-box checklist-items">
      <img class="bg" src="{% static 'codemon/images/backgrounds/checklist_edit_blue3_bg.png' %}" alt="チェックリスト項目" onerror="this.style.display='none'"> 
      <div class="section-title">チェックリスト項目</div>
      <div id="items-container" aria-live="polite"></div>
    </div>

    <!-- ボタンエリア -->
    <div class="side-actions">
      <button type="button" id="add-item" class="btn-add" aria-label="項目追加">
        <img src="{% static 'codemon/images/nav/add_item.png' %}" alt="項目追加">
      </button>
      <button type="submit" name="show_confirm" value="1" class="btn-save" aria-label="保存">
        <img src="{% static 'codemon/images/nav/save.png' %}" alt="保存">
      </button>
      <a href="{% url 'codemon:checklist_detail' pk=checklist.checklist_id %}" class="btn-back" aria-label="戻る">
        <img src="{% static 'codemon/images/buttons/back.png' %}" alt="戻る">
      </a>
    </div>
    
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    if (accountTab) accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}

  let itemIndex = {{ checklist.items.count }} + 1;
  const container = document.getElementById('items-container');

  function createItemRow(index, checked = false, title = '') {
    const row = document.createElement('div');
    row.className = 'item-row';
    row.id = `item-row-${index}`;
    row.innerHTML = `
      <div class="item-title" style="flex:1;">
        <input type="text" id="item-title-${index}" name="item_title_${index}" placeholder="タイトル" value="${title}" />
      </div>
      <button type="button" class="item-delete" data-index="${index}" aria-label="項目削除">
        <img src="{% static 'codemon/images/nav/delete.png' %}" alt="">
      </button>
    `;
    return row;
  }

  // 既存の項目を初期化
  {% for item in checklist.items.all %}
    container.appendChild(createItemRow({{ forloop.counter }}, {{ item.is_done|lower }}, "{{ item.item_text|escapejs }}"));
  {% endfor %}

  // 追加ボタン
  const addBtn = document.getElementById('add-item');
  if (addBtn) {
    addBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const newRow = createItemRow(itemIndex);
      container.appendChild(newRow);
      const focusTarget = document.getElementById(`item-title-${itemIndex}`);
      if (focusTarget) focusTarget.focus();
      itemIndex++;
    });
  }

  // 削除ボタン
  container.addEventListener('click', function(e) {
    const btn = e.target.closest('.item-delete');
    if (btn) {
      const index = btn.dataset.index;
      const row = document.getElementById(`item-row-${index}`);
      if (row) row.remove();
    }
  });
});
</script>
{% endblock %}
