{% extends 'base.html' %}
{% block content %}

<!-- ğŸ”¹ AIãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
<div class="chat-ai-bubble">
  <a href="{% url 'codemon:chat' %}" class="chat-button">
    <i class="fas fa-comments"></i> AIãƒãƒ£ãƒƒãƒˆ
  </a>
</div>

<!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="checklist-edit-container">
  <h2>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ç·¨é›†</h2>
  <form method="POST" action="{% url 'codemon:checklist_save' pk=checklist.checklist_id %}">
  {% csrf_token %}

  <div>
    <label>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå</label>
    <input type="text" name="checklist_name" value="{{ checklist.checklist_name }}" required>
  </div>

  <div>
    <label>æ¦‚è¦</label>
    <textarea name="checklist_description">{{ checklist.checklist_description }}</textarea>
  </div>

  <h3>é …ç›®</h3>
  <div id="items-container">
    {% for item in checklist.items.all %}
      <div class="item-row">
        <input type="text" name="item_{{ forloop.counter }}" value="{{ item.item_text }}">
        <input type="checkbox" name="done_{{ forloop.counter }}" {% if item.is_done %}checked{% endif %}>
      </div>
    {% endfor %}
  </div>

  <button type="button" id="add-item">é …ç›®ã‚’è¿½åŠ </button>
  <button type="submit" name="show_confirm" value="1">ä¿å­˜</button>
</form>

<script>
let itemIndex = {{ checklist.items.count }} + 1;
document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const div = document.createElement('div');
    div.classList.add('item-row');
    div.innerHTML = `<input type="text" name="item_${itemIndex}" value="">
                     <input type="checkbox" name="done_${itemIndex}">`;
    container.appendChild(div);
    itemIndex++;
});
</script>

<!-- ğŸ”¹ ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
.chat-ai-bubble { position: fixed; bottom: 20px; right: 20px; }
.chat-button { display: inline-flex; align-items: center; gap: 8px; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 20px; font-weight: bold; }

.checklist-edit-container { max-width: 700px; margin: 30px auto; padding: 25px 30px; background-color: #f9f9f9; border: 1px solid #ddd; border-radius: 10px; }
.checklist-edit-container h2 { text-align: center; margin-bottom: 25px; }

.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 6px; font-weight: bold; }
input[type="text"], textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

#checklist-items-container .checklist-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
.remove-item-btn { background-color: #dc3545; color: white; border: none; padding: 0 8px; border-radius: 4px; cursor: pointer; }
.remove-item-btn:hover { background-color: #c82333; }

#add-item-btn { margin-top: 10px; padding: 6px 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
#add-item-btn:hover { background-color: #218838; }

.btn-save { display: inline-block; padding: 10px 25px; border-radius: 4px; background-color: #28a745; border: none; color: white; font-weight: bold; cursor: pointer; }
.btn-save:hover { background-color: #218838; }
</style>

<!-- ğŸ”¹ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}

  const addItemBtn = document.getElementById('add-item-btn');
  const container = document.getElementById('checklist-items-container');

  addItemBtn.addEventListener('click', function() {
    const index = container.children.length + 1;
    const div = document.createElement('div');
    div.className = 'checklist-item';
    div.innerHTML = `
      <input type="text" name="item_${index}" placeholder="é …ç›®ã‚’å…¥åŠ›" required>
      <label>
        <input type="checkbox" name="done_${index}">
        å®Œäº†
      </label>
      <button type="button" class="remove-item-btn" onclick="removeItem(this)">å‰Šé™¤</button>
    `;
    container.appendChild(div);
  });
});

function removeItem(btn) {
  btn.parentElement.remove();
}

let itemIndex = {{ checklist.items.count }} + 1;
document.getElementById('add-item').addEventListener('click', function() {
    const container = document.getElementById('items-container');
    const div = document.createElement('div');
    div.classList.add('item-row');
    div.innerHTML = `<input type="text" name="item_${itemIndex}" value="">
                     <input type="checkbox" name="done_${itemIndex}">`;
    container.appendChild(div);
    itemIndex++;
});
</script>

{% endblock %}
