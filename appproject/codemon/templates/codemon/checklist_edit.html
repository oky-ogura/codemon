{% extends 'base.html' %}
{% load static %}
{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}
{% block extra_css %}
<style>
/* ãƒšãƒ¼ã‚¸å›ºæœ‰ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã•åˆ†ã ã‘ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸‹ã’ã‚‹ */
.content-wrapper { padding-top: 140px !important; }

/* ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ç”»åƒï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šéƒ¨ã®é£¾ã‚Šï¼‰ */
.page-hero {
  text-align: center;
  margin-bottom: 12px;
}
.page-hero-img {
  /* å¹…ã‚’ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¸­æ®µã®ã€Œã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã€â†’ã€Œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã€åŒºé–“ã«è¿‘ã¥ã‘ã‚‹ */
  width: min(26vw, 640px);
  max-width: 640px;
  height: auto;
  display: block;
  margin: 25px auto 22px; /* ä¸­å¤®ã«å¯„ã›ã¤ã¤ä¸‹ã®ä½™ç™½ã‚’åºƒã‚ã« */
}

.checklist-edit-container { max-width: 700px; margin: 120px auto 160px; padding: 25px 30px; position: relative; z-index:20; background-color: transparent; border: none; box-shadow: none; }
.checklist-edit-container h2 { text-align:center; margin-bottom:25px; }

/* å·¦å´ã«ç¸¦ä¸¦ã³ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé …ç›®è¿½åŠ ï¼ä¿å­˜ï¼æˆ»ã‚‹ï¼‰ã‚’é…ç½® */
.side-actions { position: absolute; left: -280px; top: 230px; display: flex; flex-direction: column; gap: 12px; }
.side-actions a, .side-actions button { display: inline-block; background: none; border: none; padding: 0; cursor: pointer; }
.side-actions img { height: 45px; display: block; }
.side-actions .btn-add img { height: 45px; }

@media (max-width: 800px) {
  .side-actions { left: 10px; position: relative; top: 0; flex-direction: row; gap: 8px; }
  .side-actions img { height: 44px; }
  .checklist-edit-container { margin: 80px 20px; }
}

/* å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…±é€š */
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 10px; font-weight: bold; }
input[type="text"], textarea { width: 100%; padding: 10px; box-sizing: border-box; background: transparent; border: none; border-radius: 0; }

/* field-bg ã‚³ãƒ³ãƒ†ãƒŠã®ç™½èƒŒæ™¯ãƒ»æ ã‚’å–ã‚Šé™¤ãï¼ˆå¿…é ˆï¼‰ */
.field-bg { background: transparent !important; border: none !important; box-shadow: none !important; }
.field-bg input[type="text"], .field-bg textarea { background: transparent; border: none; }

/* form å†…ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜ãƒœã‚¿ãƒ³ç”¨ï¼ˆç”»åƒä»¥å¤–ã®ãƒœã‚¿ãƒ³ãŒã‚ã‚Œã°é€éï¼‰ */
.btn-save-fallback { background: transparent; border: none; box-shadow: none; }

/* é …ç›®ç”¨ */
#checklist-items-container .checklist-item { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; }
.remove-item-btn { background-color: #dc3545; color: white; border: none; padding: 0 8px; border-radius: 4px; cursor: pointer; }
.remove-item-btn:hover { background-color: #c82333; }

.btn-save-fallback { display: inline-block; padding: 10px 25px; border-radius: 4px; background-color: #28a745; border: none; color: white; font-weight: bold; cursor: pointer; }
.btn-save-fallback:hover { background-color: #218838; }

.form-actions { text-align: center; margin-top: 20px; }
.form-actions .btn-back, .form-actions .btn-save { display:inline-block; margin:0 8px; }
.form-actions img { height:56px; max-width:220px; }
@media (max-width:480px){ .form-actions img { height:44px; } }

/* ===== å€‹åˆ¥ç”»åƒã‚³ãƒ³ãƒ†ãƒŠç”¨ã‚¹ã‚¿ã‚¤ãƒ« (èª¿æ•´ã¯ --img-* å¤‰æ•°ã§ä¸Šæ›¸ã) ===== */
/* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå */
.checklist-name {
  position: relative;
  --img-w: 290px;   /* ç”»åƒå¹… */
  --img-h: 70px;    /* ç”»åƒé«˜ã• */
  --img-left: -160px;  /* ç”»åƒã®å·¦ã‚ªãƒ•ã‚»ãƒƒãƒˆ */
  --img-top: 15px;   /* ç”»åƒã®ä¸Šã‚ªãƒ•ã‚»ãƒƒãƒˆ */
  width: 100%;
  min-height: var(--img-h);
}
.checklist-name img {
  position: absolute;
  left: var(--img-left);
  top: var(--img-top);
  width: var(--img-w);
  height: var(--img-h);
  object-fit: contain;
  display: block;
}

/* ç”»åƒä¸Šã«è¡¨ç¤ºç”¨ã‚¿ã‚¤ãƒˆãƒ«ã¨å…¥åŠ›æ¬„ã‚’é‡ã­ã‚‹ï¼ˆä½ç½®ã¯å„ --*-* å¤‰æ•°ã§èª¿æ•´ï¼‰ */
.checklist-name-title {
  position: absolute;
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»åƒå†…ã®ç™½é ˜åŸŸã‚ãŸã‚Šã«è¡¨ç¤ºï¼ˆç”»åƒå†…ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰ */
  left: var(--title-left, calc(var(--img-left) + 40px));
  top: var(--title-top, calc(var(--img-top) + 12px));
  color: var(--title-color, #000);
  font-size: var(--title-size, 20px);
  font-weight: bold;
  z-index: 3;
}

.checklist-name-input {
  position: absolute;
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»åƒå†…ã®é’ã„ãƒãƒ¼ä¸Šã«é…ç½® */
  left: var(--input-left, calc(var(--img-left) + 18px));
  top: var(--input-top, calc(var(--img-top) + 36px));
  width: var(--input-width, calc(var(--img-w) - 36px));
  z-index: 2;
}
.checklist-name-input input[type="text"] {
  width: 100%;
  background: transparent;
  border: none;
  color: #000;
  font-size: 18px;
  padding: 6px 8px;
  box-sizing: border-box;
}

/* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ¦‚è¦ */
.checklist-overview {
  position: relative;
  --img-w: 290px;
  --img-h: 125px;
  --img-left: -160px;
  --img-top: 40px;
  width: 100%;
  min-height: var(--img-h);
}
.checklist-overview img {
  position: absolute;
  left: var(--img-left);
  top: var(--img-top);
  width: var(--img-w);
  height: var(--img-h);
  object-fit: contain;
  display: block;
}

/* ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ¦‚è¦ç”¨ã®ã‚¿ã‚¤ãƒˆãƒ«ã¨å…¥åŠ›ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.checklist-overview-title {
  position: absolute;
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»åƒå†…ã®ç™½é ˜åŸŸã‚ãŸã‚Šã«è¡¨ç¤º */
  left: var(--title-left, calc(var(--img-left) + 40px));
  top: var(--title-top, calc(var(--img-top) + 12px));
  color: var(--title-color, #000);
  font-size: var(--title-size, 18px);
  font-weight: bold;
  z-index: 3;
}

.checklist-overview-input {
  position: absolute;
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»åƒå†…ã®é’ã„ã‚¨ãƒªã‚¢ä¸Šã«é…ç½® */
  left: var(--input-left, calc(var(--img-left) + 18px));
  top: var(--input-top, calc(var(--img-top) + 60px));
  width: var(--input-width, calc(var(--img-w) - 36px));
  z-index: 2;
}
.checklist-overview-input textarea {
  width: 100%;
  height: var(--input-height, 60px);
  background: transparent;
  border: none;
  color: #000;
  font-size: 16px;
  padding: 6px 8px;
  box-sizing: border-box;
  resize: vertical;
}

/* é …ç›® */
.checklist-items {
  position: relative;
  --img-w: 420px;
  --img-h: 220px;
  --img-left: 140px;
  --img-top: -180px;
  width: 100%;
  min-height: var(--img-h);
}
.checklist-items img {
  position: absolute;
  left: var(--img-left);
  top: var(--img-top);
  width: var(--img-w);
  height: var(--img-h);
  object-fit: contain;
  display: block;
}

/* é …ç›®ã‚¨ãƒªã‚¢ã®ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç”»åƒã®ç™½é ˜åŸŸï¼‰ã¨é …ç›®ãƒªã‚¹ãƒˆï¼ˆç”»åƒã®é’é ˜åŸŸï¼‰ */
.checklist-items-title {
  position: absolute;
  left: var(--title-left, calc(var(--img-left) + 20px));
  top: var(--title-top, calc(var(--img-top) + 12px));
  color: var(--title-color, #000);
  font-size: var(--title-size, 18px);
  font-weight: bold;
  z-index: 3;
}

/* é’ã„éƒ¨åˆ†ã«é…ç½®ã™ã‚‹é …ç›®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ#items-container ã‚’ã“ã“ã§é…ç½®ï¼‰ */
#items-container {
  position: absolute;
  left: var(--items-left, calc(var(--img-left) + 16px));
  top: var(--items-top, calc(var(--img-top) + 52px));
  width: var(--items-width, calc(var(--img-w) - 32px));
  height: var(--items-height, calc(var(--img-h) * 0.6));
  z-index: 2;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

#items-container .item-row { display: flex; gap: 8px; align-items: center; }
#items-container .item-row input[type="text"] { flex: 1; background: transparent; border: none; color: #000; padding: 6px 8px; box-sizing: border-box; }
#items-container .item-row input[type="checkbox"] { width: 18px; height: 18px; }
#items-container .item-row .remove-item-btn { background: rgba(220,53,69,0.9); color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer; }

/* ä½¿ç”¨ä¾‹ï¼ˆHTMLä¸Šã§ä¸Šæ›¸ãï¼‰:
   <div class="checklist-name" style="--img-w:180px; --img-left:-12px; --img-top:4px;"> ...</div>
*/

/* ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ */
.chat-ai-bubble { position: fixed; bottom: 20px; right: 20px; z-index:9999; }
.chat-button { display: inline-flex; align-items: center; gap:8px; padding:10px 15px; background-color:#007bff; color:white; text-decoration:none; border-radius:20px; font-weight:bold; }

</style>
{% endblock %}

{% block content %}

<!-- ğŸ”¹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  -->

<div class="checklist-edit-container">
  <div class="page-hero">
    <img src="{% static 'codemon/images/titles/checklist_edit.png' %}" alt="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç·¨é›†" class="page-hero-img" onerror="this.style.display='none'">
  </div>
  <form method="POST" action="{% url 'codemon:checklist_save' pk=checklist.checklist_id %}">
  {% csrf_token %}

  <div class="checklist-name">
    <img src="{% static 'codemon/images/backgrounds/checklist_blue_bg1.png' %}" alt="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå" onerror="this.style.display='none'">
    <!-- ç™½ã„éƒ¨åˆ†ã«ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º -->
    <div class="checklist-name-title">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆå</div>
    <!-- é’ã„ãƒãƒ¼ä¸Šã«å…¥åŠ›æ¬„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…/ä½ç½®ã¯ CSS å¤‰æ•°ã§èª¿æ•´ï¼‰ -->
    <div class="checklist-name-input">
      <input type="text" name="checklist_name" value="{{ checklist.checklist_name }}" required>
    </div>
  </div>

  <div class="checklist-overview">
    <img src="{% static 'codemon/images/backgrounds/checklist_blue_bg2.png' %}" alt="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ¦‚è¦" onerror="this.style.display='none'">
    <!-- ç™½ã„éƒ¨åˆ†ã«ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º -->
    <div class="checklist-overview-title">ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæ¦‚è¦</div>
    <!-- é’ã„ãƒãƒ¼ä¸Šã«å…¥åŠ›æ¬„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…/ä½ç½®ã¯ CSS å¤‰æ•°ã§èª¿æ•´ï¼‰ -->
    <div class="checklist-overview-input">
      <textarea name="checklist_overview" rows="3">{{ checklist.checklist_overview }}</textarea>
    </div>
  </div>

  <div class="checklist-items">
    <img src="{% static 'codemon/images/backgrounds/checklist_blue_bg3.png' %}" alt="é …ç›®" onerror="this.style.display='none'">
    <!-- ç™½ã„éƒ¨åˆ†ã«ã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤º -->
    <div class="checklist-items-title">é …ç›®</div>
    <!-- é’ã„éƒ¨åˆ†ã«è¿½åŠ é …ç›®ãŒå…¥ã‚‹ã‚³ãƒ³ãƒ†ãƒŠï¼ˆJSãŒã“ã“ã«è¦ç´ ã‚’è¿½åŠ ã—ã¾ã™ï¼‰ -->
    <div id="items-container" aria-live="polite"></div>
  </div>

  <!-- å·¦å´ã®ç¸¦ä¸¦ã³ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å†…éƒ¨ã«å…¥ã‚Œã¦ submit ã‚’æœ‰åŠ¹ã«ã™ã‚‹ï¼‰ -->
  <div class="side-actions" aria-hidden="false">
    <!-- é …ç›®è¿½åŠ ï¼ˆJSã§å‡¦ç†ï¼‰ -->
    <button type="button" id="add-item" class="btn-add" aria-label="é …ç›®è¿½åŠ ">
      <img src="{% static 'codemon/images/nav/add_item.png' %}" alt="é …ç›®è¿½åŠ ">
    </button>

    <!-- ä¿å­˜ï¼ˆç”»åƒãƒœã‚¿ãƒ³ï¼‰ -->
    <button type="submit" name="show_confirm" value="1" class="btn-save" aria-label="ä¿å­˜">
      <img src="{% static 'codemon/images/nav/save.png' %}" alt="ä¿å­˜">
    </button>

    <!-- æˆ»ã‚‹ -->
    <a href="{% url 'codemon:checklist_selection' %}" class="btn-back" aria-label="æˆ»ã‚‹">
      <img src="{% static 'codemon/images/buttons/back.png' %}" alt="æˆ»ã‚‹">
    </a>
  </div>

  <!-- äº’æ›æ€§ã®ãŸã‚ã®ä¸­å¤®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã«æ®‹ã™ï¼‰ -->
  <div class="form-actions" style="display:none;">
    <a href="{% url 'codemon:checklist_selection' %}" class="btn-back" aria-label="æˆ»ã‚‹">
      <img src="{% static 'codemon/images/buttons/back.png' %}" alt="æˆ»ã‚‹">
    </a>
    <button type="submit" class="btn-save" aria-label="ä¿å­˜">
      <img src="{% static 'codemon/images/buttons/save.png' %}" alt="ä¿å­˜">
    </button>
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // account tab redirect for teachers
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    if (accountTab) accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}

  // dynamic item add/remove
  let itemIndex = {{ checklist.items.count }} + 1;
  const addBtn = document.getElementById('add-item');
  const container = document.getElementById('items-container');

  function removeItem(btn) { btn.parentElement.remove(); }

  if (addBtn && container) {
    addBtn.addEventListener('click', function() {
      const div = document.createElement('div');
      div.className = 'item-row';

      const input = document.createElement('input');
      input.type = 'text';
      input.name = `item_${itemIndex}`;
      input.value = '';
      input.placeholder = 'æ–°ã—ã„é …ç›®';

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.name = `done_${itemIndex}`;

      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'remove-item-btn';
      del.textContent = 'å‰Šé™¤';
      del.addEventListener('click', function() { div.remove(); });

      div.appendChild(input);
      div.appendChild(checkbox);
      div.appendChild(del);

      container.appendChild(div);

      // è¿½åŠ ç›´å¾Œã«å…¥åŠ›ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã€è¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      input.focus();
      div.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      itemIndex++;
    });
  }
});
</script>

{% endblock %}