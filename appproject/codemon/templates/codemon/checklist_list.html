{% extends 'base.html' %}
{% load static %}

{% block title %}チェックリスト一覧 - Codemon{% endblock %}
{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* ページ固有：ナビゲーションの高さ分だけコンテンツを下げる */
.content-wrapper { padding-top: 110px !important; }

/* ページヘッダー用画像 */
.page-hero { text-align: center; margin-bottom: 6px; }
.page-hero h1 { font-size: 44px; margin: 8px 0 18px; font-weight:800; }
.page-hero-img { display:block; margin: 0 auto 12px; }

/* コンテナ */
.checklist-list-container { max-width: 1100px; width: min(94vw,1100px); margin: 80px auto 120px; padding: 30px 36px; position: relative; z-index:20; background-color:transparent; border:none; border-radius:12px; }
.checklist-list-container h1 { text-align: center; margin-bottom: 8px; font-size:28px; }

/* テーブル（カード風の行に置き換え） */
.checklist-table { width: 100%; margin-top: 10px; }
.checklist-row { 
  display:flex; 
  align-items:center; 
  background: var(--row-background, transparent); 
  border-radius: var(--row-radius, 28px); 
  padding: var(--row-padding, 14px 18px); 
  margin: var(--row-margin, 12px 0); 
  width: var(--row-width, 100%);
  max-width: var(--row-max-width, 100%);
  min-height: var(--row-min-height, auto);
  transform: translate(var(--row-tx, 0), var(--row-ty, -70px)) scale(var(--row-scale, 1));
}
/* 表示されるチェックリスト行のみ、CSS変数で個別調整可能に */
.checklist-row.list-item {
  background: var(--row-background, transparent);
  border-radius: var(--row-radius, 28px);
  padding: var(--row-padding, 14px 18px);
  margin: var(--row-margin, 12px 0);
  width: var(--row-width, 100%);
  max-width: var(--row-max-width, 700px);
  min-height: var(--row-min-height, auto);
  transform: translate(var(--row-tx, 60px), var(--row-ty, -140px)) scale(var(--row-scale, 1));
}
.checklist-row.header { background:transparent; box-shadow:none; border-radius:4px; padding:8px 6px; margin-top:0; }
.checklist-cell { padding: 8px 12px; }
.checklist-name { flex:1; display:flex; align-items:center; gap:12px; font-weight:700; }
.checklist-meta { width:180px; text-align:center; color:#444; }
.checklist-updated { width:200px; text-align:center; color:#444; }
/* リストアイテム内の文字スタイルのみCSS変数で調整可能 */
.list-item .checklist-name {
  font-weight: var(--name-font-weight, 700);
  font-size: var(--name-font-size, 16px);
  color: var(--name-color, inherit);
  transform: translate(var(--name-tx, -10px), var(--name-ty, 0)) scale(var(--name-scale, 1));
}
.list-item .checklist-meta {
  color: var(--meta-color, #444);
  font-size: var(--meta-font-size, 14px);
  font-weight: var(--meta-font-weight, 400);
  transform: translate(var(--meta-tx, 110px), var(--meta-ty, 0)) scale(var(--meta-scale, 1));
}
.list-item .checklist-updated {
  color: var(--updated-color, #444);
  font-size: var(--updated-font-size, 14px);
  font-weight: var(--updated-font-weight, 400);
  transform: translate(var(--updated-tx, 90px), var(--updated-ty, 0)) scale(var(--updated-scale, 1));
}
.checklist-action { width:240px; text-align:center; }
.checklist-action .btn-view { display:inline-block; }
.no-items { text-align: center; color: #999; font-style: italic; padding: 40px 0 !important; }
.checklist-row.list-item {
  background-image: url("{% static 'codemon/images/backgrounds/checklist_list_bg.png' %}");
  background-repeat: var(--row-bg-repeat, no-repeat);
  background-position: var(--row-bg-pos, center);
  background-size: var(--row-bg-size, contain);
}
.checklist-tag { display:block; margin:0 auto; width: var(--tag-width, auto); max-width: var(--tag-max-width, 260px); height: var(--tag-height, 36px); object-fit: contain; transform: translate(var(--tag-tx, 0), var(--tag-ty, 0)) scale(var(--tag-scale, 1)); }
.checklist-tag-name { --tag-width: var(--tag-name-width, auto); --tag-max-width: var(--tag-name-max-width, 180px); --tag-height: var(--tag-name-height, 36px); --tag-tx: var(--tag-name-tx, -40px); --tag-ty: var(--tag-name-ty, -20px); --tag-scale: var(--tag-name-scale, 1); }
.checklist-tag-date { --tag-width: var(--tag-date-width, auto); --tag-max-width: var(--tag-date-max-width, 130px); --tag-height: var(--tag-date-height, 36px); --tag-tx: var(--tag-date-tx, -160px); --tag-ty: var(--tag-date-ty, -20px); --tag-scale: var(--tag-date-scale, 1); }
.checklist-tag-update { --tag-width: var(--tag-update-width, auto); --tag-max-width: var(--tag-update-max-width, 130px); --tag-height: var(--tag-update-height, 36px); --tag-tx: var(--tag-update-tx, -190px); --tag-ty: var(--tag-update-ty, -20px); --tag-scale: var(--tag-update-scale, 1); }
.checklist-line { display:block; width: var(--line-width, 100%); max-width: var(--line-max-width, 100%); height: var(--line-height, auto); margin: var(--line-margin, 6px 0 10px); object-fit: contain; transform: translate(var(--line-tx, 0), var(--line-ty, 0)) scale(var(--line-scale, 1)); }
.checklist-line-first { --line-width: var(--line-first-width, 100%); --line-max-width: var(--line-first-max-width, 763px); --line-height: var(--line-first-height, auto); --line-margin: var(--line-first-margin, 6px 0 10px); --line-tx: var(--line-first-tx, 20px); --line-ty: var(--line-first-ty, -120px); --line-scale: var(--line-first-scale, 1); }
.checklist-line-between { --line-width: var(--line-between-width, 100%); --line-max-width: var(--line-between-max-width, 100%); --line-height: var(--line-between-height, auto); --line-margin: var(--line-between-margin, 6px 0 10px); --line-tx: var(--line-between-tx, 0); --line-ty: var(--line-between-ty, 0); --line-scale: var(--line-between-scale, 1); }
.checklist-divider { padding: 0 6px; }

/* 閲覧ボタン(緑の丸角) */
.btn-view { 
  display:inline-block; 
  background: var(--btn-bg, #bfead8); 
  color: var(--btn-color, rgb(12, 12, 12)); 
  padding: var(--btn-padding, 10px 18px); 
  border-radius: var(--btn-radius, 20px); 
  text-decoration:none; 
  font-weight: var(--btn-font-weight, 700);
  font-size: var(--btn-font-size, 14px);
  width: var(--btn-width, auto);
  max-width: var(--btn-max-width, auto);
  height: var(--btn-height, auto);  white-space: nowrap;
  writing-mode: horizontal-tb;  transform: translate(var(--btn-tx, 60px), var(--btn-ty, 0)) scale(var(--btn-scale, 1));
}
.btn-view:hover { filter:brightness(var(--btn-hover-brightness, 0.96)); }

/* 戻るボタンコンテナもCSS変数で調整可能に */
.back-button-container {
  text-align: var(--back-align, left);
  margin-top: var(--back-margin-top, 20px);
  margin-left: var(--back-margin-left, 0);
  margin-right: var(--back-margin-right, 0);
  margin-bottom: var(--back-margin-bottom, 0);
  transform: translate(var(--back-tx, -75px), var(--back-ty, 55px)) scale(var(--back-scale, 1));
}
.back-button-container .btn-back img {
  height: var(--back-img-height, 56px);
  width: var(--back-img-width, auto);
}

@media (max-width:800px) {
  .checklist-meta, .checklist-updated, .checklist-action { width:auto; text-align:left; }
  .checklist-row { flex-direction:column; align-items:stretch; gap:8px; }
}

/* アクション（右上）: 作成ボタンなど */
.list-actions { 
  position: var(--actions-position, absolute); 
  right: var(--actions-right, 22px); 
  top: var(--actions-top, 22px); 
  display: var(--actions-display, flex); 
  gap: var(--actions-gap, 12px); 
  align-items: var(--actions-align, center);
  transform: translate(var(--actions-tx, 0), var(--actions-ty, 0)) scale(var(--actions-scale, 1));
}
.list-actions a, .list-actions button { 
  background: var(--actions-btn-bg, none); 
  border: var(--actions-btn-border, none); 
  padding: var(--actions-btn-padding, 0); 
  cursor: var(--actions-btn-cursor, pointer);
  transform: translate(var(--actions-btn-tx, 0), var(--actions-btn-ty, 0)) scale(var(--actions-btn-scale, 1));
}
.list-actions img { 
  height: var(--actions-img-height, 56px); 
  width: var(--actions-img-width, auto);
  display: var(--actions-img-display, block);
  transform: translate(var(--actions-img-tx, 0), var(--actions-img-ty, 0)) scale(var(--actions-img-scale, 1));
}

@media (max-width: 800px) {
  .checklist-list-container { margin: 80px 12px; }
  .list-actions img { height:44px; }
}

</style>
{% endblock %}

{% block content %}

<!-- ページヘッダー画像 -->

<div class="checklist-list-container">
  <div class="checklist-table">
    <div class="checklist-row header">
      <div class="checklist-cell checklist-name">
        <img src="{% static 'codemon/images/tags/checklist_list_name.png' %}" alt="チェックリスト名" class="checklist-tag checklist-tag-name">
      </div>
      <div class="checklist-cell checklist-meta">
        <img src="{% static 'codemon/images/tags/checklist_list_date.png' %}" alt="作成日" class="checklist-tag checklist-tag-date">
      </div>
      <div class="checklist-cell checklist-updated">
        <img src="{% static 'codemon/images/tags/checklist_list_update.png' %}" alt="更新日" class="checklist-tag checklist-tag-update">
      </div>
      <div class="checklist-cell checklist-action"></div>
    </div>

    <div class="checklist-divider">
      <img src="{% static 'codemon/images/tags/checklist_list_line.png' %}" alt="" class="checklist-line checklist-line-first" onerror="this.style.display='none'">
    </div>

    {% for checklist in checklists %}
      <div class="checklist-row list-item">
        <div class="checklist-cell checklist-name">
          <span>{{ checklist.checklist_name }}</span>
        </div>
        <div class="checklist-cell checklist-meta">{{ checklist.created_at|date:"Y/m/d H:i" }}</div>
        <div class="checklist-cell checklist-updated">{{ checklist.updated_at|date:"Y/m/d H:i" }}</div>
        <div class="checklist-cell checklist-action">
            <a href="{% url 'codemon:checklist_detail' pk=checklist.checklist_id %}" class="btn-view" aria-label="チェックリスト閲覧">
              <img src="{% static 'codemon/images/buttons/checklist_detail_button.png' %}" alt="" onerror="this.style.display='none'">
              <span class="btn-label">チェックリスト閲覧</span>
            </a>
        </div>
      </div>
    {% empty %}
      <div class="checklist-row"><div class="checklist-cell no-items" style="flex:1; text-align:center;">作成されたチェックリストはありません。</div></div>
    {% endfor %}
  </div>

  <!-- 戻るボタン（下部） -->
  <div class="back-button-container">
    <a href="{% url 'codemon:checklist_selection' %}" class="btn-back">
      <img src="{% static 'codemon/images/buttons/back.png' %}" alt="戻る" style="height:56px;">
    </a>
  </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    if (accountTab) accountTab.href = "{% url 'accounts:account_entry' %}";
  {% endif %}
  // Ensure chat bubble is attached to <body> so position:fixed is viewport-relative
  try {
    const chat = document.querySelector('.chat-ai-bubble');
    if (chat && chat.parentElement !== document.body) {
      document.body.appendChild(chat);
    }
  } catch(e) {
    console.error('chat bubble reposition failed', e);
  }
  
  // ページ読み込み時にチェックリスト位置までスクロール
  setTimeout(function() {
    const firstListItem = document.querySelector('.checklist-row.list-item');
    if (firstListItem) {
      firstListItem.scrollIntoView({ behavior: 'instant', block: 'center' });
    }
  }, 100);
});
</script>
{% endblock %}