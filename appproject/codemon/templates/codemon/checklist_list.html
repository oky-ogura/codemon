{% extends 'base.html' %}
{% load static %}

{% block title %}ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆä¸€è¦§ - Codemon{% endblock %}
{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.content-wrapper { padding-top: 100px !important; }

.checklist-list-container {
    max-width: 1000px;
    width: 92vw;
    margin: 0 auto;
    padding: 25px;
    background-color: rgba(255, 255, 255, 0.98);
    border-radius: 30px;
    border: 8px solid #ffffff;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    position: relative;
    z-index: 20;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 160px); 
    min-height: 500px;
}

/* --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆå›ºå®šï¼‰ --- */
.action-bar {
    flex-shrink: 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    gap: 10px;
}
.left-actions { display: flex; gap: 12px; }

/* å…±é€šãƒœã‚¿ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šãƒ›ãƒãƒ¼ã§æµ®ãä¸ŠãŒã‚‹ */
.btn-pop {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 22px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: 900;
    font-size: 14px;
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* ã·ã‚‹ã‚“ã¨ã—ãŸå‹•ã */
    border: none;
    cursor: pointer;
}
.btn-pop:hover {
    transform: translateY(-4px) scale(1.05); /* å°‘ã—æµ®ã„ã¦å¤§ãããªã‚‹ */
}

.btn-create { background: #3fbcd9; color: white; box-shadow: 0 5px 0 #2a8da4; }
.btn-create:hover { background: #4ad0ef; box-shadow: 0 7px 0 #2a8da4; }
.btn-create:active { transform: translateY(2px); box-shadow: 0 2px 0 #2a8da4; }

.btn-back-small { background: #ff7675; color: white; box-shadow: 0 5px 0 #e55a5a; }
.btn-back-small:hover { background: #ff8e8d; box-shadow: 0 7px 0 #e55a5a; }
.btn-back-small:active { transform: translateY(2px); box-shadow: 0 2px 0 #e55a5a; }

/* --- ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ --- */
.sort-controls { display: flex; background: #edf2f7; padding: 5px; border-radius: 50px; }
.btn-sort {
    padding: 6px 15px; border-radius: 50px; font-size: 12px; font-weight: 800;
    color: #718096; background: transparent; border: none; cursor: pointer;
    transition: all 0.2s;
}
.btn-sort:hover:not(.active) { background: rgba(255,255,255,0.5); color: #3fbcd9; }
.btn-sort.active { background: white; color: #3fbcd9; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

/* --- ãƒªã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ --- */
.checklist-header-row {
    flex-shrink: 0;
    background: #3fbcd9;
    display: flex;
    align-items: center; /* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã‚‚ä¸­å¤®æƒãˆ */
    padding: 12px 20px;
    border-radius: 15px 15px 8px 8px;
    color: #fff;
    font-weight: 900;
    margin-bottom: 8px;
}

/* --- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒªã‚¹ãƒˆ --- */
.checklist-scroll-area {
    flex-grow: 1;
    overflow-y: auto;
    padding-right: 8px;
}

.checklist-row.list-item {
    display: flex; 
    align-items: center; /* â† ã“ã‚Œã§ä¸Šä¸‹ã®ä¸­å¤®ã‚’æƒãˆã‚‹ */
    padding: 15px 20px;
    margin-bottom: 12px;
    background: #f8fafc;
    border-radius: 20px;
    border: 3px solid transparent;
    transition: all 0.2s;
}
.checklist-row.list-item.hidden { display: none; }
.checklist-row.list-item:hover { 
    background: white; 
    border-color: #3fbcd9; 
    transform: translateX(8px); /* ãƒ›ãƒãƒ¼ã§å°‘ã—æ¨ªã«ã‚¹ãƒ©ã‚¤ãƒ‰ */
    box-shadow: 5px 5px 15px rgba(0,0,0,0.05);
}

/* åå‰ã‚¨ãƒªã‚¢ */
.cell-name { 
    flex: 2; 
    min-width: 0; 
    font-weight: 800; 
    color: #2d3748;
    display: flex;
    align-items: center;
}
.name-scroll-container {
    display: block; 
    white-space: nowrap; 
    overflow-x: auto; 
    scrollbar-width: none; 
    -ms-overflow-style: none;
    line-height: 1.2; /* è¡Œã®é«˜ã•ã‚’æ•´ãˆã¦ã‚ºãƒ¬é˜²æ­¢ */
}
.name-scroll-container::-webkit-scrollbar { display: none; }

/* æ—¥ä»˜ãƒãƒƒã‚¸ */
.cell-date { flex: 1; text-align: center; }
.date-badge {
    display: inline-block;
    background: #e2e8f0;
    color: #4a5568;
    padding: 4px 12px;
    border-radius: 10px;
    font-size: 12px;
    font-weight: 800;
}
.date-badge.today {
    background: #ff9f43;
    color: white;
    box-shadow: 0 3px 0 #e67e22;
    transform: rotate(-1deg);
}

/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼šå‚ç›´ä¸­å¤®ã«å›ºå®š */
.cell-action { 
    width: 140px; 
    display: flex;
    justify-content: flex-end;
    align-items: center;
}
.btn-view {
    display: inline-block;
    background: #FFD200; 
    color: #333; 
    padding: 10px 18px; 
    border-radius: 50px;
    text-decoration: none; 
    font-weight: 900; 
    font-size: 13px; 
    box-shadow: 0 4px 0 #d9b300;
    transition: all 0.2s;
    line-height: 1; /* ãƒœã‚¿ãƒ³å†…ã®ãƒ†ã‚­ã‚¹ãƒˆä½ç½®ã‚’å›ºå®š */
}
.btn-view:hover {
    background: #ffe04d;
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 6px 0 #d9b300;
}
.btn-view:active {
    transform: translateY(2px);
    box-shadow: 0 1px 0 #d9b300;
}

/* --- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ --- */
.pagination-container {
    flex-shrink: 0;
    display: flex; justify-content: center; align-items: center;
    gap: 12px; padding-top: 15px; border-top: 3px dashed #edf2f7;
}
.page-btn {
    width: 42px; height: 42px; border-radius: 12px; border: none;
    background: #edf2f7; color: #4a5568; font-weight: 900; cursor: pointer; 
    transition: all 0.2s;
    box-shadow: 0 3px 0 #cbd5e0;
}
.page-btn:hover:not(.active) {
    background: #e2e8f0;
    transform: translateY(-2px);
}
.page-btn.active { 
    background: #3fbcd9; 
    color: white; 
    box-shadow: 0 4px 0 #2a8da4;
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .checklist-list-container { height: auto; max-height: 95vh; }
    .checklist-header-row { display: none; }
    .checklist-row.list-item { flex-direction: column; align-items: stretch; gap: 12px; }
    .cell-action { justify-content: center; width: 100%; }
    .btn-view { width: 100%; text-align: center; }
}
</style>
{% endblock %}

{% block content %}
<div class="checklist-list-container">
    <h1 style="text-align:center; color:#3fbcd9; font-weight:900; margin-bottom:20px; font-size: 26px; letter-spacing: 1px;">
        ğŸ” ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ãˆã‚‰ã¼ã†
    </h1>

    <div class="action-bar">
        <div class="left-actions">
            <a href="{% url 'codemon:checklist_selection' %}" class="btn-pop btn-back-small">
                â† ã‚‚ã©ã‚‹
            </a>
            <a href="{% url 'codemon:checklist_create' %}" class="btn-pop btn-create">
                ï¼‹ ã‚ãŸã‚‰ã—ã„ãƒªã‚¹ãƒˆã‚’ä½œã‚‹
            </a>
        </div>
        
        <div class="sort-controls">
            <button class="btn-sort active" onclick="handleSort('new')">æ–°ã—ã„é †</button>
            <button class="btn-sort" onclick="handleSort('old')">å¤ã„é †</button>
        </div>
    </div>

    <div class="checklist-header-row">
        <div class="cell-name">ãªã¾ãˆ</div>
        <div class="cell-date">ä½œã£ãŸæ—¥</div>
        <div class="cell-date">ã•ã„ã”ã®æ›´æ–°</div>
        <div class="cell-action"></div>
    </div>

    <div class="checklist-scroll-area" id="checklist-list">
        {% for checklist in checklists %}
        <div class="checklist-row list-item" 
             data-timestamp="{{ checklist.created_at|date:'U' }}"
             data-updated-timestamp="{{ checklist.updated_at|date:'U' }}">
            <div class="cell-name">
                <div class="name-scroll-container">
                    {{ checklist.checklist_name }}
                </div>
            </div>
            <div class="cell-date"><span class="date-badge create-date"></span></div>
            <div class="cell-date"><span class="date-badge update-date"></span></div>
            <div class="cell-action">
                <a href="{% url 'codemon:checklist_detail' pk=checklist.checklist_id %}" class="btn-view">
                    ãªã‹ã¿ã‚’è¦‹ã‚‹
                </a>
            </div>
        </div>
        {% empty %}
        <div style="text-align: center; padding: 50px; color: #a0aec0;">
            <p style="font-weight: 800;">ã¾ã ãƒªã‚¹ãƒˆãŒãªã„ã‚ˆã€‚<br>ä¸Šã®ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œã£ã¦ã¿ã¦ã­ï¼</p>
        </div>
        {% endfor %}
    </div>

    <div class="pagination-container" id="pagination"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// JSãƒ­ã‚¸ãƒƒã‚¯ã¯å‰å›åŒæ§˜ã§ã™ãŒã€å¿µã®ãŸã‚ãã®ã¾ã¾è¨˜è¼‰ã—ã¾ã™
let currentPage = 1;
const itemsPerPage = 10;

function getFriendlyDate(timestamp) {
    const now = Math.floor(Date.now() / 1000);
    const diff = now - timestamp;
    const oneDay = 86400;

    if (diff < oneDay) return "ãã‚‡ã†";
    if (diff < oneDay * 2) return "ãã®ã†";
    if (diff < oneDay * 7) return Math.floor(diff / oneDay) + "æ—¥å‰";
    
    const date = new Date(timestamp * 1000);
    return date.getFullYear() + "/" + (date.getMonth() + 1) + "/" + date.getDate();
}

function updateDates() {
    document.querySelectorAll('.list-item').forEach(item => {
        const createTs = item.getAttribute('data-timestamp');
        const updateTs = item.getAttribute('data-updated-timestamp');
        const createBadge = item.querySelector('.create-date');
        const updateBadge = item.querySelector('.update-date');

        const createText = getFriendlyDate(createTs);
        createBadge.innerText = createText;
        if (createText === "ãã‚‡ã†") createBadge.classList.add('today');

        const updateText = getFriendlyDate(updateTs);
        updateBadge.innerText = updateText;
        if (updateText === "ãã‚‡ã†") updateBadge.classList.add('today');
    });
}

function updateDisplay() {
    const list = document.getElementById('checklist-list');
    const items = Array.from(list.getElementsByClassName('list-item'));
    const totalPages = Math.ceil(items.length / itemsPerPage);

    items.forEach(item => item.classList.add('hidden'));
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    items.slice(start, end).forEach(item => item.classList.remove('hidden'));

    renderPagination(totalPages);
}

function renderPagination(totalPages) {
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    if (totalPages <= 1) return;
    for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        btn.onclick = () => { 
            currentPage = i; 
            updateDisplay(); 
            document.querySelector('.checklist-scroll-area').scrollTop = 0; 
        };
        pagination.appendChild(btn);
    }
}

function handleSort(order) {
    const list = document.getElementById('checklist-list');
    const items = Array.from(list.getElementsByClassName('list-item'));
    const buttons = document.querySelectorAll('.btn-sort');
    
    buttons.forEach(btn => btn.classList.toggle('active', 
        (order === 'new' && btn.innerText === 'æ–°ã—ã„é †') || 
        (order === 'old' && btn.innerText === 'å¤ã„é †')));

    items.sort((a, b) => {
        const timeA = parseInt(a.getAttribute('data-timestamp'));
        const timeB = parseInt(b.getAttribute('data-timestamp'));
        return order === 'new' ? timeB - timeA : timeA - timeB;
    });

    items.forEach(item => list.appendChild(item));
    currentPage = 1;
    updateDisplay();
}

document.addEventListener('DOMContentLoaded', () => {
    updateDates();
    updateDisplay();
});
</script>
{% endblock %}