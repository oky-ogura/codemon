{% extends 'base.html' %}
{% load static %}

{% block title %}ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆä¸€è¦§ - Codemon{% endblock %}

{% block extra_css %}
<style>
/* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.content-wrapper { padding-top: 100px !important; }

/* --- ãƒªã‚¹ãƒˆéƒ¨åˆ†ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰ --- */
.list-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    max-width: 1000px;
    margin: 0 auto 100px;
    padding: 20px;
    transition: opacity 0.4s ease;
}

.checklist-card {
    background: white;
    border-radius: 30px;
    border: 6px solid #ffffff;
    padding: 25px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
}

.checklist-card:hover {
    transform: translateY(-8px);
    border-color: #3fbcd9;
    box-shadow: 0 20px 40px rgba(63, 188, 217, 0.15);
}

.checklist-card h3 {
    margin: 0 0 12px 0;
    color: #3fbcd9;
    font-size: 20px;
    font-weight: 900;
}

.card-meta {
    font-size: 13px;
    color: #a0aec0;
    font-weight: 700;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼šç§»å‹•ä¸­ã®ã‚«ãƒ¼ãƒ‰ */
.checklist-card.fixed {
    position: fixed;
    z-index: 1000;
    pointer-events: none;
    box-shadow: 0 15px 40px rgba(0,0,0,0.2);
}

/* --- è©³ç´°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆä¸­å¤®ãƒ‘ãƒãƒ«ï¼‰ --- */
#detail-overlay {
    position: fixed;
    top: 50%;
    left: 55%;
    transform: translate(-50%, -50%) scale(0.8);
    width: 90%;
    max-width: 550px;
    max-height: 80vh;
    background: white;
    border-radius: 40px;
    border: 10px solid #ffffff;
    box-shadow: 0 40px 80px rgba(0,0,0,0.25);
    z-index: 900;
    display: none;
    flex-direction: column;
    padding: 30px;
    opacity: 0;
    transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
}

#detail-overlay.active {
    display: flex;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.detail-scroll-area {
    overflow-y: auto;
    flex-grow: 1;
    margin: 20px 0;
    padding-right: 10px;
}

/* --- ã‚¢ã‚¤ãƒ†ãƒ ã‚«ãƒ¼ãƒ‰ï¼ˆè©³ç´°å†…ï¼‰ --- */
.item-card {
    display: flex;
    align-items: center;
    background: #ffffff;
    border: 3px solid #f1f5f9;
    border-radius: 20px;
    padding: 15px 20px;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
}

.item-card:hover { border-color: #3fbcd9; background: #f0f9ff; }
.item-card.is-done { background: #f8fafc; border-color: transparent; }

/* ã‚«ã‚¹ã‚¿ãƒ ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.custom-checkbox {
    width: 32px; height: 32px;
    border: 4px solid #3fbcd9;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    background: white;
    margin-right: 15px;
    flex-shrink: 0;
}

input[type="checkbox"] { display: none; }

input[type="checkbox"]:checked + .custom-checkbox {
    background: #3fbcd9;
}

input[type="checkbox"]:checked + .custom-checkbox::after {
    content: "âœ“"; color: white; font-size: 20px; font-weight: 900;
}

.item-text { font-size: 18px; font-weight: 800; color: #2d3748; }
input[type="checkbox"]:checked ~ .item-text {
    text-decoration: line-through; color: #a0aec0;
}

/* --- æ¥ç¶šç·šç”¨SVG --- */
#connector-svg { position: fixed; inset: 0; pointer-events: none; z-index: 850; }
#connector-path {
    fill: none; stroke: #3fbcd9; stroke-width: 5;
    stroke-dasharray: 12, 8; animation: lineFlow 1s linear infinite;
    stroke-linecap: round; opacity: 0; transition: opacity 0.3s;
}
@keyframes lineFlow { to { stroke-dashoffset: -20; } }

/* --- ãƒœã‚¿ãƒ³ --- */
.btn-pop {
    padding: 12px 25px; border-radius: 50px; text-decoration: none;
    font-weight: 900; border: none; cursor: pointer;
    display: inline-flex; align-items: center; gap: 8px;
    transition: transform 0.2s;
}
.btn-pop:hover { transform: scale(1.05); }
.btn-back { background: #cbd5e0; color: #4a5568; }
.btn-edit { background: #FFD200; color: #333; }
</style>
{% endblock %}

{% block content %}
<div class="page-header" style="text-align: center; margin-bottom: 50px;">
    <h1 style="color: #3fbcd9; font-weight: 900; font-size: 32px;">ğŸ“ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ãˆã‚‰ã¼ã†</h1>
</div>

<svg id="connector-svg"><path id="connector-path"></path></svg>

<div class="list-container" id="list-grid">
    {% for checklist in checklists %}
    <div class="checklist-card" 
         onclick="openDetailMotion(this, '{{ checklist.checklist_name|escapejs }}', '{{ checklist.checklist_description|default:''|escapejs }}', {{ checklist.checklist_id }})">
        <h3>{{ checklist.checklist_name }}</h3>
        <div class="card-meta">ğŸ“… {{ checklist.created_at|date:"Y/m/d" }}</div>
    </div>
    {% empty %}
    <p style="text-align:center; color:#999;">ã¾ã ãªã„ã‚ˆã€‚ã¤ãã£ã¦ã¿ã‚ˆã†ï¼</p>
    {% endfor %}
</div>

<div id="detail-overlay">
    <h2 id="dt-title" style="color: #3fbcd9; margin: 0; font-size: 26px;"></h2>
    <p id="dt-desc" style="color: #718096; margin-top: 10px; font-weight: 600;"></p>
    
    <div class="detail-scroll-area" id="dt-items">
        </div>

    <div style="display: flex; gap: 10px; justify-content: center; padding-top: 10px;">
        <button class="btn-pop btn-back" onclick="closeDetailMotion()">âŒ ã¨ã˜ã‚‹</button>
        <a id="dt-edit-btn" href="#" class="btn-pop btn-edit">âœï¸ ã¸ã‚“ã—ã‚…ã†</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let activeCard = null;
const overlay = document.getElementById('detail-overlay');
const path = document.getElementById('connector-path');
const grid = document.getElementById('list-grid');

// CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ç”¨
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ğŸ’¡ è©³ç´°ã‚’é–‹ã
async function openDetailMotion(card, name, desc, id) {
    if (activeCard) return;
    activeCard = card;

    document.getElementById('dt-title').innerText = name;
    document.getElementById('dt-desc').innerText = desc;
    document.getElementById('dt-edit-btn').href = `/codemon/checklists/${id}/edit/`;
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    loadActualItems(id);

    const rect = card.getBoundingClientRect();
    card.style.width = rect.width + 'px';
    card.style.height = rect.height + 'px';
    card.style.top = rect.top + 'px';
    card.style.left = rect.left + 'px';
    card.dataset.origTop = rect.top;
    card.dataset.origLeft = rect.left;
    card.classList.add('fixed');

    setTimeout(() => {
        card.style.transition = "all 0.6s cubic-bezier(0.19, 1, 0.22, 1)";
        card.style.top = "100px";
        card.style.left = "40px";
        card.style.width = "200px";
        card.style.transform = "rotate(-5deg) scale(0.9)";
        grid.style.opacity = "0.2";
        overlay.classList.add('active');
        setTimeout(drawCurve, 500);
    }, 10);
}

// ğŸ’¡ ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
async function loadActualItems(checklistId) {
    const container = document.getElementById('dt-items');
    container.innerHTML = "<p style='text-align:center; padding:20px;'>ã•ãŒã—ã¦ã‚‹ã‚ˆ...</p>";

    try {
        // â€»ã“ã®APIç”¨URLãŒæœªå®Ÿè£…ã®å ´åˆã¯ã€views.pyã§ä½œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
        const response = await fetch(`/codemon/api/checklists/${checklistId}/items/`);
        const data = await response.json();
        container.innerHTML = "";

        if (data.items.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#999;'>é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>";
            return;
        }

        data.items.forEach(item => {
            const label = document.createElement('label');
            label.className = `item-card ${item.is_done ? 'is-done' : ''}`;
            // idã®ã‚­ãƒ¼åã¯Djangoã®ãƒ¢ãƒ‡ãƒ«ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„
            const itemId = item.checklist_item_id || item.id;
            
            label.innerHTML = `
                <div class="checkbox-wrapper">
                    <input type="checkbox" ${item.is_done ? 'checked' : ''} 
                           onchange="handleToggle(this, ${checklistId}, ${itemId})">
                    <div class="custom-checkbox"></div>
                </div>
                <span class="item-text">${item.item_text}</span>
            `;
            container.appendChild(label);
        });
    } catch (e) {
        container.innerHTML = "<p style='color:red;'>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>";
    }
}

// ğŸ’¡ ãƒã‚§ãƒƒã‚¯ã®ä¿å­˜ï¼ˆè©³ç´°ç”»é¢ã®é–¢æ•°ã‚’æµç”¨ï¼‰
function handleToggle(checkbox, checklistId, itemId) {
    const card = checkbox.closest('.item-card');
    card.classList.toggle('is-done', checkbox.checked);

    fetch(`/codemon/checklists/${checklistId}/items/${itemId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 'is_done': checkbox.checked })
    }).catch(error => {
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        checkbox.checked = !checkbox.checked;
        card.classList.toggle('is-done');
    });
}

function drawCurve() {
    if (!activeCard) return;
    const cardRect = activeCard.getBoundingClientRect();
    const detailRect = overlay.getBoundingClientRect();
    const startX = cardRect.right;
    const startY = cardRect.top + cardRect.height / 2;
    const endX = detailRect.left;
    const endY = detailRect.top + detailRect.height / 2;
    const cpX = (startX + endX) / 2;
    path.setAttribute('d', `M ${startX} ${startY} Q ${cpX} ${startY}, ${endX} ${endY}`);
    path.style.opacity = "1";
}

function closeDetailMotion() {
    overlay.classList.remove('active');
    path.style.opacity = "0";
    grid.style.opacity = "1";
    activeCard.style.top = activeCard.dataset.origTop + 'px';
    activeCard.style.left = activeCard.dataset.origLeft + 'px';
    activeCard.style.width = "";
    activeCard.style.transform = "rotate(0deg) scale(1)";
    setTimeout(() => {
        activeCard.classList.remove('fixed');
        activeCard.style.transition = "none";
        activeCard = null;
    }, 600);
}

window.addEventListener('resize', () => { if(activeCard) drawCurve(); });
</script>
{% endblock %}