{% extends 'base.html' %}
{% load static %}

{% block title %}ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆä¸€è¦§ - Codemon{% endblock %}
{% block body_class %} class="no-scroll"{% endblock %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" class="bg-frame frame-green" onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* --- å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.content-wrapper { padding-top: 100px !important; }
.checklist-list-container {
    max-width: 1000px; width: 92vw; margin: 0 auto; padding: 25px;
    background-color: rgba(255, 255, 255, 0.98); border-radius: 30px; border: 8px solid #ffffff;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1); position: relative; z-index: 20;
    display: flex; flex-direction: column; height: calc(100vh - 160px); min-height: 500px;
}

/* --- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ & ãƒœã‚¿ãƒ³ --- */
.action-bar { flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
.left-actions { display: flex; gap: 12px; }

.btn-pop {
    display: inline-flex; align-items: center; gap: 8px; padding: 10px 22px; border-radius: 50px;
    text-decoration: none; font-weight: 900; font-size: 14px; 
    transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border: none; cursor: pointer; user-select: none;
}
.btn-pop:hover { transform: translateY(-4px) scale(1.05); }
.btn-pop:active { transform: translateY(0) scale(0.95); }

.btn-create { background: #3fbcd9; color: white; box-shadow: 0 5px 0 #2a8da4; }
.btn-back-small { background: #ff7675; color: white; box-shadow: 0 5px 0 #e55a5a; }

/* ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ */
.sort-controls { display: flex; background: #edf2f7; padding: 5px; border-radius: 50px; }
.btn-sort {
    padding: 6px 15px; border-radius: 50px; font-size: 12px; font-weight: 800;
    color: #718096; background: transparent; border: none; cursor: pointer; transition: 0.2s;
}
.btn-sort.active { background: white; color: #3fbcd9; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

/* --- ãƒªã‚¹ãƒˆãƒ‡ã‚¶ã‚¤ãƒ³ --- */
.checklist-header-row {
    flex-shrink: 0; background: #3fbcd9; display: flex; padding: 12px 20px;
    border-radius: 15px 15px 8px 8px; color: #fff; font-weight: 900; margin-bottom: 8px;
}
.checklist-scroll-area { flex-grow: 1; overflow-y: auto; padding-right: 8px; }

.checklist-card {
    display: flex; align-items: center; padding: 15px 20px; margin-bottom: 12px;
    background: #f8fafc; border-radius: 20px; transition: all 0.2s; cursor: pointer;
    position: relative; /* ãƒãƒƒã‚¸ã®é…ç½®ç”¨ */
}
.checklist-card:hover { transform: translateX(8px); background: white; box-shadow: 5px 5px 15px rgba(0,0,0,0.05); }

.cell-name { flex: 2; font-weight: 800; color: #2d3748; }
.cell-date { flex: 1; text-align: center; }
.cell-action { width: 140px; display: flex; justify-content: flex-end; }
.date-badge { display: inline-block; background: #e2e8f0; color: #4a5568; padding: 4px 12px; border-radius: 10px; font-size: 12px; font-weight: 800; }
.btn-view { background: #FFD200; color: #333; padding: 8px 16px; border-radius: 50px; font-weight: 900; box-shadow: 0 4px 0 #d9b300; }

/* --- è©³ç´°è¡¨ç¤ºç”¨ (z-indexç®¡ç†ã‚’å¾¹åº•) --- */
#detail-backdrop {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); 
    z-index: 500; display: none; opacity: 0; transition: opacity 0.4s;
}
/* ã‚¿ã‚¤ãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ (æœ€å‰é¢) */
.checklist-card.fixed {
    position: fixed; z-index: 1000; pointer-events: none;
    background: white; border: 5px solid #3fbcd9; border-radius: 60px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    overflow: hidden; /* ã¯ã¿å‡ºã—é˜²æ­¢ */
}
.checklist-card.fixed .cell-name { font-size: 18px; color: #3fbcd9; font-weight: 900; text-align: center; }
.checklist-card.fixed .cell-date, .checklist-card.fixed .cell-action { display: none; }

.card-placeholder { height: 72px; margin-bottom: 12px; visibility: hidden; }

/* èª¬æ˜æ–‡ã‚«ãƒ¼ãƒ‰ & ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
#fixed-desc-card {
    position: fixed; left: 40px; top: 210px; width: 280px;
    background: white; border-radius: 25px; padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 900; display: none;
}
#detail-actions {
    position: fixed; left: 40px; bottom: 60px; display: flex; flex-direction: column; gap: 12px; z-index: 900; display: none;
}

/* å³å´ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ */
#detail-items-container {
    position: fixed; right: 5%; top: 100px; width: 55%; height: 80vh;
    overflow-y: auto; z-index: 900; display: none; padding: 20px;
}
.item-card {
    display: flex; align-items: center; background: white; border: 4px solid #f1f5f9;
    border-radius: 20px; padding: 18px 25px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
}

/* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
.custom-checkbox {
    width: 32px; height: 32px; border: 4px solid #3fbcd9; border-radius: 10px;
    margin-right: 15px; background: white; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
}
input[type="checkbox"] { display: none; }
input[type="checkbox"]:checked + .custom-checkbox { background: #3fbcd9; }
input[type="checkbox"]:checked + .custom-checkbox::after { content: "âœ“"; color: white; font-size: 20px; font-weight: 900; }
.item-text { font-size: 18px; font-weight: 800; color: #2d3748; }
input[type="checkbox"]:checked ~ .item-text { text-decoration: line-through; color: #a0aec0; }

/* ã‚³ãƒã‚¯ã‚¿ãƒ¼ï¼ˆç·šãŒä¼¸ã³ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ */
#connector-svg { position: fixed; inset: 0; pointer-events: none; z-index: 800; width: 100vw; height: 100vh; }
.connector-path { 
    fill: none; stroke: #3fbcd9; stroke-width: 4; stroke-dasharray: 8, 8; 
    /* åˆæœŸçŠ¶æ…‹ã¯ç·šã‚’éš ã™ï¼ˆå¾Œã§JSã§ä¸Šæ›¸ãï¼‰ */
    stroke-dashoffset: 0;
}
/* æãçµ‚ã‚ã£ãŸå¾Œã®æµã‚Œã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
.connector-path.flow-active { animation: flow 1s linear infinite; }
@keyframes flow { to { stroke-dashoffset: -16; } }

.completed-badge {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
    background: linear-gradient(135deg, #FFD700, #FFA500); color: white;
    padding: 5px 15px; border-radius: 50px; font-size: 12px; font-weight: 900;
    box-shadow: 0 3px 10px rgba(255, 165, 0, 0.3);
    animation: badgePulse 2s infinite;
    pointer-events: none; /* ã‚¯ãƒªãƒƒã‚¯ã‚’é€é */
    z-index: 10;
}
@keyframes badgePulse {
    0%, 100% { transform: translateY(-50%) scale(1); }
    50% { transform: translateY(-50%) scale(1.05); }
}

/* é”æˆæ¸ˆã¿ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
.checklist-card.completed {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 2px solid #3fbcd9;
}
.checklist-card.completed .cell-name {
    color: #0891b2;
    margin-left: 90px; /* ãƒãƒƒã‚¸åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ */
}

@media (max-width: 768px) {
    #detail-items-container { width: 90%; left: 5%; top: 320px; height: 45vh; }
    #fixed-desc-card { width: 90%; left: 5%; top: 190px; }
}
</style>
{% endblock %}

{% block content %}
<div id="detail-backdrop" onclick="closeDetailMotion()"></div>

<div class="checklist-list-container" id="main-container">
    <h1 style="text-align:center; color:#3fbcd9; font-weight:900; margin-bottom:20px; font-size: 26px;">ğŸ” ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ãˆã‚‰ã¼ã†</h1>

    <div class="action-bar">
        <div class="left-actions">
            <a href="{% url 'codemon:checklist_selection' %}" class="btn-pop btn-back-small">â† ã‚‚ã©ã‚‹</a>
            <a href="{% url 'codemon:checklist_create' %}" class="btn-pop btn-create">ï¼‹ ã‚ãŸã‚‰ã—ã„ãƒªã‚¹ãƒˆã‚’ä½œã‚‹</a>
        </div>
        <div class="sort-controls">
            <button class="btn-sort active" id="sort-new" onclick="handleSort('new')">æ–°ã—ã„é †</button>
            <button class="btn-sort" id="sort-old" onclick="handleSort('old')">å¤ã„é †</button>
            <button class="btn-sort" id="sort-deadline" onclick="handleSort('deadline')">æœŸé™ãŒè¿‘ã„é †</button>
        </div>
        <div class="sort-controls" style="margin-left: 10px;">
            <button class="btn-sort" id="filter-completed" onclick="toggleCompleted()">âœ“ é”æˆæ¸ˆã¿ã‚’é™¤ã</button>
        </div>
    </div>

    <div class="checklist-header-row">
        <div class="cell-name">ãªã¾ãˆ</div>
        <div class="cell-date">ä½œã£ãŸæ—¥</div>
        <div class="cell-date">ã•ã„ã”ã®æ›´æ–°</div>
        <div class="cell-action"></div>
    </div>

    <div class="checklist-scroll-area" id="list-grid">
        {% for checklist in checklists %}
        <div class="checklist-card list-item" 
             data-id="{{ checklist.checklist_id }}"
             data-timestamp="{{ checklist.created_at|date:'U' }}"
             data-updated-timestamp="{{ checklist.updated_at|date:'U' }}"
             data-due-date="{% if checklist.due_date %}{{ checklist.due_date|date:'U' }}{% else %}9999999999{% endif %}"
             data-completed="false"
             onclick="openDetailMotion(this, '{{ checklist.checklist_name|escapejs }}', '{{ checklist.checklist_description|default:''|escapejs }}')">
            <div class="cell-name">{{ checklist.checklist_name }}</div>
            <div class="cell-date"><span class="date-badge create-date"></span></div>
            <div class="cell-date"><span class="date-badge update-date"></span></div>
            <div class="cell-action"><span class="btn-view">ã¿ã‚‹</span></div>
            <div class="completed-badge" style="display: none;">âœ“ é”æˆæ¸ˆã¿</div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="fixed-desc-card"></div>
<div id="detail-items-container"><div id="dt-items-list"></div></div>

<div id="detail-actions">
    <button class="btn-pop" style="background:#fff; color:#4a5568; box-shadow: 0 4px 0 #ddd;" onclick="closeDetailMotion()">âŒ ã¨ã˜ã‚‹</button>
    <a id="dt-edit-btn" href="#" class="btn-pop btn-create">âœï¸ ã¸ã‚“ã—ã‚…ã†</a>
    <a id="dt-delete-btn" href="#" class="btn-pop btn-back-small">ğŸ—‘ï¸ ã‘ã™</a>
</div>

<svg id="connector-svg"></svg>
{% endblock %}

{% block extra_js %}
<script>
let activeCard = null;
let placeholder = null;
const backdrop = document.getElementById('detail-backdrop');
const descCard = document.getElementById('fixed-desc-card');
const itemsContainer = document.getElementById('detail-items-container');
const actions = document.getElementById('detail-actions');
const svg = document.getElementById('connector-svg');

// æ—¥ä»˜æ›´æ–°
function updateDates() {
    const getFriendlyDate = (ts) => {
        const diff = Math.floor(Date.now() / 1000) - ts;
        if (diff < 86400) return "ãã‚‡ã†";
        if (diff < 172800) return "ãã®ã†";
        const d = new Date(ts * 1000);
        return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
    };
    document.querySelectorAll('.list-item').forEach(item => {
        item.querySelector('.create-date').innerText = getFriendlyDate(item.dataset.timestamp);
        item.querySelector('.update-date').innerText = getFriendlyDate(item.dataset.updatedTimestamp);
    });
}

// ã‚½ãƒ¼ãƒˆ
let hideCompleted = false;

function handleSort(order) {
    const list = document.getElementById('list-grid');
    const items = Array.from(list.getElementsByClassName('list-item'));
    document.querySelectorAll('.btn-sort:not(#filter-completed)').forEach(btn => btn.classList.remove('active'));
    
    if (order === 'new') {
        document.getElementById('sort-new').classList.add('active');
        items.sort((a, b) => b.dataset.timestamp - a.dataset.timestamp);
    } else if (order === 'old') {
        document.getElementById('sort-old').classList.add('active');
        items.sort((a, b) => a.dataset.timestamp - b.dataset.timestamp);
    } else if (order === 'deadline') {
        document.getElementById('sort-deadline').classList.add('active');
        items.sort((a, b) => {
            const dueA = parseInt(a.dataset.dueDate);
            const dueB = parseInt(b.dataset.dueDate);
            // æœŸé™ãŒãªã„ï¼ˆ9999999999ï¼‰ã‚‚ã®ã¯å¾Œã‚ã«
            return dueA - dueB;
        });
    }
    
    items.forEach(item => list.appendChild(item));
    applyCompletedFilter();
}

function toggleCompleted() {
    hideCompleted = !hideCompleted;
    const btn = document.getElementById('filter-completed');
    if (hideCompleted) {
        btn.classList.add('active');
    } else {
        btn.classList.remove('active');
    }
    applyCompletedFilter();
}

function applyCompletedFilter() {
    document.querySelectorAll('.list-item').forEach(item => {
        const isCompleted = item.dataset.completed === 'true';
        if (hideCompleted && isCompleted) {
            item.style.display = 'none';
        } else {
            item.style.display = 'flex';
        }
    });
}

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
async function openDetailMotion(card, name, desc) {
    if (activeCard) return;
    
    // 1. ç§»å‹•å‰ã®çµ¶å¯¾ä½ç½®ã‚’è¨˜éŒ²
    const rect = card.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    activeCard = card;
    const id = card.dataset.id;

    // 2. å…ƒã®å ´æ‰€ã«ç©´ãŒé–‹ã‹ãªã„ã‚ˆã†ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æŒ¿å…¥
    placeholder = document.createElement('div');
    placeholder.className = 'card-placeholder';
    card.parentNode.insertBefore(placeholder, card);

    // 3. é‡è¦ï¼šã‚«ãƒ¼ãƒ‰ã‚’ body ç›´ä¸‹ã«ç§»å‹•ã—ã¦ã€Œz-index ã®å£ã€ã‚’çªç ´ã™ã‚‹
    card.style.width = rect.width + 'px';
    card.style.height = rect.height + 'px';
    card.style.top = (rect.top + scrollTop) + 'px';
    card.style.left = (rect.left + scrollLeft) + 'px';
    card.style.margin = "0"; // ä½™è¨ˆãªãƒãƒ¼ã‚¸ãƒ³ã‚’æ¶ˆå»
    card.classList.add('fixed');
    document.body.appendChild(card); // ã“ã“ã§è¦ªè¦ç´ ã‹ã‚‰ç‹¬ç«‹ï¼

    // 4. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¼”å‡º
    backdrop.style.display = 'block';
    setTimeout(() => {
        backdrop.style.opacity = '1';
        card.style.transition = "all 0.6s cubic-bezier(0.19, 1, 0.22, 1)";
        
        // ç›®çš„åœ°ï¼ˆç”»é¢å·¦ä¸Šã®æ–¹ï¼‰
        card.style.top = "100px";
        card.style.left = "40px";
        card.style.width = "280px";
        card.style.height = "70px";

        if (desc) {
            descCard.innerHTML = `<h4 style="margin:0 0 10px 0; color:#3fbcd9; font-weight:900;">ğŸ“ ãƒ¡ãƒ¢</h4><p style="margin:0; font-size:14px; color:#4a5568;">${desc}</p>`;
            descCard.style.display = 'block';
        }
        actions.style.display = 'flex';
        document.getElementById('dt-edit-btn').href = `/codemon/checklists/${id}/edit/`;
        document.getElementById('dt-delete-btn').href = `/codemon/checklists/${id}/delete/`;
        
        loadItems(id);
    }, 10);
}
// ã‚¢ã‚¤ãƒ†ãƒ èª­ã¿è¾¼ã¿
async function loadItems(checklistId) {
    const list = document.getElementById('dt-items-list');
    list.innerHTML = "<p style='text-align:center; color:white; padding-top:40px;'>èª­ã¿è¾¼ã¿ä¸­...</p>";
    itemsContainer.style.display = 'block';
    
    try {
        const response = await fetch(`/codemon/api/checklists/${checklistId}/items/`);
        const data = await response.json();
        list.innerHTML = "";
        
        // å®Œäº†çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        const allCompleted = data.items.length > 0 && data.items.every(item => item.is_done);
        const card = document.querySelector(`[data-id="${checklistId}"]`);
        if (card) {
            card.dataset.completed = allCompleted;
            updateCompletedUI(card, allCompleted);
        }
        
        data.items.forEach((item) => {
            const label = document.createElement('label');
            label.className = `item-card ${item.is_done ? 'is-done' : ''}`;
            label.innerHTML = `
                <input type="checkbox" ${item.is_done ? 'checked' : ''} onchange="handleToggle(this, ${checklistId}, ${item.checklist_item_id || item.id})">
                <div class="custom-checkbox"></div>
                <span class="item-text">${item.item_text}</span>
            `;
            list.appendChild(label);
        });

        // ã‚«ãƒ¼ãƒ‰ãŒç›®çš„åœ°ã«åˆ°ç€ã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ç·šã‚’æç”»ï¼ˆ0.6s transition + ä½™è£•åˆ†ï¼‰
        setTimeout(() => {
            drawCurves(true);
        }, 650);

        itemsContainer.addEventListener('scroll', () => drawCurves(false));
    } catch (e) { list.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"; }
}
// ç·šã‚’æç”»ã™ã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°
function drawCurves(isInitial = false) {
    svg.innerHTML = "";
    if (!activeCard) return;

    // ç¾åœ¨ã®æ­£ç¢ºãªä½ç½®ã‚’å†å–å¾—
    const startRect = activeCard.getBoundingClientRect();
    const startX = startRect.right; // ã‚«ãƒ¼ãƒ‰ã®å³ç«¯ã‚®ãƒªã‚®ãƒªã‹ã‚‰
    const startY = startRect.top + (startRect.height / 2); // ã‚«ãƒ¼ãƒ‰ã®å‚ç›´æ–¹å‘ã®ä¸­å¿ƒ

    document.querySelectorAll('.item-card').forEach((item, index) => {
        const rect = item.getBoundingClientRect();
        // ç”»é¢å¤–ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ã¯ç·šã‚’å¼•ã‹ãªã„
        if (rect.top < 0 || rect.bottom > window.innerHeight) return;

        const endX = rect.left;
        const endY = rect.top + (rect.height / 2);
        const cpX = startX + (endX - startX) * 0.5; // ä¸­é–“åœ°ç‚¹ï¼ˆåˆ¶å¾¡ç‚¹ï¼‰

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        const d = `M ${startX} ${startY} C ${cpX} ${startY}, ${cpX} ${endY}, ${endX} ${endY}`;
        path.setAttribute("d", d);
        path.setAttribute("class", "connector-path");
        svg.appendChild(path);

        if (isInitial) {
            const length = path.getTotalLength();
            path.style.strokeDasharray = length;
            path.style.strokeDashoffset = length;
            
            setTimeout(() => {
                path.style.transition = `stroke-dashoffset 0.6s ease-out`;
                path.style.strokeDashoffset = "0";
                setTimeout(() => {
                    path.classList.add('flow-active');
                    path.style.strokeDasharray = "8, 8";
                }, 600);
            }, index * 80); // é †ã€…ã«ã‚¹ãƒ«ã‚¹ãƒ«ã¨å‡ºã™
        } else {
            path.classList.add('flow-active');
        }
    });
}
// é–‰ã˜ã‚‹
function closeDetailMotion() {
    if (!activeCard) return;
    
    backdrop.style.opacity = '0';
    descCard.style.display = 'none';
    itemsContainer.style.display = 'none';
    actions.style.display = 'none';
    svg.innerHTML = "";

    // 1. ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã®ä½ç½®ï¼ˆå…ƒã®å ´æ‰€ï¼‰ã‚’å–å¾—
    const pRect = placeholder.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    // 2. å…ƒã®å ´æ‰€ã«æˆ»ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    activeCard.style.top = (pRect.top + scrollTop) + 'px';
    activeCard.style.left = pRect.left + 'px';
    activeCard.style.width = placeholder.offsetWidth + 'px';
    activeCard.style.height = placeholder.offsetHeight + 'px';

    setTimeout(() => {
        // 3. å®Œå…¨ã«å…ƒé€šã‚Šã«ã™ã‚‹
        activeCard.classList.remove('fixed');
        activeCard.style.transition = "none";
        activeCard.style.width = "";
        activeCard.style.height = "";
        activeCard.style.top = "";
        activeCard.style.left = "";
        
        // 4. ã‚«ãƒ¼ãƒ‰ã‚’å…ƒã®ãƒªã‚¹ãƒˆå†…ã«æˆ»ã™
        placeholder.parentNode.insertBefore(activeCard, placeholder);
        placeholder.remove();
        
        backdrop.style.display = 'none';
        activeCard = null;
    }, 600);
}

// ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹å¤‰æ›´ã‚’å‡¦ç†
async function handleToggle(checkbox, checklistId, itemId) {
    try {
        const response = await fetch(`/codemon/checklists/${checklistId}/items/${itemId}/toggle/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ is_done: checkbox.checked })
        });
        
        if (response.ok) {
            // å®Œäº†çŠ¶æ…‹ã‚’å†è¨ˆç®—
            const allCheckboxes = document.querySelectorAll(`#dt-items-list input[type="checkbox"]`);
            const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
            const isCompleted = allChecked && allCheckboxes.length > 0;
            
            const card = document.querySelector(`[data-id="${checklistId}"]`);
            if (card) {
                card.dataset.completed = isCompleted;
                updateCompletedUI(card, isCompleted);
                applyCompletedFilter(); // ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
            }
        }
    } catch (error) {
        console.error('ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// é”æˆæ¸ˆã¿UIã‚’æ›´æ–°
function updateCompletedUI(card, isCompleted) {
    const badge = card.querySelector('.completed-badge');
    if (isCompleted) {
        card.classList.add('completed');
        if (badge) badge.style.display = 'block';
    } else {
        card.classList.remove('completed');
        if (badge) badge.style.display = 'none';
    }
}

// CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å…¨ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®é”æˆçŠ¶æ…‹ã‚’ç¢ºèª
async function checkAllCompletionStates() {
    const cards = document.querySelectorAll('.list-item');
    for (const card of cards) {
        const checklistId = card.dataset.id;
        try {
            const response = await fetch(`/codemon/api/checklists/${checklistId}/items/`);
            const data = await response.json();
            const allCompleted = data.items.length > 0 && data.items.every(item => item.is_done);
            card.dataset.completed = allCompleted;
            updateCompletedUI(card, allCompleted);
        } catch (e) {
            console.error('ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆçŠ¶æ…‹ç¢ºèªã‚¨ãƒ©ãƒ¼:', e);
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    updateDates();
    checkAllCompletionStates(); // é”æˆçŠ¶æ…‹ã‚’ç¢ºèª
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('dt-delete-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (activeCard) {
            const checklistId = activeCard.dataset.id;
            window.location.href = `/codemon/checklists/${checklistId}/delete/confirm/`;
        }
    });
});
</script>
{% endblock %}