{% extends 'base.html' %}
{% load static %}

{% block background_frame %}
  <img src="{% static 'codemon/images/frames/bg_frame_green.png' %}" 
       alt="" 
       class="bg-frame frame-green"
       onerror="this.style.display='none';">
{% endblock %}

{% block extra_css %}
<style>
/* ===== ãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ ===== */
.chat-ai-bubble { position: fixed; bottom: 20px; right: 20px; }
.chat-button { display: inline-flex; align-items: center; gap: 6px; padding: 10px 15px; background-color: #007bff; color: white; text-decoration: none; border-radius: 20px; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
.chat-button:hover { background-color: #0056b3; }

/* ===== ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ ===== */
.checklist-edit-container { max-width: 800px; margin: 40px auto; padding: 30px; border: 1px solid #e0e0e0; border-radius: 10px; background-color: #fafafa; }
.checklist-edit-container h2 { text-align: center; margin-bottom: 25px; }

/* ===== ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæƒ…å ±è¡¨ç¤º ===== */
.checklist-details { background-color: #f8f9fa; border: 1px solid #ddd; padding: 15px 20px; border-radius: 6px; margin-bottom: 25px; }
.checklist-details p { margin: 10px 0; font-size: 1rem; }
.checklist-items { list-style: disc; margin-left: 20px; margin-bottom: 20px; }
.checklist-items li { margin-bottom: 6px; }

/* ===== ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ ===== */
.form-actions { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
.btn-save, .btn-back { padding: 0; border: none; background: none; cursor: pointer; }
.btn-save img, .btn-back img { height:56px; }
.btn-save img:hover { filter:brightness(0.97); }

/* ãƒšãƒ¼ã‚¸å›ºæœ‰ï¼šãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®é«˜ã•åˆ†ã ã‘ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä¸‹ã’ã‚‹ */
.content-wrapper { padding-top: 140px !important; }

</style>
{% endblock %}

{% block content %}

<!-- ğŸ’¬ AIãƒãƒ£ãƒƒãƒˆãƒœã‚¿ãƒ³ -->
<div class="chat-ai-bubble">
  <a href="{% url 'codemon:chat' %}" class="chat-button">
    <i class="fas fa-comments"></i> AIãƒãƒ£ãƒƒãƒˆ
  </a>
</div>

<!-- ğŸ§¾ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç¢ºèªãƒ»ä¿å­˜ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="checklist-edit-container">
  <h2>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã®å†…å®¹ç¢ºèª</h2>

  <div class="checklist-details">
    <p><strong>ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆåï¼š</strong> {{ checklist_name }}</p>
    <p><strong>æ¦‚è¦ï¼š</strong> {{ checklist_description|default:"(ãªã—)" }}</p>
  </div>

  <h3>é …ç›®ä¸€è¦§</h3>
  <ul class="checklist-items">
    {% for item in items %}
      <li>
        {{ item.text }} {% if item.done %}(å®Œäº†){% endif %}
      </li>
    {% empty %}
      <li>é …ç›®ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>
    {% endfor %}
  </ul>

  <form method="POST" action="{% url 'codemon:checklist_save' pk=checklist.checklist_id %}">
    {% csrf_token %}
    <input type="hidden" name="checklist_name" value="{{ checklist_name }}">
    <input type="hidden" name="checklist_description" value="{{ checklist_description }}">
    {% for item in items %}
      <input type="hidden" name="item_{{ forloop.counter }}" value="{{ item.text }}">
      <input type="hidden" name="done_{{ forloop.counter }}" value="{% if item.done %}on{% endif %}">
    {% endfor %}

    <div class="form-actions">
      <button type="submit" name="confirm_save" value="1" class="btn-save" aria-label="ç¢ºå®šä¿å­˜">
        <img src="{% static 'codemon/images/buttons/edit.png' %}" alt="ç¢ºå®šä¿å­˜">
      </button>
      <a href="{% url 'codemon:checklist_edit' pk=checklist.checklist_id %}" class="btn-back" aria-label="ç·¨é›†ã«æˆ»ã‚‹">
        <img src="{% static 'codemon/images/buttons/back.png' %}" alt="ç·¨é›†ã«æˆ»ã‚‹">
      </a>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountTab = document.getElementById('account-tab');
  {% if request.user.role == 'teacher' %}
    if (accountTab) accountTab.href = "{% url 'accounts:teacher_home' %}";
  {% endif %}
  // Ensure chat bubble is attached to <body> so position:fixed is viewport-relative
  try {
    const chat = document.querySelector('.chat-ai-bubble');
    if (chat && chat.parentElement !== document.body) {
      document.body.appendChild(chat);
    }
  } catch(e) {
    console.error('chat bubble reposition failed', e);
  }
});
</script>
{% endblock %}
