{% load static %}
{% load accessory_filters %}
{# ãƒ¢ãƒ¼ãƒ‰: 'karihome' (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ) ã¾ãŸã¯ 'sidebar' #}
{# ä½¿ç”¨ä¾‹: {% include 'includes/character_widget.html' with mode='sidebar' %} #}

<!-- DEBUG: appearance={{ appearance }}, ai_name={{ ai_name }}, mode={{ mode }} -->
<div class="character-widget {% if mode == 'sidebar' %}sidebar-mode{% else %}karihome-mode{% endif %}" id="characterWidget" data-character="{{ appearance|default:'ã‚¤ãƒŒ.png' }}">
  
  {# karihomeãƒ¢ãƒ¼ãƒ‰: å¹ãå‡ºã—è¡¨ç¤º #}
  {% if mode != 'sidebar' %}
  <div class="speech-bubble-container">
    <div class="speech-bubble">
      <p class="text-fun" id="characterMumble" style="margin: 0;"></p>
    </div>
  </div>
  <button class="chat-trigger-btn" id="chatTriggerBtn">
    <i class="fas fa-comment-dots"></i> ã¯ãªã—ã‹ã‘ã‚‹
  </button>
  {% endif %}
  
  {# sidebarãƒ¢ãƒ¼ãƒ‰: æœ€å°åŒ–ãƒœã‚¿ãƒ³ #}
  {% if mode == 'sidebar' %}
  <button class="widget-minimize-btn" id="widgetMinimizeBtn" title="æœ€å°åŒ–">âˆ’</button>
  {% endif %}
  
  <div class="character-container">
    {# ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”»åƒã¨ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã‚’ãƒ©ãƒƒãƒ—ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ #}
    <div class="character-with-accessory">
      {% if mode == 'karihome' %}
        {# karihomeãƒ¢ãƒ¼ãƒ‰: é€šå¸¸ç”»åƒã¨ç¬‘é¡”ç”»åƒ #}
        <img src="{% static 'codemon/images/characters/' %}{{ appearance|default:'ã‚¤ãƒŒ.png' }}" 
             alt="AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" 
             class="character-image character-default"
             id="characterDefault"
             onerror="this.onerror=null;this.src='{% static 'codemon/images/characters/ã‚¤ãƒŒ.png' %}';">
        {% with smile_char=appearance|default:'ã‚¤ãƒŒ.png'|slice:':-4' %}
        <img src="{% static 'codemon/images/characters/' %}{{ smile_char }} ç¬‘é¡”.png" 
             alt="AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç¬‘é¡”" 
             class="character-image character-hover"
             id="characterHover"
             onerror="this.onerror=null;this.src='{% static 'codemon/images/characters/ã‚¤ãƒŒ ç¬‘é¡”.png' %}';">
        {% endwith %}
      {% else %}
        {# sidebarãƒ¢ãƒ¼ãƒ‰: é€šå¸¸ç”»åƒã®ã¿ #}
        <img src="{% static 'codemon/images/characters/' %}{{ appearance|default:'ã‚¤ãƒŒ.png' }}" 
             alt="AIã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼" 
             class="character-image"
             onerror="this.onerror=null;this.src='{% static 'codemon/images/characters/ã‚¤ãƒŒ.png' %}';">
      {% endif %}
      
      {# ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼è¡¨ç¤º #}
      {% if equipped_accessory %}
        {% if equipped_accessory.accessory.use_image and equipped_accessory.accessory.image_path %}
          {# ç”»åƒã‚’ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ #}
          <span class="character-accessory acc use-image {{ equipped_accessory.accessory.css_class|css_class_to_html }}" 
                style="background-image: url('{% static equipped_accessory.accessory.image_path %}');"></span>
        {% else %}
          {# CSSæç”»ã®ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ï¼ˆå¾“æ¥ï¼‰ #}
          <span class="character-accessory acc {{ equipped_accessory.accessory.css_class|css_class_to_html }}"></span>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

{# sidebarãƒ¢ãƒ¼ãƒ‰: æœ€å°åŒ–æ™‚ã®ã‚¢ã‚¤ã‚³ãƒ³ #}
{% if mode == 'sidebar' %}
<div class="character-mini-icon" id="characterMiniIcon" title="ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’è¡¨ç¤º">
  <div class="mini-icon-wrapper">
    <img src="{% static 'codemon/images/characters/' %}{{ appearance|default:'ã‚¤ãƒŒ.png' }}" 
         alt="AI"
         onerror="this.onerror=null;this.src='{% static 'codemon/images/characters/ã‚¤ãƒŒ.png' %}';">
    
    {# å°ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ #}
    {% if equipped_accessory %}
      <span class="mini-accessory acc {{ equipped_accessory.accessory.css_class }}"></span>
    {% endif %}
  </div>
</div>
{% endif %}

{# ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰ #}
<div class="chat-modal" id="chatModal">
  <div class="chat-window">
    <div class="chat-header">
      <h2 id="chatHeaderTitle">{{ ai_name|default:'ã†ãŸãƒ¼' }} ã¨ ãŠã¯ãªã—</h2>
      <button class="chat-close-btn" id="closeChatBtn">Ã—</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message ai">
        <div class="chat-message-content" id="initialGreeting">
          <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ã®æŒ¨æ‹¶ãŒJavaScriptã§è¨­å®šã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
    <div class="chat-loading" id="chatLoading">
      {{ ai_name|default:'ã†ãŸãƒ¼' }}ãŒè€ƒãˆä¸­...ğŸ¤”
    </div>
    <div class="chat-input-area">
      <input type="text" class="chat-input" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ã­ï¼">
      <button class="chat-send-btn" id="sendChatBtn">é€ä¿¡</button>
    </div>
  </div>
</div>

<link rel="stylesheet" href="{% static 'codemon/css/redesign.css' %}">
<style>
  /* ========================================
     ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ï¼ˆCSSå¤‰æ•°ï¼‰
     ======================================== */
  :root {
    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆã‚¤ãƒŒï¼‰ã®è‰² */
    --theme-primary: #FFD700;
    --theme-secondary: #FFA500;
    --theme-dark: #FF8C00;
    --theme-light: #FFF9E6;
    --theme-shadow: rgba(255, 165, 0, 0.4);
    --theme-shadow-strong: rgba(255, 165, 0, 0.6);
    --theme-glow: rgba(255, 215, 0, 0.3);
  }
  
  /* ã‚¦ã‚µã‚® */
  .character-widget[data-character="ã‚¦ã‚µã‚®.png"],
  .character-widget[data-character="ã‚¦ã‚µã‚®.png"] ~ .character-mini-icon,
  .character-widget[data-character="ã‚¦ã‚µã‚®.png"] ~ .chat-modal,
  .character-widget[data-character="usagi"],
  .character-widget[data-character="usagi"] ~ .character-mini-icon,
  .character-widget[data-character="usagi"] ~ .chat-modal {
    --theme-primary: #F5E3F4;
    --theme-secondary: #E8C4E8;
    --theme-dark: #D4A5D4;
    --theme-light: #FDF5FC;
    --theme-shadow: rgba(245, 227, 244, 0.6);
    --theme-shadow-strong: rgba(232, 196, 232, 0.7);
    --theme-glow: rgba(245, 227, 244, 0.5);
  }
  
  /* ã‚­ãƒ„ãƒ */
  .character-widget[data-character="ã‚­ãƒ„ãƒ.png"],
  .character-widget[data-character="ã‚­ãƒ„ãƒ.png"] ~ .character-mini-icon,
  .character-widget[data-character="ã‚­ãƒ„ãƒ.png"] ~ .chat-modal,
  .character-widget[data-character="kitsune"],
  .character-widget[data-character="kitsune"] ~ .character-mini-icon,
  .character-widget[data-character="kitsune"] ~ .chat-modal {
    --theme-primary: #FCD37D;
    --theme-secondary: #F5B942;
    --theme-dark: #E5A020;
    --theme-light: #FFFAED;
    --theme-shadow: rgba(252, 211, 125, 0.6);
    --theme-shadow-strong: rgba(245, 185, 66, 0.7);
    --theme-glow: rgba(252, 211, 125, 0.5);
  }
  
  /* ã‚¤ãƒŒï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ */
  .character-widget[data-character="ã‚¤ãƒŒ.png"],
  .character-widget[data-character="ã‚¤ãƒŒ.png"] ~ .character-mini-icon,
  .character-widget[data-character="ã‚¤ãƒŒ.png"] ~ .chat-modal,
  .character-widget[data-character="inu"],
  .character-widget[data-character="inu"] ~ .character-mini-icon,
  .character-widget[data-character="inu"] ~ .chat-modal {
    --theme-primary: #FFD700;
    --theme-secondary: #FFA500;
    --theme-dark: #FF8C00;
    --theme-light: #FFF9E6;
    --theme-shadow: rgba(255, 165, 0, 0.4);
    --theme-shadow-strong: rgba(255, 165, 0, 0.6);
    --theme-glow: rgba(255, 215, 0, 0.3);
  }
  
  /* ãƒ‘ãƒ³ãƒ€ */
  .character-widget[data-character="ãƒ‘ãƒ³ãƒ€.png"],
  .character-widget[data-character="ãƒ‘ãƒ³ãƒ€.png"] ~ .character-mini-icon,
  .character-widget[data-character="ãƒ‘ãƒ³ãƒ€.png"] ~ .chat-modal,
  .character-widget[data-character="panda"],
  .character-widget[data-character="panda"] ~ .character-mini-icon,
  .character-widget[data-character="panda"] ~ .chat-modal {
    --theme-primary: #FEF5DB;
    --theme-secondary: #F5E6B8;
    --theme-dark: #E5D090;
    --theme-light: #FFFDF5;
    --theme-shadow: rgba(254, 245, 219, 0.6);
    --theme-shadow-strong: rgba(245, 230, 184, 0.7);
    --theme-glow: rgba(254, 245, 219, 0.5);
  }
  
  /* ãƒªã‚¹ */
  .character-widget[data-character="ãƒªã‚¹.png"],
  .character-widget[data-character="ãƒªã‚¹.png"] ~ .character-mini-icon,
  .character-widget[data-character="ãƒªã‚¹.png"] ~ .chat-modal,
  .character-widget[data-character="risu"],
  .character-widget[data-character="risu"] ~ .character-mini-icon,
  .character-widget[data-character="risu"] ~ .chat-modal {
    --theme-primary: #FEB6AC;
    --theme-secondary: #F59A8E;
    --theme-dark: #E57A6E;
    --theme-light: #FFF5F3;
    --theme-shadow: rgba(254, 182, 172, 0.6);
    --theme-shadow-strong: rgba(245, 154, 142, 0.7);
    --theme-glow: rgba(254, 182, 172, 0.5);
  }
  
  /* ãƒ•ã‚¯ãƒ­ã‚¦ */
  .character-widget[data-character="ãƒ•ã‚¯ãƒ­ã‚¦.png"],
  .character-widget[data-character="ãƒ•ã‚¯ãƒ­ã‚¦.png"] ~ .character-mini-icon,
  .character-widget[data-character="ãƒ•ã‚¯ãƒ­ã‚¦.png"] ~ .chat-modal,
  .character-widget[data-character="fukurou"],
  .character-widget[data-character="fukurou"] ~ .character-mini-icon,
  .character-widget[data-character="fukurou"] ~ .chat-modal {
    --theme-primary: #92B7D6;
    --theme-secondary: #6A9BC5;
    --theme-dark: #4A7BA5;
    --theme-light: #F0F6FA;
    --theme-shadow: rgba(146, 183, 214, 0.6);
    --theme-shadow-strong: rgba(106, 155, 197, 0.7);
    --theme-glow: rgba(146, 183, 214, 0.5);
  }
  
  /* ãƒã‚³ */
  .character-widget[data-character="ãƒã‚³.png"],
  .character-widget[data-character="ãƒã‚³.png"] ~ .character-mini-icon,
  .character-widget[data-character="ãƒã‚³.png"] ~ .chat-modal,
  .character-widget[data-character="neko"],
  .character-widget[data-character="neko"] ~ .character-mini-icon,
  .character-widget[data-character="neko"] ~ .chat-modal {
    --theme-primary: #9CBDB6;
    --theme-secondary: #7AA59D;
    --theme-dark: #5A8A80;
    --theme-light: #F2F8F6;
    --theme-shadow: rgba(156, 189, 182, 0.6);
    --theme-shadow-strong: rgba(122, 165, 157, 0.7);
    --theme-glow: rgba(156, 189, 182, 0.5);
  }
  
  /* ã‚¢ãƒ«ãƒ‘ã‚« */
  .character-widget[data-character="ã‚¢ãƒ«ãƒ‘ã‚«.png"],
  .character-widget[data-character="ã‚¢ãƒ«ãƒ‘ã‚«.png"] ~ .character-mini-icon,
  .character-widget[data-character="ã‚¢ãƒ«ãƒ‘ã‚«.png"] ~ .chat-modal,
  .character-widget[data-character="arupaka"],
  .character-widget[data-character="arupaka"] ~ .character-mini-icon,
  .character-widget[data-character="arupaka"] ~ .chat-modal {
    --theme-primary: #FFF5CD;
    --theme-secondary: #F5E8A5;
    --theme-dark: #E5D580;
    --theme-light: #FFFDF0;
    --theme-shadow: rgba(255, 245, 205, 0.6);
    --theme-shadow-strong: rgba(245, 232, 165, 0.7);
    --theme-glow: rgba(255, 245, 205, 0.5);
  }

  /* ========================================
     å…±é€šã‚¹ã‚¿ã‚¤ãƒ«
     ======================================== */
  .character-widget {
    pointer-events: none;
    position: fixed;
    z-index: 100;
  }
  .character-container, .chat-trigger-btn, .speech-bubble-container, .widget-minimize-btn {
    pointer-events: auto;
  }
  
  /* ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ï¼‹ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .character-with-accessory {
    position: relative;
    display: inline-block;
  }
  
  .character-image {
    pointer-events: auto;
    transform-origin: bottom center;
    display: block;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    cursor: pointer;
    transition: none !important;
  }
  .character-container img {
    border: none !important;
    outline: none !important;
  }
  .character-image:hover {
    /* ãƒ›ãƒãƒ¼æ™‚ã®å‚¾ãã‚’å‰Šé™¤ */
  }
  
  /* ==================== ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼å…±é€šã‚¹ã‚¿ã‚¤ãƒ« ==================== */
  .acc {
    position: absolute;
    pointer-events: none;
  }
  
  /* å¤§ãã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ç”¨ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ï¼ˆkarihomeãƒ¢ãƒ¼ãƒ‰ãƒ»é€šå¸¸ã‚µã‚¤ã‚ºï¼‰ */
  .character-with-accessory .character-accessory.flower {
    width: 96px;
    height: 96px;
    border-radius: 50%;
    top: 50px;
    right: 180px;
  }
  
  .character-with-accessory .character-accessory.glasses {
    width: 1000px;
    height: 1000px;
    border: 4px solid currentColor;
    border-radius: 12px;
    top: 180px;
    left: 50%;
    transform: translateX(-50%);
  }
  
  /* å°ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ï¼ˆ90pxåŸºæº–ï¼‰ */
  .mini-icon-wrapper {
    position: relative;
    display: inline-block;
    width: 100%;
    height: 100%;
  }
  
  .mini-icon-wrapper .mini-accessory.flower {
    width: 9px;
    height: 9px;
    border-radius: 50%;
    top: 8px;
    right: 8px;
  }
  
  .mini-icon-wrapper .mini-accessory.glasses {
    width: 16px;
    height: 6px;
    border: 2px solid currentColor;
    border-radius: 6px;
    top: 40px;
    left: 37px;
  }
  
  /* ==================== ç”»åƒã‚’ä½¿ç”¨ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ ==================== */
  /* ç”»åƒã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ç”¨ã®å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
  .character-accessory.use-image {
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    border-radius: 0; /* ç”»åƒã®å½¢ã‚’ãã®ã¾ã¾ä½¿ã† */
  }
  
  /* èŠ±ã®ç”»åƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆä¾‹ï¼‰ */
  .character-accessory.flower.use-image.inu {
    background-image: url('/static/codemon/images/accessories/flower_inu.png');
  }
  .character-accessory.flower.use-image.usagi {
    background-image: url('/static/codemon/images/accessories/flower_usagi.png');
  }
  .character-accessory.flower.use-image.kitsune {
    background-image: url('/static/codemon/images/accessories/flower_kitsune.png');
  }
  /* ä»–ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç”»åƒã‚‚åŒæ§˜ã«è¿½åŠ  */
  
  /* ==================== CSSæç”»ã®ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ï¼ˆå¾“æ¥ï¼‰ ==================== */
  /* ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ã®è‰²ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
  .flower.inu { background: #FFD700; }
  .flower.usagi { background: #FFB6C1; }
  .flower.kitsune { background: #E5A020; }
  .flower.neko { background: #4DB6AC; }
  .flower.panda { background: #E0E0E0; }
  .flower.fukurou { background: #92B7D6; }
  .flower.risu { background: #FEB6AC; }
  .flower.alpaca { background: #E5D580; }
  
  .glasses.inu { color: #FFD700; }
  .glasses.usagi { color: #FFB6C1; }
  .glasses.kitsune { color: #E5A020; }
  .glasses.neko { color: #4DB6AC; }
  .glasses.panda { color: #E0E0E0; }
  .glasses.fukurou { color: #92B7D6; }
  .glasses.risu { color: #FEB6AC; }
  .glasses.alpaca { color: #E5D580; }
  

  /* ==================== æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼å½¢çŠ¶ ==================== */
  /* ãƒªãƒœãƒ³ - è¶ãƒã‚¯ã‚¿ã‚¤å‹ */
  .character-with-accessory .character-accessory.ribbon {
    width: 32px;
    height: 16px;
    background: linear-gradient(90deg, currentColor 0%, currentColor 40%, transparent 40%, transparent 60%, currentColor 60%, currentColor 100%);
    border-radius: 4px;
    top: 45px;
    right: 55px;
  }
  .ribbon.inu { color: #FFD700; }
  .ribbon.usagi { color: #FFB6C1; }
  .ribbon.kitsune { color: #E5A020; }
  .ribbon.neko { color: #4DB6AC; }
  .ribbon.panda { color: #E0E0E0; }
  .ribbon.fukurou { color: #92B7D6; }
  .ribbon.risu { color: #FEB6AC; }
  .ribbon.alpaca { color: #E5D580; }
  
  
  /* æ˜Ÿ - Unicodeæ–‡å­—ã‚’ä½¿ç”¨ */
  .character-with-accessory .character-accessory.star {
    width: 24px;
    height: 24px;
    top: 48px;
    right: 60px;
  }
  .character-accessory.star::before {
    content: "â˜…";
    font-size: 28px;
    color: currentColor;
    position: absolute;
    top: -4px;
    left: -2px;
  }
  
  .star.inu { color: #FFD700; }
  .star.usagi { color: #FFB6C1; }
  .star.kitsune { color: #E5A020; }
  .star.neko { color: #4DB6AC; }
  .star.panda { color: #E0E0E0; }
  .star.fukurou { color: #92B7D6; }
  .star.risu { color: #FEB6AC; }
  .star.alpaca { color: #E5D580; }
  
  
  /* å¸½å­ - ã‚·ãƒ³ãƒ—ãƒ«ãªå°å½¢ */
  .character-with-accessory .character-accessory.hat {
    width: 0;
    height: 0;
    border-left: 15px solid transparent;
    border-right: 15px solid transparent;
    border-bottom: 20px solid currentColor;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
  }

  .hat.inu { color: #FFD700; }
  .hat.usagi { color: #FFB6C1; }
  .hat.kitsune { color: #E5A020; }
  .hat.neko { color: #4DB6AC; }
  .hat.panda { color: #E0E0E0; }
  .hat.fukurou { color: #92B7D6; }
  .hat.risu { color: #FEB6AC; }
  .hat.alpaca { color: #E5D580; }
  
  /* ç‹å†  - Unicodeæ–‡å­—ã‚’ä½¿ç”¨ */
  .character-with-accessory .character-accessory.crown {
    width: 30px;
    height: 24px;
    top: 15px;
    left: 50%;
    transform: translateX(-50%);
  }
  .character-accessory.crown::before {
    content: "ğŸ‘‘";
    font-size: 30px;
    position: absolute;
    top: -5px;
    left: 0;
  }
  .crown.inu { color: #FFD700; }
  .crown.usagi { color: #FFB6C1; }
  .crown.kitsune { color: #E5A020; }
  .crown.neko { color: #4DB6AC; }
  .crown.panda { color: #E0E0E0; }
  .crown.fukurou { color: #92B7D6; }
  .crown.risu { color: #FEB6AC; }
  .crown.alpaca { color: #E5D580; }
  
  /* å°ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ */
  .mini-icon-wrapper .mini-accessory.ribbon {
    width: 12px;
    height: 6px;
    background: linear-gradient(90deg, currentColor 0%, currentColor 40%, transparent 40%, transparent 60%, currentColor 60%, currentColor 100%);
    border-radius: 2px;
    top: 7px;
    right: 7px;
  }
  
  .mini-icon-wrapper .mini-accessory.heart::before,
  .mini-icon-wrapper .mini-accessory.star::before {
    font-size: 10px;
    top: -2px;
    left: -1px;
  }
  
  .mini-icon-wrapper .mini-accessory.heart,
  .mini-icon-wrapper .mini-accessory.star {
    width: 8px;
    height: 8px;
    top: 8px;
    right: 8px;
  }
  
  .mini-icon-wrapper .mini-accessory.crown::before {
    font-size: 12px;
    top: -2px;
  }
  
  .mini-icon-wrapper .mini-accessory.crown {
    width: 12px;
    height: 10px;
    top: 3px;
    left: 39px;
  }

  /* ==================== ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ã‚¢ã‚¯ã‚»ã‚µãƒªãƒ¼ä½ç½®èª¿æ•´ ==================== */
  /* ã‚¦ã‚µã‚® - è€³ãŒé«˜ã„ã®ã§èŠ±ã‚’å°‘ã—ä¸‹ã« */
  .character-widget[data-character="ã‚¦ã‚µã‚®.png"] .character-accessory.flower,
  .character-widget[data-character="usagi"] .character-accessory.flower {
    top: 60px;
    right: 65px;
  }
  .character-widget[data-character="ã‚¦ã‚µã‚®.png"] .character-accessory.glasses,
  .character-widget[data-character="usagi"] .character-accessory.glasses {
    top: 190px;
  }
  
  /* ã‚­ãƒ„ãƒ - é¡”ãŒç´°ã„ã®ã§èŠ±ã‚’å³å¯„ã‚Šã« */
  .character-widget[data-character="ã‚­ãƒ„ãƒ.png"] .character-accessory.flower,
  .character-widget[data-character="kitsune"] .character-accessory.flower {
    top: 45px;
    right: 55px;
  }
  .character-widget[data-character="ã‚­ãƒ„ãƒ.png"] .character-accessory.glasses,
  .character-widget[data-character="kitsune"] .character-accessory.glasses {
    top: 175px;
  }
  
  /* ã‚¤ãƒŒ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ï¼ˆå¤‰æ›´ãªã—ï¼‰ */
  
  /* ãƒ‘ãƒ³ãƒ€ - ä¸¸é¡”ãªã®ã§èŠ±ã‚’å°‘ã—ä¸Šã« */
  .character-widget[data-character="ãƒ‘ãƒ³ãƒ€.png"] .character-accessory.flower,
  .character-widget[data-character="panda"] .character-accessory.flower {
    top: 45px;
    right: 70px;
  }
  .character-widget[data-character="ãƒ‘ãƒ³ãƒ€.png"] .character-accessory.glasses,
  .character-widget[data-character="panda"] .character-accessory.glasses {
    top: 185px;
  }
  
  /* ãƒªã‚¹ - å°ã•ã‚ãªã®ã§èŠ±ã‚‚å°‘ã—ä¸­å¤®å¯„ã‚Šã« */
  .character-widget[data-character="ãƒªã‚¹.png"] .character-accessory.flower,
  .character-widget[data-character="risu"] .character-accessory.flower {
    top: 48px;
    right: 58px;
  }
  .character-widget[data-character="ãƒªã‚¹.png"] .character-accessory.glasses,
  .character-widget[data-character="risu"] .character-accessory.glasses {
    top: 178px;
  }
  
  /* ãƒ•ã‚¯ãƒ­ã‚¦ - é¡”ãŒä¸¸ãå¤§ãã„ã®ã§èŠ±ã‚’å¤–å´ã« */
  .character-widget[data-character="ãƒ•ã‚¯ãƒ­ã‚¦.png"] .character-accessory.flower,
  .character-widget[data-character="fukurou"] .character-accessory.flower {
    top: 55px;
    right: 75px;
  }
  .character-widget[data-character="ãƒ•ã‚¯ãƒ­ã‚¦.png"] .character-accessory.glasses,
  .character-widget[data-character="fukurou"] .character-accessory.glasses {
    top: 195px;
  }
  
  /* ãƒã‚³ - é¡”ãŒå°ã•ã‚ãªã®ã§èŠ±ã‚‚å°ã•ã‚ã«é…ç½® */
  .character-widget[data-character="ãƒã‚³.png"] .character-accessory.flower,
  .character-widget[data-character="neko"] .character-accessory.flower {
    top: 52px;
    right: 62px;
  }
  .character-widget[data-character="ãƒã‚³.png"] .character-accessory.glasses,
  .character-widget[data-character="neko"] .character-accessory.glasses {
    top: 182px;
  }
  
  /* ã‚¢ãƒ«ãƒ‘ã‚« - é¦–ãŒé•·ã„ã®ã§èŠ±ã‚’ä¸Šã« */
  .character-widget[data-character="ã‚¢ãƒ«ãƒ‘ã‚«.png"] .character-accessory.flower,
  .character-widget[data-character="arupaka"] .character-accessory.flower {
    top: 40px;
    right: 68px;
  }
  .character-widget[data-character="ã‚¢ãƒ«ãƒ‘ã‚«.png"] .character-accessory.glasses,
  .character-widget[data-character="arupaka"] .character-accessory.glasses {
    top: 170px;
  }
  
  /* å°ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥èª¿æ•´ */
  .character-widget[data-character="ã‚¦ã‚µã‚®.png"] .mini-accessory.flower,
  .character-widget[data-character="usagi"] .mini-accessory.flower {
    top: 10px;
    right: 9px;
  }
  
  .character-widget[data-character="ã‚­ãƒ„ãƒ.png"] .mini-accessory.flower,
  .character-widget[data-character="kitsune"] .mini-accessory.flower {
    top: 7px;
    right: 7px;
  }
  
  .character-widget[data-character="ãƒ•ã‚¯ãƒ­ã‚¦.png"] .mini-accessory.flower,
  .character-widget[data-character="fukurou"] .mini-accessory.flower {
    top: 9px;
    right: 10px;
  }

  /* ========================================
     karihomeãƒ¢ãƒ¼ãƒ‰ï¼ˆå¤§ãã„è¡¨ç¤ºï¼‰
     ======================================== */
  .karihome-mode {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-end;
  }
  
  .karihome-mode .character-container {
    position: relative;
    width: 100%;
    height: 85vh;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding-right: 8%;
    z-index: 100;
  }
  
  .karihome-mode .character-with-accessory {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding-right: 2%;
  }
  
  .karihome-mode .character-image {
    max-height: 100%;
    width: auto;
    max-width: 420px;
    filter: drop-shadow(15px 15px 0 rgba(0,0,0,0.05));
    cursor: pointer;
    position: absolute;
    bottom: 0;
    right: 2%;
  }
  
  .karihome-mode .character-default {
    opacity: 1;
    transition: none !important;
  }
  
  .karihome-mode .character-hover {
    opacity: 0;
    transition: none !important;
  }
  
  .karihome-mode .character-with-accessory:hover .character-default {
    opacity: 0 !important;
    transition: none !important;
  }
  
  .karihome-mode .character-with-accessory:hover .character-hover {
    opacity: 1 !important;
    transition: none !important;
  }
  
  .karihome-mode .speech-bubble-container {
    position: absolute;
    top: 120px;
    left: -30px;
    z-index: 101;
  }
  
  .karihome-mode .speech-bubble {
    background: white;
    border: 4px solid var(--theme-primary, #FFD700);
    padding: 15px 25px;
    border-radius: 25px;
    font-weight: 900;
    box-shadow: 0 10px 0 rgba(0,0,0,0.05);
    font-size: 18px;
    line-height: 1.6;
    color: #333;
    min-width: 150px;
    text-align: center;
    animation: bubbleFloat 3s ease-in-out infinite;
  }
  
  .karihome-mode .speech-bubble::after {
    /* å¹ãå‡ºã—ã®â–³ãƒãƒ¼ã‚¯ã‚’éè¡¨ç¤º */
    display: none;
  }
  
  .karihome-mode .chat-trigger-btn {
    position: absolute;
    bottom: 40px;
    left: 10px;
    background: linear-gradient(135deg, var(--theme-primary, #FFD700), var(--theme-secondary, #FFA500));
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 50px;
    font-size: 16px;
    font-weight: 900;
    cursor: pointer;
    box-shadow: 0 6px 0 var(--theme-dark, #FF8C00);
    z-index: 102;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .karihome-mode .chat-trigger-btn:hover {
    box-shadow: 0 10px 0 var(--theme-dark, #FF8C00);
  }
  
  .karihome-mode .chat-trigger-btn .sparkle {
    display: none;
  }

  /* ========================================
     sidebarãƒ¢ãƒ¼ãƒ‰ï¼ˆå°ã•ã„å¸¸é§è¡¨ç¤ºï¼‰
     ======================================== */
  .sidebar-mode {
    right: 20px;
    bottom: -100px;
    width: auto;
    height: auto;
  }
  .sidebar-mode .character-container {
    position: relative;
    display: flex;
    align-items: flex-end;
  }
  .sidebar-mode .character-image {
    max-width: 225px !important;
    max-height: 225px !important;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
  }
  .sidebar-mode .widget-minimize-btn {
    position: absolute;
    top: -60px;
    left: -65px;
    width: 24px;
    height: 24px;
    background: linear-gradient(135deg, var(--theme-primary, #FFD700), var(--theme-secondary, #FFA500));
    border: 2px solid white;
    border-radius: 50%;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 101;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  .sidebar-mode .widget-minimize-btn:hover {
    background: linear-gradient(135deg, var(--theme-secondary, #FFA500), var(--theme-dark, #FF8C00));
  }

  /* æœ€å°åŒ–æ™‚ã®ã‚¢ã‚¤ã‚³ãƒ³ */
  .character-mini-icon {
    position: fixed;
    right: 40px;
    bottom: 30px;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, var(--theme-primary, #FFD700), var(--theme-secondary, #FFA500));
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 12px var(--theme-shadow, rgba(255, 165, 0, 0.4));
    z-index: 100;
    overflow: hidden;
    padding: 5px;
  }
  .character-mini-icon img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }
  .character-mini-icon:hover {
    box-shadow: 0 6px 16px var(--theme-shadow-strong, rgba(255, 165, 0, 0.6));
  }
  .character-mini-icon.active {
    display: flex;
  }

  /* éè¡¨ç¤ºçŠ¶æ…‹ */
  .character-widget.minimized {
    display: none;
  }

  /* ========================================
     ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
     ======================================== */
  @keyframes bubbleFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }
  @keyframes sparkleFloat {
    0%, 100% { opacity: 0; transform: translateY(0) scale(0.5); }
    50% { opacity: 1; transform: translateY(-20px) scale(1); }
  }

  /* ========================================
     ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…±é€šï¼‰
     ======================================== */
  .chat-modal {
    display: none;
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    background: rgba(0, 0, 0, 0.5);
    z-index: 99999 !important;
    justify-content: center;
    align-items: center;
  }
  .chat-modal.active {
    display: flex;
  }
  .chat-window {
    background: white;
    border-radius: 30px;
    width: 90%;
    max-width: 800px;
    height: 80%;
    max-height: 600px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: modalSlideIn 0.3s ease-out;
    position: relative !important;
    z-index: 100000 !important;
  }
  @keyframes modalSlideIn {
    from { transform: scale(0.8) translateY(-50px); opacity: 0; }
    to { transform: scale(1) translateY(0); opacity: 1; }
  }
  .chat-header {
    background: linear-gradient(135deg, var(--theme-primary, #FFD700), var(--theme-secondary, #FFA500));
    padding: 20px 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid var(--theme-dark, #FF8C00);
  }
  .chat-header h2 {
    margin: 0;
    color: white;
    font-size: 24px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
  }
  .chat-close-btn {
    background: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--theme-dark, #FF8C00);
    font-weight: bold;
  }
  .chat-close-btn:hover {
    background: var(--theme-light, #FFE4B5);
  }
  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: var(--theme-light, #FFF9E6);
  }
  .chat-message {
    display: flex;
    margin-bottom: 15px;
    animation: messageSlideIn 0.3s ease-out;
  }
  @keyframes messageSlideIn {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }
  .chat-message.user {
    flex-direction: row-reverse;
    background: none !important;
    background-color: transparent !important;
  }
  .chat-message-content {
    max-width: 70%;
    padding: 15px 20px;
    border-radius: 20px;
    font-size: 16px;
    line-height: 1.5;
  }
  .chat-message.ai .chat-message-content {
    background: white;
    border: 3px solid var(--theme-primary, #FFD700);
    color: #333;
  }
  .chat-message.user .chat-message-content {
    background: var(--theme-primary, #FFD700) !important;
    background-color: var(--theme-primary, #FFD700) !important;
    color: #333;
    font-weight: bold;
    border: none !important;
    box-shadow: none !important;
  }
  .chat-input-area {
    padding: 20px;
    background: white;
    border-top: 3px solid var(--theme-primary, #FFD700);
    display: flex;
    gap: 10px;
  }
  .chat-input {
    flex: 1;
    padding: 15px 20px;
    border: 3px solid var(--theme-primary, #FFD700);
    border-radius: 25px;
    font-size: 16px;
    outline: none;
  }
  .chat-input:focus {
    border-color: var(--theme-secondary, #FFA500);
    box-shadow: 0 0 15px var(--theme-glow, rgba(255, 215, 0, 0.3));
  }
  .chat-send-btn {
    background: linear-gradient(135deg, var(--theme-primary, #FFD700), var(--theme-secondary, #FFA500));
    border: none;
    padding: 15px 30px;
    border-radius: 25px;
    color: white;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
  }
  .chat-send-btn:hover {
    box-shadow: 0 5px 15px var(--theme-shadow, rgba(255, 165, 0, 0.4));
  }
  .chat-send-btn:active {
  }
  .chat-loading {
    display: none;
    text-align: center;
    padding: 10px;
    color: #666;
  }
  .chat-loading.active {
    display: block;
  }
</style>

<script src="{% static 'codemon/js/interactions.js' %}"></script>
<script>
(function() {
  'use strict';
  
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ¯ character_widget.html DOMContentLoadedé–‹å§‹');
  
  const widget = document.getElementById('characterWidget');
  const character = document.querySelector('.character-image');
  const chatModal = document.getElementById('chatModal');
  const closeChatBtn = document.getElementById('closeChatBtn');
  const sendChatBtn = document.getElementById('sendChatBtn');
  const chatInput = document.getElementById('chatInput');
  const chatMessages = document.getElementById('chatMessages');
  const chatTriggerBtn = document.getElementById('chatTriggerBtn');
  const chatHeaderTitle = document.getElementById('chatHeaderTitle');
  const chatLoading = document.querySelector('.chat-loading');
  const characterMumble = document.getElementById('characterMumble');
  const minimizeBtn = document.getElementById('widgetMinimizeBtn');
  const miniIcon = document.getElementById('characterMiniIcon');
  
  console.log('ğŸ¯ DOMè¦ç´ å–å¾—çµæœ:');
  console.log('  - widget:', widget);
  console.log('  - chatModal:', chatModal);
  console.log('  - chatTriggerBtn:', chatTriggerBtn);
  console.log('  - closeChatBtn:', closeChatBtn);
  console.log('  - sendChatBtn:', sendChatBtn);
  console.log('  - characterMumble:', characterMumble);
  
  // ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
  const isSidebarMode = widget ? widget.classList.contains('sidebar-mode') : false;
  console.log('  - isSidebarMode:', isSidebarMode);
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥ã®ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼è¨­å®š
  const characterColors = {
    'ã‚¦ã‚µã‚®.png': { primary: '#F5E3F4', secondary: '#E8C4E8', dark: '#D4A5D4' },
    'ã‚­ãƒ„ãƒ.png': { primary: '#FCD37D', secondary: '#F5B942', dark: '#E5A020' },
    'ã‚¤ãƒŒ.png': { primary: '#FFD700', secondary: '#FFA500', dark: '#FF8C00' },
    'ãƒ‘ãƒ³ãƒ€.png': { primary: '#FEF5DB', secondary: '#F5E6B8', dark: '#E5D090' },
    'ãƒªã‚¹.png': { primary: '#FEB6AC', secondary: '#F59A8E', dark: '#E57A6E' },
    'ãƒ•ã‚¯ãƒ­ã‚¦.png': { primary: '#92B7D6', secondary: '#6A9BC5', dark: '#4A7BA5' },
    'ãƒã‚³.png': { primary: '#9CBDB6', secondary: '#7AA59D', dark: '#5A8A80' },
    'ã‚¢ãƒ«ãƒ‘ã‚«.png': { primary: '#FFF5CD', secondary: '#F5E8A5', dark: '#E5D580' }
  };
  
  // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã«åŸºã¥ã„ã¦ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼ã‚’è¨­å®š
  const currentAppearance = widget ? widget.getAttribute('data-character') : 'ã‚¤ãƒŒ.png';
  const colors = characterColors[currentAppearance] || characterColors['ã‚¤ãƒŒ.png'];
  
  document.documentElement.style.setProperty('--theme-primary', colors.primary);
  document.documentElement.style.setProperty('--theme-secondary', colors.secondary);
  document.documentElement.style.setProperty('--theme-dark', colors.dark);
  
  // ========================================
  // sidebarãƒ¢ãƒ¼ãƒ‰: æœ€å°åŒ–/å¾©å…ƒæ©Ÿèƒ½
  // ========================================
    if (isSidebarMode) {
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å–å¾—
      const userId = '{{ request.user.id|default:"anon" }}';
      // æœ€å°åŒ–çŠ¶æ…‹ã®ã‚­ãƒ¼
      const minimizedKey = `character_minimized_${userId}`;

      // æœ€å°åŒ–ãƒœã‚¿ãƒ³
      if (minimizeBtn) {
        minimizeBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          widget.classList.add('minimized');
          if (miniIcon) miniIcon.classList.add('active');
          // æœ€å°åŒ–çŠ¶æ…‹ã‚’ä¿å­˜
          localStorage.setItem(minimizedKey, 'true');
        });
      }
      // ãƒŸãƒ‹ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å¾©å…ƒ
      if (miniIcon) {
        miniIcon.addEventListener('click', function() {
          widget.classList.remove('minimized');
          miniIcon.classList.remove('active');
          // å¾©å…ƒçŠ¶æ…‹ã‚’ä¿å­˜
          localStorage.setItem(minimizedKey, 'false');
        });
      }
      // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ£ãƒƒãƒˆã‚’é–‹ãï¼ˆsidebarãƒ¢ãƒ¼ãƒ‰ï¼‰
      if (character) {
        character.addEventListener('click', function() {
          openChat();
        });
      }
      // ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«æœ€å°åŒ–çŠ¶æ…‹ã‚’å¾©å…ƒ
      const minimized = localStorage.getItem(minimizedKey);
      if (minimized === 'true') {
        widget.classList.add('minimized');
        if (miniIcon) miniIcon.classList.add('active');
      } else {
        widget.classList.remove('minimized');
        if (miniIcon) miniIcon.classList.remove('active');
      }
    }
  
  // ========================================
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åˆ¥å°è©ãƒ‡ãƒ¼ã‚¿
  // ========================================
  const characterDialogues = {
    // ã‚¦ã‚µã‚®ï¼ˆæ¥ãšã‹ã—ãŒã‚Šå±‹ã€ã‚„ã•ã—ã„ï¼‰
    'ã‚¦ã‚µã‚®.png': {
      mumbles: [
        'ãˆã€ãˆã£ã¨â€¦ä½•ã—ã‚ˆã†ã‹ãªâ€¦',
        'ã¼ã€ã¼ãã€ã“ã“ã«ã„ã‚‹ã‚ˆâ€¦',
        'ã†ã€ã†ã‚“ã¨â€¦å°‘ã—çœ ã„ã‹ã‚‚â€¦',
        'ã‚ã€ã‚ã®â€¦èª°ã‹ã„ã‚‹ã‹ãªâ€¦',
        'ã¼ã€ã¼ãã§ã‚ˆã‘ã‚Œã°â€¦è©±ãã†ã‚ˆâ€¦',
        'ãˆã€ãˆã£ã¨â€¦ä»Šæ—¥ã‚‚ãŒã‚“ã°ã‚‹ã­â€¦',
        'ã¼ã€ã¼ãâ€¦ã¡ã‚‡ã£ã¨ç·Šå¼µã™ã‚‹â€¦',
        'ã‚ã€ã‚ã®â€¦ã‚ˆã‹ã£ãŸã‚‰å£°ã‹ã‘ã¦ã­â€¦'
      ],
      greeting: 'ã“ã€ã“ã‚“ã«ã¡ã¯â€¦ï¼ ã¼ã€ã¼ãã¯{AI_NAME}ã§ã™ã€‚<br>ãˆã€ãˆã£ã¨â€¦ãªã‚“ã§ã‚‚èã„ã¦ã­â€¦ï¼',
      hoverMessage: 'ã„ã£ã—ã‚‡ã«<br>ã‚ãã¼ã†ï¼'
    },
    // ã‚­ãƒ„ãƒï¼ˆçš®è‚‰å±‹ã€é£„ã€…ï¼‰
    'ã‚­ãƒ„ãƒ.png': {
      mumbles: [
        'ãµãâ€¦é€€å±ˆã ãªã',
        'ãªã‚“ã‹é¢ç™½ã„ã“ã¨ãªã„ã‹ã­',
        'ã¾ã€æš‡ã¤ã¶ã—ã«ã¯ãªã‚‹ã‹',
        'ãŠã¾ãˆã€ãã“ã«ã„ã‚‹ã‚“ã ã‚ï¼Ÿ',
        'ã¸ã‡â€¦è¦‹ã¦ã‚‹ã®ã•',
        'ã‚ãã³ãŒå‡ºã¡ã‚ƒã†ãª',
        'èª°ã‹æ§‹ã£ã¦ãã‚Œãªã„ã‹ã­ã‡',
        'ã¾ã€æ°—ãŒå‘ã„ãŸã‚‰è©±ã—ã‹ã‘ãªã‚ˆ'
      ],
      greeting: 'ã‚ˆã‰ã€‚ã‚ªãƒ¬ã¯{AI_NAME}ã£ã¦ã‚„ã¤ã•ã€‚<br>ãªã‚“ã‹èããŸã„ã“ã¨ã‚ã‚‹ãªã‚‰ã€èã„ã¦ã‚„ã‚‹ã‚ˆã€‚',
      hoverMessage: 'ã¾ã€<br>ä»˜ãåˆã£ã¦ã‚„ã‚‹ã‹'
    },
    // ã‚¤ãƒŒï¼ˆæ˜ã‚‹ãå‰å‘ãï¼‰
    'ã‚¤ãƒŒ.png': {
      mumbles: [
        'ä»Šæ—¥ã‚‚ã„ã„å¤©æ°—ã ãªï¼',
        'èª°ã‹éŠã³ã«æ¥ãªã„ã‹ãª',
        'ãŠè…¹ã™ã„ã¦ããŸã',
        'ã‚ˆã—ã€ã‚„ã‚‹æ°—å‡ºã¦ããŸï¼',
        'ãªã‚“ã‹ãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ãª',
        'ã¡ã‚‡ã£ã¨çœ ããªã£ã¦ããŸâ€¦',
        'æ•£æ­©ã—ãŸã„ãª',
        'è©±ã—ã‹ã‘ã¦ãã‚Œã‚ˆï¼'
      ],
      greeting: 'ã“ã‚“ã«ã¡ã¯ï¼ãŠã‚Œã¯{AI_NAME}ã ï¼<br>ãªã‚“ã§ã‚‚èã„ã¦ãã‚Œã‚ˆãªï¼',
      hoverMessage: 'ã„ã£ã—ã‚‡ã«<br>ã‚ãã¼ã†ï¼'
    },
    // ãƒ‘ãƒ³ãƒ€ï¼ˆã®ã‚“ã³ã‚Šç™’ã—ï¼‰
    'ãƒ‘ãƒ³ãƒ€.png': {
      mumbles: [
        'ãµããâ€¦ã®ã‚“ã³ã‚Šã™ã‚‹ã­ã‡',
        'ãŠæ˜¼å¯ã—ãŸã„ãªã',
        'ã‚†ã£ãã‚Šã§ã„ã„ã‚ˆã‰',
        'ç¬¹ãŒé£Ÿã¹ãŸã„ãªã',
        'ã¾ã£ãŸã‚Šã—ã¦ã‚‹ã­ã‡',
        'ã‚ã£ãŸã‹ã„ã­ã‡â€¦',
        'æ€¥ãŒãªãã¦ã„ã„ã‚ˆã‰',
        'ã¼ãã€ã“ã“ã«ã„ã‚‹ã‚ˆã‰'
      ],
      greeting: 'ã‚„ãâ€¦ã¼ãã¯{AI_NAME}ã ã‚ˆã‰ã€‚<br>ã‚†ã£ãã‚Šã§ã„ã„ã‹ã‚‰ã€ãªã‚“ã§ã‚‚èã„ã¦ã­ã‡ã€‚',
      hoverMessage: 'ã„ã£ã—ã‚‡ã«<br>ã¾ã£ãŸã‚Šã—ã‚ˆã†ã‰'
    },
    // ãƒªã‚¹ï¼ˆãƒ„ãƒ³ãƒ‡ãƒ¬ä¸–è©±ç„¼ãï¼‰
    'ãƒªã‚¹.png': {
      mumbles: [
        'ã‚‚ã†ã€ä½•ã—ã¦ã‚‹ã®ã‚ˆ',
        'ã¡ã‚ƒã‚“ã¨ã‚„ã£ã¦ã‚‹ï¼Ÿ',
        'ã—ã‚‡ã†ãŒãªã„ã‚ã­â€¦',
        'ã‚¢ã‚¿ã‚·ã«ä»»ã›ãªã•ã„ã‚ˆ',
        'ãµã‚“ã€åˆ¥ã«æš‡ã˜ã‚ƒãªã„ã—',
        'ä½•ã‹æ‰‹ä¼ã£ã¦ã‚ã’ã‚ˆã†ã‹ï¼Ÿ',
        'ã¡ã‚‡ã£ã¨ã€èã„ã¦ã‚‹ã®ï¼Ÿ',
        'ã¾ã£ãŸãã€ä¸–è©±ãŒç„¼ã‘ã‚‹ã‚ã­'
      ],
      greeting: 'ãµã‚“ã€ã‚¢ã‚¿ã‚·ã¯{AI_NAME}ã‚ˆã€‚<br>ã—ã‚‡ã†ãŒãªã„ã‹ã‚‰ã€è³ªå•ãŒã‚ã‚Œã°èã„ã¦ã‚ã’ã‚‹ã‚ã€‚',
      hoverMessage: 'ã¹ã€åˆ¥ã«ã‚¢ãƒ³ã‚¿ã®<br>ãŸã‚ã˜ã‚ƒãªã„ã‚“ã ã‹ã‚‰ï¼'
    },
    // ãƒ•ã‚¯ãƒ­ã‚¦ï¼ˆçŸ¥çš„ã§ç©ã‚„ã‹ï¼‰
    'ãƒ•ã‚¯ãƒ­ã‚¦.png': {
      mumbles: [
        'ãµã‚€â€¦è€ƒãˆäº‹ã‚’ã—ã¦ã„ã¾ã—ãŸ',
        'é™ã‹ã§è½ã¡ç€ãã¾ã™ã­',
        'çŸ¥è­˜ã¯å®ã§ã™ã‚ˆ',
        'ä½•ã‹ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ',
        'ã‚†ã£ãã‚Šè€ƒãˆã¾ã—ã‚‡ã†',
        'ãªã‚‹ã»ã©â€¦èˆˆå‘³æ·±ã„ã§ã™ã­',
        'å­¦ã¶ã“ã¨ã¯æ¥½ã—ã„ã§ã™ã‚ˆ',
        'ã„ã¤ã§ã‚‚ãŠæ‰‹ä¼ã„ã—ã¾ã™ã‚ˆ'
      ],
      greeting: 'ã“ã‚“ã«ã¡ã¯ã€‚ã‚ãŸã—ã¯{AI_NAME}ã§ã™ã€‚<br>ä½•ã‹ãŠå›°ã‚Šã®ã“ã¨ãŒã‚ã‚Œã°ã€ãŠæ°—è»½ã«ã©ã†ãã€‚',
      hoverMessage: 'çŸ¥è­˜ã¯åŠ›ãªã‚Šã€‚<br>ã„ã¤ã§ã‚‚ã”ç›¸è«‡ã‚’'
    },
    // ãƒã‚³ï¼ˆã‘ã ã‚‹ã’ã€æ°—ã¾ãã‚Œï¼‰
    'ãƒã‚³.png': {
      mumbles: [
        'â€¦â€¦ãµã',
        'â€¦â€¦çœ ã„',
        'â€¦â€¦ãªã«ï¼Ÿ',
        'â€¦â€¦ã¾ã€ã„ã„ã‘ã©',
        'â€¦â€¦æš‡ã ãª',
        'â€¦â€¦ãã“ã«ã„ã‚‹ã®ï¼Ÿ',
        'â€¦â€¦æ°—ãŒå‘ã„ãŸã‚‰è©±ã™',
        'â€¦â€¦åˆ¥ã«å¾…ã£ã¦ãªã„ã—'
      ],
      greeting: 'â€¦â€¦ã‚ã‚ã€ã¼ãã¯{AI_NAME}ã€‚<br>â€¦â€¦èããŸã„ã“ã¨ãŒã‚ã‚‹ãªã‚‰ã€èã‘ã°ï¼Ÿ',
      hoverMessage: 'â€¦â€¦æ°—ãŒå‘ã„ãŸã‚‰<br>ç­”ãˆã¦ã‚ã’ã‚‹'
    },
    // ã‚¢ãƒ«ãƒ‘ã‚«ï¼ˆãŠå¬¢æ§˜ï¼‰
    'ã‚¢ãƒ«ãƒ‘ã‚«.png': {
      mumbles: [
        'ã”ãã’ã‚“ã‚ˆã†',
        'ãŠç´…èŒ¶ãŒé£²ã¿ãŸã„ã§ã™ã‚',
        'ã‚ˆãã£ã¦ã‚ˆ',
        'ã‚ãŸãã—ã«ä»»ã›ãªã•ã„',
        'ãµãµã€ç´ æ•µã§ã™ã‚ã­',
        'ä½•ã‹ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹ï¼Ÿ',
        'ã¤ã„ã¦ã„ã‚‰ã£ã—ã‚ƒã„',
        'ã•ã‚ã€ä½•ã§ã‚‚ãŠã£ã—ã‚ƒã£ã¦'
      ],
      greeting: 'ã”ãã’ã‚“ã‚ˆã†ã€‚ã‚ãŸãã—ã¯{AI_NAME}ã§ã™ã‚ã€‚<br>ä½•ã§ã‚‚ãŠèãã«ãªã£ã¦ã€‚ãŠåŠ›ã«ãªã‚Šã¾ã™ã‚ã‚ˆã€‚',
      hoverMessage: 'ã‚ãŸãã—ã¨ä¸€ç·’ã«<br>é ‘å¼µã‚Šã¾ã—ã‚‡ã†'
    }
  };
  
  // ç¾åœ¨ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æƒ…å ±ã‚’å–å¾—ï¼ˆæ—¢ã«1019è¡Œç›®ã§å®£è¨€æ¸ˆã¿ï¼‰
  const currentDialogue = characterDialogues[currentAppearance] || characterDialogues['ã‚¤ãƒŒ.png'];
  const aiName = '{{ ai_name|default:"ã†ãŸãƒ¼"|escapejs }}';
  
  console.log('DEBUG character_widget.html:');
  console.log('  - currentAppearance:', currentAppearance);
  console.log('  - aiName:', aiName);
  console.log('  - currentDialogue:', currentDialogue);
  console.log('  - isSidebarMode:', isSidebarMode);
  console.log('  - characterMumble:', characterMumble);
  
  // åˆæœŸæŒ¨æ‹¶ã‚’è¨­å®š
  const initialGreeting = document.getElementById('initialGreeting');
  if (initialGreeting) {
    initialGreeting.innerHTML = currentDialogue.greeting.replace(/{AI_NAME}/g, aiName);
  }
  
  // ========================================
  // karihomeãƒ¢ãƒ¼ãƒ‰: å¹ãå‡ºã—æ©Ÿèƒ½
  // ========================================
  if (!isSidebarMode && characterMumble) {
    const mumbles = currentDialogue.mumbles;
    const greeting = currentDialogue.greeting.replace(/{AI_NAME}/g, aiName);
    let mumbleIndex = 0;
    
    console.log('DEBUG karihomeå¹ãå‡ºã—:');
    console.log('  - mumbles:', mumbles);
    console.log('  - greeting:', greeting);
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦greetingã‚’è¡¨ç¤º
    characterMumble.innerHTML = greeting;
    console.log('  - åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨­å®šå®Œäº†:', greeting);
    
    function showMumble(idx) {
      characterMumble.innerHTML = mumbles[idx % mumbles.length];
    }
    
    // 5ç§’å¾Œã‹ã‚‰ç‹¬ã‚Šè¨€ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
    setTimeout(function() {
      showMumble(mumbleIndex);
      setInterval(function() {
        mumbleIndex++;
        showMumble(mumbleIndex);
      }, 5000);
    }, 5000);
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®ä¼šè©±ï¼ˆkarihomeãƒ¢ãƒ¼ãƒ‰ï¼‰
    if (character) {
      character.addEventListener('click', function() {
        mumbleIndex++;
        showMumble(mumbleIndex);
      });
    }
    
    // å¹ãå‡ºã—ã‚¯ãƒªãƒƒã‚¯ã§æ¬¡ã®ä¼šè©±ï¼ˆkarihomeãƒ¢ãƒ¼ãƒ‰ï¼‰
    const speechBubble = document.querySelector('.speech-bubble');
    if (speechBubble) {
      speechBubble.style.cursor = 'pointer';
      speechBubble.addEventListener('click', function() {
        mumbleIndex++;
        showMumble(mumbleIndex);
      });
    }
    
    // ãƒ›ãƒãƒ¼æ™‚ã®å¹ãå‡ºã—å¤‰æ›´ï¼ˆkarihomeãƒ¢ãƒ¼ãƒ‰ï¼‰
    // ç”»åƒåˆ‡ã‚Šæ›¿ãˆã¯CSSã§å‡¦ç†
    const characterContainer = document.querySelector('.character-with-accessory');
    const hoverMessage = currentDialogue.hoverMessage || currentDialogue.greeting;
    let originalMessage = characterMumble ? characterMumble.innerHTML : '';
    
    if (characterContainer && characterMumble) {
      characterContainer.addEventListener('mouseenter', function() {
        // å¹ãå‡ºã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å¤‰æ›´ï¼ˆç”»åƒåˆ‡ã‚Šæ›¿ãˆã¯CSSã§å‡¦ç†ï¼‰
        originalMessage = characterMumble.innerHTML;
        characterMumble.innerHTML = hoverMessage;
      });
      
      characterContainer.addEventListener('mouseleave', function() {
        // å¹ãå‡ºã—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æˆ»ã™
        characterMumble.innerHTML = originalMessage;
      });
    }
  }
  
  // ========================================
  // sidebarãƒ¢ãƒ¼ãƒ‰: æœ€å°åŒ–/å¾©å…ƒæ©Ÿèƒ½
  // ========================================
  if (isSidebarMode) {
    // æœ€å°åŒ–ãƒœã‚¿ãƒ³
    if (minimizeBtn) {
      minimizeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        widget.classList.add('minimized');
        if (miniIcon) miniIcon.classList.add('active');
      });
    }
    
    // ãƒŸãƒ‹ã‚¢ã‚¤ã‚³ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§å¾©å…ƒ
    if (miniIcon) {
      miniIcon.addEventListener('click', function() {
        widget.classList.remove('minimized');
        miniIcon.classList.remove('active');
      });
    }
    
    // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ£ãƒƒãƒˆã‚’é–‹ãï¼ˆsidebarãƒ¢ãƒ¼ãƒ‰ï¼‰
    if (character) {
      character.addEventListener('click', function() {
        openChat();
      });
    }
  }
  
  // ========================================
  // å…±é€š: ãƒ›ãƒãƒ¼ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆå‚¾ãã‚’å‰Šé™¤ï¼‰
  // ========================================
  // ãƒ›ãƒãƒ¼æ™‚ã®ç”»åƒåˆ‡ã‚Šæ›¿ãˆã¯CSSã§å‡¦ç†
  
  // ========================================
  // å…±é€š: ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½
  // ========================================
  function openChat() {
    console.log('ğŸ¯ openChat() called');
    if (!chatModal) {
      console.error('âŒ chatModal is null!');
      return;
    }
    chatModal.classList.add('active');
    if (chatInput) chatInput.focus();
    const navBar = document.querySelector('.top-tabs');
    if (navBar) navBar.style.display = 'none';
    console.log('âœ… ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº†');
  }
  
  function closeChat() {
    console.log('ğŸ¯ closeChat() called');
    if (!chatModal) return;
    chatModal.classList.remove('active');
    const navBar = document.querySelector('.top-tabs');
    if (navBar) navBar.style.display = '';
  }
  
  // è©±ã—ã‹ã‘ã‚‹ãƒœã‚¿ãƒ³ï¼ˆkarihomeãƒ¢ãƒ¼ãƒ‰ï¼‰
  if (chatTriggerBtn) {
    console.log('âœ… chatTriggerBtn ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š');
    chatTriggerBtn.addEventListener('click', openChat);
  } else {
    console.warn('âš ï¸ chatTriggerBtn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
  if (closeChatBtn) {
    console.log('âœ… closeChatBtn ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š');
    closeChatBtn.addEventListener('click', closeChat);
  } else {
    console.warn('âš ï¸ closeChatBtn ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  // èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  if (chatModal) {
    chatModal.addEventListener('click', function(e) {
      if (e.target === chatModal) closeChat();
    });
  }

  // ========================================
  // ã‚³ãƒ”ãƒ¼æ™‚ã«ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ä¸
  // ========================================
  if (chatMessages) {
    chatMessages.addEventListener('copy', function(e) {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;

      // é¸æŠç¯„å›²å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¦ç´ ã‚’å–å¾—
      const range = selection.getRangeAt(0);
      const container = document.createElement('div');
      container.appendChild(range.cloneContents());

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ•´å½¢
      let formattedText = '';
      const messages = container.querySelectorAll('.chat-message');
      
      if (messages.length > 0) {
        // è¤‡æ•°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé¸æŠã•ã‚ŒãŸå ´åˆ
        messages.forEach(msg => {
          const content = msg.querySelector('.chat-message-content');
          if (content) {
            const prefix = msg.classList.contains('user') ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š' : 'ï¼¡ï¼©ï¼š';
            formattedText += prefix + content.textContent.trim() + '\n\n';
          }
        });
      } else {
        // å˜ä¸€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã®éƒ¨åˆ†é¸æŠã®å ´åˆ
        const selectedNode = selection.anchorNode;
        let messageElement = selectedNode.nodeType === Node.TEXT_NODE 
          ? selectedNode.parentElement 
          : selectedNode;
        
        // .chat-messageè¦ç´ ã‚’æ¢ã™
        while (messageElement && !messageElement.classList?.contains('chat-message')) {
          messageElement = messageElement.parentElement;
        }
        
        if (messageElement && messageElement.classList.contains('chat-message')) {
          const prefix = messageElement.classList.contains('user') ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š' : 'ï¼¡ï¼©ï¼š';
          formattedText = prefix + selection.toString().trim();
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãã®ã¾ã¾ã®ãƒ†ã‚­ã‚¹ãƒˆ
          formattedText = selection.toString();
        }
      }

      // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
      e.clipboardData.setData('text/plain', formattedText.trim());
      e.preventDefault();
    });
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
  function addMessage(text, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${type}`;
    const contentDiv = document.createElement('div');
    contentDiv.className = 'chat-message-content';
    contentDiv.textContent = text;
    messageDiv.appendChild(contentDiv);
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
  
  // CSRFãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼åã‹ã‚‰APIã§ä½¿ç”¨ã™ã‚‹IDã¸ã®ãƒãƒƒãƒ”ãƒ³ã‚°
  const characterNameToId = {
    'ã‚¦ã‚µã‚®.png': 'usagi',
    'ã‚­ãƒ„ãƒ.png': 'kitsune',
    'ã‚¤ãƒŒ.png': 'inu',
    'ãƒ‘ãƒ³ãƒ€.png': 'panda',
    'ãƒªã‚¹.png': 'risu',
    'ãƒ•ã‚¯ãƒ­ã‚¦.png': 'fukurou',
    'ãƒã‚³.png': 'neko',
    'ã‚¢ãƒ«ãƒ‘ã‚«.png': 'arupaka',
    // æ‹¡å¼µå­ãªã—ã®å ´åˆã‚‚å¯¾å¿œ
    'ã‚¦ã‚µã‚®': 'usagi',
    'ã‚­ãƒ„ãƒ': 'kitsune',
    'ã‚¤ãƒŒ': 'inu',
    'ãƒ‘ãƒ³ãƒ€': 'panda',
    'ãƒªã‚¹': 'risu',
    'ãƒ•ã‚¯ãƒ­ã‚¦': 'fukurou',
    'ãƒã‚³': 'neko',
    'ã‚¢ãƒ«ãƒ‘ã‚«': 'arupaka'
  };
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å–å¾—
  const userAppearance = '{{ appearance|default:"ã‚¤ãƒŒ.png" }}';
  const currentCharacterId = characterNameToId[userAppearance] || 'inu';
  
  // é€ä¿¡å‡¦ç†
  if (sendChatBtn) {
    sendChatBtn.addEventListener('click', function() {
      const message = chatInput.value.trim();
      if (!message) return;
      addMessage(message, 'user');
      chatInput.value = '';
      chatLoading.classList.add('active');
      
      fetch('/codemon/api/ai/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          message: message,
          character: currentCharacterId
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || `HTTP ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.error) {
          addMessage('ã‚¨ãƒ©ãƒ¼: ' + data.error, 'ai');
        } else {
          let reply = data.reply || 'ã‚¨ãƒ©ãƒ¼: è¿”ç­”ãŒã‚ã‚Šã¾ã›ã‚“';
          addMessage(reply, 'ai');
        }
        chatLoading.classList.remove('active');
      })
      .catch(err => {
        console.error('AI Chat Error:', err);
        addMessage('ã‚¨ãƒ©ãƒ¼: ' + (err.message || 'AIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ'), 'ai');
        chatLoading.classList.remove('active');
      });
    });
  }
  
  // Enterã§é€ä¿¡
  if (chatInput) {
    chatInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendChatBtn.click();
      }
    });
  }
});

})(); // å³æ™‚é–¢æ•°ã®çµ‚äº†
</script>
